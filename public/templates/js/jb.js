
/*! jQuery v3.4.1 | (c) JS Foundation and other contributors | jquery.org/license */
!function(e,t){"use strict";"object"==typeof module&&"object"==typeof module.exports?module.exports=e.document?t(e,!0):function(e){if(!e.document)throw new Error("jQuery requires a window with a document");return t(e)}:t(e)}("undefined"!=typeof window?window:this,function(C,e){"use strict";var t=[],E=C.document,r=Object.getPrototypeOf,s=t.slice,g=t.concat,u=t.push,i=t.indexOf,n={},o=n.toString,v=n.hasOwnProperty,a=v.toString,l=a.call(Object),y={},m=function(e){return"function"==typeof e&&"number"!=typeof e.nodeType},x=function(e){return null!=e&&e===e.window},c={type:!0,src:!0,nonce:!0,noModule:!0};function b(e,t,n){var r,i,o=(n=n||E).createElement("script");if(o.text=e,t)for(r in c)(i=t[r]||t.getAttribute&&t.getAttribute(r))&&o.setAttribute(r,i);n.head.appendChild(o).parentNode.removeChild(o)}function w(e){return null==e?e+"":"object"==typeof e||"function"==typeof e?n[o.call(e)]||"object":typeof e}var f="3.4.1",k=function(e,t){return new k.fn.init(e,t)},p=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g;function d(e){var t=!!e&&"length"in e&&e.length,n=w(e);return!m(e)&&!x(e)&&("array"===n||0===t||"number"==typeof t&&0<t&&t-1 in e)}k.fn=k.prototype={jquery:f,constructor:k,length:0,toArray:function(){return s.call(this)},get:function(e){return null==e?s.call(this):e<0?this[e+this.length]:this[e]},pushStack:function(e){var t=k.merge(this.constructor(),e);return t.prevObject=this,t},each:function(e){return k.each(this,e)},map:function(n){return this.pushStack(k.map(this,function(e,t){return n.call(e,t,e)}))},slice:function(){return this.pushStack(s.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},eq:function(e){var t=this.length,n=+e+(e<0?t:0);return this.pushStack(0<=n&&n<t?[this[n]]:[])},end:function(){return this.prevObject||this.constructor()},push:u,sort:t.sort,splice:t.splice},k.extend=k.fn.extend=function(){var e,t,n,r,i,o,a=arguments[0]||{},s=1,u=arguments.length,l=!1;for("boolean"==typeof a&&(l=a,a=arguments[s]||{},s++),"object"==typeof a||m(a)||(a={}),s===u&&(a=this,s--);s<u;s++)if(null!=(e=arguments[s]))for(t in e)r=e[t],"__proto__"!==t&&a!==r&&(l&&r&&(k.isPlainObject(r)||(i=Array.isArray(r)))?(n=a[t],o=i&&!Array.isArray(n)?[]:i||k.isPlainObject(n)?n:{},i=!1,a[t]=k.extend(l,o,r)):void 0!==r&&(a[t]=r));return a},k.extend({expando:"jQuery"+(f+Math.random()).replace(/\D/g,""),isReady:!0,error:function(e){throw new Error(e)},noop:function(){},isPlainObject:function(e){var t,n;return!(!e||"[object Object]"!==o.call(e))&&(!(t=r(e))||"function"==typeof(n=v.call(t,"constructor")&&t.constructor)&&a.call(n)===l)},isEmptyObject:function(e){var t;for(t in e)return!1;return!0},globalEval:function(e,t){b(e,{nonce:t&&t.nonce})},each:function(e,t){var n,r=0;if(d(e)){for(n=e.length;r<n;r++)if(!1===t.call(e[r],r,e[r]))break}else for(r in e)if(!1===t.call(e[r],r,e[r]))break;return e},trim:function(e){return null==e?"":(e+"").replace(p,"")},makeArray:function(e,t){var n=t||[];return null!=e&&(d(Object(e))?k.merge(n,"string"==typeof e?[e]:e):u.call(n,e)),n},inArray:function(e,t,n){return null==t?-1:i.call(t,e,n)},merge:function(e,t){for(var n=+t.length,r=0,i=e.length;r<n;r++)e[i++]=t[r];return e.length=i,e},grep:function(e,t,n){for(var r=[],i=0,o=e.length,a=!n;i<o;i++)!t(e[i],i)!==a&&r.push(e[i]);return r},map:function(e,t,n){var r,i,o=0,a=[];if(d(e))for(r=e.length;o<r;o++)null!=(i=t(e[o],o,n))&&a.push(i);else for(o in e)null!=(i=t(e[o],o,n))&&a.push(i);return g.apply([],a)},guid:1,support:y}),"function"==typeof Symbol&&(k.fn[Symbol.iterator]=t[Symbol.iterator]),k.each("Boolean Number String Function Array Date RegExp Object Error Symbol".split(" "),function(e,t){n["[object "+t+"]"]=t.toLowerCase()});var h=function(n){var e,d,b,o,i,h,f,g,w,u,l,T,C,a,E,v,s,c,y,k="sizzle"+1*new Date,m=n.document,S=0,r=0,p=ue(),x=ue(),N=ue(),A=ue(),D=function(e,t){return e===t&&(l=!0),0},j={}.hasOwnProperty,t=[],q=t.pop,L=t.push,H=t.push,O=t.slice,P=function(e,t){for(var n=0,r=e.length;n<r;n++)if(e[n]===t)return n;return-1},R="checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped",M="[\\x20\\t\\r\\n\\f]",I="(?:\\\\.|[\\w-]|[^\0-\\xa0])+",W="\\["+M+"*("+I+")(?:"+M+"*([*^$|!~]?=)"+M+"*(?:'((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\"|("+I+"))|)"+M+"*\\]",$=":("+I+")(?:\\((('((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\")|((?:\\\\.|[^\\\\()[\\]]|"+W+")*)|.*)\\)|)",F=new RegExp(M+"+","g"),B=new RegExp("^"+M+"+|((?:^|[^\\\\])(?:\\\\.)*)"+M+"+$","g"),_=new RegExp("^"+M+"*,"+M+"*"),z=new RegExp("^"+M+"*([>+~]|"+M+")"+M+"*"),U=new RegExp(M+"|>"),X=new RegExp($),V=new RegExp("^"+I+"$"),G={ID:new RegExp("^#("+I+")"),CLASS:new RegExp("^\\.("+I+")"),TAG:new RegExp("^("+I+"|[*])"),ATTR:new RegExp("^"+W),PSEUDO:new RegExp("^"+$),CHILD:new RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\("+M+"*(even|odd|(([+-]|)(\\d*)n|)"+M+"*(?:([+-]|)"+M+"*(\\d+)|))"+M+"*\\)|)","i"),bool:new RegExp("^(?:"+R+")$","i"),needsContext:new RegExp("^"+M+"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\("+M+"*((?:-\\d)?\\d*)"+M+"*\\)|)(?=[^-]|$)","i")},Y=/HTML$/i,Q=/^(?:input|select|textarea|button)$/i,J=/^h\d$/i,K=/^[^{]+\{\s*\[native \w/,Z=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,ee=/[+~]/,te=new RegExp("\\\\([\\da-f]{1,6}"+M+"?|("+M+")|.)","ig"),ne=function(e,t,n){var r="0x"+t-65536;return r!=r||n?t:r<0?String.fromCharCode(r+65536):String.fromCharCode(r>>10|55296,1023&r|56320)},re=/([\0-\x1f\x7f]|^-?\d)|^-$|[^\0-\x1f\x7f-\uFFFF\w-]/g,ie=function(e,t){return t?"\0"===e?"\ufffd":e.slice(0,-1)+"\\"+e.charCodeAt(e.length-1).toString(16)+" ":"\\"+e},oe=function(){T()},ae=be(function(e){return!0===e.disabled&&"fieldset"===e.nodeName.toLowerCase()},{dir:"parentNode",next:"legend"});try{H.apply(t=O.call(m.childNodes),m.childNodes),t[m.childNodes.length].nodeType}catch(e){H={apply:t.length?function(e,t){L.apply(e,O.call(t))}:function(e,t){var n=e.length,r=0;while(e[n++]=t[r++]);e.length=n-1}}}function se(t,e,n,r){var i,o,a,s,u,l,c,f=e&&e.ownerDocument,p=e?e.nodeType:9;if(n=n||[],"string"!=typeof t||!t||1!==p&&9!==p&&11!==p)return n;if(!r&&((e?e.ownerDocument||e:m)!==C&&T(e),e=e||C,E)){if(11!==p&&(u=Z.exec(t)))if(i=u[1]){if(9===p){if(!(a=e.getElementById(i)))return n;if(a.id===i)return n.push(a),n}else if(f&&(a=f.getElementById(i))&&y(e,a)&&a.id===i)return n.push(a),n}else{if(u[2])return H.apply(n,e.getElementsByTagName(t)),n;if((i=u[3])&&d.getElementsByClassName&&e.getElementsByClassName)return H.apply(n,e.getElementsByClassName(i)),n}if(d.qsa&&!A[t+" "]&&(!v||!v.test(t))&&(1!==p||"object"!==e.nodeName.toLowerCase())){if(c=t,f=e,1===p&&U.test(t)){(s=e.getAttribute("id"))?s=s.replace(re,ie):e.setAttribute("id",s=k),o=(l=h(t)).length;while(o--)l[o]="#"+s+" "+xe(l[o]);c=l.join(","),f=ee.test(t)&&ye(e.parentNode)||e}try{return H.apply(n,f.querySelectorAll(c)),n}catch(e){A(t,!0)}finally{s===k&&e.removeAttribute("id")}}}return g(t.replace(B,"$1"),e,n,r)}function ue(){var r=[];return function e(t,n){return r.push(t+" ")>b.cacheLength&&delete e[r.shift()],e[t+" "]=n}}function le(e){return e[k]=!0,e}function ce(e){var t=C.createElement("fieldset");try{return!!e(t)}catch(e){return!1}finally{t.parentNode&&t.parentNode.removeChild(t),t=null}}function fe(e,t){var n=e.split("|"),r=n.length;while(r--)b.attrHandle[n[r]]=t}function pe(e,t){var n=t&&e,r=n&&1===e.nodeType&&1===t.nodeType&&e.sourceIndex-t.sourceIndex;if(r)return r;if(n)while(n=n.nextSibling)if(n===t)return-1;return e?1:-1}function de(t){return function(e){return"input"===e.nodeName.toLowerCase()&&e.type===t}}function he(n){return function(e){var t=e.nodeName.toLowerCase();return("input"===t||"button"===t)&&e.type===n}}function ge(t){return function(e){return"form"in e?e.parentNode&&!1===e.disabled?"label"in e?"label"in e.parentNode?e.parentNode.disabled===t:e.disabled===t:e.isDisabled===t||e.isDisabled!==!t&&ae(e)===t:e.disabled===t:"label"in e&&e.disabled===t}}function ve(a){return le(function(o){return o=+o,le(function(e,t){var n,r=a([],e.length,o),i=r.length;while(i--)e[n=r[i]]&&(e[n]=!(t[n]=e[n]))})})}function ye(e){return e&&"undefined"!=typeof e.getElementsByTagName&&e}for(e in d=se.support={},i=se.isXML=function(e){var t=e.namespaceURI,n=(e.ownerDocument||e).documentElement;return!Y.test(t||n&&n.nodeName||"HTML")},T=se.setDocument=function(e){var t,n,r=e?e.ownerDocument||e:m;return r!==C&&9===r.nodeType&&r.documentElement&&(a=(C=r).documentElement,E=!i(C),m!==C&&(n=C.defaultView)&&n.top!==n&&(n.addEventListener?n.addEventListener("unload",oe,!1):n.attachEvent&&n.attachEvent("onunload",oe)),d.attributes=ce(function(e){return e.className="i",!e.getAttribute("className")}),d.getElementsByTagName=ce(function(e){return e.appendChild(C.createComment("")),!e.getElementsByTagName("*").length}),d.getElementsByClassName=K.test(C.getElementsByClassName),d.getById=ce(function(e){return a.appendChild(e).id=k,!C.getElementsByName||!C.getElementsByName(k).length}),d.getById?(b.filter.ID=function(e){var t=e.replace(te,ne);return function(e){return e.getAttribute("id")===t}},b.find.ID=function(e,t){if("undefined"!=typeof t.getElementById&&E){var n=t.getElementById(e);return n?[n]:[]}}):(b.filter.ID=function(e){var n=e.replace(te,ne);return function(e){var t="undefined"!=typeof e.getAttributeNode&&e.getAttributeNode("id");return t&&t.value===n}},b.find.ID=function(e,t){if("undefined"!=typeof t.getElementById&&E){var n,r,i,o=t.getElementById(e);if(o){if((n=o.getAttributeNode("id"))&&n.value===e)return[o];i=t.getElementsByName(e),r=0;while(o=i[r++])if((n=o.getAttributeNode("id"))&&n.value===e)return[o]}return[]}}),b.find.TAG=d.getElementsByTagName?function(e,t){return"undefined"!=typeof t.getElementsByTagName?t.getElementsByTagName(e):d.qsa?t.querySelectorAll(e):void 0}:function(e,t){var n,r=[],i=0,o=t.getElementsByTagName(e);if("*"===e){while(n=o[i++])1===n.nodeType&&r.push(n);return r}return o},b.find.CLASS=d.getElementsByClassName&&function(e,t){if("undefined"!=typeof t.getElementsByClassName&&E)return t.getElementsByClassName(e)},s=[],v=[],(d.qsa=K.test(C.querySelectorAll))&&(ce(function(e){a.appendChild(e).innerHTML="<a id='"+k+"'></a><select id='"+k+"-\r\\' msallowcapture=''><option selected=''></option></select>",e.querySelectorAll("[msallowcapture^='']").length&&v.push("[*^$]="+M+"*(?:''|\"\")"),e.querySelectorAll("[selected]").length||v.push("\\["+M+"*(?:value|"+R+")"),e.querySelectorAll("[id~="+k+"-]").length||v.push("~="),e.querySelectorAll(":checked").length||v.push(":checked"),e.querySelectorAll("a#"+k+"+*").length||v.push(".#.+[+~]")}),ce(function(e){e.innerHTML="<a href='' disabled='disabled'></a><select disabled='disabled'><option/></select>";var t=C.createElement("input");t.setAttribute("type","hidden"),e.appendChild(t).setAttribute("name","D"),e.querySelectorAll("[name=d]").length&&v.push("name"+M+"*[*^$|!~]?="),2!==e.querySelectorAll(":enabled").length&&v.push(":enabled",":disabled"),a.appendChild(e).disabled=!0,2!==e.querySelectorAll(":disabled").length&&v.push(":enabled",":disabled"),e.querySelectorAll("*,:x"),v.push(",.*:")})),(d.matchesSelector=K.test(c=a.matches||a.webkitMatchesSelector||a.mozMatchesSelector||a.oMatchesSelector||a.msMatchesSelector))&&ce(function(e){d.disconnectedMatch=c.call(e,"*"),c.call(e,"[s!='']:x"),s.push("!=",$)}),v=v.length&&new RegExp(v.join("|")),s=s.length&&new RegExp(s.join("|")),t=K.test(a.compareDocumentPosition),y=t||K.test(a.contains)?function(e,t){var n=9===e.nodeType?e.documentElement:e,r=t&&t.parentNode;return e===r||!(!r||1!==r.nodeType||!(n.contains?n.contains(r):e.compareDocumentPosition&&16&e.compareDocumentPosition(r)))}:function(e,t){if(t)while(t=t.parentNode)if(t===e)return!0;return!1},D=t?function(e,t){if(e===t)return l=!0,0;var n=!e.compareDocumentPosition-!t.compareDocumentPosition;return n||(1&(n=(e.ownerDocument||e)===(t.ownerDocument||t)?e.compareDocumentPosition(t):1)||!d.sortDetached&&t.compareDocumentPosition(e)===n?e===C||e.ownerDocument===m&&y(m,e)?-1:t===C||t.ownerDocument===m&&y(m,t)?1:u?P(u,e)-P(u,t):0:4&n?-1:1)}:function(e,t){if(e===t)return l=!0,0;var n,r=0,i=e.parentNode,o=t.parentNode,a=[e],s=[t];if(!i||!o)return e===C?-1:t===C?1:i?-1:o?1:u?P(u,e)-P(u,t):0;if(i===o)return pe(e,t);n=e;while(n=n.parentNode)a.unshift(n);n=t;while(n=n.parentNode)s.unshift(n);while(a[r]===s[r])r++;return r?pe(a[r],s[r]):a[r]===m?-1:s[r]===m?1:0}),C},se.matches=function(e,t){return se(e,null,null,t)},se.matchesSelector=function(e,t){if((e.ownerDocument||e)!==C&&T(e),d.matchesSelector&&E&&!A[t+" "]&&(!s||!s.test(t))&&(!v||!v.test(t)))try{var n=c.call(e,t);if(n||d.disconnectedMatch||e.document&&11!==e.document.nodeType)return n}catch(e){A(t,!0)}return 0<se(t,C,null,[e]).length},se.contains=function(e,t){return(e.ownerDocument||e)!==C&&T(e),y(e,t)},se.attr=function(e,t){(e.ownerDocument||e)!==C&&T(e);var n=b.attrHandle[t.toLowerCase()],r=n&&j.call(b.attrHandle,t.toLowerCase())?n(e,t,!E):void 0;return void 0!==r?r:d.attributes||!E?e.getAttribute(t):(r=e.getAttributeNode(t))&&r.specified?r.value:null},se.escape=function(e){return(e+"").replace(re,ie)},se.error=function(e){throw new Error("Syntax error, unrecognized expression: "+e)},se.uniqueSort=function(e){var t,n=[],r=0,i=0;if(l=!d.detectDuplicates,u=!d.sortStable&&e.slice(0),e.sort(D),l){while(t=e[i++])t===e[i]&&(r=n.push(i));while(r--)e.splice(n[r],1)}return u=null,e},o=se.getText=function(e){var t,n="",r=0,i=e.nodeType;if(i){if(1===i||9===i||11===i){if("string"==typeof e.textContent)return e.textContent;for(e=e.firstChild;e;e=e.nextSibling)n+=o(e)}else if(3===i||4===i)return e.nodeValue}else while(t=e[r++])n+=o(t);return n},(b=se.selectors={cacheLength:50,createPseudo:le,match:G,attrHandle:{},find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(e){return e[1]=e[1].replace(te,ne),e[3]=(e[3]||e[4]||e[5]||"").replace(te,ne),"~="===e[2]&&(e[3]=" "+e[3]+" "),e.slice(0,4)},CHILD:function(e){return e[1]=e[1].toLowerCase(),"nth"===e[1].slice(0,3)?(e[3]||se.error(e[0]),e[4]=+(e[4]?e[5]+(e[6]||1):2*("even"===e[3]||"odd"===e[3])),e[5]=+(e[7]+e[8]||"odd"===e[3])):e[3]&&se.error(e[0]),e},PSEUDO:function(e){var t,n=!e[6]&&e[2];return G.CHILD.test(e[0])?null:(e[3]?e[2]=e[4]||e[5]||"":n&&X.test(n)&&(t=h(n,!0))&&(t=n.indexOf(")",n.length-t)-n.length)&&(e[0]=e[0].slice(0,t),e[2]=n.slice(0,t)),e.slice(0,3))}},filter:{TAG:function(e){var t=e.replace(te,ne).toLowerCase();return"*"===e?function(){return!0}:function(e){return e.nodeName&&e.nodeName.toLowerCase()===t}},CLASS:function(e){var t=p[e+" "];return t||(t=new RegExp("(^|"+M+")"+e+"("+M+"|$)"))&&p(e,function(e){return t.test("string"==typeof e.className&&e.className||"undefined"!=typeof e.getAttribute&&e.getAttribute("class")||"")})},ATTR:function(n,r,i){return function(e){var t=se.attr(e,n);return null==t?"!="===r:!r||(t+="","="===r?t===i:"!="===r?t!==i:"^="===r?i&&0===t.indexOf(i):"*="===r?i&&-1<t.indexOf(i):"$="===r?i&&t.slice(-i.length)===i:"~="===r?-1<(" "+t.replace(F," ")+" ").indexOf(i):"|="===r&&(t===i||t.slice(0,i.length+1)===i+"-"))}},CHILD:function(h,e,t,g,v){var y="nth"!==h.slice(0,3),m="last"!==h.slice(-4),x="of-type"===e;return 1===g&&0===v?function(e){return!!e.parentNode}:function(e,t,n){var r,i,o,a,s,u,l=y!==m?"nextSibling":"previousSibling",c=e.parentNode,f=x&&e.nodeName.toLowerCase(),p=!n&&!x,d=!1;if(c){if(y){while(l){a=e;while(a=a[l])if(x?a.nodeName.toLowerCase()===f:1===a.nodeType)return!1;u=l="only"===h&&!u&&"nextSibling"}return!0}if(u=[m?c.firstChild:c.lastChild],m&&p){d=(s=(r=(i=(o=(a=c)[k]||(a[k]={}))[a.uniqueID]||(o[a.uniqueID]={}))[h]||[])[0]===S&&r[1])&&r[2],a=s&&c.childNodes[s];while(a=++s&&a&&a[l]||(d=s=0)||u.pop())if(1===a.nodeType&&++d&&a===e){i[h]=[S,s,d];break}}else if(p&&(d=s=(r=(i=(o=(a=e)[k]||(a[k]={}))[a.uniqueID]||(o[a.uniqueID]={}))[h]||[])[0]===S&&r[1]),!1===d)while(a=++s&&a&&a[l]||(d=s=0)||u.pop())if((x?a.nodeName.toLowerCase()===f:1===a.nodeType)&&++d&&(p&&((i=(o=a[k]||(a[k]={}))[a.uniqueID]||(o[a.uniqueID]={}))[h]=[S,d]),a===e))break;return(d-=v)===g||d%g==0&&0<=d/g}}},PSEUDO:function(e,o){var t,a=b.pseudos[e]||b.setFilters[e.toLowerCase()]||se.error("unsupported pseudo: "+e);return a[k]?a(o):1<a.length?(t=[e,e,"",o],b.setFilters.hasOwnProperty(e.toLowerCase())?le(function(e,t){var n,r=a(e,o),i=r.length;while(i--)e[n=P(e,r[i])]=!(t[n]=r[i])}):function(e){return a(e,0,t)}):a}},pseudos:{not:le(function(e){var r=[],i=[],s=f(e.replace(B,"$1"));return s[k]?le(function(e,t,n,r){var i,o=s(e,null,r,[]),a=e.length;while(a--)(i=o[a])&&(e[a]=!(t[a]=i))}):function(e,t,n){return r[0]=e,s(r,null,n,i),r[0]=null,!i.pop()}}),has:le(function(t){return function(e){return 0<se(t,e).length}}),contains:le(function(t){return t=t.replace(te,ne),function(e){return-1<(e.textContent||o(e)).indexOf(t)}}),lang:le(function(n){return V.test(n||"")||se.error("unsupported lang: "+n),n=n.replace(te,ne).toLowerCase(),function(e){var t;do{if(t=E?e.lang:e.getAttribute("xml:lang")||e.getAttribute("lang"))return(t=t.toLowerCase())===n||0===t.indexOf(n+"-")}while((e=e.parentNode)&&1===e.nodeType);return!1}}),target:function(e){var t=n.location&&n.location.hash;return t&&t.slice(1)===e.id},root:function(e){return e===a},focus:function(e){return e===C.activeElement&&(!C.hasFocus||C.hasFocus())&&!!(e.type||e.href||~e.tabIndex)},enabled:ge(!1),disabled:ge(!0),checked:function(e){var t=e.nodeName.toLowerCase();return"input"===t&&!!e.checked||"option"===t&&!!e.selected},selected:function(e){return e.parentNode&&e.parentNode.selectedIndex,!0===e.selected},empty:function(e){for(e=e.firstChild;e;e=e.nextSibling)if(e.nodeType<6)return!1;return!0},parent:function(e){return!b.pseudos.empty(e)},header:function(e){return J.test(e.nodeName)},input:function(e){return Q.test(e.nodeName)},button:function(e){var t=e.nodeName.toLowerCase();return"input"===t&&"button"===e.type||"button"===t},text:function(e){var t;return"input"===e.nodeName.toLowerCase()&&"text"===e.type&&(null==(t=e.getAttribute("type"))||"text"===t.toLowerCase())},first:ve(function(){return[0]}),last:ve(function(e,t){return[t-1]}),eq:ve(function(e,t,n){return[n<0?n+t:n]}),even:ve(function(e,t){for(var n=0;n<t;n+=2)e.push(n);return e}),odd:ve(function(e,t){for(var n=1;n<t;n+=2)e.push(n);return e}),lt:ve(function(e,t,n){for(var r=n<0?n+t:t<n?t:n;0<=--r;)e.push(r);return e}),gt:ve(function(e,t,n){for(var r=n<0?n+t:n;++r<t;)e.push(r);return e})}}).pseudos.nth=b.pseudos.eq,{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})b.pseudos[e]=de(e);for(e in{submit:!0,reset:!0})b.pseudos[e]=he(e);function me(){}function xe(e){for(var t=0,n=e.length,r="";t<n;t++)r+=e[t].value;return r}function be(s,e,t){var u=e.dir,l=e.next,c=l||u,f=t&&"parentNode"===c,p=r++;return e.first?function(e,t,n){while(e=e[u])if(1===e.nodeType||f)return s(e,t,n);return!1}:function(e,t,n){var r,i,o,a=[S,p];if(n){while(e=e[u])if((1===e.nodeType||f)&&s(e,t,n))return!0}else while(e=e[u])if(1===e.nodeType||f)if(i=(o=e[k]||(e[k]={}))[e.uniqueID]||(o[e.uniqueID]={}),l&&l===e.nodeName.toLowerCase())e=e[u]||e;else{if((r=i[c])&&r[0]===S&&r[1]===p)return a[2]=r[2];if((i[c]=a)[2]=s(e,t,n))return!0}return!1}}function we(i){return 1<i.length?function(e,t,n){var r=i.length;while(r--)if(!i[r](e,t,n))return!1;return!0}:i[0]}function Te(e,t,n,r,i){for(var o,a=[],s=0,u=e.length,l=null!=t;s<u;s++)(o=e[s])&&(n&&!n(o,r,i)||(a.push(o),l&&t.push(s)));return a}function Ce(d,h,g,v,y,e){return v&&!v[k]&&(v=Ce(v)),y&&!y[k]&&(y=Ce(y,e)),le(function(e,t,n,r){var i,o,a,s=[],u=[],l=t.length,c=e||function(e,t,n){for(var r=0,i=t.length;r<i;r++)se(e,t[r],n);return n}(h||"*",n.nodeType?[n]:n,[]),f=!d||!e&&h?c:Te(c,s,d,n,r),p=g?y||(e?d:l||v)?[]:t:f;if(g&&g(f,p,n,r),v){i=Te(p,u),v(i,[],n,r),o=i.length;while(o--)(a=i[o])&&(p[u[o]]=!(f[u[o]]=a))}if(e){if(y||d){if(y){i=[],o=p.length;while(o--)(a=p[o])&&i.push(f[o]=a);y(null,p=[],i,r)}o=p.length;while(o--)(a=p[o])&&-1<(i=y?P(e,a):s[o])&&(e[i]=!(t[i]=a))}}else p=Te(p===t?p.splice(l,p.length):p),y?y(null,t,p,r):H.apply(t,p)})}function Ee(e){for(var i,t,n,r=e.length,o=b.relative[e[0].type],a=o||b.relative[" "],s=o?1:0,u=be(function(e){return e===i},a,!0),l=be(function(e){return-1<P(i,e)},a,!0),c=[function(e,t,n){var r=!o&&(n||t!==w)||((i=t).nodeType?u(e,t,n):l(e,t,n));return i=null,r}];s<r;s++)if(t=b.relative[e[s].type])c=[be(we(c),t)];else{if((t=b.filter[e[s].type].apply(null,e[s].matches))[k]){for(n=++s;n<r;n++)if(b.relative[e[n].type])break;return Ce(1<s&&we(c),1<s&&xe(e.slice(0,s-1).concat({value:" "===e[s-2].type?"*":""})).replace(B,"$1"),t,s<n&&Ee(e.slice(s,n)),n<r&&Ee(e=e.slice(n)),n<r&&xe(e))}c.push(t)}return we(c)}return me.prototype=b.filters=b.pseudos,b.setFilters=new me,h=se.tokenize=function(e,t){var n,r,i,o,a,s,u,l=x[e+" "];if(l)return t?0:l.slice(0);a=e,s=[],u=b.preFilter;while(a){for(o in n&&!(r=_.exec(a))||(r&&(a=a.slice(r[0].length)||a),s.push(i=[])),n=!1,(r=z.exec(a))&&(n=r.shift(),i.push({value:n,type:r[0].replace(B," ")}),a=a.slice(n.length)),b.filter)!(r=G[o].exec(a))||u[o]&&!(r=u[o](r))||(n=r.shift(),i.push({value:n,type:o,matches:r}),a=a.slice(n.length));if(!n)break}return t?a.length:a?se.error(e):x(e,s).slice(0)},f=se.compile=function(e,t){var n,v,y,m,x,r,i=[],o=[],a=N[e+" "];if(!a){t||(t=h(e)),n=t.length;while(n--)(a=Ee(t[n]))[k]?i.push(a):o.push(a);(a=N(e,(v=o,m=0<(y=i).length,x=0<v.length,r=function(e,t,n,r,i){var o,a,s,u=0,l="0",c=e&&[],f=[],p=w,d=e||x&&b.find.TAG("*",i),h=S+=null==p?1:Math.random()||.1,g=d.length;for(i&&(w=t===C||t||i);l!==g&&null!=(o=d[l]);l++){if(x&&o){a=0,t||o.ownerDocument===C||(T(o),n=!E);while(s=v[a++])if(s(o,t||C,n)){r.push(o);break}i&&(S=h)}m&&((o=!s&&o)&&u--,e&&c.push(o))}if(u+=l,m&&l!==u){a=0;while(s=y[a++])s(c,f,t,n);if(e){if(0<u)while(l--)c[l]||f[l]||(f[l]=q.call(r));f=Te(f)}H.apply(r,f),i&&!e&&0<f.length&&1<u+y.length&&se.uniqueSort(r)}return i&&(S=h,w=p),c},m?le(r):r))).selector=e}return a},g=se.select=function(e,t,n,r){var i,o,a,s,u,l="function"==typeof e&&e,c=!r&&h(e=l.selector||e);if(n=n||[],1===c.length){if(2<(o=c[0]=c[0].slice(0)).length&&"ID"===(a=o[0]).type&&9===t.nodeType&&E&&b.relative[o[1].type]){if(!(t=(b.find.ID(a.matches[0].replace(te,ne),t)||[])[0]))return n;l&&(t=t.parentNode),e=e.slice(o.shift().value.length)}i=G.needsContext.test(e)?0:o.length;while(i--){if(a=o[i],b.relative[s=a.type])break;if((u=b.find[s])&&(r=u(a.matches[0].replace(te,ne),ee.test(o[0].type)&&ye(t.parentNode)||t))){if(o.splice(i,1),!(e=r.length&&xe(o)))return H.apply(n,r),n;break}}}return(l||f(e,c))(r,t,!E,n,!t||ee.test(e)&&ye(t.parentNode)||t),n},d.sortStable=k.split("").sort(D).join("")===k,d.detectDuplicates=!!l,T(),d.sortDetached=ce(function(e){return 1&e.compareDocumentPosition(C.createElement("fieldset"))}),ce(function(e){return e.innerHTML="<a href='#'></a>","#"===e.firstChild.getAttribute("href")})||fe("type|href|height|width",function(e,t,n){if(!n)return e.getAttribute(t,"type"===t.toLowerCase()?1:2)}),d.attributes&&ce(function(e){return e.innerHTML="<input/>",e.firstChild.setAttribute("value",""),""===e.firstChild.getAttribute("value")})||fe("value",function(e,t,n){if(!n&&"input"===e.nodeName.toLowerCase())return e.defaultValue}),ce(function(e){return null==e.getAttribute("disabled")})||fe(R,function(e,t,n){var r;if(!n)return!0===e[t]?t.toLowerCase():(r=e.getAttributeNode(t))&&r.specified?r.value:null}),se}(C);k.find=h,k.expr=h.selectors,k.expr[":"]=k.expr.pseudos,k.uniqueSort=k.unique=h.uniqueSort,k.text=h.getText,k.isXMLDoc=h.isXML,k.contains=h.contains,k.escapeSelector=h.escape;var T=function(e,t,n){var r=[],i=void 0!==n;while((e=e[t])&&9!==e.nodeType)if(1===e.nodeType){if(i&&k(e).is(n))break;r.push(e)}return r},S=function(e,t){for(var n=[];e;e=e.nextSibling)1===e.nodeType&&e!==t&&n.push(e);return n},N=k.expr.match.needsContext;function A(e,t){return e.nodeName&&e.nodeName.toLowerCase()===t.toLowerCase()}var D=/^<([a-z][^\/\0>:\x20\t\r\n\f]*)[\x20\t\r\n\f]*\/?>(?:<\/\1>|)$/i;function j(e,n,r){return m(n)?k.grep(e,function(e,t){return!!n.call(e,t,e)!==r}):n.nodeType?k.grep(e,function(e){return e===n!==r}):"string"!=typeof n?k.grep(e,function(e){return-1<i.call(n,e)!==r}):k.filter(n,e,r)}k.filter=function(e,t,n){var r=t[0];return n&&(e=":not("+e+")"),1===t.length&&1===r.nodeType?k.find.matchesSelector(r,e)?[r]:[]:k.find.matches(e,k.grep(t,function(e){return 1===e.nodeType}))},k.fn.extend({find:function(e){var t,n,r=this.length,i=this;if("string"!=typeof e)return this.pushStack(k(e).filter(function(){for(t=0;t<r;t++)if(k.contains(i[t],this))return!0}));for(n=this.pushStack([]),t=0;t<r;t++)k.find(e,i[t],n);return 1<r?k.uniqueSort(n):n},filter:function(e){return this.pushStack(j(this,e||[],!1))},not:function(e){return this.pushStack(j(this,e||[],!0))},is:function(e){return!!j(this,"string"==typeof e&&N.test(e)?k(e):e||[],!1).length}});var q,L=/^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]+))$/;(k.fn.init=function(e,t,n){var r,i;if(!e)return this;if(n=n||q,"string"==typeof e){if(!(r="<"===e[0]&&">"===e[e.length-1]&&3<=e.length?[null,e,null]:L.exec(e))||!r[1]&&t)return!t||t.jquery?(t||n).find(e):this.constructor(t).find(e);if(r[1]){if(t=t instanceof k?t[0]:t,k.merge(this,k.parseHTML(r[1],t&&t.nodeType?t.ownerDocument||t:E,!0)),D.test(r[1])&&k.isPlainObject(t))for(r in t)m(this[r])?this[r](t[r]):this.attr(r,t[r]);return this}return(i=E.getElementById(r[2]))&&(this[0]=i,this.length=1),this}return e.nodeType?(this[0]=e,this.length=1,this):m(e)?void 0!==n.ready?n.ready(e):e(k):k.makeArray(e,this)}).prototype=k.fn,q=k(E);var H=/^(?:parents|prev(?:Until|All))/,O={children:!0,contents:!0,next:!0,prev:!0};function P(e,t){while((e=e[t])&&1!==e.nodeType);return e}k.fn.extend({has:function(e){var t=k(e,this),n=t.length;return this.filter(function(){for(var e=0;e<n;e++)if(k.contains(this,t[e]))return!0})},closest:function(e,t){var n,r=0,i=this.length,o=[],a="string"!=typeof e&&k(e);if(!N.test(e))for(;r<i;r++)for(n=this[r];n&&n!==t;n=n.parentNode)if(n.nodeType<11&&(a?-1<a.index(n):1===n.nodeType&&k.find.matchesSelector(n,e))){o.push(n);break}return this.pushStack(1<o.length?k.uniqueSort(o):o)},index:function(e){return e?"string"==typeof e?i.call(k(e),this[0]):i.call(this,e.jquery?e[0]:e):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(e,t){return this.pushStack(k.uniqueSort(k.merge(this.get(),k(e,t))))},addBack:function(e){return this.add(null==e?this.prevObject:this.prevObject.filter(e))}}),k.each({parent:function(e){var t=e.parentNode;return t&&11!==t.nodeType?t:null},parents:function(e){return T(e,"parentNode")},parentsUntil:function(e,t,n){return T(e,"parentNode",n)},next:function(e){return P(e,"nextSibling")},prev:function(e){return P(e,"previousSibling")},nextAll:function(e){return T(e,"nextSibling")},prevAll:function(e){return T(e,"previousSibling")},nextUntil:function(e,t,n){return T(e,"nextSibling",n)},prevUntil:function(e,t,n){return T(e,"previousSibling",n)},siblings:function(e){return S((e.parentNode||{}).firstChild,e)},children:function(e){return S(e.firstChild)},contents:function(e){return"undefined"!=typeof e.contentDocument?e.contentDocument:(A(e,"template")&&(e=e.content||e),k.merge([],e.childNodes))}},function(r,i){k.fn[r]=function(e,t){var n=k.map(this,i,e);return"Until"!==r.slice(-5)&&(t=e),t&&"string"==typeof t&&(n=k.filter(t,n)),1<this.length&&(O[r]||k.uniqueSort(n),H.test(r)&&n.reverse()),this.pushStack(n)}});var R=/[^\x20\t\r\n\f]+/g;function M(e){return e}function I(e){throw e}function W(e,t,n,r){var i;try{e&&m(i=e.promise)?i.call(e).done(t).fail(n):e&&m(i=e.then)?i.call(e,t,n):t.apply(void 0,[e].slice(r))}catch(e){n.apply(void 0,[e])}}k.Callbacks=function(r){var e,n;r="string"==typeof r?(e=r,n={},k.each(e.match(R)||[],function(e,t){n[t]=!0}),n):k.extend({},r);var i,t,o,a,s=[],u=[],l=-1,c=function(){for(a=a||r.once,o=i=!0;u.length;l=-1){t=u.shift();while(++l<s.length)!1===s[l].apply(t[0],t[1])&&r.stopOnFalse&&(l=s.length,t=!1)}r.memory||(t=!1),i=!1,a&&(s=t?[]:"")},f={add:function(){return s&&(t&&!i&&(l=s.length-1,u.push(t)),function n(e){k.each(e,function(e,t){m(t)?r.unique&&f.has(t)||s.push(t):t&&t.length&&"string"!==w(t)&&n(t)})}(arguments),t&&!i&&c()),this},remove:function(){return k.each(arguments,function(e,t){var n;while(-1<(n=k.inArray(t,s,n)))s.splice(n,1),n<=l&&l--}),this},has:function(e){return e?-1<k.inArray(e,s):0<s.length},empty:function(){return s&&(s=[]),this},disable:function(){return a=u=[],s=t="",this},disabled:function(){return!s},lock:function(){return a=u=[],t||i||(s=t=""),this},locked:function(){return!!a},fireWith:function(e,t){return a||(t=[e,(t=t||[]).slice?t.slice():t],u.push(t),i||c()),this},fire:function(){return f.fireWith(this,arguments),this},fired:function(){return!!o}};return f},k.extend({Deferred:function(e){var o=[["notify","progress",k.Callbacks("memory"),k.Callbacks("memory"),2],["resolve","done",k.Callbacks("once memory"),k.Callbacks("once memory"),0,"resolved"],["reject","fail",k.Callbacks("once memory"),k.Callbacks("once memory"),1,"rejected"]],i="pending",a={state:function(){return i},always:function(){return s.done(arguments).fail(arguments),this},"catch":function(e){return a.then(null,e)},pipe:function(){var i=arguments;return k.Deferred(function(r){k.each(o,function(e,t){var n=m(i[t[4]])&&i[t[4]];s[t[1]](function(){var e=n&&n.apply(this,arguments);e&&m(e.promise)?e.promise().progress(r.notify).done(r.resolve).fail(r.reject):r[t[0]+"With"](this,n?[e]:arguments)})}),i=null}).promise()},then:function(t,n,r){var u=0;function l(i,o,a,s){return function(){var n=this,r=arguments,e=function(){var e,t;if(!(i<u)){if((e=a.apply(n,r))===o.promise())throw new TypeError("Thenable self-resolution");t=e&&("object"==typeof e||"function"==typeof e)&&e.then,m(t)?s?t.call(e,l(u,o,M,s),l(u,o,I,s)):(u++,t.call(e,l(u,o,M,s),l(u,o,I,s),l(u,o,M,o.notifyWith))):(a!==M&&(n=void 0,r=[e]),(s||o.resolveWith)(n,r))}},t=s?e:function(){try{e()}catch(e){k.Deferred.exceptionHook&&k.Deferred.exceptionHook(e,t.stackTrace),u<=i+1&&(a!==I&&(n=void 0,r=[e]),o.rejectWith(n,r))}};i?t():(k.Deferred.getStackHook&&(t.stackTrace=k.Deferred.getStackHook()),C.setTimeout(t))}}return k.Deferred(function(e){o[0][3].add(l(0,e,m(r)?r:M,e.notifyWith)),o[1][3].add(l(0,e,m(t)?t:M)),o[2][3].add(l(0,e,m(n)?n:I))}).promise()},promise:function(e){return null!=e?k.extend(e,a):a}},s={};return k.each(o,function(e,t){var n=t[2],r=t[5];a[t[1]]=n.add,r&&n.add(function(){i=r},o[3-e][2].disable,o[3-e][3].disable,o[0][2].lock,o[0][3].lock),n.add(t[3].fire),s[t[0]]=function(){return s[t[0]+"With"](this===s?void 0:this,arguments),this},s[t[0]+"With"]=n.fireWith}),a.promise(s),e&&e.call(s,s),s},when:function(e){var n=arguments.length,t=n,r=Array(t),i=s.call(arguments),o=k.Deferred(),a=function(t){return function(e){r[t]=this,i[t]=1<arguments.length?s.call(arguments):e,--n||o.resolveWith(r,i)}};if(n<=1&&(W(e,o.done(a(t)).resolve,o.reject,!n),"pending"===o.state()||m(i[t]&&i[t].then)))return o.then();while(t--)W(i[t],a(t),o.reject);return o.promise()}});var $=/^(Eval|Internal|Range|Reference|Syntax|Type|URI)Error$/;k.Deferred.exceptionHook=function(e,t){C.console&&C.console.warn&&e&&$.test(e.name)&&C.console.warn("jQuery.Deferred exception: "+e.message,e.stack,t)},k.readyException=function(e){C.setTimeout(function(){throw e})};var F=k.Deferred();function B(){E.removeEventListener("DOMContentLoaded",B),C.removeEventListener("load",B),k.ready()}k.fn.ready=function(e){return F.then(e)["catch"](function(e){k.readyException(e)}),this},k.extend({isReady:!1,readyWait:1,ready:function(e){(!0===e?--k.readyWait:k.isReady)||(k.isReady=!0)!==e&&0<--k.readyWait||F.resolveWith(E,[k])}}),k.ready.then=F.then,"complete"===E.readyState||"loading"!==E.readyState&&!E.documentElement.doScroll?C.setTimeout(k.ready):(E.addEventListener("DOMContentLoaded",B),C.addEventListener("load",B));var _=function(e,t,n,r,i,o,a){var s=0,u=e.length,l=null==n;if("object"===w(n))for(s in i=!0,n)_(e,t,s,n[s],!0,o,a);else if(void 0!==r&&(i=!0,m(r)||(a=!0),l&&(a?(t.call(e,r),t=null):(l=t,t=function(e,t,n){return l.call(k(e),n)})),t))for(;s<u;s++)t(e[s],n,a?r:r.call(e[s],s,t(e[s],n)));return i?e:l?t.call(e):u?t(e[0],n):o},z=/^-ms-/,U=/-([a-z])/g;function X(e,t){return t.toUpperCase()}function V(e){return e.replace(z,"ms-").replace(U,X)}var G=function(e){return 1===e.nodeType||9===e.nodeType||!+e.nodeType};function Y(){this.expando=k.expando+Y.uid++}Y.uid=1,Y.prototype={cache:function(e){var t=e[this.expando];return t||(t={},G(e)&&(e.nodeType?e[this.expando]=t:Object.defineProperty(e,this.expando,{value:t,configurable:!0}))),t},set:function(e,t,n){var r,i=this.cache(e);if("string"==typeof t)i[V(t)]=n;else for(r in t)i[V(r)]=t[r];return i},get:function(e,t){return void 0===t?this.cache(e):e[this.expando]&&e[this.expando][V(t)]},access:function(e,t,n){return void 0===t||t&&"string"==typeof t&&void 0===n?this.get(e,t):(this.set(e,t,n),void 0!==n?n:t)},remove:function(e,t){var n,r=e[this.expando];if(void 0!==r){if(void 0!==t){n=(t=Array.isArray(t)?t.map(V):(t=V(t))in r?[t]:t.match(R)||[]).length;while(n--)delete r[t[n]]}(void 0===t||k.isEmptyObject(r))&&(e.nodeType?e[this.expando]=void 0:delete e[this.expando])}},hasData:function(e){var t=e[this.expando];return void 0!==t&&!k.isEmptyObject(t)}};var Q=new Y,J=new Y,K=/^(?:\{[\w\W]*\}|\[[\w\W]*\])$/,Z=/[A-Z]/g;function ee(e,t,n){var r,i;if(void 0===n&&1===e.nodeType)if(r="data-"+t.replace(Z,"-$&").toLowerCase(),"string"==typeof(n=e.getAttribute(r))){try{n="true"===(i=n)||"false"!==i&&("null"===i?null:i===+i+""?+i:K.test(i)?JSON.parse(i):i)}catch(e){}J.set(e,t,n)}else n=void 0;return n}k.extend({hasData:function(e){return J.hasData(e)||Q.hasData(e)},data:function(e,t,n){return J.access(e,t,n)},removeData:function(e,t){J.remove(e,t)},_data:function(e,t,n){return Q.access(e,t,n)},_removeData:function(e,t){Q.remove(e,t)}}),k.fn.extend({data:function(n,e){var t,r,i,o=this[0],a=o&&o.attributes;if(void 0===n){if(this.length&&(i=J.get(o),1===o.nodeType&&!Q.get(o,"hasDataAttrs"))){t=a.length;while(t--)a[t]&&0===(r=a[t].name).indexOf("data-")&&(r=V(r.slice(5)),ee(o,r,i[r]));Q.set(o,"hasDataAttrs",!0)}return i}return"object"==typeof n?this.each(function(){J.set(this,n)}):_(this,function(e){var t;if(o&&void 0===e)return void 0!==(t=J.get(o,n))?t:void 0!==(t=ee(o,n))?t:void 0;this.each(function(){J.set(this,n,e)})},null,e,1<arguments.length,null,!0)},removeData:function(e){return this.each(function(){J.remove(this,e)})}}),k.extend({queue:function(e,t,n){var r;if(e)return t=(t||"fx")+"queue",r=Q.get(e,t),n&&(!r||Array.isArray(n)?r=Q.access(e,t,k.makeArray(n)):r.push(n)),r||[]},dequeue:function(e,t){t=t||"fx";var n=k.queue(e,t),r=n.length,i=n.shift(),o=k._queueHooks(e,t);"inprogress"===i&&(i=n.shift(),r--),i&&("fx"===t&&n.unshift("inprogress"),delete o.stop,i.call(e,function(){k.dequeue(e,t)},o)),!r&&o&&o.empty.fire()},_queueHooks:function(e,t){var n=t+"queueHooks";return Q.get(e,n)||Q.access(e,n,{empty:k.Callbacks("once memory").add(function(){Q.remove(e,[t+"queue",n])})})}}),k.fn.extend({queue:function(t,n){var e=2;return"string"!=typeof t&&(n=t,t="fx",e--),arguments.length<e?k.queue(this[0],t):void 0===n?this:this.each(function(){var e=k.queue(this,t,n);k._queueHooks(this,t),"fx"===t&&"inprogress"!==e[0]&&k.dequeue(this,t)})},dequeue:function(e){return this.each(function(){k.dequeue(this,e)})},clearQueue:function(e){return this.queue(e||"fx",[])},promise:function(e,t){var n,r=1,i=k.Deferred(),o=this,a=this.length,s=function(){--r||i.resolveWith(o,[o])};"string"!=typeof e&&(t=e,e=void 0),e=e||"fx";while(a--)(n=Q.get(o[a],e+"queueHooks"))&&n.empty&&(r++,n.empty.add(s));return s(),i.promise(t)}});var te=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,ne=new RegExp("^(?:([+-])=|)("+te+")([a-z%]*)$","i"),re=["Top","Right","Bottom","Left"],ie=E.documentElement,oe=function(e){return k.contains(e.ownerDocument,e)},ae={composed:!0};ie.getRootNode&&(oe=function(e){return k.contains(e.ownerDocument,e)||e.getRootNode(ae)===e.ownerDocument});var se=function(e,t){return"none"===(e=t||e).style.display||""===e.style.display&&oe(e)&&"none"===k.css(e,"display")},ue=function(e,t,n,r){var i,o,a={};for(o in t)a[o]=e.style[o],e.style[o]=t[o];for(o in i=n.apply(e,r||[]),t)e.style[o]=a[o];return i};function le(e,t,n,r){var i,o,a=20,s=r?function(){return r.cur()}:function(){return k.css(e,t,"")},u=s(),l=n&&n[3]||(k.cssNumber[t]?"":"px"),c=e.nodeType&&(k.cssNumber[t]||"px"!==l&&+u)&&ne.exec(k.css(e,t));if(c&&c[3]!==l){u/=2,l=l||c[3],c=+u||1;while(a--)k.style(e,t,c+l),(1-o)*(1-(o=s()/u||.5))<=0&&(a=0),c/=o;c*=2,k.style(e,t,c+l),n=n||[]}return n&&(c=+c||+u||0,i=n[1]?c+(n[1]+1)*n[2]:+n[2],r&&(r.unit=l,r.start=c,r.end=i)),i}var ce={};function fe(e,t){for(var n,r,i,o,a,s,u,l=[],c=0,f=e.length;c<f;c++)(r=e[c]).style&&(n=r.style.display,t?("none"===n&&(l[c]=Q.get(r,"display")||null,l[c]||(r.style.display="")),""===r.style.display&&se(r)&&(l[c]=(u=a=o=void 0,a=(i=r).ownerDocument,s=i.nodeName,(u=ce[s])||(o=a.body.appendChild(a.createElement(s)),u=k.css(o,"display"),o.parentNode.removeChild(o),"none"===u&&(u="block"),ce[s]=u)))):"none"!==n&&(l[c]="none",Q.set(r,"display",n)));for(c=0;c<f;c++)null!=l[c]&&(e[c].style.display=l[c]);return e}k.fn.extend({show:function(){return fe(this,!0)},hide:function(){return fe(this)},toggle:function(e){return"boolean"==typeof e?e?this.show():this.hide():this.each(function(){se(this)?k(this).show():k(this).hide()})}});var pe=/^(?:checkbox|radio)$/i,de=/<([a-z][^\/\0>\x20\t\r\n\f]*)/i,he=/^$|^module$|\/(?:java|ecma)script/i,ge={option:[1,"<select multiple='multiple'>","</select>"],thead:[1,"<table>","</table>"],col:[2,"<table><colgroup>","</colgroup></table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:[0,"",""]};function ve(e,t){var n;return n="undefined"!=typeof e.getElementsByTagName?e.getElementsByTagName(t||"*"):"undefined"!=typeof e.querySelectorAll?e.querySelectorAll(t||"*"):[],void 0===t||t&&A(e,t)?k.merge([e],n):n}function ye(e,t){for(var n=0,r=e.length;n<r;n++)Q.set(e[n],"globalEval",!t||Q.get(t[n],"globalEval"))}ge.optgroup=ge.option,ge.tbody=ge.tfoot=ge.colgroup=ge.caption=ge.thead,ge.th=ge.td;var me,xe,be=/<|&#?\w+;/;function we(e,t,n,r,i){for(var o,a,s,u,l,c,f=t.createDocumentFragment(),p=[],d=0,h=e.length;d<h;d++)if((o=e[d])||0===o)if("object"===w(o))k.merge(p,o.nodeType?[o]:o);else if(be.test(o)){a=a||f.appendChild(t.createElement("div")),s=(de.exec(o)||["",""])[1].toLowerCase(),u=ge[s]||ge._default,a.innerHTML=u[1]+k.htmlPrefilter(o)+u[2],c=u[0];while(c--)a=a.lastChild;k.merge(p,a.childNodes),(a=f.firstChild).textContent=""}else p.push(t.createTextNode(o));f.textContent="",d=0;while(o=p[d++])if(r&&-1<k.inArray(o,r))i&&i.push(o);else if(l=oe(o),a=ve(f.appendChild(o),"script"),l&&ye(a),n){c=0;while(o=a[c++])he.test(o.type||"")&&n.push(o)}return f}me=E.createDocumentFragment().appendChild(E.createElement("div")),(xe=E.createElement("input")).setAttribute("type","radio"),xe.setAttribute("checked","checked"),xe.setAttribute("name","t"),me.appendChild(xe),y.checkClone=me.cloneNode(!0).cloneNode(!0).lastChild.checked,me.innerHTML="<textarea>x</textarea>",y.noCloneChecked=!!me.cloneNode(!0).lastChild.defaultValue;var Te=/^key/,Ce=/^(?:mouse|pointer|contextmenu|drag|drop)|click/,Ee=/^([^.]*)(?:\.(.+)|)/;function ke(){return!0}function Se(){return!1}function Ne(e,t){return e===function(){try{return E.activeElement}catch(e){}}()==("focus"===t)}function Ae(e,t,n,r,i,o){var a,s;if("object"==typeof t){for(s in"string"!=typeof n&&(r=r||n,n=void 0),t)Ae(e,s,n,r,t[s],o);return e}if(null==r&&null==i?(i=n,r=n=void 0):null==i&&("string"==typeof n?(i=r,r=void 0):(i=r,r=n,n=void 0)),!1===i)i=Se;else if(!i)return e;return 1===o&&(a=i,(i=function(e){return k().off(e),a.apply(this,arguments)}).guid=a.guid||(a.guid=k.guid++)),e.each(function(){k.event.add(this,t,i,r,n)})}function De(e,i,o){o?(Q.set(e,i,!1),k.event.add(e,i,{namespace:!1,handler:function(e){var t,n,r=Q.get(this,i);if(1&e.isTrigger&&this[i]){if(r.length)(k.event.special[i]||{}).delegateType&&e.stopPropagation();else if(r=s.call(arguments),Q.set(this,i,r),t=o(this,i),this[i](),r!==(n=Q.get(this,i))||t?Q.set(this,i,!1):n={},r!==n)return e.stopImmediatePropagation(),e.preventDefault(),n.value}else r.length&&(Q.set(this,i,{value:k.event.trigger(k.extend(r[0],k.Event.prototype),r.slice(1),this)}),e.stopImmediatePropagation())}})):void 0===Q.get(e,i)&&k.event.add(e,i,ke)}k.event={global:{},add:function(t,e,n,r,i){var o,a,s,u,l,c,f,p,d,h,g,v=Q.get(t);if(v){n.handler&&(n=(o=n).handler,i=o.selector),i&&k.find.matchesSelector(ie,i),n.guid||(n.guid=k.guid++),(u=v.events)||(u=v.events={}),(a=v.handle)||(a=v.handle=function(e){return"undefined"!=typeof k&&k.event.triggered!==e.type?k.event.dispatch.apply(t,arguments):void 0}),l=(e=(e||"").match(R)||[""]).length;while(l--)d=g=(s=Ee.exec(e[l])||[])[1],h=(s[2]||"").split(".").sort(),d&&(f=k.event.special[d]||{},d=(i?f.delegateType:f.bindType)||d,f=k.event.special[d]||{},c=k.extend({type:d,origType:g,data:r,handler:n,guid:n.guid,selector:i,needsContext:i&&k.expr.match.needsContext.test(i),namespace:h.join(".")},o),(p=u[d])||((p=u[d]=[]).delegateCount=0,f.setup&&!1!==f.setup.call(t,r,h,a)||t.addEventListener&&t.addEventListener(d,a)),f.add&&(f.add.call(t,c),c.handler.guid||(c.handler.guid=n.guid)),i?p.splice(p.delegateCount++,0,c):p.push(c),k.event.global[d]=!0)}},remove:function(e,t,n,r,i){var o,a,s,u,l,c,f,p,d,h,g,v=Q.hasData(e)&&Q.get(e);if(v&&(u=v.events)){l=(t=(t||"").match(R)||[""]).length;while(l--)if(d=g=(s=Ee.exec(t[l])||[])[1],h=(s[2]||"").split(".").sort(),d){f=k.event.special[d]||{},p=u[d=(r?f.delegateType:f.bindType)||d]||[],s=s[2]&&new RegExp("(^|\\.)"+h.join("\\.(?:.*\\.|)")+"(\\.|$)"),a=o=p.length;while(o--)c=p[o],!i&&g!==c.origType||n&&n.guid!==c.guid||s&&!s.test(c.namespace)||r&&r!==c.selector&&("**"!==r||!c.selector)||(p.splice(o,1),c.selector&&p.delegateCount--,f.remove&&f.remove.call(e,c));a&&!p.length&&(f.teardown&&!1!==f.teardown.call(e,h,v.handle)||k.removeEvent(e,d,v.handle),delete u[d])}else for(d in u)k.event.remove(e,d+t[l],n,r,!0);k.isEmptyObject(u)&&Q.remove(e,"handle events")}},dispatch:function(e){var t,n,r,i,o,a,s=k.event.fix(e),u=new Array(arguments.length),l=(Q.get(this,"events")||{})[s.type]||[],c=k.event.special[s.type]||{};for(u[0]=s,t=1;t<arguments.length;t++)u[t]=arguments[t];if(s.delegateTarget=this,!c.preDispatch||!1!==c.preDispatch.call(this,s)){a=k.event.handlers.call(this,s,l),t=0;while((i=a[t++])&&!s.isPropagationStopped()){s.currentTarget=i.elem,n=0;while((o=i.handlers[n++])&&!s.isImmediatePropagationStopped())s.rnamespace&&!1!==o.namespace&&!s.rnamespace.test(o.namespace)||(s.handleObj=o,s.data=o.data,void 0!==(r=((k.event.special[o.origType]||{}).handle||o.handler).apply(i.elem,u))&&!1===(s.result=r)&&(s.preventDefault(),s.stopPropagation()))}return c.postDispatch&&c.postDispatch.call(this,s),s.result}},handlers:function(e,t){var n,r,i,o,a,s=[],u=t.delegateCount,l=e.target;if(u&&l.nodeType&&!("click"===e.type&&1<=e.button))for(;l!==this;l=l.parentNode||this)if(1===l.nodeType&&("click"!==e.type||!0!==l.disabled)){for(o=[],a={},n=0;n<u;n++)void 0===a[i=(r=t[n]).selector+" "]&&(a[i]=r.needsContext?-1<k(i,this).index(l):k.find(i,this,null,[l]).length),a[i]&&o.push(r);o.length&&s.push({elem:l,handlers:o})}return l=this,u<t.length&&s.push({elem:l,handlers:t.slice(u)}),s},addProp:function(t,e){Object.defineProperty(k.Event.prototype,t,{enumerable:!0,configurable:!0,get:m(e)?function(){if(this.originalEvent)return e(this.originalEvent)}:function(){if(this.originalEvent)return this.originalEvent[t]},set:function(e){Object.defineProperty(this,t,{enumerable:!0,configurable:!0,writable:!0,value:e})}})},fix:function(e){return e[k.expando]?e:new k.Event(e)},special:{load:{noBubble:!0},click:{setup:function(e){var t=this||e;return pe.test(t.type)&&t.click&&A(t,"input")&&De(t,"click",ke),!1},trigger:function(e){var t=this||e;return pe.test(t.type)&&t.click&&A(t,"input")&&De(t,"click"),!0},_default:function(e){var t=e.target;return pe.test(t.type)&&t.click&&A(t,"input")&&Q.get(t,"click")||A(t,"a")}},beforeunload:{postDispatch:function(e){void 0!==e.result&&e.originalEvent&&(e.originalEvent.returnValue=e.result)}}}},k.removeEvent=function(e,t,n){e.removeEventListener&&e.removeEventListener(t,n)},k.Event=function(e,t){if(!(this instanceof k.Event))return new k.Event(e,t);e&&e.type?(this.originalEvent=e,this.type=e.type,this.isDefaultPrevented=e.defaultPrevented||void 0===e.defaultPrevented&&!1===e.returnValue?ke:Se,this.target=e.target&&3===e.target.nodeType?e.target.parentNode:e.target,this.currentTarget=e.currentTarget,this.relatedTarget=e.relatedTarget):this.type=e,t&&k.extend(this,t),this.timeStamp=e&&e.timeStamp||Date.now(),this[k.expando]=!0},k.Event.prototype={constructor:k.Event,isDefaultPrevented:Se,isPropagationStopped:Se,isImmediatePropagationStopped:Se,isSimulated:!1,preventDefault:function(){var e=this.originalEvent;this.isDefaultPrevented=ke,e&&!this.isSimulated&&e.preventDefault()},stopPropagation:function(){var e=this.originalEvent;this.isPropagationStopped=ke,e&&!this.isSimulated&&e.stopPropagation()},stopImmediatePropagation:function(){var e=this.originalEvent;this.isImmediatePropagationStopped=ke,e&&!this.isSimulated&&e.stopImmediatePropagation(),this.stopPropagation()}},k.each({altKey:!0,bubbles:!0,cancelable:!0,changedTouches:!0,ctrlKey:!0,detail:!0,eventPhase:!0,metaKey:!0,pageX:!0,pageY:!0,shiftKey:!0,view:!0,"char":!0,code:!0,charCode:!0,key:!0,keyCode:!0,button:!0,buttons:!0,clientX:!0,clientY:!0,offsetX:!0,offsetY:!0,pointerId:!0,pointerType:!0,screenX:!0,screenY:!0,targetTouches:!0,toElement:!0,touches:!0,which:function(e){var t=e.button;return null==e.which&&Te.test(e.type)?null!=e.charCode?e.charCode:e.keyCode:!e.which&&void 0!==t&&Ce.test(e.type)?1&t?1:2&t?3:4&t?2:0:e.which}},k.event.addProp),k.each({focus:"focusin",blur:"focusout"},function(e,t){k.event.special[e]={setup:function(){return De(this,e,Ne),!1},trigger:function(){return De(this,e),!0},delegateType:t}}),k.each({mouseenter:"mouseover",mouseleave:"mouseout",pointerenter:"pointerover",pointerleave:"pointerout"},function(e,i){k.event.special[e]={delegateType:i,bindType:i,handle:function(e){var t,n=e.relatedTarget,r=e.handleObj;return n&&(n===this||k.contains(this,n))||(e.type=r.origType,t=r.handler.apply(this,arguments),e.type=i),t}}}),k.fn.extend({on:function(e,t,n,r){return Ae(this,e,t,n,r)},one:function(e,t,n,r){return Ae(this,e,t,n,r,1)},off:function(e,t,n){var r,i;if(e&&e.preventDefault&&e.handleObj)return r=e.handleObj,k(e.delegateTarget).off(r.namespace?r.origType+"."+r.namespace:r.origType,r.selector,r.handler),this;if("object"==typeof e){for(i in e)this.off(i,t,e[i]);return this}return!1!==t&&"function"!=typeof t||(n=t,t=void 0),!1===n&&(n=Se),this.each(function(){k.event.remove(this,e,n,t)})}});var je=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([a-z][^\/\0>\x20\t\r\n\f]*)[^>]*)\/>/gi,qe=/<script|<style|<link/i,Le=/checked\s*(?:[^=]|=\s*.checked.)/i,He=/^\s*<!(?:\[CDATA\[|--)|(?:\]\]|--)>\s*$/g;function Oe(e,t){return A(e,"table")&&A(11!==t.nodeType?t:t.firstChild,"tr")&&k(e).children("tbody")[0]||e}function Pe(e){return e.type=(null!==e.getAttribute("type"))+"/"+e.type,e}function Re(e){return"true/"===(e.type||"").slice(0,5)?e.type=e.type.slice(5):e.removeAttribute("type"),e}function Me(e,t){var n,r,i,o,a,s,u,l;if(1===t.nodeType){if(Q.hasData(e)&&(o=Q.access(e),a=Q.set(t,o),l=o.events))for(i in delete a.handle,a.events={},l)for(n=0,r=l[i].length;n<r;n++)k.event.add(t,i,l[i][n]);J.hasData(e)&&(s=J.access(e),u=k.extend({},s),J.set(t,u))}}function Ie(n,r,i,o){r=g.apply([],r);var e,t,a,s,u,l,c=0,f=n.length,p=f-1,d=r[0],h=m(d);if(h||1<f&&"string"==typeof d&&!y.checkClone&&Le.test(d))return n.each(function(e){var t=n.eq(e);h&&(r[0]=d.call(this,e,t.html())),Ie(t,r,i,o)});if(f&&(t=(e=we(r,n[0].ownerDocument,!1,n,o)).firstChild,1===e.childNodes.length&&(e=t),t||o)){for(s=(a=k.map(ve(e,"script"),Pe)).length;c<f;c++)u=e,c!==p&&(u=k.clone(u,!0,!0),s&&k.merge(a,ve(u,"script"))),i.call(n[c],u,c);if(s)for(l=a[a.length-1].ownerDocument,k.map(a,Re),c=0;c<s;c++)u=a[c],he.test(u.type||"")&&!Q.access(u,"globalEval")&&k.contains(l,u)&&(u.src&&"module"!==(u.type||"").toLowerCase()?k._evalUrl&&!u.noModule&&k._evalUrl(u.src,{nonce:u.nonce||u.getAttribute("nonce")}):b(u.textContent.replace(He,""),u,l))}return n}function We(e,t,n){for(var r,i=t?k.filter(t,e):e,o=0;null!=(r=i[o]);o++)n||1!==r.nodeType||k.cleanData(ve(r)),r.parentNode&&(n&&oe(r)&&ye(ve(r,"script")),r.parentNode.removeChild(r));return e}k.extend({htmlPrefilter:function(e){return e.replace(je,"<$1></$2>")},clone:function(e,t,n){var r,i,o,a,s,u,l,c=e.cloneNode(!0),f=oe(e);if(!(y.noCloneChecked||1!==e.nodeType&&11!==e.nodeType||k.isXMLDoc(e)))for(a=ve(c),r=0,i=(o=ve(e)).length;r<i;r++)s=o[r],u=a[r],void 0,"input"===(l=u.nodeName.toLowerCase())&&pe.test(s.type)?u.checked=s.checked:"input"!==l&&"textarea"!==l||(u.defaultValue=s.defaultValue);if(t)if(n)for(o=o||ve(e),a=a||ve(c),r=0,i=o.length;r<i;r++)Me(o[r],a[r]);else Me(e,c);return 0<(a=ve(c,"script")).length&&ye(a,!f&&ve(e,"script")),c},cleanData:function(e){for(var t,n,r,i=k.event.special,o=0;void 0!==(n=e[o]);o++)if(G(n)){if(t=n[Q.expando]){if(t.events)for(r in t.events)i[r]?k.event.remove(n,r):k.removeEvent(n,r,t.handle);n[Q.expando]=void 0}n[J.expando]&&(n[J.expando]=void 0)}}}),k.fn.extend({detach:function(e){return We(this,e,!0)},remove:function(e){return We(this,e)},text:function(e){return _(this,function(e){return void 0===e?k.text(this):this.empty().each(function(){1!==this.nodeType&&11!==this.nodeType&&9!==this.nodeType||(this.textContent=e)})},null,e,arguments.length)},append:function(){return Ie(this,arguments,function(e){1!==this.nodeType&&11!==this.nodeType&&9!==this.nodeType||Oe(this,e).appendChild(e)})},prepend:function(){return Ie(this,arguments,function(e){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var t=Oe(this,e);t.insertBefore(e,t.firstChild)}})},before:function(){return Ie(this,arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this)})},after:function(){return Ie(this,arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this.nextSibling)})},empty:function(){for(var e,t=0;null!=(e=this[t]);t++)1===e.nodeType&&(k.cleanData(ve(e,!1)),e.textContent="");return this},clone:function(e,t){return e=null!=e&&e,t=null==t?e:t,this.map(function(){return k.clone(this,e,t)})},html:function(e){return _(this,function(e){var t=this[0]||{},n=0,r=this.length;if(void 0===e&&1===t.nodeType)return t.innerHTML;if("string"==typeof e&&!qe.test(e)&&!ge[(de.exec(e)||["",""])[1].toLowerCase()]){e=k.htmlPrefilter(e);try{for(;n<r;n++)1===(t=this[n]||{}).nodeType&&(k.cleanData(ve(t,!1)),t.innerHTML=e);t=0}catch(e){}}t&&this.empty().append(e)},null,e,arguments.length)},replaceWith:function(){var n=[];return Ie(this,arguments,function(e){var t=this.parentNode;k.inArray(this,n)<0&&(k.cleanData(ve(this)),t&&t.replaceChild(e,this))},n)}}),k.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(e,a){k.fn[e]=function(e){for(var t,n=[],r=k(e),i=r.length-1,o=0;o<=i;o++)t=o===i?this:this.clone(!0),k(r[o])[a](t),u.apply(n,t.get());return this.pushStack(n)}});var $e=new RegExp("^("+te+")(?!px)[a-z%]+$","i"),Fe=function(e){var t=e.ownerDocument.defaultView;return t&&t.opener||(t=C),t.getComputedStyle(e)},Be=new RegExp(re.join("|"),"i");function _e(e,t,n){var r,i,o,a,s=e.style;return(n=n||Fe(e))&&(""!==(a=n.getPropertyValue(t)||n[t])||oe(e)||(a=k.style(e,t)),!y.pixelBoxStyles()&&$e.test(a)&&Be.test(t)&&(r=s.width,i=s.minWidth,o=s.maxWidth,s.minWidth=s.maxWidth=s.width=a,a=n.width,s.width=r,s.minWidth=i,s.maxWidth=o)),void 0!==a?a+"":a}function ze(e,t){return{get:function(){if(!e())return(this.get=t).apply(this,arguments);delete this.get}}}!function(){function e(){if(u){s.style.cssText="position:absolute;left:-11111px;width:60px;margin-top:1px;padding:0;border:0",u.style.cssText="position:relative;display:block;box-sizing:border-box;overflow:scroll;margin:auto;border:1px;padding:1px;width:60%;top:1%",ie.appendChild(s).appendChild(u);var e=C.getComputedStyle(u);n="1%"!==e.top,a=12===t(e.marginLeft),u.style.right="60%",o=36===t(e.right),r=36===t(e.width),u.style.position="absolute",i=12===t(u.offsetWidth/3),ie.removeChild(s),u=null}}function t(e){return Math.round(parseFloat(e))}var n,r,i,o,a,s=E.createElement("div"),u=E.createElement("div");u.style&&(u.style.backgroundClip="content-box",u.cloneNode(!0).style.backgroundClip="",y.clearCloneStyle="content-box"===u.style.backgroundClip,k.extend(y,{boxSizingReliable:function(){return e(),r},pixelBoxStyles:function(){return e(),o},pixelPosition:function(){return e(),n},reliableMarginLeft:function(){return e(),a},scrollboxSize:function(){return e(),i}}))}();var Ue=["Webkit","Moz","ms"],Xe=E.createElement("div").style,Ve={};function Ge(e){var t=k.cssProps[e]||Ve[e];return t||(e in Xe?e:Ve[e]=function(e){var t=e[0].toUpperCase()+e.slice(1),n=Ue.length;while(n--)if((e=Ue[n]+t)in Xe)return e}(e)||e)}var Ye=/^(none|table(?!-c[ea]).+)/,Qe=/^--/,Je={position:"absolute",visibility:"hidden",display:"block"},Ke={letterSpacing:"0",fontWeight:"400"};function Ze(e,t,n){var r=ne.exec(t);return r?Math.max(0,r[2]-(n||0))+(r[3]||"px"):t}function et(e,t,n,r,i,o){var a="width"===t?1:0,s=0,u=0;if(n===(r?"border":"content"))return 0;for(;a<4;a+=2)"margin"===n&&(u+=k.css(e,n+re[a],!0,i)),r?("content"===n&&(u-=k.css(e,"padding"+re[a],!0,i)),"margin"!==n&&(u-=k.css(e,"border"+re[a]+"Width",!0,i))):(u+=k.css(e,"padding"+re[a],!0,i),"padding"!==n?u+=k.css(e,"border"+re[a]+"Width",!0,i):s+=k.css(e,"border"+re[a]+"Width",!0,i));return!r&&0<=o&&(u+=Math.max(0,Math.ceil(e["offset"+t[0].toUpperCase()+t.slice(1)]-o-u-s-.5))||0),u}function tt(e,t,n){var r=Fe(e),i=(!y.boxSizingReliable()||n)&&"border-box"===k.css(e,"boxSizing",!1,r),o=i,a=_e(e,t,r),s="offset"+t[0].toUpperCase()+t.slice(1);if($e.test(a)){if(!n)return a;a="auto"}return(!y.boxSizingReliable()&&i||"auto"===a||!parseFloat(a)&&"inline"===k.css(e,"display",!1,r))&&e.getClientRects().length&&(i="border-box"===k.css(e,"boxSizing",!1,r),(o=s in e)&&(a=e[s])),(a=parseFloat(a)||0)+et(e,t,n||(i?"border":"content"),o,r,a)+"px"}function nt(e,t,n,r,i){return new nt.prototype.init(e,t,n,r,i)}k.extend({cssHooks:{opacity:{get:function(e,t){if(t){var n=_e(e,"opacity");return""===n?"1":n}}}},cssNumber:{animationIterationCount:!0,columnCount:!0,fillOpacity:!0,flexGrow:!0,flexShrink:!0,fontWeight:!0,gridArea:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnStart:!0,gridRow:!0,gridRowEnd:!0,gridRowStart:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{},style:function(e,t,n,r){if(e&&3!==e.nodeType&&8!==e.nodeType&&e.style){var i,o,a,s=V(t),u=Qe.test(t),l=e.style;if(u||(t=Ge(s)),a=k.cssHooks[t]||k.cssHooks[s],void 0===n)return a&&"get"in a&&void 0!==(i=a.get(e,!1,r))?i:l[t];"string"===(o=typeof n)&&(i=ne.exec(n))&&i[1]&&(n=le(e,t,i),o="number"),null!=n&&n==n&&("number"!==o||u||(n+=i&&i[3]||(k.cssNumber[s]?"":"px")),y.clearCloneStyle||""!==n||0!==t.indexOf("background")||(l[t]="inherit"),a&&"set"in a&&void 0===(n=a.set(e,n,r))||(u?l.setProperty(t,n):l[t]=n))}},css:function(e,t,n,r){var i,o,a,s=V(t);return Qe.test(t)||(t=Ge(s)),(a=k.cssHooks[t]||k.cssHooks[s])&&"get"in a&&(i=a.get(e,!0,n)),void 0===i&&(i=_e(e,t,r)),"normal"===i&&t in Ke&&(i=Ke[t]),""===n||n?(o=parseFloat(i),!0===n||isFinite(o)?o||0:i):i}}),k.each(["height","width"],function(e,u){k.cssHooks[u]={get:function(e,t,n){if(t)return!Ye.test(k.css(e,"display"))||e.getClientRects().length&&e.getBoundingClientRect().width?tt(e,u,n):ue(e,Je,function(){return tt(e,u,n)})},set:function(e,t,n){var r,i=Fe(e),o=!y.scrollboxSize()&&"absolute"===i.position,a=(o||n)&&"border-box"===k.css(e,"boxSizing",!1,i),s=n?et(e,u,n,a,i):0;return a&&o&&(s-=Math.ceil(e["offset"+u[0].toUpperCase()+u.slice(1)]-parseFloat(i[u])-et(e,u,"border",!1,i)-.5)),s&&(r=ne.exec(t))&&"px"!==(r[3]||"px")&&(e.style[u]=t,t=k.css(e,u)),Ze(0,t,s)}}}),k.cssHooks.marginLeft=ze(y.reliableMarginLeft,function(e,t){if(t)return(parseFloat(_e(e,"marginLeft"))||e.getBoundingClientRect().left-ue(e,{marginLeft:0},function(){return e.getBoundingClientRect().left}))+"px"}),k.each({margin:"",padding:"",border:"Width"},function(i,o){k.cssHooks[i+o]={expand:function(e){for(var t=0,n={},r="string"==typeof e?e.split(" "):[e];t<4;t++)n[i+re[t]+o]=r[t]||r[t-2]||r[0];return n}},"margin"!==i&&(k.cssHooks[i+o].set=Ze)}),k.fn.extend({css:function(e,t){return _(this,function(e,t,n){var r,i,o={},a=0;if(Array.isArray(t)){for(r=Fe(e),i=t.length;a<i;a++)o[t[a]]=k.css(e,t[a],!1,r);return o}return void 0!==n?k.style(e,t,n):k.css(e,t)},e,t,1<arguments.length)}}),((k.Tween=nt).prototype={constructor:nt,init:function(e,t,n,r,i,o){this.elem=e,this.prop=n,this.easing=i||k.easing._default,this.options=t,this.start=this.now=this.cur(),this.end=r,this.unit=o||(k.cssNumber[n]?"":"px")},cur:function(){var e=nt.propHooks[this.prop];return e&&e.get?e.get(this):nt.propHooks._default.get(this)},run:function(e){var t,n=nt.propHooks[this.prop];return this.options.duration?this.pos=t=k.easing[this.easing](e,this.options.duration*e,0,1,this.options.duration):this.pos=t=e,this.now=(this.end-this.start)*t+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),n&&n.set?n.set(this):nt.propHooks._default.set(this),this}}).init.prototype=nt.prototype,(nt.propHooks={_default:{get:function(e){var t;return 1!==e.elem.nodeType||null!=e.elem[e.prop]&&null==e.elem.style[e.prop]?e.elem[e.prop]:(t=k.css(e.elem,e.prop,""))&&"auto"!==t?t:0},set:function(e){k.fx.step[e.prop]?k.fx.step[e.prop](e):1!==e.elem.nodeType||!k.cssHooks[e.prop]&&null==e.elem.style[Ge(e.prop)]?e.elem[e.prop]=e.now:k.style(e.elem,e.prop,e.now+e.unit)}}}).scrollTop=nt.propHooks.scrollLeft={set:function(e){e.elem.nodeType&&e.elem.parentNode&&(e.elem[e.prop]=e.now)}},k.easing={linear:function(e){return e},swing:function(e){return.5-Math.cos(e*Math.PI)/2},_default:"swing"},k.fx=nt.prototype.init,k.fx.step={};var rt,it,ot,at,st=/^(?:toggle|show|hide)$/,ut=/queueHooks$/;function lt(){it&&(!1===E.hidden&&C.requestAnimationFrame?C.requestAnimationFrame(lt):C.setTimeout(lt,k.fx.interval),k.fx.tick())}function ct(){return C.setTimeout(function(){rt=void 0}),rt=Date.now()}function ft(e,t){var n,r=0,i={height:e};for(t=t?1:0;r<4;r+=2-t)i["margin"+(n=re[r])]=i["padding"+n]=e;return t&&(i.opacity=i.width=e),i}function pt(e,t,n){for(var r,i=(dt.tweeners[t]||[]).concat(dt.tweeners["*"]),o=0,a=i.length;o<a;o++)if(r=i[o].call(n,t,e))return r}function dt(o,e,t){var n,a,r=0,i=dt.prefilters.length,s=k.Deferred().always(function(){delete u.elem}),u=function(){if(a)return!1;for(var e=rt||ct(),t=Math.max(0,l.startTime+l.duration-e),n=1-(t/l.duration||0),r=0,i=l.tweens.length;r<i;r++)l.tweens[r].run(n);return s.notifyWith(o,[l,n,t]),n<1&&i?t:(i||s.notifyWith(o,[l,1,0]),s.resolveWith(o,[l]),!1)},l=s.promise({elem:o,props:k.extend({},e),opts:k.extend(!0,{specialEasing:{},easing:k.easing._default},t),originalProperties:e,originalOptions:t,startTime:rt||ct(),duration:t.duration,tweens:[],createTween:function(e,t){var n=k.Tween(o,l.opts,e,t,l.opts.specialEasing[e]||l.opts.easing);return l.tweens.push(n),n},stop:function(e){var t=0,n=e?l.tweens.length:0;if(a)return this;for(a=!0;t<n;t++)l.tweens[t].run(1);return e?(s.notifyWith(o,[l,1,0]),s.resolveWith(o,[l,e])):s.rejectWith(o,[l,e]),this}}),c=l.props;for(!function(e,t){var n,r,i,o,a;for(n in e)if(i=t[r=V(n)],o=e[n],Array.isArray(o)&&(i=o[1],o=e[n]=o[0]),n!==r&&(e[r]=o,delete e[n]),(a=k.cssHooks[r])&&"expand"in a)for(n in o=a.expand(o),delete e[r],o)n in e||(e[n]=o[n],t[n]=i);else t[r]=i}(c,l.opts.specialEasing);r<i;r++)if(n=dt.prefilters[r].call(l,o,c,l.opts))return m(n.stop)&&(k._queueHooks(l.elem,l.opts.queue).stop=n.stop.bind(n)),n;return k.map(c,pt,l),m(l.opts.start)&&l.opts.start.call(o,l),l.progress(l.opts.progress).done(l.opts.done,l.opts.complete).fail(l.opts.fail).always(l.opts.always),k.fx.timer(k.extend(u,{elem:o,anim:l,queue:l.opts.queue})),l}k.Animation=k.extend(dt,{tweeners:{"*":[function(e,t){var n=this.createTween(e,t);return le(n.elem,e,ne.exec(t),n),n}]},tweener:function(e,t){m(e)?(t=e,e=["*"]):e=e.match(R);for(var n,r=0,i=e.length;r<i;r++)n=e[r],dt.tweeners[n]=dt.tweeners[n]||[],dt.tweeners[n].unshift(t)},prefilters:[function(e,t,n){var r,i,o,a,s,u,l,c,f="width"in t||"height"in t,p=this,d={},h=e.style,g=e.nodeType&&se(e),v=Q.get(e,"fxshow");for(r in n.queue||(null==(a=k._queueHooks(e,"fx")).unqueued&&(a.unqueued=0,s=a.empty.fire,a.empty.fire=function(){a.unqueued||s()}),a.unqueued++,p.always(function(){p.always(function(){a.unqueued--,k.queue(e,"fx").length||a.empty.fire()})})),t)if(i=t[r],st.test(i)){if(delete t[r],o=o||"toggle"===i,i===(g?"hide":"show")){if("show"!==i||!v||void 0===v[r])continue;g=!0}d[r]=v&&v[r]||k.style(e,r)}if((u=!k.isEmptyObject(t))||!k.isEmptyObject(d))for(r in f&&1===e.nodeType&&(n.overflow=[h.overflow,h.overflowX,h.overflowY],null==(l=v&&v.display)&&(l=Q.get(e,"display")),"none"===(c=k.css(e,"display"))&&(l?c=l:(fe([e],!0),l=e.style.display||l,c=k.css(e,"display"),fe([e]))),("inline"===c||"inline-block"===c&&null!=l)&&"none"===k.css(e,"float")&&(u||(p.done(function(){h.display=l}),null==l&&(c=h.display,l="none"===c?"":c)),h.display="inline-block")),n.overflow&&(h.overflow="hidden",p.always(function(){h.overflow=n.overflow[0],h.overflowX=n.overflow[1],h.overflowY=n.overflow[2]})),u=!1,d)u||(v?"hidden"in v&&(g=v.hidden):v=Q.access(e,"fxshow",{display:l}),o&&(v.hidden=!g),g&&fe([e],!0),p.done(function(){for(r in g||fe([e]),Q.remove(e,"fxshow"),d)k.style(e,r,d[r])})),u=pt(g?v[r]:0,r,p),r in v||(v[r]=u.start,g&&(u.end=u.start,u.start=0))}],prefilter:function(e,t){t?dt.prefilters.unshift(e):dt.prefilters.push(e)}}),k.speed=function(e,t,n){var r=e&&"object"==typeof e?k.extend({},e):{complete:n||!n&&t||m(e)&&e,duration:e,easing:n&&t||t&&!m(t)&&t};return k.fx.off?r.duration=0:"number"!=typeof r.duration&&(r.duration in k.fx.speeds?r.duration=k.fx.speeds[r.duration]:r.duration=k.fx.speeds._default),null!=r.queue&&!0!==r.queue||(r.queue="fx"),r.old=r.complete,r.complete=function(){m(r.old)&&r.old.call(this),r.queue&&k.dequeue(this,r.queue)},r},k.fn.extend({fadeTo:function(e,t,n,r){return this.filter(se).css("opacity",0).show().end().animate({opacity:t},e,n,r)},animate:function(t,e,n,r){var i=k.isEmptyObject(t),o=k.speed(e,n,r),a=function(){var e=dt(this,k.extend({},t),o);(i||Q.get(this,"finish"))&&e.stop(!0)};return a.finish=a,i||!1===o.queue?this.each(a):this.queue(o.queue,a)},stop:function(i,e,o){var a=function(e){var t=e.stop;delete e.stop,t(o)};return"string"!=typeof i&&(o=e,e=i,i=void 0),e&&!1!==i&&this.queue(i||"fx",[]),this.each(function(){var e=!0,t=null!=i&&i+"queueHooks",n=k.timers,r=Q.get(this);if(t)r[t]&&r[t].stop&&a(r[t]);else for(t in r)r[t]&&r[t].stop&&ut.test(t)&&a(r[t]);for(t=n.length;t--;)n[t].elem!==this||null!=i&&n[t].queue!==i||(n[t].anim.stop(o),e=!1,n.splice(t,1));!e&&o||k.dequeue(this,i)})},finish:function(a){return!1!==a&&(a=a||"fx"),this.each(function(){var e,t=Q.get(this),n=t[a+"queue"],r=t[a+"queueHooks"],i=k.timers,o=n?n.length:0;for(t.finish=!0,k.queue(this,a,[]),r&&r.stop&&r.stop.call(this,!0),e=i.length;e--;)i[e].elem===this&&i[e].queue===a&&(i[e].anim.stop(!0),i.splice(e,1));for(e=0;e<o;e++)n[e]&&n[e].finish&&n[e].finish.call(this);delete t.finish})}}),k.each(["toggle","show","hide"],function(e,r){var i=k.fn[r];k.fn[r]=function(e,t,n){return null==e||"boolean"==typeof e?i.apply(this,arguments):this.animate(ft(r,!0),e,t,n)}}),k.each({slideDown:ft("show"),slideUp:ft("hide"),slideToggle:ft("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(e,r){k.fn[e]=function(e,t,n){return this.animate(r,e,t,n)}}),k.timers=[],k.fx.tick=function(){var e,t=0,n=k.timers;for(rt=Date.now();t<n.length;t++)(e=n[t])()||n[t]!==e||n.splice(t--,1);n.length||k.fx.stop(),rt=void 0},k.fx.timer=function(e){k.timers.push(e),k.fx.start()},k.fx.interval=13,k.fx.start=function(){it||(it=!0,lt())},k.fx.stop=function(){it=null},k.fx.speeds={slow:600,fast:200,_default:400},k.fn.delay=function(r,e){return r=k.fx&&k.fx.speeds[r]||r,e=e||"fx",this.queue(e,function(e,t){var n=C.setTimeout(e,r);t.stop=function(){C.clearTimeout(n)}})},ot=E.createElement("input"),at=E.createElement("select").appendChild(E.createElement("option")),ot.type="checkbox",y.checkOn=""!==ot.value,y.optSelected=at.selected,(ot=E.createElement("input")).value="t",ot.type="radio",y.radioValue="t"===ot.value;var ht,gt=k.expr.attrHandle;k.fn.extend({attr:function(e,t){return _(this,k.attr,e,t,1<arguments.length)},removeAttr:function(e){return this.each(function(){k.removeAttr(this,e)})}}),k.extend({attr:function(e,t,n){var r,i,o=e.nodeType;if(3!==o&&8!==o&&2!==o)return"undefined"==typeof e.getAttribute?k.prop(e,t,n):(1===o&&k.isXMLDoc(e)||(i=k.attrHooks[t.toLowerCase()]||(k.expr.match.bool.test(t)?ht:void 0)),void 0!==n?null===n?void k.removeAttr(e,t):i&&"set"in i&&void 0!==(r=i.set(e,n,t))?r:(e.setAttribute(t,n+""),n):i&&"get"in i&&null!==(r=i.get(e,t))?r:null==(r=k.find.attr(e,t))?void 0:r)},attrHooks:{type:{set:function(e,t){if(!y.radioValue&&"radio"===t&&A(e,"input")){var n=e.value;return e.setAttribute("type",t),n&&(e.value=n),t}}}},removeAttr:function(e,t){var n,r=0,i=t&&t.match(R);if(i&&1===e.nodeType)while(n=i[r++])e.removeAttribute(n)}}),ht={set:function(e,t,n){return!1===t?k.removeAttr(e,n):e.setAttribute(n,n),n}},k.each(k.expr.match.bool.source.match(/\w+/g),function(e,t){var a=gt[t]||k.find.attr;gt[t]=function(e,t,n){var r,i,o=t.toLowerCase();return n||(i=gt[o],gt[o]=r,r=null!=a(e,t,n)?o:null,gt[o]=i),r}});var vt=/^(?:input|select|textarea|button)$/i,yt=/^(?:a|area)$/i;function mt(e){return(e.match(R)||[]).join(" ")}function xt(e){return e.getAttribute&&e.getAttribute("class")||""}function bt(e){return Array.isArray(e)?e:"string"==typeof e&&e.match(R)||[]}k.fn.extend({prop:function(e,t){return _(this,k.prop,e,t,1<arguments.length)},removeProp:function(e){return this.each(function(){delete this[k.propFix[e]||e]})}}),k.extend({prop:function(e,t,n){var r,i,o=e.nodeType;if(3!==o&&8!==o&&2!==o)return 1===o&&k.isXMLDoc(e)||(t=k.propFix[t]||t,i=k.propHooks[t]),void 0!==n?i&&"set"in i&&void 0!==(r=i.set(e,n,t))?r:e[t]=n:i&&"get"in i&&null!==(r=i.get(e,t))?r:e[t]},propHooks:{tabIndex:{get:function(e){var t=k.find.attr(e,"tabindex");return t?parseInt(t,10):vt.test(e.nodeName)||yt.test(e.nodeName)&&e.href?0:-1}}},propFix:{"for":"htmlFor","class":"className"}}),y.optSelected||(k.propHooks.selected={get:function(e){var t=e.parentNode;return t&&t.parentNode&&t.parentNode.selectedIndex,null},set:function(e){var t=e.parentNode;t&&(t.selectedIndex,t.parentNode&&t.parentNode.selectedIndex)}}),k.each(["tabIndex","readOnly","maxLength","cellSpacing","cellPadding","rowSpan","colSpan","useMap","frameBorder","contentEditable"],function(){k.propFix[this.toLowerCase()]=this}),k.fn.extend({addClass:function(t){var e,n,r,i,o,a,s,u=0;if(m(t))return this.each(function(e){k(this).addClass(t.call(this,e,xt(this)))});if((e=bt(t)).length)while(n=this[u++])if(i=xt(n),r=1===n.nodeType&&" "+mt(i)+" "){a=0;while(o=e[a++])r.indexOf(" "+o+" ")<0&&(r+=o+" ");i!==(s=mt(r))&&n.setAttribute("class",s)}return this},removeClass:function(t){var e,n,r,i,o,a,s,u=0;if(m(t))return this.each(function(e){k(this).removeClass(t.call(this,e,xt(this)))});if(!arguments.length)return this.attr("class","");if((e=bt(t)).length)while(n=this[u++])if(i=xt(n),r=1===n.nodeType&&" "+mt(i)+" "){a=0;while(o=e[a++])while(-1<r.indexOf(" "+o+" "))r=r.replace(" "+o+" "," ");i!==(s=mt(r))&&n.setAttribute("class",s)}return this},toggleClass:function(i,t){var o=typeof i,a="string"===o||Array.isArray(i);return"boolean"==typeof t&&a?t?this.addClass(i):this.removeClass(i):m(i)?this.each(function(e){k(this).toggleClass(i.call(this,e,xt(this),t),t)}):this.each(function(){var e,t,n,r;if(a){t=0,n=k(this),r=bt(i);while(e=r[t++])n.hasClass(e)?n.removeClass(e):n.addClass(e)}else void 0!==i&&"boolean"!==o||((e=xt(this))&&Q.set(this,"__className__",e),this.setAttribute&&this.setAttribute("class",e||!1===i?"":Q.get(this,"__className__")||""))})},hasClass:function(e){var t,n,r=0;t=" "+e+" ";while(n=this[r++])if(1===n.nodeType&&-1<(" "+mt(xt(n))+" ").indexOf(t))return!0;return!1}});var wt=/\r/g;k.fn.extend({val:function(n){var r,e,i,t=this[0];return arguments.length?(i=m(n),this.each(function(e){var t;1===this.nodeType&&(null==(t=i?n.call(this,e,k(this).val()):n)?t="":"number"==typeof t?t+="":Array.isArray(t)&&(t=k.map(t,function(e){return null==e?"":e+""})),(r=k.valHooks[this.type]||k.valHooks[this.nodeName.toLowerCase()])&&"set"in r&&void 0!==r.set(this,t,"value")||(this.value=t))})):t?(r=k.valHooks[t.type]||k.valHooks[t.nodeName.toLowerCase()])&&"get"in r&&void 0!==(e=r.get(t,"value"))?e:"string"==typeof(e=t.value)?e.replace(wt,""):null==e?"":e:void 0}}),k.extend({valHooks:{option:{get:function(e){var t=k.find.attr(e,"value");return null!=t?t:mt(k.text(e))}},select:{get:function(e){var t,n,r,i=e.options,o=e.selectedIndex,a="select-one"===e.type,s=a?null:[],u=a?o+1:i.length;for(r=o<0?u:a?o:0;r<u;r++)if(((n=i[r]).selected||r===o)&&!n.disabled&&(!n.parentNode.disabled||!A(n.parentNode,"optgroup"))){if(t=k(n).val(),a)return t;s.push(t)}return s},set:function(e,t){var n,r,i=e.options,o=k.makeArray(t),a=i.length;while(a--)((r=i[a]).selected=-1<k.inArray(k.valHooks.option.get(r),o))&&(n=!0);return n||(e.selectedIndex=-1),o}}}}),k.each(["radio","checkbox"],function(){k.valHooks[this]={set:function(e,t){if(Array.isArray(t))return e.checked=-1<k.inArray(k(e).val(),t)}},y.checkOn||(k.valHooks[this].get=function(e){return null===e.getAttribute("value")?"on":e.value})}),y.focusin="onfocusin"in C;var Tt=/^(?:focusinfocus|focusoutblur)$/,Ct=function(e){e.stopPropagation()};k.extend(k.event,{trigger:function(e,t,n,r){var i,o,a,s,u,l,c,f,p=[n||E],d=v.call(e,"type")?e.type:e,h=v.call(e,"namespace")?e.namespace.split("."):[];if(o=f=a=n=n||E,3!==n.nodeType&&8!==n.nodeType&&!Tt.test(d+k.event.triggered)&&(-1<d.indexOf(".")&&(d=(h=d.split(".")).shift(),h.sort()),u=d.indexOf(":")<0&&"on"+d,(e=e[k.expando]?e:new k.Event(d,"object"==typeof e&&e)).isTrigger=r?2:3,e.namespace=h.join("."),e.rnamespace=e.namespace?new RegExp("(^|\\.)"+h.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,e.result=void 0,e.target||(e.target=n),t=null==t?[e]:k.makeArray(t,[e]),c=k.event.special[d]||{},r||!c.trigger||!1!==c.trigger.apply(n,t))){if(!r&&!c.noBubble&&!x(n)){for(s=c.delegateType||d,Tt.test(s+d)||(o=o.parentNode);o;o=o.parentNode)p.push(o),a=o;a===(n.ownerDocument||E)&&p.push(a.defaultView||a.parentWindow||C)}i=0;while((o=p[i++])&&!e.isPropagationStopped())f=o,e.type=1<i?s:c.bindType||d,(l=(Q.get(o,"events")||{})[e.type]&&Q.get(o,"handle"))&&l.apply(o,t),(l=u&&o[u])&&l.apply&&G(o)&&(e.result=l.apply(o,t),!1===e.result&&e.preventDefault());return e.type=d,r||e.isDefaultPrevented()||c._default&&!1!==c._default.apply(p.pop(),t)||!G(n)||u&&m(n[d])&&!x(n)&&((a=n[u])&&(n[u]=null),k.event.triggered=d,e.isPropagationStopped()&&f.addEventListener(d,Ct),n[d](),e.isPropagationStopped()&&f.removeEventListener(d,Ct),k.event.triggered=void 0,a&&(n[u]=a)),e.result}},simulate:function(e,t,n){var r=k.extend(new k.Event,n,{type:e,isSimulated:!0});k.event.trigger(r,null,t)}}),k.fn.extend({trigger:function(e,t){return this.each(function(){k.event.trigger(e,t,this)})},triggerHandler:function(e,t){var n=this[0];if(n)return k.event.trigger(e,t,n,!0)}}),y.focusin||k.each({focus:"focusin",blur:"focusout"},function(n,r){var i=function(e){k.event.simulate(r,e.target,k.event.fix(e))};k.event.special[r]={setup:function(){var e=this.ownerDocument||this,t=Q.access(e,r);t||e.addEventListener(n,i,!0),Q.access(e,r,(t||0)+1)},teardown:function(){var e=this.ownerDocument||this,t=Q.access(e,r)-1;t?Q.access(e,r,t):(e.removeEventListener(n,i,!0),Q.remove(e,r))}}});var Et=C.location,kt=Date.now(),St=/\?/;k.parseXML=function(e){var t;if(!e||"string"!=typeof e)return null;try{t=(new C.DOMParser).parseFromString(e,"text/xml")}catch(e){t=void 0}return t&&!t.getElementsByTagName("parsererror").length||k.error("Invalid XML: "+e),t};var Nt=/\[\]$/,At=/\r?\n/g,Dt=/^(?:submit|button|image|reset|file)$/i,jt=/^(?:input|select|textarea|keygen)/i;function qt(n,e,r,i){var t;if(Array.isArray(e))k.each(e,function(e,t){r||Nt.test(n)?i(n,t):qt(n+"["+("object"==typeof t&&null!=t?e:"")+"]",t,r,i)});else if(r||"object"!==w(e))i(n,e);else for(t in e)qt(n+"["+t+"]",e[t],r,i)}k.param=function(e,t){var n,r=[],i=function(e,t){var n=m(t)?t():t;r[r.length]=encodeURIComponent(e)+"="+encodeURIComponent(null==n?"":n)};if(null==e)return"";if(Array.isArray(e)||e.jquery&&!k.isPlainObject(e))k.each(e,function(){i(this.name,this.value)});else for(n in e)qt(n,e[n],t,i);return r.join("&")},k.fn.extend({serialize:function(){return k.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var e=k.prop(this,"elements");return e?k.makeArray(e):this}).filter(function(){var e=this.type;return this.name&&!k(this).is(":disabled")&&jt.test(this.nodeName)&&!Dt.test(e)&&(this.checked||!pe.test(e))}).map(function(e,t){var n=k(this).val();return null==n?null:Array.isArray(n)?k.map(n,function(e){return{name:t.name,value:e.replace(At,"\r\n")}}):{name:t.name,value:n.replace(At,"\r\n")}}).get()}});var Lt=/%20/g,Ht=/#.*$/,Ot=/([?&])_=[^&]*/,Pt=/^(.*?):[ \t]*([^\r\n]*)$/gm,Rt=/^(?:GET|HEAD)$/,Mt=/^\/\//,It={},Wt={},$t="*/".concat("*"),Ft=E.createElement("a");function Bt(o){return function(e,t){"string"!=typeof e&&(t=e,e="*");var n,r=0,i=e.toLowerCase().match(R)||[];if(m(t))while(n=i[r++])"+"===n[0]?(n=n.slice(1)||"*",(o[n]=o[n]||[]).unshift(t)):(o[n]=o[n]||[]).push(t)}}function _t(t,i,o,a){var s={},u=t===Wt;function l(e){var r;return s[e]=!0,k.each(t[e]||[],function(e,t){var n=t(i,o,a);return"string"!=typeof n||u||s[n]?u?!(r=n):void 0:(i.dataTypes.unshift(n),l(n),!1)}),r}return l(i.dataTypes[0])||!s["*"]&&l("*")}function zt(e,t){var n,r,i=k.ajaxSettings.flatOptions||{};for(n in t)void 0!==t[n]&&((i[n]?e:r||(r={}))[n]=t[n]);return r&&k.extend(!0,e,r),e}Ft.href=Et.href,k.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:Et.href,type:"GET",isLocal:/^(?:about|app|app-storage|.+-extension|file|res|widget):$/.test(Et.protocol),global:!0,processData:!0,async:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"*":$t,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/\bxml\b/,html:/\bhtml/,json:/\bjson\b/},responseFields:{xml:"responseXML",text:"responseText",json:"responseJSON"},converters:{"* text":String,"text html":!0,"text json":JSON.parse,"text xml":k.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(e,t){return t?zt(zt(e,k.ajaxSettings),t):zt(k.ajaxSettings,e)},ajaxPrefilter:Bt(It),ajaxTransport:Bt(Wt),ajax:function(e,t){"object"==typeof e&&(t=e,e=void 0),t=t||{};var c,f,p,n,d,r,h,g,i,o,v=k.ajaxSetup({},t),y=v.context||v,m=v.context&&(y.nodeType||y.jquery)?k(y):k.event,x=k.Deferred(),b=k.Callbacks("once memory"),w=v.statusCode||{},a={},s={},u="canceled",T={readyState:0,getResponseHeader:function(e){var t;if(h){if(!n){n={};while(t=Pt.exec(p))n[t[1].toLowerCase()+" "]=(n[t[1].toLowerCase()+" "]||[]).concat(t[2])}t=n[e.toLowerCase()+" "]}return null==t?null:t.join(", ")},getAllResponseHeaders:function(){return h?p:null},setRequestHeader:function(e,t){return null==h&&(e=s[e.toLowerCase()]=s[e.toLowerCase()]||e,a[e]=t),this},overrideMimeType:function(e){return null==h&&(v.mimeType=e),this},statusCode:function(e){var t;if(e)if(h)T.always(e[T.status]);else for(t in e)w[t]=[w[t],e[t]];return this},abort:function(e){var t=e||u;return c&&c.abort(t),l(0,t),this}};if(x.promise(T),v.url=((e||v.url||Et.href)+"").replace(Mt,Et.protocol+"//"),v.type=t.method||t.type||v.method||v.type,v.dataTypes=(v.dataType||"*").toLowerCase().match(R)||[""],null==v.crossDomain){r=E.createElement("a");try{r.href=v.url,r.href=r.href,v.crossDomain=Ft.protocol+"//"+Ft.host!=r.protocol+"//"+r.host}catch(e){v.crossDomain=!0}}if(v.data&&v.processData&&"string"!=typeof v.data&&(v.data=k.param(v.data,v.traditional)),_t(It,v,t,T),h)return T;for(i in(g=k.event&&v.global)&&0==k.active++&&k.event.trigger("ajaxStart"),v.type=v.type.toUpperCase(),v.hasContent=!Rt.test(v.type),f=v.url.replace(Ht,""),v.hasContent?v.data&&v.processData&&0===(v.contentType||"").indexOf("application/x-www-form-urlencoded")&&(v.data=v.data.replace(Lt,"+")):(o=v.url.slice(f.length),v.data&&(v.processData||"string"==typeof v.data)&&(f+=(St.test(f)?"&":"?")+v.data,delete v.data),!1===v.cache&&(f=f.replace(Ot,"$1"),o=(St.test(f)?"&":"?")+"_="+kt+++o),v.url=f+o),v.ifModified&&(k.lastModified[f]&&T.setRequestHeader("If-Modified-Since",k.lastModified[f]),k.etag[f]&&T.setRequestHeader("If-None-Match",k.etag[f])),(v.data&&v.hasContent&&!1!==v.contentType||t.contentType)&&T.setRequestHeader("Content-Type",v.contentType),T.setRequestHeader("Accept",v.dataTypes[0]&&v.accepts[v.dataTypes[0]]?v.accepts[v.dataTypes[0]]+("*"!==v.dataTypes[0]?", "+$t+"; q=0.01":""):v.accepts["*"]),v.headers)T.setRequestHeader(i,v.headers[i]);if(v.beforeSend&&(!1===v.beforeSend.call(y,T,v)||h))return T.abort();if(u="abort",b.add(v.complete),T.done(v.success),T.fail(v.error),c=_t(Wt,v,t,T)){if(T.readyState=1,g&&m.trigger("ajaxSend",[T,v]),h)return T;v.async&&0<v.timeout&&(d=C.setTimeout(function(){T.abort("timeout")},v.timeout));try{h=!1,c.send(a,l)}catch(e){if(h)throw e;l(-1,e)}}else l(-1,"No Transport");function l(e,t,n,r){var i,o,a,s,u,l=t;h||(h=!0,d&&C.clearTimeout(d),c=void 0,p=r||"",T.readyState=0<e?4:0,i=200<=e&&e<300||304===e,n&&(s=function(e,t,n){var r,i,o,a,s=e.contents,u=e.dataTypes;while("*"===u[0])u.shift(),void 0===r&&(r=e.mimeType||t.getResponseHeader("Content-Type"));if(r)for(i in s)if(s[i]&&s[i].test(r)){u.unshift(i);break}if(u[0]in n)o=u[0];else{for(i in n){if(!u[0]||e.converters[i+" "+u[0]]){o=i;break}a||(a=i)}o=o||a}if(o)return o!==u[0]&&u.unshift(o),n[o]}(v,T,n)),s=function(e,t,n,r){var i,o,a,s,u,l={},c=e.dataTypes.slice();if(c[1])for(a in e.converters)l[a.toLowerCase()]=e.converters[a];o=c.shift();while(o)if(e.responseFields[o]&&(n[e.responseFields[o]]=t),!u&&r&&e.dataFilter&&(t=e.dataFilter(t,e.dataType)),u=o,o=c.shift())if("*"===o)o=u;else if("*"!==u&&u!==o){if(!(a=l[u+" "+o]||l["* "+o]))for(i in l)if((s=i.split(" "))[1]===o&&(a=l[u+" "+s[0]]||l["* "+s[0]])){!0===a?a=l[i]:!0!==l[i]&&(o=s[0],c.unshift(s[1]));break}if(!0!==a)if(a&&e["throws"])t=a(t);else try{t=a(t)}catch(e){return{state:"parsererror",error:a?e:"No conversion from "+u+" to "+o}}}return{state:"success",data:t}}(v,s,T,i),i?(v.ifModified&&((u=T.getResponseHeader("Last-Modified"))&&(k.lastModified[f]=u),(u=T.getResponseHeader("etag"))&&(k.etag[f]=u)),204===e||"HEAD"===v.type?l="nocontent":304===e?l="notmodified":(l=s.state,o=s.data,i=!(a=s.error))):(a=l,!e&&l||(l="error",e<0&&(e=0))),T.status=e,T.statusText=(t||l)+"",i?x.resolveWith(y,[o,l,T]):x.rejectWith(y,[T,l,a]),T.statusCode(w),w=void 0,g&&m.trigger(i?"ajaxSuccess":"ajaxError",[T,v,i?o:a]),b.fireWith(y,[T,l]),g&&(m.trigger("ajaxComplete",[T,v]),--k.active||k.event.trigger("ajaxStop")))}return T},getJSON:function(e,t,n){return k.get(e,t,n,"json")},getScript:function(e,t){return k.get(e,void 0,t,"script")}}),k.each(["get","post"],function(e,i){k[i]=function(e,t,n,r){return m(t)&&(r=r||n,n=t,t=void 0),k.ajax(k.extend({url:e,type:i,dataType:r,data:t,success:n},k.isPlainObject(e)&&e))}}),k._evalUrl=function(e,t){return k.ajax({url:e,type:"GET",dataType:"script",cache:!0,async:!1,global:!1,converters:{"text script":function(){}},dataFilter:function(e){k.globalEval(e,t)}})},k.fn.extend({wrapAll:function(e){var t;return this[0]&&(m(e)&&(e=e.call(this[0])),t=k(e,this[0].ownerDocument).eq(0).clone(!0),this[0].parentNode&&t.insertBefore(this[0]),t.map(function(){var e=this;while(e.firstElementChild)e=e.firstElementChild;return e}).append(this)),this},wrapInner:function(n){return m(n)?this.each(function(e){k(this).wrapInner(n.call(this,e))}):this.each(function(){var e=k(this),t=e.contents();t.length?t.wrapAll(n):e.append(n)})},wrap:function(t){var n=m(t);return this.each(function(e){k(this).wrapAll(n?t.call(this,e):t)})},unwrap:function(e){return this.parent(e).not("body").each(function(){k(this).replaceWith(this.childNodes)}),this}}),k.expr.pseudos.hidden=function(e){return!k.expr.pseudos.visible(e)},k.expr.pseudos.visible=function(e){return!!(e.offsetWidth||e.offsetHeight||e.getClientRects().length)},k.ajaxSettings.xhr=function(){try{return new C.XMLHttpRequest}catch(e){}};var Ut={0:200,1223:204},Xt=k.ajaxSettings.xhr();y.cors=!!Xt&&"withCredentials"in Xt,y.ajax=Xt=!!Xt,k.ajaxTransport(function(i){var o,a;if(y.cors||Xt&&!i.crossDomain)return{send:function(e,t){var n,r=i.xhr();if(r.open(i.type,i.url,i.async,i.username,i.password),i.xhrFields)for(n in i.xhrFields)r[n]=i.xhrFields[n];for(n in i.mimeType&&r.overrideMimeType&&r.overrideMimeType(i.mimeType),i.crossDomain||e["X-Requested-With"]||(e["X-Requested-With"]="XMLHttpRequest"),e)r.setRequestHeader(n,e[n]);o=function(e){return function(){o&&(o=a=r.onload=r.onerror=r.onabort=r.ontimeout=r.onreadystatechange=null,"abort"===e?r.abort():"error"===e?"number"!=typeof r.status?t(0,"error"):t(r.status,r.statusText):t(Ut[r.status]||r.status,r.statusText,"text"!==(r.responseType||"text")||"string"!=typeof r.responseText?{binary:r.response}:{text:r.responseText},r.getAllResponseHeaders()))}},r.onload=o(),a=r.onerror=r.ontimeout=o("error"),void 0!==r.onabort?r.onabort=a:r.onreadystatechange=function(){4===r.readyState&&C.setTimeout(function(){o&&a()})},o=o("abort");try{r.send(i.hasContent&&i.data||null)}catch(e){if(o)throw e}},abort:function(){o&&o()}}}),k.ajaxPrefilter(function(e){e.crossDomain&&(e.contents.script=!1)}),k.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/\b(?:java|ecma)script\b/},converters:{"text script":function(e){return k.globalEval(e),e}}}),k.ajaxPrefilter("script",function(e){void 0===e.cache&&(e.cache=!1),e.crossDomain&&(e.type="GET")}),k.ajaxTransport("script",function(n){var r,i;if(n.crossDomain||n.scriptAttrs)return{send:function(e,t){r=k("<script>").attr(n.scriptAttrs||{}).prop({charset:n.scriptCharset,src:n.url}).on("load error",i=function(e){r.remove(),i=null,e&&t("error"===e.type?404:200,e.type)}),E.head.appendChild(r[0])},abort:function(){i&&i()}}});var Vt,Gt=[],Yt=/(=)\?(?=&|$)|\?\?/;k.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var e=Gt.pop()||k.expando+"_"+kt++;return this[e]=!0,e}}),k.ajaxPrefilter("json jsonp",function(e,t,n){var r,i,o,a=!1!==e.jsonp&&(Yt.test(e.url)?"url":"string"==typeof e.data&&0===(e.contentType||"").indexOf("application/x-www-form-urlencoded")&&Yt.test(e.data)&&"data");if(a||"jsonp"===e.dataTypes[0])return r=e.jsonpCallback=m(e.jsonpCallback)?e.jsonpCallback():e.jsonpCallback,a?e[a]=e[a].replace(Yt,"$1"+r):!1!==e.jsonp&&(e.url+=(St.test(e.url)?"&":"?")+e.jsonp+"="+r),e.converters["script json"]=function(){return o||k.error(r+" was not called"),o[0]},e.dataTypes[0]="json",i=C[r],C[r]=function(){o=arguments},n.always(function(){void 0===i?k(C).removeProp(r):C[r]=i,e[r]&&(e.jsonpCallback=t.jsonpCallback,Gt.push(r)),o&&m(i)&&i(o[0]),o=i=void 0}),"script"}),y.createHTMLDocument=((Vt=E.implementation.createHTMLDocument("").body).innerHTML="<form></form><form></form>",2===Vt.childNodes.length),k.parseHTML=function(e,t,n){return"string"!=typeof e?[]:("boolean"==typeof t&&(n=t,t=!1),t||(y.createHTMLDocument?((r=(t=E.implementation.createHTMLDocument("")).createElement("base")).href=E.location.href,t.head.appendChild(r)):t=E),o=!n&&[],(i=D.exec(e))?[t.createElement(i[1])]:(i=we([e],t,o),o&&o.length&&k(o).remove(),k.merge([],i.childNodes)));var r,i,o},k.fn.load=function(e,t,n){var r,i,o,a=this,s=e.indexOf(" ");return-1<s&&(r=mt(e.slice(s)),e=e.slice(0,s)),m(t)?(n=t,t=void 0):t&&"object"==typeof t&&(i="POST"),0<a.length&&k.ajax({url:e,type:i||"GET",dataType:"html",data:t}).done(function(e){o=arguments,a.html(r?k("<div>").append(k.parseHTML(e)).find(r):e)}).always(n&&function(e,t){a.each(function(){n.apply(this,o||[e.responseText,t,e])})}),this},k.each(["ajaxStart","ajaxStop","ajaxComplete","ajaxError","ajaxSuccess","ajaxSend"],function(e,t){k.fn[t]=function(e){return this.on(t,e)}}),k.expr.pseudos.animated=function(t){return k.grep(k.timers,function(e){return t===e.elem}).length},k.offset={setOffset:function(e,t,n){var r,i,o,a,s,u,l=k.css(e,"position"),c=k(e),f={};"static"===l&&(e.style.position="relative"),s=c.offset(),o=k.css(e,"top"),u=k.css(e,"left"),("absolute"===l||"fixed"===l)&&-1<(o+u).indexOf("auto")?(a=(r=c.position()).top,i=r.left):(a=parseFloat(o)||0,i=parseFloat(u)||0),m(t)&&(t=t.call(e,n,k.extend({},s))),null!=t.top&&(f.top=t.top-s.top+a),null!=t.left&&(f.left=t.left-s.left+i),"using"in t?t.using.call(e,f):c.css(f)}},k.fn.extend({offset:function(t){if(arguments.length)return void 0===t?this:this.each(function(e){k.offset.setOffset(this,t,e)});var e,n,r=this[0];return r?r.getClientRects().length?(e=r.getBoundingClientRect(),n=r.ownerDocument.defaultView,{top:e.top+n.pageYOffset,left:e.left+n.pageXOffset}):{top:0,left:0}:void 0},position:function(){if(this[0]){var e,t,n,r=this[0],i={top:0,left:0};if("fixed"===k.css(r,"position"))t=r.getBoundingClientRect();else{t=this.offset(),n=r.ownerDocument,e=r.offsetParent||n.documentElement;while(e&&(e===n.body||e===n.documentElement)&&"static"===k.css(e,"position"))e=e.parentNode;e&&e!==r&&1===e.nodeType&&((i=k(e).offset()).top+=k.css(e,"borderTopWidth",!0),i.left+=k.css(e,"borderLeftWidth",!0))}return{top:t.top-i.top-k.css(r,"marginTop",!0),left:t.left-i.left-k.css(r,"marginLeft",!0)}}},offsetParent:function(){return this.map(function(){var e=this.offsetParent;while(e&&"static"===k.css(e,"position"))e=e.offsetParent;return e||ie})}}),k.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(t,i){var o="pageYOffset"===i;k.fn[t]=function(e){return _(this,function(e,t,n){var r;if(x(e)?r=e:9===e.nodeType&&(r=e.defaultView),void 0===n)return r?r[i]:e[t];r?r.scrollTo(o?r.pageXOffset:n,o?n:r.pageYOffset):e[t]=n},t,e,arguments.length)}}),k.each(["top","left"],function(e,n){k.cssHooks[n]=ze(y.pixelPosition,function(e,t){if(t)return t=_e(e,n),$e.test(t)?k(e).position()[n]+"px":t})}),k.each({Height:"height",Width:"width"},function(a,s){k.each({padding:"inner"+a,content:s,"":"outer"+a},function(r,o){k.fn[o]=function(e,t){var n=arguments.length&&(r||"boolean"!=typeof e),i=r||(!0===e||!0===t?"margin":"border");return _(this,function(e,t,n){var r;return x(e)?0===o.indexOf("outer")?e["inner"+a]:e.document.documentElement["client"+a]:9===e.nodeType?(r=e.documentElement,Math.max(e.body["scroll"+a],r["scroll"+a],e.body["offset"+a],r["offset"+a],r["client"+a])):void 0===n?k.css(e,t,i):k.style(e,t,n,i)},s,n?e:void 0,n)}})}),k.each("blur focus focusin focusout resize scroll click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup contextmenu".split(" "),function(e,n){k.fn[n]=function(e,t){return 0<arguments.length?this.on(n,null,e,t):this.trigger(n)}}),k.fn.extend({hover:function(e,t){return this.mouseenter(e).mouseleave(t||e)}}),k.fn.extend({bind:function(e,t,n){return this.on(e,null,t,n)},unbind:function(e,t){return this.off(e,null,t)},delegate:function(e,t,n,r){return this.on(t,e,n,r)},undelegate:function(e,t,n){return 1===arguments.length?this.off(e,"**"):this.off(t,e||"**",n)}}),k.proxy=function(e,t){var n,r,i;if("string"==typeof t&&(n=e[t],t=e,e=n),m(e))return r=s.call(arguments,2),(i=function(){return e.apply(t||this,r.concat(s.call(arguments)))}).guid=e.guid=e.guid||k.guid++,i},k.holdReady=function(e){e?k.readyWait++:k.ready(!0)},k.isArray=Array.isArray,k.parseJSON=JSON.parse,k.nodeName=A,k.isFunction=m,k.isWindow=x,k.camelCase=V,k.type=w,k.now=Date.now,k.isNumeric=function(e){var t=k.type(e);return("number"===t||"string"===t)&&!isNaN(e-parseFloat(e))},"function"==typeof define&&define.amd&&define("jquery",[],function(){return k});var Qt=C.jQuery,Jt=C.$;return k.noConflict=function(e){return C.$===k&&(C.$=Jt),e&&C.jQuery===k&&(C.jQuery=Qt),k},e||(C.jQuery=C.$=k),k});


(function($){
	$.fn.live=function(event, callback){
		if (!callback){
			return;
		}

		$(document.body).on(event, this, callback);
	};
})(jQuery);

(function($){var a=$.fn.jquery.split("."),b;for(b in a)a[b]=parseInt(a[b]);if(!$.browser&&(1<a[0]||9<=a[1])){a={browser:void 0,version:void 0,mobile:!1};navigator&&navigator.userAgent&&(a.ua=navigator.userAgent,a.webkit=/WebKit/i.test(a.ua),a.browserArray="MSIE Chrome Opera Kindle Silk BlackBerry PlayBook Android Safari Mozilla Nokia".split(" "),/Sony[^ ]*/i.test(a.ua)?a.mobile="Sony":/RIM Tablet/i.test(a.ua)?a.mobile="RIM Tablet":/BlackBerry/i.test(a.ua)?a.mobile="BlackBerry":/iPhone/i.test(a.ua)?
		a.mobile="iPhone":/iPad/i.test(a.ua)?a.mobile="iPad":/iPod/i.test(a.ua)?a.mobile="iPod":/Opera Mini/i.test(a.ua)?a.mobile="Opera Mini":/IEMobile/i.test(a.ua)?a.mobile="IEMobile":/BB[0-9]{1,}; Touch/i.test(a.ua)?a.mobile="BlackBerry":/Nokia/i.test(a.ua)?a.mobile="Nokia":/Android/i.test(a.ua)&&(a.mobile="Android"),/MSIE|Trident/i.test(a.ua)?(a.browser="MSIE",a.version=/MSIE/i.test(navigator.userAgent)&&0<parseFloat(a.ua.split("MSIE")[1].match(/[0-9\.]{1,}/)[0])?parseFloat(a.ua.split("MSIE")[1].match(/[0-9\.]{1,}/)[0]):
		"Edge",/Trident/i.test(a.ua)&&/rv:([0-9]{1,}[\.0-9]{0,})/.test(a.ua)&&(a.version=parseFloat(a.ua.match(/rv:([0-9]{1,}[\.0-9]{0,})/)[1].match(/[0-9\.]{1,}/)[0]))):/Chrome/.test(a.ua)?(a.browser="Chrome",a.version=parseFloat(a.ua.split("Chrome/")[1].split("Safari")[0].match(/[0-9\.]{1,}/)[0])):/Opera/.test(a.ua)?(a.browser="Opera",a.version=parseFloat(a.ua.split("Version/")[1].match(/[0-9\.]{1,}/)[0])):/Kindle|Silk|KFTT|KFOT|KFJWA|KFJWI|KFSOWI|KFTHWA|KFTHWI|KFAPWA|KFAPWI/i.test(a.ua)?(a.mobile="Kindle",
		/Silk/i.test(a.ua)?(a.browser="Silk",a.version=parseFloat(a.ua.split("Silk/")[1].split("Safari")[0].match(/[0-9\.]{1,}/)[0])):/Kindle/i.test(a.ua)&&/Version/i.test(a.ua)&&(a.browser="Kindle",a.version=parseFloat(a.ua.split("Version/")[1].split("Safari")[0].match(/[0-9\.]{1,}/)[0]))):/BlackBerry/.test(a.ua)?(a.browser="BlackBerry",a.version=parseFloat(a.ua.split("/")[1].match(/[0-9\.]{1,}/)[0])):/PlayBook/.test(a.ua)?(a.browser="PlayBook",a.version=parseFloat(a.ua.split("Version/")[1].split("Safari")[0].match(/[0-9\.]{1,}/)[0])):
		/BB[0-9]{1,}; Touch/.test(a.ua)?(a.browser="Blackberry",a.version=parseFloat(a.ua.split("Version/")[1].split("Safari")[0].match(/[0-9\.]{1,}/)[0])):/Android/.test(a.ua)?(a.browser="Android",a.version=parseFloat(a.ua.split("Version/")[1].split("Safari")[0].match(/[0-9\.]{1,}/)[0])):/Safari/.test(a.ua)?(a.browser="Safari",a.version=parseFloat(a.ua.split("Version/")[1].split("Safari")[0].match(/[0-9\.]{1,}/)[0])):/Firefox/.test(a.ua)?(a.browser="Mozilla",a.version=parseFloat(a.ua.split("Firefox/")[1].match(/[0-9\.]{1,}/)[0])):
		/Nokia/.test(a.ua)&&(a.browser="Nokia",a.version=parseFloat(a.ua.split("Browser")[1].match(/[0-9\.]{1,}/)[0])));if(a.browser)for(var c in a.browserArray)a[a.browserArray[c].toLowerCase()]=a.browser==a.browserArray[c];$.extend(!0,$.browser={},a)}})(jQuery);
		/* - - - - - - - - - - - - - - - - - - - */




/*! jQuery UI - v1.12.1 - 2017-03-10
* http://jqueryui.com
* Includes: widget.js, position.js, data.js, disable-selection.js, focusable.js, form-reset-mixin.js, jquery-1-7.js, keycode.js, labels.js, scroll-parent.js, tabbable.js, unique-id.js, widgets/draggable.js, widgets/droppable.js, widgets/resizable.js, widgets/selectable.js, widgets/sortable.js, widgets/autocomplete.js, widgets/datepicker.js, widgets/menu.js, widgets/mouse.js, widgets/progressbar.js, widgets/slider.js, effect.js, effects/effect-blind.js, effects/effect-bounce.js, effects/effect-clip.js, effects/effect-drop.js, effects/effect-explode.js, effects/effect-fade.js, effects/effect-fold.js, effects/effect-highlight.js, effects/effect-puff.js, effects/effect-pulsate.js, effects/effect-scale.js, effects/effect-shake.js, effects/effect-size.js, effects/effect-slide.js, effects/effect-transfer.js
* Copyright jQuery Foundation and other contributors; Licensed MIT */

(function(t){"function"==typeof define&&define.amd?define(["jquery"],t):t(jQuery)})(function(t){function e(t){for(var e=t.css("visibility");"inherit"===e;)t=t.parent(),e=t.css("visibility");return"hidden"!==e}function i(t){for(var e,i;t.length&&t[0]!==document;){if (e=t.css("position"),("absolute"===e||"relative"===e||"fixed"===e)&&(i=parseInt(t.css("zIndex"),10),!isNaN(i)&&0!==i))return i;t=t.parent()}return 0}function s(){this._curInst=null,this._keyEvent=!1,this._disabledInputs=[],this._datepickerShowing=!1,this._inDialog=!1,this._mainDivId="ui-datepicker-div",this._inlineClass="ui-datepicker-inline",this._appendClass="ui-datepicker-append",this._triggerClass="ui-datepicker-trigger",this._dialogClass="ui-datepicker-dialog",this._disableClass="ui-datepicker-disabled",this._unselectableClass="ui-datepicker-unselectable",this._currentClass="ui-datepicker-current-day",this._dayOverClass="ui-datepicker-days-cell-over",this.regional=[],this.regional[""]={closeText:"Done",prevText:"Prev",nextText:"Next",currentText:"Today",monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"],monthNamesShort:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],dayNames:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],dayNamesShort:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],dayNamesMin:["Su","Mo","Tu","We","Th","Fr","Sa"],weekHeader:"Wk",dateFormat:"mm/dd/yy",firstDay:0,isRTL:!1,showMonthAfterYear:!1,yearSuffix:""},this._defaults={showOn:"focus",showAnim:"fadeIn",showOptions:{},defaultDate:null,appendText:"",buttonText:"...",buttonImage:"",buttonImageOnly:!1,hideIfNoPrevNext:!1,navigationAsDateFormat:!1,gotoCurrent:!1,changeMonth:!1,changeYear:!1,yearRange:"c-10:c+10",showOtherMonths:!1,selectOtherMonths:!1,showWeek:!1,calculateWeek:this.iso8601Week,shortYearCutoff:"+10",minDate:null,maxDate:null,duration:"fast",beforeShowDay:null,beforeShow:null,onSelect:null,onChangeMonthYear:null,onClose:null,numberOfMonths:1,showCurrentAtPos:0,stepMonths:1,stepBigMonths:12,altField:"",altFormat:"",constrainInput:!0,showButtonPanel:!1,autoSize:!1,disabled:!1},t.extend(this._defaults,this.regional[""]),this.regional.en=t.extend(!0,{},this.regional[""]),this.regional["en-US"]=t.extend(!0,{},this.regional.en),this.dpDiv=n(t("<div id='"+this._mainDivId+"' class='ui-datepicker ui-widget ui-widget-content ui-helper-clearfix ui-corner-all'></div>"))}function n(e){var i="button, .ui-datepicker-prev, .ui-datepicker-next, .ui-datepicker-calendar td a";return e.on("mouseout",i,function(){t(this).removeClass("ui-state-hover"),-1!==this.className.indexOf("ui-datepicker-prev")&&t(this).removeClass("ui-datepicker-prev-hover"),-1!==this.className.indexOf("ui-datepicker-next")&&t(this).removeClass("ui-datepicker-next-hover")}).on("mouseover",i,o)}function o(){t.datepicker._isDisabledDatepicker(u.inline?u.dpDiv.parent()[0]:u.input[0])||(t(this).parents(".ui-datepicker-calendar").find("a").removeClass("ui-state-hover"),t(this).addClass("ui-state-hover"),-1!==this.className.indexOf("ui-datepicker-prev")&&t(this).addClass("ui-datepicker-prev-hover"),-1!==this.className.indexOf("ui-datepicker-next")&&t(this).addClass("ui-datepicker-next-hover"))}function a(e,i){t.extend(e,i);for(var s in i)null==i[s]&&(e[s]=i[s]);return e}t.ui=t.ui||{},t.ui.version="1.12.1";var r=0,l=Array.prototype.slice;t.cleanData=function(e){return function(i){var s,n,o;for(o=0;null!=(n=i[o]);o++)try{s=t._data(n,"events"),s&&s.remove&&t(n).triggerHandler("remove")}catch(a){}e(i)}}(t.cleanData),t.widget=function(e,i,s){var n,o,a,r={},l=e.split(".")[0];e=e.split(".")[1];var h=l+"-"+e;return s||(s=i,i=t.Widget),t.isArray(s)&&(s=t.extend.apply(null,[{}].concat(s))),t.expr[":"][h.toLowerCase()]=function(e){return!!t.data(e,h)},t[l]=t[l]||{},n=t[l][e],o=t[l][e]=function(t,e){return this._createWidget?(arguments.length&&this._createWidget(t,e),void 0):new o(t,e)},t.extend(o,n,{version:s.version,_proto:t.extend({},s),_childConstructors:[]}),a=new i,a.options=t.widget.extend({},a.options),t.each(s,function(e,s){return t.isFunction(s)?(r[e]=function(){function t(){return i.prototype[e].apply(this,arguments)}function n(t){return i.prototype[e].apply(this,t)}return function(){var e,i=this._super,o=this._superApply;return this._super=t,this._superApply=n,e=s.apply(this,arguments),this._super=i,this._superApply=o,e}}(),void 0):(r[e]=s,void 0)}),o.prototype=t.widget.extend(a,{widgetEventPrefix:n?a.widgetEventPrefix||e:e},r,{constructor:o,namespace:l,widgetName:e,widgetFullName:h}),n?(t.each(n._childConstructors,function(e,i){var s=i.prototype;t.widget(s.namespace+"."+s.widgetName,o,i._proto)}),delete n._childConstructors):i._childConstructors.push(o),t.widget.bridge(e,o),o},t.widget.extend=function(e){for(var i,s,n=l.call(arguments,1),o=0,a=n.length;a>o;o++)for(i in n[o])s=n[o][i],n[o].hasOwnProperty(i)&&void 0!==s&&(e[i]=t.isPlainObject(s)?t.isPlainObject(e[i])?t.widget.extend({},e[i],s):t.widget.extend({},s):s);return e},t.widget.bridge=function(e,i){var s=i.prototype.widgetFullName||e;t.fn[e]=function(n){var o="string"==typeof n,a=l.call(arguments,1),r=this;return o?this.length||"instance"!==n?this.each(function(){var i,o=t.data(this,s);return"instance"===n?(r=o,!1):o?t.isFunction(o[n])&&"_"!==n.charAt(0)?(i=o[n].apply(o,a),i!==o&&void 0!==i?(r=i&&i.jquery?r.pushStack(i.get()):i,!1):void 0):t.error("no such method '"+n+"' for "+e+" widget instance"):t.error("cannot call methods on "+e+" prior to initialization; "+"attempted to call method '"+n+"'")}):r=void 0:(a.length&&(n=t.widget.extend.apply(null,[n].concat(a))),this.each(function(){var e=t.data(this,s);e?(e.option(n||{}),e._init&&e._init()):t.data(this,s,new i(n,this))})),r}},t.Widget=function(){},t.Widget._childConstructors=[],t.Widget.prototype={widgetName:"widget",widgetEventPrefix:"",defaultElement:"<div>",options:{classes:{},disabled:!1,create:null},_createWidget:function(e,i){i=t(i||this.defaultElement||this)[0],this.element=t(i),this.uuid=r++,this.eventNamespace="."+this.widgetName+this.uuid,this.bindings=t(),this.hoverable=t(),this.focusable=t(),this.classesElementLookup={},i!==this&&(t.data(i,this.widgetFullName,this),this._on(!0,this.element,{remove:function(t){t.target===i&&this.destroy()}}),this.document=t(i.style?i.ownerDocument:i.document||i),this.window=t(this.document[0].defaultView||this.document[0].parentWindow)),this.options=t.widget.extend({},this.options,this._getCreateOptions(),e),this._create(),this.options.disabled&&this._setOptionDisabled(this.options.disabled),this._trigger("create",null,this._getCreateEventData()),this._init()},_getCreateOptions:function(){return{}},_getCreateEventData:t.noop,_create:t.noop,_init:t.noop,destroy:function(){var e=this;this._destroy(),t.each(this.classesElementLookup,function(t,i){e._removeClass(i,t)}),this.element.off(this.eventNamespace).removeData(this.widgetFullName),this.widget().off(this.eventNamespace).removeAttr("aria-disabled"),this.bindings.off(this.eventNamespace)},_destroy:t.noop,widget:function(){return this.element},option:function(e,i){var s,n,o,a=e;if (0===arguments.length)return t.widget.extend({},this.options);if ("string"==typeof e)if (a={},s=e.split("."),e=s.shift(),s.length){for(n=a[e]=t.widget.extend({},this.options[e]),o=0;s.length-1>o;o++)n[s[o]]=n[s[o]]||{},n=n[s[o]];if (e=s.pop(),1===arguments.length)return void 0===n[e]?null:n[e];n[e]=i}else{if (1===arguments.length)return void 0===this.options[e]?null:this.options[e];a[e]=i}return this._setOptions(a),this},_setOptions:function(t){var e;for(e in t)this._setOption(e,t[e]);return this},_setOption:function(t,e){return"classes"===t&&this._setOptionClasses(e),this.options[t]=e,"disabled"===t&&this._setOptionDisabled(e),this},_setOptionClasses:function(e){var i,s,n;for(i in e)n=this.classesElementLookup[i],e[i]!==this.options.classes[i]&&n&&n.length&&(s=t(n.get()),this._removeClass(n,i),s.addClass(this._classes({element:s,keys:i,classes:e,add:!0})))},_setOptionDisabled:function(t){this._toggleClass(this.widget(),this.widgetFullName+"-disabled",null,!!t),t&&(this._removeClass(this.hoverable,null,"ui-state-hover"),this._removeClass(this.focusable,null,"ui-state-focus"))},enable:function(){return this._setOptions({disabled:!1})},disable:function(){return this._setOptions({disabled:!0})},_classes:function(e){function i(i,o){var a,r;for(r=0;i.length>r;r++)a=n.classesElementLookup[i[r]]||t(),a=e.add?t(t.unique(a.get().concat(e.element.get()))):t(a.not(e.element).get()),n.classesElementLookup[i[r]]=a,s.push(i[r]),o&&e.classes[i[r]]&&s.push(e.classes[i[r]])}var s=[],n=this;return e=t.extend({element:this.element,classes:this.options.classes||{}},e),this._on(e.element,{remove:"_untrackClassesElement"}),e.keys&&i(e.keys.match(/\S+/g)||[],!0),e.extra&&i(e.extra.match(/\S+/g)||[]),s.join(" ")},_untrackClassesElement:function(e){var i=this;t.each(i.classesElementLookup,function(s,n){-1!==t.inArray(e.target,n)&&(i.classesElementLookup[s]=t(n.not(e.target).get()))})},_removeClass:function(t,e,i){return this._toggleClass(t,e,i,!1)},_addClass:function(t,e,i){return this._toggleClass(t,e,i,!0)},_toggleClass:function(t,e,i,s){s="boolean"==typeof s?s:i;var n="string"==typeof t||null===t,o={extra:n?e:i,keys:n?t:e,element:n?this.element:t,add:s};return o.element.toggleClass(this._classes(o),s),this},_on:function(e,i,s){var n,o=this;"boolean"!=typeof e&&(s=i,i=e,e=!1),s?(i=n=t(i),this.bindings=this.bindings.add(i)):(s=i,i=this.element,n=this.widget()),t.each(s,function(s,a){function r(){return e||o.options.disabled!==!0&&!t(this).hasClass("ui-state-disabled")?("string"==typeof a?o[a]:a).apply(o,arguments):void 0}"string"!=typeof a&&(r.guid=a.guid=a.guid||r.guid||t.guid++);var l=s.match(/^([\w:-]*)\s*(.*)$/),h=l[1]+o.eventNamespace,c=l[2];c?n.on(h,c,r):i.on(h,r)})},_off:function(e,i){i=(i||"").split(" ").join(this.eventNamespace+" ")+this.eventNamespace,e.off(i).off(i),this.bindings=t(this.bindings.not(e).get()),this.focusable=t(this.focusable.not(e).get()),this.hoverable=t(this.hoverable.not(e).get())},_delay:function(t,e){function i(){return("string"==typeof t?s[t]:t).apply(s,arguments)}var s=this;return setTimeout(i,e||0)},_hoverable:function(e){this.hoverable=this.hoverable.add(e),this._on(e,{mouseenter:function(e){this._addClass(t(e.currentTarget),null,"ui-state-hover")},mouseleave:function(e){this._removeClass(t(e.currentTarget),null,"ui-state-hover")}})},_focusable:function(e){this.focusable=this.focusable.add(e),this._on(e,{focusin:function(e){this._addClass(t(e.currentTarget),null,"ui-state-focus")},focusout:function(e){this._removeClass(t(e.currentTarget),null,"ui-state-focus")}})},_trigger:function(e,i,s){var n,o,a=this.options[e];if (s=s||{},i=t.Event(i),i.type=(e===this.widgetEventPrefix?e:this.widgetEventPrefix+e).toLowerCase(),i.target=this.element[0],o=i.originalEvent)for(n in o)n in i||(i[n]=o[n]);return this.element.trigger(i,s),!(t.isFunction(a)&&a.apply(this.element[0],[i].concat(s))===!1||i.isDefaultPrevented())}},t.each({show:"fadeIn",hide:"fadeOut"},function(e,i){t.Widget.prototype["_"+e]=function(s,n,o){"string"==typeof n&&(n={effect:n});var a,r=n?n===!0||"number"==typeof n?i:n.effect||i:e;n=n||{},"number"==typeof n&&(n={duration:n}),a=!t.isEmptyObject(n),n.complete=o,n.delay&&s.delay(n.delay),a&&t.effects&&t.effects.effect[r]?s[e](n):r!==e&&s[r]?s[r](n.duration,n.easing,o):s.queue(function(i){t(this)[e](),o&&o.call(s[0]),i()})}}),t.widget,function(){function e(t,e,i){return[parseFloat(t[0])*(u.test(t[0])?e/100:1),parseFloat(t[1])*(u.test(t[1])?i/100:1)]}function i(e,i){return parseInt(t.css(e,i),10)||0}function s(e){var i=e[0];return 9===i.nodeType?{width:e.width(),height:e.height(),offset:{top:0,left:0}}:t.isWindow(i)?{width:e.width(),height:e.height(),offset:{top:e.scrollTop(),left:e.scrollLeft()}}:i.preventDefault?{width:0,height:0,offset:{top:i.pageY,left:i.pageX}}:{width:e.outerWidth(),height:e.outerHeight(),offset:e.offset()}}var n,o=Math.max,a=Math.abs,r=/left|center|right/,l=/top|center|bottom/,h=/[\+\-]\d+(\.[\d]+)?%?/,c=/^\w+/,u=/%$/,d=t.fn.position;t.position={scrollbarWidth:function(){if (void 0!==n)return n;var e,i,s=t("<div style='display:block;position:absolute;width:50px;height:50px;overflow:hidden;'><div style='height:100px;width:auto;'></div></div>"),o=s.children()[0];return t("body").append(s),e=o.offsetWidth,s.css("overflow","scroll"),i=o.offsetWidth,e===i&&(i=s[0].clientWidth),s.remove(),n=e-i},getScrollInfo:function(e){var i=e.isWindow||e.isDocument?"":e.element.css("overflow-x"),s=e.isWindow||e.isDocument?"":e.element.css("overflow-y"),n="scroll"===i||"auto"===i&&e.width<e.element[0].scrollWidth,o="scroll"===s||"auto"===s&&e.height<e.element[0].scrollHeight;return{width:o?t.position.scrollbarWidth():0,height:n?t.position.scrollbarWidth():0}},getWithinInfo:function(e){var i=t(e||window),s=t.isWindow(i[0]),n=!!i[0]&&9===i[0].nodeType,o=!s&&!n;return{element:i,isWindow:s,isDocument:n,offset:o?t(e).offset():{left:0,top:0},scrollLeft:i.scrollLeft(),scrollTop:i.scrollTop(),width:i.outerWidth(),height:i.outerHeight()}}},t.fn.position=function(n){if (!n||!n.of)return d.apply(this,arguments);n=t.extend({},n);var u,p,f,g,m,_,v=t(n.of),b=t.position.getWithinInfo(n.within),y=t.position.getScrollInfo(b),w=(n.collision||"flip").split(" "),k={};return _=s(v),v[0].preventDefault&&(n.at="left top"),p=_.width,f=_.height,g=_.offset,m=t.extend({},g),t.each(["my","at"],function(){var t,e,i=(n[this]||"").split(" ");1===i.length&&(i=r.test(i[0])?i.concat(["center"]):l.test(i[0])?["center"].concat(i):["center","center"]),i[0]=r.test(i[0])?i[0]:"center",i[1]=l.test(i[1])?i[1]:"center",t=h.exec(i[0]),e=h.exec(i[1]),k[this]=[t?t[0]:0,e?e[0]:0],n[this]=[c.exec(i[0])[0],c.exec(i[1])[0]]}),1===w.length&&(w[1]=w[0]),"right"===n.at[0]?m.left+=p:"center"===n.at[0]&&(m.left+=p/2),"bottom"===n.at[1]?m.top+=f:"center"===n.at[1]&&(m.top+=f/2),u=e(k.at,p,f),m.left+=u[0],m.top+=u[1],this.each(function(){var s,r,l=t(this),h=l.outerWidth(),c=l.outerHeight(),d=i(this,"marginLeft"),_=i(this,"marginTop"),x=h+d+i(this,"marginRight")+y.width,C=c+_+i(this,"marginBottom")+y.height,D=t.extend({},m),T=e(k.my,l.outerWidth(),l.outerHeight());"right"===n.my[0]?D.left-=h:"center"===n.my[0]&&(D.left-=h/2),"bottom"===n.my[1]?D.top-=c:"center"===n.my[1]&&(D.top-=c/2),D.left+=T[0],D.top+=T[1],s={marginLeft:d,marginTop:_},t.each(["left","top"],function(e,i){t.ui.position[w[e]]&&t.ui.position[w[e]][i](D,{targetWidth:p,targetHeight:f,elemWidth:h,elemHeight:c,collisionPosition:s,collisionWidth:x,collisionHeight:C,offset:[u[0]+T[0],u[1]+T[1]],my:n.my,at:n.at,within:b,elem:l})}),n.using&&(r=function(t){var e=g.left-D.left,i=e+p-h,s=g.top-D.top,r=s+f-c,u={target:{element:v,left:g.left,top:g.top,width:p,height:f},element:{element:l,left:D.left,top:D.top,width:h,height:c},horizontal:0>i?"left":e>0?"right":"center",vertical:0>r?"top":s>0?"bottom":"middle"};h>p&&p>a(e+i)&&(u.horizontal="center"),c>f&&f>a(s+r)&&(u.vertical="middle"),u.important=o(a(e),a(i))>o(a(s),a(r))?"horizontal":"vertical",n.using.call(this,t,u)}),l.offset(t.extend(D,{using:r}))})},t.ui.position={fit:{left:function(t,e){var i,s=e.within,n=s.isWindow?s.scrollLeft:s.offset.left,a=s.width,r=t.left-e.collisionPosition.marginLeft,l=n-r,h=r+e.collisionWidth-a-n;e.collisionWidth>a?l>0&&0>=h?(i=t.left+l+e.collisionWidth-a-n,t.left+=l-i):t.left=h>0&&0>=l?n:l>h?n+a-e.collisionWidth:n:l>0?t.left+=l:h>0?t.left-=h:t.left=o(t.left-r,t.left)},top:function(t,e){var i,s=e.within,n=s.isWindow?s.scrollTop:s.offset.top,a=e.within.height,r=t.top-e.collisionPosition.marginTop,l=n-r,h=r+e.collisionHeight-a-n;e.collisionHeight>a?l>0&&0>=h?(i=t.top+l+e.collisionHeight-a-n,t.top+=l-i):t.top=h>0&&0>=l?n:l>h?n+a-e.collisionHeight:n:l>0?t.top+=l:h>0?t.top-=h:t.top=o(t.top-r,t.top)}},flip:{left:function(t,e){var i,s,n=e.within,o=n.offset.left+n.scrollLeft,r=n.width,l=n.isWindow?n.scrollLeft:n.offset.left,h=t.left-e.collisionPosition.marginLeft,c=h-l,u=h+e.collisionWidth-r-l,d="left"===e.my[0]?-e.elemWidth:"right"===e.my[0]?e.elemWidth:0,p="left"===e.at[0]?e.targetWidth:"right"===e.at[0]?-e.targetWidth:0,f=-2*e.offset[0];0>c?(i=t.left+d+p+f+e.collisionWidth-r-o,(0>i||a(c)>i)&&(t.left+=d+p+f)):u>0&&(s=t.left-e.collisionPosition.marginLeft+d+p+f-l,(s>0||u>a(s))&&(t.left+=d+p+f))},top:function(t,e){var i,s,n=e.within,o=n.offset.top+n.scrollTop,r=n.height,l=n.isWindow?n.scrollTop:n.offset.top,h=t.top-e.collisionPosition.marginTop,c=h-l,u=h+e.collisionHeight-r-l,d="top"===e.my[1],p=d?-e.elemHeight:"bottom"===e.my[1]?e.elemHeight:0,f="top"===e.at[1]?e.targetHeight:"bottom"===e.at[1]?-e.targetHeight:0,g=-2*e.offset[1];0>c?(s=t.top+p+f+g+e.collisionHeight-r-o,(0>s||a(c)>s)&&(t.top+=p+f+g)):u>0&&(i=t.top-e.collisionPosition.marginTop+p+f+g-l,(i>0||u>a(i))&&(t.top+=p+f+g))}},flipfit:{left:function(){t.ui.position.flip.left.apply(this,arguments),t.ui.position.fit.left.apply(this,arguments)},top:function(){t.ui.position.flip.top.apply(this,arguments),t.ui.position.fit.top.apply(this,arguments)}}}}(),t.ui.position,t.extend(t.expr[":"],{data:t.expr.createPseudo?t.expr.createPseudo(function(e){return function(i){return!!t.data(i,e)}}):function(e,i,s){return!!t.data(e,s[3])}}),t.fn.extend({disableSelection:function(){var t="onselectstart"in document.createElement("div")?"selectstart":"mousedown";return function(){return this.on(t+".ui-disableSelection",function(t){t.preventDefault()})}}(),enableSelection:function(){return this.off(".ui-disableSelection")}}),t.ui.focusable=function(i,s){var n,o,a,r,l,h=i.nodeName.toLowerCase();return"area"===h?(n=i.parentNode,o=n.name,i.href&&o&&"map"===n.nodeName.toLowerCase()?(a=t("img[usemap='#"+o+"']"),a.length>0&&a.is(":visible")):!1):(/^(input|select|textarea|button|object)$/.test(h)?(r=!i.disabled,r&&(l=t(i).closest("fieldset")[0],l&&(r=!l.disabled))):r="a"===h?i.href||s:s,r&&t(i).is(":visible")&&e(t(i)))},t.extend(t.expr[":"],{focusable:function(e){return t.ui.focusable(e,null!=t.attr(e,"tabindex"))}}),t.ui.focusable,t.fn.form=function(){return"string"==typeof this[0].form?this.closest("form"):t(this[0].form)},t.ui.formResetMixin={_formResetHandler:function(){var e=t(this);setTimeout(function(){var i=e.data("ui-form-reset-instances");t.each(i,function(){this.refresh()})})},_bindFormResetHandler:function(){if (this.form=this.element.form(),this.form.length){var t=this.form.data("ui-form-reset-instances")||[];t.length||this.form.on("reset.ui-form-reset",this._formResetHandler),t.push(this),this.form.data("ui-form-reset-instances",t)}},_unbindFormResetHandler:function(){if (this.form.length){var e=this.form.data("ui-form-reset-instances");e.splice(t.inArray(this,e),1),e.length?this.form.data("ui-form-reset-instances",e):this.form.removeData("ui-form-reset-instances").off("reset.ui-form-reset")}}},"1.7"===t.fn.jquery.substring(0,3)&&(t.each(["Width","Height"],function(e,i){function s(e,i,s,o){return t.each(n,function(){i-=parseFloat(t.css(e,"padding"+this))||0,s&&(i-=parseFloat(t.css(e,"border"+this+"Width"))||0),o&&(i-=parseFloat(t.css(e,"margin"+this))||0)}),i}var n="Width"===i?["Left","Right"]:["Top","Bottom"],o=i.toLowerCase(),a={innerWidth:t.fn.innerWidth,innerHeight:t.fn.innerHeight,outerWidth:t.fn.outerWidth,outerHeight:t.fn.outerHeight};t.fn["inner"+i]=function(e){return void 0===e?a["inner"+i].call(this):this.each(function(){t(this).css(o,s(this,e)+"px")})},t.fn["outer"+i]=function(e,n){return"number"!=typeof e?a["outer"+i].call(this,e):this.each(function(){t(this).css(o,s(this,e,!0,n)+"px")})}}),t.fn.addBack=function(t){return this.add(null==t?this.prevObject:this.prevObject.filter(t))}),t.ui.keyCode={BACKSPACE:8,COMMA:188,DELETE:46,DOWN:40,END:35,ENTER:13,ESCAPE:27,HOME:36,LEFT:37,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190,RIGHT:39,SPACE:32,TAB:9,UP:38},t.ui.escapeSelector=function(){var t=/([!"#$%&'()*+,./:;<=>?@[\]^`{|}~])/g;return function(e){return e.replace(t,"\\$1")}}(),t.fn.labels=function(){var e,i,s,n,o;return this[0].labels&&this[0].labels.length?this.pushStack(this[0].labels):(n=this.eq(0).parents("label"),s=this.attr("id"),s&&(e=this.eq(0).parents().last(),o=e.add(e.length?e.siblings():this.siblings()),i="label[for='"+t.ui.escapeSelector(s)+"']",n=n.add(o.find(i).addBack(i))),this.pushStack(n))},t.fn.scrollParent=function(e){var i=this.css("position"),s="absolute"===i,n=e?/(auto|scroll|hidden)/:/(auto|scroll)/,o=this.parents().filter(function(){var e=t(this);return s&&"static"===e.css("position")?!1:n.test(e.css("overflow")+e.css("overflow-y")+e.css("overflow-x"))}).eq(0);return"fixed"!==i&&o.length?o:t(this[0].ownerDocument||document)},t.extend(t.expr[":"],{tabbable:function(e){var i=t.attr(e,"tabindex"),s=null!=i;return(!s||i>=0)&&t.ui.focusable(e,s)}}),t.fn.extend({uniqueId:function(){var t=0;return function(){return this.each(function(){this.id||(this.id="ui-id-"+ ++t)})}}(),removeUniqueId:function(){return this.each(function(){/^ui-id-\d+$/.test(this.id)&&t(this).removeAttr("id")})}}),t.ui.ie=!!/msie [\w.]+/.exec(navigator.userAgent.toLowerCase());var h=!1;t(document).on("mouseup",function(){h=!1}),t.widget("ui.mouse",{version:"1.12.1",options:{cancel:"input, textarea, button, select, option",distance:1,delay:0},_mouseInit:function(){var e=this;this.element.on("mousedown."+this.widgetName,function(t){return e._mouseDown(t)}).on("click."+this.widgetName,function(i){return!0===t.data(i.target,e.widgetName+".preventClickEvent")?(t.removeData(i.target,e.widgetName+".preventClickEvent"),i.stopImmediatePropagation(),!1):void 0}),this.started=!1},_mouseDestroy:function(){this.element.off("."+this.widgetName),this._mouseMoveDelegate&&this.document.off("mousemove."+this.widgetName,this._mouseMoveDelegate).off("mouseup."+this.widgetName,this._mouseUpDelegate)},_mouseDown:function(e){if (!h){this._mouseMoved=!1,this._mouseStarted&&this._mouseUp(e),this._mouseDownEvent=e;var i=this,s=1===e.which,n="string"==typeof this.options.cancel&&e.target.nodeName?t(e.target).closest(this.options.cancel).length:!1;return s&&!n&&this._mouseCapture(e)?(this.mouseDelayMet=!this.options.delay,this.mouseDelayMet||(this._mouseDelayTimer=setTimeout(function(){i.mouseDelayMet=!0},this.options.delay)),this._mouseDistanceMet(e)&&this._mouseDelayMet(e)&&(this._mouseStarted=this._mouseStart(e)!==!1,!this._mouseStarted)?(e.preventDefault(),!0):(!0===t.data(e.target,this.widgetName+".preventClickEvent")&&t.removeData(e.target,this.widgetName+".preventClickEvent"),this._mouseMoveDelegate=function(t){return i._mouseMove(t)},this._mouseUpDelegate=function(t){return i._mouseUp(t)},this.document.on("mousemove."+this.widgetName,this._mouseMoveDelegate).on("mouseup."+this.widgetName,this._mouseUpDelegate),e.preventDefault(),h=!0,!0)):!0}},_mouseMove:function(e){if (this._mouseMoved){if (t.ui.ie&&(!document.documentMode||9>document.documentMode)&&!e.button)return this._mouseUp(e);if (!e.which)if (e.originalEvent.altKey||e.originalEvent.ctrlKey||e.originalEvent.metaKey||e.originalEvent.shiftKey)this.ignoreMissingWhich=!0;else if (!this.ignoreMissingWhich)return this._mouseUp(e)}return(e.which||e.button)&&(this._mouseMoved=!0),this._mouseStarted?(this._mouseDrag(e),e.preventDefault()):(this._mouseDistanceMet(e)&&this._mouseDelayMet(e)&&(this._mouseStarted=this._mouseStart(this._mouseDownEvent,e)!==!1,this._mouseStarted?this._mouseDrag(e):this._mouseUp(e)),!this._mouseStarted)},_mouseUp:function(e){this.document.off("mousemove."+this.widgetName,this._mouseMoveDelegate).off("mouseup."+this.widgetName,this._mouseUpDelegate),this._mouseStarted&&(this._mouseStarted=!1,e.target===this._mouseDownEvent.target&&t.data(e.target,this.widgetName+".preventClickEvent",!0),this._mouseStop(e)),this._mouseDelayTimer&&(clearTimeout(this._mouseDelayTimer),delete this._mouseDelayTimer),this.ignoreMissingWhich=!1,h=!1,e.preventDefault()},_mouseDistanceMet:function(t){return Math.max(Math.abs(this._mouseDownEvent.pageX-t.pageX),Math.abs(this._mouseDownEvent.pageY-t.pageY))>=this.options.distance},_mouseDelayMet:function(){return this.mouseDelayMet},_mouseStart:function(){},_mouseDrag:function(){},_mouseStop:function(){},_mouseCapture:function(){return!0}}),t.ui.plugin={add:function(e,i,s){var n,o=t.ui[e].prototype;for(n in s)o.plugins[n]=o.plugins[n]||[],o.plugins[n].push([i,s[n]])},call:function(t,e,i,s){var n,o=t.plugins[e];if (o&&(s||t.element[0].parentNode&&11!==t.element[0].parentNode.nodeType))for(n=0;o.length>n;n++)t.options[o[n][0]]&&o[n][1].apply(t.element,i)}},t.ui.safeActiveElement=function(t){var e;try{e=t.activeElement}catch(i){e=t.body}return e||(e=t.body),e.nodeName||(e=t.body),e},t.ui.safeBlur=function(e){e&&"body"!==e.nodeName.toLowerCase()&&t(e).trigger("blur")},t.widget("ui.draggable",t.ui.mouse,{version:"1.12.1",widgetEventPrefix:"drag",options:{addClasses:!0,appendTo:"parent",axis:!1,connectToSortable:!1,containment:!1,cursor:"auto",cursorAt:!1,grid:!1,handle:!1,helper:"original",iframeFix:!1,opacity:!1,refreshPositions:!1,revert:!1,revertDuration:500,scope:"default",scroll:!0,scrollSensitivity:20,scrollSpeed:20,snap:!1,snapMode:"both",snapTolerance:20,stack:!1,zIndex:!1,drag:null,start:null,stop:null},_create:function(){"original"===this.options.helper&&this._setPositionRelative(),this.options.addClasses&&this._addClass("ui-draggable"),this._setHandleClassName(),this._mouseInit()},_setOption:function(t,e){this._super(t,e),"handle"===t&&(this._removeHandleClassName(),this._setHandleClassName())},_destroy:function(){return(this.helper||this.element).is(".ui-draggable-dragging")?(this.destroyOnClear=!0,void 0):(this._removeHandleClassName(),this._mouseDestroy(),void 0)},_mouseCapture:function(e){var i=this.options;return this.helper||i.disabled||t(e.target).closest(".ui-resizable-handle").length>0?!1:(this.handle=this._getHandle(e),this.handle?(this._blurActiveElement(e),this._blockFrames(i.iframeFix===!0?"iframe":i.iframeFix),!0):!1)},_blockFrames:function(e){this.iframeBlocks=this.document.find(e).map(function(){var e=t(this);return t("<div>").css("position","absolute").appendTo(e.parent()).outerWidth(e.outerWidth()).outerHeight(e.outerHeight()).offset(e.offset())[0]})},_unblockFrames:function(){this.iframeBlocks&&(this.iframeBlocks.remove(),delete this.iframeBlocks)},_blurActiveElement:function(e){var i=t.ui.safeActiveElement(this.document[0]),s=t(e.target);s.closest(i).length||t.ui.safeBlur(i)},_mouseStart:function(e){var i=this.options;return this.helper=this._createHelper(e),this._addClass(this.helper,"ui-draggable-dragging"),this._cacheHelperProportions(),t.ui.ddmanager&&(t.ui.ddmanager.current=this),this._cacheMargins(),this.cssPosition=this.helper.css("position"),this.scrollParent=this.helper.scrollParent(!0),this.offsetParent=this.helper.offsetParent(),this.hasFixedAncestor=this.helper.parents().filter(function(){return"fixed"===t(this).css("position")}).length>0,this.positionAbs=this.element.offset(),this._refreshOffsets(e),this.originalPosition=this.position=this._generatePosition(e,!1),this.originalPageX=e.pageX,this.originalPageY=e.pageY,i.cursorAt&&this._adjustOffsetFromHelper(i.cursorAt),this._setContainment(),this._trigger("start",e)===!1?(this._clear(),!1):(this._cacheHelperProportions(),t.ui.ddmanager&&!i.dropBehaviour&&t.ui.ddmanager.prepareOffsets(this,e),this._mouseDrag(e,!0),t.ui.ddmanager&&t.ui.ddmanager.dragStart(this,e),!0)},_refreshOffsets:function(t){this.offset={top:this.positionAbs.top-this.margins.top,left:this.positionAbs.left-this.margins.left,scroll:!1,parent:this._getParentOffset(),relative:this._getRelativeOffset()},this.offset.click={left:t.pageX-this.offset.left,top:t.pageY-this.offset.top}},_mouseDrag:function(e,i){if (this.hasFixedAncestor&&(this.offset.parent=this._getParentOffset()),this.position=this._generatePosition(e,!0),this.positionAbs=this._convertPositionTo("absolute"),!i){var s=this._uiHash();if (this._trigger("drag",e,s)===!1)return this._mouseUp(new t.Event("mouseup",e)),!1;this.position=s.position}return this.helper[0].style.left=this.position.left+"px",this.helper[0].style.top=this.position.top+"px",t.ui.ddmanager&&t.ui.ddmanager.drag(this,e),!1},_mouseStop:function(e){var i=this,s=!1;return t.ui.ddmanager&&!this.options.dropBehaviour&&(s=t.ui.ddmanager.drop(this,e)),this.dropped&&(s=this.dropped,this.dropped=!1),"invalid"===this.options.revert&&!s||"valid"===this.options.revert&&s||this.options.revert===!0||t.isFunction(this.options.revert)&&this.options.revert.call(this.element,s)?t(this.helper).animate(this.originalPosition,parseInt(this.options.revertDuration,10),function(){i._trigger("stop",e)!==!1&&i._clear()}):this._trigger("stop",e)!==!1&&this._clear(),!1},_mouseUp:function(e){return this._unblockFrames(),t.ui.ddmanager&&t.ui.ddmanager.dragStop(this,e),this.handleElement.is(e.target)&&this.element.trigger("focus"),t.ui.mouse.prototype._mouseUp.call(this,e)},cancel:function(){return this.helper.is(".ui-draggable-dragging")?this._mouseUp(new t.Event("mouseup",{target:this.element[0]})):this._clear(),this},_getHandle:function(e){return this.options.handle?!!t(e.target).closest(this.element.find(this.options.handle)).length:!0},_setHandleClassName:function(){this.handleElement=this.options.handle?this.element.find(this.options.handle):this.element,this._addClass(this.handleElement,"ui-draggable-handle")},_removeHandleClassName:function(){this._removeClass(this.handleElement,"ui-draggable-handle")},_createHelper:function(e){var i=this.options,s=t.isFunction(i.helper),n=s?t(i.helper.apply(this.element[0],[e])):"clone"===i.helper?this.element.clone().removeAttr("id"):this.element;return n.parents("body").length||n.appendTo("parent"===i.appendTo?this.element[0].parentNode:i.appendTo),s&&n[0]===this.element[0]&&this._setPositionRelative(),n[0]===this.element[0]||/(fixed|absolute)/.test(n.css("position"))||n.css("position","absolute"),n},_setPositionRelative:function(){/^(?:r|a|f)/.test(this.element.css("position"))||(this.element[0].style.position="relative")},_adjustOffsetFromHelper:function(e){"string"==typeof e&&(e=e.split(" ")),t.isArray(e)&&(e={left:+e[0],top:+e[1]||0}),"left"in e&&(this.offset.click.left=e.left+this.margins.left),"right"in e&&(this.offset.click.left=this.helperProportions.width-e.right+this.margins.left),"top"in e&&(this.offset.click.top=e.top+this.margins.top),"bottom"in e&&(this.offset.click.top=this.helperProportions.height-e.bottom+this.margins.top)},_isRootNode:function(t){return/(html|body)/i.test(t.tagName)||t===this.document[0]},_getParentOffset:function(){var e=this.offsetParent.offset(),i=this.document[0];return"absolute"===this.cssPosition&&this.scrollParent[0]!==i&&t.contains(this.scrollParent[0],this.offsetParent[0])&&(e.left+=this.scrollParent.scrollLeft(),e.top+=this.scrollParent.scrollTop()),this._isRootNode(this.offsetParent[0])&&(e={top:0,left:0}),{top:e.top+(parseInt(this.offsetParent.css("borderTopWidth"),10)||0),left:e.left+(parseInt(this.offsetParent.css("borderLeftWidth"),10)||0)}},_getRelativeOffset:function(){if ("relative"!==this.cssPosition)return{top:0,left:0};var t=this.element.position(),e=this._isRootNode(this.scrollParent[0]);return{top:t.top-(parseInt(this.helper.css("top"),10)||0)+(e?0:this.scrollParent.scrollTop()),left:t.left-(parseInt(this.helper.css("left"),10)||0)+(e?0:this.scrollParent.scrollLeft())}},_cacheMargins:function(){this.margins={left:parseInt(this.element.css("marginLeft"),10)||0,top:parseInt(this.element.css("marginTop"),10)||0,right:parseInt(this.element.css("marginRight"),10)||0,bottom:parseInt(this.element.css("marginBottom"),10)||0}},_cacheHelperProportions:function(){this.helperProportions={width:this.helper.outerWidth(),height:this.helper.outerHeight()}},_setContainment:function(){var e,i,s,n=this.options,o=this.document[0];return this.relativeContainer=null,n.containment?"window"===n.containment?(this.containment=[t(window).scrollLeft()-this.offset.relative.left-this.offset.parent.left,t(window).scrollTop()-this.offset.relative.top-this.offset.parent.top,t(window).scrollLeft()+t(window).width()-this.helperProportions.width-this.margins.left,t(window).scrollTop()+(t(window).height()||o.body.parentNode.scrollHeight)-this.helperProportions.height-this.margins.top],void 0):"document"===n.containment?(this.containment=[0,0,t(o).width()-this.helperProportions.width-this.margins.left,(t(o).height()||o.body.parentNode.scrollHeight)-this.helperProportions.height-this.margins.top],void 0):n.containment.constructor===Array?(this.containment=n.containment,void 0):("parent"===n.containment&&(n.containment=this.helper[0].parentNode),i=t(n.containment),s=i[0],s&&(e=/(scroll|auto)/.test(i.css("overflow")),this.containment=[(parseInt(i.css("borderLeftWidth"),10)||0)+(parseInt(i.css("paddingLeft"),10)||0),(parseInt(i.css("borderTopWidth"),10)||0)+(parseInt(i.css("paddingTop"),10)||0),(e?Math.max(s.scrollWidth,s.offsetWidth):s.offsetWidth)-(parseInt(i.css("borderRightWidth"),10)||0)-(parseInt(i.css("paddingRight"),10)||0)-this.helperProportions.width-this.margins.left-this.margins.right,(e?Math.max(s.scrollHeight,s.offsetHeight):s.offsetHeight)-(parseInt(i.css("borderBottomWidth"),10)||0)-(parseInt(i.css("paddingBottom"),10)||0)-this.helperProportions.height-this.margins.top-this.margins.bottom],this.relativeContainer=i),void 0):(this.containment=null,void 0)
},_convertPositionTo:function(t,e){e||(e=this.position);var i="absolute"===t?1:-1,s=this._isRootNode(this.scrollParent[0]);return{top:e.top+this.offset.relative.top*i+this.offset.parent.top*i-("fixed"===this.cssPosition?-this.offset.scroll.top:s?0:this.offset.scroll.top)*i,left:e.left+this.offset.relative.left*i+this.offset.parent.left*i-("fixed"===this.cssPosition?-this.offset.scroll.left:s?0:this.offset.scroll.left)*i}},_generatePosition:function(t,e){var i,s,n,o,a=this.options,r=this._isRootNode(this.scrollParent[0]),l=t.pageX,h=t.pageY;return r&&this.offset.scroll||(this.offset.scroll={top:this.scrollParent.scrollTop(),left:this.scrollParent.scrollLeft()}),e&&(this.containment&&(this.relativeContainer?(s=this.relativeContainer.offset(),i=[this.containment[0]+s.left,this.containment[1]+s.top,this.containment[2]+s.left,this.containment[3]+s.top]):i=this.containment,t.pageX-this.offset.click.left<i[0]&&(l=i[0]+this.offset.click.left),t.pageY-this.offset.click.top<i[1]&&(h=i[1]+this.offset.click.top),t.pageX-this.offset.click.left>i[2]&&(l=i[2]+this.offset.click.left),t.pageY-this.offset.click.top>i[3]&&(h=i[3]+this.offset.click.top)),a.grid&&(n=a.grid[1]?this.originalPageY+Math.round((h-this.originalPageY)/a.grid[1])*a.grid[1]:this.originalPageY,h=i?n-this.offset.click.top>=i[1]||n-this.offset.click.top>i[3]?n:n-this.offset.click.top>=i[1]?n-a.grid[1]:n+a.grid[1]:n,o=a.grid[0]?this.originalPageX+Math.round((l-this.originalPageX)/a.grid[0])*a.grid[0]:this.originalPageX,l=i?o-this.offset.click.left>=i[0]||o-this.offset.click.left>i[2]?o:o-this.offset.click.left>=i[0]?o-a.grid[0]:o+a.grid[0]:o),"y"===a.axis&&(l=this.originalPageX),"x"===a.axis&&(h=this.originalPageY)),{top:h-this.offset.click.top-this.offset.relative.top-this.offset.parent.top+("fixed"===this.cssPosition?-this.offset.scroll.top:r?0:this.offset.scroll.top),left:l-this.offset.click.left-this.offset.relative.left-this.offset.parent.left+("fixed"===this.cssPosition?-this.offset.scroll.left:r?0:this.offset.scroll.left)}},_clear:function(){this._removeClass(this.helper,"ui-draggable-dragging"),this.helper[0]===this.element[0]||this.cancelHelperRemoval||this.helper.remove(),this.helper=null,this.cancelHelperRemoval=!1,this.destroyOnClear&&this.destroy()},_trigger:function(e,i,s){return s=s||this._uiHash(),t.ui.plugin.call(this,e,[i,s,this],!0),/^(drag|start|stop)/.test(e)&&(this.positionAbs=this._convertPositionTo("absolute"),s.offset=this.positionAbs),t.Widget.prototype._trigger.call(this,e,i,s)},plugins:{},_uiHash:function(){return{helper:this.helper,position:this.position,originalPosition:this.originalPosition,offset:this.positionAbs}}}),t.ui.plugin.add("draggable","connectToSortable",{start:function(e,i,s){var n=t.extend({},i,{item:s.element});s.sortables=[],t(s.options.connectToSortable).each(function(){var i=t(this).sortable("instance");i&&!i.options.disabled&&(s.sortables.push(i),i.refreshPositions(),i._trigger("activate",e,n))})},stop:function(e,i,s){var n=t.extend({},i,{item:s.element});s.cancelHelperRemoval=!1,t.each(s.sortables,function(){var t=this;t.isOver?(t.isOver=0,s.cancelHelperRemoval=!0,t.cancelHelperRemoval=!1,t._storedCSS={position:t.placeholder.css("position"),top:t.placeholder.css("top"),left:t.placeholder.css("left")},t._mouseStop(e),t.options.helper=t.options._helper):(t.cancelHelperRemoval=!0,t._trigger("deactivate",e,n))})},drag:function(e,i,s){t.each(s.sortables,function(){var n=!1,o=this;o.positionAbs=s.positionAbs,o.helperProportions=s.helperProportions,o.offset.click=s.offset.click,o._intersectsWith(o.containerCache)&&(n=!0,t.each(s.sortables,function(){return this.positionAbs=s.positionAbs,this.helperProportions=s.helperProportions,this.offset.click=s.offset.click,this!==o&&this._intersectsWith(this.containerCache)&&t.contains(o.element[0],this.element[0])&&(n=!1),n})),n?(o.isOver||(o.isOver=1,s._parent=i.helper.parent(),o.currentItem=i.helper.appendTo(o.element).data("ui-sortable-item",!0),o.options._helper=o.options.helper,o.options.helper=function(){return i.helper[0]},e.target=o.currentItem[0],o._mouseCapture(e,!0),o._mouseStart(e,!0,!0),o.offset.click.top=s.offset.click.top,o.offset.click.left=s.offset.click.left,o.offset.parent.left-=s.offset.parent.left-o.offset.parent.left,o.offset.parent.top-=s.offset.parent.top-o.offset.parent.top,s._trigger("toSortable",e),s.dropped=o.element,t.each(s.sortables,function(){this.refreshPositions()}),s.currentItem=s.element,o.fromOutside=s),o.currentItem&&(o._mouseDrag(e),i.position=o.position)):o.isOver&&(o.isOver=0,o.cancelHelperRemoval=!0,o.options._revert=o.options.revert,o.options.revert=!1,o._trigger("out",e,o._uiHash(o)),o._mouseStop(e,!0),o.options.revert=o.options._revert,o.options.helper=o.options._helper,o.placeholder&&o.placeholder.remove(),i.helper.appendTo(s._parent),s._refreshOffsets(e),i.position=s._generatePosition(e,!0),s._trigger("fromSortable",e),s.dropped=!1,t.each(s.sortables,function(){this.refreshPositions()}))})}}),t.ui.plugin.add("draggable","cursor",{start:function(e,i,s){var n=t("body"),o=s.options;n.css("cursor")&&(o._cursor=n.css("cursor")),n.css("cursor",o.cursor)},stop:function(e,i,s){var n=s.options;n._cursor&&t("body").css("cursor",n._cursor)}}),t.ui.plugin.add("draggable","opacity",{start:function(e,i,s){var n=t(i.helper),o=s.options;n.css("opacity")&&(o._opacity=n.css("opacity")),n.css("opacity",o.opacity)},stop:function(e,i,s){var n=s.options;n._opacity&&t(i.helper).css("opacity",n._opacity)}}),t.ui.plugin.add("draggable","scroll",{start:function(t,e,i){i.scrollParentNotHidden||(i.scrollParentNotHidden=i.helper.scrollParent(!1)),i.scrollParentNotHidden[0]!==i.document[0]&&"HTML"!==i.scrollParentNotHidden[0].tagName&&(i.overflowOffset=i.scrollParentNotHidden.offset())},drag:function(e,i,s){var n=s.options,o=!1,a=s.scrollParentNotHidden[0],r=s.document[0];a!==r&&"HTML"!==a.tagName?(n.axis&&"x"===n.axis||(s.overflowOffset.top+a.offsetHeight-e.pageY<n.scrollSensitivity?a.scrollTop=o=a.scrollTop+n.scrollSpeed:e.pageY-s.overflowOffset.top<n.scrollSensitivity&&(a.scrollTop=o=a.scrollTop-n.scrollSpeed)),n.axis&&"y"===n.axis||(s.overflowOffset.left+a.offsetWidth-e.pageX<n.scrollSensitivity?a.scrollLeft=o=a.scrollLeft+n.scrollSpeed:e.pageX-s.overflowOffset.left<n.scrollSensitivity&&(a.scrollLeft=o=a.scrollLeft-n.scrollSpeed))):(n.axis&&"x"===n.axis||(e.pageY-t(r).scrollTop()<n.scrollSensitivity?o=t(r).scrollTop(t(r).scrollTop()-n.scrollSpeed):t(window).height()-(e.pageY-t(r).scrollTop())<n.scrollSensitivity&&(o=t(r).scrollTop(t(r).scrollTop()+n.scrollSpeed))),n.axis&&"y"===n.axis||(e.pageX-t(r).scrollLeft()<n.scrollSensitivity?o=t(r).scrollLeft(t(r).scrollLeft()-n.scrollSpeed):t(window).width()-(e.pageX-t(r).scrollLeft())<n.scrollSensitivity&&(o=t(r).scrollLeft(t(r).scrollLeft()+n.scrollSpeed)))),o!==!1&&t.ui.ddmanager&&!n.dropBehaviour&&t.ui.ddmanager.prepareOffsets(s,e)}}),t.ui.plugin.add("draggable","snap",{start:function(e,i,s){var n=s.options;s.snapElements=[],t(n.snap.constructor!==String?n.snap.items||":data(ui-draggable)":n.snap).each(function(){var e=t(this),i=e.offset();this!==s.element[0]&&s.snapElements.push({item:this,width:e.outerWidth(),height:e.outerHeight(),top:i.top,left:i.left})})},drag:function(e,i,s){var n,o,a,r,l,h,c,u,d,p,f=s.options,g=f.snapTolerance,m=i.offset.left,_=m+s.helperProportions.width,v=i.offset.top,b=v+s.helperProportions.height;for(d=s.snapElements.length-1;d>=0;d--)l=s.snapElements[d].left-s.margins.left,h=l+s.snapElements[d].width,c=s.snapElements[d].top-s.margins.top,u=c+s.snapElements[d].height,l-g>_||m>h+g||c-g>b||v>u+g||!t.contains(s.snapElements[d].item.ownerDocument,s.snapElements[d].item)?(s.snapElements[d].snapping&&s.options.snap.release&&s.options.snap.release.call(s.element,e,t.extend(s._uiHash(),{snapItem:s.snapElements[d].item})),s.snapElements[d].snapping=!1):("inner"!==f.snapMode&&(n=g>=Math.abs(c-b),o=g>=Math.abs(u-v),a=g>=Math.abs(l-_),r=g>=Math.abs(h-m),n&&(i.position.top=s._convertPositionTo("relative",{top:c-s.helperProportions.height,left:0}).top),o&&(i.position.top=s._convertPositionTo("relative",{top:u,left:0}).top),a&&(i.position.left=s._convertPositionTo("relative",{top:0,left:l-s.helperProportions.width}).left),r&&(i.position.left=s._convertPositionTo("relative",{top:0,left:h}).left)),p=n||o||a||r,"outer"!==f.snapMode&&(n=g>=Math.abs(c-v),o=g>=Math.abs(u-b),a=g>=Math.abs(l-m),r=g>=Math.abs(h-_),n&&(i.position.top=s._convertPositionTo("relative",{top:c,left:0}).top),o&&(i.position.top=s._convertPositionTo("relative",{top:u-s.helperProportions.height,left:0}).top),a&&(i.position.left=s._convertPositionTo("relative",{top:0,left:l}).left),r&&(i.position.left=s._convertPositionTo("relative",{top:0,left:h-s.helperProportions.width}).left)),!s.snapElements[d].snapping&&(n||o||a||r||p)&&s.options.snap.snap&&s.options.snap.snap.call(s.element,e,t.extend(s._uiHash(),{snapItem:s.snapElements[d].item})),s.snapElements[d].snapping=n||o||a||r||p)}}),t.ui.plugin.add("draggable","stack",{start:function(e,i,s){var n,o=s.options,a=t.makeArray(t(o.stack)).sort(function(e,i){return(parseInt(t(e).css("zIndex"),10)||0)-(parseInt(t(i).css("zIndex"),10)||0)});a.length&&(n=parseInt(t(a[0]).css("zIndex"),10)||0,t(a).each(function(e){t(this).css("zIndex",n+e)}),this.css("zIndex",n+a.length))}}),t.ui.plugin.add("draggable","zIndex",{start:function(e,i,s){var n=t(i.helper),o=s.options;n.css("zIndex")&&(o._zIndex=n.css("zIndex")),n.css("zIndex",o.zIndex)},stop:function(e,i,s){var n=s.options;n._zIndex&&t(i.helper).css("zIndex",n._zIndex)}}),t.ui.draggable,t.widget("ui.droppable",{version:"1.12.1",widgetEventPrefix:"drop",options:{accept:"*",addClasses:!0,greedy:!1,scope:"default",tolerance:"intersect",activate:null,deactivate:null,drop:null,out:null,over:null},_create:function(){var e,i=this.options,s=i.accept;this.isover=!1,this.isout=!0,this.accept=t.isFunction(s)?s:function(t){return t.is(s)},this.proportions=function(){return arguments.length?(e=arguments[0],void 0):e?e:e={width:this.element[0].offsetWidth,height:this.element[0].offsetHeight}},this._addToManager(i.scope),i.addClasses&&this._addClass("ui-droppable")},_addToManager:function(e){t.ui.ddmanager.droppables[e]=t.ui.ddmanager.droppables[e]||[],t.ui.ddmanager.droppables[e].push(this)},_splice:function(t){for(var e=0;t.length>e;e++)t[e]===this&&t.splice(e,1)},_destroy:function(){var e=t.ui.ddmanager.droppables[this.options.scope];this._splice(e)},_setOption:function(e,i){if ("accept"===e)this.accept=t.isFunction(i)?i:function(t){return t.is(i)};else if ("scope"===e){var s=t.ui.ddmanager.droppables[this.options.scope];this._splice(s),this._addToManager(i)}this._super(e,i)},_activate:function(e){var i=t.ui.ddmanager.current;this._addActiveClass(),i&&this._trigger("activate",e,this.ui(i))},_deactivate:function(e){var i=t.ui.ddmanager.current;this._removeActiveClass(),i&&this._trigger("deactivate",e,this.ui(i))},_over:function(e){var i=t.ui.ddmanager.current;i&&(i.currentItem||i.element)[0]!==this.element[0]&&this.accept.call(this.element[0],i.currentItem||i.element)&&(this._addHoverClass(),this._trigger("over",e,this.ui(i)))},_out:function(e){var i=t.ui.ddmanager.current;i&&(i.currentItem||i.element)[0]!==this.element[0]&&this.accept.call(this.element[0],i.currentItem||i.element)&&(this._removeHoverClass(),this._trigger("out",e,this.ui(i)))},_drop:function(e,i){var s=i||t.ui.ddmanager.current,n=!1;return s&&(s.currentItem||s.element)[0]!==this.element[0]?(this.element.find(":data(ui-droppable)").not(".ui-draggable-dragging").each(function(){var i=t(this).droppable("instance");return i.options.greedy&&!i.options.disabled&&i.options.scope===s.options.scope&&i.accept.call(i.element[0],s.currentItem||s.element)&&c(s,t.extend(i,{offset:i.element.offset()}),i.options.tolerance,e)?(n=!0,!1):void 0}),n?!1:this.accept.call(this.element[0],s.currentItem||s.element)?(this._removeActiveClass(),this._removeHoverClass(),this._trigger("drop",e,this.ui(s)),this.element):!1):!1},ui:function(t){return{draggable:t.currentItem||t.element,helper:t.helper,position:t.position,offset:t.positionAbs}},_addHoverClass:function(){this._addClass("ui-droppable-hover")},_removeHoverClass:function(){this._removeClass("ui-droppable-hover")},_addActiveClass:function(){this._addClass("ui-droppable-active")},_removeActiveClass:function(){this._removeClass("ui-droppable-active")}});var c=t.ui.intersect=function(){function t(t,e,i){return t>=e&&e+i>t}return function(e,i,s,n){if (!i.offset)return!1;var o=(e.positionAbs||e.position.absolute).left+e.margins.left,a=(e.positionAbs||e.position.absolute).top+e.margins.top,r=o+e.helperProportions.width,l=a+e.helperProportions.height,h=i.offset.left,c=i.offset.top,u=h+i.proportions().width,d=c+i.proportions().height;switch(s){case"fit":return o>=h&&u>=r&&a>=c&&d>=l;case"intersect":return o+e.helperProportions.width/2>h&&u>r-e.helperProportions.width/2&&a+e.helperProportions.height/2>c&&d>l-e.helperProportions.height/2;case"pointer":return t(n.pageY,c,i.proportions().height)&&t(n.pageX,h,i.proportions().width);case"touch":return(a>=c&&d>=a||l>=c&&d>=l||c>a&&l>d)&&(o>=h&&u>=o||r>=h&&u>=r||h>o&&r>u);default:return!1}}}();t.ui.ddmanager={current:null,droppables:{"default":[]},prepareOffsets:function(e,i){var s,n,o=t.ui.ddmanager.droppables[e.options.scope]||[],a=i?i.type:null,r=(e.currentItem||e.element).find(":data(ui-droppable)").addBack();t:for(s=0;o.length>s;s++)if (!(o[s].options.disabled||e&&!o[s].accept.call(o[s].element[0],e.currentItem||e.element))){for(n=0;r.length>n;n++)if (r[n]===o[s].element[0]){o[s].proportions().height=0;continue t}o[s].visible="none"!==o[s].element.css("display"),o[s].visible&&("mousedown"===a&&o[s]._activate.call(o[s],i),o[s].offset=o[s].element.offset(),o[s].proportions({width:o[s].element[0].offsetWidth,height:o[s].element[0].offsetHeight}))}},drop:function(e,i){var s=!1;return t.each((t.ui.ddmanager.droppables[e.options.scope]||[]).slice(),function(){this.options&&(!this.options.disabled&&this.visible&&c(e,this,this.options.tolerance,i)&&(s=this._drop.call(this,i)||s),!this.options.disabled&&this.visible&&this.accept.call(this.element[0],e.currentItem||e.element)&&(this.isout=!0,this.isover=!1,this._deactivate.call(this,i)))}),s},dragStart:function(e,i){e.element.parentsUntil("body").on("scroll.droppable",function(){e.options.refreshPositions||t.ui.ddmanager.prepareOffsets(e,i)})},drag:function(e,i){e.options.refreshPositions&&t.ui.ddmanager.prepareOffsets(e,i),t.each(t.ui.ddmanager.droppables[e.options.scope]||[],function(){if (!this.options.disabled&&!this.greedyChild&&this.visible){var s,n,o,a=c(e,this,this.options.tolerance,i),r=!a&&this.isover?"isout":a&&!this.isover?"isover":null;r&&(this.options.greedy&&(n=this.options.scope,o=this.element.parents(":data(ui-droppable)").filter(function(){return t(this).droppable("instance").options.scope===n}),o.length&&(s=t(o[0]).droppable("instance"),s.greedyChild="isover"===r)),s&&"isover"===r&&(s.isover=!1,s.isout=!0,s._out.call(s,i)),this[r]=!0,this["isout"===r?"isover":"isout"]=!1,this["isover"===r?"_over":"_out"].call(this,i),s&&"isout"===r&&(s.isout=!1,s.isover=!0,s._over.call(s,i)))}})},dragStop:function(e,i){e.element.parentsUntil("body").off("scroll.droppable"),e.options.refreshPositions||t.ui.ddmanager.prepareOffsets(e,i)}},t.uiBackCompat!==!1&&t.widget("ui.droppable",t.ui.droppable,{options:{hoverClass:!1,activeClass:!1},_addActiveClass:function(){this._super(),this.options.activeClass&&this.element.addClass(this.options.activeClass)},_removeActiveClass:function(){this._super(),this.options.activeClass&&this.element.removeClass(this.options.activeClass)},_addHoverClass:function(){this._super(),this.options.hoverClass&&this.element.addClass(this.options.hoverClass)},_removeHoverClass:function(){this._super(),this.options.hoverClass&&this.element.removeClass(this.options.hoverClass)}}),t.ui.droppable,t.widget("ui.resizable",t.ui.mouse,{version:"1.12.1",widgetEventPrefix:"resize",options:{alsoResize:!1,animate:!1,animateDuration:"slow",animateEasing:"swing",aspectRatio:!1,autoHide:!1,classes:{"ui-resizable-se":"ui-icon ui-icon-gripsmall-diagonal-se"},containment:!1,ghost:!1,grid:!1,handles:"e,s,se",helper:!1,maxHeight:null,maxWidth:null,minHeight:10,minWidth:10,zIndex:90,resize:null,start:null,stop:null},_num:function(t){return parseFloat(t)||0},_isNumber:function(t){return!isNaN(parseFloat(t))},_hasScroll:function(e,i){if ("hidden"===t(e).css("overflow"))return!1;var s=i&&"left"===i?"scrollLeft":"scrollTop",n=!1;return e[s]>0?!0:(e[s]=1,n=e[s]>0,e[s]=0,n)},_create:function(){var e,i=this.options,s=this;this._addClass("ui-resizable"),t.extend(this,{_aspectRatio:!!i.aspectRatio,aspectRatio:i.aspectRatio,originalElement:this.element,_proportionallyResizeElements:[],_helper:i.helper||i.ghost||i.animate?i.helper||"ui-resizable-helper":null}),this.element[0].nodeName.match(/^(canvas|textarea|input|select|button|img)$/i)&&(this.element.wrap(t("<div class='ui-wrapper' style='overflow: hidden;'></div>").css({position:this.element.css("position"),width:this.element.outerWidth(),height:this.element.outerHeight(),top:this.element.css("top"),left:this.element.css("left")})),this.element=this.element.parent().data("ui-resizable",this.element.resizable("instance")),this.elementIsWrapper=!0,e={marginTop:this.originalElement.css("marginTop"),marginRight:this.originalElement.css("marginRight"),marginBottom:this.originalElement.css("marginBottom"),marginLeft:this.originalElement.css("marginLeft")},this.element.css(e),this.originalElement.css("margin",0),this.originalResizeStyle=this.originalElement.css("resize"),this.originalElement.css("resize","none"),this._proportionallyResizeElements.push(this.originalElement.css({position:"static",zoom:1,display:"block"})),this.originalElement.css(e),this._proportionallyResize()),this._setupHandles(),i.autoHide&&t(this.element).on("mouseenter",function(){i.disabled||(s._removeClass("ui-resizable-autohide"),s._handles.show())}).on("mouseleave",function(){i.disabled||s.resizing||(s._addClass("ui-resizable-autohide"),s._handles.hide())}),this._mouseInit()},_destroy:function(){this._mouseDestroy();var e,i=function(e){t(e).removeData("resizable").removeData("ui-resizable").off(".resizable").find(".ui-resizable-handle").remove()};return this.elementIsWrapper&&(i(this.element),e=this.element,this.originalElement.css({position:e.css("position"),width:e.outerWidth(),height:e.outerHeight(),top:e.css("top"),left:e.css("left")}).insertAfter(e),e.remove()),this.originalElement.css("resize",this.originalResizeStyle),i(this.originalElement),this},_setOption:function(t,e){switch(this._super(t,e),t){case"handles":this._removeHandles(),this._setupHandles();break;default:}},_setupHandles:function(){var e,i,s,n,o,a=this.options,r=this;if (this.handles=a.handles||(t(".ui-resizable-handle",this.element).length?{n:".ui-resizable-n",e:".ui-resizable-e",s:".ui-resizable-s",w:".ui-resizable-w",se:".ui-resizable-se",sw:".ui-resizable-sw",ne:".ui-resizable-ne",nw:".ui-resizable-nw"}:"e,s,se"),this._handles=t(),this.handles.constructor===String)for("all"===this.handles&&(this.handles="n,e,s,w,se,sw,ne,nw"),s=this.handles.split(","),this.handles={},i=0;s.length>i;i++)e=t.trim(s[i]),n="ui-resizable-"+e,o=t("<div>"),this._addClass(o,"ui-resizable-handle "+n),o.css({zIndex:a.zIndex}),this.handles[e]=".ui-resizable-"+e,this.element.append(o);this._renderAxis=function(e){var i,s,n,o;e=e||this.element;for(i in this.handles)this.handles[i].constructor===String?this.handles[i]=this.element.children(this.handles[i]).first().show():(this.handles[i].jquery||this.handles[i].nodeType)&&(this.handles[i]=t(this.handles[i]),this._on(this.handles[i],{mousedown:r._mouseDown})),this.elementIsWrapper&&this.originalElement[0].nodeName.match(/^(textarea|input|select|button)$/i)&&(s=t(this.handles[i],this.element),o=/sw|ne|nw|se|n|s/.test(i)?s.outerHeight():s.outerWidth(),n=["padding",/ne|nw|n/.test(i)?"Top":/se|sw|s/.test(i)?"Bottom":/^e$/.test(i)?"Right":"Left"].join(""),e.css(n,o),this._proportionallyResize()),this._handles=this._handles.add(this.handles[i])},this._renderAxis(this.element),this._handles=this._handles.add(this.element.find(".ui-resizable-handle")),this._handles.disableSelection(),this._handles.on("mouseover",function(){r.resizing||(this.className&&(o=this.className.match(/ui-resizable-(se|sw|ne|nw|n|e|s|w)/i)),r.axis=o&&o[1]?o[1]:"se")}),a.autoHide&&(this._handles.hide(),this._addClass("ui-resizable-autohide"))},_removeHandles:function(){this._handles.remove()},_mouseCapture:function(e){var i,s,n=!1;for(i in this.handles)s=t(this.handles[i])[0],(s===e.target||t.contains(s,e.target))&&(n=!0);return!this.options.disabled&&n},_mouseStart:function(e){var i,s,n,o=this.options,a=this.element;return this.resizing=!0,this._renderProxy(),i=this._num(this.helper.css("left")),s=this._num(this.helper.css("top")),o.containment&&(i+=t(o.containment).scrollLeft()||0,s+=t(o.containment).scrollTop()||0),this.offset=this.helper.offset(),this.position={left:i,top:s},this.size=this._helper?{width:this.helper.width(),height:this.helper.height()}:{width:a.width(),height:a.height()},this.originalSize=this._helper?{width:a.outerWidth(),height:a.outerHeight()}:{width:a.width(),height:a.height()},this.sizeDiff={width:a.outerWidth()-a.width(),height:a.outerHeight()-a.height()},this.originalPosition={left:i,top:s},this.originalMousePosition={left:e.pageX,top:e.pageY},this.aspectRatio="number"==typeof o.aspectRatio?o.aspectRatio:this.originalSize.width/this.originalSize.height||1,n=t(".ui-resizable-"+this.axis).css("cursor"),t("body").css("cursor","auto"===n?this.axis+"-resize":n),this._addClass("ui-resizable-resizing"),this._propagate("start",e),!0},_mouseDrag:function(e){var i,s,n=this.originalMousePosition,o=this.axis,a=e.pageX-n.left||0,r=e.pageY-n.top||0,l=this._change[o];return this._updatePrevProperties(),l?(i=l.apply(this,[e,a,r]),this._updateVirtualBoundaries(e.shiftKey),(this._aspectRatio||e.shiftKey)&&(i=this._updateRatio(i,e)),i=this._respectSize(i,e),this._updateCache(i),this._propagate("resize",e),s=this._applyChanges(),!this._helper&&this._proportionallyResizeElements.length&&this._proportionallyResize(),t.isEmptyObject(s)||(this._updatePrevProperties(),this._trigger("resize",e,this.ui()),this._applyChanges()),!1):!1},_mouseStop:function(e){this.resizing=!1;var i,s,n,o,a,r,l,h=this.options,c=this;return this._helper&&(i=this._proportionallyResizeElements,s=i.length&&/textarea/i.test(i[0].nodeName),n=s&&this._hasScroll(i[0],"left")?0:c.sizeDiff.height,o=s?0:c.sizeDiff.width,a={width:c.helper.width()-o,height:c.helper.height()-n},r=parseFloat(c.element.css("left"))+(c.position.left-c.originalPosition.left)||null,l=parseFloat(c.element.css("top"))+(c.position.top-c.originalPosition.top)||null,h.animate||this.element.css(t.extend(a,{top:l,left:r})),c.helper.height(c.size.height),c.helper.width(c.size.width),this._helper&&!h.animate&&this._proportionallyResize()),t("body").css("cursor","auto"),this._removeClass("ui-resizable-resizing"),this._propagate("stop",e),this._helper&&this.helper.remove(),!1},_updatePrevProperties:function(){this.prevPosition={top:this.position.top,left:this.position.left},this.prevSize={width:this.size.width,height:this.size.height}},_applyChanges:function(){var t={};return this.position.top!==this.prevPosition.top&&(t.top=this.position.top+"px"),this.position.left!==this.prevPosition.left&&(t.left=this.position.left+"px"),this.size.width!==this.prevSize.width&&(t.width=this.size.width+"px"),this.size.height!==this.prevSize.height&&(t.height=this.size.height+"px"),this.helper.css(t),t},_updateVirtualBoundaries:function(t){var e,i,s,n,o,a=this.options;o={minWidth:this._isNumber(a.minWidth)?a.minWidth:0,maxWidth:this._isNumber(a.maxWidth)?a.maxWidth:1/0,minHeight:this._isNumber(a.minHeight)?a.minHeight:0,maxHeight:this._isNumber(a.maxHeight)?a.maxHeight:1/0},(this._aspectRatio||t)&&(e=o.minHeight*this.aspectRatio,s=o.minWidth/this.aspectRatio,i=o.maxHeight*this.aspectRatio,n=o.maxWidth/this.aspectRatio,e>o.minWidth&&(o.minWidth=e),s>o.minHeight&&(o.minHeight=s),o.maxWidth>i&&(o.maxWidth=i),o.maxHeight>n&&(o.maxHeight=n)),this._vBoundaries=o},_updateCache:function(t){this.offset=this.helper.offset(),this._isNumber(t.left)&&(this.position.left=t.left),this._isNumber(t.top)&&(this.position.top=t.top),this._isNumber(t.height)&&(this.size.height=t.height),this._isNumber(t.width)&&(this.size.width=t.width)},_updateRatio:function(t){var e=this.position,i=this.size,s=this.axis;return this._isNumber(t.height)?t.width=t.height*this.aspectRatio:this._isNumber(t.width)&&(t.height=t.width/this.aspectRatio),"sw"===s&&(t.left=e.left+(i.width-t.width),t.top=null),"nw"===s&&(t.top=e.top+(i.height-t.height),t.left=e.left+(i.width-t.width)),t},_respectSize:function(t){var e=this._vBoundaries,i=this.axis,s=this._isNumber(t.width)&&e.maxWidth&&e.maxWidth<t.width,n=this._isNumber(t.height)&&e.maxHeight&&e.maxHeight<t.height,o=this._isNumber(t.width)&&e.minWidth&&e.minWidth>t.width,a=this._isNumber(t.height)&&e.minHeight&&e.minHeight>t.height,r=this.originalPosition.left+this.originalSize.width,l=this.originalPosition.top+this.originalSize.height,h=/sw|nw|w/.test(i),c=/nw|ne|n/.test(i);return o&&(t.width=e.minWidth),a&&(t.height=e.minHeight),s&&(t.width=e.maxWidth),n&&(t.height=e.maxHeight),o&&h&&(t.left=r-e.minWidth),s&&h&&(t.left=r-e.maxWidth),a&&c&&(t.top=l-e.minHeight),n&&c&&(t.top=l-e.maxHeight),t.width||t.height||t.left||!t.top?t.width||t.height||t.top||!t.left||(t.left=null):t.top=null,t},_getPaddingPlusBorderDimensions:function(t){for(var e=0,i=[],s=[t.css("borderTopWidth"),t.css("borderRightWidth"),t.css("borderBottomWidth"),t.css("borderLeftWidth")],n=[t.css("paddingTop"),t.css("paddingRight"),t.css("paddingBottom"),t.css("paddingLeft")];4>e;e++)i[e]=parseFloat(s[e])||0,i[e]+=parseFloat(n[e])||0;return{height:i[0]+i[2],width:i[1]+i[3]}},_proportionallyResize:function(){if (this._proportionallyResizeElements.length)for(var t,e=0,i=this.helper||this.element;this._proportionallyResizeElements.length>e;e++)t=this._proportionallyResizeElements[e],this.outerDimensions||(this.outerDimensions=this._getPaddingPlusBorderDimensions(t)),t.css({height:i.height()-this.outerDimensions.height||0,width:i.width()-this.outerDimensions.width||0})},_renderProxy:function(){var e=this.element,i=this.options;this.elementOffset=e.offset(),this._helper?(this.helper=this.helper||t("<div style='overflow:hidden;'></div>"),this._addClass(this.helper,this._helper),this.helper.css({width:this.element.outerWidth(),height:this.element.outerHeight(),position:"absolute",left:this.elementOffset.left+"px",top:this.elementOffset.top+"px",zIndex:++i.zIndex}),this.helper.appendTo("body").disableSelection()):this.helper=this.element},_change:{e:function(t,e){return{width:this.originalSize.width+e}},w:function(t,e){var i=this.originalSize,s=this.originalPosition;return{left:s.left+e,width:i.width-e}},n:function(t,e,i){var s=this.originalSize,n=this.originalPosition;return{top:n.top+i,height:s.height-i}},s:function(t,e,i){return{height:this.originalSize.height+i}},se:function(e,i,s){return t.extend(this._change.s.apply(this,arguments),this._change.e.apply(this,[e,i,s]))},sw:function(e,i,s){return t.extend(this._change.s.apply(this,arguments),this._change.w.apply(this,[e,i,s]))},ne:function(e,i,s){return t.extend(this._change.n.apply(this,arguments),this._change.e.apply(this,[e,i,s]))},nw:function(e,i,s){return t.extend(this._change.n.apply(this,arguments),this._change.w.apply(this,[e,i,s]))}},_propagate:function(e,i){t.ui.plugin.call(this,e,[i,this.ui()]),"resize"!==e&&this._trigger(e,i,this.ui())},plugins:{},ui:function(){return{originalElement:this.originalElement,element:this.element,helper:this.helper,position:this.position,size:this.size,originalSize:this.originalSize,originalPosition:this.originalPosition}}}),t.ui.plugin.add("resizable","animate",{stop:function(e){var i=t(this).resizable("instance"),s=i.options,n=i._proportionallyResizeElements,o=n.length&&/textarea/i.test(n[0].nodeName),a=o&&i._hasScroll(n[0],"left")?0:i.sizeDiff.height,r=o?0:i.sizeDiff.width,l={width:i.size.width-r,height:i.size.height-a},h=parseFloat(i.element.css("left"))+(i.position.left-i.originalPosition.left)||null,c=parseFloat(i.element.css("top"))+(i.position.top-i.originalPosition.top)||null;i.element.animate(t.extend(l,c&&h?{top:c,left:h}:{}),{duration:s.animateDuration,easing:s.animateEasing,step:function(){var s={width:parseFloat(i.element.css("width")),height:parseFloat(i.element.css("height")),top:parseFloat(i.element.css("top")),left:parseFloat(i.element.css("left"))};n&&n.length&&t(n[0]).css({width:s.width,height:s.height}),i._updateCache(s),i._propagate("resize",e)}})}}),t.ui.plugin.add("resizable","containment",{start:function(){var e,i,s,n,o,a,r,l=t(this).resizable("instance"),h=l.options,c=l.element,u=h.containment,d=u instanceof t?u.get(0):/parent/.test(u)?c.parent().get(0):u;d&&(l.containerElement=t(d),/document/.test(u)||u===document?(l.containerOffset={left:0,top:0},l.containerPosition={left:0,top:0},l.parentData={element:t(document),left:0,top:0,width:t(document).width(),height:t(document).height()||document.body.parentNode.scrollHeight}):(e=t(d),i=[],t(["Top","Right","Left","Bottom"]).each(function(t,s){i[t]=l._num(e.css("padding"+s))}),l.containerOffset=e.offset(),l.containerPosition=e.position(),l.containerSize={height:e.innerHeight()-i[3],width:e.innerWidth()-i[1]},s=l.containerOffset,n=l.containerSize.height,o=l.containerSize.width,a=l._hasScroll(d,"left")?d.scrollWidth:o,r=l._hasScroll(d)?d.scrollHeight:n,l.parentData={element:d,left:s.left,top:s.top,width:a,height:r}))},resize:function(e){var i,s,n,o,a=t(this).resizable("instance"),r=a.options,l=a.containerOffset,h=a.position,c=a._aspectRatio||e.shiftKey,u={top:0,left:0},d=a.containerElement,p=!0;d[0]!==document&&/static/.test(d.css("position"))&&(u=l),h.left<(a._helper?l.left:0)&&(a.size.width=a.size.width+(a._helper?a.position.left-l.left:a.position.left-u.left),c&&(a.size.height=a.size.width/a.aspectRatio,p=!1),a.position.left=r.helper?l.left:0),h.top<(a._helper?l.top:0)&&(a.size.height=a.size.height+(a._helper?a.position.top-l.top:a.position.top),c&&(a.size.width=a.size.height*a.aspectRatio,p=!1),a.position.top=a._helper?l.top:0),n=a.containerElement.get(0)===a.element.parent().get(0),o=/relative|absolute/.test(a.containerElement.css("position")),n&&o?(a.offset.left=a.parentData.left+a.position.left,a.offset.top=a.parentData.top+a.position.top):(a.offset.left=a.element.offset().left,a.offset.top=a.element.offset().top),i=Math.abs(a.sizeDiff.width+(a._helper?a.offset.left-u.left:a.offset.left-l.left)),s=Math.abs(a.sizeDiff.height+(a._helper?a.offset.top-u.top:a.offset.top-l.top)),i+a.size.width>=a.parentData.width&&(a.size.width=a.parentData.width-i,c&&(a.size.height=a.size.width/a.aspectRatio,p=!1)),s+a.size.height>=a.parentData.height&&(a.size.height=a.parentData.height-s,c&&(a.size.width=a.size.height*a.aspectRatio,p=!1)),p||(a.position.left=a.prevPosition.left,a.position.top=a.prevPosition.top,a.size.width=a.prevSize.width,a.size.height=a.prevSize.height)},stop:function(){var e=t(this).resizable("instance"),i=e.options,s=e.containerOffset,n=e.containerPosition,o=e.containerElement,a=t(e.helper),r=a.offset(),l=a.outerWidth()-e.sizeDiff.width,h=a.outerHeight()-e.sizeDiff.height;e._helper&&!i.animate&&/relative/.test(o.css("position"))&&t(this).css({left:r.left-n.left-s.left,width:l,height:h}),e._helper&&!i.animate&&/static/.test(o.css("position"))&&t(this).css({left:r.left-n.left-s.left,width:l,height:h})}}),t.ui.plugin.add("resizable","alsoResize",{start:function(){var e=t(this).resizable("instance"),i=e.options;t(i.alsoResize).each(function(){var e=t(this);e.data("ui-resizable-alsoresize",{width:parseFloat(e.width()),height:parseFloat(e.height()),left:parseFloat(e.css("left")),top:parseFloat(e.css("top"))})})},resize:function(e,i){var s=t(this).resizable("instance"),n=s.options,o=s.originalSize,a=s.originalPosition,r={height:s.size.height-o.height||0,width:s.size.width-o.width||0,top:s.position.top-a.top||0,left:s.position.left-a.left||0};
t(n.alsoResize).each(function(){var e=t(this),s=t(this).data("ui-resizable-alsoresize"),n={},o=e.parents(i.originalElement[0]).length?["width","height"]:["width","height","top","left"];t.each(o,function(t,e){var i=(s[e]||0)+(r[e]||0);i&&i>=0&&(n[e]=i||null)}),e.css(n)})},stop:function(){t(this).removeData("ui-resizable-alsoresize")}}),t.ui.plugin.add("resizable","ghost",{start:function(){var e=t(this).resizable("instance"),i=e.size;e.ghost=e.originalElement.clone(),e.ghost.css({opacity:.25,display:"block",position:"relative",height:i.height,width:i.width,margin:0,left:0,top:0}),e._addClass(e.ghost,"ui-resizable-ghost"),t.uiBackCompat!==!1&&"string"==typeof e.options.ghost&&e.ghost.addClass(this.options.ghost),e.ghost.appendTo(e.helper)},resize:function(){var e=t(this).resizable("instance");e.ghost&&e.ghost.css({position:"relative",height:e.size.height,width:e.size.width})},stop:function(){var e=t(this).resizable("instance");e.ghost&&e.helper&&e.helper.get(0).removeChild(e.ghost.get(0))}}),t.ui.plugin.add("resizable","grid",{resize:function(){var e,i=t(this).resizable("instance"),s=i.options,n=i.size,o=i.originalSize,a=i.originalPosition,r=i.axis,l="number"==typeof s.grid?[s.grid,s.grid]:s.grid,h=l[0]||1,c=l[1]||1,u=Math.round((n.width-o.width)/h)*h,d=Math.round((n.height-o.height)/c)*c,p=o.width+u,f=o.height+d,g=s.maxWidth&&p>s.maxWidth,m=s.maxHeight&&f>s.maxHeight,_=s.minWidth&&s.minWidth>p,v=s.minHeight&&s.minHeight>f;s.grid=l,_&&(p+=h),v&&(f+=c),g&&(p-=h),m&&(f-=c),/^(se|s|e)$/.test(r)?(i.size.width=p,i.size.height=f):/^(ne)$/.test(r)?(i.size.width=p,i.size.height=f,i.position.top=a.top-d):/^(sw)$/.test(r)?(i.size.width=p,i.size.height=f,i.position.left=a.left-u):((0>=f-c||0>=p-h)&&(e=i._getPaddingPlusBorderDimensions(this)),f-c>0?(i.size.height=f,i.position.top=a.top-d):(f=c-e.height,i.size.height=f,i.position.top=a.top+o.height-f),p-h>0?(i.size.width=p,i.position.left=a.left-u):(p=h-e.width,i.size.width=p,i.position.left=a.left+o.width-p))}}),t.ui.resizable,t.widget("ui.selectable",t.ui.mouse,{version:"1.12.1",options:{appendTo:"body",autoRefresh:!0,distance:0,filter:"*",tolerance:"touch",selected:null,selecting:null,start:null,stop:null,unselected:null,unselecting:null},_create:function(){var e=this;this._addClass("ui-selectable"),this.dragged=!1,this.refresh=function(){e.elementPos=t(e.element[0]).offset(),e.selectees=t(e.options.filter,e.element[0]),e._addClass(e.selectees,"ui-selectee"),e.selectees.each(function(){var i=t(this),s=i.offset(),n={left:s.left-e.elementPos.left,top:s.top-e.elementPos.top};t.data(this,"selectable-item",{element:this,$element:i,left:n.left,top:n.top,right:n.left+i.outerWidth(),bottom:n.top+i.outerHeight(),startselected:!1,selected:i.hasClass("ui-selected"),selecting:i.hasClass("ui-selecting"),unselecting:i.hasClass("ui-unselecting")})})},this.refresh(),this._mouseInit(),this.helper=t("<div>"),this._addClass(this.helper,"ui-selectable-helper")},_destroy:function(){this.selectees.removeData("selectable-item"),this._mouseDestroy()},_mouseStart:function(e){var i=this,s=this.options;this.opos=[e.pageX,e.pageY],this.elementPos=t(this.element[0]).offset(),this.options.disabled||(this.selectees=t(s.filter,this.element[0]),this._trigger("start",e),t(s.appendTo).append(this.helper),this.helper.css({left:e.pageX,top:e.pageY,width:0,height:0}),s.autoRefresh&&this.refresh(),this.selectees.filter(".ui-selected").each(function(){var s=t.data(this,"selectable-item");s.startselected=!0,e.metaKey||e.ctrlKey||(i._removeClass(s.$element,"ui-selected"),s.selected=!1,i._addClass(s.$element,"ui-unselecting"),s.unselecting=!0,i._trigger("unselecting",e,{unselecting:s.element}))}),t(e.target).parents().addBack().each(function(){var s,n=t.data(this,"selectable-item");return n?(s=!e.metaKey&&!e.ctrlKey||!n.$element.hasClass("ui-selected"),i._removeClass(n.$element,s?"ui-unselecting":"ui-selected")._addClass(n.$element,s?"ui-selecting":"ui-unselecting"),n.unselecting=!s,n.selecting=s,n.selected=s,s?i._trigger("selecting",e,{selecting:n.element}):i._trigger("unselecting",e,{unselecting:n.element}),!1):void 0}))},_mouseDrag:function(e){if (this.dragged=!0,!this.options.disabled){var i,s=this,n=this.options,o=this.opos[0],a=this.opos[1],r=e.pageX,l=e.pageY;return o>r&&(i=r,r=o,o=i),a>l&&(i=l,l=a,a=i),this.helper.css({left:o,top:a,width:r-o,height:l-a}),this.selectees.each(function(){var i=t.data(this,"selectable-item"),h=!1,c={};i&&i.element!==s.element[0]&&(c.left=i.left+s.elementPos.left,c.right=i.right+s.elementPos.left,c.top=i.top+s.elementPos.top,c.bottom=i.bottom+s.elementPos.top,"touch"===n.tolerance?h=!(c.left>r||o>c.right||c.top>l||a>c.bottom):"fit"===n.tolerance&&(h=c.left>o&&r>c.right&&c.top>a&&l>c.bottom),h?(i.selected&&(s._removeClass(i.$element,"ui-selected"),i.selected=!1),i.unselecting&&(s._removeClass(i.$element,"ui-unselecting"),i.unselecting=!1),i.selecting||(s._addClass(i.$element,"ui-selecting"),i.selecting=!0,s._trigger("selecting",e,{selecting:i.element}))):(i.selecting&&((e.metaKey||e.ctrlKey)&&i.startselected?(s._removeClass(i.$element,"ui-selecting"),i.selecting=!1,s._addClass(i.$element,"ui-selected"),i.selected=!0):(s._removeClass(i.$element,"ui-selecting"),i.selecting=!1,i.startselected&&(s._addClass(i.$element,"ui-unselecting"),i.unselecting=!0),s._trigger("unselecting",e,{unselecting:i.element}))),i.selected&&(e.metaKey||e.ctrlKey||i.startselected||(s._removeClass(i.$element,"ui-selected"),i.selected=!1,s._addClass(i.$element,"ui-unselecting"),i.unselecting=!0,s._trigger("unselecting",e,{unselecting:i.element})))))}),!1}},_mouseStop:function(e){var i=this;return this.dragged=!1,t(".ui-unselecting",this.element[0]).each(function(){var s=t.data(this,"selectable-item");i._removeClass(s.$element,"ui-unselecting"),s.unselecting=!1,s.startselected=!1,i._trigger("unselected",e,{unselected:s.element})}),t(".ui-selecting",this.element[0]).each(function(){var s=t.data(this,"selectable-item");i._removeClass(s.$element,"ui-selecting")._addClass(s.$element,"ui-selected"),s.selecting=!1,s.selected=!0,s.startselected=!0,i._trigger("selected",e,{selected:s.element})}),this._trigger("stop",e),this.helper.remove(),!1}}),t.widget("ui.sortable",t.ui.mouse,{version:"1.12.1",widgetEventPrefix:"sort",ready:!1,options:{appendTo:"parent",axis:!1,connectWith:!1,containment:!1,cursor:"auto",cursorAt:!1,dropOnEmpty:!0,forcePlaceholderSize:!1,forceHelperSize:!1,grid:!1,handle:!1,helper:"original",items:"> *",opacity:!1,placeholder:!1,revert:!1,scroll:!0,scrollSensitivity:20,scrollSpeed:20,scope:"default",tolerance:"intersect",zIndex:1e3,activate:null,beforeStop:null,change:null,deactivate:null,out:null,over:null,receive:null,remove:null,sort:null,start:null,stop:null,update:null},_isOverAxis:function(t,e,i){return t>=e&&e+i>t},_isFloating:function(t){return/left|right/.test(t.css("float"))||/inline|table-cell/.test(t.css("display"))},_create:function(){this.containerCache={},this._addClass("ui-sortable"),this.refresh(),this.offset=this.element.offset(),this._mouseInit(),this._setHandleClassName(),this.ready=!0},_setOption:function(t,e){this._super(t,e),"handle"===t&&this._setHandleClassName()},_setHandleClassName:function(){var e=this;this._removeClass(this.element.find(".ui-sortable-handle"),"ui-sortable-handle"),t.each(this.items,function(){e._addClass(this.instance.options.handle?this.item.find(this.instance.options.handle):this.item,"ui-sortable-handle")})},_destroy:function(){this._mouseDestroy();for(var t=this.items.length-1;t>=0;t--)this.items[t].item.removeData(this.widgetName+"-item");return this},_mouseCapture:function(e,i){var s=null,n=!1,o=this;return this.reverting?!1:this.options.disabled||"static"===this.options.type?!1:(this._refreshItems(e),t(e.target).parents().each(function(){return t.data(this,o.widgetName+"-item")===o?(s=t(this),!1):void 0}),t.data(e.target,o.widgetName+"-item")===o&&(s=t(e.target)),s?!this.options.handle||i||(t(this.options.handle,s).find("*").addBack().each(function(){this===e.target&&(n=!0)}),n)?(this.currentItem=s,this._removeCurrentsFromItems(),!0):!1:!1)},_mouseStart:function(e,i,s){var n,o,a=this.options;if (this.currentContainer=this,this.refreshPositions(),this.helper=this._createHelper(e),this._cacheHelperProportions(),this._cacheMargins(),this.scrollParent=this.helper.scrollParent(),this.offset=this.currentItem.offset(),this.offset={top:this.offset.top-this.margins.top,left:this.offset.left-this.margins.left},t.extend(this.offset,{click:{left:e.pageX-this.offset.left,top:e.pageY-this.offset.top},parent:this._getParentOffset(),relative:this._getRelativeOffset()}),this.helper.css("position","absolute"),this.cssPosition=this.helper.css("position"),this.originalPosition=this._generatePosition(e),this.originalPageX=e.pageX,this.originalPageY=e.pageY,a.cursorAt&&this._adjustOffsetFromHelper(a.cursorAt),this.domPosition={prev:this.currentItem.prev()[0],parent:this.currentItem.parent()[0]},this.helper[0]!==this.currentItem[0]&&this.currentItem.hide(),this._createPlaceholder(),a.containment&&this._setContainment(),a.cursor&&"auto"!==a.cursor&&(o=this.document.find("body"),this.storedCursor=o.css("cursor"),o.css("cursor",a.cursor),this.storedStylesheet=t("<style>*{ cursor: "+a.cursor+" !important; }</style>").appendTo(o)),a.opacity&&(this.helper.css("opacity")&&(this._storedOpacity=this.helper.css("opacity")),this.helper.css("opacity",a.opacity)),a.zIndex&&(this.helper.css("zIndex")&&(this._storedZIndex=this.helper.css("zIndex")),this.helper.css("zIndex",a.zIndex)),this.scrollParent[0]!==this.document[0]&&"HTML"!==this.scrollParent[0].tagName&&(this.overflowOffset=this.scrollParent.offset()),this._trigger("start",e,this._uiHash()),this._preserveHelperProportions||this._cacheHelperProportions(),!s)for(n=this.containers.length-1;n>=0;n--)this.containers[n]._trigger("activate",e,this._uiHash(this));return t.ui.ddmanager&&(t.ui.ddmanager.current=this),t.ui.ddmanager&&!a.dropBehaviour&&t.ui.ddmanager.prepareOffsets(this,e),this.dragging=!0,this._addClass(this.helper,"ui-sortable-helper"),this._mouseDrag(e),!0},_mouseDrag:function(e){var i,s,n,o,a=this.options,r=!1;for(this.position=this._generatePosition(e),this.positionAbs=this._convertPositionTo("absolute"),this.lastPositionAbs||(this.lastPositionAbs=this.positionAbs),this.options.scroll&&(this.scrollParent[0]!==this.document[0]&&"HTML"!==this.scrollParent[0].tagName?(this.overflowOffset.top+this.scrollParent[0].offsetHeight-e.pageY<a.scrollSensitivity?this.scrollParent[0].scrollTop=r=this.scrollParent[0].scrollTop+a.scrollSpeed:e.pageY-this.overflowOffset.top<a.scrollSensitivity&&(this.scrollParent[0].scrollTop=r=this.scrollParent[0].scrollTop-a.scrollSpeed),this.overflowOffset.left+this.scrollParent[0].offsetWidth-e.pageX<a.scrollSensitivity?this.scrollParent[0].scrollLeft=r=this.scrollParent[0].scrollLeft+a.scrollSpeed:e.pageX-this.overflowOffset.left<a.scrollSensitivity&&(this.scrollParent[0].scrollLeft=r=this.scrollParent[0].scrollLeft-a.scrollSpeed)):(e.pageY-this.document.scrollTop()<a.scrollSensitivity?r=this.document.scrollTop(this.document.scrollTop()-a.scrollSpeed):this.window.height()-(e.pageY-this.document.scrollTop())<a.scrollSensitivity&&(r=this.document.scrollTop(this.document.scrollTop()+a.scrollSpeed)),e.pageX-this.document.scrollLeft()<a.scrollSensitivity?r=this.document.scrollLeft(this.document.scrollLeft()-a.scrollSpeed):this.window.width()-(e.pageX-this.document.scrollLeft())<a.scrollSensitivity&&(r=this.document.scrollLeft(this.document.scrollLeft()+a.scrollSpeed))),r!==!1&&t.ui.ddmanager&&!a.dropBehaviour&&t.ui.ddmanager.prepareOffsets(this,e)),this.positionAbs=this._convertPositionTo("absolute"),this.options.axis&&"y"===this.options.axis||(this.helper[0].style.left=this.position.left+"px"),this.options.axis&&"x"===this.options.axis||(this.helper[0].style.top=this.position.top+"px"),i=this.items.length-1;i>=0;i--)if (s=this.items[i],n=s.item[0],o=this._intersectsWithPointer(s),o&&s.instance===this.currentContainer&&n!==this.currentItem[0]&&this.placeholder[1===o?"next":"prev"]()[0]!==n&&!t.contains(this.placeholder[0],n)&&("semi-dynamic"===this.options.type?!t.contains(this.element[0],n):!0)){if (this.direction=1===o?"down":"up","pointer"!==this.options.tolerance&&!this._intersectsWithSides(s))break;this._rearrange(e,s),this._trigger("change",e,this._uiHash());break}return this._contactContainers(e),t.ui.ddmanager&&t.ui.ddmanager.drag(this,e),this._trigger("sort",e,this._uiHash()),this.lastPositionAbs=this.positionAbs,!1},_mouseStop:function(e,i){if (e){if (t.ui.ddmanager&&!this.options.dropBehaviour&&t.ui.ddmanager.drop(this,e),this.options.revert){var s=this,n=this.placeholder.offset(),o=this.options.axis,a={};o&&"x"!==o||(a.left=n.left-this.offset.parent.left-this.margins.left+(this.offsetParent[0]===this.document[0].body?0:this.offsetParent[0].scrollLeft)),o&&"y"!==o||(a.top=n.top-this.offset.parent.top-this.margins.top+(this.offsetParent[0]===this.document[0].body?0:this.offsetParent[0].scrollTop)),this.reverting=!0,t(this.helper).animate(a,parseInt(this.options.revert,10)||500,function(){s._clear(e)})}else this._clear(e,i);return!1}},cancel:function(){if (this.dragging){this._mouseUp(new t.Event("mouseup",{target:null})),"original"===this.options.helper?(this.currentItem.css(this._storedCSS),this._removeClass(this.currentItem,"ui-sortable-helper")):this.currentItem.show();for(var e=this.containers.length-1;e>=0;e--)this.containers[e]._trigger("deactivate",null,this._uiHash(this)),this.containers[e].containerCache.over&&(this.containers[e]._trigger("out",null,this._uiHash(this)),this.containers[e].containerCache.over=0)}return this.placeholder&&(this.placeholder[0].parentNode&&this.placeholder[0].parentNode.removeChild(this.placeholder[0]),"original"!==this.options.helper&&this.helper&&this.helper[0].parentNode&&this.helper.remove(),t.extend(this,{helper:null,dragging:!1,reverting:!1,_noFinalSort:null}),this.domPosition.prev?t(this.domPosition.prev).after(this.currentItem):t(this.domPosition.parent).prepend(this.currentItem)),this},serialize:function(e){var i=this._getItemsAsjQuery(e&&e.connected),s=[];return e=e||{},t(i).each(function(){var i=(t(e.item||this).attr(e.attribute||"id")||"").match(e.expression||/(.+)[\-=_](.+)/);i&&s.push((e.key||i[1]+"[]")+"="+(e.key&&e.expression?i[1]:i[2]))}),!s.length&&e.key&&s.push(e.key+"="),s.join("&")},toArray:function(e){var i=this._getItemsAsjQuery(e&&e.connected),s=[];return e=e||{},i.each(function(){s.push(t(e.item||this).attr(e.attribute||"id")||"")}),s},_intersectsWith:function(t){var e=this.positionAbs.left,i=e+this.helperProportions.width,s=this.positionAbs.top,n=s+this.helperProportions.height,o=t.left,a=o+t.width,r=t.top,l=r+t.height,h=this.offset.click.top,c=this.offset.click.left,u="x"===this.options.axis||s+h>r&&l>s+h,d="y"===this.options.axis||e+c>o&&a>e+c,p=u&&d;return"pointer"===this.options.tolerance||this.options.forcePointerForContainers||"pointer"!==this.options.tolerance&&this.helperProportions[this.floating?"width":"height"]>t[this.floating?"width":"height"]?p:e+this.helperProportions.width/2>o&&a>i-this.helperProportions.width/2&&s+this.helperProportions.height/2>r&&l>n-this.helperProportions.height/2},_intersectsWithPointer:function(t){var e,i,s="x"===this.options.axis||this._isOverAxis(this.positionAbs.top+this.offset.click.top,t.top,t.height),n="y"===this.options.axis||this._isOverAxis(this.positionAbs.left+this.offset.click.left,t.left,t.width),o=s&&n;return o?(e=this._getDragVerticalDirection(),i=this._getDragHorizontalDirection(),this.floating?"right"===i||"down"===e?2:1:e&&("down"===e?2:1)):!1},_intersectsWithSides:function(t){var e=this._isOverAxis(this.positionAbs.top+this.offset.click.top,t.top+t.height/2,t.height),i=this._isOverAxis(this.positionAbs.left+this.offset.click.left,t.left+t.width/2,t.width),s=this._getDragVerticalDirection(),n=this._getDragHorizontalDirection();return this.floating&&n?"right"===n&&i||"left"===n&&!i:s&&("down"===s&&e||"up"===s&&!e)},_getDragVerticalDirection:function(){var t=this.positionAbs.top-this.lastPositionAbs.top;return 0!==t&&(t>0?"down":"up")},_getDragHorizontalDirection:function(){var t=this.positionAbs.left-this.lastPositionAbs.left;return 0!==t&&(t>0?"right":"left")},refresh:function(t){return this._refreshItems(t),this._setHandleClassName(),this.refreshPositions(),this},_connectWith:function(){var t=this.options;return t.connectWith.constructor===String?[t.connectWith]:t.connectWith},_getItemsAsjQuery:function(e){function i(){r.push(this)}var s,n,o,a,r=[],l=[],h=this._connectWith();if (h&&e)for(s=h.length-1;s>=0;s--)for(o=t(h[s],this.document[0]),n=o.length-1;n>=0;n--)a=t.data(o[n],this.widgetFullName),a&&a!==this&&!a.options.disabled&&l.push([t.isFunction(a.options.items)?a.options.items.call(a.element):t(a.options.items,a.element).not(".ui-sortable-helper").not(".ui-sortable-placeholder"),a]);for(l.push([t.isFunction(this.options.items)?this.options.items.call(this.element,null,{options:this.options,item:this.currentItem}):t(this.options.items,this.element).not(".ui-sortable-helper").not(".ui-sortable-placeholder"),this]),s=l.length-1;s>=0;s--)l[s][0].each(i);return t(r)},_removeCurrentsFromItems:function(){var e=this.currentItem.find(":data("+this.widgetName+"-item)");this.items=t.grep(this.items,function(t){for(var i=0;e.length>i;i++)if (e[i]===t.item[0])return!1;return!0})},_refreshItems:function(e){this.items=[],this.containers=[this];var i,s,n,o,a,r,l,h,c=this.items,u=[[t.isFunction(this.options.items)?this.options.items.call(this.element[0],e,{item:this.currentItem}):t(this.options.items,this.element),this]],d=this._connectWith();if (d&&this.ready)for(i=d.length-1;i>=0;i--)for(n=t(d[i],this.document[0]),s=n.length-1;s>=0;s--)o=t.data(n[s],this.widgetFullName),o&&o!==this&&!o.options.disabled&&(u.push([t.isFunction(o.options.items)?o.options.items.call(o.element[0],e,{item:this.currentItem}):t(o.options.items,o.element),o]),this.containers.push(o));for(i=u.length-1;i>=0;i--)for(a=u[i][1],r=u[i][0],s=0,h=r.length;h>s;s++)l=t(r[s]),l.data(this.widgetName+"-item",a),c.push({item:l,instance:a,width:0,height:0,left:0,top:0})},refreshPositions:function(e){this.floating=this.items.length?"x"===this.options.axis||this._isFloating(this.items[0].item):!1,this.offsetParent&&this.helper&&(this.offset.parent=this._getParentOffset());var i,s,n,o;for(i=this.items.length-1;i>=0;i--)s=this.items[i],s.instance!==this.currentContainer&&this.currentContainer&&s.item[0]!==this.currentItem[0]||(n=this.options.toleranceElement?t(this.options.toleranceElement,s.item):s.item,e||(s.width=n.outerWidth(),s.height=n.outerHeight()),o=n.offset(),s.left=o.left,s.top=o.top);if (this.options.custom&&this.options.custom.refreshContainers)this.options.custom.refreshContainers.call(this);else for(i=this.containers.length-1;i>=0;i--)o=this.containers[i].element.offset(),this.containers[i].containerCache.left=o.left,this.containers[i].containerCache.top=o.top,this.containers[i].containerCache.width=this.containers[i].element.outerWidth(),this.containers[i].containerCache.height=this.containers[i].element.outerHeight();return this},_createPlaceholder:function(e){e=e||this;var i,s=e.options;s.placeholder&&s.placeholder.constructor!==String||(i=s.placeholder,s.placeholder={element:function(){var s=e.currentItem[0].nodeName.toLowerCase(),n=t("<"+s+">",e.document[0]);return e._addClass(n,"ui-sortable-placeholder",i||e.currentItem[0].className)._removeClass(n,"ui-sortable-helper"),"tbody"===s?e._createTrPlaceholder(e.currentItem.find("tr").eq(0),t("<tr>",e.document[0]).appendTo(n)):"tr"===s?e._createTrPlaceholder(e.currentItem,n):"img"===s&&n.attr("src",e.currentItem.attr("src")),i||n.css("visibility","hidden"),n},update:function(t,n){(!i||s.forcePlaceholderSize)&&(n.height()||n.height(e.currentItem.innerHeight()-parseInt(e.currentItem.css("paddingTop")||0,10)-parseInt(e.currentItem.css("paddingBottom")||0,10)),n.width()||n.width(e.currentItem.innerWidth()-parseInt(e.currentItem.css("paddingLeft")||0,10)-parseInt(e.currentItem.css("paddingRight")||0,10)))}}),e.placeholder=t(s.placeholder.element.call(e.element,e.currentItem)),e.currentItem.after(e.placeholder),s.placeholder.update(e,e.placeholder)},_createTrPlaceholder:function(e,i){var s=this;e.children().each(function(){t("<td>&#160;</td>",s.document[0]).attr("colspan",t(this).attr("colspan")||1).appendTo(i)})},_contactContainers:function(e){var i,s,n,o,a,r,l,h,c,u,d=null,p=null;for(i=this.containers.length-1;i>=0;i--)if (!t.contains(this.currentItem[0],this.containers[i].element[0]))if (this._intersectsWith(this.containers[i].containerCache)){if (d&&t.contains(this.containers[i].element[0],d.element[0]))continue;d=this.containers[i],p=i}else this.containers[i].containerCache.over&&(this.containers[i]._trigger("out",e,this._uiHash(this)),this.containers[i].containerCache.over=0);if (d)if (1===this.containers.length)this.containers[p].containerCache.over||(this.containers[p]._trigger("over",e,this._uiHash(this)),this.containers[p].containerCache.over=1);else{for(n=1e4,o=null,c=d.floating||this._isFloating(this.currentItem),a=c?"left":"top",r=c?"width":"height",u=c?"pageX":"pageY",s=this.items.length-1;s>=0;s--)t.contains(this.containers[p].element[0],this.items[s].item[0])&&this.items[s].item[0]!==this.currentItem[0]&&(l=this.items[s].item.offset()[a],h=!1,e[u]-l>this.items[s][r]/2&&(h=!0),n>Math.abs(e[u]-l)&&(n=Math.abs(e[u]-l),o=this.items[s],this.direction=h?"up":"down"));if (!o&&!this.options.dropOnEmpty)return;if (this.currentContainer===this.containers[p])return this.currentContainer.containerCache.over||(this.containers[p]._trigger("over",e,this._uiHash()),this.currentContainer.containerCache.over=1),void 0;o?this._rearrange(e,o,null,!0):this._rearrange(e,null,this.containers[p].element,!0),this._trigger("change",e,this._uiHash()),this.containers[p]._trigger("change",e,this._uiHash(this)),this.currentContainer=this.containers[p],this.options.placeholder.update(this.currentContainer,this.placeholder),this.containers[p]._trigger("over",e,this._uiHash(this)),this.containers[p].containerCache.over=1}},_createHelper:function(e){var i=this.options,s=t.isFunction(i.helper)?t(i.helper.apply(this.element[0],[e,this.currentItem])):"clone"===i.helper?this.currentItem.clone():this.currentItem;return s.parents("body").length||t("parent"!==i.appendTo?i.appendTo:this.currentItem[0].parentNode)[0].appendChild(s[0]),s[0]===this.currentItem[0]&&(this._storedCSS={width:this.currentItem[0].style.width,height:this.currentItem[0].style.height,position:this.currentItem.css("position"),top:this.currentItem.css("top"),left:this.currentItem.css("left")}),(!s[0].style.width||i.forceHelperSize)&&s.width(this.currentItem.width()),(!s[0].style.height||i.forceHelperSize)&&s.height(this.currentItem.height()),s},_adjustOffsetFromHelper:function(e){"string"==typeof e&&(e=e.split(" ")),t.isArray(e)&&(e={left:+e[0],top:+e[1]||0}),"left"in e&&(this.offset.click.left=e.left+this.margins.left),"right"in e&&(this.offset.click.left=this.helperProportions.width-e.right+this.margins.left),"top"in e&&(this.offset.click.top=e.top+this.margins.top),"bottom"in e&&(this.offset.click.top=this.helperProportions.height-e.bottom+this.margins.top)},_getParentOffset:function(){this.offsetParent=this.helper.offsetParent();var e=this.offsetParent.offset();return"absolute"===this.cssPosition&&this.scrollParent[0]!==this.document[0]&&t.contains(this.scrollParent[0],this.offsetParent[0])&&(e.left+=this.scrollParent.scrollLeft(),e.top+=this.scrollParent.scrollTop()),(this.offsetParent[0]===this.document[0].body||this.offsetParent[0].tagName&&"html"===this.offsetParent[0].tagName.toLowerCase()&&t.ui.ie)&&(e={top:0,left:0}),{top:e.top+(parseInt(this.offsetParent.css("borderTopWidth"),10)||0),left:e.left+(parseInt(this.offsetParent.css("borderLeftWidth"),10)||0)}},_getRelativeOffset:function(){if ("relative"===this.cssPosition){var t=this.currentItem.position();return{top:t.top-(parseInt(this.helper.css("top"),10)||0)+this.scrollParent.scrollTop(),left:t.left-(parseInt(this.helper.css("left"),10)||0)+this.scrollParent.scrollLeft()}}return{top:0,left:0}},_cacheMargins:function(){this.margins={left:parseInt(this.currentItem.css("marginLeft"),10)||0,top:parseInt(this.currentItem.css("marginTop"),10)||0}},_cacheHelperProportions:function(){this.helperProportions={width:this.helper.outerWidth(),height:this.helper.outerHeight()}},_setContainment:function(){var e,i,s,n=this.options;"parent"===n.containment&&(n.containment=this.helper[0].parentNode),("document"===n.containment||"window"===n.containment)&&(this.containment=[0-this.offset.relative.left-this.offset.parent.left,0-this.offset.relative.top-this.offset.parent.top,"document"===n.containment?this.document.width():this.window.width()-this.helperProportions.width-this.margins.left,("document"===n.containment?this.document.height()||document.body.parentNode.scrollHeight:this.window.height()||this.document[0].body.parentNode.scrollHeight)-this.helperProportions.height-this.margins.top]),/^(document|window|parent)$/.test(n.containment)||(e=t(n.containment)[0],i=t(n.containment).offset(),s="hidden"!==t(e).css("overflow"),this.containment=[i.left+(parseInt(t(e).css("borderLeftWidth"),10)||0)+(parseInt(t(e).css("paddingLeft"),10)||0)-this.margins.left,i.top+(parseInt(t(e).css("borderTopWidth"),10)||0)+(parseInt(t(e).css("paddingTop"),10)||0)-this.margins.top,i.left+(s?Math.max(e.scrollWidth,e.offsetWidth):e.offsetWidth)-(parseInt(t(e).css("borderLeftWidth"),10)||0)-(parseInt(t(e).css("paddingRight"),10)||0)-this.helperProportions.width-this.margins.left,i.top+(s?Math.max(e.scrollHeight,e.offsetHeight):e.offsetHeight)-(parseInt(t(e).css("borderTopWidth"),10)||0)-(parseInt(t(e).css("paddingBottom"),10)||0)-this.helperProportions.height-this.margins.top])},_convertPositionTo:function(e,i){i||(i=this.position);var s="absolute"===e?1:-1,n="absolute"!==this.cssPosition||this.scrollParent[0]!==this.document[0]&&t.contains(this.scrollParent[0],this.offsetParent[0])?this.scrollParent:this.offsetParent,o=/(html|body)/i.test(n[0].tagName);return{top:i.top+this.offset.relative.top*s+this.offset.parent.top*s-("fixed"===this.cssPosition?-this.scrollParent.scrollTop():o?0:n.scrollTop())*s,left:i.left+this.offset.relative.left*s+this.offset.parent.left*s-("fixed"===this.cssPosition?-this.scrollParent.scrollLeft():o?0:n.scrollLeft())*s}},_generatePosition:function(e){var i,s,n=this.options,o=e.pageX,a=e.pageY,r="absolute"!==this.cssPosition||this.scrollParent[0]!==this.document[0]&&t.contains(this.scrollParent[0],this.offsetParent[0])?this.scrollParent:this.offsetParent,l=/(html|body)/i.test(r[0].tagName);return"relative"!==this.cssPosition||this.scrollParent[0]!==this.document[0]&&this.scrollParent[0]!==this.offsetParent[0]||(this.offset.relative=this._getRelativeOffset()),this.originalPosition&&(this.containment&&(e.pageX-this.offset.click.left<this.containment[0]&&(o=this.containment[0]+this.offset.click.left),e.pageY-this.offset.click.top<this.containment[1]&&(a=this.containment[1]+this.offset.click.top),e.pageX-this.offset.click.left>this.containment[2]&&(o=this.containment[2]+this.offset.click.left),e.pageY-this.offset.click.top>this.containment[3]&&(a=this.containment[3]+this.offset.click.top)),n.grid&&(i=this.originalPageY+Math.round((a-this.originalPageY)/n.grid[1])*n.grid[1],a=this.containment?i-this.offset.click.top>=this.containment[1]&&i-this.offset.click.top<=this.containment[3]?i:i-this.offset.click.top>=this.containment[1]?i-n.grid[1]:i+n.grid[1]:i,s=this.originalPageX+Math.round((o-this.originalPageX)/n.grid[0])*n.grid[0],o=this.containment?s-this.offset.click.left>=this.containment[0]&&s-this.offset.click.left<=this.containment[2]?s:s-this.offset.click.left>=this.containment[0]?s-n.grid[0]:s+n.grid[0]:s)),{top:a-this.offset.click.top-this.offset.relative.top-this.offset.parent.top+("fixed"===this.cssPosition?-this.scrollParent.scrollTop():l?0:r.scrollTop()),left:o-this.offset.click.left-this.offset.relative.left-this.offset.parent.left+("fixed"===this.cssPosition?-this.scrollParent.scrollLeft():l?0:r.scrollLeft())}},_rearrange:function(t,e,i,s){i?i[0].appendChild(this.placeholder[0]):e.item[0].parentNode.insertBefore(this.placeholder[0],"down"===this.direction?e.item[0]:e.item[0].nextSibling),this.counter=this.counter?++this.counter:1;var n=this.counter;this._delay(function(){n===this.counter&&this.refreshPositions(!s)})},_clear:function(t,e){function i(t,e,i){return function(s){i._trigger(t,s,e._uiHash(e))}}this.reverting=!1;var s,n=[];if (!this._noFinalSort&&this.currentItem.parent().length&&this.placeholder.before(this.currentItem),this._noFinalSort=null,this.helper[0]===this.currentItem[0]){for(s in this._storedCSS)("auto"===this._storedCSS[s]||"static"===this._storedCSS[s])&&(this._storedCSS[s]="");this.currentItem.css(this._storedCSS),this._removeClass(this.currentItem,"ui-sortable-helper")}else this.currentItem.show();for(this.fromOutside&&!e&&n.push(function(t){this._trigger("receive",t,this._uiHash(this.fromOutside))}),!this.fromOutside&&this.domPosition.prev===this.currentItem.prev().not(".ui-sortable-helper")[0]&&this.domPosition.parent===this.currentItem.parent()[0]||e||n.push(function(t){this._trigger("update",t,this._uiHash())}),this!==this.currentContainer&&(e||(n.push(function(t){this._trigger("remove",t,this._uiHash())}),n.push(function(t){return function(e){t._trigger("receive",e,this._uiHash(this))}}.call(this,this.currentContainer)),n.push(function(t){return function(e){t._trigger("update",e,this._uiHash(this))}}.call(this,this.currentContainer)))),s=this.containers.length-1;s>=0;s--)e||n.push(i("deactivate",this,this.containers[s])),this.containers[s].containerCache.over&&(n.push(i("out",this,this.containers[s])),this.containers[s].containerCache.over=0);if (this.storedCursor&&(this.document.find("body").css("cursor",this.storedCursor),this.storedStylesheet.remove()),this._storedOpacity&&this.helper.css("opacity",this._storedOpacity),this._storedZIndex&&this.helper.css("zIndex","auto"===this._storedZIndex?"":this._storedZIndex),this.dragging=!1,e||this._trigger("beforeStop",t,this._uiHash()),this.placeholder[0].parentNode.removeChild(this.placeholder[0]),this.cancelHelperRemoval||(this.helper[0]!==this.currentItem[0]&&this.helper.remove(),this.helper=null),!e){for(s=0;n.length>s;s++)n[s].call(this,t);this._trigger("stop",t,this._uiHash())}return this.fromOutside=!1,!this.cancelHelperRemoval},_trigger:function(){t.Widget.prototype._trigger.apply(this,arguments)===!1&&this.cancel()},_uiHash:function(e){var i=e||this;return{helper:i.helper,placeholder:i.placeholder||t([]),position:i.position,originalPosition:i.originalPosition,offset:i.positionAbs,item:i.currentItem,sender:e?e.element:null}}}),t.widget("ui.menu",{version:"1.12.1",defaultElement:"<ul>",delay:300,options:{icons:{submenu:"ui-icon-caret-1-e"},items:"> *",menus:"ul",position:{my:"left top",at:"right top"},role:"menu",blur:null,focus:null,select:null},_create:function(){this.activeMenu=this.element,this.mouseHandled=!1,this.element.uniqueId().attr({role:this.options.role,tabIndex:0}),this._addClass("ui-menu","ui-widget ui-widget-content"),this._on({"mousedown .ui-menu-item":function(t){t.preventDefault()},"click .ui-menu-item":function(e){var i=t(e.target),s=t(t.ui.safeActiveElement(this.document[0]));!this.mouseHandled&&i.not(".ui-state-disabled").length&&(this.select(e),e.isPropagationStopped()||(this.mouseHandled=!0),i.has(".ui-menu").length?this.expand(e):!this.element.is(":focus")&&s.closest(".ui-menu").length&&(this.element.trigger("focus",[!0]),this.active&&1===this.active.parents(".ui-menu").length&&clearTimeout(this.timer)))},"mouseenter .ui-menu-item":function(e){if (!this.previousFilter){var i=t(e.target).closest(".ui-menu-item"),s=t(e.currentTarget);i[0]===s[0]&&(this._removeClass(s.siblings().children(".ui-state-active"),null,"ui-state-active"),this.focus(e,s))}},mouseleave:"collapseAll","mouseleave .ui-menu":"collapseAll",focus:function(t,e){var i=this.active||this.element.find(this.options.items).eq(0);
e||this.focus(t,i)},blur:function(e){this._delay(function(){var i=!t.contains(this.element[0],t.ui.safeActiveElement(this.document[0]));i&&this.collapseAll(e)})},keydown:"_keydown"}),this.refresh(),this._on(this.document,{click:function(t){this._closeOnDocumentClick(t)&&this.collapseAll(t),this.mouseHandled=!1}})},_destroy:function(){var e=this.element.find(".ui-menu-item").removeAttr("role aria-disabled"),i=e.children(".ui-menu-item-wrapper").removeUniqueId().removeAttr("tabIndex role aria-haspopup");this.element.removeAttr("aria-activedescendant").find(".ui-menu").addBack().removeAttr("role aria-labelledby aria-expanded aria-hidden aria-disabled tabIndex").removeUniqueId().show(),i.children().each(function(){var e=t(this);e.data("ui-menu-submenu-caret")&&e.remove()})},_keydown:function(e){var i,s,n,o,a=!0;switch(e.keyCode){case t.ui.keyCode.PAGE_UP:this.previousPage(e);break;case t.ui.keyCode.PAGE_DOWN:this.nextPage(e);break;case t.ui.keyCode.HOME:this._move("first","first",e);break;case t.ui.keyCode.END:this._move("last","last",e);break;case t.ui.keyCode.UP:this.previous(e);break;case t.ui.keyCode.DOWN:this.next(e);break;case t.ui.keyCode.LEFT:this.collapse(e);break;case t.ui.keyCode.RIGHT:this.active&&!this.active.is(".ui-state-disabled")&&this.expand(e);break;case t.ui.keyCode.ENTER:case t.ui.keyCode.SPACE:this._activate(e);break;case t.ui.keyCode.ESCAPE:this.collapse(e);break;default:a=!1,s=this.previousFilter||"",o=!1,n=e.keyCode>=96&&105>=e.keyCode?""+(e.keyCode-96):String.fromCharCode(e.keyCode),clearTimeout(this.filterTimer),n===s?o=!0:n=s+n,i=this._filterMenuItems(n),i=o&&-1!==i.index(this.active.next())?this.active.nextAll(".ui-menu-item"):i,i.length||(n=String.fromCharCode(e.keyCode),i=this._filterMenuItems(n)),i.length?(this.focus(e,i),this.previousFilter=n,this.filterTimer=this._delay(function(){delete this.previousFilter},1e3)):delete this.previousFilter}a&&e.preventDefault()},_activate:function(t){this.active&&!this.active.is(".ui-state-disabled")&&(this.active.children("[aria-haspopup='true']").length?this.expand(t):this.select(t))},refresh:function(){var e,i,s,n,o,a=this,r=this.options.icons.submenu,l=this.element.find(this.options.menus);this._toggleClass("ui-menu-icons",null,!!this.element.find(".ui-icon").length),s=l.filter(":not(.ui-menu)").hide().attr({role:this.options.role,"aria-hidden":"true","aria-expanded":"false"}).each(function(){var e=t(this),i=e.prev(),s=t("<span>").data("ui-menu-submenu-caret",!0);a._addClass(s,"ui-menu-icon","ui-icon "+r),i.attr("aria-haspopup","true").prepend(s),e.attr("aria-labelledby",i.attr("id"))}),this._addClass(s,"ui-menu","ui-widget ui-widget-content ui-front"),e=l.add(this.element),i=e.find(this.options.items),i.not(".ui-menu-item").each(function(){var e=t(this);a._isDivider(e)&&a._addClass(e,"ui-menu-divider","ui-widget-content")}),n=i.not(".ui-menu-item, .ui-menu-divider"),o=n.children().not(".ui-menu").uniqueId().attr({tabIndex:-1,role:this._itemRole()}),this._addClass(n,"ui-menu-item")._addClass(o,"ui-menu-item-wrapper"),i.filter(".ui-state-disabled").attr("aria-disabled","true"),this.active&&!t.contains(this.element[0],this.active[0])&&this.blur()},_itemRole:function(){return{menu:"menuitem",listbox:"option"}[this.options.role]},_setOption:function(t,e){if ("icons"===t){var i=this.element.find(".ui-menu-icon");this._removeClass(i,null,this.options.icons.submenu)._addClass(i,null,e.submenu)}this._super(t,e)},_setOptionDisabled:function(t){this._super(t),this.element.attr("aria-disabled",t+""),this._toggleClass(null,"ui-state-disabled",!!t)},focus:function(t,e){var i,s,n;this.blur(t,t&&"focus"===t.type),this._scrollIntoView(e),this.active=e.first(),s=this.active.children(".ui-menu-item-wrapper"),this._addClass(s,null,"ui-state-active"),this.options.role&&this.element.attr("aria-activedescendant",s.attr("id")),n=this.active.parent().closest(".ui-menu-item").children(".ui-menu-item-wrapper"),this._addClass(n,null,"ui-state-active"),t&&"keydown"===t.type?this._close():this.timer=this._delay(function(){this._close()},this.delay),i=e.children(".ui-menu"),i.length&&t&&/^mouse/.test(t.type)&&this._startOpening(i),this.activeMenu=e.parent(),this._trigger("focus",t,{item:e})},_scrollIntoView:function(e){var i,s,n,o,a,r;this._hasScroll()&&(i=parseFloat(t.css(this.activeMenu[0],"borderTopWidth"))||0,s=parseFloat(t.css(this.activeMenu[0],"paddingTop"))||0,n=e.offset().top-this.activeMenu.offset().top-i-s,o=this.activeMenu.scrollTop(),a=this.activeMenu.height(),r=e.outerHeight(),0>n?this.activeMenu.scrollTop(o+n):n+r>a&&this.activeMenu.scrollTop(o+n-a+r))},blur:function(t,e){e||clearTimeout(this.timer),this.active&&(this._removeClass(this.active.children(".ui-menu-item-wrapper"),null,"ui-state-active"),this._trigger("blur",t,{item:this.active}),this.active=null)},_startOpening:function(t){clearTimeout(this.timer),"true"===t.attr("aria-hidden")&&(this.timer=this._delay(function(){this._close(),this._open(t)},this.delay))},_open:function(e){var i=t.extend({of:this.active},this.options.position);clearTimeout(this.timer),this.element.find(".ui-menu").not(e.parents(".ui-menu")).hide().attr("aria-hidden","true"),e.show().removeAttr("aria-hidden").attr("aria-expanded","true").position(i)},collapseAll:function(e,i){clearTimeout(this.timer),this.timer=this._delay(function(){var s=i?this.element:t(e&&e.target).closest(this.element.find(".ui-menu"));s.length||(s=this.element),this._close(s),this.blur(e),this._removeClass(s.find(".ui-state-active"),null,"ui-state-active"),this.activeMenu=s},this.delay)},_close:function(t){t||(t=this.active?this.active.parent():this.element),t.find(".ui-menu").hide().attr("aria-hidden","true").attr("aria-expanded","false")},_closeOnDocumentClick:function(e){return!t(e.target).closest(".ui-menu").length},_isDivider:function(t){return!/[^\-\u2014\u2013\s]/.test(t.text())},collapse:function(t){var e=this.active&&this.active.parent().closest(".ui-menu-item",this.element);e&&e.length&&(this._close(),this.focus(t,e))},expand:function(t){var e=this.active&&this.active.children(".ui-menu ").find(this.options.items).first();e&&e.length&&(this._open(e.parent()),this._delay(function(){this.focus(t,e)}))},next:function(t){this._move("next","first",t)},previous:function(t){this._move("prev","last",t)},isFirstItem:function(){return this.active&&!this.active.prevAll(".ui-menu-item").length},isLastItem:function(){return this.active&&!this.active.nextAll(".ui-menu-item").length},_move:function(t,e,i){var s;this.active&&(s="first"===t||"last"===t?this.active["first"===t?"prevAll":"nextAll"](".ui-menu-item").eq(-1):this.active[t+"All"](".ui-menu-item").eq(0)),s&&s.length&&this.active||(s=this.activeMenu.find(this.options.items)[e]()),this.focus(i,s)},nextPage:function(e){var i,s,n;return this.active?(this.isLastItem()||(this._hasScroll()?(s=this.active.offset().top,n=this.element.height(),this.active.nextAll(".ui-menu-item").each(function(){return i=t(this),0>i.offset().top-s-n}),this.focus(e,i)):this.focus(e,this.activeMenu.find(this.options.items)[this.active?"last":"first"]())),void 0):(this.next(e),void 0)},previousPage:function(e){var i,s,n;return this.active?(this.isFirstItem()||(this._hasScroll()?(s=this.active.offset().top,n=this.element.height(),this.active.prevAll(".ui-menu-item").each(function(){return i=t(this),i.offset().top-s+n>0}),this.focus(e,i)):this.focus(e,this.activeMenu.find(this.options.items).first())),void 0):(this.next(e),void 0)},_hasScroll:function(){return this.element.outerHeight()<this.element.prop("scrollHeight")},select:function(e){this.active=this.active||t(e.target).closest(".ui-menu-item");var i={item:this.active};this.active.has(".ui-menu").length||this.collapseAll(e,!0),this._trigger("select",e,i)},_filterMenuItems:function(e){var i=e.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&"),s=RegExp("^"+i,"i");return this.activeMenu.find(this.options.items).filter(".ui-menu-item").filter(function(){return s.test(t.trim(t(this).children(".ui-menu-item-wrapper").text()))})}}),t.widget("ui.autocomplete",{version:"1.12.1",defaultElement:"<input>",options:{appendTo:null,autoFocus:!1,delay:300,minLength:1,position:{my:"left top",at:"left bottom",collision:"none"},source:null,change:null,close:null,focus:null,open:null,response:null,search:null,select:null},requestIndex:0,pending:0,_create:function(){var e,i,s,n=this.element[0].nodeName.toLowerCase(),o="textarea"===n,a="input"===n;this.isMultiLine=o||!a&&this._isContentEditable(this.element),this.valueMethod=this.element[o||a?"val":"text"],this.isNewMenu=!0,this._addClass("ui-autocomplete-input"),this.element.attr("autocomplete","off"),this._on(this.element,{keydown:function(n){if (this.element.prop("readOnly"))return e=!0,s=!0,i=!0,void 0;e=!1,s=!1,i=!1;var o=t.ui.keyCode;switch(n.keyCode){case o.PAGE_UP:e=!0,this._move("previousPage",n);break;case o.PAGE_DOWN:e=!0,this._move("nextPage",n);break;case o.UP:e=!0,this._keyEvent("previous",n);break;case o.DOWN:e=!0,this._keyEvent("next",n);break;case o.ENTER:this.menu.active&&(e=!0,n.preventDefault(),this.menu.select(n));break;case o.TAB:this.menu.active&&this.menu.select(n);break;case o.ESCAPE:this.menu.element.is(":visible")&&(this.isMultiLine||this._value(this.term),this.close(n),n.preventDefault());break;default:i=!0,this._searchTimeout(n)}},keypress:function(s){if (e)return e=!1,(!this.isMultiLine||this.menu.element.is(":visible"))&&s.preventDefault(),void 0;if (!i){var n=t.ui.keyCode;switch(s.keyCode){case n.PAGE_UP:this._move("previousPage",s);break;case n.PAGE_DOWN:this._move("nextPage",s);break;case n.UP:this._keyEvent("previous",s);break;case n.DOWN:this._keyEvent("next",s)}}},input:function(t){return s?(s=!1,t.preventDefault(),void 0):(this._searchTimeout(t),void 0)},focus:function(){this.selectedItem=null,this.previous=this._value()},blur:function(t){return this.cancelBlur?(delete this.cancelBlur,void 0):(clearTimeout(this.searching),this.close(t),this._change(t),void 0)}}),this._initSource(),this.menu=t("<ul>").appendTo(this._appendTo()).menu({role:null}).hide().menu("instance"),this._addClass(this.menu.element,"ui-autocomplete","ui-front"),this._on(this.menu.element,{mousedown:function(e){e.preventDefault(),this.cancelBlur=!0,this._delay(function(){delete this.cancelBlur,this.element[0]!==t.ui.safeActiveElement(this.document[0])&&this.element.trigger("focus")})},menufocus:function(e,i){var s,n;return this.isNewMenu&&(this.isNewMenu=!1,e.originalEvent&&/^mouse/.test(e.originalEvent.type))?(this.menu.blur(),this.document.one("mousemove",function(){t(e.target).trigger(e.originalEvent)}),void 0):(n=i.item.data("ui-autocomplete-item"),!1!==this._trigger("focus",e,{item:n})&&e.originalEvent&&/^key/.test(e.originalEvent.type)&&this._value(n.value),s=i.item.attr("aria-label")||n.value,s&&t.trim(s).length&&(this.liveRegion.children().hide(),t("<div>").text(s).appendTo(this.liveRegion)),void 0)},menuselect:function(e,i){var s=i.item.data("ui-autocomplete-item"),n=this.previous;this.element[0]!==t.ui.safeActiveElement(this.document[0])&&(this.element.trigger("focus"),this.previous=n,this._delay(function(){this.previous=n,this.selectedItem=s})),!1!==this._trigger("select",e,{item:s})&&this._value(s.value),this.term=this._value(),this.close(e),this.selectedItem=s}}),this.liveRegion=t("<div>",{role:"status","aria-live":"assertive","aria-relevant":"additions"}).appendTo(this.document[0].body),this._addClass(this.liveRegion,null,"ui-helper-hidden-accessible"),this._on(this.window,{beforeunload:function(){this.element.removeAttr("autocomplete")}})},_destroy:function(){clearTimeout(this.searching),this.element.removeAttr("autocomplete"),this.menu.element.remove(),this.liveRegion.remove()},_setOption:function(t,e){this._super(t,e),"source"===t&&this._initSource(),"appendTo"===t&&this.menu.element.appendTo(this._appendTo()),"disabled"===t&&e&&this.xhr&&this.xhr.abort()},_isEventTargetInWidget:function(e){var i=this.menu.element[0];return e.target===this.element[0]||e.target===i||t.contains(i,e.target)},_closeOnClickOutside:function(t){this._isEventTargetInWidget(t)||this.close()},_appendTo:function(){var e=this.options.appendTo;return e&&(e=e.jquery||e.nodeType?t(e):this.document.find(e).eq(0)),e&&e[0]||(e=this.element.closest(".ui-front, dialog")),e.length||(e=this.document[0].body),e},_initSource:function(){var e,i,s=this;t.isArray(this.options.source)?(e=this.options.source,this.source=function(i,s){s(t.ui.autocomplete.filter(e,i.term))}):"string"==typeof this.options.source?(i=this.options.source,this.source=function(e,n){s.xhr&&s.xhr.abort(),s.xhr=t.ajax({url:i,data:e,dataType:"json",success:function(t){n(t)},error:function(){n([])}})}):this.source=this.options.source},_searchTimeout:function(t){clearTimeout(this.searching),this.searching=this._delay(function(){var e=this.term===this._value(),i=this.menu.element.is(":visible"),s=t.altKey||t.ctrlKey||t.metaKey||t.shiftKey;(!e||e&&!i&&!s)&&(this.selectedItem=null,this.search(null,t))},this.options.delay)},search:function(t,e){return t=null!=t?t:this._value(),this.term=this._value(),t.length<this.options.minLength?this.close(e):this._trigger("search",e)!==!1?this._search(t):void 0},_search:function(t){this.pending++,this._addClass("ui-autocomplete-loading"),this.cancelSearch=!1,this.source({term:t},this._response())},_response:function(){var e=++this.requestIndex;return t.proxy(function(t){e===this.requestIndex&&this.__response(t),this.pending--,this.pending||this._removeClass("ui-autocomplete-loading")},this)},__response:function(t){t&&(t=this._normalize(t)),this._trigger("response",null,{content:t}),!this.options.disabled&&t&&t.length&&!this.cancelSearch?(this._suggest(t),this._trigger("open")):this._close()},close:function(t){this.cancelSearch=!0,this._close(t)},_close:function(t){this._off(this.document,"mousedown"),this.menu.element.is(":visible")&&(this.menu.element.hide(),this.menu.blur(),this.isNewMenu=!0,this._trigger("close",t))},_change:function(t){this.previous!==this._value()&&this._trigger("change",t,{item:this.selectedItem})},_normalize:function(e){return e.length&&e[0].label&&e[0].value?e:t.map(e,function(e){return"string"==typeof e?{label:e,value:e}:t.extend({},e,{label:e.label||e.value,value:e.value||e.label})})},_suggest:function(e){var i=this.menu.element.empty();this._renderMenu(i,e),this.isNewMenu=!0,this.menu.refresh(),i.show(),this._resizeMenu(),i.position(t.extend({of:this.element},this.options.position)),this.options.autoFocus&&this.menu.next(),this._on(this.document,{mousedown:"_closeOnClickOutside"})},_resizeMenu:function(){var t=this.menu.element;t.outerWidth(Math.max(t.width("").outerWidth()+1,this.element.outerWidth()))},_renderMenu:function(e,i){var s=this;t.each(i,function(t,i){s._renderItemData(e,i)})},_renderItemData:function(t,e){return this._renderItem(t,e).data("ui-autocomplete-item",e)},_renderItem:function(e,i){return t("<li>").append(t("<div>").text(i.label)).appendTo(e)},_move:function(t,e){return this.menu.element.is(":visible")?this.menu.isFirstItem()&&/^previous/.test(t)||this.menu.isLastItem()&&/^next/.test(t)?(this.isMultiLine||this._value(this.term),this.menu.blur(),void 0):(this.menu[t](e),void 0):(this.search(null,e),void 0)},widget:function(){return this.menu.element},_value:function(){return this.valueMethod.apply(this.element,arguments)},_keyEvent:function(t,e){(!this.isMultiLine||this.menu.element.is(":visible"))&&(this._move(t,e),e.preventDefault())},_isContentEditable:function(t){if (!t.length)return!1;var e=t.prop("contentEditable");return"inherit"===e?this._isContentEditable(t.parent()):"true"===e}}),t.extend(t.ui.autocomplete,{escapeRegex:function(t){return t.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")},filter:function(e,i){var s=RegExp(t.ui.autocomplete.escapeRegex(i),"i");return t.grep(e,function(t){return s.test(t.label||t.value||t)})}}),t.widget("ui.autocomplete",t.ui.autocomplete,{options:{messages:{noResults:"No search results.",results:function(t){return t+(t>1?" results are":" result is")+" available, use up and down arrow keys to navigate."}}},__response:function(e){var i;this._superApply(arguments),this.options.disabled||this.cancelSearch||(i=e&&e.length?this.options.messages.results(e.length):this.options.messages.noResults,this.liveRegion.children().hide(),t("<div>").text(i).appendTo(this.liveRegion))}}),t.ui.autocomplete,t.extend(t.ui,{datepicker:{version:"1.12.1"}});var u;t.extend(s.prototype,{markerClassName:"hasDatepicker",maxRows:4,_widgetDatepicker:function(){return this.dpDiv},setDefaults:function(t){return a(this._defaults,t||{}),this},_attachDatepicker:function(e,i){var s,n,o;s=e.nodeName.toLowerCase(),n="div"===s||"span"===s,e.id||(this.uuid+=1,e.id="dp"+this.uuid),o=this._newInst(t(e),n),o.settings=t.extend({},i||{}),"input"===s?this._connectDatepicker(e,o):n&&this._inlineDatepicker(e,o)},_newInst:function(e,i){var s=e[0].id.replace(/([^A-Za-z0-9_\-])/g,"\\\\$1");return{id:s,input:e,selectedDay:0,selectedMonth:0,selectedYear:0,drawMonth:0,drawYear:0,inline:i,dpDiv:i?n(t("<div class='"+this._inlineClass+" ui-datepicker ui-widget ui-widget-content ui-helper-clearfix ui-corner-all'></div>")):this.dpDiv}},_connectDatepicker:function(e,i){var s=t(e);i.append=t([]),i.trigger=t([]),s.hasClass(this.markerClassName)||(this._attachments(s,i),s.addClass(this.markerClassName).on("keydown",this._doKeyDown).on("keypress",this._doKeyPress).on("keyup",this._doKeyUp),this._autoSize(i),t.data(e,"datepicker",i),i.settings.disabled&&this._disableDatepicker(e))},_attachments:function(e,i){var s,n,o,a=this._get(i,"appendText"),r=this._get(i,"isRTL");i.append&&i.append.remove(),a&&(i.append=t("<span class='"+this._appendClass+"'>"+a+"</span>"),e[r?"before":"after"](i.append)),e.off("focus",this._showDatepicker),i.trigger&&i.trigger.remove(),s=this._get(i,"showOn"),("focus"===s||"both"===s)&&e.on("focus",this._showDatepicker),("button"===s||"both"===s)&&(n=this._get(i,"buttonText"),o=this._get(i,"buttonImage"),i.trigger=t(this._get(i,"buttonImageOnly")?t("<img/>").addClass(this._triggerClass).attr({src:o,alt:n,title:n}):t("<button type='button'></button>").addClass(this._triggerClass).html(o?t("<img/>").attr({src:o,alt:n,title:n}):n)),e[r?"before":"after"](i.trigger),i.trigger.on("click",function(){return t.datepicker._datepickerShowing&&t.datepicker._lastInput===e[0]?t.datepicker._hideDatepicker():t.datepicker._datepickerShowing&&t.datepicker._lastInput!==e[0]?(t.datepicker._hideDatepicker(),t.datepicker._showDatepicker(e[0])):t.datepicker._showDatepicker(e[0]),!1}))},_autoSize:function(t){if (this._get(t,"autoSize")&&!t.inline){var e,i,s,n,o=new Date(2009,11,20),a=this._get(t,"dateFormat");a.match(/[DM]/)&&(e=function(t){for(i=0,s=0,n=0;t.length>n;n++)t[n].length>i&&(i=t[n].length,s=n);return s},o.setMonth(e(this._get(t,a.match(/MM/)?"monthNames":"monthNamesShort"))),o.setDate(e(this._get(t,a.match(/DD/)?"dayNames":"dayNamesShort"))+20-o.getDay())),t.input.attr("size",this._formatDate(t,o).length)}},_inlineDatepicker:function(e,i){var s=t(e);s.hasClass(this.markerClassName)||(s.addClass(this.markerClassName).append(i.dpDiv),t.data(e,"datepicker",i),this._setDate(i,this._getDefaultDate(i),!0),this._updateDatepicker(i),this._updateAlternate(i),i.settings.disabled&&this._disableDatepicker(e),i.dpDiv.css("display","block"))},_dialogDatepicker:function(e,i,s,n,o){var r,l,h,c,u,d=this._dialogInst;return d||(this.uuid+=1,r="dp"+this.uuid,this._dialogInput=t("<input type='text' id='"+r+"' style='position: absolute; top: -100px; width: 0px;'/>"),this._dialogInput.on("keydown",this._doKeyDown),t("body").append(this._dialogInput),d=this._dialogInst=this._newInst(this._dialogInput,!1),d.settings={},t.data(this._dialogInput[0],"datepicker",d)),a(d.settings,n||{}),i=i&&i.constructor===Date?this._formatDate(d,i):i,this._dialogInput.val(i),this._pos=o?o.length?o:[o.pageX,o.pageY]:null,this._pos||(l=document.documentElement.clientWidth,h=document.documentElement.clientHeight,c=document.documentElement.scrollLeft||document.body.scrollLeft,u=document.documentElement.scrollTop||document.body.scrollTop,this._pos=[l/2-100+c,h/2-150+u]),this._dialogInput.css("left",this._pos[0]+20+"px").css("top",this._pos[1]+"px"),d.settings.onSelect=s,this._inDialog=!0,this.dpDiv.addClass(this._dialogClass),this._showDatepicker(this._dialogInput[0]),t.blockUI&&t.blockUI(this.dpDiv),t.data(this._dialogInput[0],"datepicker",d),this},_destroyDatepicker:function(e){var i,s=t(e),n=t.data(e,"datepicker");s.hasClass(this.markerClassName)&&(i=e.nodeName.toLowerCase(),t.removeData(e,"datepicker"),"input"===i?(n.append.remove(),n.trigger.remove(),s.removeClass(this.markerClassName).off("focus",this._showDatepicker).off("keydown",this._doKeyDown).off("keypress",this._doKeyPress).off("keyup",this._doKeyUp)):("div"===i||"span"===i)&&s.removeClass(this.markerClassName).empty(),u===n&&(u=null))},_enableDatepicker:function(e){var i,s,n=t(e),o=t.data(e,"datepicker");n.hasClass(this.markerClassName)&&(i=e.nodeName.toLowerCase(),"input"===i?(e.disabled=!1,o.trigger.filter("button").each(function(){this.disabled=!1}).end().filter("img").css({opacity:"1.0",cursor:""})):("div"===i||"span"===i)&&(s=n.children("."+this._inlineClass),s.children().removeClass("ui-state-disabled"),s.find("select.ui-datepicker-month, select.ui-datepicker-year").prop("disabled",!1)),this._disabledInputs=t.map(this._disabledInputs,function(t){return t===e?null:t}))},_disableDatepicker:function(e){var i,s,n=t(e),o=t.data(e,"datepicker");n.hasClass(this.markerClassName)&&(i=e.nodeName.toLowerCase(),"input"===i?(e.disabled=!0,o.trigger.filter("button").each(function(){this.disabled=!0}).end().filter("img").css({opacity:"0.5",cursor:"default"})):("div"===i||"span"===i)&&(s=n.children("."+this._inlineClass),s.children().addClass("ui-state-disabled"),s.find("select.ui-datepicker-month, select.ui-datepicker-year").prop("disabled",!0)),this._disabledInputs=t.map(this._disabledInputs,function(t){return t===e?null:t}),this._disabledInputs[this._disabledInputs.length]=e)},_isDisabledDatepicker:function(t){if (!t)return!1;for(var e=0;this._disabledInputs.length>e;e++)if (this._disabledInputs[e]===t)return!0;return!1},_getInst:function(e){try{return t.data(e,"datepicker")}catch(i){throw"Missing instance data for this datepicker"}},_optionDatepicker:function(e,i,s){var n,o,r,l,h=this._getInst(e);return 2===arguments.length&&"string"==typeof i?"defaults"===i?t.extend({},t.datepicker._defaults):h?"all"===i?t.extend({},h.settings):this._get(h,i):null:(n=i||{},"string"==typeof i&&(n={},n[i]=s),h&&(this._curInst===h&&this._hideDatepicker(),o=this._getDateDatepicker(e,!0),r=this._getMinMaxDate(h,"min"),l=this._getMinMaxDate(h,"max"),a(h.settings,n),null!==r&&void 0!==n.dateFormat&&void 0===n.minDate&&(h.settings.minDate=this._formatDate(h,r)),null!==l&&void 0!==n.dateFormat&&void 0===n.maxDate&&(h.settings.maxDate=this._formatDate(h,l)),"disabled"in n&&(n.disabled?this._disableDatepicker(e):this._enableDatepicker(e)),this._attachments(t(e),h),this._autoSize(h),this._setDate(h,o),this._updateAlternate(h),this._updateDatepicker(h)),void 0)},_changeDatepicker:function(t,e,i){this._optionDatepicker(t,e,i)},_refreshDatepicker:function(t){var e=this._getInst(t);e&&this._updateDatepicker(e)},_setDateDatepicker:function(t,e){var i=this._getInst(t);i&&(this._setDate(i,e),this._updateDatepicker(i),this._updateAlternate(i))},_getDateDatepicker:function(t,e){var i=this._getInst(t);return i&&!i.inline&&this._setDateFromField(i,e),i?this._getDate(i):null},_doKeyDown:function(e){var i,s,n,o=t.datepicker._getInst(e.target),a=!0,r=o.dpDiv.is(".ui-datepicker-rtl");if (o._keyEvent=!0,t.datepicker._datepickerShowing)switch(e.keyCode){case 9:t.datepicker._hideDatepicker(),a=!1;break;case 13:return n=t("td."+t.datepicker._dayOverClass+":not(."+t.datepicker._currentClass+")",o.dpDiv),n[0]&&t.datepicker._selectDay(e.target,o.selectedMonth,o.selectedYear,n[0]),i=t.datepicker._get(o,"onSelect"),i?(s=t.datepicker._formatDate(o),i.apply(o.input?o.input[0]:null,[s,o])):t.datepicker._hideDatepicker(),!1;case 27:t.datepicker._hideDatepicker();break;case 33:t.datepicker._adjustDate(e.target,e.ctrlKey?-t.datepicker._get(o,"stepBigMonths"):-t.datepicker._get(o,"stepMonths"),"M");break;case 34:t.datepicker._adjustDate(e.target,e.ctrlKey?+t.datepicker._get(o,"stepBigMonths"):+t.datepicker._get(o,"stepMonths"),"M");break;case 35:(e.ctrlKey||e.metaKey)&&t.datepicker._clearDate(e.target),a=e.ctrlKey||e.metaKey;break;case 36:(e.ctrlKey||e.metaKey)&&t.datepicker._gotoToday(e.target),a=e.ctrlKey||e.metaKey;break;case 37:(e.ctrlKey||e.metaKey)&&t.datepicker._adjustDate(e.target,r?1:-1,"D"),a=e.ctrlKey||e.metaKey,e.originalEvent.altKey&&t.datepicker._adjustDate(e.target,e.ctrlKey?-t.datepicker._get(o,"stepBigMonths"):-t.datepicker._get(o,"stepMonths"),"M");break;case 38:(e.ctrlKey||e.metaKey)&&t.datepicker._adjustDate(e.target,-7,"D"),a=e.ctrlKey||e.metaKey;break;case 39:(e.ctrlKey||e.metaKey)&&t.datepicker._adjustDate(e.target,r?-1:1,"D"),a=e.ctrlKey||e.metaKey,e.originalEvent.altKey&&t.datepicker._adjustDate(e.target,e.ctrlKey?+t.datepicker._get(o,"stepBigMonths"):+t.datepicker._get(o,"stepMonths"),"M");break;case 40:(e.ctrlKey||e.metaKey)&&t.datepicker._adjustDate(e.target,7,"D"),a=e.ctrlKey||e.metaKey;break;default:a=!1}else 36===e.keyCode&&e.ctrlKey?t.datepicker._showDatepicker(this):a=!1;a&&(e.preventDefault(),e.stopPropagation())},_doKeyPress:function(e){var i,s,n=t.datepicker._getInst(e.target);return t.datepicker._get(n,"constrainInput")?(i=t.datepicker._possibleChars(t.datepicker._get(n,"dateFormat")),s=String.fromCharCode(null==e.charCode?e.keyCode:e.charCode),e.ctrlKey||e.metaKey||" ">s||!i||i.indexOf(s)>-1):void 0},_doKeyUp:function(e){var i,s=t.datepicker._getInst(e.target);if (s.input.val()!==s.lastVal)try{i=t.datepicker.parseDate(t.datepicker._get(s,"dateFormat"),s.input?s.input.val():null,t.datepicker._getFormatConfig(s)),i&&(t.datepicker._setDateFromField(s),t.datepicker._updateAlternate(s),t.datepicker._updateDatepicker(s))}catch(n){}return!0},_showDatepicker:function(e){if (e=e.target||e,"input"!==e.nodeName.toLowerCase()&&(e=t("input",e.parentNode)[0]),!t.datepicker._isDisabledDatepicker(e)&&t.datepicker._lastInput!==e){var s,n,o,r,l,h,c;s=t.datepicker._getInst(e),t.datepicker._curInst&&t.datepicker._curInst!==s&&(t.datepicker._curInst.dpDiv.stop(!0,!0),s&&t.datepicker._datepickerShowing&&t.datepicker._hideDatepicker(t.datepicker._curInst.input[0])),n=t.datepicker._get(s,"beforeShow"),o=n?n.apply(e,[e,s]):{},o!==!1&&(a(s.settings,o),s.lastVal=null,t.datepicker._lastInput=e,t.datepicker._setDateFromField(s),t.datepicker._inDialog&&(e.value=""),t.datepicker._pos||(t.datepicker._pos=t.datepicker._findPos(e),t.datepicker._pos[1]+=e.offsetHeight),r=!1,t(e).parents().each(function(){return r|="fixed"===t(this).css("position"),!r}),l={left:t.datepicker._pos[0],top:t.datepicker._pos[1]},t.datepicker._pos=null,s.dpDiv.empty(),s.dpDiv.css({position:"absolute",display:"block",top:"-1000px"}),t.datepicker._updateDatepicker(s),l=t.datepicker._checkOffset(s,l,r),s.dpDiv.css({position:t.datepicker._inDialog&&t.blockUI?"static":r?"fixed":"absolute",display:"none",left:l.left+"px",top:l.top+"px"}),s.inline||(h=t.datepicker._get(s,"showAnim"),c=t.datepicker._get(s,"duration"),s.dpDiv.css("z-index",i(t(e))+1),t.datepicker._datepickerShowing=!0,t.effects&&t.effects.effect[h]?s.dpDiv.show(h,t.datepicker._get(s,"showOptions"),c):s.dpDiv[h||"show"](h?c:null),t.datepicker._shouldFocusInput(s)&&s.input.trigger("focus"),t.datepicker._curInst=s))}},_updateDatepicker:function(e){this.maxRows=4,u=e,e.dpDiv.empty().append(this._generateHTML(e)),this._attachHandlers(e);var i,s=this._getNumberOfMonths(e),n=s[1],a=17,r=e.dpDiv.find("."+this._dayOverClass+" a");r.length>0&&o.apply(r.get(0)),e.dpDiv.removeClass("ui-datepicker-multi-2 ui-datepicker-multi-3 ui-datepicker-multi-4").width(""),n>1&&e.dpDiv.addClass("ui-datepicker-multi-"+n).css("width",a*n+"em"),e.dpDiv[(1!==s[0]||1!==s[1]?"add":"remove")+"Class"]("ui-datepicker-multi"),e.dpDiv[(this._get(e,"isRTL")?"add":"remove")+"Class"]("ui-datepicker-rtl"),e===t.datepicker._curInst&&t.datepicker._datepickerShowing&&t.datepicker._shouldFocusInput(e)&&e.input.trigger("focus"),e.yearshtml&&(i=e.yearshtml,setTimeout(function(){i===e.yearshtml&&e.yearshtml&&e.dpDiv.find("select.ui-datepicker-year:first").replaceWith(e.yearshtml),i=e.yearshtml=null},0))},_shouldFocusInput:function(t){return t.input&&t.input.is(":visible")&&!t.input.is(":disabled")&&!t.input.is(":focus")},_checkOffset:function(e,i,s){var n=e.dpDiv.outerWidth(),o=e.dpDiv.outerHeight(),a=e.input?e.input.outerWidth():0,r=e.input?e.input.outerHeight():0,l=document.documentElement.clientWidth+(s?0:t(document).scrollLeft()),h=document.documentElement.clientHeight+(s?0:t(document).scrollTop());return i.left-=this._get(e,"isRTL")?n-a:0,i.left-=s&&i.left===e.input.offset().left?t(document).scrollLeft():0,i.top-=s&&i.top===e.input.offset().top+r?t(document).scrollTop():0,i.left-=Math.min(i.left,i.left+n>l&&l>n?Math.abs(i.left+n-l):0),i.top-=Math.min(i.top,i.top+o>h&&h>o?Math.abs(o+r):0),i},_findPos:function(e){for(var i,s=this._getInst(e),n=this._get(s,"isRTL");e&&("hidden"===e.type||1!==e.nodeType||t.expr.filters.hidden(e));)e=e[n?"previousSibling":"nextSibling"];return i=t(e).offset(),[i.left,i.top]},_hideDatepicker:function(e){var i,s,n,o,a=this._curInst;!a||e&&a!==t.data(e,"datepicker")||this._datepickerShowing&&(i=this._get(a,"showAnim"),s=this._get(a,"duration"),n=function(){t.datepicker._tidyDialog(a)},t.effects&&(t.effects.effect[i]||t.effects[i])?a.dpDiv.hide(i,t.datepicker._get(a,"showOptions"),s,n):a.dpDiv["slideDown"===i?"slideUp":"fadeIn"===i?"fadeOut":"hide"](i?s:null,n),i||n(),this._datepickerShowing=!1,o=this._get(a,"onClose"),o&&o.apply(a.input?a.input[0]:null,[a.input?a.input.val():"",a]),this._lastInput=null,this._inDialog&&(this._dialogInput.css({position:"absolute",left:"0",top:"-100px"}),t.blockUI&&(t.unblockUI(),t("body").append(this.dpDiv))),this._inDialog=!1)},_tidyDialog:function(t){t.dpDiv.removeClass(this._dialogClass).off(".ui-datepicker-calendar")},_checkExternalClick:function(e){if (t.datepicker._curInst){var i=t(e.target),s=t.datepicker._getInst(i[0]);(i[0].id!==t.datepicker._mainDivId&&0===i.parents("#"+t.datepicker._mainDivId).length&&!i.hasClass(t.datepicker.markerClassName)&&!i.closest("."+t.datepicker._triggerClass).length&&t.datepicker._datepickerShowing&&(!t.datepicker._inDialog||!t.blockUI)||i.hasClass(t.datepicker.markerClassName)&&t.datepicker._curInst!==s)&&t.datepicker._hideDatepicker()}},_adjustDate:function(e,i,s){var n=t(e),o=this._getInst(n[0]);this._isDisabledDatepicker(n[0])||(this._adjustInstDate(o,i+("M"===s?this._get(o,"showCurrentAtPos"):0),s),this._updateDatepicker(o))},_gotoToday:function(e){var i,s=t(e),n=this._getInst(s[0]);this._get(n,"gotoCurrent")&&n.currentDay?(n.selectedDay=n.currentDay,n.drawMonth=n.selectedMonth=n.currentMonth,n.drawYear=n.selectedYear=n.currentYear):(i=new Date,n.selectedDay=i.getDate(),n.drawMonth=n.selectedMonth=i.getMonth(),n.drawYear=n.selectedYear=i.getFullYear()),this._notifyChange(n),this._adjustDate(s)},_selectMonthYear:function(e,i,s){var n=t(e),o=this._getInst(n[0]);o["selected"+("M"===s?"Month":"Year")]=o["draw"+("M"===s?"Month":"Year")]=parseInt(i.options[i.selectedIndex].value,10),this._notifyChange(o),this._adjustDate(n)},_selectDay:function(e,i,s,n){var o,a=t(e);t(n).hasClass(this._unselectableClass)||this._isDisabledDatepicker(a[0])||(o=this._getInst(a[0]),o.selectedDay=o.currentDay=t("a",n).html(),o.selectedMonth=o.currentMonth=i,o.selectedYear=o.currentYear=s,this._selectDate(e,this._formatDate(o,o.currentDay,o.currentMonth,o.currentYear)))},_clearDate:function(e){var i=t(e);this._selectDate(i,"")},_selectDate:function(e,i){var s,n=t(e),o=this._getInst(n[0]);i=null!=i?i:this._formatDate(o),o.input&&o.input.val(i),this._updateAlternate(o),s=this._get(o,"onSelect"),s?s.apply(o.input?o.input[0]:null,[i,o]):o.input&&o.input.trigger("change"),o.inline?this._updateDatepicker(o):(this._hideDatepicker(),this._lastInput=o.input[0],"object"!=typeof o.input[0]&&o.input.trigger("focus"),this._lastInput=null)
},_updateAlternate:function(e){var i,s,n,o=this._get(e,"altField");o&&(i=this._get(e,"altFormat")||this._get(e,"dateFormat"),s=this._getDate(e),n=this.formatDate(i,s,this._getFormatConfig(e)),t(o).val(n))},noWeekends:function(t){var e=t.getDay();return[e>0&&6>e,""]},iso8601Week:function(t){var e,i=new Date(t.getTime());return i.setDate(i.getDate()+4-(i.getDay()||7)),e=i.getTime(),i.setMonth(0),i.setDate(1),Math.floor(Math.round((e-i)/864e5)/7)+1},parseDate:function(e,i,s){if (null==e||null==i)throw"Invalid arguments";if (i="object"==typeof i?""+i:i+"",""===i)return null;var n,o,a,r,l=0,h=(s?s.shortYearCutoff:null)||this._defaults.shortYearCutoff,c="string"!=typeof h?h:(new Date).getFullYear()%100+parseInt(h,10),u=(s?s.dayNamesShort:null)||this._defaults.dayNamesShort,d=(s?s.dayNames:null)||this._defaults.dayNames,p=(s?s.monthNamesShort:null)||this._defaults.monthNamesShort,f=(s?s.monthNames:null)||this._defaults.monthNames,g=-1,m=-1,_=-1,v=-1,b=!1,y=function(t){var i=e.length>n+1&&e.charAt(n+1)===t;return i&&n++,i},w=function(t){var e=y(t),s="@"===t?14:"!"===t?20:"y"===t&&e?4:"o"===t?3:2,n="y"===t?s:1,o=RegExp("^\\d{"+n+","+s+"}"),a=i.substring(l).match(o);if (!a)throw"Missing number at position "+l;return l+=a[0].length,parseInt(a[0],10)},k=function(e,s,n){var o=-1,a=t.map(y(e)?n:s,function(t,e){return[[e,t]]}).sort(function(t,e){return-(t[1].length-e[1].length)});if (t.each(a,function(t,e){var s=e[1];return i.substr(l,s.length).toLowerCase()===s.toLowerCase()?(o=e[0],l+=s.length,!1):void 0}),-1!==o)return o+1;throw"Unknown name at position "+l},x=function(){if (i.charAt(l)!==e.charAt(n))throw"Unexpected literal at position "+l;l++};for(n=0;e.length>n;n++)if (b)"'"!==e.charAt(n)||y("'")?x():b=!1;else switch(e.charAt(n)){case"d":_=w("d");break;case"D":k("D",u,d);break;case"o":v=w("o");break;case"m":m=w("m");break;case"M":m=k("M",p,f);break;case"y":g=w("y");break;case"@":r=new Date(w("@")),g=r.getFullYear(),m=r.getMonth()+1,_=r.getDate();break;case"!":r=new Date((w("!")-this._ticksTo1970)/1e4),g=r.getFullYear(),m=r.getMonth()+1,_=r.getDate();break;case"'":y("'")?x():b=!0;break;default:x()}if (i.length>l&&(a=i.substr(l),!/^\s+/.test(a)))throw"Extra/unparsed characters found in date: "+a;if (-1===g?g=(new Date).getFullYear():100>g&&(g+=(new Date).getFullYear()-(new Date).getFullYear()%100+(c>=g?0:-100)),v>-1)for(m=1,_=v;;){if (o=this._getDaysInMonth(g,m-1),o>=_)break;m++,_-=o}if (r=this._daylightSavingAdjust(new Date(g,m-1,_)),r.getFullYear()!==g||r.getMonth()+1!==m||r.getDate()!==_)throw"Invalid date";return r},ATOM:"yy-mm-dd",COOKIE:"D, dd M yy",ISO_8601:"yy-mm-dd",RFC_822:"D, d M y",RFC_850:"DD, dd-M-y",RFC_1036:"D, d M y",RFC_1123:"D, d M yy",RFC_2822:"D, d M yy",RSS:"D, d M y",TICKS:"!",TIMESTAMP:"@",W3C:"yy-mm-dd",_ticksTo1970:1e7*60*60*24*(718685+Math.floor(492.5)-Math.floor(19.7)+Math.floor(4.925)),formatDate:function(t,e,i){if (!e)return"";var s,n=(i?i.dayNamesShort:null)||this._defaults.dayNamesShort,o=(i?i.dayNames:null)||this._defaults.dayNames,a=(i?i.monthNamesShort:null)||this._defaults.monthNamesShort,r=(i?i.monthNames:null)||this._defaults.monthNames,l=function(e){var i=t.length>s+1&&t.charAt(s+1)===e;return i&&s++,i},h=function(t,e,i){var s=""+e;if (l(t))for(;i>s.length;)s="0"+s;return s},c=function(t,e,i,s){return l(t)?s[e]:i[e]},u="",d=!1;if (e)for(s=0;t.length>s;s++)if (d)"'"!==t.charAt(s)||l("'")?u+=t.charAt(s):d=!1;else switch(t.charAt(s)){case"d":u+=h("d",e.getDate(),2);break;case"D":u+=c("D",e.getDay(),n,o);break;case"o":u+=h("o",Math.round((new Date(e.getFullYear(),e.getMonth(),e.getDate()).getTime()-new Date(e.getFullYear(),0,0).getTime())/864e5),3);break;case"m":u+=h("m",e.getMonth()+1,2);break;case"M":u+=c("M",e.getMonth(),a,r);break;case"y":u+=l("y")?e.getFullYear():(10>e.getFullYear()%100?"0":"")+e.getFullYear()%100;break;case"@":u+=e.getTime();break;case"!":u+=1e4*e.getTime()+this._ticksTo1970;break;case"'":l("'")?u+="'":d=!0;break;default:u+=t.charAt(s)}return u},_possibleChars:function(t){var e,i="",s=!1,n=function(i){var s=t.length>e+1&&t.charAt(e+1)===i;return s&&e++,s};for(e=0;t.length>e;e++)if (s)"'"!==t.charAt(e)||n("'")?i+=t.charAt(e):s=!1;else switch(t.charAt(e)){case"d":case"m":case"y":case"@":i+="0123456789";break;case"D":case"M":return null;case"'":n("'")?i+="'":s=!0;break;default:i+=t.charAt(e)}return i},_get:function(t,e){return void 0!==t.settings[e]?t.settings[e]:this._defaults[e]},_setDateFromField:function(t,e){if (t.input.val()!==t.lastVal){var i=this._get(t,"dateFormat"),s=t.lastVal=t.input?t.input.val():null,n=this._getDefaultDate(t),o=n,a=this._getFormatConfig(t);try{o=this.parseDate(i,s,a)||n}catch(r){s=e?"":s}t.selectedDay=o.getDate(),t.drawMonth=t.selectedMonth=o.getMonth(),t.drawYear=t.selectedYear=o.getFullYear(),t.currentDay=s?o.getDate():0,t.currentMonth=s?o.getMonth():0,t.currentYear=s?o.getFullYear():0,this._adjustInstDate(t)}},_getDefaultDate:function(t){return this._restrictMinMax(t,this._determineDate(t,this._get(t,"defaultDate"),new Date))},_determineDate:function(e,i,s){var n=function(t){var e=new Date;return e.setDate(e.getDate()+t),e},o=function(i){try{return t.datepicker.parseDate(t.datepicker._get(e,"dateFormat"),i,t.datepicker._getFormatConfig(e))}catch(s){}for(var n=(i.toLowerCase().match(/^c/)?t.datepicker._getDate(e):null)||new Date,o=n.getFullYear(),a=n.getMonth(),r=n.getDate(),l=/([+\-]?[0-9]+)\s*(d|D|w|W|m|M|y|Y)?/g,h=l.exec(i);h;){switch(h[2]||"d"){case"d":case"D":r+=parseInt(h[1],10);break;case"w":case"W":r+=7*parseInt(h[1],10);break;case"m":case"M":a+=parseInt(h[1],10),r=Math.min(r,t.datepicker._getDaysInMonth(o,a));break;case"y":case"Y":o+=parseInt(h[1],10),r=Math.min(r,t.datepicker._getDaysInMonth(o,a))}h=l.exec(i)}return new Date(o,a,r)},a=null==i||""===i?s:"string"==typeof i?o(i):"number"==typeof i?isNaN(i)?s:n(i):new Date(i.getTime());return a=a&&"Invalid Date"==""+a?s:a,a&&(a.setHours(0),a.setMinutes(0),a.setSeconds(0),a.setMilliseconds(0)),this._daylightSavingAdjust(a)},_daylightSavingAdjust:function(t){return t?(t.setHours(t.getHours()>12?t.getHours()+2:0),t):null},_setDate:function(t,e,i){var s=!e,n=t.selectedMonth,o=t.selectedYear,a=this._restrictMinMax(t,this._determineDate(t,e,new Date));t.selectedDay=t.currentDay=a.getDate(),t.drawMonth=t.selectedMonth=t.currentMonth=a.getMonth(),t.drawYear=t.selectedYear=t.currentYear=a.getFullYear(),n===t.selectedMonth&&o===t.selectedYear||i||this._notifyChange(t),this._adjustInstDate(t),t.input&&t.input.val(s?"":this._formatDate(t))},_getDate:function(t){var e=!t.currentYear||t.input&&""===t.input.val()?null:this._daylightSavingAdjust(new Date(t.currentYear,t.currentMonth,t.currentDay));return e},_attachHandlers:function(e){var i=this._get(e,"stepMonths"),s="#"+e.id.replace(/\\\\/g,"\\");e.dpDiv.find("[data-handler]").map(function(){var e={prev:function(){t.datepicker._adjustDate(s,-i,"M")},next:function(){t.datepicker._adjustDate(s,+i,"M")},hide:function(){t.datepicker._hideDatepicker()},today:function(){t.datepicker._gotoToday(s)},selectDay:function(){return t.datepicker._selectDay(s,+this.getAttribute("data-month"),+this.getAttribute("data-year"),this),!1},selectMonth:function(){return t.datepicker._selectMonthYear(s,this,"M"),!1},selectYear:function(){return t.datepicker._selectMonthYear(s,this,"Y"),!1}};t(this).on(this.getAttribute("data-event"),e[this.getAttribute("data-handler")])})},_generateHTML:function(t){var e,i,s,n,o,a,r,l,h,c,u,d,p,f,g,m,_,v,b,y,w,k,x,C,D,T,I,M,P,S,N,H,A,z,O,E,W,F,L,R=new Date,Y=this._daylightSavingAdjust(new Date(R.getFullYear(),R.getMonth(),R.getDate())),B=this._get(t,"isRTL"),j=this._get(t,"showButtonPanel"),q=this._get(t,"hideIfNoPrevNext"),K=this._get(t,"navigationAsDateFormat"),U=this._getNumberOfMonths(t),V=this._get(t,"showCurrentAtPos"),X=this._get(t,"stepMonths"),$=1!==U[0]||1!==U[1],G=this._daylightSavingAdjust(t.currentDay?new Date(t.currentYear,t.currentMonth,t.currentDay):new Date(9999,9,9)),J=this._getMinMaxDate(t,"min"),Q=this._getMinMaxDate(t,"max"),Z=t.drawMonth-V,te=t.drawYear;if (0>Z&&(Z+=12,te--),Q)for(e=this._daylightSavingAdjust(new Date(Q.getFullYear(),Q.getMonth()-U[0]*U[1]+1,Q.getDate())),e=J&&J>e?J:e;this._daylightSavingAdjust(new Date(te,Z,1))>e;)Z--,0>Z&&(Z=11,te--);for(t.drawMonth=Z,t.drawYear=te,i=this._get(t,"prevText"),i=K?this.formatDate(i,this._daylightSavingAdjust(new Date(te,Z-X,1)),this._getFormatConfig(t)):i,s=this._canAdjustMonth(t,-1,te,Z)?"<a class='ui-datepicker-prev ui-corner-all' data-handler='prev' data-event='click' title='"+i+"'><span class='ui-icon ui-icon-circle-triangle-"+(B?"e":"w")+"'>"+i+"</span></a>":q?"":"<a class='ui-datepicker-prev ui-corner-all ui-state-disabled' title='"+i+"'><span class='ui-icon ui-icon-circle-triangle-"+(B?"e":"w")+"'>"+i+"</span></a>",n=this._get(t,"nextText"),n=K?this.formatDate(n,this._daylightSavingAdjust(new Date(te,Z+X,1)),this._getFormatConfig(t)):n,o=this._canAdjustMonth(t,1,te,Z)?"<a class='ui-datepicker-next ui-corner-all' data-handler='next' data-event='click' title='"+n+"'><span class='ui-icon ui-icon-circle-triangle-"+(B?"w":"e")+"'>"+n+"</span></a>":q?"":"<a class='ui-datepicker-next ui-corner-all ui-state-disabled' title='"+n+"'><span class='ui-icon ui-icon-circle-triangle-"+(B?"w":"e")+"'>"+n+"</span></a>",a=this._get(t,"currentText"),r=this._get(t,"gotoCurrent")&&t.currentDay?G:Y,a=K?this.formatDate(a,r,this._getFormatConfig(t)):a,l=t.inline?"":"<button type='button' class='ui-datepicker-close ui-state-default ui-priority-primary ui-corner-all' data-handler='hide' data-event='click'>"+this._get(t,"closeText")+"</button>",h=j?"<div class='ui-datepicker-buttonpane ui-widget-content'>"+(B?l:"")+(this._isInRange(t,r)?"<button type='button' class='ui-datepicker-current ui-state-default ui-priority-secondary ui-corner-all' data-handler='today' data-event='click'>"+a+"</button>":"")+(B?"":l)+"</div>":"",c=parseInt(this._get(t,"firstDay"),10),c=isNaN(c)?0:c,u=this._get(t,"showWeek"),d=this._get(t,"dayNames"),p=this._get(t,"dayNamesMin"),f=this._get(t,"monthNames"),g=this._get(t,"monthNamesShort"),m=this._get(t,"beforeShowDay"),_=this._get(t,"showOtherMonths"),v=this._get(t,"selectOtherMonths"),b=this._getDefaultDate(t),y="",k=0;U[0]>k;k++){for(x="",this.maxRows=4,C=0;U[1]>C;C++){if (D=this._daylightSavingAdjust(new Date(te,Z,t.selectedDay)),T=" ui-corner-all",I="",$){if (I+="<div class='ui-datepicker-group",U[1]>1)switch(C){case 0:I+=" ui-datepicker-group-first",T=" ui-corner-"+(B?"right":"left");break;case U[1]-1:I+=" ui-datepicker-group-last",T=" ui-corner-"+(B?"left":"right");break;default:I+=" ui-datepicker-group-middle",T=""}I+="'>"}for(I+="<div class='ui-datepicker-header ui-widget-header ui-helper-clearfix"+T+"'>"+(/all|left/.test(T)&&0===k?B?o:s:"")+(/all|right/.test(T)&&0===k?B?s:o:"")+this._generateMonthYearHeader(t,Z,te,J,Q,k>0||C>0,f,g)+"</div><table class='ui-datepicker-calendar'><thead>"+"<tr>",M=u?"<th class='ui-datepicker-week-col'>"+this._get(t,"weekHeader")+"</th>":"",w=0;7>w;w++)P=(w+c)%7,M+="<th scope='col'"+((w+c+6)%7>=5?" class='ui-datepicker-week-end'":"")+">"+"<span title='"+d[P]+"'>"+p[P]+"</span></th>";for(I+=M+"</tr></thead><tbody>",S=this._getDaysInMonth(te,Z),te===t.selectedYear&&Z===t.selectedMonth&&(t.selectedDay=Math.min(t.selectedDay,S)),N=(this._getFirstDayOfMonth(te,Z)-c+7)%7,H=Math.ceil((N+S)/7),A=$?this.maxRows>H?this.maxRows:H:H,this.maxRows=A,z=this._daylightSavingAdjust(new Date(te,Z,1-N)),O=0;A>O;O++){for(I+="<tr>",E=u?"<td class='ui-datepicker-week-col'>"+this._get(t,"calculateWeek")(z)+"</td>":"",w=0;7>w;w++)W=m?m.apply(t.input?t.input[0]:null,[z]):[!0,""],F=z.getMonth()!==Z,L=F&&!v||!W[0]||J&&J>z||Q&&z>Q,E+="<td class='"+((w+c+6)%7>=5?" ui-datepicker-week-end":"")+(F?" ui-datepicker-other-month":"")+(z.getTime()===D.getTime()&&Z===t.selectedMonth&&t._keyEvent||b.getTime()===z.getTime()&&b.getTime()===D.getTime()?" "+this._dayOverClass:"")+(L?" "+this._unselectableClass+" ui-state-disabled":"")+(F&&!_?"":" "+W[1]+(z.getTime()===G.getTime()?" "+this._currentClass:"")+(z.getTime()===Y.getTime()?" ui-datepicker-today":""))+"'"+(F&&!_||!W[2]?"":" title='"+W[2].replace(/'/g,"&#39;")+"'")+(L?"":" data-handler='selectDay' data-event='click' data-month='"+z.getMonth()+"' data-year='"+z.getFullYear()+"'")+">"+(F&&!_?"&#xa0;":L?"<span class='ui-state-default'>"+z.getDate()+"</span>":"<a class='ui-state-default"+(z.getTime()===Y.getTime()?" ui-state-highlight":"")+(z.getTime()===G.getTime()?" ui-state-active":"")+(F?" ui-priority-secondary":"")+"' href='#'>"+z.getDate()+"</a>")+"</td>",z.setDate(z.getDate()+1),z=this._daylightSavingAdjust(z);I+=E+"</tr>"}Z++,Z>11&&(Z=0,te++),I+="</tbody></table>"+($?"</div>"+(U[0]>0&&C===U[1]-1?"<div class='ui-datepicker-row-break'></div>":""):""),x+=I}y+=x}return y+=h,t._keyEvent=!1,y},_generateMonthYearHeader:function(t,e,i,s,n,o,a,r){var l,h,c,u,d,p,f,g,m=this._get(t,"changeMonth"),_=this._get(t,"changeYear"),v=this._get(t,"showMonthAfterYear"),b="<div class='ui-datepicker-title'>",y="";if (o||!m)y+="<span class='ui-datepicker-month'>"+a[e]+"</span>";else{for(l=s&&s.getFullYear()===i,h=n&&n.getFullYear()===i,y+="<select class='ui-datepicker-month' data-handler='selectMonth' data-event='change'>",c=0;12>c;c++)(!l||c>=s.getMonth())&&(!h||n.getMonth()>=c)&&(y+="<option value='"+c+"'"+(c===e?" selected='selected'":"")+">"+r[c]+"</option>");y+="</select>"}if (v||(b+=y+(!o&&m&&_?"":"&#xa0;")),!t.yearshtml)if (t.yearshtml="",o||!_)b+="<span class='ui-datepicker-year'>"+i+"</span>";else{for(u=this._get(t,"yearRange").split(":"),d=(new Date).getFullYear(),p=function(t){var e=t.match(/c[+\-].*/)?i+parseInt(t.substring(1),10):t.match(/[+\-].*/)?d+parseInt(t,10):parseInt(t,10);return isNaN(e)?d:e},f=p(u[0]),g=Math.max(f,p(u[1]||"")),f=s?Math.max(f,s.getFullYear()):f,g=n?Math.min(g,n.getFullYear()):g,t.yearshtml+="<select class='ui-datepicker-year' data-handler='selectYear' data-event='change'>";g>=f;f++)t.yearshtml+="<option value='"+f+"'"+(f===i?" selected='selected'":"")+">"+f+"</option>";t.yearshtml+="</select>",b+=t.yearshtml,t.yearshtml=null}return b+=this._get(t,"yearSuffix"),v&&(b+=(!o&&m&&_?"":"&#xa0;")+y),b+="</div>"},_adjustInstDate:function(t,e,i){var s=t.selectedYear+("Y"===i?e:0),n=t.selectedMonth+("M"===i?e:0),o=Math.min(t.selectedDay,this._getDaysInMonth(s,n))+("D"===i?e:0),a=this._restrictMinMax(t,this._daylightSavingAdjust(new Date(s,n,o)));t.selectedDay=a.getDate(),t.drawMonth=t.selectedMonth=a.getMonth(),t.drawYear=t.selectedYear=a.getFullYear(),("M"===i||"Y"===i)&&this._notifyChange(t)},_restrictMinMax:function(t,e){var i=this._getMinMaxDate(t,"min"),s=this._getMinMaxDate(t,"max"),n=i&&i>e?i:e;return s&&n>s?s:n},_notifyChange:function(t){var e=this._get(t,"onChangeMonthYear");e&&e.apply(t.input?t.input[0]:null,[t.selectedYear,t.selectedMonth+1,t])},_getNumberOfMonths:function(t){var e=this._get(t,"numberOfMonths");return null==e?[1,1]:"number"==typeof e?[1,e]:e},_getMinMaxDate:function(t,e){return this._determineDate(t,this._get(t,e+"Date"),null)},_getDaysInMonth:function(t,e){return 32-this._daylightSavingAdjust(new Date(t,e,32)).getDate()},_getFirstDayOfMonth:function(t,e){return new Date(t,e,1).getDay()},_canAdjustMonth:function(t,e,i,s){var n=this._getNumberOfMonths(t),o=this._daylightSavingAdjust(new Date(i,s+(0>e?e:n[0]*n[1]),1));return 0>e&&o.setDate(this._getDaysInMonth(o.getFullYear(),o.getMonth())),this._isInRange(t,o)},_isInRange:function(t,e){var i,s,n=this._getMinMaxDate(t,"min"),o=this._getMinMaxDate(t,"max"),a=null,r=null,l=this._get(t,"yearRange");return l&&(i=l.split(":"),s=(new Date).getFullYear(),a=parseInt(i[0],10),r=parseInt(i[1],10),i[0].match(/[+\-].*/)&&(a+=s),i[1].match(/[+\-].*/)&&(r+=s)),(!n||e.getTime()>=n.getTime())&&(!o||e.getTime()<=o.getTime())&&(!a||e.getFullYear()>=a)&&(!r||r>=e.getFullYear())},_getFormatConfig:function(t){var e=this._get(t,"shortYearCutoff");return e="string"!=typeof e?e:(new Date).getFullYear()%100+parseInt(e,10),{shortYearCutoff:e,dayNamesShort:this._get(t,"dayNamesShort"),dayNames:this._get(t,"dayNames"),monthNamesShort:this._get(t,"monthNamesShort"),monthNames:this._get(t,"monthNames")}},_formatDate:function(t,e,i,s){e||(t.currentDay=t.selectedDay,t.currentMonth=t.selectedMonth,t.currentYear=t.selectedYear);var n=e?"object"==typeof e?e:this._daylightSavingAdjust(new Date(s,i,e)):this._daylightSavingAdjust(new Date(t.currentYear,t.currentMonth,t.currentDay));return this.formatDate(this._get(t,"dateFormat"),n,this._getFormatConfig(t))}}),t.fn.datepicker=function(e){if (!this.length)return this;t.datepicker.initialized||(t(document).on("mousedown",t.datepicker._checkExternalClick),t.datepicker.initialized=!0),0===t("#"+t.datepicker._mainDivId).length&&t("body").append(t.datepicker.dpDiv);var i=Array.prototype.slice.call(arguments,1);return"string"!=typeof e||"isDisabled"!==e&&"getDate"!==e&&"widget"!==e?"option"===e&&2===arguments.length&&"string"==typeof arguments[1]?t.datepicker["_"+e+"Datepicker"].apply(t.datepicker,[this[0]].concat(i)):this.each(function(){"string"==typeof e?t.datepicker["_"+e+"Datepicker"].apply(t.datepicker,[this].concat(i)):t.datepicker._attachDatepicker(this,e)}):t.datepicker["_"+e+"Datepicker"].apply(t.datepicker,[this[0]].concat(i))},t.datepicker=new s,t.datepicker.initialized=!1,t.datepicker.uuid=(new Date).getTime(),t.datepicker.version="1.12.1",t.datepicker,t.widget("ui.progressbar",{version:"1.12.1",options:{classes:{"ui-progressbar":"ui-corner-all","ui-progressbar-value":"ui-corner-left","ui-progressbar-complete":"ui-corner-right"},max:100,value:0,change:null,complete:null},min:0,_create:function(){this.oldValue=this.options.value=this._constrainedValue(),this.element.attr({role:"progressbar","aria-valuemin":this.min}),this._addClass("ui-progressbar","ui-widget ui-widget-content"),this.valueDiv=t("<div>").appendTo(this.element),this._addClass(this.valueDiv,"ui-progressbar-value","ui-widget-header"),this._refreshValue()},_destroy:function(){this.element.removeAttr("role aria-valuemin aria-valuemax aria-valuenow"),this.valueDiv.remove()},value:function(t){return void 0===t?this.options.value:(this.options.value=this._constrainedValue(t),this._refreshValue(),void 0)},_constrainedValue:function(t){return void 0===t&&(t=this.options.value),this.indeterminate=t===!1,"number"!=typeof t&&(t=0),this.indeterminate?!1:Math.min(this.options.max,Math.max(this.min,t))},_setOptions:function(t){var e=t.value;delete t.value,this._super(t),this.options.value=this._constrainedValue(e),this._refreshValue()},_setOption:function(t,e){"max"===t&&(e=Math.max(this.min,e)),this._super(t,e)},_setOptionDisabled:function(t){this._super(t),this.element.attr("aria-disabled",t),this._toggleClass(null,"ui-state-disabled",!!t)},_percentage:function(){return this.indeterminate?100:100*(this.options.value-this.min)/(this.options.max-this.min)},_refreshValue:function(){var e=this.options.value,i=this._percentage();this.valueDiv.toggle(this.indeterminate||e>this.min).width(i.toFixed(0)+"%"),this._toggleClass(this.valueDiv,"ui-progressbar-complete",null,e===this.options.max)._toggleClass("ui-progressbar-indeterminate",null,this.indeterminate),this.indeterminate?(this.element.removeAttr("aria-valuenow"),this.overlayDiv||(this.overlayDiv=t("<div>").appendTo(this.valueDiv),this._addClass(this.overlayDiv,"ui-progressbar-overlay"))):(this.element.attr({"aria-valuemax":this.options.max,"aria-valuenow":e}),this.overlayDiv&&(this.overlayDiv.remove(),this.overlayDiv=null)),this.oldValue!==e&&(this.oldValue=e,this._trigger("change")),e===this.options.max&&this._trigger("complete")}}),t.widget("ui.slider",t.ui.mouse,{version:"1.12.1",widgetEventPrefix:"slide",options:{animate:!1,classes:{"ui-slider":"ui-corner-all","ui-slider-handle":"ui-corner-all","ui-slider-range":"ui-corner-all ui-widget-header"},distance:0,max:100,min:0,orientation:"horizontal",range:!1,step:1,value:0,values:null,change:null,slide:null,start:null,stop:null},numPages:5,_create:function(){this._keySliding=!1,this._mouseSliding=!1,this._animateOff=!0,this._handleIndex=null,this._detectOrientation(),this._mouseInit(),this._calculateNewMax(),this._addClass("ui-slider ui-slider-"+this.orientation,"ui-widget ui-widget-content"),this._refresh(),this._animateOff=!1},_refresh:function(){this._createRange(),this._createHandles(),this._setupEvents(),this._refreshValue()},_createHandles:function(){var e,i,s=this.options,n=this.element.find(".ui-slider-handle"),o="<span tabindex='0'></span>",a=[];for(i=s.values&&s.values.length||1,n.length>i&&(n.slice(i).remove(),n=n.slice(0,i)),e=n.length;i>e;e++)a.push(o);this.handles=n.add(t(a.join("")).appendTo(this.element)),this._addClass(this.handles,"ui-slider-handle","ui-state-default"),this.handle=this.handles.eq(0),this.handles.each(function(e){t(this).data("ui-slider-handle-index",e).attr("tabIndex",0)})},_createRange:function(){var e=this.options;e.range?(e.range===!0&&(e.values?e.values.length&&2!==e.values.length?e.values=[e.values[0],e.values[0]]:t.isArray(e.values)&&(e.values=e.values.slice(0)):e.values=[this._valueMin(),this._valueMin()]),this.range&&this.range.length?(this._removeClass(this.range,"ui-slider-range-min ui-slider-range-max"),this.range.css({left:"",bottom:""})):(this.range=t("<div>").appendTo(this.element),this._addClass(this.range,"ui-slider-range")),("min"===e.range||"max"===e.range)&&this._addClass(this.range,"ui-slider-range-"+e.range)):(this.range&&this.range.remove(),this.range=null)},_setupEvents:function(){this._off(this.handles),this._on(this.handles,this._handleEvents),this._hoverable(this.handles),this._focusable(this.handles)},_destroy:function(){this.handles.remove(),this.range&&this.range.remove(),this._mouseDestroy()},_mouseCapture:function(e){var i,s,n,o,a,r,l,h,c=this,u=this.options;return u.disabled?!1:(this.elementSize={width:this.element.outerWidth(),height:this.element.outerHeight()},this.elementOffset=this.element.offset(),i={x:e.pageX,y:e.pageY},s=this._normValueFromMouse(i),n=this._valueMax()-this._valueMin()+1,this.handles.each(function(e){var i=Math.abs(s-c.values(e));(n>i||n===i&&(e===c._lastChangedValue||c.values(e)===u.min))&&(n=i,o=t(this),a=e)}),r=this._start(e,a),r===!1?!1:(this._mouseSliding=!0,this._handleIndex=a,this._addClass(o,null,"ui-state-active"),o.trigger("focus"),l=o.offset(),h=!t(e.target).parents().addBack().is(".ui-slider-handle"),this._clickOffset=h?{left:0,top:0}:{left:e.pageX-l.left-o.width()/2,top:e.pageY-l.top-o.height()/2-(parseInt(o.css("borderTopWidth"),10)||0)-(parseInt(o.css("borderBottomWidth"),10)||0)+(parseInt(o.css("marginTop"),10)||0)},this.handles.hasClass("ui-state-hover")||this._slide(e,a,s),this._animateOff=!0,!0))},_mouseStart:function(){return!0},_mouseDrag:function(t){var e={x:t.pageX,y:t.pageY},i=this._normValueFromMouse(e);return this._slide(t,this._handleIndex,i),!1},_mouseStop:function(t){return this._removeClass(this.handles,null,"ui-state-active"),this._mouseSliding=!1,this._stop(t,this._handleIndex),this._change(t,this._handleIndex),this._handleIndex=null,this._clickOffset=null,this._animateOff=!1,!1},_detectOrientation:function(){this.orientation="vertical"===this.options.orientation?"vertical":"horizontal"},_normValueFromMouse:function(t){var e,i,s,n,o;return"horizontal"===this.orientation?(e=this.elementSize.width,i=t.x-this.elementOffset.left-(this._clickOffset?this._clickOffset.left:0)):(e=this.elementSize.height,i=t.y-this.elementOffset.top-(this._clickOffset?this._clickOffset.top:0)),s=i/e,s>1&&(s=1),0>s&&(s=0),"vertical"===this.orientation&&(s=1-s),n=this._valueMax()-this._valueMin(),o=this._valueMin()+s*n,this._trimAlignValue(o)},_uiHash:function(t,e,i){var s={handle:this.handles[t],handleIndex:t,value:void 0!==e?e:this.value()};return this._hasMultipleValues()&&(s.value=void 0!==e?e:this.values(t),s.values=i||this.values()),s},_hasMultipleValues:function(){return this.options.values&&this.options.values.length},_start:function(t,e){return this._trigger("start",t,this._uiHash(e))},_slide:function(t,e,i){var s,n,o=this.value(),a=this.values();this._hasMultipleValues()&&(n=this.values(e?0:1),o=this.values(e),2===this.options.values.length&&this.options.range===!0&&(i=0===e?Math.min(n,i):Math.max(n,i)),a[e]=i),i!==o&&(s=this._trigger("slide",t,this._uiHash(e,i,a)),s!==!1&&(this._hasMultipleValues()?this.values(e,i):this.value(i)))},_stop:function(t,e){this._trigger("stop",t,this._uiHash(e))},_change:function(t,e){this._keySliding||this._mouseSliding||(this._lastChangedValue=e,this._trigger("change",t,this._uiHash(e)))},value:function(t){return arguments.length?(this.options.value=this._trimAlignValue(t),this._refreshValue(),this._change(null,0),void 0):this._value()},values:function(e,i){var s,n,o;if (arguments.length>1)return this.options.values[e]=this._trimAlignValue(i),this._refreshValue(),this._change(null,e),void 0;if (!arguments.length)return this._values();if (!t.isArray(arguments[0]))return this._hasMultipleValues()?this._values(e):this.value();for(s=this.options.values,n=arguments[0],o=0;s.length>o;o+=1)s[o]=this._trimAlignValue(n[o]),this._change(null,o);this._refreshValue()},_setOption:function(e,i){var s,n=0;switch("range"===e&&this.options.range===!0&&("min"===i?(this.options.value=this._values(0),this.options.values=null):"max"===i&&(this.options.value=this._values(this.options.values.length-1),this.options.values=null)),t.isArray(this.options.values)&&(n=this.options.values.length),this._super(e,i),e){case"orientation":this._detectOrientation(),this._removeClass("ui-slider-horizontal ui-slider-vertical")._addClass("ui-slider-"+this.orientation),this._refreshValue(),this.options.range&&this._refreshRange(i),this.handles.css("horizontal"===i?"bottom":"left","");break;case"value":this._animateOff=!0,this._refreshValue(),this._change(null,0),this._animateOff=!1;break;case"values":for(this._animateOff=!0,this._refreshValue(),s=n-1;s>=0;s--)this._change(null,s);this._animateOff=!1;break;case"step":case"min":case"max":this._animateOff=!0,this._calculateNewMax(),this._refreshValue(),this._animateOff=!1;break;case"range":this._animateOff=!0,this._refresh(),this._animateOff=!1}},_setOptionDisabled:function(t){this._super(t),this._toggleClass(null,"ui-state-disabled",!!t)},_value:function(){var t=this.options.value;return t=this._trimAlignValue(t)},_values:function(t){var e,i,s;if (arguments.length)return e=this.options.values[t],e=this._trimAlignValue(e);if (this._hasMultipleValues()){for(i=this.options.values.slice(),s=0;i.length>s;s+=1)i[s]=this._trimAlignValue(i[s]);return i}return[]},_trimAlignValue:function(t){if (this._valueMin()>=t)return this._valueMin();if (t>=this._valueMax())return this._valueMax();var e=this.options.step>0?this.options.step:1,i=(t-this._valueMin())%e,s=t-i;return 2*Math.abs(i)>=e&&(s+=i>0?e:-e),parseFloat(s.toFixed(5))},_calculateNewMax:function(){var t=this.options.max,e=this._valueMin(),i=this.options.step,s=Math.round((t-e)/i)*i;t=s+e,t>this.options.max&&(t-=i),this.max=parseFloat(t.toFixed(this._precision()))},_precision:function(){var t=this._precisionOf(this.options.step);return null!==this.options.min&&(t=Math.max(t,this._precisionOf(this.options.min))),t},_precisionOf:function(t){var e=""+t,i=e.indexOf(".");return-1===i?0:e.length-i-1},_valueMin:function(){return this.options.min},_valueMax:function(){return this.max},_refreshRange:function(t){"vertical"===t&&this.range.css({width:"",left:""}),"horizontal"===t&&this.range.css({height:"",bottom:""})},_refreshValue:function(){var e,i,s,n,o,a=this.options.range,r=this.options,l=this,h=this._animateOff?!1:r.animate,c={};this._hasMultipleValues()?this.handles.each(function(s){i=100*((l.values(s)-l._valueMin())/(l._valueMax()-l._valueMin())),c["horizontal"===l.orientation?"left":"bottom"]=i+"%",t(this).stop(1,1)[h?"animate":"css"](c,r.animate),l.options.range===!0&&("horizontal"===l.orientation?(0===s&&l.range.stop(1,1)[h?"animate":"css"]({left:i+"%"},r.animate),1===s&&l.range[h?"animate":"css"]({width:i-e+"%"},{queue:!1,duration:r.animate})):(0===s&&l.range.stop(1,1)[h?"animate":"css"]({bottom:i+"%"},r.animate),1===s&&l.range[h?"animate":"css"]({height:i-e+"%"},{queue:!1,duration:r.animate}))),e=i}):(s=this.value(),n=this._valueMin(),o=this._valueMax(),i=o!==n?100*((s-n)/(o-n)):0,c["horizontal"===this.orientation?"left":"bottom"]=i+"%",this.handle.stop(1,1)[h?"animate":"css"](c,r.animate),"min"===a&&"horizontal"===this.orientation&&this.range.stop(1,1)[h?"animate":"css"]({width:i+"%"},r.animate),"max"===a&&"horizontal"===this.orientation&&this.range.stop(1,1)[h?"animate":"css"]({width:100-i+"%"},r.animate),"min"===a&&"vertical"===this.orientation&&this.range.stop(1,1)[h?"animate":"css"]({height:i+"%"},r.animate),"max"===a&&"vertical"===this.orientation&&this.range.stop(1,1)[h?"animate":"css"]({height:100-i+"%"},r.animate))},_handleEvents:{keydown:function(e){var i,s,n,o,a=t(e.target).data("ui-slider-handle-index");switch(e.keyCode){case t.ui.keyCode.HOME:case t.ui.keyCode.END:case t.ui.keyCode.PAGE_UP:case t.ui.keyCode.PAGE_DOWN:case t.ui.keyCode.UP:case t.ui.keyCode.RIGHT:case t.ui.keyCode.DOWN:case t.ui.keyCode.LEFT:if (e.preventDefault(),!this._keySliding&&(this._keySliding=!0,this._addClass(t(e.target),null,"ui-state-active"),i=this._start(e,a),i===!1))return}switch(o=this.options.step,s=n=this._hasMultipleValues()?this.values(a):this.value(),e.keyCode){case t.ui.keyCode.HOME:n=this._valueMin();break;case t.ui.keyCode.END:n=this._valueMax();break;case t.ui.keyCode.PAGE_UP:n=this._trimAlignValue(s+(this._valueMax()-this._valueMin())/this.numPages);break;case t.ui.keyCode.PAGE_DOWN:n=this._trimAlignValue(s-(this._valueMax()-this._valueMin())/this.numPages);break;case t.ui.keyCode.UP:case t.ui.keyCode.RIGHT:if (s===this._valueMax())return;n=this._trimAlignValue(s+o);break;case t.ui.keyCode.DOWN:case t.ui.keyCode.LEFT:if (s===this._valueMin())return;n=this._trimAlignValue(s-o)}this._slide(e,a,n)},keyup:function(e){var i=t(e.target).data("ui-slider-handle-index");this._keySliding&&(this._keySliding=!1,this._stop(e,i),this._change(e,i),this._removeClass(t(e.target),null,"ui-state-active"))}}});var d="ui-effects-",p="ui-effects-style",f="ui-effects-animated",g=t;t.effects={effect:{}},function(t,e){function i(t,e,i){var s=u[e.type]||{};return null==t?i||!e.def?null:e.def:(t=s.floor?~~t:parseFloat(t),isNaN(t)?e.def:s.mod?(t+s.mod)%s.mod:0>t?0:t>s.max?s.max:t)}function s(i){var s=h(),n=s._rgba=[];return i=i.toLowerCase(),f(l,function(t,o){var a,r=o.re.exec(i),l=r&&o.parse(r),h=o.space||"rgba";return l?(a=s[h](l),s[c[h].cache]=a[c[h].cache],n=s._rgba=a._rgba,!1):e}),n.length?("0,0,0,0"===n.join()&&t.extend(n,o.transparent),s):o[i]}function n(t,e,i){return i=(i+1)%1,1>6*i?t+6*(e-t)*i:1>2*i?e:2>3*i?t+6*(e-t)*(2/3-i):t}var o,a="backgroundColor borderBottomColor borderLeftColor borderRightColor borderTopColor color columnRuleColor outlineColor textDecorationColor textEmphasisColor",r=/^([\-+])=\s*(\d+\.?\d*)/,l=[{re:/rgba?\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*(?:,\s*(\d?(?:\.\d+)?)\s*)?\)/,parse:function(t){return[t[1],t[2],t[3],t[4]]}},{re:/rgba?\(\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*(?:,\s*(\d?(?:\.\d+)?)\s*)?\)/,parse:function(t){return[2.55*t[1],2.55*t[2],2.55*t[3],t[4]]}},{re:/#([a-f0-9]{2})([a-f0-9]{2})([a-f0-9]{2})/,parse:function(t){return[parseInt(t[1],16),parseInt(t[2],16),parseInt(t[3],16)]}},{re:/#([a-f0-9])([a-f0-9])([a-f0-9])/,parse:function(t){return[parseInt(t[1]+t[1],16),parseInt(t[2]+t[2],16),parseInt(t[3]+t[3],16)]}},{re:/hsla?\(\s*(\d+(?:\.\d+)?)\s*,\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*(?:,\s*(\d?(?:\.\d+)?)\s*)?\)/,space:"hsla",parse:function(t){return[t[1],t[2]/100,t[3]/100,t[4]]}}],h=t.Color=function(e,i,s,n){return new t.Color.fn.parse(e,i,s,n)},c={rgba:{props:{red:{idx:0,type:"byte"},green:{idx:1,type:"byte"},blue:{idx:2,type:"byte"}}},hsla:{props:{hue:{idx:0,type:"degrees"},saturation:{idx:1,type:"percent"},lightness:{idx:2,type:"percent"}}}},u={"byte":{floor:!0,max:255},percent:{max:1},degrees:{mod:360,floor:!0}},d=h.support={},p=t("<p>")[0],f=t.each;p.style.cssText="background-color:rgba(1,1,1,.5)",d.rgba=p.style.backgroundColor.indexOf("rgba")>-1,f(c,function(t,e){e.cache="_"+t,e.props.alpha={idx:3,type:"percent",def:1}
}),h.fn=t.extend(h.prototype,{parse:function(n,a,r,l){if (n===e)return this._rgba=[null,null,null,null],this;(n.jquery||n.nodeType)&&(n=t(n).css(a),a=e);var u=this,d=t.type(n),p=this._rgba=[];return a!==e&&(n=[n,a,r,l],d="array"),"string"===d?this.parse(s(n)||o._default):"array"===d?(f(c.rgba.props,function(t,e){p[e.idx]=i(n[e.idx],e)}),this):"object"===d?(n instanceof h?f(c,function(t,e){n[e.cache]&&(u[e.cache]=n[e.cache].slice())}):f(c,function(e,s){var o=s.cache;f(s.props,function(t,e){if (!u[o]&&s.to){if ("alpha"===t||null==n[t])return;u[o]=s.to(u._rgba)}u[o][e.idx]=i(n[t],e,!0)}),u[o]&&0>t.inArray(null,u[o].slice(0,3))&&(u[o][3]=1,s.from&&(u._rgba=s.from(u[o])))}),this):e},is:function(t){var i=h(t),s=!0,n=this;return f(c,function(t,o){var a,r=i[o.cache];return r&&(a=n[o.cache]||o.to&&o.to(n._rgba)||[],f(o.props,function(t,i){return null!=r[i.idx]?s=r[i.idx]===a[i.idx]:e})),s}),s},_space:function(){var t=[],e=this;return f(c,function(i,s){e[s.cache]&&t.push(i)}),t.pop()},transition:function(t,e){var s=h(t),n=s._space(),o=c[n],a=0===this.alpha()?h("transparent"):this,r=a[o.cache]||o.to(a._rgba),l=r.slice();return s=s[o.cache],f(o.props,function(t,n){var o=n.idx,a=r[o],h=s[o],c=u[n.type]||{};null!==h&&(null===a?l[o]=h:(c.mod&&(h-a>c.mod/2?a+=c.mod:a-h>c.mod/2&&(a-=c.mod)),l[o]=i((h-a)*e+a,n)))}),this[n](l)},blend:function(e){if (1===this._rgba[3])return this;var i=this._rgba.slice(),s=i.pop(),n=h(e)._rgba;return h(t.map(i,function(t,e){return(1-s)*n[e]+s*t}))},toRgbaString:function(){var e="rgba(",i=t.map(this._rgba,function(t,e){return null==t?e>2?1:0:t});return 1===i[3]&&(i.pop(),e="rgb("),e+i.join()+")"},toHslaString:function(){var e="hsla(",i=t.map(this.hsla(),function(t,e){return null==t&&(t=e>2?1:0),e&&3>e&&(t=Math.round(100*t)+"%"),t});return 1===i[3]&&(i.pop(),e="hsl("),e+i.join()+")"},toHexString:function(e){var i=this._rgba.slice(),s=i.pop();return e&&i.push(~~(255*s)),"#"+t.map(i,function(t){return t=(t||0).toString(16),1===t.length?"0"+t:t}).join("")},toString:function(){return 0===this._rgba[3]?"transparent":this.toRgbaString()}}),h.fn.parse.prototype=h.fn,c.hsla.to=function(t){if (null==t[0]||null==t[1]||null==t[2])return[null,null,null,t[3]];var e,i,s=t[0]/255,n=t[1]/255,o=t[2]/255,a=t[3],r=Math.max(s,n,o),l=Math.min(s,n,o),h=r-l,c=r+l,u=.5*c;return e=l===r?0:s===r?60*(n-o)/h+360:n===r?60*(o-s)/h+120:60*(s-n)/h+240,i=0===h?0:.5>=u?h/c:h/(2-c),[Math.round(e)%360,i,u,null==a?1:a]},c.hsla.from=function(t){if (null==t[0]||null==t[1]||null==t[2])return[null,null,null,t[3]];var e=t[0]/360,i=t[1],s=t[2],o=t[3],a=.5>=s?s*(1+i):s+i-s*i,r=2*s-a;return[Math.round(255*n(r,a,e+1/3)),Math.round(255*n(r,a,e)),Math.round(255*n(r,a,e-1/3)),o]},f(c,function(s,n){var o=n.props,a=n.cache,l=n.to,c=n.from;h.fn[s]=function(s){if (l&&!this[a]&&(this[a]=l(this._rgba)),s===e)return this[a].slice();var n,r=t.type(s),u="array"===r||"object"===r?s:arguments,d=this[a].slice();return f(o,function(t,e){var s=u["object"===r?t:e.idx];null==s&&(s=d[e.idx]),d[e.idx]=i(s,e)}),c?(n=h(c(d)),n[a]=d,n):h(d)},f(o,function(e,i){h.fn[e]||(h.fn[e]=function(n){var o,a=t.type(n),l="alpha"===e?this._hsla?"hsla":"rgba":s,h=this[l](),c=h[i.idx];return"undefined"===a?c:("function"===a&&(n=n.call(this,c),a=t.type(n)),null==n&&i.empty?this:("string"===a&&(o=r.exec(n),o&&(n=c+parseFloat(o[2])*("+"===o[1]?1:-1))),h[i.idx]=n,this[l](h)))})})}),h.hook=function(e){var i=e.split(" ");f(i,function(e,i){t.cssHooks[i]={set:function(e,n){var o,a,r="";if ("transparent"!==n&&("string"!==t.type(n)||(o=s(n)))){if (n=h(o||n),!d.rgba&&1!==n._rgba[3]){for(a="backgroundColor"===i?e.parentNode:e;(""===r||"transparent"===r)&&a&&a.style;)try{r=t.css(a,"backgroundColor"),a=a.parentNode}catch(l){}n=n.blend(r&&"transparent"!==r?r:"_default")}n=n.toRgbaString()}try{e.style[i]=n}catch(l){}}},t.fx.step[i]=function(e){e.colorInit||(e.start=h(e.elem,i),e.end=h(e.end),e.colorInit=!0),t.cssHooks[i].set(e.elem,e.start.transition(e.end,e.pos))}})},h.hook(a),t.cssHooks.borderColor={expand:function(t){var e={};return f(["Top","Right","Bottom","Left"],function(i,s){e["border"+s+"Color"]=t}),e}},o=t.Color.names={aqua:"#00ffff",black:"#000000",blue:"#0000ff",fuchsia:"#ff00ff",gray:"#808080",green:"#008000",lime:"#00ff00",maroon:"#800000",navy:"#000080",olive:"#808000",purple:"#800080",red:"#ff0000",silver:"#c0c0c0",teal:"#008080",white:"#ffffff",yellow:"#ffff00",transparent:[null,null,null,0],_default:"#ffffff"}}(g),function(){function e(e){var i,s,n=e.ownerDocument.defaultView?e.ownerDocument.defaultView.getComputedStyle(e,null):e.currentStyle,o={};if (n&&n.length&&n[0]&&n[n[0]])for(s=n.length;s--;)i=n[s],"string"==typeof n[i]&&(o[t.camelCase(i)]=n[i]);else for(i in n)"string"==typeof n[i]&&(o[i]=n[i]);return o}function i(e,i){var s,o,a={};for(s in i)o=i[s],e[s]!==o&&(n[s]||(t.fx.step[s]||!isNaN(parseFloat(o)))&&(a[s]=o));return a}var s=["add","remove","toggle"],n={border:1,borderBottom:1,borderColor:1,borderLeft:1,borderRight:1,borderTop:1,borderWidth:1,margin:1,padding:1};t.each(["borderLeftStyle","borderRightStyle","borderBottomStyle","borderTopStyle"],function(e,i){t.fx.step[i]=function(t){("none"!==t.end&&!t.setAttr||1===t.pos&&!t.setAttr)&&(g.style(t.elem,i,t.end),t.setAttr=!0)}}),t.fn.addBack||(t.fn.addBack=function(t){return this.add(null==t?this.prevObject:this.prevObject.filter(t))}),t.effects.animateClass=function(n,o,a,r){var l=t.speed(o,a,r);return this.queue(function(){var o,a=t(this),r=a.attr("class")||"",h=l.children?a.find("*").addBack():a;h=h.map(function(){var i=t(this);return{el:i,start:e(this)}}),o=function(){t.each(s,function(t,e){n[e]&&a[e+"Class"](n[e])})},o(),h=h.map(function(){return this.end=e(this.el[0]),this.diff=i(this.start,this.end),this}),a.attr("class",r),h=h.map(function(){var e=this,i=t.Deferred(),s=t.extend({},l,{queue:!1,complete:function(){i.resolve(e)}});return this.el.animate(this.diff,s),i.promise()}),t.when.apply(t,h.get()).done(function(){o(),t.each(arguments,function(){var e=this.el;t.each(this.diff,function(t){e.css(t,"")})}),l.complete.call(a[0])})})},t.fn.extend({addClass:function(e){return function(i,s,n,o){return s?t.effects.animateClass.call(this,{add:i},s,n,o):e.apply(this,arguments)}}(t.fn.addClass),removeClass:function(e){return function(i,s,n,o){return arguments.length>1?t.effects.animateClass.call(this,{remove:i},s,n,o):e.apply(this,arguments)}}(t.fn.removeClass),toggleClass:function(e){return function(i,s,n,o,a){return"boolean"==typeof s||void 0===s?n?t.effects.animateClass.call(this,s?{add:i}:{remove:i},n,o,a):e.apply(this,arguments):t.effects.animateClass.call(this,{toggle:i},s,n,o)}}(t.fn.toggleClass),switchClass:function(e,i,s,n,o){return t.effects.animateClass.call(this,{add:i,remove:e},s,n,o)}})}(),function(){function e(e,i,s,n){return t.isPlainObject(e)&&(i=e,e=e.effect),e={effect:e},null==i&&(i={}),t.isFunction(i)&&(n=i,s=null,i={}),("number"==typeof i||t.fx.speeds[i])&&(n=s,s=i,i={}),t.isFunction(s)&&(n=s,s=null),i&&t.extend(e,i),s=s||i.duration,e.duration=t.fx.off?0:"number"==typeof s?s:s in t.fx.speeds?t.fx.speeds[s]:t.fx.speeds._default,e.complete=n||i.complete,e}function i(e){return!e||"number"==typeof e||t.fx.speeds[e]?!0:"string"!=typeof e||t.effects.effect[e]?t.isFunction(e)?!0:"object"!=typeof e||e.effect?!1:!0:!0}function s(t,e){var i=e.outerWidth(),s=e.outerHeight(),n=/^rect\((-?\d*\.?\d*px|-?\d+%|auto),?\s*(-?\d*\.?\d*px|-?\d+%|auto),?\s*(-?\d*\.?\d*px|-?\d+%|auto),?\s*(-?\d*\.?\d*px|-?\d+%|auto)\)$/,o=n.exec(t)||["",0,i,s,0];return{top:parseFloat(o[1])||0,right:"auto"===o[2]?i:parseFloat(o[2]),bottom:"auto"===o[3]?s:parseFloat(o[3]),left:parseFloat(o[4])||0}}t.expr&&t.expr.filters&&t.expr.filters.animated&&(t.expr.filters.animated=function(e){return function(i){return!!t(i).data(f)||e(i)}}(t.expr.filters.animated)),t.uiBackCompat!==!1&&t.extend(t.effects,{save:function(t,e){for(var i=0,s=e.length;s>i;i++)null!==e[i]&&t.data(d+e[i],t[0].style[e[i]])},restore:function(t,e){for(var i,s=0,n=e.length;n>s;s++)null!==e[s]&&(i=t.data(d+e[s]),t.css(e[s],i))},setMode:function(t,e){return"toggle"===e&&(e=t.is(":hidden")?"show":"hide"),e},createWrapper:function(e){if (e.parent().is(".ui-effects-wrapper"))return e.parent();var i={width:e.outerWidth(!0),height:e.outerHeight(!0),"float":e.css("float")},s=t("<div></div>").addClass("ui-effects-wrapper").css({fontSize:"100%",background:"transparent",border:"none",margin:0,padding:0}),n={width:e.width(),height:e.height()},o=document.activeElement;try{o.id}catch(a){o=document.body}return e.wrap(s),(e[0]===o||t.contains(e[0],o))&&t(o).trigger("focus"),s=e.parent(),"static"===e.css("position")?(s.css({position:"relative"}),e.css({position:"relative"})):(t.extend(i,{position:e.css("position"),zIndex:e.css("z-index")}),t.each(["top","left","bottom","right"],function(t,s){i[s]=e.css(s),isNaN(parseInt(i[s],10))&&(i[s]="auto")}),e.css({position:"relative",top:0,left:0,right:"auto",bottom:"auto"})),e.css(n),s.css(i).show()},removeWrapper:function(e){var i=document.activeElement;return e.parent().is(".ui-effects-wrapper")&&(e.parent().replaceWith(e),(e[0]===i||t.contains(e[0],i))&&t(i).trigger("focus")),e}}),t.extend(t.effects,{version:"1.12.1",define:function(e,i,s){return s||(s=i,i="effect"),t.effects.effect[e]=s,t.effects.effect[e].mode=i,s},scaledDimensions:function(t,e,i){if (0===e)return{height:0,width:0,outerHeight:0,outerWidth:0};var s="horizontal"!==i?(e||100)/100:1,n="vertical"!==i?(e||100)/100:1;return{height:t.height()*n,width:t.width()*s,outerHeight:t.outerHeight()*n,outerWidth:t.outerWidth()*s}},clipToBox:function(t){return{width:t.clip.right-t.clip.left,height:t.clip.bottom-t.clip.top,left:t.clip.left,top:t.clip.top}},unshift:function(t,e,i){var s=t.queue();e>1&&s.splice.apply(s,[1,0].concat(s.splice(e,i))),t.dequeue()},saveStyle:function(t){t.data(p,t[0].style.cssText)},restoreStyle:function(t){t[0].style.cssText=t.data(p)||"",t.removeData(p)},mode:function(t,e){var i=t.is(":hidden");return"toggle"===e&&(e=i?"show":"hide"),(i?"hide"===e:"show"===e)&&(e="none"),e},getBaseline:function(t,e){var i,s;switch(t[0]){case"top":i=0;break;case"middle":i=.5;break;case"bottom":i=1;break;default:i=t[0]/e.height}switch(t[1]){case"left":s=0;break;case"center":s=.5;break;case"right":s=1;break;default:s=t[1]/e.width}return{x:s,y:i}},createPlaceholder:function(e){var i,s=e.css("position"),n=e.position();return e.css({marginTop:e.css("marginTop"),marginBottom:e.css("marginBottom"),marginLeft:e.css("marginLeft"),marginRight:e.css("marginRight")}).outerWidth(e.outerWidth()).outerHeight(e.outerHeight()),/^(static|relative)/.test(s)&&(s="absolute",i=t("<"+e[0].nodeName+">").insertAfter(e).css({display:/^(inline|ruby)/.test(e.css("display"))?"inline-block":"block",visibility:"hidden",marginTop:e.css("marginTop"),marginBottom:e.css("marginBottom"),marginLeft:e.css("marginLeft"),marginRight:e.css("marginRight"),"float":e.css("float")}).outerWidth(e.outerWidth()).outerHeight(e.outerHeight()).addClass("ui-effects-placeholder"),e.data(d+"placeholder",i)),e.css({position:s,left:n.left,top:n.top}),i},removePlaceholder:function(t){var e=d+"placeholder",i=t.data(e);i&&(i.remove(),t.removeData(e))},cleanUp:function(e){t.effects.restoreStyle(e),t.effects.removePlaceholder(e)},setTransition:function(e,i,s,n){return n=n||{},t.each(i,function(t,i){var o=e.cssUnit(i);o[0]>0&&(n[i]=o[0]*s+o[1])}),n}}),t.fn.extend({effect:function(){function i(e){function i(){r.removeData(f),t.effects.cleanUp(r),"hide"===s.mode&&r.hide(),a()}function a(){t.isFunction(l)&&l.call(r[0]),t.isFunction(e)&&e()}var r=t(this);s.mode=c.shift(),t.uiBackCompat===!1||o?"none"===s.mode?(r[h](),a()):n.call(r[0],s,i):(r.is(":hidden")?"hide"===h:"show"===h)?(r[h](),a()):n.call(r[0],s,a)}var s=e.apply(this,arguments),n=t.effects.effect[s.effect],o=n.mode,a=s.queue,r=a||"fx",l=s.complete,h=s.mode,c=[],u=function(e){var i=t(this),s=t.effects.mode(i,h)||o;i.data(f,!0),c.push(s),o&&("show"===s||s===o&&"hide"===s)&&i.show(),o&&"none"===s||t.effects.saveStyle(i),t.isFunction(e)&&e()};return t.fx.off||!n?h?this[h](s.duration,l):this.each(function(){l&&l.call(this)}):a===!1?this.each(u).each(i):this.queue(r,u).queue(r,i)},show:function(t){return function(s){if (i(s))return t.apply(this,arguments);var n=e.apply(this,arguments);return n.mode="show",this.effect.call(this,n)}}(t.fn.show),hide:function(t){return function(s){if (i(s))return t.apply(this,arguments);var n=e.apply(this,arguments);return n.mode="hide",this.effect.call(this,n)}}(t.fn.hide),toggle:function(t){return function(s){if (i(s)||"boolean"==typeof s)return t.apply(this,arguments);var n=e.apply(this,arguments);return n.mode="toggle",this.effect.call(this,n)}}(t.fn.toggle),cssUnit:function(e){var i=this.css(e),s=[];return t.each(["em","px","%","pt"],function(t,e){i.indexOf(e)>0&&(s=[parseFloat(i),e])}),s},cssClip:function(t){return t?this.css("clip","rect("+t.top+"px "+t.right+"px "+t.bottom+"px "+t.left+"px)"):s(this.css("clip"),this)},transfer:function(e,i){var s=t(this),n=t(e.to),o="fixed"===n.css("position"),a=t("body"),r=o?a.scrollTop():0,l=o?a.scrollLeft():0,h=n.offset(),c={top:h.top-r,left:h.left-l,height:n.innerHeight(),width:n.innerWidth()},u=s.offset(),d=t("<div class='ui-effects-transfer'></div>").appendTo("body").addClass(e.className).css({top:u.top-r,left:u.left-l,height:s.innerHeight(),width:s.innerWidth(),position:o?"fixed":"absolute"}).animate(c,e.duration,e.easing,function(){d.remove(),t.isFunction(i)&&i()})}}),t.fx.step.clip=function(e){e.clipInit||(e.start=t(e.elem).cssClip(),"string"==typeof e.end&&(e.end=s(e.end,e.elem)),e.clipInit=!0),t(e.elem).cssClip({top:e.pos*(e.end.top-e.start.top)+e.start.top,right:e.pos*(e.end.right-e.start.right)+e.start.right,bottom:e.pos*(e.end.bottom-e.start.bottom)+e.start.bottom,left:e.pos*(e.end.left-e.start.left)+e.start.left})}}(),function(){var e={};t.each(["Quad","Cubic","Quart","Quint","Expo"],function(t,i){e[i]=function(e){return Math.pow(e,t+2)}}),t.extend(e,{Sine:function(t){return 1-Math.cos(t*Math.PI/2)},Circ:function(t){return 1-Math.sqrt(1-t*t)},Elastic:function(t){return 0===t||1===t?t:-Math.pow(2,8*(t-1))*Math.sin((80*(t-1)-7.5)*Math.PI/15)},Back:function(t){return t*t*(3*t-2)},Bounce:function(t){for(var e,i=4;((e=Math.pow(2,--i))-1)/11>t;);return 1/Math.pow(4,3-i)-7.5625*Math.pow((3*e-2)/22-t,2)}}),t.each(e,function(e,i){t.easing["easeIn"+e]=i,t.easing["easeOut"+e]=function(t){return 1-i(1-t)},t.easing["easeInOut"+e]=function(t){return.5>t?i(2*t)/2:1-i(-2*t+2)/2}})}();var m=t.effects;t.effects.define("blind","hide",function(e,i){var s={up:["bottom","top"],vertical:["bottom","top"],down:["top","bottom"],left:["right","left"],horizontal:["right","left"],right:["left","right"]},n=t(this),o=e.direction||"up",a=n.cssClip(),r={clip:t.extend({},a)},l=t.effects.createPlaceholder(n);r.clip[s[o][0]]=r.clip[s[o][1]],"show"===e.mode&&(n.cssClip(r.clip),l&&l.css(t.effects.clipToBox(r)),r.clip=a),l&&l.animate(t.effects.clipToBox(r),e.duration,e.easing),n.animate(r,{queue:!1,duration:e.duration,easing:e.easing,complete:i})}),t.effects.define("bounce",function(e,i){var s,n,o,a=t(this),r=e.mode,l="hide"===r,h="show"===r,c=e.direction||"up",u=e.distance,d=e.times||5,p=2*d+(h||l?1:0),f=e.duration/p,g=e.easing,m="up"===c||"down"===c?"top":"left",_="up"===c||"left"===c,v=0,b=a.queue().length;for(t.effects.createPlaceholder(a),o=a.css(m),u||(u=a["top"===m?"outerHeight":"outerWidth"]()/3),h&&(n={opacity:1},n[m]=o,a.css("opacity",0).css(m,_?2*-u:2*u).animate(n,f,g)),l&&(u/=Math.pow(2,d-1)),n={},n[m]=o;d>v;v++)s={},s[m]=(_?"-=":"+=")+u,a.animate(s,f,g).animate(n,f,g),u=l?2*u:u/2;l&&(s={opacity:0},s[m]=(_?"-=":"+=")+u,a.animate(s,f,g)),a.queue(i),t.effects.unshift(a,b,p+1)}),t.effects.define("clip","hide",function(e,i){var s,n={},o=t(this),a=e.direction||"vertical",r="both"===a,l=r||"horizontal"===a,h=r||"vertical"===a;s=o.cssClip(),n.clip={top:h?(s.bottom-s.top)/2:s.top,right:l?(s.right-s.left)/2:s.right,bottom:h?(s.bottom-s.top)/2:s.bottom,left:l?(s.right-s.left)/2:s.left},t.effects.createPlaceholder(o),"show"===e.mode&&(o.cssClip(n.clip),n.clip=s),o.animate(n,{queue:!1,duration:e.duration,easing:e.easing,complete:i})}),t.effects.define("drop","hide",function(e,i){var s,n=t(this),o=e.mode,a="show"===o,r=e.direction||"left",l="up"===r||"down"===r?"top":"left",h="up"===r||"left"===r?"-=":"+=",c="+="===h?"-=":"+=",u={opacity:0};t.effects.createPlaceholder(n),s=e.distance||n["top"===l?"outerHeight":"outerWidth"](!0)/2,u[l]=h+s,a&&(n.css(u),u[l]=c+s,u.opacity=1),n.animate(u,{queue:!1,duration:e.duration,easing:e.easing,complete:i})}),t.effects.define("explode","hide",function(e,i){function s(){b.push(this),b.length===u*d&&n()}function n(){p.css({visibility:"visible"}),t(b).remove(),i()}var o,a,r,l,h,c,u=e.pieces?Math.round(Math.sqrt(e.pieces)):3,d=u,p=t(this),f=e.mode,g="show"===f,m=p.show().css("visibility","hidden").offset(),_=Math.ceil(p.outerWidth()/d),v=Math.ceil(p.outerHeight()/u),b=[];for(o=0;u>o;o++)for(l=m.top+o*v,c=o-(u-1)/2,a=0;d>a;a++)r=m.left+a*_,h=a-(d-1)/2,p.clone().appendTo("body").wrap("<div></div>").css({position:"absolute",visibility:"visible",left:-a*_,top:-o*v}).parent().addClass("ui-effects-explode").css({position:"absolute",overflow:"hidden",width:_,height:v,left:r+(g?h*_:0),top:l+(g?c*v:0),opacity:g?0:1}).animate({left:r+(g?0:h*_),top:l+(g?0:c*v),opacity:g?1:0},e.duration||500,e.easing,s)}),t.effects.define("fade","toggle",function(e,i){var s="show"===e.mode;t(this).css("opacity",s?0:1).animate({opacity:s?1:0},{queue:!1,duration:e.duration,easing:e.easing,complete:i})}),t.effects.define("fold","hide",function(e,i){var s=t(this),n=e.mode,o="show"===n,a="hide"===n,r=e.size||15,l=/([0-9]+)%/.exec(r),h=!!e.horizFirst,c=h?["right","bottom"]:["bottom","right"],u=e.duration/2,d=t.effects.createPlaceholder(s),p=s.cssClip(),f={clip:t.extend({},p)},g={clip:t.extend({},p)},m=[p[c[0]],p[c[1]]],_=s.queue().length;l&&(r=parseInt(l[1],10)/100*m[a?0:1]),f.clip[c[0]]=r,g.clip[c[0]]=r,g.clip[c[1]]=0,o&&(s.cssClip(g.clip),d&&d.css(t.effects.clipToBox(g)),g.clip=p),s.queue(function(i){d&&d.animate(t.effects.clipToBox(f),u,e.easing).animate(t.effects.clipToBox(g),u,e.easing),i()}).animate(f,u,e.easing).animate(g,u,e.easing).queue(i),t.effects.unshift(s,_,4)}),t.effects.define("highlight","show",function(e,i){var s=t(this),n={backgroundColor:s.css("backgroundColor")};"hide"===e.mode&&(n.opacity=0),t.effects.saveStyle(s),s.css({backgroundImage:"none",backgroundColor:e.color||"#ffff99"}).animate(n,{queue:!1,duration:e.duration,easing:e.easing,complete:i})}),t.effects.define("size",function(e,i){var s,n,o,a=t(this),r=["fontSize"],l=["borderTopWidth","borderBottomWidth","paddingTop","paddingBottom"],h=["borderLeftWidth","borderRightWidth","paddingLeft","paddingRight"],c=e.mode,u="effect"!==c,d=e.scale||"both",p=e.origin||["middle","center"],f=a.css("position"),g=a.position(),m=t.effects.scaledDimensions(a),_=e.from||m,v=e.to||t.effects.scaledDimensions(a,0);t.effects.createPlaceholder(a),"show"===c&&(o=_,_=v,v=o),n={from:{y:_.height/m.height,x:_.width/m.width},to:{y:v.height/m.height,x:v.width/m.width}},("box"===d||"both"===d)&&(n.from.y!==n.to.y&&(_=t.effects.setTransition(a,l,n.from.y,_),v=t.effects.setTransition(a,l,n.to.y,v)),n.from.x!==n.to.x&&(_=t.effects.setTransition(a,h,n.from.x,_),v=t.effects.setTransition(a,h,n.to.x,v))),("content"===d||"both"===d)&&n.from.y!==n.to.y&&(_=t.effects.setTransition(a,r,n.from.y,_),v=t.effects.setTransition(a,r,n.to.y,v)),p&&(s=t.effects.getBaseline(p,m),_.top=(m.outerHeight-_.outerHeight)*s.y+g.top,_.left=(m.outerWidth-_.outerWidth)*s.x+g.left,v.top=(m.outerHeight-v.outerHeight)*s.y+g.top,v.left=(m.outerWidth-v.outerWidth)*s.x+g.left),a.css(_),("content"===d||"both"===d)&&(l=l.concat(["marginTop","marginBottom"]).concat(r),h=h.concat(["marginLeft","marginRight"]),a.find("*[width]").each(function(){var i=t(this),s=t.effects.scaledDimensions(i),o={height:s.height*n.from.y,width:s.width*n.from.x,outerHeight:s.outerHeight*n.from.y,outerWidth:s.outerWidth*n.from.x},a={height:s.height*n.to.y,width:s.width*n.to.x,outerHeight:s.height*n.to.y,outerWidth:s.width*n.to.x};n.from.y!==n.to.y&&(o=t.effects.setTransition(i,l,n.from.y,o),a=t.effects.setTransition(i,l,n.to.y,a)),n.from.x!==n.to.x&&(o=t.effects.setTransition(i,h,n.from.x,o),a=t.effects.setTransition(i,h,n.to.x,a)),u&&t.effects.saveStyle(i),i.css(o),i.animate(a,e.duration,e.easing,function(){u&&t.effects.restoreStyle(i)})})),a.animate(v,{queue:!1,duration:e.duration,easing:e.easing,complete:function(){var e=a.offset();0===v.opacity&&a.css("opacity",_.opacity),u||(a.css("position","static"===f?"relative":f).offset(e),t.effects.saveStyle(a)),i()}})}),t.effects.define("scale",function(e,i){var s=t(this),n=e.mode,o=parseInt(e.percent,10)||(0===parseInt(e.percent,10)?0:"effect"!==n?0:100),a=t.extend(!0,{from:t.effects.scaledDimensions(s),to:t.effects.scaledDimensions(s,o,e.direction||"both"),origin:e.origin||["middle","center"]},e);e.fade&&(a.from.opacity=1,a.to.opacity=0),t.effects.effect.size.call(this,a,i)}),t.effects.define("puff","hide",function(e,i){var s=t.extend(!0,{},e,{fade:!0,percent:parseInt(e.percent,10)||150});t.effects.effect.scale.call(this,s,i)}),t.effects.define("pulsate","show",function(e,i){var s=t(this),n=e.mode,o="show"===n,a="hide"===n,r=o||a,l=2*(e.times||5)+(r?1:0),h=e.duration/l,c=0,u=1,d=s.queue().length;for((o||!s.is(":visible"))&&(s.css("opacity",0).show(),c=1);l>u;u++)s.animate({opacity:c},h,e.easing),c=1-c;s.animate({opacity:c},h,e.easing),s.queue(i),t.effects.unshift(s,d,l+1)}),t.effects.define("shake",function(e,i){var s=1,n=t(this),o=e.direction||"left",a=e.distance||20,r=e.times||3,l=2*r+1,h=Math.round(e.duration/l),c="up"===o||"down"===o?"top":"left",u="up"===o||"left"===o,d={},p={},f={},g=n.queue().length;for(t.effects.createPlaceholder(n),d[c]=(u?"-=":"+=")+a,p[c]=(u?"+=":"-=")+2*a,f[c]=(u?"-=":"+=")+2*a,n.animate(d,h,e.easing);r>s;s++)n.animate(p,h,e.easing).animate(f,h,e.easing);n.animate(p,h,e.easing).animate(d,h/2,e.easing).queue(i),t.effects.unshift(n,g,l+1)}),t.effects.define("slide","show",function(e,i){var s,n,o=t(this),a={up:["bottom","top"],down:["top","bottom"],left:["right","left"],right:["left","right"]},r=e.mode,l=e.direction||"left",h="up"===l||"down"===l?"top":"left",c="up"===l||"left"===l,u=e.distance||o["top"===h?"outerHeight":"outerWidth"](!0),d={};t.effects.createPlaceholder(o),s=o.cssClip(),n=o.position()[h],d[h]=(c?-1:1)*u+n,d.clip=o.cssClip(),d.clip[a[l][1]]=d.clip[a[l][0]],"show"===r&&(o.cssClip(d.clip),o.css(h,d[h]),d.clip=s,d[h]=n),o.animate(d,{queue:!1,duration:e.duration,easing:e.easing,complete:i})});var m;t.uiBackCompat!==!1&&(m=t.effects.define("transfer",function(e,i){t(this).transfer(e,i)}))});



/**
 * Class Inheritance
 * @param descendant
 * @param parent
 * @example viewer.js
 */
function inherits(descendant, parent) {
	var keys = [];

	// Only iterate the keys if we were given an object, and
	// a special check for null, as typeof null == "object"
	if (typeof parent === "object" && parent !== null) {	
		// Use a standard for in loop
		for (var x in parent) {
			// A for in will iterate over members on the prototype
			// chain as well, but Object.getOwnPropertyNames returns
			// only those directly on the object, so use hasOwnProperty.
			if (parent.hasOwnProperty(x)) {
				keys.push(x);
			}
		}
	}
	
	for (var i=0; i<keys.length; i++){
		descendant[keys[i]]=parent[keys[i]];
	}
	
	descendant["parent"]=parent;
};









if (!String.prototype.padStart){
	String.prototype.padStart = function padStart(targetLength,padString) {
		targetLength = targetLength>>0; //truncate if number or convert non-number to 0;
		padString = String((typeof padString !== 'undefined' ? padString : ' '));
		if (this.length > targetLength) {
			return String(this);
		}
		else {
			targetLength = targetLength-this.length;
			if (targetLength > padString.length) {
				padString += padString.repeat(targetLength/padString.length); //append to original to ensure we are longer than needed
			}
			return padString.slice(0,targetLength) + String(this);
		}
	};
}
 

/*! VelocityJS.org (1.2.3). (C) 2014 Julian Shapiro. MIT @license: en.wikipedia.org/wiki/MIT_License */
/*! VelocityJS.org jQuery Shim (1.0.1). (C) 2014 The jQuery Foundation. MIT @license: en.wikipedia.org/wiki/MIT_License. */
!function(a){function b(a){var b=a.length,d=c.type(a);return"function"===d||c.isWindow(a)?!1:1===a.nodeType&&b?!0:"array"===d||0===b||"number"==typeof b&&b>0&&b-1 in a}if (!a.jQuery){var c=function(a,b){return new c.fn.init(a,b)};c.isWindow=function(a){return null!=a&&a==a.window},c.type=function(a){return null==a?a+"":"object"==typeof a||"function"==typeof a?e[g.call(a)]||"object":typeof a},c.isArray=Array.isArray||function(a){return"array"===c.type(a)},c.isPlainObject=function(a){var b;if (!a||"object"!==c.type(a)||a.nodeType||c.isWindow(a))return!1;try{if (a.constructor&&!f.call(a,"constructor")&&!f.call(a.constructor.prototype,"isPrototypeOf"))return!1}catch(d){return!1}for(b in a);return void 0===b||f.call(a,b)},c.each=function(a,c,d){var e,f=0,g=a.length,h=b(a);if (d){if (h)for(;g>f&&(e=c.apply(a[f],d),e!==!1);f++);else for(f in a)if (e=c.apply(a[f],d),e===!1)break}else if (h)for(;g>f&&(e=c.call(a[f],f,a[f]),e!==!1);f++);else for(f in a)if (e=c.call(a[f],f,a[f]),e===!1)break;return a},c.data=function(a,b,e){if (void 0===e){var f=a[c.expando],g=f&&d[f];if (void 0===b)return g;if (g&&b in g)return g[b]}else if (void 0!==b){var f=a[c.expando]||(a[c.expando]=++c.uuid);return d[f]=d[f]||{},d[f][b]=e,e}},c.removeData=function(a,b){var e=a[c.expando],f=e&&d[e];f&&c.each(b,function(a,b){delete f[b]})},c.extend=function(){var a,b,d,e,f,g,h=arguments[0]||{},i=1,j=arguments.length,k=!1;for("boolean"==typeof h&&(k=h,h=arguments[i]||{},i++),"object"!=typeof h&&"function"!==c.type(h)&&(h={}),i===j&&(h=this,i--);j>i;i++)if (null!=(f=arguments[i]))for(e in f)a=h[e],d=f[e],h!==d&&(k&&d&&(c.isPlainObject(d)||(b=c.isArray(d)))?(b?(b=!1,g=a&&c.isArray(a)?a:[]):g=a&&c.isPlainObject(a)?a:{},h[e]=c.extend(k,g,d)):void 0!==d&&(h[e]=d));return h},c.queue=function(a,d,e){function f(a,c){var d=c||[];return null!=a&&(b(Object(a))?!function(a,b){for(var c=+b.length,d=0,e=a.length;c>d;)a[e++]=b[d++];if (c!==c)for(;void 0!==b[d];)a[e++]=b[d++];return a.length=e,a}(d,"string"==typeof a?[a]:a):[].push.call(d,a)),d}if (a){d=(d||"fx")+"queue";var g=c.data(a,d);return e?(!g||c.isArray(e)?g=c.data(a,d,f(e)):g.push(e),g):g||[]}},c.dequeue=function(a,b){c.each(a.nodeType?[a]:a,function(a,d){b=b||"fx";var e=c.queue(d,b),f=e.shift();"inprogress"===f&&(f=e.shift()),f&&("fx"===b&&e.unshift("inprogress"),f.call(d,function(){c.dequeue(d,b)}))})},c.fn=c.prototype={init:function(a){if (a.nodeType)return this[0]=a,this;throw new Error("Not a DOM node.")},offset:function(){var b=this[0].getBoundingClientRect?this[0].getBoundingClientRect():{top:0,left:0};return{top:b.top+(a.pageYOffset||document.scrollTop||0)-(document.clientTop||0),left:b.left+(a.pageXOffset||document.scrollLeft||0)-(document.clientLeft||0)}},position:function(){function a(){for(var a=this.offsetParent||document;a&&"html"===!a.nodeType.toLowerCase&&"static"===a.style.position;)a=a.offsetParent;return a||document}var b=this[0],a=a.apply(b),d=this.offset(),e=/^(?:body|html)$/i.test(a.nodeName)?{top:0,left:0}:c(a).offset();return d.top-=parseFloat(b.style.marginTop)||0,d.left-=parseFloat(b.style.marginLeft)||0,a.style&&(e.top+=parseFloat(a.style.borderTopWidth)||0,e.left+=parseFloat(a.style.borderLeftWidth)||0),{top:d.top-e.top,left:d.left-e.left}}};var d={};c.expando="velocity"+(new Date).getTime(),c.uuid=0;for(var e={},f=e.hasOwnProperty,g=e.toString,h="Boolean Number String Function Array Date RegExp Object Error".split(" "),i=0;i<h.length;i++)e["[object "+h[i]+"]"]=h[i].toLowerCase();c.fn.init.prototype=c.fn,a.Velocity={Utilities:c}}}(window),function(a){"object"==typeof module&&"object"==typeof module.exports?module.exports=a():"function"==typeof define&&define.amd?define(a):a()}(function(){return function(a,b,c,d){function e(a){for(var b=-1,c=a?a.length:0,d=[];++b<c;){var e=a[b];e&&d.push(e)}return d}function f(a){return p.isWrapped(a)?a=[].slice.call(a):p.isNode(a)&&(a=[a]),a}function g(a){var b=m.data(a,"velocity");return null===b?d:b}function h(a){return function(b){return Math.round(b*a)*(1/a)}}function i(a,c,d,e){function f(a,b){return 1-3*b+3*a}function g(a,b){return 3*b-6*a}function h(a){return 3*a}function i(a,b,c){return((f(b,c)*a+g(b,c))*a+h(b))*a}function j(a,b,c){return 3*f(b,c)*a*a+2*g(b,c)*a+h(b)}function k(b,c){for(var e=0;p>e;++e){var f=j(c,a,d);if (0===f)return c;var g=i(c,a,d)-b;c-=g/f}return c}function l(){for(var b=0;t>b;++b)x[b]=i(b*u,a,d)}function m(b,c,e){var f,g,h=0;do g=c+(e-c)/2,f=i(g,a,d)-b,f>0?e=g:c=g;while(Math.abs(f)>r&&++h<s);return g}function n(b){for(var c=0,e=1,f=t-1;e!=f&&x[e]<=b;++e)c+=u;--e;var g=(b-x[e])/(x[e+1]-x[e]),h=c+g*u,i=j(h,a,d);return i>=q?k(b,h):0==i?h:m(b,c,c+u)}function o(){y=!0,(a!=c||d!=e)&&l()}var p=4,q=.001,r=1e-7,s=10,t=11,u=1/(t-1),v="Float32Array"in b;if (4!==arguments.length)return!1;for(var w=0;4>w;++w)if ("number"!=typeof arguments[w]||isNaN(arguments[w])||!isFinite(arguments[w]))return!1;a=Math.min(a,1),d=Math.min(d,1),a=Math.max(a,0),d=Math.max(d,0);var x=v?new Float32Array(t):new Array(t),y=!1,z=function(b){return y||o(),a===c&&d===e?b:0===b?0:1===b?1:i(n(b),c,e)};z.getControlPoints=function(){return[{x:a,y:c},{x:d,y:e}]};var A="generateBezier("+[a,c,d,e]+")";return z.toString=function(){return A},z}function j(a,b){var c=a;return p.isString(a)?t.Easings[a]||(c=!1):c=p.isArray(a)&&1===a.length?h.apply(null,a):p.isArray(a)&&2===a.length?u.apply(null,a.concat([b])):p.isArray(a)&&4===a.length?i.apply(null,a):!1,c===!1&&(c=t.Easings[t.defaults.easing]?t.defaults.easing:s),c}function k(a){if (a){var b=(new Date).getTime(),c=t.State.calls.length;c>1e4&&(t.State.calls=e(t.State.calls));for(var f=0;c>f;f++)if (t.State.calls[f]){var h=t.State.calls[f],i=h[0],j=h[2],n=h[3],o=!!n,q=null;n||(n=t.State.calls[f][3]=b-16);for(var r=Math.min((b-n)/j.duration,1),s=0,u=i.length;u>s;s++){var w=i[s],y=w.element;if (g(y)){var z=!1;if (j.display!==d&&null!==j.display&&"none"!==j.display){if ("flex"===j.display){var A=["-webkit-box","-moz-box","-ms-flexbox","-webkit-flex"];m.each(A,function(a,b){v.setPropertyValue(y,"display",b)})}v.setPropertyValue(y,"display",j.display)}j.visibility!==d&&"hidden"!==j.visibility&&v.setPropertyValue(y,"visibility",j.visibility);for(var B in w)if ("element"!==B){var C,D=w[B],E=p.isString(D.easing)?t.Easings[D.easing]:D.easing;if (1===r)C=D.endValue;else{var F=D.endValue-D.startValue;if (C=D.startValue+F*E(r,j,F),!o&&C===D.currentValue)continue}if (D.currentValue=C,"tween"===B)q=C;else{if (v.Hooks.registered[B]){var G=v.Hooks.getRoot(B),H=g(y).rootPropertyValueCache[G];H&&(D.rootPropertyValue=H)}var I=v.setPropertyValue(y,B,D.currentValue+(0===parseFloat(C)?"":D.unitType),D.rootPropertyValue,D.scrollData);v.Hooks.registered[B]&&(g(y).rootPropertyValueCache[G]=v.Normalizations.registered[G]?v.Normalizations.registered[G]("extract",null,I[1]):I[1]),"transform"===I[0]&&(z=!0)}}j.mobileHA&&g(y).transformCache.translate3d===d&&(g(y).transformCache.translate3d="(0px, 0px, 0px)",z=!0),z&&v.flushTransformCache(y)}}j.display!==d&&"none"!==j.display&&(t.State.calls[f][2].display=!1),j.visibility!==d&&"hidden"!==j.visibility&&(t.State.calls[f][2].visibility=!1),j.progress&&j.progress.call(h[1],h[1],r,Math.max(0,n+j.duration-b),n,q),1===r&&l(f)}}t.State.isTicking&&x(k)}function l(a,b){if (!t.State.calls[a])return!1;for(var c=t.State.calls[a][0],e=t.State.calls[a][1],f=t.State.calls[a][2],h=t.State.calls[a][4],i=!1,j=0,k=c.length;k>j;j++){var l=c[j].element;if (b||f.loop||("none"===f.display&&v.setPropertyValue(l,"display",f.display),"hidden"===f.visibility&&v.setPropertyValue(l,"visibility",f.visibility)),f.loop!==!0&&(m.queue(l)[1]===d||!/\.velocityQueueEntryFlag/i.test(m.queue(l)[1]))&&g(l)){g(l).isAnimating=!1,g(l).rootPropertyValueCache={};var n=!1;m.each(v.Lists.transforms3D,function(a,b){var c=/^scale/.test(b)?1:0,e=g(l).transformCache[b];g(l).transformCache[b]!==d&&new RegExp("^\\("+c+"[^.]").test(e)&&(n=!0,delete g(l).transformCache[b])}),f.mobileHA&&(n=!0,delete g(l).transformCache.translate3d),n&&v.flushTransformCache(l),v.Values.removeClass(l,"velocity-animating")}if (!b&&f.complete&&!f.loop&&j===k-1)try{f.complete.call(e,e)}catch(o){setTimeout(function(){throw o},1)}h&&f.loop!==!0&&h(e),g(l)&&f.loop===!0&&!b&&(m.each(g(l).tweensContainer,function(a,b){/^rotate/.test(a)&&360===parseFloat(b.endValue)&&(b.endValue=0,b.startValue=360),/^backgroundPosition/.test(a)&&100===parseFloat(b.endValue)&&"%"===b.unitType&&(b.endValue=0,b.startValue=100)}),t(l,"reverse",{loop:!0,delay:f.delay})),f.queue!==!1&&m.dequeue(l,f.queue)}t.State.calls[a]=!1;for(var p=0,q=t.State.calls.length;q>p;p++)if (t.State.calls[p]!==!1){i=!0;break}i===!1&&(t.State.isTicking=!1,delete t.State.calls,t.State.calls=[])}var m,n=function(){if (c.documentMode)return c.documentMode;for(var a=7;a>4;a--){var b=c.createElement("div");if (b.innerHTML="<!--[if IE "+a+"]><span></span><![endif]-->",b.getElementsByTagName("span").length)return b=null,a}return d}(),o=function(){var a=0;return b.webkitRequestAnimationFrame||b.mozRequestAnimationFrame||function(b){var c,d=(new Date).getTime();return c=Math.max(0,16-(d-a)),a=d+c,setTimeout(function(){b(d+c)},c)}}(),p={isString:function(a){return"string"==typeof a},isArray:Array.isArray||function(a){return"[object Array]"===Object.prototype.toString.call(a)},isFunction:function(a){return"[object Function]"===Object.prototype.toString.call(a)},isNode:function(a){return a&&a.nodeType},isNodeList:function(a){return"object"==typeof a&&/^\[object (HTMLCollection|NodeList|Object)\]$/.test(Object.prototype.toString.call(a))&&a.length!==d&&(0===a.length||"object"==typeof a[0]&&a[0].nodeType>0)},isWrapped:function(a){return a&&(a.jquery||b.Zepto&&b.Zepto.zepto.isZ(a))},isSVG:function(a){return b.SVGElement&&a instanceof b.SVGElement},isEmptyObject:function(a){for(var b in a)return!1;return!0}},q=!1;if (a.fn&&a.fn.jquery?(m=a,q=!0):m=b.Velocity.Utilities,8>=n&&!q)throw new Error("Velocity: IE8 and below require jQuery to be loaded before Velocity.");if (7>=n)return void(jQuery.fn.velocity=jQuery.fn.animate);var r=400,s="swing",t={State:{isMobile:/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),isAndroid:/Android/i.test(navigator.userAgent),isGingerbread:/Android 2\.3\.[3-7]/i.test(navigator.userAgent),isChrome:b.chrome,isFirefox:/Firefox/i.test(navigator.userAgent),prefixElement:c.createElement("div"),prefixMatches:{},scrollAnchor:null,scrollPropertyLeft:null,scrollPropertyTop:null,isTicking:!1,calls:[]},CSS:{},Utilities:m,Redirects:{},Easings:{},Promise:b.Promise,defaults:{queue:"",duration:r,easing:s,begin:d,complete:d,progress:d,display:d,visibility:d,loop:!1,delay:!1,mobileHA:!0,_cacheValues:!0},init:function(a){m.data(a,"velocity",{isSVG:p.isSVG(a),isAnimating:!1,computedStyle:null,tweensContainer:null,rootPropertyValueCache:{},transformCache:{}})},hook:null,mock:!1,version:{major:1,minor:2,patch:2},debug:!1};b.pageYOffset!==d?(t.State.scrollAnchor=b,t.State.scrollPropertyLeft="pageXOffset",t.State.scrollPropertyTop="pageYOffset"):(t.State.scrollAnchor=c.documentElement||c.body.parentNode||c.body,t.State.scrollPropertyLeft="scrollLeft",t.State.scrollPropertyTop="scrollTop");var u=function(){function a(a){return-a.tension*a.x-a.friction*a.v}function b(b,c,d){var e={x:b.x+d.dx*c,v:b.v+d.dv*c,tension:b.tension,friction:b.friction};return{dx:e.v,dv:a(e)}}function c(c,d){var e={dx:c.v,dv:a(c)},f=b(c,.5*d,e),g=b(c,.5*d,f),h=b(c,d,g),i=1/6*(e.dx+2*(f.dx+g.dx)+h.dx),j=1/6*(e.dv+2*(f.dv+g.dv)+h.dv);return c.x=c.x+i*d,c.v=c.v+j*d,c}return function d(a,b,e){var f,g,h,i={x:-1,v:0,tension:null,friction:null},j=[0],k=0,l=1e-4,m=.016;for(a=parseFloat(a)||500,b=parseFloat(b)||20,e=e||null,i.tension=a,i.friction=b,f=null!==e,f?(k=d(a,b),g=k/e*m):g=m;;)if (h=c(h||i,g),j.push(1+h.x),k+=16,!(Math.abs(h.x)>l&&Math.abs(h.v)>l))break;return f?function(a){return j[a*(j.length-1)|0]}:k}}();t.Easings={linear:function(a){return a},swing:function(a){return.5-Math.cos(a*Math.PI)/2},spring:function(a){return 1-Math.cos(4.5*a*Math.PI)*Math.exp(6*-a)}},m.each([["ease",[.25,.1,.25,1]],["ease-in",[.42,0,1,1]],["ease-out",[0,0,.58,1]],["ease-in-out",[.42,0,.58,1]],["easeInSine",[.47,0,.745,.715]],["easeOutSine",[.39,.575,.565,1]],["easeInOutSine",[.445,.05,.55,.95]],["easeInQuad",[.55,.085,.68,.53]],["easeOutQuad",[.25,.46,.45,.94]],["easeInOutQuad",[.455,.03,.515,.955]],["easeInCubic",[.55,.055,.675,.19]],["easeOutCubic",[.215,.61,.355,1]],["easeInOutCubic",[.645,.045,.355,1]],["easeInQuart",[.895,.03,.685,.22]],["easeOutQuart",[.165,.84,.44,1]],["easeInOutQuart",[.77,0,.175,1]],["easeInQuint",[.755,.05,.855,.06]],["easeOutQuint",[.23,1,.32,1]],["easeInOutQuint",[.86,0,.07,1]],["easeInExpo",[.95,.05,.795,.035]],["easeOutExpo",[.19,1,.22,1]],["easeInOutExpo",[1,0,0,1]],["easeInCirc",[.6,.04,.98,.335]],["easeOutCirc",[.075,.82,.165,1]],["easeInOutCirc",[.785,.135,.15,.86]]],function(a,b){t.Easings[b[0]]=i.apply(null,b[1])});var v=t.CSS={RegEx:{isHex:/^#([A-f\d]{3}){1,2}$/i,valueUnwrap:/^[A-z]+\((.*)\)$/i,wrappedValueAlreadyExtracted:/[0-9.]+ [0-9.]+ [0-9.]+( [0-9.]+)?/,valueSplit:/([A-z]+\(.+\))|(([A-z0-9#-.]+?)(?=\s|$))/gi},Lists:{colors:["fill","stroke","stopColor","color","backgroundColor","borderColor","borderTopColor","borderRightColor","borderBottomColor","borderLeftColor","outlineColor"],transformsBase:["translateX","translateY","scale","scaleX","scaleY","skewX","skewY","rotateZ"],transforms3D:["transformPerspective","translateZ","scaleZ","rotateX","rotateY"]},Hooks:{templates:{textShadow:["Color X Y Blur","black 0px 0px 0px"],boxShadow:["Color X Y Blur Spread","black 0px 0px 0px 0px"],clip:["Top Right Bottom Left","0px 0px 0px 0px"],backgroundPosition:["X Y","0% 0%"],transformOrigin:["X Y Z","50% 50% 0px"],perspectiveOrigin:["X Y","50% 50%"]},registered:{},register:function(){for(var a=0;a<v.Lists.colors.length;a++){var b="color"===v.Lists.colors[a]?"0 0 0 1":"255 255 255 1";v.Hooks.templates[v.Lists.colors[a]]=["Red Green Blue Alpha",b]}var c,d,e;if (n)for(c in v.Hooks.templates){d=v.Hooks.templates[c],e=d[0].split(" ");var f=d[1].match(v.RegEx.valueSplit);"Color"===e[0]&&(e.push(e.shift()),f.push(f.shift()),v.Hooks.templates[c]=[e.join(" "),f.join(" ")])}for(c in v.Hooks.templates){d=v.Hooks.templates[c],e=d[0].split(" ");for(var a in e){var g=c+e[a],h=a;v.Hooks.registered[g]=[c,h]}}},getRoot:function(a){var b=v.Hooks.registered[a];return b?b[0]:a},cleanRootPropertyValue:function(a,b){return v.RegEx.valueUnwrap.test(b)&&(b=b.match(v.RegEx.valueUnwrap)[1]),v.Values.isCSSNullValue(b)&&(b=v.Hooks.templates[a][1]),b},extractValue:function(a,b){var c=v.Hooks.registered[a];if (c){var d=c[0],e=c[1];return b=v.Hooks.cleanRootPropertyValue(d,b),b.toString().match(v.RegEx.valueSplit)[e]}return b},injectValue:function(a,b,c){var d=v.Hooks.registered[a];if (d){var e,f,g=d[0],h=d[1];return c=v.Hooks.cleanRootPropertyValue(g,c),e=c.toString().match(v.RegEx.valueSplit),e[h]=b,f=e.join(" ")}return c}},Normalizations:{registered:{clip:function(a,b,c){switch(a){case"name":return"clip";case"extract":var d;return v.RegEx.wrappedValueAlreadyExtracted.test(c)?d=c:(d=c.toString().match(v.RegEx.valueUnwrap),d=d?d[1].replace(/,(\s+)?/g," "):c),d;case"inject":return"rect("+c+")"}},blur:function(a,b,c){switch(a){case"name":return t.State.isFirefox?"filter":"-webkit-filter";case"extract":var d=parseFloat(c);if (!d&&0!==d){var e=c.toString().match(/blur\(([0-9]+[A-z]+)\)/i);d=e?e[1]:0}return d;case"inject":return parseFloat(c)?"blur("+c+")":"none"}},opacity:function(a,b,c){if (8>=n)switch(a){case"name":return"filter";case"extract":var d=c.toString().match(/alpha\(opacity=(.*)\)/i);return c=d?d[1]/100:1;case"inject":return b.style.zoom=1,parseFloat(c)>=1?"":"alpha(opacity="+parseInt(100*parseFloat(c),10)+")"}else switch(a){case"name":return"opacity";case"extract":return c;case"inject":return c}}},register:function(){9>=n||t.State.isGingerbread||(v.Lists.transformsBase=v.Lists.transformsBase.concat(v.Lists.transforms3D));for(var a=0;a<v.Lists.transformsBase.length;a++)!function(){var b=v.Lists.transformsBase[a];v.Normalizations.registered[b]=function(a,c,e){switch(a){case"name":return"transform";case"extract":return g(c)===d||g(c).transformCache[b]===d?/^scale/i.test(b)?1:0:g(c).transformCache[b].replace(/[()]/g,"");case"inject":var f=!1;switch(b.substr(0,b.length-1)){case"translate":f=!/(%|px|em|rem|vw|vh|\d)$/i.test(e);break;case"scal":case"scale":t.State.isAndroid&&g(c).transformCache[b]===d&&1>e&&(e=1),f=!/(\d)$/i.test(e);break;case"skew":f=!/(deg|\d)$/i.test(e);break;case"rotate":f=!/(deg|\d)$/i.test(e)}return f||(g(c).transformCache[b]="("+e+")"),g(c).transformCache[b]}}}();for(var a=0;a<v.Lists.colors.length;a++)!function(){var b=v.Lists.colors[a];v.Normalizations.registered[b]=function(a,c,e){switch(a){case"name":return b;case"extract":var f;if (v.RegEx.wrappedValueAlreadyExtracted.test(e))f=e;else{var g,h={black:"rgb(0, 0, 0)",blue:"rgb(0, 0, 255)",gray:"rgb(128, 128, 128)",green:"rgb(0, 128, 0)",red:"rgb(255, 0, 0)",white:"rgb(255, 255, 255)"};/^[A-z]+$/i.test(e)?g=h[e]!==d?h[e]:h.black:v.RegEx.isHex.test(e)?g="rgb("+v.Values.hexToRgb(e).join(" ")+")":/^rgba?\(/i.test(e)||(g=h.black),f=(g||e).toString().match(v.RegEx.valueUnwrap)[1].replace(/,(\s+)?/g," ")}return 8>=n||3!==f.split(" ").length||(f+=" 1"),f;case"inject":return 8>=n?4===e.split(" ").length&&(e=e.split(/\s+/).slice(0,3).join(" ")):3===e.split(" ").length&&(e+=" 1"),(8>=n?"rgb":"rgba")+"("+e.replace(/\s+/g,",").replace(/\.(\d)+(?=,)/g,"")+")"}}}()}},Names:{camelCase:function(a){return a.replace(/-(\w)/g,function(a,b){return b.toUpperCase()})},SVGAttribute:function(a){var b="width|height|x|y|cx|cy|r|rx|ry|x1|x2|y1|y2";return(n||t.State.isAndroid&&!t.State.isChrome)&&(b+="|transform"),new RegExp("^("+b+")$","i").test(a)},prefixCheck:function(a){if (t.State.prefixMatches[a])return[t.State.prefixMatches[a],!0];for(var b=["","Webkit","Moz","ms","O"],c=0,d=b.length;d>c;c++){var e;if (e=0===c?a:b[c]+a.replace(/^\w/,function(a){return a.toUpperCase()}),p.isString(t.State.prefixElement.style[e]))return t.State.prefixMatches[a]=e,[e,!0]}return[a,!1]}},Values:{hexToRgb:function(a){var b,c=/^#?([a-f\d])([a-f\d])([a-f\d])$/i,d=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i;return a=a.replace(c,function(a,b,c,d){return b+b+c+c+d+d}),b=d.exec(a),b?[parseInt(b[1],16),parseInt(b[2],16),parseInt(b[3],16)]:[0,0,0]},isCSSNullValue:function(a){return 0==a||/^(none|auto|transparent|(rgba\(0, ?0, ?0, ?0\)))$/i.test(a)},getUnitType:function(a){return/^(rotate|skew)/i.test(a)?"deg":/(^(scale|scaleX|scaleY|scaleZ|alpha|flexGrow|flexHeight|zIndex|fontWeight)$)|((opacity|red|green|blue|alpha)$)/i.test(a)?"":"px"},getDisplayType:function(a){var b=a&&a.tagName.toString().toLowerCase();return/^(b|big|i|small|tt|abbr|acronym|cite|code|dfn|em|kbd|strong|samp|var|a|bdo|br|img|map|object|q|script|span|sub|sup|button|input|label|select|textarea)$/i.test(b)?"inline":/^(li)$/i.test(b)?"list-item":/^(tr)$/i.test(b)?"table-row":/^(table)$/i.test(b)?"table":/^(tbody)$/i.test(b)?"table-row-group":"block"},addClass:function(a,b){a.classList?a.classList.add(b):a.className+=(a.className.length?" ":"")+b},removeClass:function(a,b){a.classList?a.classList.remove(b):a.className=a.className.toString().replace(new RegExp("(^|\\s)"+b.split(" ").join("|")+"(\\s|$)","gi")," ")}},getPropertyValue:function(a,c,e,f){function h(a,c){function e(){j&&v.setPropertyValue(a,"display","none")}var i=0;if (8>=n)i=m.css(a,c);else{var j=!1;if (/^(width|height)$/.test(c)&&0===v.getPropertyValue(a,"display")&&(j=!0,v.setPropertyValue(a,"display",v.Values.getDisplayType(a))),!f){if ("height"===c&&"border-box"!==v.getPropertyValue(a,"boxSizing").toString().toLowerCase()){var k=a.offsetHeight-(parseFloat(v.getPropertyValue(a,"borderTopWidth"))||0)-(parseFloat(v.getPropertyValue(a,"borderBottomWidth"))||0)-(parseFloat(v.getPropertyValue(a,"paddingTop"))||0)-(parseFloat(v.getPropertyValue(a,"paddingBottom"))||0);return e(),k}if ("width"===c&&"border-box"!==v.getPropertyValue(a,"boxSizing").toString().toLowerCase()){var l=a.offsetWidth-(parseFloat(v.getPropertyValue(a,"borderLeftWidth"))||0)-(parseFloat(v.getPropertyValue(a,"borderRightWidth"))||0)-(parseFloat(v.getPropertyValue(a,"paddingLeft"))||0)-(parseFloat(v.getPropertyValue(a,"paddingRight"))||0);return e(),l}}var o;o=g(a)===d?b.getComputedStyle(a,null):g(a).computedStyle?g(a).computedStyle:g(a).computedStyle=b.getComputedStyle(a,null),"borderColor"===c&&(c="borderTopColor"),i=9===n&&"filter"===c?o.getPropertyValue(c):o[c],(""===i||null===i)&&(i=a.style[c]),e()}if ("auto"===i&&/^(top|right|bottom|left)$/i.test(c)){var p=h(a,"position");("fixed"===p||"absolute"===p&&/top|left/i.test(c))&&(i=m(a).position()[c]+"px")}return i}var i;if (v.Hooks.registered[c]){var j=c,k=v.Hooks.getRoot(j);e===d&&(e=v.getPropertyValue(a,v.Names.prefixCheck(k)[0])),v.Normalizations.registered[k]&&(e=v.Normalizations.registered[k]("extract",a,e)),i=v.Hooks.extractValue(j,e)}else if (v.Normalizations.registered[c]){var l,o;l=v.Normalizations.registered[c]("name",a),"transform"!==l&&(o=h(a,v.Names.prefixCheck(l)[0]),v.Values.isCSSNullValue(o)&&v.Hooks.templates[c]&&(o=v.Hooks.templates[c][1])),i=v.Normalizations.registered[c]("extract",a,o)}if (!/^[\d-]/.test(i))if (g(a)&&g(a).isSVG&&v.Names.SVGAttribute(c))if (/^(height|width)$/i.test(c))try{i=a.getBBox()[c]}catch(p){i=0}else i=a.getAttribute(c);else i=h(a,v.Names.prefixCheck(c)[0]);return v.Values.isCSSNullValue(i)&&(i=0),t.debug>=2&&console.log("Get "+c+": "+i),i},setPropertyValue:function(a,c,d,e,f){var h=c;if ("scroll"===c)f.container?f.container["scroll"+f.direction]=d:"Left"===f.direction?b.scrollTo(d,f.alternateValue):b.scrollTo(f.alternateValue,d);else if (v.Normalizations.registered[c]&&"transform"===v.Normalizations.registered[c]("name",a))v.Normalizations.registered[c]("inject",a,d),h="transform",d=g(a).transformCache[c];else{if (v.Hooks.registered[c]){var i=c,j=v.Hooks.getRoot(c);e=e||v.getPropertyValue(a,j),d=v.Hooks.injectValue(i,d,e),c=j}if (v.Normalizations.registered[c]&&(d=v.Normalizations.registered[c]("inject",a,d),c=v.Normalizations.registered[c]("name",a)),h=v.Names.prefixCheck(c)[0],8>=n)try{a.style[h]=d}catch(k){t.debug&&console.log("Browser does not support ["+d+"] for ["+h+"]")}else g(a)&&g(a).isSVG&&v.Names.SVGAttribute(c)?a.setAttribute(c,d):a.style[h]=d;t.debug>=2&&console.log("Set "+c+" ("+h+"): "+d)}return[h,d]},flushTransformCache:function(a){function b(b){return parseFloat(v.getPropertyValue(a,b))}var c="";if ((n||t.State.isAndroid&&!t.State.isChrome)&&g(a).isSVG){var d={translate:[b("translateX"),b("translateY")],skewX:[b("skewX")],skewY:[b("skewY")],scale:1!==b("scale")?[b("scale"),b("scale")]:[b("scaleX"),b("scaleY")],rotate:[b("rotateZ"),0,0]};m.each(g(a).transformCache,function(a){/^translate/i.test(a)?a="translate":/^scale/i.test(a)?a="scale":/^rotate/i.test(a)&&(a="rotate"),d[a]&&(c+=a+"("+d[a].join(" ")+") ",delete d[a])})}else{var e,f;m.each(g(a).transformCache,function(b){return e=g(a).transformCache[b],"transformPerspective"===b?(f=e,!0):(9===n&&"rotateZ"===b&&(b="rotate"),void(c+=b+e+" "))}),f&&(c="perspective"+f+" "+c)}v.setPropertyValue(a,"transform",c)}};v.Hooks.register(),v.Normalizations.register(),t.hook=function(a,b,c){var e=d;return a=f(a),m.each(a,function(a,f){if (g(f)===d&&t.init(f),c===d)e===d&&(e=t.CSS.getPropertyValue(f,b));else{var h=t.CSS.setPropertyValue(f,b,c);"transform"===h[0]&&t.CSS.flushTransformCache(f),e=h}}),e};var w=function(){function a(){return h?B.promise||null:i}function e(){function a(){function a(a,b){var c=d,e=d,g=d;return p.isArray(a)?(c=a[0],!p.isArray(a[1])&&/^[\d-]/.test(a[1])||p.isFunction(a[1])||v.RegEx.isHex.test(a[1])?g=a[1]:(p.isString(a[1])&&!v.RegEx.isHex.test(a[1])||p.isArray(a[1]))&&(e=b?a[1]:j(a[1],h.duration),a[2]!==d&&(g=a[2]))):c=a,b||(e=e||h.easing),p.isFunction(c)&&(c=c.call(f,y,x)),p.isFunction(g)&&(g=g.call(f,y,x)),[c||0,e,g]}function l(a,b){var c,d;return d=(b||"0").toString().toLowerCase().replace(/[%A-z]+$/,function(a){return c=a,""}),c||(c=v.Values.getUnitType(a)),[d,c]}function n(){var a={myParent:f.parentNode||c.body,position:v.getPropertyValue(f,"position"),fontSize:v.getPropertyValue(f,"fontSize")},d=a.position===I.lastPosition&&a.myParent===I.lastParent,e=a.fontSize===I.lastFontSize;I.lastParent=a.myParent,I.lastPosition=a.position,I.lastFontSize=a.fontSize;var h=100,i={};if (e&&d)i.emToPx=I.lastEmToPx,i.percentToPxWidth=I.lastPercentToPxWidth,i.percentToPxHeight=I.lastPercentToPxHeight;else{var j=g(f).isSVG?c.createElementNS("http://www.w3.org/2000/svg","rect"):c.createElement("div");t.init(j),a.myParent.appendChild(j),m.each(["overflow","overflowX","overflowY"],function(a,b){t.CSS.setPropertyValue(j,b,"hidden")}),t.CSS.setPropertyValue(j,"position",a.position),t.CSS.setPropertyValue(j,"fontSize",a.fontSize),t.CSS.setPropertyValue(j,"boxSizing","content-box"),m.each(["minWidth","maxWidth","width","minHeight","maxHeight","height"],function(a,b){t.CSS.setPropertyValue(j,b,h+"%")}),t.CSS.setPropertyValue(j,"paddingLeft",h+"em"),i.percentToPxWidth=I.lastPercentToPxWidth=(parseFloat(v.getPropertyValue(j,"width",null,!0))||1)/h,i.percentToPxHeight=I.lastPercentToPxHeight=(parseFloat(v.getPropertyValue(j,"height",null,!0))||1)/h,i.emToPx=I.lastEmToPx=(parseFloat(v.getPropertyValue(j,"paddingLeft"))||1)/h,a.myParent.removeChild(j)}return null===I.remToPx&&(I.remToPx=parseFloat(v.getPropertyValue(c.body,"fontSize"))||16),null===I.vwToPx&&(I.vwToPx=parseFloat(b.innerWidth)/100,I.vhToPx=parseFloat(b.innerHeight)/100),i.remToPx=I.remToPx,i.vwToPx=I.vwToPx,i.vhToPx=I.vhToPx,t.debug>=1&&console.log("Unit ratios: "+JSON.stringify(i),f),i}if (h.begin&&0===y)try{h.begin.call(o,o)}catch(r){setTimeout(function(){throw r},1)}if ("scroll"===C){var u,w,z,A=/^x$/i.test(h.axis)?"Left":"Top",D=parseFloat(h.offset)||0;h.container?p.isWrapped(h.container)||p.isNode(h.container)?(h.container=h.container[0]||h.container,u=h.container["scroll"+A],z=u+m(f).position()[A.toLowerCase()]+D):h.container=null:(u=t.State.scrollAnchor[t.State["scrollProperty"+A]],w=t.State.scrollAnchor[t.State["scrollProperty"+("Left"===A?"Top":"Left")]],z=m(f).offset()[A.toLowerCase()]+D),i={scroll:{rootPropertyValue:!1,startValue:u,currentValue:u,endValue:z,unitType:"",easing:h.easing,scrollData:{container:h.container,direction:A,alternateValue:w}},element:f},t.debug&&console.log("tweensContainer (scroll): ",i.scroll,f)}else if ("reverse"===C){if (!g(f).tweensContainer)return void m.dequeue(f,h.queue);"none"===g(f).opts.display&&(g(f).opts.display="auto"),"hidden"===g(f).opts.visibility&&(g(f).opts.visibility="visible"),g(f).opts.loop=!1,g(f).opts.begin=null,g(f).opts.complete=null,s.easing||delete h.easing,s.duration||delete h.duration,h=m.extend({},g(f).opts,h);var E=m.extend(!0,{},g(f).tweensContainer);for(var F in E)if ("element"!==F){var G=E[F].startValue;E[F].startValue=E[F].currentValue=E[F].endValue,E[F].endValue=G,p.isEmptyObject(s)||(E[F].easing=h.easing),t.debug&&console.log("reverse tweensContainer ("+F+"): "+JSON.stringify(E[F]),f)}i=E}else if ("start"===C){var E;g(f).tweensContainer&&g(f).isAnimating===!0&&(E=g(f).tweensContainer),m.each(q,function(b,c){if (RegExp("^"+v.Lists.colors.join("$|^")+"$").test(b)){var e=a(c,!0),f=e[0],g=e[1],h=e[2];if (v.RegEx.isHex.test(f)){for(var i=["Red","Green","Blue"],j=v.Values.hexToRgb(f),k=h?v.Values.hexToRgb(h):d,l=0;l<i.length;l++){var m=[j[l]];g&&m.push(g),k!==d&&m.push(k[l]),q[b+i[l]]=m}delete q[b]}}});for(var H in q){var K=a(q[H]),L=K[0],M=K[1],N=K[2];H=v.Names.camelCase(H);var O=v.Hooks.getRoot(H),P=!1;if (g(f).isSVG||"tween"===O||v.Names.prefixCheck(O)[1]!==!1||v.Normalizations.registered[O]!==d){(h.display!==d&&null!==h.display&&"none"!==h.display||h.visibility!==d&&"hidden"!==h.visibility)&&/opacity|filter/.test(H)&&!N&&0!==L&&(N=0),h._cacheValues&&E&&E[H]?(N===d&&(N=E[H].endValue+E[H].unitType),P=g(f).rootPropertyValueCache[O]):v.Hooks.registered[H]?N===d?(P=v.getPropertyValue(f,O),N=v.getPropertyValue(f,H,P)):P=v.Hooks.templates[O][1]:N===d&&(N=v.getPropertyValue(f,H));var Q,R,S,T=!1;if (Q=l(H,N),N=Q[0],S=Q[1],Q=l(H,L),L=Q[0].replace(/^([+-\/*])=/,function(a,b){return T=b,""}),R=Q[1],N=parseFloat(N)||0,L=parseFloat(L)||0,"%"===R&&(/^(fontSize|lineHeight)$/.test(H)?(L/=100,R="em"):/^scale/.test(H)?(L/=100,R=""):/(Red|Green|Blue)$/i.test(H)&&(L=L/100*255,R="")),/[\/*]/.test(T))R=S;else if (S!==R&&0!==N)if (0===L)R=S;else{e=e||n();var U=/margin|padding|left|right|width|text|word|letter/i.test(H)||/X$/.test(H)||"x"===H?"x":"y";switch(S){case"%":N*="x"===U?e.percentToPxWidth:e.percentToPxHeight;break;case"px":break;default:N*=e[S+"ToPx"]}switch(R){case"%":N*=1/("x"===U?e.percentToPxWidth:e.percentToPxHeight);break;case"px":break;default:N*=1/e[R+"ToPx"]}}switch(T){case"+":L=N+L;break;case"-":L=N-L;break;case"*":L=N*L;break;case"/":L=N/L}i[H]={rootPropertyValue:P,startValue:N,currentValue:N,endValue:L,unitType:R,easing:M},t.debug&&console.log("tweensContainer ("+H+"): "+JSON.stringify(i[H]),f)}else t.debug&&console.log("Skipping ["+O+"] due to a lack of browser support.")}i.element=f}i.element&&(v.Values.addClass(f,"velocity-animating"),J.push(i),""===h.queue&&(g(f).tweensContainer=i,g(f).opts=h),g(f).isAnimating=!0,y===x-1?(t.State.calls.push([J,o,h,null,B.resolver]),t.State.isTicking===!1&&(t.State.isTicking=!0,k())):y++)}var e,f=this,h=m.extend({},t.defaults,s),i={};switch(g(f)===d&&t.init(f),parseFloat(h.delay)&&h.queue!==!1&&m.queue(f,h.queue,function(a){t.velocityQueueEntryFlag=!0,g(f).delayTimer={setTimeout:setTimeout(a,parseFloat(h.delay)),next:a}}),h.duration.toString().toLowerCase()){case"fast":h.duration=200;break;case"normal":h.duration=r;break;case"slow":h.duration=600;break;default:h.duration=parseFloat(h.duration)||1}t.mock!==!1&&(t.mock===!0?h.duration=h.delay=1:(h.duration*=parseFloat(t.mock)||1,h.delay*=parseFloat(t.mock)||1)),h.easing=j(h.easing,h.duration),h.begin&&!p.isFunction(h.begin)&&(h.begin=null),h.progress&&!p.isFunction(h.progress)&&(h.progress=null),h.complete&&!p.isFunction(h.complete)&&(h.complete=null),h.display!==d&&null!==h.display&&(h.display=h.display.toString().toLowerCase(),"auto"===h.display&&(h.display=t.CSS.Values.getDisplayType(f))),h.visibility!==d&&null!==h.visibility&&(h.visibility=h.visibility.toString().toLowerCase()),h.mobileHA=h.mobileHA&&t.State.isMobile&&!t.State.isGingerbread,h.queue===!1?h.delay?setTimeout(a,h.delay):a():m.queue(f,h.queue,function(b,c){return c===!0?(B.promise&&B.resolver(o),!0):(t.velocityQueueEntryFlag=!0,void a(b))}),""!==h.queue&&"fx"!==h.queue||"inprogress"===m.queue(f)[0]||m.dequeue(f)}var h,i,n,o,q,s,u=arguments[0]&&(arguments[0].p||m.isPlainObject(arguments[0].properties)&&!arguments[0].properties.names||p.isString(arguments[0].properties));if (p.isWrapped(this)?(h=!1,n=0,o=this,i=this):(h=!0,n=1,o=u?arguments[0].elements||arguments[0].e:arguments[0]),o=f(o)){u?(q=arguments[0].properties||arguments[0].p,s=arguments[0].options||arguments[0].o):(q=arguments[n],s=arguments[n+1]);var x=o.length,y=0;if (!/^(stop|finish|finishAll)$/i.test(q)&&!m.isPlainObject(s)){var z=n+1;s={};for(var A=z;A<arguments.length;A++)p.isArray(arguments[A])||!/^(fast|normal|slow)$/i.test(arguments[A])&&!/^\d/.test(arguments[A])?p.isString(arguments[A])||p.isArray(arguments[A])?s.easing=arguments[A]:p.isFunction(arguments[A])&&(s.complete=arguments[A]):s.duration=arguments[A]}var B={promise:null,resolver:null,rejecter:null};h&&t.Promise&&(B.promise=new t.Promise(function(a,b){B.resolver=a,B.rejecter=b}));var C;switch(q){case"scroll":C="scroll";break;case"reverse":C="reverse";break;case"finish":case"finishAll":case"stop":m.each(o,function(a,b){g(b)&&g(b).delayTimer&&(clearTimeout(g(b).delayTimer.setTimeout),g(b).delayTimer.next&&g(b).delayTimer.next(),delete g(b).delayTimer),"finishAll"!==q||s!==!0&&!p.isString(s)||(m.each(m.queue(b,p.isString(s)?s:""),function(a,b){p.isFunction(b)&&b()}),m.queue(b,p.isString(s)?s:"",[]))});var D=[];return m.each(t.State.calls,function(a,b){b&&m.each(b[1],function(c,e){var f=s===d?"":s;return f===!0||b[2].queue===f||s===d&&b[2].queue===!1?void m.each(o,function(c,d){d===e&&((s===!0||p.isString(s))&&(m.each(m.queue(d,p.isString(s)?s:""),function(a,b){p.isFunction(b)&&b(null,!0)
}),m.queue(d,p.isString(s)?s:"",[])),"stop"===q?(g(d)&&g(d).tweensContainer&&f!==!1&&m.each(g(d).tweensContainer,function(a,b){b.endValue=b.currentValue}),D.push(a)):("finish"===q||"finishAll"===q)&&(b[2].duration=1))}):!0})}),"stop"===q&&(m.each(D,function(a,b){l(b,!0)}),B.promise&&B.resolver(o)),a();default:if (!m.isPlainObject(q)||p.isEmptyObject(q)){if (p.isString(q)&&t.Redirects[q]){var E=m.extend({},s),F=E.duration,G=E.delay||0;return E.backwards===!0&&(o=m.extend(!0,[],o).reverse()),m.each(o,function(a,b){parseFloat(E.stagger)?E.delay=G+parseFloat(E.stagger)*a:p.isFunction(E.stagger)&&(E.delay=G+E.stagger.call(b,a,x)),E.drag&&(E.duration=parseFloat(F)||(/^(callout|transition)/.test(q)?1e3:r),E.duration=Math.max(E.duration*(E.backwards?1-a/x:(a+1)/x),.75*E.duration,200)),t.Redirects[q].call(b,b,E||{},a,x,o,B.promise?B:d)}),a()}var H="Velocity: First argument ("+q+") was not a property map, a known action, or a registered redirect. Aborting.";return B.promise?B.rejecter(new Error(H)):console.log(H),a()}C="start"}var I={lastParent:null,lastPosition:null,lastFontSize:null,lastPercentToPxWidth:null,lastPercentToPxHeight:null,lastEmToPx:null,remToPx:null,vwToPx:null,vhToPx:null},J=[];m.each(o,function(a,b){p.isNode(b)&&e.call(b)});var K,E=m.extend({},t.defaults,s);if (E.loop=parseInt(E.loop),K=2*E.loop-1,E.loop)for(var L=0;K>L;L++){var M={delay:E.delay,progress:E.progress};L===K-1&&(M.display=E.display,M.visibility=E.visibility,M.complete=E.complete),w(o,"reverse",M)}return a()}};t=m.extend(w,t),t.animate=w;var x=b.requestAnimationFrame||o;return t.State.isMobile||c.hidden===d||c.addEventListener("visibilitychange",function(){c.hidden?(x=function(a){return setTimeout(function(){a(!0)},16)},k()):x=b.requestAnimationFrame||o}),a.Velocity=t,a!==b&&(a.fn.velocity=w,a.fn.velocity.defaults=t.defaults),m.each(["Down","Up"],function(a,b){t.Redirects["slide"+b]=function(a,c,e,f,g,h){var i=m.extend({},c),j=i.begin,k=i.complete,l={height:"",marginTop:"",marginBottom:"",paddingTop:"",paddingBottom:""},n={};i.display===d&&(i.display="Down"===b?"inline"===t.CSS.Values.getDisplayType(a)?"inline-block":"block":"none"),i.begin=function(){j&&j.call(g,g);for(var c in l){n[c]=a.style[c];var d=t.CSS.getPropertyValue(a,c);l[c]="Down"===b?[d,0]:[0,d]}n.overflow=a.style.overflow,a.style.overflow="hidden"},i.complete=function(){for(var b in n)a.style[b]=n[b];k&&k.call(g,g),h&&h.resolver(g)},t(a,l,i)}}),m.each(["In","Out"],function(a,b){t.Redirects["fade"+b]=function(a,c,e,f,g,h){var i=m.extend({},c),j={opacity:"In"===b?1:0},k=i.complete;i.complete=e!==f-1?i.begin=null:function(){k&&k.call(g,g),h&&h.resolver(g)},i.display===d&&(i.display="In"===b?"auto":"none"),t(this,j,i)}}),t}(window.jQuery||window.Zepto||window,window,document)});


/**
 * @desc The basic AP Framework.
 * @depend jQuery, jQuery UI (autoComplete, datePicker)
 * @depend ap.css (wrapping CSS for jquery UI autocomplete and date picker).
 * @returns {AP}
 */
var AP=new function _AP(){
	this.config={};
	this.__printing=0;
	this.blockRedirection=null;
	this.transition="";
	
	
	this.key={enter: 13, tab: 9, backspace: 8, escape: 27, prev: 37, next: 39, left: 37, right: 39, up: 38, down: 40};
	this.keycode=function(e, str){
		return (e.keycode==this.key[str]);
	};


	this.EVENTS={PAGE_UNLOAD: 'page.unload',
		PAGE:{
			INIT: 'page.init',
			UNLOAD: 'page.unload',
			RELOAD: 'page.reload',
			AFTERLOAD: 'page.afterload'
	}};


	this.display=function(data, options){
		options=$.extend({},{emotion: false, tag: true, script: true}, options);
		return data;
	};




	/**
	 * @desc Call user function with parameter
	 */
	this.fn=function(fn, data){
		var __fn=eval(fn);
		__fn(data);
	};


	/**
	 * @desc Call user object function with parameter
	 */
	this.call=function(fn){
		fn();
	};


	this.__ts=[];
	this.__rts=[];

	/**
	 * @desc Temporary timeout (all timeouts are clear in the next page)
	 */
	this.timeout=function(fn, total_time){
		var tx=setTimeout(function(){
			fn();
		}, total_time);
		
		AP.__ts.push(tx);
		
		return tx;
	};


	/**
	 * @desc Temporary timeout (all timeouts are clear in the next page)
	 */
	this.rtimeout=function(fn, total_time){
		var intv=setInterval(function(){
			fn.apply(intv);
		}, total_time);
		
		AP.__rts.push(intv);
		return intv;
	};


	/**
	 * @desc Call a function once. The function is marked by its name, where fn is the actually
	 * function.
	 * @example
	 * 	AP.once("alertme", function(){alert(1)}); // This is called
	 *  AP.once("alertme", function(){alert(1)}); // This is not called as alertme has been called earlier.
	 */
	this.once_list=[];
	this.once=function(name, fn){
		if (this.array.within(name, this.once_list)){
			return;
		}
		this.once_list.push(name);
		fn();
	};



	this.alert=function(content, buttons, icon, opts){
		opts=$.extend({}, opts);

		if (!icon){
			icon='s48-ap-error';
		}

		var icon_html="<div class='icon' style='width:42px;'>"+icon+"</div>";
		if (AP.word.match(icon, /^([a-zA-Z0-9\s\-\_]+)$/)){
			icon_html="<span class='"+icon+"' style='font-size:42px;'></span>";
		}

		AP.dialog("#alert")
			.temp(false)
			.engine(AP.config.alertDialogEngine)
			.style("__apalert")
			.title("Success").temp(false)
			.buttons(buttons)
			.content("<table><tr><td class='icon'> "+icon_html+"</td> <td class='text'>"+content+"</td></tr></table>")
			.cond(Client.native, function(){
				this.width(450)
			})
			.closable(opts.closable)
			.show()
		;
	};



	this.alertSuccess=function(content, callback){
		var cb=function(){
			AP.dialog("#alert").hide();
		};
		if (callback){
			cb=function(){
				AP.dialog("#alert").hide();
				callback();
			};
		}
		AP.dialog("#alert")
			.temp(false)
			.engine(AP.config.alertDialogEngine)
			.style("__apalert")
			.title("Success").temp(false)
			.button("OK", cb,'ss')
			.content("<table><tr><td class='icon'> <span class='ficon ficon-check-circle' style='font-size:42px; color:#36b918'></span></td> <td class='text'>"+content+"</td></tr></table>")
			.show()
			;
	};



	this.alertWarning=function(content, callback){
		var cb=function(){
			AP.dialog("#alert").hide();
		};
		if (callback){
			cb=function(){
				AP.dialog("#alert").hide();
				callback();
			};
		}
		AP.dialog("#alert")
			.temp(false)
			.engine(AP.config.alertDialogEngine)
			.style("__apalert")
			.title("Success").temp(false)
			.button("OK", cb,'er')
			.content("<table><tr><td class='icon'> <span class='ficon ficon-exclamation-circle' style='font-size:42px; color:#c65144'></span></td> <td class='text'>"+content+"</td></tr></table>")
			.show();
	};


	this.alertError=function(content, extra_messages, callback){
		if (AP.word.empty(content)){
			content="There's something wrong in our system. We are working on it and we'll get it fixed as we can.";
		}

		var text=content;
		var cb=function(){
			AP.dialog("#alert").hide();
		};

		if (extra_messages && AP.isObject(extra_messages)){
			if (extra_messages[content]){
				text=extra_messages[content];
			}

			if (callback){
				cb=function(){
					AP.dialog("#alert").hide();
					callback();
				};
			}
		}else{
			if (extra_messages && !callback){
				cb=function(){
					AP.dialog("#alert").hide();
					extra_messages();
				};
			}
		}

		text=AP.error.translate(text);

		AP.dialog("#alert")
			.temp(false)
			.engine(AP.config.alertDialogEngine)
			.style("__apalert")
			.title("Error").temp(false)
			.button("OK", cb,'er alert-button')
			.content("<table><tr><td class='icon'> <span class='-ap icon-help-with-circle' style='font-size:40px; color:#666'></span></td> <td class='text'>"+text+"</td></tr></table>")
			.show()
		;
	};


	this.alertWaiting=function(content, fn){
		AP.dialog("#alert")
		.temp(false)
		.engine(AP.config.alertDialogEngine)
		.style("__apalert")
		.title("Waiting").temp(false)
		.button("Refresh", function(){
			AP.xRefresh();
		})
		.content("<table><tr><td class='icon'> <span class='s48-ap-question'></span></td> <td class='text'>"+content+"</td></tr></table>")
		.show()
		;

		if (fn){
			fn();
		}
	};



	this.confirm=function(content, fn){
		AP.dialog("#alert")
		.temp(false)
		.engine(AP.config.alertDialogEngine)
		.style("__apalert")
		.title("Confirm").temp(false)
		.button("Close", function(){
			AP.dialog("#alert").hide();
		},'er confirm-button')
		.button("OK", function(){
			AP.dialog("#alert").hide();
			fn();
		},'ss confirm-button')
		.content("<table><tr><td class='icon'> <span class='ficon ficon-exclamation-circle' style='font-size:42px; color:#c65144'></span></td> <td class='text'>"+content+"</td></tr></table>")
		.show()
		;
	};



	this.hideAlert=function(){
		AP.dialog("#alert").hide();
	};



	this.ajaxAlert=function(notShowTitle){
		if (!$('#ajaxalert').length){
			AP.add('ajaxalert');
			AP.dialog("#ajaxalert")
			.temp(false)
			.engine(AP.config.ajaxAlertDialogEngine)
			.show();
		}else{
			if (notShowTitle) {
				AP.dialog("#ajaxalert").title("").show();
			} else {
				AP.dialog("#ajaxalert").show();
			}
		}
	};

	this.ajaxShow=function(txt){
		if (!txt){
			txt="Processing";
		}
		this.ajaxAlert(true);
		// $.log(txt);
		$("#ajaxalert").prev().html(txt);
	};

	this.ajaxHide=function(){
		AP.dialog("#ajaxalert").hide();
	};



	/**
	 * @desc The default handler for ajax code returned from the server.
	 * @todo Add Dialog Here.
	 */
	this.handler=function(code){
		AP.alertError(code.message);
	};


	/**
	 * @desc The default success handler for ajax code returned from the server.
	 * @todo Add Dialog Here.
	 */
	this.successHandler=function(code){
		AP.alertSuccess(code.message);
	};


	/**
	 * @desc The default error handler for ajax code returned from the server.
	 * @todo Add Dialog Here.
	 */
	this.errorHandler=function(code){
		AP.alertError(code.message);
	};



	/**
	 * @desc Class's binary lock
	 */
	this.__lock=false;

	/**
	 * @desc Lock the ajax mechanisum.
	 */
	this.lock=function(){
		this.__lock=true;
	};

	this.undone_url="";
	this.undone_data="";


	this.ajax_data={};
	this.ajaxSetup=function(data){
		this.ajax_data=data;
	};

	
	/**
	 * @desc Making a post to the server.
	 * @param handler: The callback after retrieving the data from the server. if
	 * omitted, the default handler is called.
	 */
	this.post=function(url, data, handler, use_lock){
		if (!this.word.isURL(url)){
			if (Client.native){
				url=M.api()+'/'+url;

				if (data && AP.data.isObject(data)){
					var params=M.params();
					for (var key in params){
						M.formData(data, key, params[key]);
					}
				}

				M.formData(data, '__code', Client.code);
			}else{
				url=Client.ajax_url+'/'+url;
			}

		}

		var $this=null;

		if (use_lock && use_lock==true){
			if (this.__lock){
				if (Client.env==0 || Client.env=='0'){
					AP.alertError("Be patient! Your request is processed right now.");
				}
				return;
			}
			this.lock();
		}

		if (!handler){
			handler=this.hander;
		}

		if (AP.isAssocArray(data) && !Client.native){
			data.__code=Client.code;
			if (Client.base_network && Client.base_network.id){
				if (!data.__base_network){
					data.__base_network=Client.base_network.id;
				}
			}
			if (Client.network && Client.network.id){
				if (!data.__network){
					data.__network=Client.network.id;
				}
			}
			if (Client.user && Client.user.id){
				if (!data.__user){
					data.__user=Client.user.id;
				}
			}

			for (var key in this.ajax_data){
				data[key]=this.ajax_data[key];
			}
		}

		AP.sys.fire("ajax.pre.update",data);

		if (url==this.undone_url && AP.data.equal(data, this.undone_data)){
			// $.log(url);
			// AP.alertError("We are processing your request ....");
			$.log("[Abusive URL: "+url+"], with Data:");
			$.log(data);
			return false;
		}

		this.undone_url=url;
		this.undone_data=data;

		
		if (Client.native){
			var ajax_data={
				'url': url,
				'data': data,
				type: 'POST',
				success: function(text){
					AP.__lock=false;
					AP.undone_url="";
					AP.undone_data="";
					var c=parseCode(text);


					if (c.message=="FLAG.SYSTEM.REQUIRED.REFRESH" || c.command=="LOGIN"){
						return AP.alertError("Please refresh to continue.", function(){
							AP.refresh();
						});
					}
					handler(c);
				},
				error: function(text){
					AP.__lock=false;
					AP.undone_url="";
					AP.undone_data="";
					var c=parseCode(text);
					handler(c);
				}
			};

			if (isFormData(data)) {
				// hack to fix safari bug where ajax fails if file input is empty
				if ((navigator.userAgent.match(/iPhone|iPad|iPod/i)) || (navigator.userAgent.search("Safari") >= 0 && navigator.userAgent.search("Chrome") < 0)) {
					// Safari < 10.13.4 does not support FormData.entries()
					try {
						var formDataEntries = data.entries(), formDataIter = formDataEntries.next(), pair;
						while (!formDataIter.done) {
							pair = formDataIter.value;
							if (Object.prototype.toString.call(pair[1]) === '[object File]' && pair[1].name == '' && pair[1].size == 0) {
								data.delete(pair[0]);
								formDataEntries = data.entries();
								formDataIter = formDataEntries.next();
							} else {
								formDataIter = formDataEntries.next();
							}

						}
					} catch(e) {}
				}

				ajax_data.processData = false;
				ajax_data.contentType = false;

			}

			$.ajax(ajax_data);
		}else{
			$.post(url, data, function(text){
				AP.__lock=false;
				AP.undone_url="";
				AP.undone_data="";
				var c=parseCode(text);

				if (c.message=="FLAG.SYSTEM.REQUIRED.REFRESH" || c.command=="LOGIN"){
					return AP.alertError("Please refresh to continue.", function(){
						AP.refresh();
					});
				}
				
				handler(c);
			}).fail(function(text){
				AP.__lock=false;
				AP.undone_url="";
				AP.undone_data="";
				var c=parseCode(text);
				handler(c);
			});
		}
	};


	/**
	 * @desc Similar to post, but create a get method.
	 */
	this.get=function(url, handler, checker){
		return this.post(url, {}, handler, checker);
	};
	
	
	this.es6Post=function(url, data, handler){
		if (AP.isAssocArray(data) && !Client.native){
			data.__code=Client.code;
		}
		
		var formData = new FormData();
		for (var k in data) {
		    formData.append(k, data[k]);
		}
		
		if (!this.word.isURL(url)){
			url=Client.ajax_url+'/'+url;
		}
		
		fetch(url, {
			method: 'POST',
			headers: {"Content-Type": "application/x-www-form-urlencoded; charset=utf-8"},
			body:  new URLSearchParams(data)
		})
		.then(res => res.text()) // parse response as JSON (can be res.text() for plain response)
		.then(function(data){
			// $.log(data);
			// UI.ajaxHide();
			var c=parseCode(data);
			handler(c);
		})
		.catch(err => {
			console.log(err);
		});
	};



	this.crossPost=function(url, data, success_callback, error_handler){
		data.ext=url;
		data.ts=AP.T.timeStamp();
		data.__code=Client.code;
		$.ajax({
			  type: 'post',
			  url: Client.ajax_url+"/share/cross",
			  data: data,
			  success: function(obj){
				  success_callback(obj);
			  },
			  error: function(){
				  if (error_handler){
					  error_handler();
				  }
			  },
			  dataType: 'JSON'
		});
	};

	/**
	 * @desc Submit frame in the regular way.
	 */
	this.__submit=function(selector){
		ap_editSubmission(selector);
		$(selector).submit();
	};


	/**
	 * @desc Submit a form to the server using Ajax. Based on the elements of the form,
	 * the system will decide the corresponding method (DIRECT AJAX or FRAME).
	 * @param selector The form Selector.
	 * @returns Null
	 */
	this.submit=function(selector, callback, extra_data){
		var elem="";

		if (!AP.data.isString(selector)){
			var id;
			if (!$(selector).attr('id')){
				id=AP.uuid();
				$(selector).attr('id', id);
			}else{
				id=$(selector).attr('id');
			}

			elem="#"+id;
		}else{
			elem=selector;
		}


		if (!extra_data){
			extra_data={};
		}

		if (Client.native){
			var params=M.params();
			for (var key in params){
				extra_data[key]=params[key];
			}
		}

		for (var key in this.ajax_data){
			extra_data[key]=this.ajax_data[key];
		}

		if ($(elem).find('input[type=file]').length && !Client.native){
			return this.submitFrame(elem, callback, extra_data);
		}else{
			return this.submitAjax(elem, callback, extra_data);
		}
	};


	/**
	 * @desc Submit a form via ajax.
	 */
	this.submitAjax=function(selector, callback, extra_data){
		if (!extra_data){
			extra_data={};
		}

		var text="";
		if (!$(selector).flag("__init_code")){
			var text="<input type='hidden' name='__code' value='"+Client.code+"' /> ";
			$(selector).append(text);
			AP.sys.fire('form.pre.submit', selector);
		}

		if (!callback){
			callback=this.handler;
		}

		ap_editSubmission(selector);

		var data=$(selector).serialize();
		
		var target=$(selector).attr('action');



		if (Client.native){
			var formData = new FormData($(selector)[0]);
			if (extra_data){
				for (var k in extra_data){
					formData.append(k, extra_data[k]);
				}
			}

			this.post(target, formData, function(code){
				code.__form=assoc($(selector).serializeArray());
				for (var k in extra_data){
					code.__form[k]=extra_data[k];
				}
				callback(code);
				ap_reeditSubmission(selector);
			}, true);

		}else{
			if (extra_data){
				for (var k in extra_data){
					data+="&"+k+"="+extra_data[k];
				}
			}

			this.post(target, data, function(code){
				code.__form=assoc($(selector).serializeArray());
				callback(code);
				ap_reeditSubmission(selector);
			}, true);
		}
	};



	/**
	 * @desc Submit as iframe.
	 */
	this.submitFrame=function(selector, success, extra_data){
		if (!success){
			success=this.handler;
		}

		ap_setupFrameUpload(selector, function(code){
			$(selector).unlock();
			code.__form=assoc($(selector).serializeArray());
			success(code);
			ap_reeditSubmission(selector);
		}, extra_data);


		if ($(selector).lock()){
			this.__submit(selector);
		}else{
			AP.alertError("Be patient! Your request is processed right now.");
		}

	};



	this.getJSONP=function(url, success, error){
		var callback='APJSONCALLBACK';
		var uuid=AP.uuid();
		APJSONREG(uuid, success, error);
		var furl=url+"?callback="+callback+"&fx="+uuid;
		if (url.indexOf('?')>0){
			furl=url+"&callback="+callback+"&fx="+uuid;
		}

		$.apScript(furl,null,uuid);
	};



	/**
	 * @desc This is a very simple version of post, when we do not worry
	 * so much about callback function. The functions is very useful for case
	 * such as using AJAX to count pageview, or make a Like action.
	 */
	this.touch=function(url, success){
		if (!success){
			success=this.successHandler;
		}
		this.post(url,{}, function(code){
			if (code.good()){
				success(code);
			}else{
				AP.handler(code);
			}
		});
	};


	/**
	 * @desc This is a simpler version of touch with one exception: on error,
	 * the system doesn't notify the user.
	 */
	this.silent=function(url, success){
		if (!success){
			success=this.handler;
		}
		this.post(url,{}, function(code){
			if (code.good()){
				success(code);
			}
		});
	};




	/**
	 * @desc Redirect to a specific link. If link is not started with http, we
	 * makes it a valid link within the current host.
	 */
	this.redirect=function(link){
		if (!link){
			window.location.href=window.location.href;
		}

		if (Client.native){
			window.location.href=link;
			return;
		}

		if (this.word.prefix(link,'http')){
			window.location.href=link;
		}else{
			window.location.href=Client.url+"/"+link;
		}
	};


	/**
	 * @desc Refresh the whole page.
	 */
	this.refresh=function(){
		if (Client.native){
			location.reload();
		}

		return this.redirect(window.location.href);
	};


	/**
	 * @desc Refresh the whole page.
	 */
	this.xRefresh=function(callback){
		if (Client.native){
			return M.xRefresh();
		}

		var url=window.location.href;
		if (AP.word.prefix(url, Client.url)){
			AP.loadURL(url, {direct_load: true});
		}else{
			AP.loadURL(AP.current_url, {direct_load: true});
		}


		if (callback){
			AP.sys.once(AP.EVENTS.PAGE_UNLOAD, callback);
		}
	};



	this.__urlref=null;

	/**
	 * @desc To an internal URL. URL must be relative.
	 */
	this.toURL=function(url, callback, ref){
		if (ref){
			this.__urlref=ref;
		}

		if (Client.native){
			return AP.nativeRedirect(url);
		}

		if (AP.word.isURL(url)){
			if (!AP.word.prefix(url, Client.url)){
				window.open(url);
				return;
			}
		}

		// Remove the HTTP
		if (AP.word.prefix(url, Client.url)){
			url=url.substr(Client.url.length+1);
		}

		// Quick redirect
		if (!AP.word.isURL(url) && this.rewriteRedirect(url)){
			return;
		}

		if (AP.transition && AP.transition.length){
			AP.confirm(AP.transition, function(){
				AP.transition="";
				AP.toURL(url, callback, ref)
			});
			
			return;
		}
		
		
		if (url.indexOf('__nhash=1')!=-1){
		}else{
			if (AP.__history){
				history.pushState({url: Client.url+"/"+url},"",Client.url+"/"+url);
			}else{
				AP.setHash(url);
			}
		}

		if (!AP.word.isURL(url)){
			url=Client.url+"/"+url;
		}

		if (this.__must_reset){
			if (AP.__reset_callback){
				AP.__reset_callback();
			}

			AP.redirect(url);
			return;
		}

		AP.loadURL(url,{direct_load: true});

		if (callback){
			AP.sys.once(AP.EVENTS.PAGE_UNLOAD, callback);
		}
	};


	this.setHash=function(url){
		AP.current_url=Client.url+'/'+url;
		AP._last_hash=url;
		window.location.hash='!/'+url;
	};


	this.nativeRedirect=function(url, skip_hash_change){
		var parts=url.split("?");

		if (parts.length<2){
			Query.reset();
			M.redirect(url, skip_hash_change);
		}else{
			var d=queryStringToArray(parts[1]);
			Query.reset();
			for (var k in d){
				Query.set(k, d[k]);
			}
			M.redirect(parts[0], skip_hash_change);
		}
	};



	this._callback={};
	/**
	 * @desc Register a callback for a group. The group (name) will be
	 * the key of callback. When AP.triggerCallback is called, the set of
	 * callbacks will be cleared on the group.
	 */
	this.callback=function(group, fn){
		if (!this._callback[group]){
			this._callback[group]=[];
		}
		this._callback[group].push(fn);
	};


	/**
	 * @desc Trigger the callback on the group action.
	 */
	this.triggerCallback=function(group){
		if (!this._callback[group]){
			return;
		}
		for (var i=0; i<this._callback[group].length; i++){
			var fn=this._callback[group][i];
			fn();
		}
		this._callback[group]=[];
	};




	/**
	 * @desc Check if a variable name exists.
	 */
	this.isset=function(varname){
		return(typeof(window[varname])!='undefined');
	};


	/**
	 * @desc Apply a transform function on the array. It is very much
	 * similar to array_walk in PHP world.
	 */
	this.transform=function(arr, transform_fn){
		var b=[];
		for (var i=0; i<arr.length; i++){
			var temp=transform_fn(arr[i],i);
			if (temp!==null){
				b.push(temp);
			}
		}
		return b;
	};


	this.select=function(arr, transform_fn){
		if (!arr){
			return [];
		}
		return this.transform(arr, transform_fn);
	};


	/**
	 * @desc Apply a transform function on the array, append results at bottom
	 * to make a longer string.
	 */
	this.render=function(arr, transform_fn, limit){
		if (!limit){
			limit=0;
		}
		if (!this.isArray(arr)){
			return;
		}
		var m=arr.length;
		if (limit >0 && limit <m){
			m=limit;
		}
		var text="";
		for (var i=0; i<m; i++){
			text+=transform_fn(arr[i],i, m);
		}
		return text;
	};


	/**
	 * @desc Apply a transform function on the object, append results at bottom
	 * to make a longer string.
	 */
	this.renderObject=function(obj, render_fn, limit){
		var text="";
		for (var key in obj){
			text+=render_fn(key, obj[key]);
		}
		return text;
	};



	/**
	 * @desc Apply function to each part of the array.
	 */
	this.each=function(data, callback){
		for (var i=0; i<data.length; i++){
			callback(data[i]);
		}
	};


	/**
	 * @desc Create an associate array, where key are variables.
	 * Keys and values are placed in sequence as arguments of the function.
	 */
	this.assoc=function(){
		var r={};
		for (var i=0; i<arguments.length/2; i++){
			r[arguments[2*i]]=arguments[2*i+1];
		}
		return r;
	};


	/**
	 * @desc Encode the data so that it's Okay to pass via AJAX and URL.
	 */
	this.encodeURI=function(str){
		try { return encodeURIComponent(str); } catch(e){}
		try { return encodeURI(str); } catch(e){}
		return espace(str);
	};

	
	this.urlEncode=this.encodeURI;
	

	/**
	 * @desc Move history forward.
	 */
	this.next=function(){
		return history.go(1);
	};

	/**
	 * @desc Move history forward.
	 */
	this.back=function(){
		return history.go(-1);
	};

	this.pageError=function(){
		if (window.performance && window.performance.navigation.type == 2){
			// location.reload(true);
		}
	};
	

	/**
	 * @desc Create an event listener
	 */
	this.on=function(event, fx, $this){
		this.event.bind(event, fx, $this);
		return this;
	};


	this.rebind=function(event, fx, $this){
		this.event.rebind(event, fx, $this);
		return this;
	};



	/**
	 * @desc Create an event listener
	 */
	this.onAll=function(event, fx, $this){
		this.event.bindAll(event, fx, $this);
		return this;
	};


	/**
	 * @desc Trigger an event
	 */
	this.trigger=function(event){
		this.event.trigger(event);
		return this;
	};


	/**
	 * @desc Trigger an event
	 */
	this.fire=function(event, data){
		this.event.trigger(event, data);
		return this;
	};

	this.fireLate=function(event,time){
		if (!time){
			time=200;
		}
		var Event=this.event;
		setTimeout(function(){
			Event.trigger(event);
		},time);
		return this;
	};

	this.live=function(event, fx){
		this.on(event,fx);
		$.log(this.event.__fired);
		if (this.event.fired(event)){
			this.release(event);
		}
	};


	/**
	 * @desc Trigger an event (and dequeue)
	 */
	this.release=function(event){
		this.event.release(event);
		return this;
	};


	this.autoRelease=function(event, cond){
		if (cond){
			return this.release(event);
		};
	};


	this.removeListener=function(event){
		this.event.removeListener(event);
	};


	/**
	 * @desc Getting the url of the thumbnail.
	 */
	this.thumb=function(source, prefix){
		if (!prefix){
			prefix="1.";
		}else{
			prefix=prefix+".";
		}

		if (typeof source == 'undefined' || !source) {
			return "";
		}

		var path=source.split("/");
		if (path.length<=0){
			return source;
		}
		path[path.length-1]=prefix+path[path.length-1];
		return path.join("/");
	};

	this.xthumb=function(source){
		return this.thumb(source, "0");
	};

	this.zthumb=function(source){
		return this.thumb(source, "2");
	};


	/**
	 * @desc Check data type.
	 */
	this.isArray=function(data){
		return $.isArray(data);
	};
	this.isAssocArray=function(data){
		return typeof(data)=='object' && isNaN(data);
	};
	this.isObject=function(data){
		return typeof(data)=='object' && isNaN(data);
	};
	this.isFunction=function(data){
		return $.isFunction(data);
	};
	this.isInt=function(data){
		return !isNaN(data)&&parseInt(data)==data;
	};
	this.isString=function(data){
		return typeof(data)=='string' && isNaN(data);
	};
	this.isEmpty=function(data){
		if (!data || data.length <=0){
			return true;
		}
		return false;
	};


	this.js_list=Client.js;
	this.css_list=Client.css;


	/**
	 * @desc Loading external css.
	 */
	this.css=function(source){
		if (AP.array.within(source, this.css_list)){
			return;
		}
		this.css_list.push(source);

		if (!this.word.isURL(source)){
			source=Client.url+'/css/'+source;
		}

		$.log("[CSS: "+source+"]");

		var css = jQuery("<link>");
		css.attr({
			rel:  "stylesheet",
			type: "text/css",
			href: source
		});
		$("head").append(css);

	};


	this.cssx=function(css){
		if (Client.pageData.__lazycss && Client.pageData.__lazycss=="none"){
			return;
		}
		this.css(css);
	};

	/**
	 * @desc Loading external js file.
	 * @return Boolean
	 */
	this.js=function(source,callback,id){
		if (this.array.within(source, this.js_list)){
			return false;
		}


		this.js_list.push(source);

		if (!this.word.isURL(source)){
			source=Client.url+'/js/'+source;
		}
		$.log("[JS: "+source+"]");

		$.apScript(source,callback,id);
		return true;
	};


	this.jsx=function(source, callback, id){
		if (Client.pageData.__lazyjs && Client.pageData.__lazyjs=="none"){
			return;
		}
		if (this.array.within(source, this.js_list)){
			if (callback){
				callback();
			}
			return false;
		}


		this.js_list.push(source);

		if (!this.word.isURL(source)){
			source=Client.url+'/js/'+source;
		}
		$.log("[JS: "+source+"]");

		$.apScript(source,callback,id);
		return true;
	};



	/**
	 * @desc Setting continuous Request
	 */
	this._continuous=false;
	this._in_continuous_request=false;

	this._last_hash='';
	this.current_url=window.location.href;

	this.__history=false;
	if (history && history.pushState){
		this.__history=true;
	};

	this.adaptive=function(url1, url2){
		return true;
	};

	this.setURL=function(url){
		if (this.__history){
			history.pushState({url: Client.url+"/"+url},"",Client.url+"/"+url);
		}
	};

	this.updateURLParams=function(params){
		var ps=params;
		if (AP.data.isString(ps)){
			ps=queryStringToArray(params);
		}

		for (var key in ps){
			if (ps[key]==="null"){
				ps[key]=null;
			}
		}

		var checked={};

		var url=Client.path.current;
		url=url.replace(/(\&*)([\w\-]+)\=([\w\-]+)/g, function(match, p0, p1, p2){
			checked[p1]=1;

			if (p1 in ps && ps[p1]===null ){
				return "";
			}

			if (ps[p1]){
				return p0+p1+"="+ps[p1];
			}
			return p0+p1+"="+p2;
		});

		var extra="";
		for (var key in ps){
			if (!checked[key] && ps[key]!=null){
				extra+=key+"="+ps[key]+"&";
			}
		};

		if (extra.length){
			extra=extra.substr(0, extra.length-1);

			if (url.indexOf("?")==-1){
				url=url+"?"+extra;
			}else{
				url=url+"&"+extra;
			}
		}



		if (url.charAt(url.length-1)=="?"){
			url=url.substr(0, url.length-1);
		}


		return AP.toURL(url);
	}


	this.setURLParams=function(params, redirect){
		var ps=params;
		if (AP.data.isString(ps)){
			ps=queryStringToArray(params);
		}

		var orgs=shallowClone(ps);

		var checked={};

		var url=window.location.href;
		url=url.substr(Client.url.length+1);

		url=url.replace(/(\&*)([\w\-]+)\=([\w\-\%\(\)\.\@\/]+)/g, function(match, p0, p1, p2){
			checked[p1]=1;
			if (p1 in ps && ps[p1]===null){
				return "";
			}
			if (ps[p1]){
				return p0+p1+"="+ps[p1];
			}
			return p0+p1+"="+p2;
		});

		var extra="";

		for (var key in ps){
			if (!checked[key]){
				if (key in orgs && orgs[key]==null){
					Query.unset(key);
				}else{
					Query.set(key, ps[key]);
					extra+=key+"="+ps[key]+"&";
				}
			}else{
				Query.set(key, ps[key]);
			}
		};

		if (extra.length){
			extra=extra.substr(0, extra.length-1);

			if (url.indexOf("?")==-1){
				url=url+"?"+extra;
			}else{
				url=url+"&"+extra;
			}
		}


		if (url.charAt(url.length-1)=="?"){
			url=url.substr(0, url.length-1);
		}

		
		if (Client.url+"/"+url == document.location.href){
			return;
		}
		
		if (redirect){
			return AP.toURL(url);
		}else{
			return AP.setURL(url);
		}

	}



	this.initContinuousRequest=function(){
		if (this._continuous==false){
			var hash=window.location.hash;
			if (hash && hash.substr(0,2)=='#!' && !AP._in_continuous_request ){
				hash=hash.substring(3);
				AP.redirect(Client.url+'/'+hash);
			}
		}

		this._continuous=true;
		if (!this.__history){
			setInterval(function(){
				if (AP._in_continuous_request){
					return;
				}
				var hash=window.location.hash;
				if (!hash){
					if (AP._last_hash && AP._last_hash.length>=2){
						var nhash=getHash(window.location.href);
						if (nhash){
							window.location.hash='!/'+nhash.join('/');
							return;
						}
					}
					return;
				}

				hash=hash.substring(3);
				if (hash && hash!=AP._last_hash){
					AP._in_continuous_request=true;
					AP.current_url=Client.url+'/'+hash;
					AP.loadURL(AP.current_url);
					AP._last_hash=hash;
				}
			},500);
		}
	};

	this.__popstate_set=false;


	this.setContinuousRequest=function(container){
		if (Client.continuous && Client.continuous==-1){
			return;
		}

		if (this.__history  && !this.__popstate_set){
			history.replaceState({url: window.location.href},'');

			window.onpopstate=function(e){
				if (e.state){
					// Check hostname
					var url=AP.current_url;
					var hostname=document.location.hostname;
					if (Client.https){
						hostname="https://"+hostname;
					}else{
						hostname="http://"+hostname;
					}

					if (!AP.word.prefix(url, hostname)){
						return;
					}else if (!AP.adaptive(url, e.state.url)){
						AP.redirect(e.state.url);
						return;
					}else{
						$.log("[State: "+url+" -> "+document.location.href+"]");
						AP.loadURL(e.state.url,{direct_load: true});
					}
				}
			};
			this.__popstate_set=true;
		}


		if (!container){
			container='';
		}

		$("a", container).each(function(){
			if ($(this).hasClass('blank') || ($(this).attr('target')=='_blank')|| $(this).hasClass('__ap_processed')){
				// No follow or well-done
				return true;
			}
			
			var href=$(this).attr("href");
			if (!href){
				return;
			}

			// Check hostname
			var hostname=$(this).prop('hostname');
			if (hostname!=document.location.hostname){
				return;
			}

			if (!AP.adaptive(href, AP.current_url)){
				return;
			}

			var curl=window.location.href;

			var url;
			var idx=href.indexOf('#');
			if (idx>=0){
				var hash=href.substr(idx+1);
				if (hash.substr(0,2)=='!/'){
					url=hash.substr(2);
				}
			}else{
				url=ap_getHash(href);
				if (!url){
					return;
				}
				url=url.join('/');
			}
			
			if (!url){
				return;
			}


			$(this).addClass('__ap_processed');
			$(this).click(function(event){
				if ($(this).data("href") && $(this).data("url")){
					// event.preventDefault();
					// return false;
				}
				
				event.preventDefault();
				if (url.indexOf('__nhash=1')!=-1){
				}else{
					if (AP.__history){
						history.pushState({url: Client.url+"/"+url},"",Client.url+"/"+url);
					}else{
						window.location.hash="!/"+url;
						AP._last_hash=url;
					}
				}

				AP.loadURL(Client.url+'/'+url,{direct_load: true});

				return false;
			});

		});
	};



	/**
	 * @desc Similar to continuous AJAX request, but this function load
	 * data to the overlay and don't reset the hash.
	 */
	this.load=function(url){
		return AP.loadURL(url, {model: 'overlay'});
	};


	this.__must_reset=false;
	this.__reset_callback=false;

	this.requireReset=function(reset_callback){
		this.__reset_callback=reset_callback;
		this.__must_reset=true;
	};


	this.loadURL=function(url, options){
		AP._in_continuous_request=true;

		$("#ajax-load").show();
		$(document.body).addClass("__onload");
		AP.sys.fire("page.pre.transition");

		var data;

		if (Client.__s){
			data={'from': AP._last_hash, '__s': Client.__s};
		}else{
			data={'from': AP._last_hash, '__s': '0'};
		}

		data._rt=Client.rt;

//		if (Client.pageData.accepted_caches && Client.pageData.accepted_caches.length){
//			$.extend(data, {'__lc':Client.pageData.accepted_caches.join()});
//		}

		// Get all current caches
		var cc=Client.getCurrentCachesKey();
		if (cc && cc.length){
			$.extend(data, {'__lc':cc.join()});
		}


		if (options){
			$.extend(data, options);
		}else{
			options={};
		}





		AP.post(url,data, function(code){
			if (code.direct_request_prevented && (code.direct_request_prevented==1 || code.direct_request_prevented=='1')){
				AP.redirect(url);
				return;
			}

			AP.current_url=url;

			if (!code.good() && (code.message=='FORCE_REFRESH' || code.message=='BAD_XCODE')){
				AP.redirect(url);
				return;
			}



			$(document.body).removeClass("__onload");

			if (code.good()){
				$.log('[Load URL: '+url+"]");

				// track the page view
				// track the page view
				if (typeof ga !== 'undefined'){
					ga('send','pageview', {
						page: url,
						title: code._title
					});
				}else if (typeof _gaq !== 'undefined'){
					_gaq.push(['_trackPageview', url]);
				}


				// First, loading calling the reset function
				var rs=code._init;
				var _rs=eval(rs);
				_rs(function(){
					if (!AP._in_continuous_request && !options.direct_load){
						return;
					}

					// Remove page data

					if (!options.keep_page_data){
						AP.pageData={};
						Client.pageData={};
					}
					
					AP.pageConfig.reset();
					SE.reset();
					
					if (code._log){
						console.log("[Log: "+url+"]");
						console.log(code._log);
					}

					AP.hotkey.clear();
					AP._in_continuous_request=false;

					// Next, setting other components
					AP.html.title(code._title);

					// Next, loading css and javascript
					for (var i=0; i<code._css.length; i++){
						AP.css(code._css[i]);
					}

					// Accept only one javascript
					var called=false;


					if (code._js && code._js.length >0){
						called=AP.js(code._js[code._js.length-1], function(){
							if (code._page_data){
								eval(code._page_data);
							}

							AP.updatePageData();

							AP.fn(code._update, code._html);

							if (code._inpage_js){
								eval(code._inpage_js);
							}
						});
					}

					if (!called){
						if (code._page_data){
							eval(code._page_data);
						}

						AP.updatePageData();

						AP.fn(code._update, code._html);
						if (code._inpage_js){
							eval(code._inpage_js);
						}
					}


					if (Client.pageData.accepted_caches){
						Client.deleteCachesExcept(Client.pageData.accepted_caches);
					}else{
						Client.deleteCachesExcept();
					}

					$("#ajax-load").hide();
				});
			}else{
				$("#ajax-load").hide();

				if (code.data && code.data.force_redirect){
					AP.redirect(code.data.force_redirect);
					return;
				}

				AP._in_continuous_request=false;
			}
		}, true);
	};


	this.loadInlineURL=function(url, data, canvas, options){
		UI.ajaxShow();
		AP.post(url, data, function(code){
			UI.ajaxHide();

			if (!code.good()){
				if (options.error){
					options.error();
				}

				return AP.alertError(code.message);
			}

			if (options.start) options.start();
			AP.blockRediretion=null;
			
			AP.setTempData(code);
			$(canvas).html(code.html);

			if (code._page_data){
				for (var key in code._page_data){
					Client.pageData[key]=code._page_data[key];
				}
			}

			// AP.hotkey.clear();
			if (code.__js && code.__js.length){
				eval(code.__js);
			}

			if (options.end) options.end();
		});
	};


	this.initPageData=function(){
		return this.updatePageData();
	};


	this.updatePageData=function(){
		if (Client.pageData.network){
			Client.network=Client.pageData.network;
		}else{
			Client.network=null;
		}

		if (Client.pageData.user){
			Client.user=Client.pageData.user;
		}else{
			Client.user=null;
		}

		// Clear all events (notice: static event should be called via AP.sys
		AP.event.clear();
	};


	this.resetPageData=function(){
		// Clear MapData
		if (AP.mapData){
			AP.mapData={};
		}

		if (Client){
			Client.tempData={};
		}


		for (var i=0; i<AP.__ts.length; i++){
			if (AP.__ts[i]){
				clearTimeout(AP.__ts[i]);
			}
		}

		for (var i=0; i<AP.__rts.length; i++){
			if (AP.__rts[i]){
				clearTimeout(AP.__rts[i]);
			}
		}

		AP.__ts=[];
		AP.__rts=[];

		$("#ap-temp iframe.__temp").each(function(){
			$(this).remove();
		});

		$("#ap-temp").children('.__temp').remove();
		$(".__temp").remove();
		$(".__tempx").empty();

		$("#apdialogs").hide();

		$(document).unbind('keydown');

		$(document).unbind('.__temp');
		$(window).unbind('.__temp');
		
		AP.blockRediretion=null;
	};


	this.purify=function(txt){
		var temp=txt+"";
		
		if (!temp || !temp.length){
			return "";
		}

		temp=temp.replace(/<[^>]*>?/gm, '');
		temp=temp.replace(/<>/gm,'');
		temp=temp.replace(/^\s+|\s+$/gm,'');
		
		return temp;
	};


	/**
	 * Get HTML, and handle via a specific callback
	 */
	this.getHTML=function(url, callback, options){
		if (!options){
			options={};
		}

		options=$.extend({showAjaxLoader: true}, options);

		if (options.showAjaxLoader){
			$("#ajax-load").show();
		}
		if (!AP.word.prefix(url,'http')){
			url=Client.url+'/'+url;
		}

		AP.post(url,{}, function(code){
			if (code.direct_request_prevented && (code.direct_request_prevented==1 || code.direct_request_prevented=='1')){
				AP.redirect(url);
				return;
			}

			if (code.good()){
				$.log('[Loading] URL '+url);

				// Next, setting other components
				if (code._title){
					AP.html.title(code._title);
				}

				// Next, loading css and javascript
				for (var i=0; i<code._css.length; i++){
					AP.css(code._css[i]);
				}

				// Accept only one javascript
				var called=false;

				if (code._js && code._js.length >0){
					called=AP.js(code._js[code._js.length-1], function(){
						if (code._page_data){
							eval(code._page_data);
						}
						callback(code._html);
						if (code._inpage_js){
							eval(code._inpage_js);
						}
					});
				}
				if (!called){
					if (code._page_data){
						eval(code._page_data);
					}
					callback(code._html);
					if (code._inpage_js){
						eval(code._inpage_js);
					}
				}

				if (options.showAjaxLoader){
					$("#ajax-load").hide();
				}
			}else{
				if (options.showAjaxLoader){
					$("#ajax-load").hide();
				}
			}
		});
	};


	
	this.putTemplate=function(val, placeholder){
		$(placeholder).replaceWith("<span>"+val+"</span>");
	};


	/**
	 * @desc Extend client with data
	 */
	this.appData = function(data){
		for (var key in data){
			// Client=$.extend({}, Client, data);
			if (key != 'user' && key != 'network'){
				Client[key]=data[key];
			}else{
				if (Client[key] && !Client['previous_'+key]){
					Client['previous_'+key]=Client[key];
				}
				Client[key]=data[key];
			}


			// Cleanup application data of previous request if needed
		}
	};



	/**
	 * @desc Add wrapper to the document.body. Wrapper is hidden.
	 * @example
	 * 		AP.add("#alert, #dialog");
	 * 		AP.add("alert, dialog");
	 *	  Both generate the same ids.
	 */
	this.add= function(){
		for (var i=0; i<arguments.length; i++){
			var id=arguments[i];
			if (AP.word.prefix(id,'#')){
				id=id.substr(1);
			}
			$(document.body).append("<div id='"+id+"' style='display:none'></div>");
		}
	};


	/**
	 * @desc Generate an unique ID. This is useful when we want to create random IDs
	 * without conflict.
	 */
	var uuidLists=[];
	this.uuid=function(){
		return '_uuid'+(Math.floor(Math.random()*100000))+"_"+(Math.floor(Math.random()*100000))+"_"+AP.time.timeStamp();
	};



	/**
	 * @desc Just a placeholder function.
	 */
	this.nothing=function(){
		return;
	};


	this.test=function(){
		if (Client.native ||parseInt(Client.env) || arguments.length<2){
			return;
		}

		var code=arguments[0];
		var fn=arguments[1];

		$(document).on('keypress', function(e){
			var tag = e.target.tagName.toLowerCase();
			if (tag != 'input' && tag != 'textarea'){
				if (e.keyCode==code+48){
					fn();
					e.preventDefault();
				}
			}
		});
	}



	/**
	 * @desc Apply an action consecutively on all action
	 */
	this.chain=function(data, fn){
		__chainUp(data, 0, fn);
	};


	function __chainUp(data, index, fn){
		if (index>=data.length){
			return;
		}

		fn(data[index], function(){
			chainUp(data, index+1, fn);
		});
	};



	/**
	 * @desc THE PRIVATE METHODS
	 */

	var ap_getHash=function(href){
		return getHash(href);
	};



	var ap_editSubmission=function(elem){
		// Refreshing editor
		$(elem).find('.__apeditor').each(function(){
			nicEditors.findEditor($(this).attr('id')).saveContent();
		});

		$(elem).find("input, textarea").each(function(){
			if ($(this)[0].title && $(this)[0].title==$(this).val()){
				$(this).val("");
			};
		});

		
		$(elem).find("input[name='__code']").val(Client.code);

		if (!$(elem).hasClass('__apform_fixed')){
			$(elem).addClass('__apform_fixed');
			var text="";
			if (Client.base_network && Client.base_network.id>=1 && !$("input[name='__base_network']", $(elem)).length){
				text+="<input type='hidden' name='__base_network' value='"+Client.base_network.id+"'/>";
			}
			if (Client.network && Client.network.id>=1 && !$("input[name='__network']", $(elem)).length){
				text+="<input type='hidden' name='__network' value='"+Client.network.id+"'/>";
			}
			$(elem).append(text);
		}
	};


	var ap_reeditSubmission=function(elem){

		$(elem).find("input, textarea, select").each(function(){
			if (!$(this).hasClass('__injected')){
				$(this).restore();
			}
		});
	};


	this.iframe_counter=0;


	var ap_setupFrameUpload=function(selector, callback, extra_data){
		if ($(selector).flag("iframe_setup")){
			// Still need to fix extra_data

			if (extra_data){
				for (var key in extra_data){
					if ($(selector).find("input[name="+key+"]").length){
						$(selector).find("input[name="+key+"]").val(extra_data[key]);
					}else{
						$("<input type='hidden' name='"+key+"' class='__injected' value='"+extra_data[key]+"'/>").appendTo(selector);
					}
				}
			}
			return;
		}

		var counter=$('iframe._upload').length;
		var action=$(selector).attr('action');

		var temp=true;
		if ($(selector).hasClass('__xtemp')){
			temp=false;
		}

		var name="__iframeupload_"+AP.iframe_counter;
		AP.iframe_counter++;

		var pm_token=null;
		if (!AP.word.prefix(action, "http://") && !AP.word.prefix(action, "https://")){
			$(selector).attr('action',Client.ajax_url+"/"+action);
		}else{
			if (!AP.word.prefix(action, Client.ajax_url)){
				pm_token=AP.uuid();
				extra_data["pm_token"]=pm_token;
				$(selector).data("pm_token", pm_token);
			}
		}


		var ec="";
		if (temp){
			ec=" __temp";
		}
		var elem="<iframe class='_upload "+ec+"' id='"+name+"' name='"+name+"' src='about:blank' onload='return false;'/>";

		if (pm_token){
			$(elem).appendTo($("#ap-temp")).bind("load", function(){
			});

			AP.cors.register(action, pm_token, callback);
		}else{
			$(elem).appendTo($("#ap-temp")).bind("load", function(){
			  	ap_handleFrame(name, callback);
			});
		}




		$(selector).attr('enctype', "multipart/form-data");
		$(selector).attr('target',name);
		$(selector).attr('method','POST');

		$(selector)[0].target=name;
		$(selector)[0].enctype="multipart/form-data";
		if (!AP.word.prefix(action, "http://") && !AP.word.prefix(action, "https://")){
			$(selector)[0].action=Client.ajax_url+"/"+action;
		}
		$(selector)[0].method='POST';

		var text="<input type='hidden' name='__code' class='__injected' value='"+Client.code+"' />";
		if (Client.user && Client.user.id>=1){
			text+="<input type='hidden' name='__user' class='__injected' value='"+Client.user.id+"' />";
		}
		if (Client.base_network && Client.base_network.id>=1){
			text+="<input type='hidden' name='__base_network' class='__injected' value='"+Client.base_network.id+"'/>";
		}
		if (Client.network && Client.network.id>=1){
			text+="<input type='hidden' name='__network' class='__injected' value='"+Client.network.id+"'/>";
		}

		if (extra_data){
			for (var key in extra_data){
				text+="<input type='hidden' name='"+key+"' class='__injected' value='"+extra_data[key]+"'/>";
			}
		}

		if (AP.sys.ie()){
			text+="<input type='hidden' class='__injected' name='__apupload' value='1'/>";
			text+="<input type='hidden' class='__injected' name='__apiefix' value='1'/>";
		}else{
			text+="<input type='hidden' class='__injected' name='__via' value='__frame'/>";
		}

		$(selector).append(text);

		AP.sys.fire("form.pre.submit", selector);
	};


	var ap_handleFrame=function(name, callback){
		var txt=ap_getFrameText(name);

		if (txt && txt.length && txt.length>=2){
			var obj=parseCode(txt);
			if (callback){
				callback(obj);
			}
		}else{
			callback(new Code({code:0, message:"Unknown error (*)", data:null}));
		}
	};


	var ap_getFrameText=function(name){
		return $("#"+name).contents().find('html').text();
		// return window.frames[name].document.getElementsByTagName("body")[0].innerHTML;
	};

};


var Query=new function __Query(){
	this.__data={};
	this.init=function(data){
		this.__data=data;
	};

	this.get=function(key){
		if (key in this.__data){
			return this.__data[key];
		}
		return null;
	};

	this.getFlat=function(key){
		var val=this.get(key);
		if (val==null){
			return "";
		}

		return val;
	};

	this.getInt=function(key){
		var val=this.get(key);
		if (!val){
			return 0;
		}
		return parseInt(val);
	};

	this.set=function(key, val){
		this.__data[key]=val;
	};

	this.unset=function(key){
		delete this.__data[key];
	};

	this.setDefault=function(key, val){
		if (key in this.__data){
		}else{
			this.__data[key]=val;
		}
	};

	this.reset=function(){
		this.__data={};
	};

	this.all=function(){
		return this.__data;
	};

	
	/**
	 * @desc Safe release, to external variable, no side-effect
	 */
	this.release=function(){
		var obj= shallowClone(this.__data);
		delete obj.env;
		return obj;
	};
	
	this.text=function(){
		var txt="";

		for (var key in this.__data){
			if (key=="env"){
				continue;
			}

			txt+="&"+key+"="+this.__data[key];
		}

		return txt;
	};
};



AP.rules=[];

AP.rewrite=function(pattern, replace, callback, query_string_append){
	AP.rules.push({'pattern': pattern, 'replace': replace, 'callback': callback, 'qsa': query_string_append});
};


/**
 * @desc Check if an URL is matched by a particular rewrite rule
 * @param url
 */
AP.rewriteCheck=function(url){
	for (var i=0; i<AP.rules.length; i++){
		var temp=AP.rules[i];

		if (url.match(RegExp(temp.pattern))){
			var next=url.replace(new RegExp(temp.pattern), temp.replace);
			var fn=temp.callback;
			var paths=next.split("?");
			if (paths.length<2){
				return true;
			}else{
				var qs=queryStringToArray(paths[1]);
				return true;
			}
		}

	}

	return null;
};


/**
 * @desc Check if an URL is matched by a particular rewrite rule, and apply function directly
 * @param url
 */
AP.rewriteRedirect=function(url){
	for (var i=0; i<AP.rules.length; i++){
		var temp=AP.rules[i];

		if (url.match(RegExp(temp.pattern))){
			var qs={};
			var original_qs=url.split("?");
			if (original_qs.length==2 && temp.qsa){
				qs=queryStringToArray(original_qs[1]);
			}

			var next=url.replace(new RegExp(temp.pattern), temp.replace);
			var fn=temp.callback;
			var paths=next.split("?");

			if (paths.length<2){
				fn.call(AP.__urlref, qs);
				return true;
			}else{
				var new_qs=queryStringToArray(paths[1]);
				for (var key in new_qs){
					qs[key]=new_qs[key];
				}
				fn.call(AP.__urlref, qs);
				return true;
			}
		}

	}

	return null;
};




AP.config={};


AP.event=new function __APEvent(){
	this.events={};
	this.__fired={};

	this.clear=function(){
		this.events={};
		this.__fired={};
	};

	this.removeListener=function(ev){
		if (this.events[ev] && this.events[ev].length){
			this.events[ev]=[];
			delete this.events[ev];
		}
	};

	this.trigger=function(ev, data){
		if (this.events[ev] && this.events[ev].length){
			for (var i=0; i<this.events[ev].length; i++){
				var fn=this.events[ev][i];
				if (!fn){
					break;
				}

				if (fn._caller){
					fn.apply(fn._caller, data);
				}else{
					if (AP.data.isArray(data)){
						fn.apply(undefined, data);
					}else{
						fn(data);
					}

				}
			}
		}

		this.__fired[ev]=1;
		return this;
	};


	this.release=function(ev){
		if (this.events[ev] && this.events[ev].length){
			while (true){
				var fn=this.events[ev].shift();
				if (!fn){
					break;
				}

				if (fn._caller){
					fn.apply(fn._caller);
				}else{
					fn();
				}
			}
		}

		this.__fired[ev]=1;
		return this;
	};


	this.bind=function(ev, fx, _caller){
		if (!this.events[ev]){
			this.events[ev]=[];
		}

		if (_caller){
			fx._caller=_caller;
		}

		this.events[ev].push(fx);

		return this;
	};


	/**
	 * @desc Reset all current binds and rebind
	 */
	this.rebind=function(ev, fx, _caller){
		this.events[ev]=[];

		if (_caller){
			fx._caller=_caller;
		}

		this.events[ev].push(fx);

		return this;
	};



	this.bindAll=function(ev, fx, _caller){
		if (!this.events[ev]){
			this.events[ev]=[];
		}

		if (_caller){
			fx._caller=_caller;
		}

		this.events[ev]=[fx]; // Replace

		return this;
	};


	this.fired=function(ev){
		if (this.__fired[ev]){
			return true;
		}
		return false;
	};
};






function range(from, to, space){
	if (!space || typeof space=="undefined"){
		space=1;
	}

	var r=[];
	if (from<to){
		for (var i=from; i<=to; i=i+space){
			r.push(""+i);
		}
		return r;
	}else{
		for (var i=from; i>=to; i=i-space){
			r.push(""+i);
		}
		return r;
	}

};


function undone(msg){
	if (msg){
		AP.alertError(msg);
	}else{
		AP.alertError("This feature is either disabled or not ready for public yet. Please try again later.");
	}
};



//GetPageScroll() by quirksmode.com
function getViewport() {
	var xScroll, yScroll;
	if (self.pageYOffset) {
	  yScroll = self.pageYOffset;
	  xScroll = self.pageXOffset;
	} else if (document.documentElement && document.documentElement.scrollTop) {
	  yScroll = document.documentElement.scrollTop;
	  xScroll = document.documentElement.scrollLeft;
	} else if (document.body) {
	  yScroll = document.body.scrollTop;
	  xScroll = document.body.scrollLeft;
	}
	return new Array(xScroll,yScroll);
}


/**
 * @desc Getting the upload filename.
 */
function getUploadFN(str){
	str=str.replace(/\\/g,'/');
	var parts=str.split("/");
	if (!parts || parts.length<1){
		return false;
	}
	return parts[parts.length-1];
}



/**
 * @desc Get hash from an url.
 * @returns Array
 */
function getHash(href){
	if (!href){
		return null;
	}
	if (href.indexOf('#')!=-1){
		return null;
	}

	var path=href.split("//", 2);
	if (!path || path.length!=2){
		return;
	}
	var sub_path=path[1];
	var url=sub_path.split("/");
	if (!url || url.length<2){
		return;
	}
	url=AP.array.sub(url, 1);
	return url;
};


function safe(txt){
	return AP.purify(txt);
};

function inline(content, max_length){
	if (!max_length){
		max_length=255;
	}
	
	return AP.word.shorten(AP.purify(content),max_length," ");
};

function purify(txt){
	var str=safe(txt);
	var defaultDiacriticsRemovalMap = [
			{'base':'A', 'letters':/[\u0041\u24B6\uFF21\u00C0\u00C1\u00C2\u1EA6\u1EA4\u1EAA\u1EA8\u00C3\u0100\u0102\u1EB0\u1EAE\u1EB4\u1EB2\u0226\u01E0\u00C4\u01DE\u1EA2\u00C5\u01FA\u01CD\u0200\u0202\u1EA0\u1EAC\u1EB6\u1E00\u0104\u023A\u2C6F]/g},
			{'base':'AA','letters':/[\uA732]/g},
			{'base':'AE','letters':/[\u00C6\u01FC\u01E2]/g},
			{'base':'AO','letters':/[\uA734]/g},
			{'base':'AU','letters':/[\uA736]/g},
			{'base':'AV','letters':/[\uA738\uA73A]/g},
			{'base':'AY','letters':/[\uA73C]/g},
			{'base':'B', 'letters':/[\u0042\u24B7\uFF22\u1E02\u1E04\u1E06\u0243\u0182\u0181]/g},
			{'base':'C', 'letters':/[\u0043\u24B8\uFF23\u0106\u0108\u010A\u010C\u00C7\u1E08\u0187\u023B\uA73E]/g},
			{'base':'D', 'letters':/[\u0044\u24B9\uFF24\u1E0A\u010E\u1E0C\u1E10\u1E12\u1E0E\u0110\u018B\u018A\u0189\uA779]/g},
			{'base':'DZ','letters':/[\u01F1\u01C4]/g},
			{'base':'Dz','letters':/[\u01F2\u01C5]/g},
			{'base':'E', 'letters':/[\u0045\u24BA\uFF25\u00C8\u00C9\u00CA\u1EC0\u1EBE\u1EC4\u1EC2\u1EBC\u0112\u1E14\u1E16\u0114\u0116\u00CB\u1EBA\u011A\u0204\u0206\u1EB8\u1EC6\u0228\u1E1C\u0118\u1E18\u1E1A\u0190\u018E]/g},
			{'base':'F', 'letters':/[\u0046\u24BB\uFF26\u1E1E\u0191\uA77B]/g},
			{'base':'G', 'letters':/[\u0047\u24BC\uFF27\u01F4\u011C\u1E20\u011E\u0120\u01E6\u0122\u01E4\u0193\uA7A0\uA77D\uA77E]/g},
			{'base':'H', 'letters':/[\u0048\u24BD\uFF28\u0124\u1E22\u1E26\u021E\u1E24\u1E28\u1E2A\u0126\u2C67\u2C75\uA78D]/g},
			{'base':'I', 'letters':/[\u0049\u24BE\uFF29\u00CC\u00CD\u00CE\u0128\u012A\u012C\u0130\u00CF\u1E2E\u1EC8\u01CF\u0208\u020A\u1ECA\u012E\u1E2C\u0197]/g},
			{'base':'J', 'letters':/[\u004A\u24BF\uFF2A\u0134\u0248]/g},
			{'base':'K', 'letters':/[\u004B\u24C0\uFF2B\u1E30\u01E8\u1E32\u0136\u1E34\u0198\u2C69\uA740\uA742\uA744\uA7A2]/g},
			{'base':'L', 'letters':/[\u004C\u24C1\uFF2C\u013F\u0139\u013D\u1E36\u1E38\u013B\u1E3C\u1E3A\u0141\u023D\u2C62\u2C60\uA748\uA746\uA780]/g},
			{'base':'LJ','letters':/[\u01C7]/g},
			{'base':'Lj','letters':/[\u01C8]/g},
			{'base':'M', 'letters':/[\u004D\u24C2\uFF2D\u1E3E\u1E40\u1E42\u2C6E\u019C]/g},
			{'base':'N', 'letters':/[\u004E\u24C3\uFF2E\u01F8\u0143\u00D1\u1E44\u0147\u1E46\u0145\u1E4A\u1E48\u0220\u019D\uA790\uA7A4]/g},
			{'base':'NJ','letters':/[\u01CA]/g},
			{'base':'Nj','letters':/[\u01CB]/g},
			{'base':'O', 'letters':/[\u004F\u24C4\uFF2F\u00D2\u00D3\u00D4\u1ED2\u1ED0\u1ED6\u1ED4\u00D5\u1E4C\u022C\u1E4E\u014C\u1E50\u1E52\u014E\u022E\u0230\u00D6\u022A\u1ECE\u0150\u01D1\u020C\u020E\u01A0\u1EDC\u1EDA\u1EE0\u1EDE\u1EE2\u1ECC\u1ED8\u01EA\u01EC\u00D8\u01FE\u0186\u019F\uA74A\uA74C]/g},
			{'base':'OI','letters':/[\u01A2]/g},
			{'base':'OO','letters':/[\uA74E]/g},
			{'base':'OU','letters':/[\u0222]/g},
			{'base':'P', 'letters':/[\u0050\u24C5\uFF30\u1E54\u1E56\u01A4\u2C63\uA750\uA752\uA754]/g},
			{'base':'Q', 'letters':/[\u0051\u24C6\uFF31\uA756\uA758\u024A]/g},
			{'base':'R', 'letters':/[\u0052\u24C7\uFF32\u0154\u1E58\u0158\u0210\u0212\u1E5A\u1E5C\u0156\u1E5E\u024C\u2C64\uA75A\uA7A6\uA782]/g},
			{'base':'S', 'letters':/[\u0053\u24C8\uFF33\u1E9E\u015A\u1E64\u015C\u1E60\u0160\u1E66\u1E62\u1E68\u0218\u015E\u2C7E\uA7A8\uA784]/g},
			{'base':'T', 'letters':/[\u0054\u24C9\uFF34\u1E6A\u0164\u1E6C\u021A\u0162\u1E70\u1E6E\u0166\u01AC\u01AE\u023E\uA786]/g},
			{'base':'TZ','letters':/[\uA728]/g},
			{'base':'U', 'letters':/[\u0055\u24CA\uFF35\u00D9\u00DA\u00DB\u0168\u1E78\u016A\u1E7A\u016C\u00DC\u01DB\u01D7\u01D5\u01D9\u1EE6\u016E\u0170\u01D3\u0214\u0216\u01AF\u1EEA\u1EE8\u1EEE\u1EEC\u1EF0\u1EE4\u1E72\u0172\u1E76\u1E74\u0244]/g},
			{'base':'V', 'letters':/[\u0056\u24CB\uFF36\u1E7C\u1E7E\u01B2\uA75E\u0245]/g},
			{'base':'VY','letters':/[\uA760]/g},
			{'base':'W', 'letters':/[\u0057\u24CC\uFF37\u1E80\u1E82\u0174\u1E86\u1E84\u1E88\u2C72]/g},
			{'base':'X', 'letters':/[\u0058\u24CD\uFF38\u1E8A\u1E8C]/g},
			{'base':'Y', 'letters':/[\u0059\u24CE\uFF39\u1EF2\u00DD\u0176\u1EF8\u0232\u1E8E\u0178\u1EF6\u1EF4\u01B3\u024E\u1EFE]/g},
			{'base':'Z', 'letters':/[\u005A\u24CF\uFF3A\u0179\u1E90\u017B\u017D\u1E92\u1E94\u01B5\u0224\u2C7F\u2C6B\uA762]/g},
			{'base':'a', 'letters':/[\u0061\u24D0\uFF41\u1E9A\u00E0\u00E1\u00E2\u1EA7\u1EA5\u1EAB\u1EA9\u00E3\u0101\u0103\u1EB1\u1EAF\u1EB5\u1EB3\u0227\u01E1\u00E4\u01DF\u1EA3\u00E5\u01FB\u01CE\u0201\u0203\u1EA1\u1EAD\u1EB7\u1E01\u0105\u2C65\u0250]/g},
			{'base':'aa','letters':/[\uA733]/g},
			{'base':'ae','letters':/[\u00E6\u01FD\u01E3]/g},
			{'base':'ao','letters':/[\uA735]/g},
			{'base':'au','letters':/[\uA737]/g},
			{'base':'av','letters':/[\uA739\uA73B]/g},
			{'base':'ay','letters':/[\uA73D]/g},
			{'base':'b', 'letters':/[\u0062\u24D1\uFF42\u1E03\u1E05\u1E07\u0180\u0183\u0253]/g},
			{'base':'c', 'letters':/[\u0063\u24D2\uFF43\u0107\u0109\u010B\u010D\u00E7\u1E09\u0188\u023C\uA73F\u2184]/g},
			{'base':'d', 'letters':/[\u0064\u24D3\uFF44\u1E0B\u010F\u1E0D\u1E11\u1E13\u1E0F\u0111\u018C\u0256\u0257\uA77A]/g},
			{'base':'dz','letters':/[\u01F3\u01C6]/g},
			{'base':'e', 'letters':/[\u0065\u24D4\uFF45\u00E8\u00E9\u00EA\u1EC1\u1EBF\u1EC5\u1EC3\u1EBD\u0113\u1E15\u1E17\u0115\u0117\u00EB\u1EBB\u011B\u0205\u0207\u1EB9\u1EC7\u0229\u1E1D\u0119\u1E19\u1E1B\u0247\u025B\u01DD]/g},
			{'base':'f', 'letters':/[\u0066\u24D5\uFF46\u1E1F\u0192\uA77C]/g},
			{'base':'g', 'letters':/[\u0067\u24D6\uFF47\u01F5\u011D\u1E21\u011F\u0121\u01E7\u0123\u01E5\u0260\uA7A1\u1D79\uA77F]/g},
			{'base':'h', 'letters':/[\u0068\u24D7\uFF48\u0125\u1E23\u1E27\u021F\u1E25\u1E29\u1E2B\u1E96\u0127\u2C68\u2C76\u0265]/g},
			{'base':'hv','letters':/[\u0195]/g},
			{'base':'i', 'letters':/[\u0069\u24D8\uFF49\u00EC\u00ED\u00EE\u0129\u012B\u012D\u00EF\u1E2F\u1EC9\u01D0\u0209\u020B\u1ECB\u012F\u1E2D\u0268\u0131]/g},
			{'base':'j', 'letters':/[\u006A\u24D9\uFF4A\u0135\u01F0\u0249]/g},
			{'base':'k', 'letters':/[\u006B\u24DA\uFF4B\u1E31\u01E9\u1E33\u0137\u1E35\u0199\u2C6A\uA741\uA743\uA745\uA7A3]/g},
			{'base':'l', 'letters':/[\u006C\u24DB\uFF4C\u0140\u013A\u013E\u1E37\u1E39\u013C\u1E3D\u1E3B\u017F\u0142\u019A\u026B\u2C61\uA749\uA781\uA747]/g},
			{'base':'lj','letters':/[\u01C9]/g},
			{'base':'m', 'letters':/[\u006D\u24DC\uFF4D\u1E3F\u1E41\u1E43\u0271\u026F]/g},
			{'base':'n', 'letters':/[\u006E\u24DD\uFF4E\u01F9\u0144\u00F1\u1E45\u0148\u1E47\u0146\u1E4B\u1E49\u019E\u0272\u0149\uA791\uA7A5]/g},
			{'base':'nj','letters':/[\u01CC]/g},
			{'base':'o', 'letters':/[\u006F\u24DE\uFF4F\u00F2\u00F3\u00F4\u1ED3\u1ED1\u1ED7\u1ED5\u00F5\u1E4D\u022D\u1E4F\u014D\u1E51\u1E53\u014F\u022F\u0231\u00F6\u022B\u1ECF\u0151\u01D2\u020D\u020F\u01A1\u1EDD\u1EDB\u1EE1\u1EDF\u1EE3\u1ECD\u1ED9\u01EB\u01ED\u00F8\u01FF\u0254\uA74B\uA74D\u0275]/g},
			{'base':'oi','letters':/[\u01A3]/g},
			{'base':'ou','letters':/[\u0223]/g},
			{'base':'oo','letters':/[\uA74F]/g},
			{'base':'p','letters':/[\u0070\u24DF\uFF50\u1E55\u1E57\u01A5\u1D7D\uA751\uA753\uA755]/g},
			{'base':'q','letters':/[\u0071\u24E0\uFF51\u024B\uA757\uA759]/g},
			{'base':'r','letters':/[\u0072\u24E1\uFF52\u0155\u1E59\u0159\u0211\u0213\u1E5B\u1E5D\u0157\u1E5F\u024D\u027D\uA75B\uA7A7\uA783]/g},
			{'base':'s','letters':/[\u0073\u24E2\uFF53\u00DF\u015B\u1E65\u015D\u1E61\u0161\u1E67\u1E63\u1E69\u0219\u015F\u023F\uA7A9\uA785\u1E9B]/g},
			{'base':'t','letters':/[\u0074\u24E3\uFF54\u1E6B\u1E97\u0165\u1E6D\u021B\u0163\u1E71\u1E6F\u0167\u01AD\u0288\u2C66\uA787]/g},
			{'base':'tz','letters':/[\uA729]/g},
			{'base':'u','letters':/[\u0075\u24E4\uFF55\u00F9\u00FA\u00FB\u0169\u1E79\u016B\u1E7B\u016D\u00FC\u01DC\u01D8\u01D6\u01DA\u1EE7\u016F\u0171\u01D4\u0215\u0217\u01B0\u1EEB\u1EE9\u1EEF\u1EED\u1EF1\u1EE5\u1E73\u0173\u1E77\u1E75\u0289]/g},
			{'base':'v','letters':/[\u0076\u24E5\uFF56\u1E7D\u1E7F\u028B\uA75F\u028C]/g},
			{'base':'vy','letters':/[\uA761]/g},
			{'base':'w','letters':/[\u0077\u24E6\uFF57\u1E81\u1E83\u0175\u1E87\u1E85\u1E98\u1E89\u2C73]/g},
			{'base':'x','letters':/[\u0078\u24E7\uFF58\u1E8B\u1E8D]/g},
			{'base':'y','letters':/[\u0079\u24E8\uFF59\u1EF3\u00FD\u0177\u1EF9\u0233\u1E8F\u00FF\u1EF7\u1E99\u1EF5\u01B4\u024F\u1EFF]/g},
			{'base':'z','letters':/[\u007A\u24E9\uFF5A\u017A\u1E91\u017C\u017E\u1E93\u1E95\u01B6\u0225\u0240\u2C6C\uA763]/g}
		  ];

	for (var i=0; i<defaultDiacriticsRemovalMap.length; i++) {
		str = str.replace(defaultDiacriticsRemovalMap[i].letters, defaultDiacriticsRemovalMap[i].base);
	}

	str=str.replace(/[\W_]+/g," ");
	str=$.trim(str);
	return str.toLowerCase();
};

function purifyStrict(str){
	var s=purify(str);
	s=s.replace(/[\W_\s]+/g,"");
	return s.toLowerCase();
};

function shallowClone(obj){
	if (!AP.data.isObject(obj)){
		return obj;
	}
	
	var temp={};
	for (var key in obj){
		temp[key]=obj[key];
	}

	return temp;
};


/*! Copyright (c) 2008 Brandon Aaron (brandon.aaron@gmail.com || http://brandonaaron.net)
 * Dual licensed under the MIT (http://www.opensource.org/licenses/mit-license.php)
 * and GPL (http://www.opensource.org/licenses/gpl-license.php) licenses.
 */

/**
 * Gets the width of the OS scrollbar
 */
function getScrollbarWidth(){
	var jTest = $('<div style="display:none;height:50px;overflow: scroll"><div style="height:100px;"></div></div>');
    $('body').append(jTest);
    var w = jTest.innerWidth();
    jTest.css({
        overflow: 'auto',
        height: '200px'
    });
    var w2 = jTest.innerWidth();
    var c= w-w2;

	return (c > 0) ? c : 15; // fix invisible scrollbar on MacOSX
	
	var scrollbarWidth = 0;
	if (!scrollbarWidth) {
		if ( $.browser.msie ) {
			var $textarea1 = $('<textarea cols="10" rows="2"></textarea>')
					.css({ position: 'absolute', top: -1000, left: -1000 }).appendTo('body'),
				$textarea2 = $('<textarea cols="10" rows="2" style="overflow: hidden;"></textarea>')
					.css({ position: 'absolute', top: -1000, left: -1000 }).appendTo('body');
			scrollbarWidth = $textarea1.width() - $textarea2.width();
			$textarea1.add($textarea2).remove();
		} else {
			var $div = $('<div />')
				.css({ width: 100, height: 100, overflow: 'auto', position: 'absolute', top: -1000, left: -1000 })
				.prependTo('body').append('<div />').find('div')
					.css({ width: '100%', height: 200 });
			scrollbarWidth = 100 - $div.width();
			$div.parent().remove();
		}
	}
	return scrollbarWidth;
};





/**
 * @desc AJAX-returned Code Object
 * @param txt
 * @returns {Code}
 */

function parseCode(txt){
	if (AP.isObject(txt)){
		return new Code(txt);
	}

	try{
		var tmp = txt.substring(txt.indexOf('{"code"'));
		return new Code(eval("("+tmp+")"));
	}catch(e){
		return new Code({"code":0, "message":'Unknown Error',"data":null, "error":"parse error"});
	}
}




var ExitCode = new function _ExitCode(){
	this.fns={};

	/**
	 * @desc Register a callback on code
	 */
	this.reg=function(code, fn){
		this.fns[code]=fn;
	};


	/**
	 * @desc Execute the callback marked by code (and data is the param)
	 */
	this.execute=function(code, data){
		var fn=this.fns[code];
		if (fn){
			fn(data);
		}else{
			$.log("Unknown exitcode "+code);
		}
	}
};

/**
 * @desc Quickly build associcate array
 * @param data
 * @returns
 */
function assoc(data){
	if (AP.data.isArray(data)){
		var obj={};
		for (var i=0; i<data.length; i++){
			obj[data[i].name]=data[i].value;
		}
		return obj;	
	}
	
	var obj={};
	obj[arguments[0]]=arguments[1];
	return obj;
};


function mobile(){
	return (Client.mobile && Client.mobile==1);
};


function __(str, cond){
	if (cond) return str;
	return "";
};


function ___(str, other){
	if (!str || !str.length){
		return other;
	}
	return str;
};



/**
 * @desc This is the class to handle Ajax return result.
 */

function Code(obj){
	this.code=0;
	this.message='';
	this.data=null;

	if (obj){
		$.extend(this, obj);
		this.code=parseInt(this.code);
	}


	/**
	 * @desc Check if a code is good.
	 */
	this.good=function(){
		if (this.hasCode(1)) return true;
		return false;
	};

	this.notEmpty=function(){
		return !this.empty;
	};

	this.hasCode=function(code){
		if (this.code==code){
			return true;
		}
		return false;
	};


	this.hasMessage=function(message){
		if (this.message==message){
			return true;
		}
		if (AP.isInt(message) && this.message && message==parseInt(this.message)){
			return true;
		}
		return false;
	};
};



Code.init=function(txt){
	try{
		return new Code(eval("("+txt+")"));
	}
	catch(e){
		return new Code({"code":0, "message":'Unknown error',"data":null, "error":"parse_error"});
	}
};





var fxs={};
var fxe={};

function APJSONCALLBACK(data){
	if (data.fx){
		var fn=fxs[data.fx];
		var code=new Code(data);
		if (code){
			fn(code);
		}else{
			var err=fxe[data.fx];
			if (err){
				err(code);
			}
		}
		$("#"+data.fx).remove();
	}
};


function APJSONREG(fx, fn, fn_error){
	fxs[fx]=fn;
	fxe[fx]=fn_error;
};


function queryStringToArray(qs){
	var parts=qs.split("&");
	var r={};
	for (var i=0; i<parts.length; i++){
		var data=parts[i].split("=");
		if (data && data.length==2){
			r[data[0]]=data[1];
		}
	}

	return r;
};


function isFormData(data){
	return (data && Client.native && data instanceof FormData);
};







function __selfcall(ref){
	var fn=$(ref).data("action");
	fn();
};



function $$(fn){
	if (Client.env && !parseInt(Client.env)){
		fn();
	}
};




AP._locales={};

AP.locale=new function __APLocale(){
	this.get=function(key, df){
		if (AP._locales[key]){
			return AP._locales[key];
		}
		if (df){
			return df;
		}

		return null;
	}

	this.set=function(key, val){
		AP._locales[key]=val;
	};

};




AP.cors=new function __APCORS(){
	this.url=null;
	this.pm_token=null;
	this.callback=null;
	this.__init=false;

	this.register=function(url, token, callback){
		this.init();
		this.url=url;
		this.pm_token=token;
		this.callback=callback;
	};


	this.init=function(){
		// INIT ONCE
		if (this.__init){
			return;
		}

		this.__init=true;

		var eventMethod = window.addEventListener ? "addEventListener" : "attachEvent";
		var apeventer = window[eventMethod];
		var messageEvent = eventMethod == "attachEvent" ? "onmessage" : "message";

		// Listen to message from child window
		apeventer(messageEvent, function(e) {
			if (typeof e.data.pm_token == 'undefined') return;
			if (e.data.pm_token!=AP.cors.pm_token){
				AP.alertError("Security error (invalid pm token)");
			}

			if (!AP.word.prefix(AP.cors.url, e.origin)){
				AP.alertError("Security error (invalid origin)");
			}

			var obj=parseCode(e.data);
			if (AP.cors.callback){
				AP.cors.callback(obj);
			}
		}, false);
	}
};



AP.postmessage=new function __APPostMessage(){
	this.__inited=false;
	this.__token = 0;
	this.events={};
	
	this.init=function(){
		if (this.__inited){
			return;
		}
		
		this.__inited=true;
		this.__token=AP.uuid();
		
		this.listen(function(data, domain){
			var event=data.event;
			var token=data.token;
			if (token!=AP.postmessage.token()){
				$.log("POST_MESSAGE_TOKEN_ERROR");
				return;
			}
			
			var fn=AP.postmessage.events[event];
			if (fn){
				fn(data);
			}
		});
	};
	
	this.register=function(event, callback){
		this.events[event]=callback;
	};
	
	this.token=function(){
		this.init();
		return this.__token;
	};
	
	
	this.toParent=function(data, parent_domain){
		data.token= Query.get("base_token");
		data.event= Query.get("event");
		
		parent.postMessage(data, parent_domain);
	};

	this.toAll=function(ifr_selector, data){
		$(document.body).find(ifr_selector).each(function(){
			$(this).on("load", function(){
				$(this).data("loaded", 1);
				var src=$(this).attr("src");
				var fr=$(this)[0].contentWindow;
				var domain=getDomain($(this).attr("src"));
				fr.postMessage(data, domain);
			});

			if (!$(this).is(":visible")){
				return;
			}

			var src=$(this).attr("src");
			var fr=$(this)[0].contentWindow;
			var domain=getDomain($(this).attr("src"));
			fr.postMessage(data, domain);

		});
	};

	this.toChild=function(ifr, data){
		$(ifr).each(function(){
			$(this).on("load", function(){
				$(this).data("loaded", 1);
				var src=$(this).attr("src");
				var fr=$(this)[0].contentWindow;
				var domain=getDomain($(this).attr("src"));
				fr.postMessage(data, domain);
			});

			if (!$(this).is(":visible")){
				return;
			}

			var src=$(this).attr("src");
			var fr=$(this)[0].contentWindow;
			var domain=getDomain($(this).attr("src"));
			fr.postMessage(data, domain);

		});
	};

	this.listen=function(handler){
		var eventMethod = window.addEventListener ? "addEventListener" : "attachEvent";
		var eventer = window[eventMethod];
		var messageEvent = eventMethod == "attachEvent" ? "onmessage" : "message";

		eventer(messageEvent,function(e){
			handler(e.data, e.origin);
		},false);
	};


	function getDomain(url){
		var part=AP.word.split("/", url);
		if (part.length<2){
			return "*";
		}

		return part[0]+"//"+part[1];
	};
};


AP.cmp=new function __APCmp(){
	this.int=function(a, b){
		return parseInt(a)==parseInt(b);
	};

	this.str=function(a,b){
		return a.toLowercase()==b.toLowercase();
	}
};



function explain(txt, opts){
	if (opts && opts===true){
		opts={icon: false};
	}

	opts=$.extend({direction: 'up', width: 200, icon: true}, opts);

	if (!opts.icon){
		return "<span class='-infobox -"+opts.direction+" -w"+opts.width+"'><span class='-box block normal'>"+txt+"</span></span>";
	}

	return "&nbsp; <span class='inline relative -infow'><span class='-ap icon-help-with-circle'></span> <span class='-infobox -"+opts.direction+" -w"+opts.width+"'><span class='-box block normal'>"+txt+"</span></span></span>";
};



(function() {
	var beforePrint = function() {
		AP.__printing=1;
	};
	var afterPrint = function() {
		AP.__printing=0;
	};

	if (window.matchMedia) {
		var mediaQueryList = window.matchMedia('print');
		mediaQueryList.addListener(function(mql) {
			if (mql.matches) {
				beforePrint();
			} else {
				afterPrint();
			}
		});
	}

	window.onbeforeprint = beforePrint;
	window.onafterprint = afterPrint;
}());




AP.i18n=new function __APi18n(){
	this.confs={date_format: "dmy", time_format:"hm"};
	
	this.get=function(key){
		var confs=$.extend(this.confs, Client.i18n);
		return confs[key];
	};
	
	this.dateFormat=function(){
		var format=this.get("date_format");
		if (format=="dmy"){
			return "%d/%m/%Y";
		}else if (format=="full"){
			return "%l, %F %d, %Y";
		}else{
			return "%m/%d/%Y";
		}
	};
	
	this.date=function(ts){
		return AP.time.time(this.dateFormat(), ts);
	};
	
	this.datetime=function(ts){
		return AP.time.time("%H:%i "+this.dateFormat(), ts);
	};
	
	this.time=function(ts){
		return AP.time.time("%H:%i", ts);
	};
	
	this.readDate=function(str){
		var data=str.split("/");
		if (data.length!=3){
			return 0;
		}
		
		var day=parseInt(data[0]);
		var month=parseInt(data[1])-1;
		var year=parseInt(data[2]);
		
		var ts=new Date(year, month, day, 0, 0, 0, 0);
		return Math.floor(ts.getTime()/1000);
	};
	
	this.dateRange=function(stime, etime){
		stime=parseInt(stime);
		etime=parseInt(etime);
		
		if (etime){
			if (AP.time.sameYear(stime, etime)){
				return AP.time.time("%d/%m", stime)+" - " + AP.time.time("%d/%m/%y", etime);
			}else{
				return AP.time.time("%d/%m/%y", stime)+" - " + AP.time.time("%d/%m/%y", etime);
			}
		}else{
			if (parseInt(stime)){
				return AP.time.time("%d/%m/%y", stime)+" &#8702; ... ";
			}else{
				return "... "+" &#8702; ... ";	
			}
		}
	};
	
	
	this.timeRange=function(stime, etime){
		stime=parseInt(stime);
		etime=parseInt(etime);
		
		if (etime){
			if (AP.time.sameYear(stime, etime)){
				return AP.time.time("%H:%i %d/%m", stime)+" - " + AP.time.time("%H:%i %d/%m", etime);
			}else{
				return AP.time.time("%H:%i %d/%m", stime)+" - " + AP.time.time("%H:%i %d/%m", etime);
			}
		}else{
			return AP.time.time("%H:%i %d/%m/%y", stime)+" &#8702; ... ";
		}
	};
	
	this.range=this.dateRange;
	
	
	
	this.duration=function(total_seconds, compact){
		if (compact){
			return this.durationCompact(total_seconds);
			
		}
		
		var s=parseInt(total_seconds);
		if (s<3600){
			var m=Math.floor(s/60);
			return "<em>"+(m)+"</em>m";
		}
		
		if (s<48*3600){
			var h=Math.floor(s/3600);
			var m=Math.floor((s-h*3600)/60);
			return "<em>"+(h)+"</em>h<em>"+(m)+"</em>m";
		}
		
		var d=Math.floor(s/(24*3600));
		var h=Math.floor((s-d*24*3600)/3600);
		var m=Math.floor((s-d*24*3600-h*3600)/60);
		return "<em>"+(d)+"</em>d<em>"+(h)+"</em>h<em>"+(m)+"</em>m";
	};
	
	
	this.durationCompact=function(total_seconds){
		var s=parseInt(total_seconds);
		if (s<3600){
			var m=parseFloat(s/60).toFixed(1);
			return "<em>"+(m)+"</em>m";
		}
		
		if (s<48*3600){
			var h=parseFloat(s/3600).toFixed(1);
			return "<em>"+(h)+"</em>h";
		}
		
		var d=parseFloat(s/(24*3600)).toFixed(1);
		return "<em>"+(d)+"</em>d";
	};
	
};


AP.hotkey=new function __APHotKey(){
	this.__init=false;
	this.__dialog=false;
	this.events={};
	
	
	this.init=function(dialog){
		if (this.__init){
			return this;
		}
		
		if (!dialog){
			dialog=false;
		}
		
		this.__dialog=dialog;
		this.__init=true;
		this.bind();
		return this;
	};
	
	this.on=function(key, fn){
		this.events[key]=fn;
		return this;
	};
	
	this.clear=function(){
		this.__init=false;
		this.events={};
		
		return this;
	};
	
	
	this.moveable=function(elems, options){
		if (!options){
			options={};
		}
		
		options=$.extend({first: -1, activeClass: 'active'}, options);
		this.on("up", function(e){
			refocus(elems, -1, options);
		}).on("down", function(e){
			refocus(elems, 1, options);
		}).on("enter", function(e){
			$(elems).filter(".active").first().find(".url").click();
		});
		
		$(elems).first().addClass("active");

	};
	
	
	
	this.bind=function(){
		$(document).on('keydown.__temp', function(e){
			if (!AP.hotkey.__dialog && $("#apdialogs").is(":visible")){
				return;
			}
			
			var tag = e.target.tagName.toLowerCase();
			if (tag != 'input' && tag != 'textarea' && !$(e.target).hasClass("trumbowyg-editor")){

				var ev=findCb(AP.hotkey.events, e.which);
				if (ev){
					if (ev.delay){
						setTimeout(function(){
							ev(e);
						}, 250);	
					}else{
						ev(e);
					}
				}
			}
		});
		
		return this;
	};
	
	function findCb(evs, keycode){
		if (keycode==AP.key.right && evs["right"]){
			return evs["right"];
		}
		
		if (keycode==AP.key.left && evs["left"]){
			return evs["left"];
		}
		
		if (keycode==AP.key.down && evs["down"]){
			return evs["down"];
		}
		
		if (keycode==AP.key.up && evs["up"]){
			return evs["up"];
		}
		
		if (keycode==AP.key.enter && evs["enter"]){
			return evs["enter"];
		}
		
		var c=String.fromCharCode(keycode);
		if (c.match(/^[a-z0-9]+$/i)){
			if (evs[c.toLowerCase()]){
				evs[c.toLowerCase()].delay=1;
				return evs[c.toLowerCase()];
			}
		}
		
		return null;
	};
	
	
	function refocus(elems, pace, options){
		var $elems=$(elems);
		var $elem=$elems.filter(".active");
		var $c=null;
		
		if (!$elem.length){
			$elems.first().addClass("active");
			$c=$elems.first();
		}else{
			if (pace>0 && $elem.next().length){
				$elems.removeClass("active");
				$elem.next().addClass("active");
				$c=$elem.next();
			}else if (pace<0 && $elem.prev().length){
				$elems.removeClass("active");
				$elem.prev().addClass("active");
				$c=$elem.prev();
			}
		}
		
		if ($c && $c.length){
			var $box=$c.closest(".__apscrollbar_target");
			if (!$box.length){
				return;
			}
			var offset=$c.offset().top-$box.offset().top;
			// $.log([$c.offset().top, $box.offset().top, $box.scrollTop()]);
			// Layout.scrollTo($c, 150, 150);
		}
	};
};


function APCaret(ref){
	this.init=function(){
		
	};
};


AP.url=function(url){
	return new APURL(url);
};


function APURL(url){
	this.url=url;
	this.data={};
	
	this.q=function(key, val){
		if (val && val.length){
			this.data[key]=val;	
		}
		return this;
	};
	
	this.text=function(){
		var qs="";
		var total=0;
		for (var key in this.data){
			total++;
		}
		
		var cur=0;
		for (var key in this.data){
			cur++;
			if (cur<total){
				qs+=key+"="+this.data[key]+"&";	
			}else{
				qs+=key+"="+this.data[key];
			}
			
		}
		
		return this.url+"?"+qs;
	};
	
	
	this.current=function(){
		return window.location.href;
	};
	
	this.self=function(){
		return this.current;
	};
};


AP.currency=new function __APCurrency(){
	this.cur="vnd";
	
	/**
	 * @desc Init & set currency
	 */
	this.init=function(cur){
		this.cur=cur;
	};
	
	
	/**
	 * @desc Format a number by currency
	 */
	this.format=function(number, cur){
		if (!cur){
			cur=this.cur;
		}
		
		if (cur=="vnd"){
			return this.formatVND(number);
		}
	};
	
	
	this.full=function(number, cur){
		if (!cur){
			cur=this.cur;
		}
		
		if (cur=="vnd"){
			if (!number || number<0.001){
				return '&#8363;<em>0.00</em>';
			}
			
			return '&#8363;<em>'+AP.data.numberFormat(parseInt(number))+"</em>";
		}
	};
	
	
	/**
	 * @desc Alias of format()
	 */
	this.get=function(number, cur){
		return this.format(number, cur);
	};
	
	
	
	this.formatVND=function(number){
		if (!AP.data.isInt(number)){
			return "&#8363;0";
		}
		
		var n=parseInt(number);
		var txt=AP.data.numberFormat(n);
		
		if (n>1000000){
			txt="<b>"+(n/1000000).toFixed(2)+"</b>M";
		}else if (n>100000){
			txt="<b>"+(n/1000).toFixed(2)+"</b>K";
		}
		
		return "&#8363;"+txt;
	};
	
};


// Internal search and index engine to give O(n) operations on search
var SE=new function __SE(){
	this.data={};
	
	this.reset=function(){
		this.data={};
	};
	
	
	this.get=function(key, id){
		if (this.data["__"+key] && this.data["__"+key]["k"+id]){
			return this.data["__"+key]["k"+id];
		}
		
		return null;
	};
	
	
	/**
	 * @desc Init cache for O(1) finders
	 */
	this.cache=function(key, arr, index){
		if (!index){
			index='id';
		}
		
		this.data["__"+key]={};
		for (var i=0; i<arr.length; i++){
			this.data["__"+key]["k"+arr[i][index]]=arr[i];
		}
	};
	
	this.cached=function(key){
		if (this.data["__"+key]){
			return true;
		}
		
		return false;
	};
};


!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.Redux={})}(this,function(e){"use strict";var t=function(e){var t,r=e.Symbol;return"function"==typeof r?r.observable?t=r.observable:(t=r("observable"),r.observable=t):t="@@observable",t}("undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof module?module:Function("return this")()),r=function(){return Math.random().toString(36).substring(7).split("").join(".")},n={INIT:"@@redux/INIT"+r(),REPLACE:"@@redux/REPLACE"+r(),PROBE_UNKNOWN_ACTION:function(){return"@@redux/PROBE_UNKNOWN_ACTION"+r()}};function o(e,t){var r=t&&t.type;return"Given "+(r&&'action "'+r+'"'||"an action")+', reducer "'+e+'" returned undefined. To ignore an action, you must explicitly return the previous state. If you want this reducer to hold no value, you can return null instead of undefined.'}function i(e,t){return function(){return t(e.apply(this,arguments))}}function u(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function a(){for(var e=arguments.length,t=Array(e),r=0;e>r;r++)t[r]=arguments[r];return 0===t.length?function(e){return e}:1===t.length?t[0]:t.reduce(function(e,t){return function(){return e(t.apply(void 0,arguments))}})}e.createStore=function e(r,o,i){var u;if("function"==typeof o&&"function"==typeof i||"function"==typeof i&&"function"==typeof arguments[3])throw Error("It looks like you are passing several store enhancers to createStore(). This is not supported. Instead, compose them together to a single function");if("function"==typeof o&&void 0===i&&(i=o,o=void 0),void 0!==i){if("function"!=typeof i)throw Error("Expected the enhancer to be a function.");return i(e)(r,o)}if("function"!=typeof r)throw Error("Expected the reducer to be a function.");var a=r,c=o,f=[],s=f,d=!1;function l(){s===f&&(s=f.slice())}function p(){if(d)throw Error("You may not call store.getState() while the reducer is executing. The reducer has already received the state as an argument. Pass it down from the top reducer instead of reading it from the store.");return c}function h(e){if("function"!=typeof e)throw Error("Expected the listener to be a function.");if(d)throw Error("You may not call store.subscribe() while the reducer is executing. If you would like to be notified after the store has been updated, subscribe from a component and invoke store.getState() in the callback to access the latest state. See https://redux.js.org/api-reference/store#subscribe(listener) for more details.");var t=!0;return l(),s.push(e),function(){if(t){if(d)throw Error("You may not unsubscribe from a store listener while the reducer is executing. See https://redux.js.org/api-reference/store#subscribe(listener) for more details.");t=!1,l();var r=s.indexOf(e);s.splice(r,1)}}}function y(e){if(!function(e){if("object"!=typeof e||null===e)return!1;for(var t=e;null!==Object.getPrototypeOf(t);)t=Object.getPrototypeOf(t);return Object.getPrototypeOf(e)===t}(e))throw Error("Actions must be plain objects. Use custom middleware for async actions.");if(void 0===e.type)throw Error('Actions may not have an undefined "type" property. Have you misspelled a constant?');if(d)throw Error("Reducers may not dispatch actions.");try{d=!0,c=a(c,e)}finally{d=!1}for(var t=f=s,r=0;t.length>r;r++)(0,t[r])();return e}return y({type:n.INIT}),(u={dispatch:y,subscribe:h,getState:p,replaceReducer:function(e){if("function"!=typeof e)throw Error("Expected the nextReducer to be a function.");a=e,y({type:n.REPLACE})}})[t]=function(){var e,r=h;return(e={subscribe:function(e){if("object"!=typeof e||null===e)throw new TypeError("Expected the observer to be an object.");function t(){e.next&&e.next(p())}return t(),{unsubscribe:r(t)}}})[t]=function(){return this},e},u},e.combineReducers=function(e){for(var t=Object.keys(e),r={},i=0;t.length>i;i++){var u=t[i];"function"==typeof e[u]&&(r[u]=e[u])}var a,c=Object.keys(r);try{!function(e){Object.keys(e).forEach(function(t){var r=e[t];if(void 0===r(void 0,{type:n.INIT}))throw Error('Reducer "'+t+"\" returned undefined during initialization. If the state passed to the reducer is undefined, you must explicitly return the initial state. The initial state may not be undefined. If you don't want to set a value for this reducer, you can use null instead of undefined.");if(void 0===r(void 0,{type:n.PROBE_UNKNOWN_ACTION()}))throw Error('Reducer "'+t+"\" returned undefined when probed with a random type. Don't try to handle "+n.INIT+' or other actions in "redux/*" namespace. They are considered private. Instead, you must return the current state for any unknown actions, unless it is undefined, in which case you must return the initial state, regardless of the action type. The initial state may not be undefined, but can be null.')})}(r)}catch(e){a=e}return function(e,t){if(void 0===e&&(e={}),a)throw a;for(var n=!1,i={},u=0;c.length>u;u++){var f=c[u],s=e[f],d=(0,r[f])(s,t);if(void 0===d){var l=o(f,t);throw Error(l)}i[f]=d,n=n||d!==s}return n?i:e}},e.bindActionCreators=function(e,t){if("function"==typeof e)return i(e,t);if("object"!=typeof e||null===e)throw Error("bindActionCreators expected an object or a function, instead received "+(null===e?"null":typeof e)+'. Did you write "import ActionCreators from" instead of "import * as ActionCreators from"?');for(var r=Object.keys(e),n={},o=0;r.length>o;o++){var u=r[o],a=e[u];"function"==typeof a&&(n[u]=i(a,t))}return n},e.applyMiddleware=function(){for(var e=arguments.length,t=Array(e),r=0;e>r;r++)t[r]=arguments[r];return function(e){return function(){var r=e.apply(void 0,arguments),n=function(){throw Error("Dispatching while constructing your middleware is not allowed. Other middleware would not be applied to this dispatch.")},o={getState:r.getState,dispatch:function(){return n.apply(void 0,arguments)}},i=t.map(function(e){return e(o)});return function(e){for(var t=1;arguments.length>t;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){u(e,t,r[t])})}return e}({},r,{dispatch:n=a.apply(void 0,i)(r.dispatch)})}}},e.compose=a,e.__DO_NOT_USE__ActionTypes=n,Object.defineProperty(e,"__esModule",{value:!0})});


(function(global,factory){typeof exports==="object"&&typeof module!=="undefined"?module.exports=factory(global):typeof define==="function"&&define.amd?define(factory):factory(global)})(typeof self!=="undefined"?self:typeof window!=="undefined"?window:typeof global!=="undefined"?global:this,function(global){"use strict";var _Base64=global.Base64;var version="2.5.0";var buffer;if(typeof module!=="undefined"&&module.exports){try{buffer=eval("require('buffer').Buffer")}catch(err){buffer=undefined}}var b64chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";var b64tab=function(bin){var t={};for(var i=0,l=bin.length;i<l;i++)t[bin.charAt(i)]=i;return t}(b64chars);var fromCharCode=String.fromCharCode;var cb_utob=function(c){if(c.length<2){var cc=c.charCodeAt(0);return cc<128?c:cc<2048?fromCharCode(192|cc>>>6)+fromCharCode(128|cc&63):fromCharCode(224|cc>>>12&15)+fromCharCode(128|cc>>>6&63)+fromCharCode(128|cc&63)}else{var cc=65536+(c.charCodeAt(0)-55296)*1024+(c.charCodeAt(1)-56320);return fromCharCode(240|cc>>>18&7)+fromCharCode(128|cc>>>12&63)+fromCharCode(128|cc>>>6&63)+fromCharCode(128|cc&63)}};var re_utob=/[\uD800-\uDBFF][\uDC00-\uDFFFF]|[^\x00-\x7F]/g;var utob=function(u){return u.replace(re_utob,cb_utob)};var cb_encode=function(ccc){var padlen=[0,2,1][ccc.length%3],ord=ccc.charCodeAt(0)<<16|(ccc.length>1?ccc.charCodeAt(1):0)<<8|(ccc.length>2?ccc.charCodeAt(2):0),chars=[b64chars.charAt(ord>>>18),b64chars.charAt(ord>>>12&63),padlen>=2?"=":b64chars.charAt(ord>>>6&63),padlen>=1?"=":b64chars.charAt(ord&63)];return chars.join("")};var btoa=global.btoa?function(b){return global.btoa(b)}:function(b){return b.replace(/[\s\S]{1,3}/g,cb_encode)};var _encode=buffer?buffer.from&&Uint8Array&&buffer.from!==Uint8Array.from?function(u){return(u.constructor===buffer.constructor?u:buffer.from(u)).toString("base64")}:function(u){return(u.constructor===buffer.constructor?u:new buffer(u)).toString("base64")}:function(u){return btoa(utob(u))};var encode=function(u,urisafe){return!urisafe?_encode(String(u)):_encode(String(u)).replace(/[+\/]/g,function(m0){return m0=="+"?"-":"_"}).replace(/=/g,"")};var encodeURI=function(u){return encode(u,true)};var re_btou=new RegExp(["[À-ß][-¿]","[à-ï][-¿]{2}","[ð-÷][-¿]{3}"].join("|"),"g");var cb_btou=function(cccc){switch(cccc.length){case 4:var cp=(7&cccc.charCodeAt(0))<<18|(63&cccc.charCodeAt(1))<<12|(63&cccc.charCodeAt(2))<<6|63&cccc.charCodeAt(3),offset=cp-65536;return fromCharCode((offset>>>10)+55296)+fromCharCode((offset&1023)+56320);case 3:return fromCharCode((15&cccc.charCodeAt(0))<<12|(63&cccc.charCodeAt(1))<<6|63&cccc.charCodeAt(2));default:return fromCharCode((31&cccc.charCodeAt(0))<<6|63&cccc.charCodeAt(1))}};var btou=function(b){return b.replace(re_btou,cb_btou)};var cb_decode=function(cccc){var len=cccc.length,padlen=len%4,n=(len>0?b64tab[cccc.charAt(0)]<<18:0)|(len>1?b64tab[cccc.charAt(1)]<<12:0)|(len>2?b64tab[cccc.charAt(2)]<<6:0)|(len>3?b64tab[cccc.charAt(3)]:0),chars=[fromCharCode(n>>>16),fromCharCode(n>>>8&255),fromCharCode(n&255)];chars.length-=[0,0,2,1][padlen];return chars.join("")};var _atob=global.atob?function(a){return global.atob(a)}:function(a){return a.replace(/\S{1,4}/g,cb_decode)};var atob=function(a){return _atob(String(a).replace(/[^A-Za-z0-9\+\/]/g,""))};var _decode=buffer?buffer.from&&Uint8Array&&buffer.from!==Uint8Array.from?function(a){return(a.constructor===buffer.constructor?a:buffer.from(a,"base64")).toString()}:function(a){return(a.constructor===buffer.constructor?a:new buffer(a,"base64")).toString()}:function(a){return btou(_atob(a))};var decode=function(a){return _decode(String(a).replace(/[-_]/g,function(m0){return m0=="-"?"+":"/"}).replace(/[^A-Za-z0-9\+\/]/g,""))};var noConflict=function(){var Base64=global.Base64;global.Base64=_Base64;return Base64};global.Base64={VERSION:version,atob:atob,btoa:btoa,fromBase64:decode,toBase64:encode,utob:utob,encode:encode,encodeURI:encodeURI,btou:btou,decode:decode,noConflict:noConflict,__buffer__:buffer};if(typeof Object.defineProperty==="function"){var noEnum=function(v){return{value:v,enumerable:false,writable:true,configurable:true}};global.Base64.extendString=function(){Object.defineProperty(String.prototype,"fromBase64",noEnum(function(){return decode(this)}));Object.defineProperty(String.prototype,"toBase64",noEnum(function(urisafe){return encode(this,urisafe)}));Object.defineProperty(String.prototype,"toBase64URI",noEnum(function(){return encode(this,true)}))}}if(global["Meteor"]){Base64=global.Base64}if(typeof module!=="undefined"&&module.exports){module.exports.Base64=global.Base64}else if(typeof define==="function"&&define.amd){define([],function(){return global.Base64})}return{Base64:global.Base64}});


function md5cycle(x, k) {
var a = x[0], b = x[1], c = x[2], d = x[3];

a = ff(a, b, c, d, k[0], 7, -680876936);
d = ff(d, a, b, c, k[1], 12, -389564586);
c = ff(c, d, a, b, k[2], 17,  606105819);
b = ff(b, c, d, a, k[3], 22, -1044525330);
a = ff(a, b, c, d, k[4], 7, -176418897);
d = ff(d, a, b, c, k[5], 12,  1200080426);
c = ff(c, d, a, b, k[6], 17, -1473231341);
b = ff(b, c, d, a, k[7], 22, -45705983);
a = ff(a, b, c, d, k[8], 7,  1770035416);
d = ff(d, a, b, c, k[9], 12, -1958414417);
c = ff(c, d, a, b, k[10], 17, -42063);
b = ff(b, c, d, a, k[11], 22, -1990404162);
a = ff(a, b, c, d, k[12], 7,  1804603682);
d = ff(d, a, b, c, k[13], 12, -40341101);
c = ff(c, d, a, b, k[14], 17, -1502002290);
b = ff(b, c, d, a, k[15], 22,  1236535329);

a = gg(a, b, c, d, k[1], 5, -165796510);
d = gg(d, a, b, c, k[6], 9, -1069501632);
c = gg(c, d, a, b, k[11], 14,  643717713);
b = gg(b, c, d, a, k[0], 20, -373897302);
a = gg(a, b, c, d, k[5], 5, -701558691);
d = gg(d, a, b, c, k[10], 9,  38016083);
c = gg(c, d, a, b, k[15], 14, -660478335);
b = gg(b, c, d, a, k[4], 20, -405537848);
a = gg(a, b, c, d, k[9], 5,  568446438);
d = gg(d, a, b, c, k[14], 9, -1019803690);
c = gg(c, d, a, b, k[3], 14, -187363961);
b = gg(b, c, d, a, k[8], 20,  1163531501);
a = gg(a, b, c, d, k[13], 5, -1444681467);
d = gg(d, a, b, c, k[2], 9, -51403784);
c = gg(c, d, a, b, k[7], 14,  1735328473);
b = gg(b, c, d, a, k[12], 20, -1926607734);

a = hh(a, b, c, d, k[5], 4, -378558);
d = hh(d, a, b, c, k[8], 11, -2022574463);
c = hh(c, d, a, b, k[11], 16,  1839030562);
b = hh(b, c, d, a, k[14], 23, -35309556);
a = hh(a, b, c, d, k[1], 4, -1530992060);
d = hh(d, a, b, c, k[4], 11,  1272893353);
c = hh(c, d, a, b, k[7], 16, -155497632);
b = hh(b, c, d, a, k[10], 23, -1094730640);
a = hh(a, b, c, d, k[13], 4,  681279174);
d = hh(d, a, b, c, k[0], 11, -358537222);
c = hh(c, d, a, b, k[3], 16, -722521979);
b = hh(b, c, d, a, k[6], 23,  76029189);
a = hh(a, b, c, d, k[9], 4, -640364487);
d = hh(d, a, b, c, k[12], 11, -421815835);
c = hh(c, d, a, b, k[15], 16,  530742520);
b = hh(b, c, d, a, k[2], 23, -995338651);

a = ii(a, b, c, d, k[0], 6, -198630844);
d = ii(d, a, b, c, k[7], 10,  1126891415);
c = ii(c, d, a, b, k[14], 15, -1416354905);
b = ii(b, c, d, a, k[5], 21, -57434055);
a = ii(a, b, c, d, k[12], 6,  1700485571);
d = ii(d, a, b, c, k[3], 10, -1894986606);
c = ii(c, d, a, b, k[10], 15, -1051523);
b = ii(b, c, d, a, k[1], 21, -2054922799);
a = ii(a, b, c, d, k[8], 6,  1873313359);
d = ii(d, a, b, c, k[15], 10, -30611744);
c = ii(c, d, a, b, k[6], 15, -1560198380);
b = ii(b, c, d, a, k[13], 21,  1309151649);
a = ii(a, b, c, d, k[4], 6, -145523070);
d = ii(d, a, b, c, k[11], 10, -1120210379);
c = ii(c, d, a, b, k[2], 15,  718787259);
b = ii(b, c, d, a, k[9], 21, -343485551);

x[0] = add32(a, x[0]);
x[1] = add32(b, x[1]);
x[2] = add32(c, x[2]);
x[3] = add32(d, x[3]);

}

function cmn(q, a, b, x, s, t) {
a = add32(add32(a, q), add32(x, t));
return add32((a << s) | (a >>> (32 - s)), b);
}

function ff(a, b, c, d, x, s, t) {
return cmn((b & c) | ((~b) & d), a, b, x, s, t);
}

function gg(a, b, c, d, x, s, t) {
return cmn((b & d) | (c & (~d)), a, b, x, s, t);
}

function hh(a, b, c, d, x, s, t) {
return cmn(b ^ c ^ d, a, b, x, s, t);
}

function ii(a, b, c, d, x, s, t) {
return cmn(c ^ (b | (~d)), a, b, x, s, t);
}

function md51(s) {
txt = '';
var n = s.length,
state = [1732584193, -271733879, -1732584194, 271733878], i;
for (i=64; i<=s.length; i+=64) {
md5cycle(state, md5blk(s.substring(i-64, i)));
}
s = s.substring(i-64);
var tail = [0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0];
for (i=0; i<s.length; i++)
tail[i>>2] |= s.charCodeAt(i) << ((i%4) << 3);
tail[i>>2] |= 0x80 << ((i%4) << 3);
if (i > 55) {
md5cycle(state, tail);
for (i=0; i<16; i++) tail[i] = 0;
}
tail[14] = n*8;
md5cycle(state, tail);
return state;
}

/* there needs to be support for Unicode here,
 * unless we pretend that we can redefine the MD-5
 * algorithm for multi-byte characters (perhaps
 * by adding every four 16-bit characters and
 * shortening the sum to 32 bits). Otherwise
 * I suggest performing MD-5 as if every character
 * was two bytes--e.g., 0040 0025 = @%--but then
 * how will an ordinary MD-5 sum be matched?
 * There is no way to standardize text to something
 * like UTF-8 before transformation; speed cost is
 * utterly prohibitive. The JavaScript standard
 * itself needs to look at this: it should start
 * providing access to strings as preformed UTF-8
 * 8-bit unsigned value arrays.
 */
function md5blk(s) { /* I figured global was faster.   */
var md5blks = [], i; /* Andy King said do it this way. */
for (i=0; i<64; i+=4) {
md5blks[i>>2] = s.charCodeAt(i)
+ (s.charCodeAt(i+1) << 8)
+ (s.charCodeAt(i+2) << 16)
+ (s.charCodeAt(i+3) << 24);
}
return md5blks;
}

var hex_chr = '0123456789abcdef'.split('');

function rhex(n)
{
var s='', j=0;
for(; j<4; j++)
s += hex_chr[(n >> (j * 8 + 4)) & 0x0F]
+ hex_chr[(n >> (j * 8)) & 0x0F];
return s;
}

function hex(x) {
for (var i=0; i<x.length; i++)
x[i] = rhex(x[i]);
return x.join('');
}

function md5(s) {
return hex(md51(s));
}

/* this function is much faster,
so if possible we use it. Some IEs
are the only ones I know of that
need the idiotic second function,
generated by an if clause.  */

function add32(a, b) {
return (a + b) & 0xFFFFFFFF;
}

if (md5('hello') != '5d41402abc4b2a76b9719d911017c592') {
function add32(x, y) {
var lsw = (x & 0xFFFF) + (y & 0xFFFF),
msw = (x >> 16) + (y >> 16) + (lsw >> 16);
return (msw << 16) | (lsw & 0xFFFF);
}
}

 

AP.data=new function _APData(){
	this.isArray=function(data){
		return $.isArray(data);
	};
	this.isAssocArray=function(data){
		return typeof(data)=='object' && isNaN(data);	
	};
	this.isObject=function(data){
		return typeof(data)=='object' && isNaN(data);
	};
	this.isFunction=function(data){
		return $.isFunction(data);
	};
	this.isInt=function(data){
		return !isNaN(data)&&parseInt(data)==data;	
	};
	this.isNumber=function(data){
		return !isNaN(data)&&parseFloat(data)==data;	
	};
	this.isString=function(data){
		return typeof(data)=='string' && isNaN(data);
	};
	this.isEmpty=function(data){
		if (!data || data.length <=0){
			return true;
		}
		return false;
	};
	
	this.int=function(val){
		return parseInt(val);
	};
	
	/**
	 * Get a random integer from min to max-1
	 * @param min
	 * @param max
	 * @returns int
	 */
	this.randomInteger=function(min, max){
		return Math.floor(Math.random() * (max - min)) + min;
	};
	
	this.randomNumber=this.randomInteger;
	
	
	this.numberFormat=function(ival){
		var parts=ival.toString().split(".");
		return parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",") + (parts[1] ? "." + parts[1] : "");
	};
	
	
	this.currencyFormat=function(v){
		var c=Client.pageData.currency;
		if (!c || !c.length){
			c="VND";
		}
		if (c=="VND"){
			return AP.data.numberFormat(v)+" <sup>đ</sup>";	
		}else if (c=="GBP PENNY"){
			return "<b>&pound;"+this.globalMoneyFormat(v/100,2,".",",")+"</b>";	
		}else if (c=="USD CENT"){
			return "<b>$"+this.globalMoneyFormat(v/100,2,".",",")+"</b>";	
		}else{
			alert("Unsupported currency");
		}
		
	};
	
	
	
	this.globalMoneyFormat=function(n, c, d, t){
		var  c = isNaN(c = Math.abs(c)) ? 2 : c, 
		d = d == undefined ? "." : d, 
		t = t == undefined ? "," : t, 
		s = n < 0 ? "-" : "", 
		i = parseInt(n = Math.abs(+n || 0).toFixed(c)) + "", 
		j = (j = i.length) > 3 ? j % 3 : 0;
	   return s + (j ? i.substr(0, j) + t : "") + i.substr(j).replace(/(\d{3})(?=\d)/g, "$1" + t) + (c ? d + Math.abs(n - i).toFixed(c).slice(2) : "");
	 };
	
	
	
	this.realFormat=function(val){
		return Math.round(parseFloat(val)*10000)/10000;
	};
	
	
	this.zeroIndex=function(ival){
		ival=parseInt(ival);
		if (ival<10){
			ival="0"+ival;
		}
		return ival;
	}
	
	this.zeroPrefix=function(ival){
		return this.zeroIndex(ival);
	}
	
	/**
	 * @desc Compare two string/number x,y.
	 * @return True/false
	 */
	this.equal=function(x, y){
		if (AP.data.isInt(x)){
			x=x.toString();
		}
		if (AP.data.isInt(y)){
			y=y.toString();
		}
		
		if (AP.data.isAssocArray(x) && AP.data.isAssocArray(y)){
			return (JSON.stringify(x)==JSON.stringify(y));
		}
		
		if (AP.data.isArray(x) && AP.data.isArray(y)){
			if (x.length!=y.length){
				return false;
			}
			for (var i=0; i<x.length; i++){
				if (!AP.data.equal(x[i], y[i])){
					return false;
				}
			}
			return true;
		}
		
		return (x==y);
	};
	
	
	
	this.assoc=function(){
		return new APAssoc();
	};
};


/**
 * @desc Associate array with add() method
 * @returns
 */
function APAssoc(){
	this.data={};
	this.add=function(key, value){
		this.data[key]=value;
		return this;
	};
	
	this.assoc=function(){
		return this.data;
	};
};


	/**
	 * @desc Array manipulation and verification
	 */

	AP.array={
			
		fromObject: function(obj){
			var r=[];
			for (var key in obj){
				r[key]=obj[key];
			}
			
			return r;
		},
	
		/**
		 * @desc Check if element is an element of arr.
		 */
		within: function(element, arr, compare_fn){
			if (!arr || arr.length==0) return false;
			for (var i=0; i<arr.length; i++){
				if (compare_fn && typeof compare_fn!="undefined"){
					if (compare_fn(arr[i], element)){
						return true;
					}
				}else{
					if (arr[i]==element) return true;	
				}
				
			}
			return false;
		},
		
		/**
		 * @desc Check if the array contains the element
		 */
		contain: function(arr, element, compare_fn){
			return AP.array.within(element, arr, compare_fn);
		}, 
		
		count: function(arr, fn){
			var t=0;
			for (var i=0; i<arr.length; i++){
				t+=fn(arr[i]);
			}
			
			return t;
		},
		
		/**
		 * @desc Making a subarray, from start. If length is too big, or null, it
		 * return the subarray of maximum length.
		 */
		sub: function(arr, start, length){
			if (!length || start+length>arr.length){
				length=arr.length-start;
			}
			var b=[];
			for (var i=start; i<start+length; i++){
				b.push(arr[i]);
			}
			return b;
		},
		
		unique: function(arr, compare_fn){
			if (!compare_fn){
				compare_fn=function(e, f){
					return (parseInt(e)==parseInt(f));
				};
			}
			var r=[];
			for (var i=0; i<arr.length; i++){
				if (AP.array.contain(r, arr[i], function(e1, e2){
					return compare_fn(e1, e2);
				})){}else{
					r.push(arr[i]);
				}
			}
			
			return r;
		},
		
		uniqueObjects: function(arr, compare_fn){
			return AP.array.unique(arr, function(e1, e2){
				return e1.id==e2.id || (AP.data.isInt(e1.id) && AP.data.isInt(e2.id) && parseInt(e1.id) == parseInt(e2.id));
			});
		},
		
		find: function(arr, id){
			if (!arr || !arr.length){
				return false;
			}
			
			if (typeof id =="function"){
				for (var i=0; i<arr.length; i++){
					if (id(arr[i])){
						return arr[i];
					}
				}
				
				return null;
			}
			
			
			for (var i=0; i<arr.length; i++){
				if (arr[i]==id){
					return arr[i];
				}
			}
			return null;
		},
		
		single: function(arr, filter){
			return this.find(arr, filter); 
		},
		
		exist: function(arr, elem){
			if ($.isFunction(elem)){
				var obj=this.find(arr, elem);
				if (obj){
					return true;
				}
				return false;
			}else{
				var obj= AP.array.find(arr, function(e){
					return e==elem;
				});
				
				if (!obj){
					return false;
				}
				
				return true;
			}
		},
		
		indexOf: function(arr, elem, cmp){
			for (var i=0; i<arr.length; i++){
				if (cmp(arr[i], elem)){
					return i;
				}
			}
			
			return -1;
		},
		
		
		findObj: function(arr, id){
			if (!arr){
				return null;
			}
			
			for (var i=0; i<arr.length; i++){
				if (parseInt(arr[i].id)==parseInt(id)){
					return arr[i];
				}
				
				if (arr[i].id===id){
					return arr[i];
				}
			}
			return null;
		},
		
		
		updateObjects:function(arr, obj){
			for (var i=0; i<arr.length; i++){
				if (parseInt(arr[i].id)==parseInt(obj.id)){
					arr[i]=obj;
					return arr;
				}
			}
			
			arr.push(obj);
			
			return arr;
		},
		
		updateByID: function(arr, obj){
			return this.updateObjects(arr, obj);
		},
		
		insertByID: function(arr, obj){
			return this.updateObjects(arr, obj);
		},
		
		replaceObject: function(arr, obj){
			for (var i=0; i<arr.length; i++){
				if (parseInt(arr[i].id)==parseInt(obj.id)){
					arr[i]=obj;
					return true;
				}
			}
			
			arr.push(obj);
			
			return false;
		},
		
		
		
		/**
		 * @desc Check if prefix is a subarray of arr, starting from beginning
		 */
		prefix: function(arr, prefix){
			if (prefix.length>arr.length){
				return false;
			}
			for (var i=0; i<prefix.length; i++){
				if (!AP.data.equal(prefix[i], arr[i])){
					return false;
				}
			}
			return true;
		},
		
		
		/**
		 * @desc Check if prefix is a subarray of arr, starting from beginning
		 */
		equal: function(arr1, arr2){
			if (arr1.length!=arr2.length){
				return false;
			}
			for (var i=0; i<arr1.length; i++){
				if (!AP.data.equal(arr1[i], arr2[i])){
					return false;
				}
			}
			return true;
		},
		
		ids: function(arr){
			return this.select(arr, function(e){
				return e.id;
			});
		},
		
		cut: function(arr, max){
			if (arr.length<max){
				return arr;
			}
			
			return arr.slice(0, max);
		},
		
		usort: function(arr, sorter){
			for (var i=0; i<arr.length-1; i++){
				for (var j=i+1; j<arr.length; j++){
					if (sorter(arr[i], arr[j])>0){
						var x=arr[i];
						arr[i]=arr[j];
						arr[j]=x;
					}
				}
			}
			return arr;
		},
		
		sortObj: function(arr, field, multiplier){
			if (!multiplier){
				multiplier=1;
			}
			
			return this.usort(arr, function(e1, e2){
				return multiplier*(parseInt(e1[field]) - parseInt(e2[field]));
			}) 
		},
		
		
		reorder: function(arr, order){
			if (!order){
				order=1;
			}
			arr.sort(function(e1, e2){
				return (parseInt(e2.order)-parseInt(e1.order))*order;
			})
		},
		
		realOrder: function(arr, order){
			if (!order){
				order=1;
			}
			arr.sort(function(e1, e2){
				return (parseInt(e2.real_order)-parseInt(e1.real_order))*order;
			});
			
			return arr;
		},
		
		
		move: function(arr, elem, dir){
			for (var i=0; i<arr.length; i++){
				if (arr[i].id==elem.id){
					if (dir=="up" && i>0){
						var temp=arr[i-1];
						arr[i-1]=arr[i];
						arr[i]=temp;
					}else if (dir=="down" && i< arr.length-1){
						var temp=arr[i+1];
						arr[i+1]=arr[i];
						arr[i]=temp;
					}
						
					return;
				}
			}
		},
		
		
		
		/**
		 * @desc Unserialized a serialized string to an array.
		 */
		unserialize: function(str){
			var r={};
			var parts=str.split('&');
			for (var i=0; i<parts.length; i++){
				var x=parts[i].split("=");
				if (x.length==2){
					r[x[0]]=x[1];
				}
			}
			return r;
		},
		/**
		 * @desc Remove an element from an array
		 */
		remove: function(arr, elem, cmp_fn){
			var na=[];
			for (var i=0; i<arr.length; i++){
				if (AP.isFunction(elem)){
					if (elem(arr[i])){
					}else{
						na.push(arr[i]);
					}
				}else{
					if (cmp_fn){
						if (!cmp_fn(arr[i],elem)){
							na.push(arr[i]);
						}
					}else{
						if (!AP.data.equal(arr[i],elem)){
							na.push(arr[i]);
						}	
					}	
				}
			}
			return na;
		},
		
		removeByID: function(arr, id){
			return this.filter(arr, function(e){
				if (parseInt(e.id)==parseInt(id)){
					return false;
				}
				
				return true;
			});
		},
		
		filter: function(arr, filter){
			var na=[];
			for (var i=0; i<arr.length; i++){
				if (filter(arr[i])){
					na.push(arr[i]);
				}
			}
			return na;
		},
		
		select: function(arr, fn){
			var na=[];
			for (var i=0; i<arr.length; i++){
				var e=fn(arr[i]);
				if (e!==null){
					na.push(e);
				}
			}
			return na;
		},
		
		selectMax: function(arr, num_elems, fn){
			var temp=[];
			for (var i=0; i<arr.length; i++){
				temp.push({value: fn(arr[i]), index: i});
			}
			
			temp.sort(function(e, f){
				return f.value-e.value;
			});
			
			temp=this.cut(temp, num_elems);
			
			var r=[];
			for (var i=0; i<temp.length; i++){
				r.push(arr[temp[i].index]);
			}
			
			return r;
		},
		
		
		update: function(arr, fn){
			for (var i=0; i<arr.length; i++){
				fn(arr[i])
			}
		},
		
		join: function(array, joiner, fn){
			return AP.render(array, function(e){
				if (fn){
					return fn(e)+joiner;	
				}
				return fn(e)+joiner;
			});
		},
		
		filterQuery: function(array, keys){
			var a=array.slice(0);

			for (var i=0; i<keys.length; i++){
				var k=keys[i];
				if (Query.get(k)){
					var val=Query.get(k);
					a=AP.array.filter(a, function(e){
						return e[k]==val || e[k+"_id"]==val;
					});
				}
			}
			
			return a;
		},
		
		
		group: function(array, group_maker, group_sorter){
			var gs={};
			for (var i=0; i<array.length; i++){
				var g;
				if (AP.data.isString(group_maker)){
					g={id: array[i][group_maker]};
				}else{
					g=group_maker(array[i]);	
				}
				
				
				if (!g){
					continue;
				}
				
				if (!gs["g"+g.id]){
					gs["g"+g.id]=shallowClone(g);
					gs["g"+g.id].items=[array[i]];
				}else{
					gs["g"+g.id].items.push(array[i]);
				}
			}
			
			var r=[];
			for (var key in gs){
				r.push(gs[key]);
			}
			
			if (group_sorter){
				for (var i=0; i<r.length; i++){
					r[i].__sorter=group_sorter(r[i]);
				}
				
				return AP.array.sortObj(r, "__sorter", -1);
			}
			
			
			return r;
		},
		
	};
	
 

/**
 * @desc AP function on the Browser & General Syste,
 */
AP.sys={
	initAjax: function(){
		jQuery.ajaxSetup({async:false});
	},
			
	back: function(){
		return history.back();
	},	
	ie: function(){
		return $.browser.msie;
	},
	
	isTablet: function(){
		var ua = navigator.userAgent.toLowerCase();
		var isAndroid = ua.indexOf("android") > -1;
		var isiPad = ua.indexOf("ipad")>-1;
		return (isAndroid || isiPad);
	},
	
	isMobile:function(){
		if ('ontouchstart' in document.documentElement && navigator.userAgent.match(/Mobi/)){
			return true;
		}

		return (/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(navigator.userAgent.toLowerCase()));
	},
	
	isTouch: function(){
		return !!('ontouchstart' in window) ? 1 : 0;
	},
	
	
	/**
	 * @desc Detect flash. AP.B.flash() return true if flash is enabled, false otherwise.
	 */
	flash: function(){
		var hasFlash = false;
		try {
		  var fo = new ActiveXObject('ShockwaveFlash.ShockwaveFlash');
		  if (fo) hasFlash = true;
		}catch(e){
		  if (navigator.mimeTypes ["application/x-shockwave-flash"] != undefined) hasFlash = true;
		}
	}, 
	
	
	/**
	 * @desc Check if the browser support file API.
	 */
	file: function(){
		if (document.querySelector && window.File && window.FileReader && window.FileList){
			return true;
		}
		return false;
	},
	
	captchaReload: function(obj){
		$(obj).attr("src", Client.url+"/captcha?ts="+new Date().getTime());
	},
	
	
	/**
	 * @desc Set and get cookie,
	 * @copyright 2006 Klaus Hartl (stilbuero.de)
	 */
	cookie:function(name, value, options){
		if (typeof value == 'undefined'){
			var cookieValue = null;
			if (document.cookie && document.cookie != '') {
				var cookies = document.cookie.split(';');
				for (var i = 0; i < cookies.length; i++) {
					var cookie = jQuery.trim(cookies[i]);
					if (cookie.substring(0, name.length + 1) == (name + '=')) {
						cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
						break;
					}
				}
			}
			return cookieValue;
		}else{
			options = options || {};
			if (value === null) {
				value = '';
				options.expires = -1000;
			}
			var expires = '';
			if (options.expires && (typeof options.expires == 'number' || options.expires.toUTCString)) {
				var date;
				if (typeof options.expires == 'number') {
					date = new Date();
					date.setTime(date.getTime() + (options.expires * 1000));
				} else {
					date = options.expires;
				}
				expires = '; expires=' + date.toUTCString();
			}
			
			
			var path = options.path ? '; path=' + (options.path) : '';
			var domain = options.domain ? '; domain=' + (options.domain) : '; domain='+ Client.domain;
			var secure = options.secure ? '; secure' : '';

			document.cookie = [name, '=', AP.encodeURI(value), expires, path, domain, secure].join('');
		}
	},
	
	
	/**
	 * @desc Create an event listener
	 */
	on :function(event, fx, $this){
		AP.sysEvent.bind(event, fx, $this);
		return this;
	},
	
	off: function(event){
		AP.sysEvent.off(event);
		return this;
	},
	
	
	/**
	 * @desc Create an event listener
	 */
	once :function(event, fx, $this){
		AP.sysEvent.bindOnce(event, fx, $this);
		return this;
	},
	
	
	/**
	 * @desc Trigger an event 
	 */
	fire: function(event, data){
		AP.sysEvent.trigger(event, data);
		return this;
	},
	
	
	/**
	 * @desc Trigger an event 
	 */
	trigger: function(event, data){
		return AP.sys.fire(event, data);
	},
	
	
	/**
	 * @desc Trigger an event (and dequeue)
	 */
	release: function(event){
		AP.sysEvent.release(event);
		return this;
	}
};	











AP.sysEvent=new function __APSysEvent(){
	this.events={};
	this.__fired={};
	
	this.clear=function(){
		this.events={}
	};
	
	
	this.trigger=function(ev, data){
		if (this.events[ev] && this.events[ev].length){
			for (var i=0; i<this.events[ev].length; i++){
				var fn=this.events[ev][i];
				if (!fn){
					break;
				}

				
				if (fn._once){
					// Remove fn from event queues
					this.events[ev].splice(i, 1);
				}
				
				if (fn._caller){
					fn.apply(fn._caller, data);
				}else{
					if (AP.data.isArray(data)){
						fn.apply(undefined, data);
					}else{
						fn(data);	
					}
				}
			}
		}
		
		return this;
	};
	
	
	this.bind=function(ev, fx, _caller){
		if (!this.events[ev]){
			this.events[ev]=[];
		}
		
		if (_caller){
			fx._caller=_caller;
		}
		
		this.events[ev].push(fx);
		
		return this;
	};
	
	
	this.off=function(ev){
		if (!this.events[ev]){
			this.events[ev]=[];
		}
		
		this.events[ev]=[];
		return this;
	};
	
	this.bindOnce=function(ev, fx, _caller){
		if (!this.events[ev]){
			this.events[ev]=[];
		}
		
		if (_caller){
			fx._caller=_caller;
		}
		
		fx._once=1;
		
		this.events[ev].push(fx);
		
		return this;
	};
	
	this.release=function(ev){
		if (this.events[ev] && this.events[ev].length){
			while (true){
				var fn=this.events[ev].shift();
				if (!fn){
					break;
				}
				
				if (fn._caller){
					fn.apply(fn._caller);
				}else{
					fn();
				}
			}
		}
		
		this.__fired[ev]=1;
		return this;
	};
	
};
 

/**
 * @desc String manipulation and verification.
 */
AP.word={
	/**
	 * @desc Check if the data is an empty string or not.
	 * @param data
	 * @return True/False
	 */
	empty: function(data){ 
		if (typeof data=='undefined'){
			return true;
		}
		if (data===false) return true;
		if (data==="") return true;
		if (data===null) return true;
		if (data.length==0) return true;
		return false;
	},
	
	/**
	 * @desc Check if data is a valid data of type string.
	 * @param data
	 * @return True/False
	 */
	good: function(data){
		return typeof(data)=='string' && isNaN(data);
	},
	
	/**
	 * @desc Check if s1 is a part of s2 somewhere.
	 * @param s1 child string
	 * @param s2 parent string
	 */
	within:function(element,origin){
		if (!element) return false;
		if (origin.indexOf(element)>=0){
			return true;
		}
		return false;
	},
	
	extractLast: function(word){
		if (!word){
			return false;
		}
		var ws=word.split("-");
		return ws[ws.length-1];
	},
	
	/**
	 * @desc Check if $pre is the prefix of $origin
	 */
	prefix:function(origin, pre){
		if (!pre || !origin){
			return false;
		}
		if (origin.substring(0, pre.length)==pre){
			return true;
		}
		return false;
	},
	
	
	/**
	 * @desc Check if $suf is the suffix of $origin
	 */
	suffix:function(origin, suf){
		if (!suf || !origin || origin.length<suf.length){
			return false;
		}
		
		if (origin.substr(origin.length-suf.length, suf.length)==suf){
			return true;
		}
		return false;
	},
	
	
	
	/**
	 * @desc Check if a string is a valid url. The test is very simple, it check
	 * if the prefix is actually http
	 */
	isURL:function(url){
		if (this.prefix(url, 'http:') || this.prefix(url, 'https:')){
			return true;
		}
		return false;
	},
	
	
	shorten: function(word, max_length, tail){
		word=safe(word);
		
		if (!tail){
			tail='...';
		}
		if (word.length <max_length){
			return word;
		}
		return word.substr(0, max_length-1)+tail;
	},
	
	
	ucw: function(data){
		return data.replace( /(^|\s)([a-z])/g , function(m,p1,p2){ return p1+p2.toUpperCase(); } );
	},
	
	ucf: function(data){
		return data.charAt(0).toUpperCase() + data.slice(1);
	}, 
	upper: function(data){
		return data.toUpperCase();
	},
	
	
	/**
	 * @desc Replace all function
	 */
	replace: function(str, search, replace){
		return str.replace(new RegExp(search, 'g'),replace);
	},
	
	replaceAll:function(search, replace, str){
		return str.split(search).join(replace);
	},

	join: function(arr, joiner, fn){
		var html="";
		for (var i=0; i<arr.length; i++){
			if (i<arr.length-1){
				html+=fn?fn(arr[i]):arr[i];
				html+=joiner;
			}else{
				html+=fn?fn(arr[i]):arr[i];
			}
		}
		return html;
	},
	
	
	/**
	 * @desc Check if filename has extension belongging to fileX.
	 */
	fileX: function(filename, allowExt){
		var parts=filename.split(".");
		if (!parts || parts.length<1){
			return false;
		}
		var ext=parts[parts.length-1];
		ext=ext.toLowerCase();
		allowExt=allowExt.toLowerCase();
		
		if (allowExt.indexOf(ext)==-1){
			return false;
		}
		return true;
	},
	
	/**
	 * @desc Split a string into array.
	 * @param splitter The string splitter
	 * @param str The original string
	 * @param boolean no_spaces Allow spacings (and ends) in result or not? Default false
	 */
	split: function(splitter, str, no_spaces){
		if (!no_spaces){
			no_spaces=false;
		}
		var parts=str.split(splitter);
		var results=[];
		for (var i=0; i<parts.length; i++){
			 var s=parts[i];
			 if (no_spaces){
				 s=$.trim(parts[i]);
			 }
			 if (s && s.length>=1){
				 results.push(s);
			 }
		}
		return results;
	},
	
	ssplit: function(str){
		return str.split( /[\s,]/ );
	},
	
	plural:function(word, count){
		if (!AP.data.isInt(count)){
			index=parseInt(count);
		}
		
		if (count<2){
			return word;
		}
		
		
		switch (word){
			case "person": 
				return "people";
			case "activity":
				return "activities";
			case "reply":
				return "replies";
			default:
				return word+"s";
		};
	},
	
	safeChar: function(word){
		var regex=/^[a-z0-9]+$/i;
		return word.match(regex);
	},
	
	match: function(word, pattern){
		return word.match(pattern);
	},
	
	quickMatch: function(w, q){
		return w.toLowerCase().indexOf(q.toLowerCase())!=-1;
	},
	
	fulltextMatch: function(w, q){
		var haystack=purify(w.toLowerCase()).replace(/\s/g,'');
		var neddle=purify(q.toLowerCase()).replace(/\s/g,'');
		
		return haystack.indexOf(neddle)!=-1;
	},
	
	capitalize: function(str){
		return str.charAt(0).toUpperCase() + str.slice(1);
	},
	
	random: function(len){
		return AP.random.word(len);
	}
};

 

/**
 * @desc The DOM/Document Manipulation.
 */
AP.html={	
	data:{},
	
	/**
	 * @desc Check if the document has some specific selector.
	 */
	contain:function(selector){
		if ($(selector).length>=1){
			return true;
		}
		return false;
	},
	
	/**
	 * @desc Alias of contain
	 */
	exist:function(selector){
		return this.contain(selector);
	},
	
	
	/**
	 * @desc Save html by caching it to data
	 * @param key
	 * @param selector
	 */
	save: function(key, selector){
		this.data[key]=$(selector).html();
	},
	
	update: function(key, selector){
		$(selector).html(this.data[key]);
	},
	
	
	/**
	 * @desc Setting the document title
	 */
	title:function(str){
		document.title = str;
	},	
	input:function(element, name){
		var $input;
		if (!name){
			$input=$(element);
		}else{
			$input=$("*[name="+name+"]", element);
		}
		
		if ($input[0] && $input[0].title==$input.val()){
			return  "";
		}else{
			return $input.val();
		}
	},
	select: function(selector, value){
		$(selector+" option[value='"+value+"']").attr('selected', 'selected');	
	},
	
	/**
	 * @desc Return the value of an input (encoded before return).
	 */
	inputAjax:function(elem,name){
		return AP.encodeURI(this.D.input(elem,name));
	},
	
	/**
	 * @desc Making input hints for all input/textarea within a given
	 * selector.
	 */
	inputHint: function(selector){
		if (!selector){
			selector='';
		}
		$(' input, textarea', selector).each(function(){
			if ($(this)[0].title || $(this).data('hint') && !$(this).hasClass('autocomplete') && !$(this).hasClass('__apcomplete_marked')){
				ap_inputHint(this);
			}
		});
	},
	
	
	hidden: function(name, value){
		return "<input type='hidden' name='"+name+"' value='"+value+"'/>";
	},
	
	focus: function(selector){
		$(selector).focus();
		this.scrollTo(selector);
	},
	
	scrollTo: function(selector, base, data){
		if (!data){
			data={};
		}
		var xoffset=0;
		data=$.extend({},{offset:0, time: 400},data);
		if (!base){
			base=ap_getScrollElement(document.body, 'html','body');
		}else{
			// xoffset=$(base).scrollTop();
		}
		
		
		var targetOffset=$(selector).position().top+xoffset+data.offset;
		if (targetOffset<=0){
			targetOffset=0;
		}
		
		// $.log(targetOffset);
		
		$(base).animate({scrollTop: targetOffset}, data.time, function() {});
	},
	
	/**
	 * @desc Binding a keypress event on a specific element.
	 */
	bind:function(selector,_key, action){
		$(selector).keydown(function (e){			
			key=0;
			if (e && e.which) key=e.which;
			else if (e && e.keyCode) key=e.keyCode;
			if (key == _key){
				action();
			}
		});
	},
	
	
	/**
	 * @desc Binding a keypress on window element.
	 */
	dbind: function(_key, action){
		$(document).keydown(function (e){
			if (AP.html.inActiveState()){
				return;
			}
			key=0;
			if (e && e.which) key=e.which;
			else if (e && e.keyCode) key=e.keyCode;
			if (key == _key){
				action();
			}
		});
	},
	
	/**
	 * @desc Bind a resize action on document.body 
	 * @param action Callback function
	 * @param persistent Boolean/ Persistent or not (over page transistion). Default is false.
	 */
	resize: function(action, persistent){		
		action();
		
		if (persistent){
			$(window).resize(function(){
				action();
			});
		}else{
			$(window).bind('resize.__temp',function(){
				action();
			});
		}
	},
	
	
	/**
	 * @desc Reset stuffs when they are added to the DOM tree.
	 */
	reset: function(container){
		$("button").click(function(event){
			event.preventDefault();
		});
	},
	
	
	/**
	 * @desc Flagging some input/select being in focus.
	 */
	activeState: false,
	
	/**
	 * @desc Check if the element is in active state or not.
	 */
	inActiveState:function(){
		return this.activeState;
	},
	
	/**
	 * @desc Initializing the active state of the document.
	 */
	initState:function(selector){
		if (!selector){
			selector="";
		}
		$(selector+" textarea,"+selector+" input").bind("focus", function(){
			AP.html.activeState=true;
		});
		$(selector+" textarea,"+selector+" input").bind("blur", function(){
			AP.html.activeState=false;
		});
	},
	
	/**
	 * @desc Embedding data (passed from sever) to HTML element.
	 */
	initData: function(selector){
		if (!selector){
			selector="";
		}
		$(" > .__data", selector).each(function(){
			var text=$(this).html();
			try{
				var obj=eval("("+text+")");
				if (obj!==null){
					for (var key in obj){
						$(this).parent().data(key, obj[key]);
					}
				}
			}catch(e){
				
			}
		});
	},
	
	
	initContextMenu: function(){
		$("<div id='__ctm'><div id='__ctmi' class='__contextmenu'></div></div>").appendTo('#master');
		$("#__ctm").clickOut(function(){
			$('#__ctm').hide();
		});
	},
	
	initTransition: function(wrapper){
		if (wrapper){
			AP.setContinuousRequest(wrapper);
		}else{
			AP.setContinuousRequest();
		}
	},
	
	initDialog: function(){
		$(document.body).append("<div id='apdialogs'></div>");
		AP.html.resize(function(){
			$("#apdialogs").css("width",$(window).width()+$.sbWidth());
		}, true);
	},
	
	
	initTooltip: function(selector){
		setTimeout(function(){
			$(".tt_auto", selector).parent().tooltip('.tt');
		},1000);
	},
	
	/**
	 * @desc Create some simple transformation on the dom tree specifically
	 * for AP JS Framework.
	 */
	init: function(selector){
		if (!selector){
			selector='';
		}
		this.initState(selector);
		setTimeout(function(){
			AP.html.inputHint(selector);
		},500);
		this.initData(selector);
		this.initTooltip(selector);
		
		this.reset(selector);
		if (!selector){
			this.initContextMenu();
			this.initDialog();
		}
	},
	
	/**
	 * @desc Init selector after insert
	 */
	initInsert: function(selector){
		this.inputHint(selector);
		this.initData(selector);
		this.initTransition(selector);
		this.initTooltip(selector);
	},
	
	options: function(selector, options){
		$(selector).html(AP.render(options, function(e){
			return "<option value='"+e.value+"'>"+e.label+"</option>";
		}));
		
		if ($(selector).data("value")){
			$(selector).val($(selector).data("value"));
		}
	},
};




var ap_getScrollElement=function(){
	for (var i = 0, argLength = arguments.length; i <argLength; i++) {
		var el = arguments[i], $scrollElement = $(el);
		
		if ($scrollElement.scrollTop()> 0) {
				return el;
		}else {
				$scrollElement.scrollTop(1);
				var isScrollable = $scrollElement.scrollTop()> 0;
				$scrollElement.scrollTop(0);
				if (isScrollable) {
					return el;
				}
		}
	}
	return [];
};


var ap_inputHint=function(element, target){
	if (!target){
		target=element;
	}
	
	if ($(element).hasClass('__hinited') || $(element).hasClass('__apcomplete_marked')){
		return;
	}
	
	$(element).addClass('__hinited');
	var $parent=$(element).parent();
	
	var pos=$parent.css("position");
	if (pos !="relative" && pos!="absolute"){
		$parent.addClass("relative");
	}
	

	var fz=$(element).css("font-size");
	var pos=$(element).position();
	var pl=$parent.css("padding-left");
	var pt=$parent.css("padding-top");
	
	var txt=$(element)[0].title;
	if ($(element).data("hint")){
		txt=$(element).data("hint");
	}
	
	$(element).before("<span class='__hinited_data __blur' style='top:"+pt+"; left:"+pl+"; font-size:"+fz+"'>"+txt+"</span>");
	
	
	setTimeout(function(){
		if ($(element).data('auto')){
			$(element).prev('.__hinited_data').css("left","auto").css("right", pl).show();
		}else{
			$(element).prev().css({top: pt, left: pl});	
		}
	},200);
	
	$(element).on('focus keyup change', function(){
		if ($(this).hasClass('apcomplete')){
			return;
		}
		if (!AP.word.empty($(this).val())){
			$(this).addClass('__activated');
			
			if ($(this).data('auto')){
				$(this).prev('.__hinited_data').css("left","auto").css("right", pl);	
			}else{
				$(this).prev('.__hinited_data').hide();
			}
			
		}else{
			$(this).removeClass('__activated');
			$(this).prev('.__hinited_data').css("left",pl).show();
		}
	}).blur(function(){
		if ($(this).hasClass('apcomplete')){
			return;
		}
		
		if (AP.word.empty($(this).val())){
			$(this).prev('.__hinited_data').show();
		}
	});

	$(element).blur();
	
};



/**
 * @desc Collection of functions to manipulate time.
 */
AP.time={
	
	/**
	 * @desc Please reset this if you want to use locale words
	 */	
	months:["January","February","March","April","May","June","July","August","September","October","November","December"],
	sMonths:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],
	days:["Monday","Tuesday", "Wednesday", "Thursday","Friday","Saturday", "Sunday"],	
	sDays:["Mon","Tue", "Wed", "Thu","Fri","Sat","Sun"],  
	tDays:["T2", "T3", "T4", "T5", "T6", "T7", "CN"],
	tvDays:["Thứ 2", "Thứ 3", "Thứ 4", "Thứ 5", "Thứ 6", "Thứ 7", "Chủ Nhật"],
		
	/**
	 * @desc Handler time function.
	 */
	time:function(pattern, time_stamp){
		var t;
		if (!time_stamp){
			t = new Date();
		}else{
			t = new Date(time_stamp*1000);
		}
		
		var _year =t.getFullYear();
		
		var _month=t.getMonth()+1;
				
		var month=_month;
		if (_month<10){
			month="0"+_month;
		}
		
		var _day=(t.getDay()||7)-1;
		
		var _date=t.getDate();
		
		var date=_date;
		if (_date<10){
			date="0"+_date;
		}
		
		var _hour=t.getHours();
		var _hour12=(_hour%12);
		var hour=_hour;
		if (_hour<10){
			hour="0"+_hour;
		}
		
		var _minute=t.getMinutes();	
		var _second=t.getSeconds();
		
		
		var r=pattern;
		var tday=AP.time.tDays[_day];
		var vday=AP.time.tvDays[_day];
		
		// Day & Date
		r=r.replace("%d", date);
		r=r.replace("%D", AP.time.sDays[_day]);
		r=r.replace("%j", _date);
		r=r.replace("%l", AP.time.days[_day]);
		r=r.replace("%N", _day+1);
		r=r.replace("%w", _day);
		r=r.replace("%T", tday);
		r=r.replace("%v", tday);
		r=r.replace("%V", vday);
		
		// Month
		r=r.replace("%F", AP.time.months[_month-1]);
		r=r.replace("%m", month);
		r=r.replace("%M", AP.time.sMonths[_month-1]);
		r=r.replace("%n", _month);
		r=r.replace("%t", new Date(_year, _month, 0).getDate());
		
		// Year
		r=r.replace("%L", (new Date(_year, 1,29).getMonth()==1));
		r=r.replace("%o", _year);
		r=r.replace("%Y", _year);
		r=r.replace("%y", _year.toString().substr(2));
		
		// Hour & Minute & Second
		r=r.replace("%a", (_hour<12)?"am":"pm");
		r=r.replace("%A", (_hour<12)?"AM":"PM");
		r=r.replace("%g", _hour12);
		r=r.replace("%G", _hour);
		r=r.replace("%h", (_hour12<10)?("0"+_hour12):_hour12);
		r=r.replace("%H", (_hour<10)?("0"+_hour):_hour);
		r=r.replace("%i", (_minute<10)?("0"+_minute):_minute);
		r=r.replace("%s", (_second<10)?("0"+_second):_second);
		r=r.replace("%u", t.getMilliseconds()*1000);
		
		// Timezone
		r=r.replace("%Z", -t.getTimezoneOffset()*60);
	
		return r;
	},
	
	hm: function(time){
		var h=AP.data.zeroPrefix(Math.floor(time/3600));
		var m=AP.data.zeroPrefix(Math.floor((time-h*3600)/60));
		return h+":"+m;
	},
	
	beginOfDay: function(time_stamp){
		var t;
		if (!time_stamp){
			t = new Date();
		}else{
			t = new Date(time_stamp*1000);
		}
		return AP.time.timeStamp(new Date(t.getFullYear(), t.getMonth(), t.getDate()));
	},
	
	beginOfMonth: function(time_stamp){
		var t;
		if (!time_stamp){
			t = new Date();
		}else{
			t = new Date(time_stamp*1000);
		}
		return AP.time.timeStamp(new Date(t.getFullYear(), t.getMonth(), 1));
	},
	
	endOfMonth: function(time_stamp){
		var t;
		if (!time_stamp){
			t = new Date();
		}else{
			t = new Date(time_stamp*1000);
		}
		return AP.time.timeStamp(new Date(t.getFullYear(), t.getMonth()+1, 0));
	},
	
	
	midnight: function(time_stamp){
		var t;
		if (!time_stamp){
			t = new Date();
		}else{
			t = new Date(time_stamp*1000);
		}
		return AP.time.timeStamp(new Date(t.getFullYear(), t.getMonth(), t.getDate(), 23, 59, 59));
	},
	
	beginOfWeek: function(time_stamp){
		return AP.time.firstDayOfWeek(time_stamp);
	},

	endOfWeek: function(time_stamp){
		return AP.time.firstDayOfWeek(time_stamp)+6*24*3600;
	},
	
	sameDay: function(ts1, ts2){
		return AP.time.beginOfDay(parseInt(ts1))==AP.time.beginOfDay(parseInt(ts2));
	},
	
	sameYear: function(ts1, ts2){
		return AP.time.time("%Y",ts1)==AP.time.time("%Y",ts2);
	},
	sameMonth: function(ts1, ts2){
		return AP.time.time("%m%Y",ts1)==AP.time.time("%m%Y",ts2);
	},
	sameWeek: function(ts1, ts2){
		return AP.time.firstDayOfWeek(parseInt(ts1))==AP.time.firstDayOfWeek(parseInt(ts2));
	},
	
	test: function(ts){
		return AP.time.time("%Y %m %d, %H:%i:%s", ts);
	},
	
	/**
	 * @desc Get the previous Monday
	 * @param time_stamp
	 * @returns
	 */
	firstDayOfWeek: function(time_stamp){
		var t;
		if (!time_stamp){
			t = new Date();
		}else{
			t = new Date(time_stamp*1000);
		}
		
		// Get the first day of week [Return timestamp]
		var day=(t.getDay() || 7)-1;

		t.setHours(-24 * day);
		t.setSeconds(0);
		t.setMinutes(0);
		t.setHours(0);
		
		return AP.time.timeStamp(t);
	},
	
	
	/**
	 * @desc Get the first day of the current month
	 * @param time_stamp
	 * @returns
	 */
	firstDayOfMonth: function(time_stamp){
		var t;
		if (!time_stamp){
			t = new Date();
		}else{
			t = new Date(time_stamp*1000);
		}
		
		t.setDate(1);
		t.setSeconds(0);
		t.setMinutes(0);
		t.setHours(0);
		
		return AP.time.timeStamp(t);
	},
	
	
	
	timeStamp:function(d){
		if (!d){
			d=new Date();
		}
		return Math.floor(d.getTime()/1000);
	},
	
	now: function(){
		return Math.floor((new Date()).getTime()/1000);
	},
	
	date:function(time_stamp){
		return new Date(time_stamp*1000);
	},
	
	ago: function(time_stamp){
		time_stamp=parseInt(time_stamp);
		var t = this.timeStamp();
		var diff=t-time_stamp;
		
		if (diff<5){
			return lang("few seconds ago");
		}
		if (diff<60){
			return diff+" "+lang('seconds ago');
		}
		if (diff<3600){
			return Math.floor(diff/60)+" "+lang('minutes ago');
		}
		if (diff<3600*24){
			return Math.floor(diff/3600)+" "+lang('hours ago');
		}
		return Math.floor(diff/86400)+" "+lang('days ago');
	},
	
	
	late: function(actual_time, deadline){
		if (!deadline){
			deadline=0;
		}
		
		var diff=parseInt(actual_time)-parseInt(deadline);
		if (diff<0){
			return "---";
		}
		
		if (diff<5){
			return lang("few seconds");
		}
		if (diff<60){
			return diff+" "+lang('seconds');
		}
		
		if (diff<3600){
			return Math.floor(diff/60)+"m";
		}
		
		if (diff<3600*24){
			var h=Math.floor(diff/3600);
			var min=Math.floor((diff-h*3600)/60);
			return h+"h"+min+"m";
		}
		
		var h=Math.floor(diff/86400);
		
		if (h==1){
			return h+" "+lang('day');	
		}
		
		return h+" "+lang('days');
	},
	
	remain: function(deadline){
		return AP.time.late(-AP.time.now(), -deadline);
	},
	
	
	countdown: function(obj, __render){
		AP.rtimeout(function(){
			var ts="";
			
			var data=$(obj).data('timeremain');
			data=parseInt(data);
			
			if (data && data>=0){
				var d=Math.floor(data/(3600*24));
				var h=Math.floor((data -d*24*3600) /3600);
				var m=Math.floor((data-h*3600-d*24*3600)/60);
				var s=data-d*24*3600-h*3600-m*60;
				var ts=h+"h "+m+"m "+s+"s";
				if (d>0){
					ts=d+"d "+h+"h "+m+"m "+s+"s";
				}
				
				if (__render){
					ts=__render(d,h,m,s);
				}
			}
			
			
			
			$(obj).html(ts);
			
			if (data>=0){
				data=data-1;
				$(obj).data('timeremain', data);
			}
		}, 1000);
	},
	
	

	count: function(initial, callback, finish){
		var t=this.now();
		AP.rtimeout(function(){
			var c=AP.time.now();
			var rem=initial+t-c;
			if (rem<0){
				finish();
			}else{
				callback(rem);
			}
		},1000);
	},
	
	dow: function(index){
		return this.tvDays[index];
	}
};
 

AP.error={
	code:{
	CONFLICT_DATA:997, INVALID_DATA: 998, INCOMPLETE_DATA:999, 
	INVALID_USER:1001, INVALID_AUTHENTICATION:1002, LOGIN_REQUIRED:10033, DB_ERROR:1005, SV_ERROR:1006,
	INVALID_PASSWORD: 1021,
	INVALID_USERNAME:1022,
	INVALID_CHARACTER:1023,
	INVALID_CAPTCHA: 1024,
	INVALID_EMAIL:1020,
	UNKNOWN_ERROR: 990},
	
	messages:{},
	
	translate:function(msg){
		if (AP.error.messages[msg]){
			return AP.error.messages[msg];
		}
		return msg;
	}	
};


AP.random=new function __APRandom(){
	this.word=function(length){
		var text = "";
		var possible = "abcdefghjklmnpqrstuvwxyz";

		for (var i = 0; i < length; i++){
			text += possible.charAt(Math.floor(Math.random() * possible.length));
		}

		return text;
	};
	
	this.avatar=function(){
		return "<img src='http://localhost/lamp/avatars/"+this.int(1,10)+".svg'/>";
	};
	
	this.int=function(f, t_inclusive){
		return f+Math.floor(Math.random() * (t_inclusive+1-f));
	};
	
	this.number=function(from_number, to_number_inclusive){
		if (!from_number){
			from_number=0;
		}
		
		if (!to_number_inclusive){
			to_number_inclusive=100;
		}
		return this.int(from_number, to_number_inclusive);
	};
};


/**
 * @desc General jQuery plugin to support AP.
 * @author Hung Pham
 * @since 1/6/2011
 */

(function($){
	
	/**
	 * @desc jQuery 1.8 fix
	 */
	if (!$.curCSS){
		$.curCSS=$.css;
	};
	
	
	
	/**
	 * @desc log to the console.
	 */
	$.log=function(msg){
		if (Client.env==1 || Client.env=='1'){
			return;
		}
		if (!window.console || !window.console.log){
			
		}else{
			try{
				window.console.log(msg);
			}catch(e){
			}
		}
	};
	
	
	$.logMe=function(element){
		var str = $("<div />").append($(element).clone()).html();
		$.log(str);
	};
	
	$.cookie=function(name, value, options){
		return AP.sys.cookie(name, value, options);
	};

	
	
	/**
	 * @desc Adding an element to the document root when the element
	 * is not exists.
	 */
	$.adding=function(selector, options, callback){
		if (!$(selector).length){			
			options=$.extend({global: false, element: "div", 'class':'', action:'', title:''},options);
			
			var s=selector.substring(1);
			$(document.body).append("<"+options.element+" id='"+s+"'></"+options.element+">");
			if (options.css){
				$(selector).css(options.css);
			}
			
			if (options.title){
				$(selector).attr('title', options.title);
			}
			if (options.action){
				$(selector).attr('action', options.action);
			}
			if (options['class']){
				$(selector).addClass(options['class']);
			}
			if (!options.global){
				$(selector).addClass('__temp');
			}
			
			if (callback){
				callback();
			}
		}
	};
	
	
	/**
	 * @desc Creating a simple scalar object from a complicated object. 
	 */
	$.scalar=function(obj){
		var s={"id": obj.id, "dbk": obj.dbk};
		
		return s;
	};
	
	
	
	$.fn.max=function(field, multiple){
		var tm=null;
		var m=null;
		
		$(this).each(function(){
			var v=$(this).data(field);
			
			
			if (v){
				v=parseInt(v);
				var tv=v;
				
				if (multiple){
					if (AP.data.isInt(multiple)){
						tv=tv*multiple;
					}else{
						tv=multiple(tv);
					}
				}
				
				if (tm===null || tm<tv){
					tm=tv;
					m=v;
				}
			}
		});
		
		return m;
	};
	
	
	/**
	 * @desc Return the maximum width
	 */
	$.maxWidth=function(){
		return Math.max($(window).width(), $(document.body).width());
	};
	
	
	/**
	 * @desc Return the maximum width
	 */
	$.maxHeight=function(){
		var m= Math.max($(window).height(), $(document.body).height()+30);
		if ($("#overlay").length>=1){
			return Math.max(m, $("#overlay").height());
		}
		return $m;
	};
	
	
	$.scrollEnd=function(callback){
		
	};
	
	
	var _scrollbarWidth=0;
	$.sbWidth=function(){
		if (!_scrollbarWidth){
			_scrollbarWidth=getScrollbarWidth();
		}
		return _scrollbarWidth;
	};
	
	
	
	$.fn.reverse = [].reverse;
	
	
	/**
	 * Example:
	 * 
	 * $(window).onFinish('scroll', 250, function(event){
	 * 	
	 * });
	 */
	
	var __off_timer;
	$.fn.onFinish=function(event, delay, callback){
		return $(this).on(event, $.debounce(delay, function(event){
			callback(event);
		}));
	};
	
	
	$.fn.autofocus=function(){
		if (!mobile()){
			$(this).focus();
		}
		
		return this;
	};
	
	
	$.fn.scrollOver=function(fn){
		$(this).on('scroll.__temp', function(){
			var stop=$(this).scrollTop();
			var h=$(this)[0].scrollHeight;
			var diff=h-stop-$(this).height();
			if (Math.abs(diff)<=1){
				fn();
			}
		});
	};
	
	
	$.fn.scrollDown=function(offset){
		AP.html.scrollTo(this, null, {'offset': offset});
	};
	
	$.fn.scrollToBottom=function(){
		var h=$(this)[0].scrollHeight;
		$(this).scrollTop(h);
	};
	
	$.fn.scrollToTop=function(){
		$(this).scrollTop(0);
	};
	
	
	$.fn.contentWidth=function(){
		var w=0;
		$(this).children().each(function(){
			w+=$(this).outerWidth();
		});
		
		return w;
	};
	

	$.fn.apAppend=function(html){
		$(this).append(html);
		AP.html.initInsert(this);
		return this;
	};
	
	
	$.fn.apPrepend=function(html){
		$(this).prepend(html);
		AP.html.initInsert(this);
		return this;
	};
	
	
	$.fn.linkify=function(){
		 $(this).each(function(){
			 var el=$(this);
			 if (el.jquery) {
				 el = el[0];
			 }
			 el.normalize();
			 __linkifyNode(el);
			 return el;
		});
	};
	
	
	
	$.fn.move=function(dir, anim){
		dir=dir.toLowerCase();
		if (dir=="up" || dir=="prev"){
			var $prev=$(this).prev();
			if ($prev && $prev.length){
				if (anim){
					$(this).slideUp(200, function(){
						$(this).insertBefore($prev).slideDown(200);
					});
				}else{
					$(this).insertBefore($prev);
				}
			}
		}
		
		if (dir=="down" || dir=="next"){
			var $next=$(this).next();
			if ($next && $next.length){
				if (anim){
					$(this).slideUp(200, function(){
						$(this).insertAfter($next).slideDown(200);
					});
				}else{
					$(this).insertAfter($next);	
				}
			}
		}
	};
	
	
	/**
	 * @desc Clone css from another selector
	 */
	$.fn.cloneCSS=function(selector, properties){
		var ps=AP.word.split(",", properties);
		for (var i=0; i<ps.length; i++){
			ps[i]=$.trim(ps[i]);
			$(this).css(ps[i], $(selector).css(ps[i]));
		}
	};
	
	
	$.fn.autoExpand=function(options){
		autosize($(this));
		return this;
		
		$(this).each(function(){
			var $this=$(this);
			
			var lh=$this.data("lh");
			if (!lh) lh=22;
			var ih=$(this).height();
			
			$this.css("line-height",lh+"px").css("overflow-y", "hidden");
			$this.data("minh", $(this)[0].scrollHeight).on("keydown", function(e){
				var elem=this;
				setTimeout(function(){
					var minh=$(elem).data("minh");
					// @todo Carefully check this
					if (ih>40){
						$(elem)[0].style.height="auto";
					}
					
					$(elem)[0].style.height=Math.max($(elem)[0].scrollHeight,lh)+"px";
				},0);
			}).keydown();
		});
		
		return this;
	};
	
	
	$.fn.angular=function(options){
		var df={color:"#aaa", bg:"#fff", arc: false, stroke: 10};
		if ($(this).data("color")){
			df.color=$(this).data("color");
		}
		
		if ($(this).data("angle")){
			df.angle=$(this).data("angle");
		}
		
		if ($(this).data("bg")){
			df.bg=$(this).data("bg");
		}
		
		if ($(this).data("text")){
			df.text=$(this).data("text");
		}
		
		if ($(this).data("stroke")){
			df.stroke=$(this).data("stroke");
		}
		
		if ($(this).data("cut") || $(this).data("arc")){
			df.arc=true;
		}
		
		if ($(this).data("percent")){
			df.angle=360*parseFloat($(this).data("percent"))/100;
		}
		
		options=$.extend({}, df, options);
		
		var sektor = new Sektor(this, {
			angle: options.angle,
			sectorColor: options.color,
			circleColor: options.bg,
			arc: options.arc,
			stroke: options.stroke,
			fillCircle: !options.arc
		});
		
		if (options.text){
			$(this).append("<div class='inner-text'>"+options.text+"</div>");
		}
	};
	
	$.fn.screencopy=function(url, success, __data){
		if (!__data){
			__data={};
		}
		
		$(this).bind("paste", function(ev){
			var $this = $(this);
			var original =  ev.originalEvent;
			if (!original.clipboardData || !original.clipboardData.items || !original.clipboardData.items.length){
				return;
			}
			var raw=original.clipboardData.items[0];
			if (typeof raw !='object'){
				return;
			}
			
			var file =  raw.getAsFile();
			if (!file || !file.size || !file.type){
				return;
			}
			
			var reader = new FileReader();
			
			reader.onload = function (evt) {
				var result = evt.target.result; 
				var arr = result.split(",");
				var data = arr[1]; // raw base64
				var contentType = arr[0].split(";")[0].split(":")[1];
				
				// this needs to post to a server route that can accept raw base64 content and save to a file
				var temp=__data;
				temp.contentType=contentType;
				temp.data=data;
				temp.__ss=1;
				
				$this.parent().ajaxShow();
				AP.post(url, temp, function(code){
					$this.parent().ajaxHide();
					
					if (!code.good()){
						return AP.alertError(code.message);
					}
					
					success(code, $this);
				});
			};
			
			reader.readAsDataURL(file);
		});
		
		return this;
	};
	
	
	$.fn.textPasted=function(callback){

		$(this).bind("paste", function(ev){
			var $this = $(this);
			var original =  ev.originalEvent;
			if (!original.clipboardData || !original.clipboardData.items || !original.clipboardData.items.length){
				return;
			}
			var raw=original.clipboardData.items[0];
			if (raw && raw.type=="text/plain"){
				raw.getAsString(function(str){
					callback(str);
				});
			}
		});
		return this;
	};
	
	
	
	$.fn.selectChoices=function(){
		AP.formRender().choiceList(this);
		return this;
	};
	
	
	
	$.fn.selectRadios=function(){
		AP.formRender().radioList(this);
		return this;
	};
	
	

	$.fn.selectDate=function($format){
		var val=$(this).val();
		if (!val || val=="0"){
			$(this).val("");
		}
		
		if ($(this).data("ts")){
			var ts=$(this).data("ts");
			if (ts && ts!="0"){
				$(this).val(AP.time.time(AP.i18n.dateFormat(),ts));	
			}
		}
		
		AP.UI.dateSelect(this, $format);
		return this;
	};
	
	
	$.fn.selectTime=function(options){
		AP.UI.timeSelect(this, options);
		return this;
	};
	
	
	$.fn.selectYear=function(){
		$(this).autocomplete({source: range(2010, 1900)});
	};
	
	
	$.fn.getDialog=function(){
		var $elem=$(this).closest('.__apdialog');
		return AP.dialog('#'+$elem.attr('id'));
	};
	
	
	/**
	 * @desc Modified version of autocomplete
	 * @param sources Array
	 * @param multi_value True/False. Default is false.
	 */
	$.fn.apcomplete=function(source, multi_value, callback, filter_fn){
		if (source==":clean"){
			$(this).val("");
			$(this).siblings('input').val("");
			
			$(this).siblings('.apc-selected').remove();
			return new APComplete(this, source, multi_value, callback);
		}
		
		if (!$(this).hasClass("__apcomplete_marked")){
			$(this).addClass("__apcomplete_marked");
		}else{
			return new APComplete(this, source, multi_value, callback);
		}
		
		if (AP.isString(source)){
			if (multi_value){
				$(this).addClass("__apcomplete_multi");
				var ref=AP.UI.autocompleteComplex($(this), source, callback,filter_fn);
				return new APComplete(this, source, multi_value, callback, ref);
			}
			var ref=AP.UI.autocomplete($(this), source, callback, filter_fn);
			return new APComplete(this, source, multi_value, callback, ref);
		}else{			
			if (multi_value){
				var ref=AP.UI.acx($(this), source, callback,filter_fn);
				return new APComplete(this, source, multi_value, callback, ref);
			}
			var ref= AP.UI.ac($(this), source, callback, filter_fn);
			return new APComplete(this, source, multi_value, callback, ref);
		}
	};
	
	
	/**
	 * @desc String complete, great to use for things like tag autocompletion
	 */
	$.fn.scomplete=function(strings, callback){	
		$(this).on("keydown", function( event ) {
			if (event.keyCode === $.ui.keyCode.TAB && $(this).data("ui-autocomplete").menu.active){
				event.preventDefault();
			}
		})
		.autocomplete({
			minLength: 0,
			classes: {
				 "ui-autocomplete": "base-string-complete"
			},
			source: function(request, response){
				var last=request.term.split(/,\s*/).pop();
				response($.ui.autocomplete.filter(strings,last));
			},
			focus: function(){
				return false;
			},
			select: function(event, ui){
				var terms = this.value.split(/,\s*/);
				terms.pop();
				terms.push(ui.item.value);
				terms.push("");
				this.value = terms.join(", ");
				if (callback){
					callback(ui.item.value);
				}
				return false;
			}
		});
	};
	
	
	$.fn.livesearch=function(url, options){
		if (!options.filter){
			options.filter=null;
		}

		if (options.render){
			
		}
		
		var acc=$(this).apcomplete(url, false, options.select, options.filter);
		
		if (options.render){
			acc.aco.data("ui-autocomplete")._renderItem = function(ul,item) {
				return $("<li>").data("item.autocomplete", item).append(options.render(item)).appendTo(ul);
			};
		}
	};
	
	
	$.fn.stringcomplete=function(url){
		return AP.UI.stringcomplete(this, url);
	};
	
	
	
	$.fn.hasEmbedData=function(key){
		var obj=$(this).data(key);
		if (obj && obj!="" && typeof obj !="undefined"){
			return true;
		}
		
		return false;
	};
	
	var delay_timer=null;
	$.fn.quickFilter=function(selectors, filter_fn){
		$(this).on("input change", function(){
			var $this = $(this);
			clearTimeout(delay_timer);
			
			delay_timer = setTimeout(function(){
				var val=$this.val();
				if (!val || !val.length){
					return $(selectors).show();
				}
				
				val=val.toLowerCase();
				
				$(selectors).each(function(){
					if (filter_fn($(this), val)){
						$(this).show();
					}else{
						$(this).hide();
					}
				});
			}, 300);
		});
	};
	
	
	$.fn.rposition=function(target){
		if (!$(this).closest(target).length){
			return {top:0, left: 0};
		}
		
		var $e=$(this);
		var top=0;
		var left=0;
		
		while (true){
			if (!$e.length){
				break;
			}
			
			if ($e.is(target)){
				break;
			}
			
			var p=$e.position();
			
			if ($e.css("position")=="static" || !$e.css("position")){
			}else{
				top+=p.top;
				left+=p.left;	
			}
			
			$e=$e.parent();
		}
		
		return {top:top, left: left};
	};
	
	$.fn.quickSort=function(selectors, cmp_fn){
		var $elems=$(this).find(selectors).remove();
		$elems.sort(function(a,b){
			return cmp_fn($(a), $(b));
		}).prependTo(this);
	};
	
	
	
	$.fn.suggest=function(data, options){
		options=$.extend({placeholder: $(this).attr('placeholder'), restricted: true}, {}, options);
		
		for (var i=0; i<data.length; i++){
			var e=data[i];
			if (!AP.data.isObject(e) && AP.data.isString(e)){
				data[i]={id: purify(e), label: e};
			}
		}
		
		var $p=$(this).parent();
		var name=$(this).attr("name");
		
		if ($p.hasClass("__suggest_canvas")){
			
		}else{
			$p.addClass("__suggest_canvas").data("options", options);
			
			$(this).addClass("__input-suggestion-target").hide().before("<input class='__input-suggestion-fake' autocomplete='off' placeholder='"+options.placeholder+"' name='"+name+"-ipfk'/>");
			
			var html=AP.render(data, function(e){
				var val;
				if ("id" in e){
					val=e.id;	
				}else{
					val=e.value;
				}
				
				var icon="";
				if (options.multi){
					icon= "<span class='__icon'></span>";
				}
				
				return "<div class='__input-suggestion-row' onclick='__fn_input_suggest(this);' data-id='"+val+"'>"+icon+e.label+"</div>";
			});

			if (options.maxHeight){
				// html="<div class='__iwh' style='max-height:"+options.maxHeight+"px; overflow-y:scroll; overflow-x:hidden'>"+html+"</div>";
			}
			
			if (options.all){
				html="<div class='__input-suggestion-row -is-all' onclick='__fn_input_suggest(this);' data-all='1' data-id='"+options.all.value+"'>"+options.all.label+"</div>"+html;
			}
			
			if (data && data.length >=10){
				html="<div style='max-height:300px; overflow-y:scroll'><div class='__iw'>"+html+"</div></div>";
			}else{
				html="<div class='__iw'>"+html+"</div>";	
			}

			
			if (!options.restricted){
				html+="<div class='__input-extra'><input type='text' class='__input-extra-fx' placeholder='Or type another option here and press Enter'/> <div class='__input-enter'>Enter</div></div>";
			}
			
			
			
			var w=$(this).width()-2;
			html="<div class='__input-suggestion-canvas unselectable'>"+html+"</div>";
			
			$(this).after(html);
			
			$("<div class='__input-suggestion-ph'><div class='__labels'></div><span class='arrow -ap icon-triangle-down'></span></div>").insertAfter(this).click(function(){
				$(this).parent().addClass("__iss");
				$(this).closest(".row").addClass("__ft");
			}).parent().find(".__input-suggestion-fake").focus(function(){
				$(this).parent().addClass("__iss");
				$(this).closest(".row").addClass("__ft");
			});
			
			
			
			$p.clickOut(function(){
				$(this).removeClass("__iss");
				$(this).closest(".row").removeClass("__ft");
			});
	
		
			var v=$(this).val();
			
			if (options.multi){
				var vs=options.df;
				var ls="";
				if (vs && vs.length){
					for (var i=0; i<vs.length; i++){
						$p.parent().find(".__input-suggestion-row").each(function(){
							if ($(this).data("id")==vs[i]){
								$(this).addClass("active");
								ls+=$(this).text()+", ";
							}
						});
					}
					
					$(this).val(vs.join(","));
					$p.find(".__input-suggestion-fake").val(ls);
				}
			}else{
				if (v){
					$p.find(".__input-suggestion-row").each(function(){
						if ($(this).text()==v){
							$(this).addClass("active");
						}else{
							$(this).removeClass("active");
						}
					});
					$(this).val(v);
				}	
			}
			
			$(this).parent().find(".__input-extra-fx").enter(function(){
				var v=$(this).val();
				if (v){
					$p.find(".__input-successtion-row").each(function(){
						if ($(this).text()==v){
							$(this).addClass("active");
						}else{
							$(this).removeClass("active");
						}
					});
					
					$p.find(".__input-suggestion-target").val(v);
					$p.removeClass("__iss");
					$p.closest(".row").removeClass("__ft");
					$p.children().removeClass("active");
				}
			});
			
	
			$(this).parent().find(".__input-enter").click(function(){
				var v=$(this).parent().find("input").val();
				if (v){
					$p.find(".__input-successtion-row").each(function(){
						if ($(this).text()==v){
							$(this).addClass("active");
						}else{
							$(this).removeClass("active");
						}
					});
					
					$p.find(".__input-suggestion-target").val(v);
					$p.removeClass("__iss");
					$p.closest(".row").removeClass("__ft");
					$p.children().removeClass("active");
				}
			});
		}
		
		if (options.value && options.value.length){
			for (var i=0; i<options.value.length; i++){
				$p.find(".__input-suggestion-row").each(function(){
					if ($(this).data("id")==options.value[i]){
						$(this).click();
					}
				});
			}
		}
	};
	
	
	
	$.fn.textSuggest=function(data, options){
		options=$.extend({placeholder: $(this).attr('placeholder'), restricted: true}, {}, options);
		
		for (var i=0; i<data.length; i++){
			var e=data[i];
			if (!AP.data.isObject(e) && AP.data.isString(e)){
				data[i]={id: purify(e), label: e};
			}
		}
		
		var $p=$(this).parent();
		var name=$(this).attr("name");
		
		if ($p.hasClass("__suggest_canvas")){
			
		}else{
			$p.addClass("__suggest_canvas").data("options", options);
			
			var html=AP.render(data, function(e){
				var val;
				if ("id" in e){
					val=e.id;	
				}else{
					val=e.value;
				}
				
				var icon="";
				if (options.multi){
					icon= "<span class='__icon'></span>";
				}
				
				return "<div class='__input-suggestion-row' onclick='__fn_input_text_suggest(this);' data-id='"+val+"'>"+icon+e.label+"</div>";
			});

			if (options.maxHeight){
				// html="<div class='__iwh' style='max-height:"+options.maxHeight+"px; overflow-y:scroll; overflow-x:hidden'>"+html+"</div>";
			}
			
			if (data && data.length >=10){
				html="<div style='max-height:300px; overflow-y:scroll'><div class='__iw'>"+html+"</div></div>";
			}else{
				html="<div class='__iw'>"+html+"</div>";	
			}
		
			var w=$(this).width()-2;
			$(this).after("<div class='__input-suggestion-canvas unselectable'>"+html+"</div>");
			
			
			$(this).on("input focus", function(){
				$(this).next().show();
				var v=$(this).val();
				if (v && v.length){
					
				}
			}).on("blur", function(){
				var $that=$(this);
				setTimeout(function(){
					$that.next().hide();
				}, 300);
			}).enter(function(){
				var $that=$(this);
				setTimeout(function(){
					$that.next().hide();
				}, 100);
			});
		}
	};
	
	
	
	$.fn.tagName=function(){
		return $(this)[0].nodeName.toLowerCase();
	};
	
	
	$.fn.tag=function(url, render_fn, filter_fn, reorder_fn, select_fn){
		if (url=="reset"){
			// RESET TAGGING
			var id=$(this).attr('id');
			var new_id=id+"__temptextarea";
			if ($("#"+new_id).length){
				$("#"+new_id).remove();
			}
			
			var tid="__tag_"+id;
			
			if ($("#"+tid).length){
				$("#"+tid).remove();
			}
			
			return;
		}
		
		
		if ($(this).hasClass("__autoc")){
			return;
		}
		
		$(this).addClass("__autoc");
		
		$(this).data("reorder_fn", reorder_fn);
		
		var id=$(this).attr('id');
		if (!id){
			id=AP.uuid();
			$(this).attr('id', id);
		}

		var pos=$(this).position();
		var tagdir=$(this).data('tagdir');
		var tid="__tag_"+id;
		
		if ($("#"+tid).length){
			$("#"+tid).remove();
		}
		
		
		var item="";
		var tagname=$(this)[0].nodeName.toLowerCase();
		$(this).data("tagname", tagname);
		
		plugin_textarea_init("#"+id);
		
		if (tagdir=="bottom"){
			$("<div class='tags absolute __temp' id='"+tid+"'> "+item+"</div>").appendTo("#context-tag-bottom");
		}else{
			$("<div class='tags absolute __temp' id='"+tid+"'> "+item+"</div>").appendTo("#context-tag");
		}
		
		var $tagbox=$("#"+tid);
		if (tagdir){
			$tagbox.data("tagdir", tagdir);
		}
		
		$tagbox.data("onselect", select_fn);
		
		if ($(this).data("theme")){
			$tagbox.addClass("theme-"+$(this).data("theme"));
		}
		
		$(this).on('keydown', function(e){
			var key=e.keycode? e.keycode:e.which;
			if (key==AP.key.up || key==AP.key.down || key==AP.key.enter){
				if ($tagbox.is(':visible')){
					e.preventDefault();
					e.stopPropagation();
					return false;
				}
			}
		}).data("tagbox", $tagbox);
		
		var compact=false;
		if ($(this).data("compacttagging")){
			compact=true;
		}
		

		$(this).on('keyup', function(e){
			var $tagbox=$(this).data("tagbox");
			
			var key=e.keycode? e.keycode:e.which;
			
			if ($tagbox.is(':visible')){
				if (key==AP.key.down){
					plugin_select_updown_down($tagbox);
					return;
				}else if (key==AP.key.up){
					plugin_select_updown_up($tagbox);
					return;
				}else if (key==AP.key.enter){
					plugin_select_updown_enter($tagbox);
					return;
				}
			}else{
				if (key==AP.key.down || key==AP.key.up){
					return;
				}
			}
			
			var v=$(this).val();
			if (!compact && (!v.length || v.charAt(v.length-1)==' ')){
				fn_cancel_tag(id);
				return;
			}
			
			
			var single=$(this).data("single-tag");
			
			var term=$(this).val();
			if (!single){
				term=$.trim($(this).data("current_word"));	
			}
			
			if (term && term.length>=1){
				if (term.charAt(0)=='@' || compact){
					var q=term;
					if (term.charAt(0)=='@'){
						q=term.substr(1);
					} 				
					
					if (!q.length){
						return;
					}
					
					var data={q: q, rand: AP.uuid()};
					
					data.__code=Client.code;
					if (Client.network){
						data.__network=Client.network.id;	
					}
					
					var tdata=$(this).data("aptag");
					
					if (tdata && tdata.lock && tdata.since && tdata.q){
						if (tdata.lock){
							return;
						}
						if ((tdata.q==q && AP.time.now() - tdata.since<2)){
							return;
						}
					}
					
					$(this).data("aptag",{q: q, since: AP.time.now(), lock: 1});
				
					if (AP.data.isArray(url)){
						var tdata=$("#"+id).data("aptag");
						if (!tdata){
							tdata={};
						}
						
						tdata.lock=0;
						$("#"+id).data("aptag", tdata);
						var code=AP.array.filter(url, function(item){
							return filter_fn(item, q);
						});
						
						var reorder=$(this).data("reorder_fn");
						
						if (reorder){				
							if (code && code.length){
								code.sort(function(a,b){
									return -reorder(a, q)+reorder_fn(b, q);
								});
							}
						}
						
						if (code && code.length && code.length>=1){
							var items=AP.render(code, function(item){
								if (!render_fn){
									return "<span class='item' data-value='"+item.value+"' onclick=\"plugin_tag_select('#"+id+"','"+item.value+" '); fn_cancel_tag('"+id+"');\">"+item.name+"</span>";
								}
								return "<span class='item' data-value='"+item.value+"' onclick=\"plugin_tag_select('#"+id+"','"+item.value+" '); fn_cancel_tag('"+id+"'); \">"+render_fn(item)+"</span>";
							});
							

							var pos=$("#"+id).offset();
							var tagname=$("#"+id).data('tagname');
							
							var tw=$("#"+id).width()+8;
							if (tw<240){
								tw=240;
							}
							
							if (tagname=='textarea' && !Client.native){
								var cpos=plugin_tag_textareacursor("#"+id);
								if (tagdir=="bottom"){
									var bt=$(window).height()-pos.top-$("#"+id).height();
									if (bt<0){
										bt=0;
									}
									
									$tagbox.html(items).show().css({"left": pos.left, "width": tw, bottom: bt+20});
								}else{
									$tagbox.html(items).show().css({"left": pos.left+cpos.left, top: pos.top + cpos.top});
								}
							}else{
								if (tagdir=="bottom"){
									$tagbox.html(items).show().css({"left": pos.left, "width": tw, bottom: $("#"+id).height()+20});
								}else{
									$tagbox.html(items).show().css({"left": pos.left, "width": tw, top: pos.top +10});
								}
							}
							
							plugin_select_updown_first($tagbox);
						}else{
							fn_cancel_tag(id);
						}
					}else{
						$.post(Client.url+'/ajax/'+url, data, function(code){
							var tdata=$("#"+id).data("aptag");
							if (!tdata){
								tdata={};
							}
							tdata.lock=0;
							$("#"+id).data("aptag", tdata);
							
							
							var reorder=$(this).data("reorder_fn");
							
							if (reorder){
								if (code && code.length){
									code.sort(function(a,b){
										return -reorder(a, q)+reorder_fn(b, q);
									});
								}
							}
							
							if (code && code.length && code.length>=1){
								var items=AP.render(code, function(item){
									if (!render_fn){
										return "<span class='item' data-value='"+item.value+"' onclick=\"plugin_tag_select('#"+id+"','"+item.value+" '); fn_cancel_tag('"+id+"');\">"+item.name+"</span>";
									}
									return "<span class='item' data-value='"+item.value+"' onclick=\"plugin_tag_select('#"+id+"','"+item.value+" '); fn_cancel_tag('"+id+"'); \">"+render_fn(item)+"</span>";
								});
								

								var pos=$("#"+id).offset();
								var tagname=$("#"+id).data('tagname');
								
								if (tagname=='textarea' && !Client.native){
									var cpos=plugin_tag_textareacursor("#"+id);
									$tagbox.html(items).show().css({"left": pos.left+cpos.left, top: pos.top + cpos.top});	
								}else{
									if (tagdir=="bottom"){
										$tagbox.html(items).show().css({"left": pos.left, "width": $("#"+id).width()+8, bottom: $("#"+id).height()+20});
									}else{
										$tagbox.html(items).show().css({"left": pos.left, "width": $("#"+id).width()+8, top: pos.top +10});
									}
								}
								
								plugin_select_updown_first($tagbox);
							}else{
								fn_cancel_tag(id);
							}
						},"json");
					}
				}else{
					fn_cancel_tag(id);
				}
			}else{
				fn_cancel_tag(id);
			}
		});
		
	
		return $(this);
	};
	

	
	$.fn.renderEngine=function(fn){
		$(this).data("ui-autocomplete")._renderItem=function(ul, item){
			return $("<li></li>")
			.data("item.autocomplete", item)
			.append("<a class='rerender ap-acitem'>"+ fn(item)+"</a>")
			.appendTo(ul);
		};
		
		return $(this);
	};
	
	
	
	/**
	 * @desc Bind multiple-events
	 */
	$.fn.xbind=function(events, event_data, fn){
		if (!fn){
			fn=event_data;
			event_data={};
		}
		var lists=events.split(" ");
		for (var i=0; i<lists.length; i++){
			$(this).bind(lists[i], event_data, fn);
		}
	};
	
	
	/**
	 * @desc Set a flag on variable. If flag is not set, set it to 1.
	 * @return True if the flag is already set, false otherwhise.
	 */
	$.fn.flag=function(flag_name){
		if (!flag_name){
			flag_name='__flag';
		}
		
		var data=$(this).data(flag_name);
		if (!data){
			$(this).data(flag_name, 1);
			return false;
		}
		if (data==1){
			return true;
		}
		return false;
	};
	
	
	/**
	 * @desc Put a lock on a particular element. Return true if the lock
	 * is put on an unlocked element. False otherwise.
	 */
	$.fn.lock=function(){
		var data=$(this).data("__b_lock");
		if (!data || data===0){
			$(this).data("__b_lock", 1);
			return true;
		}
		return false;
	};
	
	

	/**
	 * @desc Put a lock on a particular element. Return true if the lock
	 * is put on an unlocked element. False otherwise.
	 */
	$.fn.unlock=function(){
		 // release binary lock
		$(this).data("__b_lock", 0);
	};
	
	
	
	/**
	 * @desc Cleanup a particular element.
	 */
	$.fn.cleanUp=function(){
		$(this).children().remove();
		$(this).empty();
		return $(this);
	};

	
	$.fn.preventAutoSubmit=function(){
		$(this).find(":input").on("keypress", function(e){
			if (event.keyCode == 13) {
				event.preventDefault();
				return false;
			}
		});
	};
	
	$.fn.mclick=function(click, dbclick){
		var timer;
		var clicks=0;
		
		$(this).on("click", function(e){
			var $this=$(this);
			clicks++;
			
			if (clicks==1){
				$(this).data("clicked", 1);
				timer=setTimeout(function(){
					click.apply($this[0]);
					clicks=0;
				}, 500);
			}else{
				clearTimeout(timer);
				dbclick.apply(this);
				clicks=0;
			}
		}).on("dbclick", function(e){
			e.preventDefault();
		});
	};
	
	
	$.fn.enter=function(action){
		var $this=$(this);
		$this.data("enter", action);
		$this.addClass("__ap_enter_binded");
		
		$(this).keydown(function(e){
			// Enter was pressed without shift key
			var key=e.keyCode? e.keyCode:e.which;
			if (key == AP.key.enter && !e.shiftKey){
				var id=$this.attr('id');
				if (id){
					var $tid=$("#__tag_"+id);
					if ($tid.length && $tid.is(":visible")){
						return;
					}
				}
				
				// prevent default behavior
				e.preventDefault();
				action.apply(this);
			}
		});
		
		return $this;
	};
	
	
	$.fn.updown=function(selections, select){
		var $this=$(this);
		$(selections).eq(0).addClass("active");
		$this.data("__updown", 0);
		
		$this.keydown(function(e){
			// Enter was pressed without shift key
			var key=e.keyCode? e.keyCode:e.which;
			var move=0;
			if (key==AP.key.up){
				move=-1;
			}
			if (key==AP.key.down){
				move=1;
			}
			
			if (move){
				e.preventDefault();
				var cur=$this.data("__updown");
				if (!cur){
					cur=0;
				}
				
				cur=parseInt(cur)+move;
				if (cur>=$(selections).length){
					cur=$(selections).length-1;
				}
				
				if (cur<0){
					cur=0;
				}
				
				if (cur<0 || !$(selections).length){
				}else{
					$this.data("__updown", cur);
					$(selections).removeClass("active");
					$(selections).eq(cur).addClass("active");
				}
			}
			
			if (key==AP.key.enter){
				var x=$this.data("__updown");
				var elem=$(selections).eq(x);
				select.apply($this, [elem, x]);
			}
		});
		
		
		$(selections).each(function(){
			$(this).click(function(){
				select.apply($this, [this, $(this).index()]);
			})
		});
		
		return $this;
	};
	
	
	$.fn.triggerEnter=function(){
		var action=$(this).data("enter");
		action.apply(this);
	};
	
	
	$.fn.disableTab=function(){
		$(this).keydown(function(e) {
			if (e.keyCode === 9) {
				// get caret position/selection
				var start = this.selectionStart;
					end = this.selectionEnd;

				var $this = $(this);

				// set textarea value to: text before caret + tab + text after caret
				$this.val($this.val().substring(0, start)
							+ "	"
							+ $this.val().substring(end));

				// put caret at right position again
				this.selectionStart = this.selectionEnd = start + 4;

				// prevent the focus lose
				return false;
			}
		});
	};
	
	
	$.fn.caret2=function(){
		return new APCaret(this);
	};
	
	
	$.fn.ajaxShow=function(){
		$(this).addClass("__disabled").append("<div class='__ajaxshow'><span class='__icon -ap icon-spinner7 ficon-spinner'></div></div>");
	};
	
	$.fn.ajaxHide=function(){
		$(this).removeClass("__disabled").find(".__ajaxshow").remove()
	};
	
	$.fn.ajaxOn=function(){
		return $(this).hasClass("__disabled");
	};
	
	
	$.fn.shortlist=function(opts){
		$.extend({max: 10}, opts);
		if ($(this).children().length <= opts.max){
			return;
		}
		
		var rem=$(this).children().length-opts.max;
		
		$(this).data("max", opts.max).after("<div class='js-show-more show-more is-more'><span>Show more ("+(rem)+")</span></div>");
		$(this).children().each(function(index){
			if (index<opts.max){
			}else{
				$(this).addClass("hidden");
			}
		});
		
		$(this).next().click(function(){
			var $prev=$(this).prev();
			$prev.children().each(function(index){
				if (index<$prev.data("max")){
				}else{
					$(this).toggleClass("hidden");
				}
			});
			
			if ($(this).hasClass("is-more")){
				$(this).removeClass("is-more");
				$(this).find("span").html("Show less");
			}else{
				var rem=$prev.children().length-$prev.data("max");
				$(this).addClass("is-more");
				$(this).find("span").html("Show more ("+rem+")"); 
			}
		});
	};
	
	
	/**
	 * @desc Animate and back to the original state
	 */
	$.fn.animateX=function(styles, seconds, xstyles){
		if (!xstyles){
			xstyles={};
		}
		var cstyles={};
		for (var s in styles){
			cstyles[s]=$(this).css(s);
		}
		
		xstyles=$.extend({}, cstyles, xstyles);
		
		$(this).animate(styles, seconds*1000, function(){
			$(this).animate({opacity: "1.0"}, seconds*3000, function(){
				$(this).animate(xstyles, seconds*1000);
			});
		});
	};
	
	
	
	/**
	 * @desc Simplified version of AP.loadURL. Only load html with inline CSS. No change on
	 * the state of the document. Put the html directly to the given element.
	 */
	$.fn.loadHTML=function(url, callback, data){
		$("#ajax-load").show();
		
		var $this=$(this);
		if (!AP.word.prefix(url,'http')){
			url=Client.url+'/'+url;
		}
		
		AP.post(url,{},function(code){
			if (code.good()){
				$.log('Loading HTML '+url);
				
				// Loading css
				for (var i=0; i<code._css.length; i++){
					AP.css(code._css[i]);
				}
				
				$this.html(code._html);
				if (code._inpage_js){
					eval(code._inpage_js);
				}
				if (callback){
					callback(data);
				}
				$("#ajax-load").hide();
			}else{
				if (code.data && code.data.force_redirect){
					AP.redirect(code.data.force_redirect);
					return;
				}
				$("#ajax-load").hide();
			}
		}, true);
		
		return $this;
	};
	
	
	
	/**
	 * @desc Set a flag on variable. If flag is not set, set it to 1.
	 */
	$.fn.apv=function(){
		return AP.html.input(this);
	};
	
	
	/**
	 * @desc Set a flag on variable. If flag is not set, set it to 1.
	 */
	$.fn.xval=function(name, value){
		if (typeof value =='undefined'){
			return AP.html.input(this, name);
		}
		
		return $("*[name="+name+"]", this).val(value);
	};
	
	
	$.fn.restore=function(){
		$(this).each(function(){
			$(this).blur();
			if ($(this).hasClass('__autoresized') && $(this).attr('id')){
				var id=$(this).attr('id');
				var newid='#'+id+"__temptextarea";
				$(newid).html("");
				plugin_textarea_update('#'+id, newid);
				
				var orgh=$('#'+id).data("orgheight");
				if (orgh && parseInt(orgh) && $(this).tagName()!="input"){
					$('#'+id).css("height", orgh);
				}
			}
		});
		
		return this;
	};
	

	/**
	 * @desc Event when a child element is dragged outside its container.
	 */
	$.fn.dragOut=function(container, callback){
		$(this).draggable({
			start: function(event, ui) {
				ui.helper.removeMe = true;
			},
			stop: function(event, ui) {
				if (ui.helper.removeMe) {
					callback(this);
				}
			},  
			revert: true,
			stack:'body',
			zIndex:9999
		});
		
		
		$(container).droppable({
			drop: function(event, ui) {
				// unset removeMe flag as child is still inside parent
			   ui.helper.removeMe = false;
			}
		});
	};
	
	
	
	/**
	 * @desc Trigger an action when click outside.
	 */
	$.fn.clickOut=function(callback, canvas){
		var $elem=$(this);
		if (canvas){
			$(canvas).on('click',function(event){
				if (!$(event.target).closest($elem).length){
					callback.apply($elem);
				}
			});
			
			return;
		}
		
		$(document.body).on('click.__temp',function(event){
			if (!$(event.target).closest($elem).length){
				callback.apply($elem);
			}
		});
	};
	
	
	$.fn.loadedAll=function(callback, params){
		var total_images=$(this).length;
		var num_loaded=0;
		
		$(this).each(function(){
			if ($(this).height()>0){
				num_loaded++;
				if (num_loaded==total_images){
					callback(params);
				}
			}else{
				$(this).bind('load.__temp, error.__temp', {all_callback: callback, all_params:params}, function(event){
					num_loaded++;
					if (num_loaded==total_images){
						var cb=event.data.all_callback;
						cb(event.data.all_params);
					}
				});
			}
		});
	};
	
	
	/**
	 * @desc Get the smallest matched data-{name}
	 */
	$.fn.lastID=function(name){
		if (!name){
			name="id";
		};
		
		var last=0;
		
		$(this).each(function(){
			var val=parseInt($(this).data(name));
			if (!val){
				return;
			}
			
			if (val < last || last==0){
				last=val;
			}
		});
		
		return last;
	};
	
	/**
	 * Set Active. Matching either index or classname.
	 */
	$.fn.setActive=function(chosen){
		if (AP.isInt(chosen)){
			$(this).each(function(index){
				$(this).removeClass('active');
				if (index==chosen){
					$(this).addClass('active');
				}
			});
		}else{
			$(this).each(function(){
				$(this).removeClass('active');
				if ($(this).is(chosen)){
					$(this).addClass('active');
				}
			});
		}
	};
	
	
	/**
	 * Set Active. Matching either index or classname.
	 */
	$.fn.getActive=function(){
		var found=null;
		$(this).each(function(){
			if ($(this).hasClass('active')){
				found=$(this);
				return;
			}
		});
			
		return found;
	};
	
	
	$.fn.setActiveURL=function(url){
		if (AP.data.isFunction(url)){
			var fn=url;
			$(this).each(function(){
				var curl=$(this).data("url");
				if (!curl || !curl.length){
					curl=$(this).data("xurl");
				}
				if (!curl){
					curl="";
				}
				
				var data={};
				var parts=curl.split("?");
				if (parts.length==2){
					data=queryStringToArray(parts[1]);
				}
				
				if (fn.apply(this, [curl, data])){
					$(this).addClass("active");
				}else{
					$(this).removeClass("active");
				}
			});
			return;
		}
		
		var base="";
		var fallback=null;
		if (AP.data.isObject(url) && url.base){
			base=url.base+"/";
		}
		
		if (AP.data.isObject(url) && url.fallback){
			fallback=url.fallback;
		}
		
		var maxscore=-1;
		var set=0;
		if (url && url.length){
			$(this).each(function(){
				var curl=$(this).data("url");
				if (!curl || !curl.length){
					curl=$(this).data("xurl");
					curl=base+curl;
				}
				if (curl==url){
					$(this).addClass("active");
				}else{
					$(this).removeClass("active");
				}
			});
			return;
		}
		
		
		$(this).each(function(){
			var turl=$(this).data("url");
			if (!turl){
				turl=base+$(this).data("xurl");
			}
			var score=computeURLSimilarity(turl);
			$(this).data("active-score", score);
			if (score>maxscore){
				maxscore=score;
			}
		});
		
		
		$(this).each(function(){
			if (set){
				// return;
			}
			
			if ($(this).data("active-score")== maxscore && maxscore>0){
				set=1;
				$(this).addClass('active');
			}else{
				$(this).removeClass('active');
			}
		});
		
		if (!set && fallback){
			$(this).each(function(){
				var turl=$(this).data("url");
				if (!turl){
					turl=$(this).data("xurl");
				}
				
				if (turl==fallback){
					$(this).addClass('active');
				}else{
					$(this).removeClass('active');
				}
			});	
		}
	};
	
	
	$.fn.setActiveURLParam=function(param, df){
		var _df=df;
		if (AP.data.isObject(df)){
			if (df.fallback){
				_df=df.fallback;
			}
			
			if (df.df){
				_df=df.df;
			}
		}
		
		var found=0;
		$(this).each(function(){
			var curl=$(this).data('url');
			if (!curl || !curl.length){
				curl=$(this).data("xurl");
			}
			
			if (!curl || !curl.length){
				curl=$(this).data("updateurl");
			}
			
			if (!curl && $(this).data("urlparam")==param){
				curl=param+"="+$(this).data("value");
			}
			
			
			if (!curl){
				$(this).removeClass('active');
				return;
			}
			
			var cq=Query.get(param);
			var reg=new RegExp(param+"="+cq+"$"); 
			var reg2=new RegExp(param+"="+cq+"[\&\?]");
			
			var df_reg1=null;
			var df_reg2=null;
			
			if (df && AP.data.isString(df)){
				df_reg1=new RegExp(param+"="+_df+"$"); 
				df_reg2=new RegExp(param+"="+_df+"[\&\?]");	
			}
			
			if (curl.match(reg) || curl.match(reg2)){
				found=1;
				$(this).addClass('active');
			}else if (df_reg1 && df_reg2 && curl.match(df_reg1) || curl.match(df_reg2)){
				found=1;
				$(this).addClass('active');
			}else{
				$(this).removeClass('active');
			}
		});
		
		if (!found){
			$(this).setActive(_df);
		}

		
		return this;
	};
	
	
	$.fn.setActiveURLQuery=function(param, defaults){
		var maxscore=-1;
		var set=0;
		
		if (param && defaults){
			$(this).each(function(){
				var curl=$(this).data("url");
				if (!curl || !curl.length){
					curl=$(this).data("xurl");
				}
				if (!curl || !curl.length){
					curl=$(this).data("updateurl");
				}
				
				var qs=Query.get(param);
				if (!qs){
					qs=defaults;
				}
				
				qs=param+"="+qs;
				
				if (curl.indexOf(qs)!=-1){
					$(this).addClass('active');
				}else{
					$(this).removeClass('active');
				}
			});
			return;
		}
	};
	
	
	
	$.fn.setActiveURLQuery=function(param, defaults){
		var maxscore=-1;
		var set=0;
		
		if (param && defaults){
			$(this).each(function(){
				var curl=$(this).data("url");
				if (!curl || !curl.length){
					curl=$(this).data("xurl");
				}
				if (!curl || !curl.length){
					curl=$(this).data("updateurl");
				}
				
				var qs=Query.get(param);
				if (!qs){
					qs=defaults;
				}
				
				qs=param+"="+qs;
				
				if (curl.indexOf(qs)!=-1){
					$(this).addClass('active');
				}else{
					$(this).removeClass('active');
				}
			});
			return;
		}
	};
	
	
	/**
	 * @desc Set active based on data-{key}={value}
	 */
	$.fn.setActiveData=function(key, value){
		$(this).each(function(){
			var v=$(this).data(key);
			if ((!v && !value) || AP.data.equal(v, value)){
				$(this).addClass("active")
			}else{
				$(this).removeClass("active")
			}
		});
	};
	
	
	
	/**
	 * Set Active. Matching either index or classname.
	 */
	$.fn.setChecked=function(chosen){
		if (AP.isInt(chosen)){
			$(this).each(function(index){
				$(this).removeClass('checked');
				if (index==chosen){
					$(this).addClass('checked');
				}
			});
		}else{
			$(this).each(function(){
				$(this).removeClass('checked');
				if ($(this).is(chosen)){
					$(this).addClass('checked');
				}
			});
		}
	};
	
	
	/**
	 * Show only element with index or classname. Hide all others.
	 */
	$.fn.showOnly=function(chosen){
		if (AP.isInt(chosen)){
			$(this).each(function(index){
				if (index==chosen){
					$(this).show('active');
				}else{
					$(this).hide();
				}
			});
		}else{
			$(this).each(function(){
				if ($(this).is(chosen)){
					$(this).show();
				}else{
					$(this).hide();
				}
			});
		}
	};
	
	
	
	/**
	 * Toggle Active. Matching either index or classname.
	 */
	$.fn.toggleActive=function(chosen){ 
		if (AP.isInt(chosen)){
			$(this).each(function(index){
				if (index==chosen){
					$(this).toggleClass('active');
				}else{
					$(this).removeClass('active');
				}
			});
		}else{
			$(this).each(function(){
				if ($(this).is(chosen)){
					$(this).toggleClass('active');
				}else{
					$(this).removeClass('active');
				}
			});
		}
	};
	   
	
	
	/**
	 * Set Active. Matching either index or classname.
	 */
	$.fn.setPage=function(chosen){
		if (AP.isInt(chosen)){
			$(this).children().each(function(index){
				$(this).hide();
				if (index==chosen){
					$(this).show();
				}
			});
		}else{
			$(this).children().each(function(index){
				$(this).hide();
				if ($(this).hasClass(chosen)){
					$(this).show();
				}
			});
		}
	};
	
	
	/**
	 * @desc Set the tooltip value of an element, provided that the tooltip is
	 * already enabled for that element
	 */
	$.fn.setTooltip=function(val){
		$(this).each(function(){
			$(this).find('.__tooltip_inner').html(val);
		});
	};
	
	$.fn.tooltip=function(child, _options){
		if (!_options){
			_options={};
		}
		

		// $(this).addClass('__hblock');
		
		$(this).each(function(){
			var $p=$(this);
			$p.find(child).each(function(){
				var options=$.extend({},{dir: 'down', color: 'black', align: 'center', padding: 8},_options);
				if ($(this).hasClass('__tooltip')){
					return;
				}
				
				var v_color=$(this).data("color");
				if (v_color){
					options.color=v_color;
				}
				
				var v_align=$(this).data("align");
				if (v_align){
					options.align=v_align;
				}
				
				var v_dir=$(this).data("dir");
				if (v_dir){
					options.dir=v_dir;
				}
				
				var v_pad=$(this).data("padding");
				if (v_pad){
					options.padding=v_pad;
				}
				
				var padding=options.padding;
				
				if ($(this).hasClass('padding_less')){
					padding=4;
				}
				$(this).addClass('__tooltip').addClass('__tooltip'+options.color);
				$(this).wrapInner("<div class='__tooltip_inner' style='padding: "+padding+"px'/>");
				
				
				
				var align;
				if (options.align=='right' || $(this).hasClass('align_right')){
					align='right';
					$(this).css('right', -20);
				}else if (options.align=='left' || $(this).hasClass('align_left')){
					align='left';
					$(this).css('left', -20);
				}else if (options.align=='center' || $(this).hasClass('align_center')){
					align='center';
					var tl=$(this).outerWidth(true)- $p.outerWidth(true);
					$(this).css('left', -tl/2.0);
				}
				
				$(this).addClass('__tooltip'+align);
				
				if (options.dir=='down'){
					$("<div class='__ttarr_down2'></div>").appendTo($(this)).css('bottom', 7);
					$("<div class='__ttarr_down'></div>").appendTo($(this)).css('bottom', 9);
				}
			});
			$(this).addClass('__tooltipw');
		});
		
		// $(this).removeClass('__hblock');
	};
	
	
	
	$.fn.contextMenu=function(selector){
		if (!selector){
			selector=".__ctm";
		}
		$(this).each(function(){
				$(this).bind("contextmenu",function(e){
				e.stopPropagation();
				e.preventDefault();
				$("#__ctm").cleanUp().css({top: e.pageY, left: e.pageX}).show();
				
				var elem=$(this).find(selector).first();
				elem.addClass('__contextmenu');
				$(elem).clone().appendTo('#__ctm').show();
			});
			$(this).find(selector).hide();
		});
		return $(this);
	};
	
	

	$.fn.nodeName=function(){
		return $(this)[0].nodeName.toLowerCase();
	};
	
	
	$.fn.xMenu=function(selector){
		$(this).addClass('ap-pointer').addClass('ap-relative');
		$(this).find(selector).first().addClass('__contextmenu').hide();
		$(this).each(function(){
				$(this).bind("click",function(e){
				e.stopPropagation();
				e.preventDefault();
				$(this).find(selector).first().toggle();
			});
		});
	};
	
	
	$.fn.place=function(data){
		$(this).find(".__ph").each(function(){
			var name=$(this).data("name");
			if (data[name]){
				$(this).html(data[name]);
			}
		});
		
		return this;
	};
	
	
	
	$.fn.showCode=function(lang){
		$(this).each(function(){
			var $this=$(this);
			var id=$this.attr('id');
			if (!id){
				id=AP.uuid();
				$this.attr('id', id);
			}
			
			var text=$this.text();
			
			text=AP.word.replaceAll("&#8216;","'", text);
			text=AP.word.replaceAll("&#8217;","'", text);
			text=AP.word.replaceAll("‘","'", text);
			text=AP.word.replaceAll("’","'", text);
			text=AP.word.replaceAll("\t","	", text);
			
			
			$this.html("<pre><code></code></pre></div>");
			var $code=$this.find('code');
			$code.text(text);
			
			
			// $this.html(text);
			
			
			if (!lang){
				lang="php";
			}
			$code.addClass(lang);
			$code.parent().addClass('__codehl compact');
			
			SyntaxHighlighter.highlightDocument($code[0],false);
			
//			text=$this.html();
//			
//			if (text){
//				text=AP.word.replaceAll("\t","&nbsp;&nbsp;&nbsp;", text);
//				text=AP.word.replaceAll("\n","<br>", text);
//				$this.html(text);
//			}
			
			$("li:first-child",$this).addClass('first');
			$("li:last-child",$this).addClass('last');
			
			var $p=$code.parent();
			$p.parent().prepend("<div class='codeheader'>" +
				"<div class='code-title'>Embedded code</div>" +
				"<div class='code-button' onclick=\"$('#"+id+"').toggleClass('__codehlx');\">Highlighted code</div> " +
				"<div class='code-button' onclick=\"$('#"+id+"').toggleClass('__codehlx');\">View sources</div> " +
			"</div>");
			
			var h=$this.height();
			var lx="";
			for (var i=0; i< h/25+1; i++){
				var ln=i;
				if (ln<10){
					ln='00'+ln;
				}else if (ln<100){
					ln='0'+ln;
				}
				if (ln==0){
					lx+="<div class='number-sep'></div>";	
				}else{
					lx+="<div class='number'><div>"+ln+"</div></div>";	
				}
			}
			$code.append("<div class='linenumbers'>"+lx+"</div>");
		});
	};
	
	
	$.fn.setCursorPosition = function(pos) {
		if ($(this).get(0).setSelectionRange) {
			$(this).get(0).setSelectionRange(pos, pos);
		}else if ($(this).get(0).createTextRange) {
			var range = $(this).get(0).createTextRange();
			range.collapse(true);
			range.moveEnd('character', pos);
			range.moveStart('character', pos);
			range.select();
		}
	 };
	
	 
	 $.fn.chartjs=function(data, options){
		if (!options){
			options={};
		}
		 
		if ($(this).data('cheight')){
			options.height=$(this).data('cheight');
		}
		
		options=$.extend({},{width:$(this).width(), type: "line"}, options);
		var optx="";
		for (var key in options){
			optx+=key+"="+options[key]+" ";
		}
		
		
		$(this).children().remove();
		var id=AP.uuid();
		$("<canvas id='"+id+"' "+optx+"></canvas>").appendTo(this);
		
		var ctx = $('#'+id).get(0).getContext("2d");
		
		var myChart = new Chart(ctx, {
			type: options.type,
			data: data,
			options: options
		});
		var myChart = new Chart(ctx);
		return myChart;
	};
	
	

	$.fn.chartjsv2 = function(options, data, extOptions){
		if (!options){
			options={};
		}
		 
		if ($(this).data('cheight')){
			options.height=$(this).data('cheight');
		}
		
		options=$.extend({},{width:$(this).width()},options);
		var optx="";
		for (var key in options){
			optx+=key+"="+options[key]+" ";
		}
		
		
		$(this).children().remove();
		var id=AP.uuid();
		$("<canvas id='"+id+"' "+optx+"></canvas>").appendTo(this);
		
		var ctxP = $('#'+id).get(0);
		
		if (typeof ctxP == 'undefined' || !ctxP) {
			return null;
		}
		var ctx = ctxP.getContext("2d");
		var myNewChart = new Chart(ctx, {
			type: 'line',
			data: data,
			options: extOptions
		});
		return myNewChart;
	};
	
	
	$.fn.caret=function(){
		return new CaretHandler(this);
	};
	
})(jQuery);



function __linkifyNode(node) {
	var _len = node.childNodes.length;
	for (var i=0; i<_len; i++) {
	  if (node.childNodes[i].nodeType == document.ELEMENT_NODE) {
		__linkifyNode(node.childNodes[i]);
	  }
	}
	
	var texts = [];
	for (i=0; i<_len; i++) {
	  if (node.childNodes[i].nodeType == document.TEXT_NODE) {
		if (node.nodeName.toLowerCase()!="a"){
			texts.push(node.childNodes[i]);	
		}else{
			node.setAttribute("target","_blank");
			node.className += " _linkify";
		}
	  }
	}
	
	texts.forEach(function (item) {
	  if (item.nodeType == document.ELEMENT_NODE) {
		  __linkifyNode(item);
	  } else if (item.nodeType == document.TEXT_NODE) {
		while (true) {
		  var text = item.nodeValue;
		  var regex = /\bhttps?:\/\/[a-z0-9\.\-_](:\d+)?[^ \n\t<>()\[\]]*/i;
		  var match = regex.exec(text);
		  if (! match) {
			break;
		  }
		  var leadingNode = document.createTextNode(text.substr(0, match.index));
		  node.replaceChild(leadingNode, item);
		  var anchor = document.createElement("a");
		  anchor.setAttribute("target", "_blank");
		  anchor.className += " _linkify";
		  anchor.href = match[0];
		  anchor.appendChild(document.createTextNode(match[0]));
		  node.insertBefore(anchor, leadingNode.nextSibling);
		  var trailing = document.createTextNode(text.substr(match.index + match[0].length));
		  node.insertBefore(trailing, anchor.nextSibling);
		  item = trailing;
		}
	  }
	});
}







/**
 * @desc Overwrite the getScript function
*/

jQuery.extend({
	apScript: function(url, callback, id) {
	   var head = document.getElementsByTagName("head")[0];
	   var script = document.createElement("script");
	   script.src = url;
	   if (id){
		   script.id=id;
	   }
	
	   // Handle Script loading
	   {
		  var done = false;
	
		  // Attach handlers for all browsers
		  if (script.addEventListener){
			  script.addEventListener("load",function(){
				  if (done){
					  return;
				  }
				  done = true;
				  if (callback) callback();
			  },false);
		  }else if (script.readyState){
			  script.onreadystatechange = function(){
				 if (!done && (this.readyState == "loaded" || this.readyState == "complete" || this.readyState==4)) {
					done = true;
					if (callback)
					   callback();
		
					// Handle memory leak in IE
					script.onload = script.onreadystatechange = null;
				 }
			  };
		  }
	   }
	
	   head.appendChild(script);
	
	   // We handle everything using the script element injection
	   return undefined;
	}

});




function __fn_input_text_suggest(ref){
	var text=$(ref).text();
	
	$box=$(ref).closest(".__input-suggestion-canvas").parent();
	$box.find("input").val(text);
	// $box.find(".__input-suggestion-canvas").hide();
};



function __fn_input_suggest(ref){
	var $box=$(ref).closest(".__input-suggestion-canvas").parent();
	var options=$box.data("options");
	
	
	if (!options.multi || $(ref).data("all")){
		$box.removeClass("__iss");
		$box.closest(".row").removeClass("__ft");
		$box.find(".__input-suggestion-row").removeClass("active");
		
		$(ref).addClass("active");
		var val=$(ref).data("id");
		var text=$(ref).text();
		$box.find("input.__input-suggestion-target").val(val);
		$box.find("input.__input-suggestion-fake").val($(ref).text());
		$box.find("input.__input-extra-fx").val("");
		
		return;
	}
	
	
	var vals=$box.find("input.__input-suggestion-target").val().split(",");
	var id=$(ref).data("id");
	
	

	var found=false;
	for (var i=0; i<vals.length; i++){
		if ($.trim(vals[i])==id){
			found=1;
			break;
		}
	}
	
	if (found){
		$(ref).removeClass("active");
	}else{
		$(ref).addClass("active");
	}
	
	
	var ids=[];
	var ts=[];
	$box.find(".__input-suggestion-row").each(function(){
		if ($(this).data("all")){
			$(this).removeClass("active");
			return;
		}
		
		if ($(this).hasClass("active")){
			ts.push($(this).text());
			ids.push($(this).data("id"));
		}
	});
	
	
	$box.find("input.__input-suggestion-target").val(ids.join(", "));
	$box.find("input.__input-suggestion-fake").val(ts.join(", "));
	$box.find("input.__input-extra-fx").val("");
};


function computeURLSimilarity(url){
	if (!url){
		return 0;
	}
	
	if (!AP.data.isString(url)){
		url=""+url;
	}
	
	var data={};
	var parts=url.split("?");
	if (parts.length==2){
		data=queryStringToArray(parts[1]);
	}
	
	var current=Client.path.current;
	if (!current){
		current="home";
	}
	
	
	var base=0;
	
	if (parts.length==1){
		if (parts[0]==current){
			return 2;
		}
		
		if (current.indexOf(parts[0])!=-1){
			if (parts[0].length){
				return 1+(1.0*parts[0].length/(parts[0].length+1));
			}
			return 1;
		}
	}else{
		if (url==current){
			return 2;
		}
	}
	
	var score=0;
	if (parts[0]==Client.path.full.join("/")){
		score=1;
	}
	
	var same=true;
	for (var key in data){
		if (data[key]!=Query.get(key)){
			same=false;
			break;
		}
	}
	
	if (!same){
		return 0;
	}
	

	for (var key in Query.all()){
		if (data[key] && data[key]===Query.get(key)){
			score++;
		}
	}
	
	return score;
};



function fn_cancel_tag(id){
	var tid="__tag_"+id;
	$("#"+tid).hide();
};



function plugin_textarea_init(id, xtemp){
	var temp='__temp ';
	if (xtemp){
		temp='';
	}
	
	var newid=id.substr(1)+"__temptextarea";
	var tagflag=$(id).data("tag");
	if (!AP.html.exist("#"+newid)){
		$(id).css("overflow","hidden").addClass('__autoresized');
		$(id).data("orgheight", $(id).height());
		
		if (tagflag=="none"){
			$("<div class='"+temp+" ap-block' id='"+newid+"'></div>").appendTo("#ap-invs");
		}else{
			$("<pre class='"+temp+" ap-block' id='"+newid+"'></pre>").appendTo("#ap-invs");	
		}
		$("#"+newid).cloneCSS(id, "lineHeight, fontSize, fontFamily, fontWeight, boxModel");
		
		$("#"+newid).css("width", $(id).width());
		$("#"+newid).css("min-height", $(id).height());
		

		$(id).on('keypress keyup keydown', function(){
			if ($(id).data('tagname')=='textarea'){
				$("#"+newid).css("width", $(id).width());
				$("#"+newid).css("fontSize", $(id).css('fontSize'));	
			}
			plugin_textarea_update(id, "#"+newid);
		});	
	}else{
		console.error("EXIST #"+newid);
	}
};



function plugin_textarea_update(id, newid){
	if (!newid){
		newid="#"+id.substr(1)+"__temptextarea";
	}
	
	var $this=$(id);
	
	var taggable=$this.data("tag");
	var v=$this.val();
	var tagname=$this[0].nodeName.toLowerCase();
	
	if ($(id).data("autoexpand") && $(id).data("maxheight")){
		var orgh=$(newid).height();
		var maxh=$(id).data("maxheight");
		var pd=parseInt($(id).css('padding-top').replace(/[^-\d\.]/g, ''));
		
		if (orgh<maxh){
			$(id).css("height", orgh+2*pd);
		}else{
			$(id).css("height", maxh);
		}
	}
	
	if (taggable=='none' && tagname!='input'){
		v=AP.word.replaceAll("\n","<br>", v);
		v=AP.word.replaceAll("<","&lt;", v);
		v=AP.word.replaceAll(">","&gt;", v);
		
		$(newid).html(v+"&nbsp;");
		
		var mh=$this.data("max-height");
		var ch=$this.height();
		
		var h=$(newid).height();

		if (ch!=h){
			$this.trigger("expand",[ch, h]);
		}
		
		if (!mh || h<mh){
			$this.css("height",h).css("overflow","hidden");
		}else{
			$this.css("height",mh).css("overflow","auto");
		}
	}else{
		var pos=plugin_get_caret_position(id);
		
		if (pos>=0 && pos<=v.length){
			var ch="";
			// Set current word to data("current.word");
			var head="";
			for (var j=pos-1; j>=0; j--){
				var ch=v.charAt(j);
				if (ch!=' ' && ch!="\n" && ch!='>'  && ch!='<' && ch!=',' && ch!='.'){
					head=ch+head;
					if (ch=='@'){
						break;
					}
				}else{
					break;
				}
			}
			
			var tail="";
			for (var j=pos; j<v.length; j++){
				var ch=v.charAt(j);
				if (ch!=' ' && ch!="\n" && ch!='>'  && ch!='<' && ch!=',' && ch!='.'){
					tail=tail+ch;
					if (ch=='@'){
						break;
					}
				}else{
					break;
				}
			}
			
			
			$this.data("current_word",head+tail);
		}
		
		if (pos<v.length){
			v=v.substr(0,pos+1)+"<span></span>"+v.substr(pos+1, v.length-pos-1);
		}else{
			if (v.charAt(v.length-1)!='\n'){
				v=v+"<span></span>";
			}else{
				v=v+"<span></span>&nbsp;";
			}
		}
		
		if (tagname!='input'){
			v=AP.word.replaceAll("<","&lt;", v);
			v=AP.word.replaceAll(">","&gt;", v);
			v=AP.word.replaceAll("\n","<br>", v);
			v=AP.word.replaceAll("&lt;span&gt","<span>", v);
			v=AP.word.replaceAll("&lt;/span&gt","</span>", v);
			
			$(newid).html(v);
			var mh=$this.data("max-height");
			
			var h=$(newid).height();
			if (!mh || h<mh){
				if (Client.native){
					$(id).css("overflow","hidden");
				}else{
					$(id).css("overflow","hidden");	
				}
			}else{
				$(id).css("overflow","auto");
			}	
		}
	}
};



function plugin_textarea_update_simple(id, newid){	
	if (!newid){
		newid="#"+id.substr(1)+"__temptextarea";
	}
	
	var v=$(id).val();
	v=AP.word.replaceAll("\n","<br>", v);
	$(newid).html(v);
	
	var mh=$(id).data("max-height");
	var h=$(newid).height()+32;
	
	
	if (!mh || h<mh){
		$(id).css("height",h).css("overflow","hidden");
	}else{
		$(id).css("height",mh).css("overflow","auto");
	}
};




function plugin_tag_textareacursor(id){
	var newid=id.substr(1)+"__temptextarea";
	var pos=$("#"+newid+" span").position();
	
	return {top: pos.top, left: pos.left, width: $("#"+newid).width(), height: $("#"+newid).height()};
};



function plugin_select_updown_first($obj){
	if (!$obj.is(":visible")){
		return;
	}
	
	$obj.children().each(function(index){
		if (index==0){
			$(this).addClass('__tagactive');
		}
	});
	
	$obj.data('aptag_cindex', 0);
};


function plugin_select_updown_down($obj){
	if (!$obj.is(":visible")){
		return;
	}
	
	var cindex=$obj.data('aptag_cindex');
	var maxlen=$obj.children().length;
	
	if (maxlen==0){
		return;
	}
	
	if (cindex<maxlen-1){
		cindex++;
	}else{
		cindex=0;
	}
	
	var val='';
	$obj.children().each(function(index){
		if (AP.data.equal(index,cindex)){
			val=$(this).data('value');
			$(this).addClass('__tagactive');
		}else{
			$(this).removeClass('__tagactive');
		}
	});
	
	$obj.data('aptag_cindex', cindex);
	
	var id="#"+$obj.attr('id').substr(6);
	plugin_tag_select(id, val);
};



function plugin_select_updown_up($obj){
	if (!$obj.is(":visible")){
		return;
	}
	var cindex=$obj.data('aptag_cindex');
	var maxlen=$obj.children().length;
	
	if (maxlen==0){
		return;
	}
	
	if (cindex>0){
		cindex--;
	}else{
		cindex=maxlen-1;
	}
	
	var val='';
	
	$obj.children().each(function(index){
		if (index==cindex){
			val=$(this).data('value');
			$(this).addClass('__tagactive');
		}else{
			$(this).removeClass('__tagactive');
		}
	});
	
	$obj.data('aptag_cindex', cindex);
	
	var id="#"+$obj.attr('id').substr(6);
	plugin_tag_select(id, val);
};



function plugin_select_updown_enter($obj){
	if (!$obj.is(":visible")){
		return;
	}
	
	var cindex=$obj.data('aptag_cindex');
	var maxlen=$obj.children().length;
	
	if (maxlen==0 || cindex>=maxlen){
		return;
	}
	
	$obj.children().eq(cindex).click();
	$obj.hide();
	
	var select_fn=$obj.data("onselect");
	
	if (select_fn){
		select_fn($obj.children().eq(cindex).data("value"));
	}
};



function plugin_tag_select(id, replaced){
	if ($(id).data("single-tag")){
		$(id).val($.trim(replaced));
		return;
	}
	
	// $(id).next('.__ap_xauto').hide();
	if (!$(id).length){
		return;
	}
	
	var v=$(id).apv();
	var pos=plugin_get_caret_position(id);
	
	var compact=($(id).data("compacttagging")==1 || $(id).data("compacttagging")=='1');
	
	var start=-1;
	var end=v.length;
	if (!v){
		return;
	}
	
	if (compact){
		if (v.indexOf(' ')==-1){
			start=0;
		}else{
			if (pos>=0 && pos<=v.length){
				var ch="";
				// Set current word to data("current.word");
				var head="";
				for (var j=pos-1; j>=0; j--){
					ch=v.charAt(j);
					if (ch!="\n" && ch!='>'  && ch!='<' && ch!=',' && ch!='.'){
						if (ch==' '){
							start=j;
							break;
						}
					}else{
						break;
					}
				}
				
				for (var j=pos; j<v.length; j++){
					var ch=v.charAt(j);
					if (ch!=' ' && ch!="\n" && ch!='>'  && ch!='<' && ch!=',' && ch!='.'){
					}else{
						end=j;
						break;
					}
				}
			}	
		}
	}else{
		if (pos>=0 && pos<=v.length){
			var ch="";
			// Set current word to data("current.word");
			var head="";
			for (var j=pos-1; j>=0; j--){
				ch=v.charAt(j);
				if (ch!=' ' && ch!="\n" && ch!='>'  && ch!='<' && ch!=',' && ch!='.'){
					if (ch=='@'){
						start=j;
						break;
					}
				}else{
					break;
				}
			}
			
			for (var j=pos; j<v.length; j++){
				var ch=v.charAt(j);
				if (ch!=' ' && ch!="\n" && ch!='>'  && ch!='<' && ch!=',' && ch!='.'){
				}else{
					end=j;
					break;
				}
			}
		}

	}
		
	
	
	if (start!=-1){
		v=v.substr(0,start)+((compact&&start>0)?" ":"")+replaced+v.substr(end, v.length-end);
		$(id).val(v);
		$(id).setCursorPosition(start+replaced.length+((compact&&start>0)?1:0));
	}
};



function plugin_actual_tag_select(id, replaced){
	$(id).next('.__ap_xauto').hide();
	var v=$(id).apv();
	var pos=plugin_get_caret_position(id);
	
	var start=-1;
	var end=v.length;
	if (!v){
		return;
	}
	
	if (pos>=0 && pos<=v.length){
		var ch="";
		// Set current word to data("current.word");
		var head="";
		for (var j=pos-1; j>=0; j--){
			ch=v.charAt(j);
			if (ch!=' ' && ch!="\n" && ch!='>'  && ch!='<' && ch!=',' && ch!='.'){
				if (ch=='@'){
					start=j;
					break;
				}
			}else{
				break;
			}
		}
		
		for (var j=pos; j<v.length; j++){
			var ch=v.charAt(j);
			if (ch!=' ' && ch!="\n" && ch!='>'  && ch!='<' && ch!=',' && ch!='.'){
			}else{
				end=j;
				break;
			}
		}
	}
	
	if (start!=-1){
		v=v.substr(0,start)+replaced+v.substr(end, v.length-end-1);
		$(id).val(v);
		$(id).setCursorPosition(start+replaced.length);
	}
};


function CaretHandler(selector){
	this.selector=selector;
	
	this.get=function(){
		return plugin_get_caret_position(this.selector);
	};
	
	this.move=function(position){
		$(this.selector).setCursorPosition(position);
	};
	
	this.start=this.get();
};


function plugin_get_caret_position(id){	
	var el = $(id)[0];
	var pos = 0;
	if ('selectionStart' in el){
		el.focus();
		pos = el.selectionStart;
	} else if ('selection' in document) {
		el.focus();
		var Sel = document.selection.createRange();
		var SelLength = document.selection.createRange().text.length;
		Sel.moveStart('character', -el.value.length);
		pos = Sel.text.length - SelLength;
	}
	return pos;
};


function plugin_textarea_insert(id, str){
	var pos=plugin_get_caret_position(id);
	var val=$(id).val();
	$(id).val(val.substr(0, pos)+str+val.substr(pos+1));
	$(id).setCursorPosition(pos+str.length);
};




/**
 * @desc 'destroyed' callback, very neat
 */
(function($){
	  $.event.special.destroyed = {
		remove: function(o) {
		  if (o.handler) {
			o.handler();
		  }
		}
	  };
})(jQuery);





function choose(a, if_null){
	if (AP.data.isEmpty(a)){
		return if_null;
	}
	return a;
};




/*
 * jQuery throttle / debounce - v1.1 - 3/7/2010
 * http://benalman.com/projects/jquery-throttle-debounce-plugin/
 * 
 * Copyright (c) 2010 "Cowboy" Ben Alman
 * Dual licensed under the MIT and GPL licenses.
 * http://benalman.com/about/license/
 */
(function(b,c){var $=b.jQuery||b.Cowboy||(b.Cowboy={}),a;$.throttle=a=function(e,f,j,i){var h,d=0;if (typeof f!=="boolean"){i=j;j=f;f=c}function g(){var o=this,m=+new Date()-d,n=arguments;function l(){d=+new Date();j.apply(o,n)}function k(){h=c}if (i&&!h){l()}h&&clearTimeout(h);if (i===c&&m>e){l()}else{if (f!==true){h=setTimeout(i?k:l,i===c?e-m:e)}}}if ($.guid){g.guid=j.guid=j.guid||$.guid++}return g};$.debounce=function(d,e,f){return f===c?a(d,e,false):a(d,f,e!==false)}})(this);












/*!
Autosize 4.0.0
license: MIT
http://www.jacklmoore.com/autosize
*/
!function(e,t){if ("function"==typeof define&&define.amd)define(["exports","module"],t);else if ("undefined"!=typeof exports&&"undefined"!=typeof module)t(exports,module);else{var n={exports:{}};t(n.exports,n),e.autosize=n.exports}}(this,function(e,t){"use strict";function n(e){function t(){var t=window.getComputedStyle(e,null);"vertical"===t.resize?e.style.resize="none":"both"===t.resize&&(e.style.resize="horizontal"),s="content-box"===t.boxSizing?-(parseFloat(t.paddingTop)+parseFloat(t.paddingBottom)):parseFloat(t.borderTopWidth)+parseFloat(t.borderBottomWidth),isNaN(s)&&(s=0),l()}function n(t){var n=e.style.width;e.style.width="0px",e.offsetWidth,e.style.width=n,e.style.overflowY=t}function o(e){for(var t=[];e&&e.parentNode&&e.parentNode instanceof Element;)e.parentNode.scrollTop&&t.push({node:e.parentNode,scrollTop:e.parentNode.scrollTop}),e=e.parentNode;return t}function r(){var t=e.style.height,n=o(e),r=document.documentElement&&document.documentElement.scrollTop;e.style.height="";var i=e.scrollHeight+s;return 0===e.scrollHeight?void(e.style.height=t):(e.style.height=i+"px",u=e.clientWidth,n.forEach(function(e){e.node.scrollTop=e.scrollTop}),void(r&&(document.documentElement.scrollTop=r)))}function l(){r();var t=Math.round(parseFloat(e.style.height)),o=window.getComputedStyle(e,null),i="content-box"===o.boxSizing?Math.round(parseFloat(o.height)):e.offsetHeight;if (i!==t?"hidden"===o.overflowY&&(n("scroll"),r(),i="content-box"===o.boxSizing?Math.round(parseFloat(window.getComputedStyle(e,null).height)):e.offsetHeight):"hidden"!==o.overflowY&&(n("hidden"),r(),i="content-box"===o.boxSizing?Math.round(parseFloat(window.getComputedStyle(e,null).height)):e.offsetHeight),a!==i){a=i;var l=d("autosize:resized");try{e.dispatchEvent(l)}catch(e){}}}if (e&&e.nodeName&&"TEXTAREA"===e.nodeName&&!i.has(e)){var s=null,u=e.clientWidth,a=null,c=function(){e.clientWidth!==u&&l()},p=function(t){window.removeEventListener("resize",c,!1),e.removeEventListener("input",l,!1),e.removeEventListener("keyup",l,!1),e.removeEventListener("autosize:destroy",p,!1),e.removeEventListener("autosize:update",l,!1),Object.keys(t).forEach(function(n){e.style[n]=t[n]}),i.delete(e)}.bind(e,{height:e.style.height,resize:e.style.resize,overflowY:e.style.overflowY,overflowX:e.style.overflowX,wordWrap:e.style.wordWrap});e.addEventListener("autosize:destroy",p,!1),"onpropertychange"in e&&"oninput"in e&&e.addEventListener("keyup",l,!1),window.addEventListener("resize",c,!1),e.addEventListener("input",l,!1),e.addEventListener("autosize:update",l,!1),e.style.overflowX="hidden",e.style.wordWrap="break-word",i.set(e,{destroy:p,update:l}),t()}}function o(e){var t=i.get(e);t&&t.destroy()}function r(e){var t=i.get(e);t&&t.update()}var i="function"==typeof Map?new Map:function(){var e=[],t=[];return{has:function(t){return e.indexOf(t)>-1},get:function(n){return t[e.indexOf(n)]},set:function(n,o){e.indexOf(n)===-1&&(e.push(n),t.push(o))},delete:function(n){var o=e.indexOf(n);o>-1&&(e.splice(o,1),t.splice(o,1))}}}(),d=function(e){return new Event(e,{bubbles:!0})};try{new Event("test")}catch(e){d=function(e){var t=document.createEvent("Event");return t.initEvent(e,!0,!1),t}}var l=null;"undefined"==typeof window||"function"!=typeof window.getComputedStyle?(l=function(e){return e},l.destroy=function(e){return e},l.update=function(e){return e}):(l=function(e,t){return e&&Array.prototype.forEach.call(e.length?e:[e],function(e){return n(e,t)}),e},l.destroy=function(e){return e&&Array.prototype.forEach.call(e.length?e:[e],o),e},l.update=function(e){return e&&Array.prototype.forEach.call(e.length?e:[e],r),e}),t.exports=l});








/**
 * @desc Jquery Multi-Upload Plugin
 * @example
 * 		$("#my-form).multiUpload();
 * @author Hung Pham
 */

(function($) {  
	
	$.fn.selectFiles=function(options){
		if (!options){
			options={};
		}
		options=$.extend({},{label:"Select Files","icon":null},options);
		if ($(this).data("label")){
			options.label=$(this).data("label");
		}
		if ($(this).data("alt-label")){
			options.alt_label=$(this).data("alt-label");
		}
		
		
		if ($(this).data("icon")){
			options.icon=$(this).data("icon");
		}

		if (!options.alt_label){
			options.alt_label=options.label;
		}
		
		
		$(this).each(function(){
			if (options.multi){
				$(this).addClass("__multi");
			}
			$(this).addClass('__file_org');
			
			var name=$(this).attr('name');
			var p=$(this).parent();
			p.addClass('__file');
			p.parent().addClass('rowfile');
			if (!p.attr('id')){
				p.attr('id',AP.uuid());
			}
			var pid=$(p).attr('id');
			
			$(this).hide();
			var temp=AP.uuid();
		
			var icon="";
			if (options.icon){
				icon="<span class='ap-f14 "+options.icon+"'></span>&nbsp; "
			}
			
			if ($(this).hasClass("__multi") || options.multi){
				$("<div class='__files hidden'></div> <div class='fl hidden'></div><div class='browse'><em data-alt_label='"+options.alt_label+"' data-prim_label='"+options.label+"'>"+icon+options.label+"</em> <input type='file' name='__tmp"+name+"' class='__browse' onchange=\"__apupload_AddFiles(this, '"+pid+"','"+name+"');\"></div>").appendTo(p);
			}else{
				$("<div class='__files hidden'></div> <div class='fl hidden'></div><div class='browse'><em data-alt_label='"+options.alt_label+"' data-prim_label='"+options.label+"'>"+icon+options.label+"</e> <input type='file' name='__tmp"+name+"' class='__browse' onchange=\"__apupload_AddOneFile(this, '"+pid+"','"+name+"');\"></div>").appendTo(p);
			}
		});
	};
	
	
	
	
	
	/**
	 * @desc Multiupload/select file
	 */
	$.fn.multiUpload=function(options, callback){
		if (options && AP.isString(options) && typeof options!='undefined'){
			return upload_apply(this, options);
		}
		
		options=$.extend({}, {show: true, close_button: false, title: "Upload Files", browse_label: "Browse", submit_label:"Finish Browsing", reset_label:"Reset Selections", hint:"Hint: You can drag your mouses or use CTRL key to select multiple files at once.", clean: false, upload_on_close: false, filename_max_length: 40, max_items: 10, name: 'file', allow:'jpg, jpeg, png, gif, pdf, doc, docx'}, options);
		if (typeof callback!='undefined'){
			options.callback=callback;
		}else{
			options.callback=null;
		}
		
		if (!$(this).flag()){
			// Setup Multi Upload
			options.queue=[];
			upload_setup(this, options);
		}
		
		if (options.clean){
			$(this).multiUpload('clean');
		};
		
		if (options.upload_on_close){
			$(this).addClass('hidden');
		}
		
		if (options.close_button){
			AP.dialog("#"+upload_container($(this).attr('id'))).canvas().find(".__dialogclose").show();
		}
		
		AP.dialog("#"+upload_container($(this).attr('id'))).show();
		
		if (options.show==false){
			AP.dialog("#"+upload_container($(this).attr('id'))).hide();
		};
		
	};
	
	
	/**
	 * @desc Add new file from input[type=file] <param fi or file input>
	 */
	$.fn.multiUpload_addFile=function(fi){
		var options=$(this).data('__ap_upload_data');
		if (!options){
			return false;
		}
		var val=$(fi).val();
		if (val && val.length>1){
			// Get filename
			var name=upload_filename(val);
			if (name){
				upload_displayFile(this, {'name': name, size:''});
			}
		}

	};
	
	
	/**
	 * @desc Add new file from input[type=file] <param fi or file input>
	 */
	$.fn.multiUpload_addMFiles=function(fi, lists){
		// Marking that we are using fileAPI.
		if ($(".__fileapi", this).length==0){
			$(this).append("<input type='hidden' name='fileapi' class='__fileapi' value='1'/>");
		}
		
		$(this).multiUpload('clean');
		
		var options=$(this).data('__ap_upload_data');
		if (!options){
			return false;
		}
		var selector=$(this).attr('id');
		
		for (var i=0; i<lists.length; i++){
			var file=lists[i];
			var name=file.name;
			if (name){
				if (name.length>=options.filename_max_length){
					name=name.substr(0, options.filename_max_length-1)+"...";
				}
				var size='';
				if (file.size){
					size=Math.floor(parseInt(file.size)/1000)+"KB";
				}
				
				// Validation
				if (options.allow && !AP.word.fileX(name, options.allow)){
					return AP.alertError("Invalid file extensions.");
				}
				
				if (options.queue.length >= options.max_items){
					$(this).multiUpload('clean');
					return AP.alertError("You've selected too many files.");
				}
				
				$("#"+upload_container(selector)+" .upload-place").append("<div class='upload-item ap-clear-fix'><div class='index'><div class='i32 i32-circle'><span>"+(options.queue.length+1)+"</span></div></div><div class='name'>"+name+"</div><div class='size'>"+size+"&nbsp;</div><div class='upload-buttons hidden'><span class='s16 s16-apb-close pointer' title='Remove this file?'></span></div><div class='ap-1fix left'></div></div>");
				options.queue.push(file.name);
			}
		}
		
		
		$("#"+upload_container(selector)+" div.browser-button input[name=ap-browser]").attr('name',''+options.name+'[]').unbind('change').appendTo(upload_area(selector));		
		$("#"+upload_container(selector)+" div.browser-button").append("<input type='file' name='ap-browser' multiple=''>");		
		
		$("#"+upload_get_counter_wrapper_id(selector)).html(options.queue.length);
		upload_setChangeHandler(selector);
		
		AP.dialog("#"+upload_container(selector)).balance();
	};
	
	
	
	var upload_apply=function(obj, fn){
		if (fn=='show'){
			AP.dialog("#"+upload_container($(obj).attr('id'))).show();
			return;
		}else if (fn=='get'){
			var options=$(obj).data('__ap_upload_data');
			if (options && options.queue){
				return options.queue;
			}
			return [];
		}else if (fn=='hide'){
			AP.dialog("#"+upload_container($(obj).attr('id'))).hide();
			upload_callback($(obj).attr('id'));
			return;
		}else if (fn=='close'){
			var options=$(obj).data('__ap_upload_data');
			if (!options){
				$.log('multi-upload fails to add file');
				return false;
			}
			if (options.upload_on_close){
				var _fn=AP.nothing;
				if (options.close_callback){
					_fn=options.close_callback;
				}
				AP.submitFrame('#'+$(obj).attr('id'), function(code){
					_fn(code);
				});
			}else{
				AP.dialog("#"+upload_container($(obj).attr('id'))).hide();
			}
			upload_callback($(obj).attr('id'));
		}else if (fn=='clean'){
			var selector=$(obj).attr('id');
			var options=$(obj).data('__ap_upload_data');
			if (!options){
				$.log('multi-upload fails to add file');
				return false;
			}
			
			// When FileAPI is not supported
			if (!AP.sys.file()){
				$("#"+upload_container(selector)+" .upload-place").empty();
				$(upload_area(selector)).empty().html("<input type='hidden' name='max-"+options.name+"' value='"+options.max_items+"'/>");
				$("#"+upload_container(selector)+" div.browser-button").empty().html('Browser').append("<input type='file' name='ap-browser' multiple=''>");
				
				upload_setChangeHandler(selector);
				
				options.queue=[];
				$(obj).data('__ap_upload_data', options);
				$("#"+upload_get_counter_wrapper_id(selector)).html(0);
			}else{
				// We won't remove the input file.
				
				$("#"+upload_container(selector)+" .upload-place").empty();
				$(upload_area(selector)).empty().html("<input type='hidden' name='max-"+options.name+"' value='"+options.max_items+"'/>");
				
				options.queue=[];
				$(obj).data('__ap_upload_data', options);
				$("#"+upload_get_counter_wrapper_id(selector)).html(0);
			}
			
			
		}else{
			$.log('unknown flag '+fn);
		}
	};

	
	
	var upload_callback=function(id){
		var id="#"+id;
		var options=$(id).data('__ap_upload_data');
		if (options.callback){
			options.callback(options.queue);
		}
	};
		
	
	/**
	 * @desc Setup the multi-upload Platform
	 */
	var upload_setup=function(element, options){
		
		$(element).data("__ap_upload_data", options);
		
		var selector=$(element).attr('id');
		var container=upload_container(selector);
		var submit=options.submit_label;

		var buttons="<div class='upload-bt' onclick=\"$('#"+selector+"').multiUpload('close');\">"+submit+"</div>";
		
		var extra_class='';
		if (options.upload_on_close){
			buttons="<div class='upload-bt upload-btd' onclick=\"$('#"+selector+"').multiUpload('hide');\">Cancel</div>"
				+"<div class='upload-bt upload-btd' onclick=\"$('#"+selector+"').multiUpload('close');\">"+submit+"</div>" +
				"<div class='upload-bts'></div>";
		}else{
			extra_class='has_close_button';
		}
		
		
		$("#ap-temp").append("<div id='"+container+"' class='multi-upload ap-mh200'>" +
				"<div class='upload-title ap-clearfix'><span id='"+upload_get_counter_wrapper_id(selector)+"'>0</span> "+"files have been selected"+" <span class='reset' onclick=\"$('#"+selector+"').multiUpload('clean');\">"+options.reset_label+"</span> <div class='button browser-button'>"+options.browse_label+"</div></div>" +
				"<div class='upload-place'></div>" +
				"<div class='upload-extra'></div>" +
				"<div class='upload-buttons relative'>" +
				buttons+
				"</div>"+
			"</div>");
		
		AP.dialog("#"+container)
			.data('form', $(element).attr('id'))
			.engine(AP.config.uploadDialogEngine)
			.title(options.title).width(600)
			.style(extra_class)
			.show();
			
		$("#"+selector).append("<div class='__ap-upload-area hidden'><input type='hidden' name='max-"+options.name+"' value='"+options.max_items+"'/></div>");
		
		$("#"+container+" div.browser-button").append("<input type='file' name='ap-browser' multiple=''>");
		
		
		if (AP.sys.file()){
			$("#"+container+" .upload-extra").append("<div class='desc'>"+options.hint+"</div>");
		}
		
		upload_setChangeHandler(selector);
		
	};
	
	
	/**
	 * @desc Setting up the onChange handler for the input button.
	 */
	var upload_setChangeHandler=function(selector){
		var container=upload_container(selector);
		$("#"+container+" div.browser-button input").bind("change", function(){
			if (AP.sys.file()){
				var s=document.querySelector("#"+container+" div.browser-button input");
				return $('#'+selector).multiUpload_addMFiles(this, s.files);
			}else{
				$('#'+selector).multiUpload_addFile(this);
			}
		});
	};
	
	
	/**
	 * @desc After adding a file, displaying it to dialog
	 */
	var upload_displayFile=function(element, file){
		var options=$(element).data('__ap_upload_data');
		if (!options){
			$.log('multi-upload fails to add file');
			return false;
		}
			
		
		var name=file.name;
		if (name.length>=options.filename_max_length){
			name=name.substr(0, options.filename_max_length-1)+"...";
		}
		var size='';
		if (file.size){
			size=file.size;
		}
		
		// Validation
		if (options.allow && !AP.word.fileX(name, options.allow)){
			return AP.alertError('Invalid file extension.');
		}
		
		if (options.queue.length >= options.max_items){
			return AP.alertError("You've selected too many files.");
		}
		
		var selector=$(element).attr('id');
		$("#"+upload_container(selector)+" .upload-place").append("<div class='upload-item ap-clear-fix'><div class='index'><div class='i32 i32-circle'><span>"+(options.queue.length+1)+"</span></div></div><div class='name'>"+name+"</div><div class='size'>"+size+"&nbsp;</div><div class='upload-buttons'><span class='i12 i12-close pointer' title='Remove this file?'></span></div><div class='ap-1fix left'></div></div>");
		
		$("#"+upload_container(selector)+" div.browser-button input[name=ap-browser]").attr('name',''+options.name+'-'+options.queue.length).unbind('change').appendTo(upload_area(selector));		
		$("#"+upload_container(selector)+" div.browser-button").append("<input type='file' name='ap-browser' multiple=''>");		
		upload_setChangeHandler(selector);
		
		
		options.queue.push(file.name);
		
		$("#"+upload_get_counter_wrapper_id(selector)).html(options.queue.length);
	};
	
	
	
	/**
	 * @desc Return the container ID 
	 */
	var upload_container=function(id){
		return "__upload_"+id;
	};
	
	
	
	/**
	 * @desc Getting the upload wrapper ID to count the items
	 */
	var upload_get_counter_wrapper_id=function(selector){
		return selector+'__upload_counter';
	};
	
	
	/**
	 * @desc Getting the upload area ID
	 */
	var upload_area=function(selector){
		return "#"+selector+" div.__ap-upload-area";
	};
	
	
	/**
	 * @desc Getting the upload filename from some posted sources
	 */
})(jQuery);



var upload_filename=function(str){
	return getUploadFN(str);
};


var __apupload_AddFiles=function(obj, pid, name){
	var $p=$('#'+pid);
	var $files=$('.__files', $p);
	var f=$(obj).val();
	if (f && f.length>1){
		// Get filename
		var tmpname=getUploadFN(f);
		var tempid=AP.uuid();
			
		if (tmpname){
			$('.fl', $p).append("<div class='fi' id='__tmp"+tempid+"'> <div class='remove' onclick=\"__apupload_RemoveFile('"+tempid+"');\"> <div class='tt hidden padding_less' style='width:140px; bottom:20px; font-weight:normal'>Remove file "+tmpname+"?</div> <span class='ticon-cancel entypo'></span></div> <span class='ticon-doc entypo'></span> "+tmpname+"</div>").show();
		}
		$('.__browse',$p).unbind('change').attr('name',name+'[]').attr('id',tempid).appendTo($files);
		$('.browse', $p).append("<input title='Click to select files' type='file' class='__browse' name='__tmp"+name+"' onchange=\"__apupload_AddFiles(this, '"+pid+"','"+name+"');\"/>");
		
		$('.remove',$p).tooltip('.tt');
		
		var alt=$('.browse em', $p).data("alt_label");
		var prim=$('.browse em', $p).data("prim_label");
		
		if ($('.fl .fi', $p).length && $('.fl .fi', $p).length>=1){
			$('.browse > em', $p).html(alt);
		}else{
			$('.browse > em', $p).html(prim);
		}
	}
};


var __apupload_AddOneFile=function(obj, pid, name){
	var $p=$('#'+pid);
	var $files=$('.__files', $p);
	var f=$(obj).val();
	if (f && f.length>1){
		// Get filename
		var tmpname=getUploadFN(f);
		var tempid=AP.uuid();
			
		if (tmpname){
			$('.fl', $p).html("<div class='fi' id='__tmp"+tempid+"'> <div class='remove' onclick=\"__apupload_RemoveFile('"+tempid+"');\"> <div class='tt hidden padding_less' style='width:140px; bottom:20px; font-weight:normal'>Remove file "+tmpname+"?</div> <span class='ticon-cancel entypo ap-f16'></span></div> <span class='ticon-upload ap-f16 entypo'></span> "+tmpname+"</div>").show();
		}
		$files.cleanUp();
		$('.__browse',$p).unbind('change').attr('name',name+'').attr('id',tempid).appendTo($files);
		$('.browse', $p).append("<input title='Click to select a file' type='file' class='__browse' name='__tmp"+name+"' onchange=\"__apupload_AddOneFile(this, '"+pid+"','"+name+"');\"/>");
		
		$('.remove',$p).tooltip('.tt');
		var alt=$('.browse em', $p).data("alt_label");
		var prim=$('.browse em', $p).data("prim_label");
		
		if ($('.fl .fi', $p).length && $('.fl .fi', $p).length>=1){
			$('.browse > em', $p).html(alt);
		}else{
			$('.browse > em', $p).html(prim);
		}
	}
};


var __apupload_RemoveFile=function(id){
	var $p=$('#__tmp'+id).parent();
	
	$('#'+id).remove();
	$('#__tmp'+id).remove();
	
	if (!$p.has('div').length){
		$p.hide();
	}
	
	var $px=$p.closest('.__file');
	
	var alt=$('.browse em', $px).data("alt_label");
	var prim=$('.browse em', $px).data("prim_label");
	var icon="";
	if ($('.__file_org',$px).data("icon")){
		icon="<span class='ap-f14 "+options.icon+"'></span>&nbsp; "
	}
	
	if ($('.fl .fi', $px).length && $('.fl .fi', $px).length>=1){
		$('.browse > em', $px).html(icon+alt);
	}else{
		$('.browse > em', $px).html(icon+prim);
	}
};


/**
 * @desc Sample Engine for Form
 */
var BasicFormEngine=new function __BasicFormEngine(){	
	this.show=function(canvas, form){
		var id=AP.uuid();
		var extra=form.getStyles().join(" ");
		var css=form.getCss().join(";");
		var text="<div class='__form "+extra+"' id='"+id+"' style='"+css+"'> <form method='post' action='"+form.getURL()+"' id='"+form.getID(true)+"'>" +
		this.getRows(form)+
		"<div class='row buttons __buttons'></div>"+
		"</form></div>";
		$(canvas).append(text);
		
		for (var button in form.getButtons()){
			$("<div class='button'>"+button+"</div>").bind('click',{fn: form.getButton(button)},function(event){
				event.data.fn();
			}).appendTo($("#"+id).find('.__buttons').first());
		};
	};
	
	
	this.html=function(form){
		var id=AP.uuid();
		var extra=form.getStyles().join(" ");
		var css=form.getCss().join(";");
		var handler=form.getHandlerInline();
		
		var text="<div class='__form "+extra+"' id='"+id+"' style='"+css+"' "+handler+"> <form method='post' action='"+form.getURL()+"' id='"+form.getID(true)+"'>" +
		this.getRows(form)+
		"</form></div>";
		return text;
	};
	
	
	
	
	/**
	 * @desc Rendering rows
	 */
	this.getRows=function(form){
		var text="";
		for (var i=0; i<form.getData().length; i++){
			var elem=form.getData(i);
			if (!elem.meta.value){
				elem.meta.value="";
			}
			
			var hint="";
			if (elem.meta.hint){
				hint="<div class='hint'>"+elem.meta.hint+"</div>";
			}
			
			
			if (elem.type=='hidden'){
				text+="<input type='hidden' name='"+elem.meta.name+"' value='"+elem.meta.value+"'/>";
			}
			if (elem.type=='text'){
				text+="<div class='row'> <label>"+elem.meta.label+"</label> <div class='input'><input type='text' name='"+elem.meta.name+"' value='"+elem.meta.value+"'/></div>"+hint+"</div>";
			}
			if (elem.type=='file'){
				var _class='';
				if (elem.meta.multi){
					_class=" class='__multi' ";
				}
				text+="<div class='row'> <label>"+elem.meta.label+"</label> <div class='file'><input type='file' "+_class+"name='"+elem.meta.name+"'/></div>"+hint+"</div>";
			}
			if (elem.type=='select'){
				text+="<div class='row'> <label>"+elem.meta.label+"</label> <div class='select'><select class='__multi' name='"+elem.meta.name+"'>"+this.getSelectOptions(elem.meta.options, elem.meta.value)+"</select></div>"+hint+"</div>";
			}
			if (elem.type=='choice'){
				text+="<div class='row'> <label>"+elem.meta.label+"</label> <div class='select'><select class='__choice' name='"+elem.meta.name+"'>"+this.getSelectOptions(elem.meta.options)+"</select></div></div>";
			}
			if (elem.type=='textarea'){
				if (!elem.meta.value){
					elem.meta.value="";
				}
				text+="<div class='row'> <label>"+elem.meta.label+"</label> <div class='input'><textarea name='"+elem.meta.name+"'>"+elem.meta.value+"</textarea></div>"+hint+"</div>";
			}
			if (elem.type=='info'){
				text+="<div class='row'> <label>"+elem.meta.label+"</label> <div class='info'><div>"+elem.meta.value+"</div></div></div>";
			}
			if (elem.type=='hint'){
				text+="<div class='row'><div class='hint'><div>"+elem.meta.value+"</div></div></div>";
			}
		}
		return text;
	};
	
	
	/**
	 * @desc Get options for a select input
	 */
	this.getSelectOptions=function(opts, value){
		var text="";
		for (var opt in opts){
			if (AP.data.equal(opt,value)){
				text+="<option value='"+opt+"' selected>"+opts[opt]+"</option>";
			}else{
				text+="<option value='"+opt+"'>"+opts[opt]+"</option>";
			}
		}
		return text;
	};
};

 

AP.config.form={engine: BasicFormEngine, dialogEngine: BasicDialogEngine};

AP.form=function(id, url, engine, dialogEngine){
	if (!url){
		url='';
	}
	if (!engine){
		engine=AP.config.form.engine;
	}
	if (!dialogEngine){
		dialogEngine=AP.config.form.dialogEngine;
	}
	return new APForm(id, url, engine, dialogEngine);
};


/**
 * @desc Rendering Form
 * @param id
 * @param url
 * @returns {APForm}
 */
function APForm(id, url, engine, dialogEngine){
	this._id=id;
	if (AP.word.prefix(id, "#")){
		this._id=id.substr(1);
	};
	
	this._url=url;
	this._data=[];
	this._classes=[];
	this._buttons={};
	this._title="";
	this._engine=engine;
	this._dialogEngine=dialogEngine;
	this._dialog=false;
	this._callbacks=[];
	this._css=[];
	this._handlers={};
	
	this.handler=function(event, handler){
		this._handlers[event]=handler;
		return this;
	};
	
	
	this.getHandlerInline=function(){
		var handler="";
		for (var event in this._handlers){
			handler+=" "+event+"=\""+this._handlers[event]+"\"";
		}
		return handler;
	};
	
	
	/**
	 * @desc Get data (input) of the form.
	 */
	this.getData=function(index){
		if (index==undefined){
			return this._data;
		}
		return this._data[index];
	};
	
	
	/**
	 * @desc Get all buttons
	 */
	this.getButtons=function(){
		return this._buttons;
	};
	
	
	/**
	 * @desc Get single button
	 */
	this.getButton=function(label){
		return this._buttons[label];
	};
	
	
	/**
	 * @desc Get all styles
	 */
	this.getStyles=function(){
		return this._classes;
	};
	
	
	/**
	 * @desc Get css
	 */
	this.getCss=function(){
		return this._css;
	};
	
	
	/**
	 * @desc Get form ID. Set no_hash to true (call getID(true)) if you want the ID
	 * without the hash at the begining.
	 */
	this.getID=function(no_hash){
		if (!no_hash){
			return "#"+this._id;
		}
		return this._id;
	};
	
	
	/**
	 * @desc Get form title
	 */
	this.getTitle=function(){
		return this._title;
	};
	
	
	/**
	 * @desc Get form action URL
	 */
	this.getURL=function(){
		return this._url;
	};
	


	
	/**
	 * @desc Set the engine for rendering.
	 */
	this.engine=function(engine){
		this._engine=engine;
		return this;
	};
	
	
	/**
	 * @desc Set the engine for rendering.
	 */
	this.dialogEngine=function(dialogEngine){
		this._dialogEngine=dialogEngine;
		return this;
	};
	
	/**
	 * @desc Directly inject css to .__form
	 */
	this.css=function(css){
		this._css.push(css);
		return this;
	};
	
	/**
	 * @desc Alias of adding row.
	 */
	this.row=function(type, meta){
		this._data.push({type: type, meta: meta});
		return this;
	};
	
	
	/**
	 * @desc Set form title
	 */
	this.title=function(title){
		this._title=title;
		return this;
	};
	
	
	/**
	 * @desc Add a new button form button
	 */
	this.button=function(label, fn){
		this._buttons[label]=fn;
		return this;
	};
	
	
	/**
	 * @desc Add a new class
	 */
	this.style=function(style){
		this._classes.push(style);
		return this;
	};
	
	
	
	this.val=function(name){
		return $("#"+this._id+" *[name="+name+"]").apv();
	};
	
	
	/**
	 * @desc Get the HTML representing the form [NO BUTTONS]
	 */
	this.html=function(){
		return this._engine.html(this);
	};
	
	
	
	/**
	 * @desc Show form (inline) 
	 */
	this.release=function(canvas){
		if (!this._dialog){
			this._engine.show(canvas, this);
		}else{
			this.dialog();	
		}
		
		for (var i=0; i<this._callbacks.length; i++){
			this._callbacks[i]();
		}
		return this;
	};
	
	
	/**
	 * @desc Show form in dialog
	 * @param dengine Optional. If set, it will be the dialogEngine.
	 */
	this.dialog=function(dengine){
		if (engine){
			this.dialogEngine(dengine);
		}
		var id=this.getID()+"__dialog";
		AP.dialog(id).title(this.getTitle()).show();
		this._engine.show(AP.dialog(id, this._dialogEngine).find("content"), this);
		AP.dialog(id, this._dialogEngine).balance();
		
		for (var i=0; i<this._callbacks.length; i++){
			this._callbacks[i]();
		}
		
		return this;
	};
	
	
	/**
	 * @desc Hide (close form) for dialog.
	 */
	this.hide=function(){
		AP.dialog(this.getID()+"__dialog").hide();
		return;
	};
	
	
	
	/**
	 * @desc Add callback function (after release)
	 */
	this.callback=function(fn){
		this._callbacks.push(fn);
		return this;
	};
};




var Textarea=new function __TextArea(){
	this.simple=function(str){
		if (!str){
			return "";
		}
		
		return AP.word.replaceAll("<br>","\n", str);
	};
	
	this.clean=function(str){
		if (!str){
			return "";
		}
		
		var regex = /<br\s*[\/]?>/gi;
		str = str.replace(regex, "\n").replace(/&#8220;/g, "\"").replace(/&#8221;/g, "\"").replace(/&#8216;/g, "'").replace(/&#8217;/g, "'");
		return str;
	};
	
};


var BasicDialogEngine=new function __BasicDialogRender(){
	this.canvas=function(){
		return $("#apdialogs");
	};
	
	/**
	 * @desc Render the dialog.
	 */
	this.render=function(dialog){
		dialog.canvas().append("" +
			"<div class='xdialog __dialog' id='"+dialog.w(true)+"'>" +
				"<div class='__dialogwrapper'>" +
					"<div class='__dialogwrapper-inner'>" +
						"<div class='main'>" +
							"<div class='__dialogtitle'>"+"&nbsp;</div>"+
							"<div class='__dialogclose' onclick=\"AP.dialog('"+dialog.id()+"').hide();\"><div class='entypo ticon-cancel'></div> </div>"+
							"<div class='__dialogcontent'></div>" +
							"<div class='__dialogbuttons xo'></div>"+
						"</div>"+
					"</div>"+
				"</div>"+
			"</div>");
	};
	
	
	/**
	 * @desc Balancing the dialog.
	 */
	this.balance=function(dialog){
		var wid=dialog.w();
		var l=$(window).width()/2- $(wid+' .__dialogwrapper').outerWidth(true)/2;
		var t=$(window).height()/2- $(wid+' .__dialogwrapper').outerHeight(true)/2-30;
		
		$(wid+' .__dialogwrapper').css({'top': t,'left': l});
		$(wid+' .dialogwrapper .__buttons .button:last').focus();
	};

};


AP.BSUCCESS='ss';
AP.BSTD='std';
AP.BERROR='er';


function initEscape(){
	$(document).keyup(function(e) {
		 if (e.keyCode == 27) { // escape key maps to keycode "27"
			 $("#apdialogs > .__dialog.__canvas_closable").each(function(){
				if ($(this).hasClass("__dialog_ontop")){
	 				AP.closeDialog($(this).find('.__dialogwrapper'));
				} 
			 });
		}
	});
};

initEscape();


AP.closeAllDialog=function(){
	$("#apdialogs > .__dialog .__dialogwrapper").each(function(){
		AP.closeDialog(this);
	});
};

AP.closeAllDialogs=AP.closeAllDialog;


AP.dialog=function(id, engine){
	if (!engine){
		engine=AP.config.dialog.engine;
	}
	return new APDialog(id, engine);
};



AP.closeDialog=function(ref){
	var dx=$(ref).closest('.__dialog').find(".__apdialog").attr("id");
	$("#"+dx).html("").empty();
	AP.dialog("#"+dx)
		.hide();
	
	AP.fire("dialog-close-"+dx);
	
	var $w=$(ref).closest('.__dialog');
	var events=$w.data("apevents");
	if (events && events.close){
		events.close.apply($w);
	}
};



AP.destroyDialog=function(id){
	var $dx=$("#__apdialog_"+id.substr(1));
	
	if (!$dx.length){
		return;
	}
	
	var events=$dx.data("apevents");
	if (events && events.close){
		events.close.apply($w);
	}
	
	$dx.html("").empty();
	
	$dx.remove();
};



/**
 * @desc AP Dialog
 * @param id
 * @returns {APDialog}
 * @example 
 * 	
 * 	
 	AP.dialog("#testdialog").title("Just a test dialog")
		.button("OK", function(){
			AP.alertSuccess("Good job");
			AP.dialog("testdialog").title("Title changed").content("<h1>Test Dialog Content</h1>")
				.button("Close", function(){
					AP.dialog("testdialog").hide();
				});
		}).button("Cancel", function(){
			AP.alertError("Cancel job");
		})
		.show();
		
 */

function APDialog(id, engine){
	this._rendered=false;
	this._temp=true;
	this._buttons={};
	this._bs={};
	this._title="Untitled";
	this._content="";
	this._classes=[];
	this._css={};
	this._data={};
	this._config={};
	this._icon=null;
	this._closable=false;
	this._close_button=true;
	
	this._engine=engine;
	if (AP.word.prefix(id,"#")){
		id=id.substr(1);
	}
	
	if (!AP.html.exist("#"+id)){
		$(document.body).append("<div id='"+id+"'></div>");
	}else{
		var title=$("#"+id).attr('title');
		if (title){
			this._title=title;
		}
	}
	
	if (engine){
		$("#"+id).data("__engine", engine);	
	}else{
		engine=$("#"+id).data("__engine");
		this._engine=engine;
	}
	
	if ($("#"+id).data("icon")){
		this._icon=$("#"+id).data("icon");
	}
	
	this._id=id;
	
	
	this.data=function(key, value){
		if (typeof value=="undefined"){
			if (key in this._data){
				return this._data[key];
			}
			return null;
		}else{
			this._data[key]=value;
			return this;
		}
	};
	
	
	this.setData=function(data){
		this._data=data;
	};
	
	this.closable=function(flag){
		this._closable=flag;
		return this;
	};
	
	this.closeButton=function(flag){
		this._close_button=flag;
		return this;
	};
	
	/**
	 * @desc Set _temp flag (flag to indicate the existance of the dialog between page transition)
	 */
	this.temp=function(flag){
		this._temp=flag;
		return this;
	};
	
	
	/**
	 * @desc Adding CSS class
	 */
	this.style=function(css_style){
		if (css_style){
			this._classes.push(css_style);
		}
		return this;
	};
	

	
	this.addClass=function(css_style){
		return this.style(css_style);
	};
	
	
	/**
	 * @desc Adding CSS class
	 */
	this.css=function(key, value){
		this._css[key]=value;
		return this;
	};
	
	this.icon=function(icon_class){
		this._icon=icon_class;
	}
	
	/**
	 * @desc Setting engine for rendering
	 */
	this.engine=function(engine){
		this._engine=engine;
		return this;
	};
	
	
	this.config=function(config){
		this._config=$.extend({}, this._config, config);
		return this;
	};
	
	
	
	/**
	 * @desc Add button
	 * @param label The text to be appeared in button
	 * @param fn Callback function 
	 * @param style [Optional] The specific style. If not defined, style will be '__default'
	 */
	this.button=function(label, fn, style){
		var counter=0;
		for (button in this._buttons){
			counter++;
		}
		if (counter==0){
			this.find("buttons").cleanUp();
		}
		var ec='__default';
		if (style){
			ec=style;
		}
		
		
		this._buttons[label]=fn;
		this._bs[label]={'style':ec,'fn':fn};
		
		
		
		if (this.initialized()){
			$("<div class='button "+ec+"'>"+label+"</div>").bind('click',{fn: fn},function(event){
				event.data.fn();
			}).appendTo(this.find("buttons"));
		}
		return this;
	};
	
	
	
	/**
	 * @desc Set title of the dialog
	 */
	this.title=function(title){
		if (title==undefined){
			title=this._title;
		}
		this._title=title;
		if (this.initialized()){
			if (this._icon){
				title="<span class='dialog-icon ap-f14 "+this._icon+"'></span>&nbsp; "+title;
			}
			this.fix('title', title);
		}
		return this;
	};
	
	
	/**
	 * @desc Set content of the dialog
	 */
	this.content=function(content){
		if (content != undefined){
			this._content=content;
		}
		
		if (this.initialized() && !AP.isEmpty(this._content)){
			$(this.id()).children().empty();
			$(this.id()).html(this._content);
		}
		
		return this;
	};
	
	
	this.append=function(id){
		$(id).appendTo($(this.id()));
		return this;
	};
	
	
	
	/**
	 * @desc Set width
	 */
	this.width=function(width){
		if (Client.native || Client.mobile){ 
			this.balance();
			return this;
		}
		
		if (AP.data.isInt(width)){
			if (Client.native || Client.mobile){ 
				$.log(width);
			}else{
				$(this.id()).css("width", width+"px");	
			}
		}else{
			$(this.id()).css("width", width);
		}
		this.balance();
		return this;
	};
	
	
	/**
	 * @desc Get the id (with # at the begining).
	 */
	this.id=function(){
		return "#"+this._id;
	};
	
	
	/**
	 * @desc Get the wrapper id.
	 * @param short Flag to mark whether we should omit the # at the begining.
	 */
	this.w=function(omit){
		if (omit){
			return "__apdialog_"+this._id;
		}
		return "#__apdialog_"+this._id;
	};
	
	
	/**
	 * @desc Return the canvas to contain all dialogs.
	 */
	this.canvas=function(){
		return this._engine.canvas();
	};
	
	
	/**
	 * @desc Check to see if the dialog is fully rendered. If yes, then future
	 * rendering will be progressive.
	 */
	this.initialized=function(){
		if (!AP.html.exist(this.id()) || !$(this.id()).hasClass('__apdialog')){
			return false;
		}
		return true;
	};
	
	
	/**
	 * @desc Render the dialog
	 */
	this.render=function(){
		if (!this.initialized()){
			this._engine.render(this);
			$(this.id()).data("config", this._config);
			$(this.id()).show().addClass('__apdialog').appendTo($(this.find('content'))).attr("title","");
			
			var classes=this._classes.join(" ");
			if (classes){
				$(this.w()).addClass(classes);
			}
			
			for (var k in this._css){
				$(this.id()).css(k, this._css[k]);
			}
			
			if (this._temp){
				$(this.w()).addClass("__temp");
			}
			$(this.w()).addClass("__dialog");
		}
		
		this._rendered=true;
		this.title();
		this.content();
		this.buttons();
		this.balance();
		
		if (this._temp){
		}else{
			var $this=this;
			AP.html.resize(function(){
				$this.balance();
			}, true);
		}
		
		
		return this;
	};
	
	
	/**
	 * @desc Setting buttons
	 */
	this.buttons=function(buttons){
		if (buttons && typeof buttons!=undefined){
			if (AP.data.isArray(buttons)){	
				for (var i=0; i<buttons.length; i++){
					if (!buttons[i].style){
						buttons[i].style='__ap_default_button';
					}
					
					this.button(buttons[i].label, buttons[i].action, buttons[i].style);
				}
			}else{
				for (var button in buttons){
					this.button(button, buttons[button],'__ap_default_button');
				}
			}
		}
		
		if (!this._rendered){
			this.find("buttons").cleanUp();
		}
		
		for (var button in this._buttons){	
			this.button(button, this._bs[button].fn, this._bs[button].style);
		}
		return this;
	};
	
	
	/**
	 * @desc Balance the dialog.
	 */
	this.balance=function(timeout){
		if (!timeout){
			this._engine.balance(this);
			// $.log(this._id); 
			// $.log(this._engine);
		}else{
			var $this=this;
			setTimeout(function(){
				$this._engine.balance($this);
			},timeout);
		}
		return this;
	};
	
	
	/**
	 * @desc Find elements of the dialog
	 */
	this.find=function(comp){
		var c=this.w()+" .__dialog"+comp;
		return $(c).first();
	};
	
	
	this.cond=function(cond, fn){
		if (cond){
			fn.apply(this);
		}
		
		return this;
	};
	
	
	/**
	 * @desc Show the dialog.
	 */
	this.show=function(){
		if (!this.initialized()){
			this.render();
		}
		$(this.canvas()).show();
		$(this.canvas()).children().each(function(){
			$(this).removeClass('__dialog_ontop');
		});
		
		$(".__ontop").removeClass("__ontop");
		$(this.w()).show().addClass('__dialog_ontop');
		this.balance();
		
		if (AP.config.disableParentScrolling && AP.sys.isTablet()){
			$("html, body").addClass("xo");
		}else if (this._config.disableParentScrolling){
			$("html, body").addClass("xo");
		}
		
		
		if (this._closable && !$(this.w()).hasClass("__canvas_closable")){
			$(this.w()).addClass("__canvas_closable");
			$("<div class='__closable'></div>").prependTo($(this.w())).click(function(){
				var id=$(this).closest(".__dialog").find(".__apdialog");
				AP.dialog("#"+id.attr("id")).hide();
			});
		}
		return this;
	};
	
	
	this.on=function(events){
		$(this.w()).data("apevents", events);
	};
	
	
	/**
	 * @desc Hide the dialog.
	 */
	this.hide=function(){
		$(this.w()).hide();
		var config=$(this.id()).data("config");
		var counter=0;
		$(this.canvas()).children().each(function(){
			if ($(this).is(":visible")){
				counter++;
				return;
			}
		});
		if (counter==0){
			$(this.canvas()).hide();
		}
		
		if (AP.config.disableParentScrolling && AP.sys.isTablet()){
			$("html, body").removeClass("xo");
		}else if (config && config.disableParentScrolling){
			$("html, body").removeClass("xo");
		}
		
		return this;
	};
	
	
	this.formatForm=function(){
		$(this.id()+' input[type=file]').selectFiles({label:"Select File"});
		$(this.id()+' textarea').disableTab();
		return this;
	};
	
	
	
	/**
	 * @desc Set flag to request re-rendering. This is not
	 * to show the dialog. 
	 */
	this.rerender=function(){
		this._rendered=false;
	};
	
	
	
	/**
	 * @desc Fix component. Key could be title or content.
	 */
	this.fix=function(key, val){
		this.find(key).html(val);
	};
};


AP.pageData={};
AP.localData={};

AP.lc=new function __APLC(){
	
	this._check=false;
	this._enable=false;
	this.enable=function(){
		if (Client.native){
			return true;
		}
		
		if (!this._check){
			this.check=true;
			if (typeof localStorage !== "undefined" && AP.isset('localStorage')){
				localStorage.setItem('__apc', '__apc');
				if (localStorage.getItem('__apc') == '__apc'){
					this._enable=true;
					return true;
				}else{
					return false;
				}
			}
			
			return false;
		}
		
		return this._enable;
	};
	
	
	this.set=function(key, data){
		if (!this.enable()){
			return false;
		}
		
		localStorage.setItem(key, data);
	};
	
	
	this.get=function(key){
		if (!this.enable()){
			return null;
		}
		
		return localStorage.getItem(key);
	};
	
	
	this.clear=function(key){
		if (!this.enable()){
			return false;
		}
		
		return localStorage.removeItem(key);
	};
};


AP.setTempData=function(code){
	if (!Client.tempData){
		Client.tempData={};
	}
	
	for (var key in code){
		if (key == "message" || key=="code" || key=="html" || key=="__js" || key=="good" || key=="notEmpty" || key=="hasCode" || key=="hasMessage" || key=="___stats" || key=="data"){
			continue;
		}
		
		Client.tempData[key]=code[key];
	}
};




 


Client.addCache=function(data){
	for (var key in data){
		Client.cache[key]=data[key];
	}
};

Client.getCurrentCachesKey=function(){
	var ks=[];
	for (var key in Client.cache){
		ks.push(key); 
	}
	return ks;
};


/**
 * @desc Clear cache except some variables
 */
Client.deleteCachesExcept=function(exs){
	var ks=Client.getCurrentCachesKey();
	for (var i=0; i<ks.length; i++){
		if (!exs){
			delete Client.cache[ks[i]];
		}else{
			if (exs.indexOf(ks[i])<0){
				delete Client.cache[ks[i]];
			}
		}
	};
};


AP.UI= new function _UI(){
	this.icon=function(icon){		
		var color="#000";
		if (icon=="doc" || icon=="docx"){
			color="#0689d5";
		}
		
		if (icon=="png" || icon=="jpg" || icon=="jpeg" || icon=="gif"){
			color="#e48a0f";
		}
		
		if (icon=="xls" || icon=="xlsx"){
			color="#5caa0f";
		}
		
		if (icon=="txt" || icon=="note"){
			color="#00c1cd";
		}
		
		if (icon=="pdf"){
			color="#dc0c12";
		}
		
		
		
		return "<span class='s32-mime-blank __mimeblank'><span class='__mimename' style='background-color: "+color+"'>"+icon+"</span></span>";
	};
	
	
	this.form=function(id, url, engine, dialogEngine){
		if (!engine){
			engine=AP.config.form.engine;
		}
		if (!dialogEngine){
			dialogEngine=AP.config.form.dialogEngine;
		}
		return new APForm(id, url, engine, dialogEngine);
	};

	
	/**
	 * @desc Generate options for year selection
	 */
	this.selectYears=function(start_year, end_year, selected_year){
		if (!selected_year){
			selected_year=0;
		}
		var text="";
		for (var i=end_year; i>start_year; i--){
			if (i==selected_year){
				text+="<option value='"+i+"' selected>"+i+"</option>";
			}else{
				text+="<option value='"+i+"'>"+i+"</option>";
			}
		}
		
		return text;
	};
	
	
	
	/**
	 * @desc Create a hashed link
	 */
	this.hash=function(){
	
		if (arguments.length==1){
			var url=arguments[0];
			if (url.indexOf('http')!=-1){
				var hash=getHash(url);
				if (hash){
					// window.location.hash="!/"+hash.join('/');
					window.location.hash="!/"+hash.join('/');
					AP._last_hash=hash.join('/');
					AP.loadURL(Client.url+'/'+hash.join('/'),{direct_load: true});
					return;
				}
			}
		}
		var path=""; 
		for (var i=0; i<arguments.length; i++){
			if (i>0){
				path=path+"/"+arguments[i];
			}else{
				path=arguments[0];
			}
		}
		// window.location.hash="!"+path;
		window.location.hash="!/"+path;
		AP._last_hash=path;
		AP.loadURL(Client.url+'/'+path,{direct_load: true});
	};
			

	/**
	 * @desc Create a regular link
	 */
	this.link=function(){
		var path="";
		for (var i=0; i<arguments.length; i++){
			path=path+"/"+arguments[i];
		}
		return "#!"+path;
	};
				
			
	/**
	 * @desc Create a time selector
	 */
	this.timeSelect = function(selector, options){
		if (!options){
			options={};
		}
		
		
		$(selector).each(function(){
			$(this).data("ts", options).addClass("__timeselect");
			if (!$(this).data('__timeselect')){
				$(this).data('__timeselect',1);
				var p=$(this).position();
				
				
//				var html='';
//				for (var i=0; i<source.length/4; i++){
//					html+="<div class='items relative'><div class='item' onclick='AP.UI.timeSelectNow(this)'><span>"+source[4*i]+"</span></div><div class='item' onclick='AP.UI.timeSelectNow(this)'><span>"+source[4*i+1]+"</span></div> <div class='item' onclick='AP.UI.timeSelectNow(this)'><span>"+source[4*i+2]+"</span></div>  <div class='item last' onclick='AP.UI.timeSelectNow(this)'><span>"+source[4*i+3]+"</span></div></div>";	
//				}
				
				
				var val=$(this).val();
				var hh=0;
				var mm=0;
				if (val && val.length){
					var hm=getCurrentHM(this);
					hh=hm[0];
					mm=hm[1];
				}else{
					var now=options.value;
					if (!now){
						now=$(this).data("value");
					}
					
					if (!now){
						now=AP.time.now();
					}
					
					if (now){
						$(this).val(AP.time.time("%H:%i", now));
					}
					
					hh=AP.time.time("%H", now);
					mm=AP.time.time("%i", now);
				}

				
				var hhtml="<div class='-tsbox -first' data-name='hour'> <div class='-tsn -up'><span class='-ap icon-chevron-thin-up'></span></div> <div class='-tsn -down'><span class='-ap icon-chevron-thin-down'></span></div> <div class='-tslabel'><div class='-tsinput -hour'>"+(hh)+"</div></div> </div>";
				
				var msrc=range(0,59,5);
				
				var mhtml="";
				mhtml="<div class='-tsbox -second' data-name='min'>" +
						"<div class='-tsn -up'><span class='-ap icon-chevron-thin-up'></span></div>" +
						"<div class='-tsn -down'><span class='-ap icon-chevron-thin-down'></span></div>" +
						"<div class='-tslabel'><div class='-tsinput -min'>"+mm+"</div></div> " +
					"</div>";
				
				
				
				var html="<div class='-tstitle'>Select time <span class='-tsclose'><span class='-ap icon-close'></span></span></div>"+hhtml + mhtml + "<div class='-tsr'>:</div> <div class='clear'></div>";
				
				
				var pos="top: "+p.top+"px; left: "+p.left+"px'";
				if (options && options.align=='bottom'){
					pos="bottom:38px; left: "+p.left+"px'";
				}
				
				$(this).parent().addClass('__timeselectw').append("<div class='__hiddenselect' style='position:absolute; "+pos+">"+html+"</div>");
				
				
				var $canvas=$(this).parent().find('.__hiddenselect');
				$canvas.find("input").on("input focus", function(){
					$canvas.find(".-tsbox").removeClass("active");
					$(this).closest(".-tsbox").addClass("active");
				});
				
				$(this).parent().clickOut(function(){
					$(this).find('.__hiddenselect').hide();
				});
				
				$canvas.find(".-tsclose").click(function(){
					$(this).closest('.__hiddenselect').hide();
				});
				
				$canvas.find(".-tsbox").each(function(){
					$(this).on("mousewheel", function(e){
						e.stopPropagation();
						if (e.originalEvent.wheelDelta / 120 > 0){
							moveTSUp(this);
						}else{
							moveTSDown(this);
						}
					});
					
					$(this).find(".-tsn.-up").click(function(){
						moveTSUp(this);
					});
					
					$(this).find(".-tsn.-down").click(function(){
						moveTSDown(this);
					});
				});
			}
			
			// AP.UI.timeSelectFocus(this);
			
			$(this).on("input focus", function(){
				var options=$(this).data("ts");
				if (!options){
					options={};
				}
				
				if (options.align && options.align=='bottom'){
					$(this).parent().find('.__hiddenselect').css('bottom', 38).show();
				}else{
					var p=$(this).position();
					$(this).parent().find('.__hiddenselect').css('top', p.top).css('left', p.left).show();	
				}
				
				$(this).parent().find('.__hiddenselect .-first .-tslabel input').focus();
				
				// AP.UI.timeSelectFocus(this);
				
				var hm=getCurrentHM(this);
				var $box=$canvas=$(this).parent().find('.__hiddenselect');
				$box.find(".-tsinput.-hour").html(hm[0]);
				$box.find(".-tsinput.-min").html(hm[1]);
				
			}).blur(function(){
				$(this).find('.__hiddenselect').hide();

				var hm=getCurrentHM(this);
				$(this).val(safeNum(hm[0])+":"+safeNum(hm[1]));
			});
			
			
		});
		
		
		
		function moveTSUp(ref){
			var type=$(ref).closest(".-tsbox").data("name");
			if (type=="hour"){
				var hour=getCurrentTS(ref, 'hour');
				hour++;
				if (hour>=24){
					hour=23;
				}
				
				setCurrentTS(ref, 'hour', hour);
			}else{
				var min=getCurrentTS(ref, 'min');
				min=min+5;
				if (min>=60){
					min=min-5;
				}
				
				setCurrentTS(ref, 'min', min);
			}
		};
		
		function moveTSDown(ref){
			var type=$(ref).closest(".-tsbox").data("name");
			if (type=="hour"){
				var hour=getCurrentTS(ref, 'hour');
				hour--;
				if (hour<0){
					hour=0;
				}
				
				setCurrentTS(ref, 'hour', hour);
			}else{
				var min=getCurrentTS(ref, 'min');
				min=min-5;
				if (min<0){
					min=min=5;
				}
				
				setCurrentTS(ref, 'min', min);
			}
		};
		
		
		function getCurrentTS(ref, type){
			var $input=$(ref).closest(".__hiddenselect").prev("input");
			if (!$input.length){
				return 0;
			}
			
			var val=$input.val();
			if (!val){
				val="00:00";
			}
			
			
			var hm=val.split(":");
			if (hm.length!=2){
				return 0;
			}
			
			if (type=='hour'){
				return parseInt(hm[0]);
			}else{
				return parseInt(hm[1]);
			}
		};
		
		
		function setCurrentTS(ref, type, val){
			var $box=$(ref).closest(".__hiddenselect");
			$box.find(".-tsinput.-"+type).html(AP.data.zeroPrefix(val));
			
			
			var hh=0;
			var mm=0;
			
			var $input=$(ref).closest(".__hiddenselect").prev("input");
			var ip="00:00";
			if (!$input.length){
			}else{
				ip=$input.val();
				if (!ip){
					ip="00:00";
				}
			}
			
			var hm=ip.split(":");
			if (hm.length!=2){
			}else{
				hh=hm[0];
				mm=hm[1];
				
				if (type=='hour'){
					hh=val;
				}else{
					mm=val;
				}
			}
			
			hh=parseInt(hh);
			mm=parseInt(mm);
			
			$input.val(AP.data.zeroPrefix(hh)+":"+AP.data.zeroPrefix(mm));
		};
		
		
		function getCurrentHM(ref){
			var hh=0;
			var mm=0;
			
			var ip=$(ref).val();
			
			if (!ip || !ip.length){
				ip="00:00";
			}
			
			var hm=ip.split(":");
			if (hm.length!=2){
				
			}else{
				hh=parseInt(hm[0]);
				mm=parseInt(hm[1]);	
			}
			
			return [safeNum(hh), safeNum(mm)];
		};
		
		function  safeNum(num){
			if (AP.data.isInt(num)){
				return AP.data.zeroPrefix(num);
			}
			
			return "00";
		};
	};

	
	
	this.timeSelectNow=function(ref){
		$(ref).addClass('chosen');
		var val=$("span", ref).html();
		var $p=$(ref).closest('.__timeselectw');
		var $input=$p.find('input.__timeselect');
		$input.val(val);
		$p.find('.__hiddenselect').fadeOut();
	};
	
	
	this.timeSelectFocus=function(selector){
		return;
		
		var val=$(selector).val();
		if (!val || !val.length){
			return;
		}
		
		var t=0;
		
		$(selector).parent().find('.__hiddenselect:first').find('.item').each(function(){
			if ($('span',this).html()==val){
				$(this).addClass('chosen');
				t=$(this).parent().position().top+$(this).closest('.__hiddenselect').scrollTop();
			}else{
				$(this).removeClass('chosen');
			}
		});
		
		if (t){
			t=t-32;
			if (t<0){
				t=0;
			}
			$(selector).parent().find('.__hiddenselect:first').animate({scrollTop: t}, 300);
		}
	};
	
			
	/**
	 * @desc Create a date selector. Require datepicker Jquery Plugin
	 */
	this.dateSelect = function(selector, format){
		if (!format){
			format=AP.locale.get("date-format-jquery","DD, MM d, yy");
		}
		
		$(selector).each(function(){
			$(this).datepicker({"dateFormat": format, firstDay: 1});
		});
	};
			
		
	
	this.stringcomplete=function(ref, url, extra_post_params){
		var $this=$(ref);
		$this.autocomplete({
			source: function(request, response) {
				request.__code=Client.code;
				if (extra_post_params){
					for (var key in extra_post_params){
						request[key]=extra_post_params[key];
					}
				}
				
				request.q=ap_extractCurrentString(ref),
				// console.log(request.q);
				
				$.ajax({
				  url: Client.ajax_url+"/"+url,
				  data: request,
				  dataType: "json",
				  type: "POST",
				  success: function(data){
					  response(data);
				  }
				});
			},

			search: function() {
				// custom minLength
				var term = ap_extractCurrentString(ref);
				if (term===null || (typeof term=='undefined') || term.length < 2 ) {
					return false;
				}
			},
			focus: function() {
				// prevent value inserted on focus
				return false;
			},
			select: function( event, ui ) {
				// Check for value
				var v=ap_extractInsertString(ref, ui.item.value);
				if (v && v.length>1){
					$(this).val(v);
				}
				return false;
			}
		});
	};
			
			
	/**
	 * @desc Create a jQuery autocomplete box
	 */
	this.autocomplete = function(selector, url, callback){	
		var id=ap_createAutoComplete(selector);
		var $this=$("#"+id);
		
		if (!$this.length){
			return;
		}
		
		$this.change(function(){
			if ($(this).val().length==0){
				$(selector).val('');
			}
		});
		
		var acc=$("#"+id).autocomplete({
			source: function(request, response) {
				var onAjaxStart=$this.data('onajaxstart_callback');
				var onAjaxEnd=$this.data('onajaxend_callback');
				
				request.__code=Client.code;
				request.q=ap_extractLast(request.term);
				request.time=AP.time.now();
				
				// Set more data
				if (Client.native){
					var params=M.params();
					for (var key in params){
						M.formData(request, key, params[key]);
					}
				}
				
				if (!request.q || request.q.length <2){
					return null;
				}
				
				for (var key in AP.ajax_data){
					request[key]=AP.ajax_data[key];
				}
				
				var ajax_url=Client.ajax_url+"/"+url+"/"+Client.code;
				if (AP.word.isURL(url)){
					ajax_url=url+"/"+Client.code;
				}
				
				if (onAjaxStart) onAjaxStart();
				
				$.ajax({
				  url: ajax_url,
				  data: request,
				  dataType: "json",
				  type: "POST",
				  success: function(data){
					  if (onAjaxEnd) onAjaxEnd();
					  response(data);
				  }
				});
			},

			select: function( event, ui ){		
				$(selector).val(ui.item.id);
				if (!callback && $('#'+id).data('select_callback')){
					callback=$('#'+id).data('select_callback');
				}
				if (callback){
					callback(ui.item);
				}
				
				$("#"+id).val(ui.item.name);
			}
		});
		 
		acc.data("ui-autocomplete")._renderItem = function( ul, item ) {
			var label=item.value;
			if (item.label && item.label.length){
				label=item.label;
			}
			return $("<li>").data("item.autocomplete", item).append("<a>" + label + "</a>").appendTo(ul);
			
		};
		
		return acc;
	};
			
	this.autocompleteComplex = function(selector, url, callback, extra_post_params){
		var id=ap_createAutoComplete(selector, true);
		var $this=$("#"+id);
		
		$this.autocomplete({
			source: function(request, response) {
				var onAjaxStart=$this.data('onajaxstart_callback');
				var onAjaxEnd=$this.data('onajaxend_callback');
			
				request.__code=Client.code;
				if (extra_post_params){
					for (var key in extra_post_params){
						request[key]=extra_post_params[key];
					}
				}
				request.q=ap_extractLast(request.term);
				request.time=AP.time.now();
				
				if (onAjaxStart) onAjaxStart();
				
				$.ajax({
				  url: Client.ajax_url+"/"+url,
				  data: request,
				  dataType: "json",
				  type: "POST",
				  success: function(data){
					  response(data);
					  if (onAjaxEnd) onAjaxEnd();
				  }
				});
			},

			search: function() {
				// custom minLength
				var term = ap_extractLast( this.value );
				if ( term.length < 2 ) {
					return false;
				}
			},
			focus: function() {
				// prevent value inserted on focus
				return false;
			},
			select: function( event, ui ) {
				// Check for value
				var results=AP.word.split(",",$(selector).val());
				if (AP.array.within(ui.item.id, results)){
					// Do nothing
					$(this).val("");
					return false;
				}
				
				results.push(ui.item.id);
				$(selector).val(results.join(","));
				$("<div class='apc-selected'> <span class='apc-text'>"+ui.item.value+"</span> <span class='apc-close' onclick=\"AP.UI.acxRemoveItem(this,'"+ui.item.id+"');\">x</span></div>").insertBefore(this);
				
				$(this).val("");
				return false;
			}
					
		});
		

		return $this;
	};
			
			
	/**
	 * @desc Autocomplete regularly.
	 */
	this.ac= function(selector, resource, callback, filter_fn){
		var acc=$(selector).autocomplete({source: resource, select: function(a, b){
			callback(b.item);
		}});
		
		acc.data("ui-autocomplete")._renderItem = function( ul, item ) {
			var label=item.value;
			if (item.label && item.label.length){
				label=item.label;
			}
			
			return $("<li>").data("item.autocomplete", item).append("<a>" + label + "</a>").appendTo(ul);
			
		};
		
		return acc;
	};
			
			
	/**
	 * @desc Autocomplate with multivalue
	 */
	this.acx= function(selector, sources, filter_fn){
		var id=ap_createAutoComplete(selector, true); 

		var $this=$("#"+id);
		$this.bind("keydown", function( event ) {
			if ( event.keyCode === $.ui.keyCode.TAB &&
					$( this ).data( "autocomplete" ).menu.active ) {
				event.preventDefault();
			}
		})
		.autocomplete({
			minLength: 0,
			source: function(request, response){
				// delegate back to autocomplete, but extract the last term
				response($.ui.autocomplete.filter(
					sources, ap_extractLast( request.term)));
			},
			focus: function() {
				// prevent value inserted on focus
				return false;
			},
			select: function( event, ui ) {
				// Check for value
				var results=AP.word.split(",",$(selector).val());
				if (AP.array.within(ui.item.id, results)){
					// Do nothing
					$(this).val("");
					return false;
				}
				
				results.push(ui.item.id);
				$(selector).val(results.join(","));
				
				$("<div class='apc-selected xfill'> <span class='apc-text'>"+ui.item.value+"</span> <span class='apc-close' onclick=\"AP.UI.acxRemoveItem(this,'"+ui.item.id+"');\">x</span></div>").insertBefore(this);
				
				$(this).val("");
				
				return false;
			}
		});
		
		return $this;
	};
			
	
	
	
	/**
	 * @desc Autocomplate with tagcloud, multiple color
	 */
	this.tagcloud= function(selector, sources, selected){
		var id=ap_createAutoComplete(selector, true); 

		var $this=$("#"+id);
		var acc=$this.bind("keydown", function( event ) {
			if ( event.keyCode === $.ui.keyCode.TAB &&
					$( this ).data( "autocomplete" ).menu.active ) {
				event.preventDefault();
			}
		})
		.autocomplete({
			minLength: 0,
			source: function(request,response){
				// delegate back to autocomplete, but extract the last term
				response($.ui.autocomplete.filter(
					sources, ap_extractLast( request.term)));
			},
			focus: function() {
				// prevent value inserted on focus
				return false;
			},
			select: function( event, ui ) {
				// Check for value
				var results=AP.word.split(",",$(selector).val());
				if (AP.array.within(ui.item.name, results)){
					// Do nothing
					$(this).val("");
					return false;
				}
				
				results.push(ui.item.name);
				$(selector).val(results.join(","));
				
				$("<div class='apc-selected fill -bg-alt"+ui.item.color+"-less text-alt"+ui.item.color+"-less'> <span class='apc-text'>"+ui.item.name+"</span> <span class='apc-close' onclick=\"AP.UI.acxRemoveItem(this,'"+ui.item.name+"');\">x</span></div>").insertBefore(this);
				
				$(this).val("");
				
				return false;
			}
		}).focus(function () {
			$(this).autocomplete('search', $(this).val())
		}).enter(function(){
			var v=$(this).val();
			if (!v.length){
				return;
			}
			
			// Check for value
			var results=AP.word.split(",",$(selector).val());
			if (AP.array.within(v, results)){
				// Do nothing
				$(this).val("");
				return false;
			}
			
			results.push(v);
			$(selector).val(results.join(","));
			
			$("<div class='apc-selected fill -bg-alt0'> <span class='apc-text'>"+v+"</span> <span class='apc-close' onclick=\"AP.UI.acxRemoveItem(this,'"+v+"');\">x</span></div>").insertAfter(this);
			
			$(this).val("");
			
			return false;
		});
		
		acc.data("ui-autocomplete")._renderItem = function(ul,item) {
			return $( "<li></li>" ).data("item.autocomplete", item)
				.append( "<span class='ap-acx'><span class='ap-acx-square -bg-alt"+item.color+"'></span> "+item.name+"</span>") 
				.appendTo(ul);
		};
		
		
		if (selected && selected.length){
			$(selector).val(selected.join(","));
			
			for (var i=0; i<selected.length; i++){
				var v=selected[i];
				$("<div class='apc-selected fill -bg-alt0'> <span class='apc-text'>"+v+"</span> <span class='apc-close' onclick=\"AP.UI.acxRemoveItem(this,'"+v+"');\">x</span></div>").insertBefore(selector);
			}
		}
		
		return $this;
	};
	
	
	this.acxRemoveItem= function(selector, item){
		// Check for input
		var input=$(selector).closest('.apcomplete').children("input.marked");
		$(selector).parent().remove();
		var values=AP.word.split(",",$(input).val());
		var newvals=[];
		for (var i=0; i<values.length; i++){
			if (values[i]!=item){
				newvals.push(values[i]);
			}
		}
		$(input).val(newvals.join(","));
	};
			
			
			
			
			
	/**
	 * @desc Get the meta value.
	 */
	this.displayInt= function(v){
		if (v){
			return v;
		}
		return 0;
	};
	
	
	this.copyTextToClipboard = function(text) {
		var textArea = document.createElement("textarea");

		// Place in top-left corner of screen regardless of scroll position.
		textArea.style.position = 'fixed';
		textArea.style.top = 0;
		textArea.style.left = 0;

		// Ensure it has a small width and height. Setting to 1px / 1em
		// doesn't work as this gives a negative w/h on some browsers.
		textArea.style.width = '2em';
		textArea.style.height = '2em';

		// We don't need padding, reducing the size if it does flash render.
		textArea.style.padding = 0;

		// Clean up any borders.
		textArea.style.border = 'none';
		textArea.style.outline = 'none';
		textArea.style.boxShadow = 'none';

		// Avoid flash of white box if rendered for any reason.
		textArea.style.background = 'transparent';


		textArea.value = text;

		document.body.appendChild(textArea);

		textArea.select();

		try {
			var successful = document.execCommand('copy');
			
			UI.flash("Đã sao chép vào clipboard!");
		} catch (err) {
			return AP.alertSuccess(text);
		}

		document.body.removeChild(textArea);
	};
};



function APComplete(obj, url, multi, callback, ref, filter_fn){
	this.$obj=$(obj);
	this.url=url;
	this.multi=multi;
	this.callback=callback;
	this.__error=false;
	
	if (ref && this.$obj){
		this.$target=this.$obj.siblings('.__apc_marked_class');
		if (ref.data("ui-autocomplete")){
			this.ref=ref.data("ui-autocomplete").menu.element;
		}else{
			this.ref=null;
		}
	}else{
		this.__error=true;
	}
	
	
	
	this.aco=ref;
	
	this.addClass=function(classname){
		this.$target.data("ui-autocomplete").addClass(classname);
	};
	
	this.render=function(fn){
		if (this.__error){
			return this;
		}
		
		this.$target.data("ui-autocomplete")._renderItem=function(ul, item){
			return $("<li></li>")
			.data("item.autocomplete", item)
			.append("<a class='rerender ap-acitem'>"+ fn(item)+"</a>")
			.appendTo(ul);
		};
		
		return this;
	};
	
	this.renderEngine=function(fn){
		return this.render(fn);
	};
	
	this.addClass=function(classes){
		if (this.__error){
			return this;
		}
		
		this.ref.addClass(classes);
		return this;
	};
	
	this.css=function(key,val){
		this.ref.css(key,val);
		return this;
	};
	
	this.val=function(value, label){
		if (this.__error){
			return;
		}
		
		if (!this.multi){
			this.$obj.val(value);
			this.$target.val(label);
			return this;
		}else{
			var results=AP.word.split(",",this.$obj.val());
			if (AP.array.within(value, results)){
				this.$target.val("");
				return false;
			}
			results.push(value);
			this.$obj.val(results.join(","));
			$("<div class='apc-selected'> <span class='apc-text'>"+label+"</span> <span class='apc-close' onclick=\"AP.UI.acxRemoveItem(this,'"+value+"');\">x</span></div>").insertBefore(this.$target);
			this.$target.val("");
		}
	};
	
	this.select=function(callback){
		this.$target.data('select_callback', callback);
		return this;
	};
	
	this.onAjaxStart=function(callback){
		this.$target.data('onajaxstart_callback', callback);
		return this;
	};
	
	this.onAjaxEnd=function(callback){
		this.$target.data('onajaxend_callback', callback);
		return this;
	};
};



function ap_createAutoComplete(selector, multivalues){	
	var p=$(selector).parent();
	var id=AP.uuid();
	
	if (!$(p).hasClass('apcomplete')){
		$(selector).data("apcomplete_ref",id);
		
		if ($(selector).hasClass('__hinited')){
			$(selector).prev().hide();
		}
		
		$(p).css("min-height", $(selector).height());
		
		var all_classes="temp disabled __apc_marked_class";
		if (multivalues){
			all_classes="temp disabled _multivalues __apc_marked_class";
		}
		
		$(p).addClass('apcomplete');
		$(p).append("<input type='text' name='"+AP.uuid()+"' id='"+id+"' class=' "+all_classes+"' value='"+$(selector).val()+"'/>");
		
		if ($(selector).attr("title")){
			$('.temp',p).data("htext",$(selector).attr("title"));
			if (!$('.temp',p).val()){
				$('.temp',p).val($('.temp',p).data("htext")).addClass("__blur");
			}
			
			$('.temp',p).blur(function(){
				if (!$('.temp',p).val() || $('.temp',p).val()=="" || $('.temp',p).val()==$('.temp',p).data("htext")){
					$('.temp',p).val($('.temp',p).data("htext")).addClass("__blur");
				}
			}).focus(function(){
				if ($('.temp',p).val()==$('.temp',p).data("htext")){
					$('.temp',p).val("");
				}
				$('.temp',p).removeClass("__blur");
			});
			
			var val=$(selector).val();
			if (val=="" || val==$(selector).attr("title")){
				$(selector).val("");
			}
			
			$('.temp',p).blur();
		}else if ($(selector).data("htext")){
			$('.temp',p).data("htext",$(selector).data("htext"));
			if (!$('.temp',p).val()){
				$('.temp',p).val($('.temp',p).data("htext")).addClass("__blur");
			}
			
			$('.temp',p).blur(function(){
				if (!$('.temp',p).val() || $('.temp',p).val()==""){
					$('.temp',p).val($('.temp',p).data("htext")).addClass("__blur");
				}
			}).focus(function(){
				if ($('.temp',p).val()==$('.temp',p).data("htext")){
					$('.temp',p).val("");
				}
				$('.temp',p).removeClass("__blur");
			});
			$('.temp',p).blur();
		}
		
		$(selector).hide().addClass('marked');
		
		if ($(selector).data('label') && $(selector).data('label').length){
			$('.temp',p).val($(selector).data('label'));
		}
		
		// Add focus when click on parent.
		$(p).click(function(){
			if (!$("#"+id).is(":focus")){
				$("#"+id).focus();
			}
		});
		
		var ph=$(selector).attr('placeholder');
		if (ph && ph.length){
			$("#"+id).attr('placeholder', ph);
		}
		
		return id;
	}else{
		return $("input.temp", p).attr("id");
	}
};




/**
 * @desc FOR AUTO COMPLETE
 */
function ap_split( val ) {
	return val.split( /,\s*/ );
};

function ap_extractLast(term){
	return ap_split(term).pop();
};


function ap_extractCurrentString(obj){
	var term=$(obj).val();
	
	if (!term || term.length<2){
		return null;
	}
	var pos=plugin_get_caret_position(obj)-1;
	if (pos <0 || pos>term.length){
		return null;
	}
	var start=pos, end=pos;
	if (term.charAt(start)==','){
		start--;
		if (start<0){
			return null;
		}
	}
	
	while (start>=0){
		if (term.charAt(start)==','){
			start++;
			break;
		}
		start--;
		if (start==0){
			break;
		}
	}
	
	while (end<term.length){
		if (term.charAt(end)==','){
			break;
		}
		end++;
		if (end>=term.length){
			break;
		}
	}

	if (end-start<1){
		return;
	}
	
	var r=$.trim(term.substring(start, end));
	if (!r.length || r.length<1){
		return null;
	}
	return r;
};



function ap_extractInsertString(obj, insert){
	var term=$(obj).val();
	
	if (!term || term.length<1){
		return null;
	}
	var pos=plugin_get_caret_position(obj)-1;
	if (pos <0 || pos>term.length){
		return null;
	}
	var start=pos, end=pos;
	if (term.charAt(start)==','){
		start--;
		if (start<0){
			return null;
		}
	}
	
	while (start>=0){
		if (term.charAt(start)==','){
			start++;
			break;
		}
		start--;
		if (start==0){
			break;
		}
	}
	
	while (end<term.length){
		if (term.charAt(end)==','){
			break;
		}
		end++;
		if (end>=term.length){
			break;
		}
	}

	if (end-start<1){
		return;
	}
	
	var s_end="";
	if (end+1<term.length){
		term.substring(end+1)
	}
	
	var r=$.trim(term.substring(0, start)+' '+insert+', '+s_end);
	return r;
};


/**
 * @desc FOR DATE/TIME
 */
function ap_getTimeOptions(){ 
	var hours=["00","01","02","03","04","05","06","07","08","09","10","11","12","13","14","15","16","17","18","19","20","21","22","23"];
	var mins=["00","15","30","45"];
	var a=[];
	for (var i=0; i<hours.length; i++){
		for (var j=0; j<mins.length; j++){
			a.push(hours[i]+":"+mins[j]);
		}
	}
	return a;
};


















'use strict';

var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };

function Sektor(selector, options) {
  this.element = $(selector)[0];

  var defaultOptions = {
	size: 100,
	stroke: 10,
	arc: false,
	angle: 225,
	sectorColor: '#789',
	circleColor: '#DDD',
	fillCircle: true
  };

  // Merge options with default ones
  options = _extends(defaultOptions, options);

  // Reset stroke to 0 if drawing full sector
  options.stroke = options.arc ? options.stroke : 0;

  // Circle dimenstions
  options.center = options.size / 2;
  options.radius = options.stroke ? options.center - options.stroke / 2 : options.center;

  this.options = options;

  this.checkAngle();

  var svg = '<svg class=\'Sektor\' viewBox=\'0 0 ' + options.size + ' ' + options.size + '\'>\n	  ' + this.getCircle() + '\n	  ' + this.getSector() + '\n	</svg>';

  this.element.innerHTML = svg;
  this.sector = this.element.querySelector('.Sektor-sector');
}

Sektor.prototype.checkAngle = function () {
  if (this.options.angle > 360) {
	this.options.angle = this.options.angle % 360;
  }
};

Sektor.prototype.changeAngle = function (angle) {
  this.options.angle = angle;
  this.checkAngle();
  this.sector.setAttribute('d', this.getSector(true));
};

Sektor.prototype.step = function (angleOffset, endAngle, time, endTime) {
  var _this = this;

  var now = new Date().valueOf();
  var timeOffset = endTime - now;

  if (timeOffset <= 0) {
	this.changeAngle(endAngle);
  } else {
	var angle = endAngle - angleOffset * timeOffset / time;

	this.changeAngle(angle);
	requestAnimationFrame(function () {
	  return _this.step(angleOffset, endAngle, time, endTime);
	});
  }
};

Sektor.prototype.animateTo = function (angle) {
  var _this2 = this;

  var time = arguments.length <= 1 || arguments[1] === undefined ? 300 : arguments[1];

  if (angle > 360) {
	angle = angle % 360;
  }

  var startTime = new Date().valueOf();
  var endTime = startTime + time;
  var angleOffset = angle - this.options.angle;

  requestAnimationFrame(function () {
	return _this2.step(angleOffset, angle, time, endTime);
  });
};

Sektor.prototype.getSector = function () {
  var returnD = arguments.length <= 0 || arguments[0] === undefined ? false : arguments[0];

  var options = this.options;

  // Colors
  var sectorFill = options.arc ? 'none' : options.sectorColor;
  var sectorStroke = options.arc ? options.sectorColor : 'none';

  // Arc angles
  var firstAngle = options.angle > 180 ? 90 : options.angle - 90;
  var secondAngle = -270 + options.angle - 180;

  // Arcs
  var firstArc = this.getArc(firstAngle, options);
  var secondArc = options.angle > 180 ? this.getArc(secondAngle, options) : '';

  // start -> starting line
  // end -> will path be closed or not
  var end = '';
  var start = null;

  if (options.arc) {
	start = 'M' + options.center + ',' + options.stroke / 2;
  } else {
	start = 'M' + options.center + ',' + options.center + ' L' + options.center + ',' + options.stroke / 2;
	end = 'z';
  }

  var d = start + ' ' + firstArc + ' ' + secondArc + ' ' + end;

  if (returnD) {
	return d;
  }

  return '<path\n	class=\'Sektor-sector\'\n	stroke-width=\'' + options.stroke + '\'\n	fill=' + sectorFill + '\n	stroke=' + sectorStroke + '\n	d=\'' + d + '\' />';
};

Sektor.prototype.getCircle = function () {
  var options = this.options;
  var circleFill = options.fillCircle || !options.arc ? options.circleColor : 'none';

  return '<circle\n	  class=\'Sektor-circle\'\n	  stroke-width=\'' + options.stroke + '\'\n	  fill=' + circleFill + '\n	  stroke=' + options.circleColor + '\n	  cx=\'' + options.center + '\'\n	  cy=\'' + options.center + '\'\n	  r=\'' + options.radius + '\' />';
};

// Generates SVG arc string
Sektor.prototype.getArc = function (angle) {
  var options = this.options;

  var x = options.center + options.radius * Math.cos(this.radians(angle));
  var y = options.center + options.radius * Math.sin(this.radians(angle));

  return 'A' + options.radius + ',' + options.radius + ' 1 0 1 ' + x + ',' + y;
};

// Converts from degrees to radians.
Sektor.prototype.radians = function (degrees) {
  return degrees / 180 * Math.PI;
};


AP.scrollBar=function __APScrollBar(selector){
	return new APScrollBar($(selector));
};


function APScrollBar($obj){
	this.$obj=$obj;
	
	this.init=function(temp){
		temp=false;
		if (temp){
			temp=true;
		}
		
		
		if (AP.sys.isTablet() || AP.sys.isMobile() || AP.__printing || Client.mobile){
			$obj.addClass("__mscroll");
			return this;
		}
		
		
		if (this.$obj.hasClass('__apscrollbar_target')){
			plugin_scrollbar_onscroll(this.$obj);
			return this;
		}
		
		var id=this.$obj.attr('id');
		if (!id){
			id=AP.uuid();
			this.$obj.attr('id', id);
		}
		
		this.$obj.addClass('__apscrollbar_target');
		if (this.$obj.parent().data('autoscroll')){
			this.$obj.addClass('__scrolled');
		}
		
		
		if (this.$obj.parent().hasClass('__apscrollbar_parent')){
			return this;
		}
		
		this.$obj.parent().addClass('__apscrollbar_parent');
		
		
		if (this.$obj.parent().data("autohide")){
			this.$obj.parent().addClass("__autohide");
			this.$obj.wrapInner("<div class='__apscrollbar_wrap __autohide'></div>");
		}else{
			this.$obj.wrapInner("<div class='__apscrollbar_wrap'></div>");	
		}
		
		$("<div id='"+id+"__apscrollbar' class='__apscrollbar'> <div class='scroller'>" +
					"<div class='sinner'></div> "+
				"</div> </div>").appendTo(this.$obj.parent());

		
		$("#"+id+"__apscrollbar .scroller").draggable({
			axis:"y",
			start: function(){
				$("#"+id).addClass('__scrollprevented');
			},
			drag: function(){
				plugin_scrollbar_update($(this));
			},
			stop: function(){
				plugin_scrollbar_update($(this));
				$("#"+id).removeClass('__scrollprevented');
			},
			containment: "parent"
		});
		
		
		this.$obj.on("scroll", function(){
			if ($(this).hasClass('__scrollprevented')){
				// $(this).removeClass('__scrollprevented')
				return;
			}

			return plugin_scrollbar_onscroll($(this));			
		});
		
		plugin_scrollbar_update($('#'+id+'__apscrollbar .scroller'));
		
		setTimeout(function(){
			plugin_scrollbar_update($('#'+id+'__apscrollbar .scroller'));
		},1000);
		
		setTimeout(function(){
			plugin_scrollbar_update($('#'+id+'__apscrollbar .scroller'));
		},5000);
		
		return this;
	};
	
	
	/**
	 * @desc ScrollTo a specific pixel height
	 */
	this.scrollTo=function(num){
		// var h=this.$obj.height();
		// var maxh=this.$target[0].scrollHeight;
		
		this.$obj.scrollTop(num);
	};
	
	
	this.update=function(){
		if (AP.sys.isTablet() || AP.sys.isMobile() || AP.__printing || Client.mobile){
			return this;
		}
		
		plugin_scrollbar_update($("#"+this.$obj.attr('id')+"__apscrollbar .scroller"));
		return this;
	};
};


/**
 * @desc Update 
 * @param obj
 */
function plugin_scrollbar_update($obj){
	var offset=$obj.position();
	
	var $scroller=$obj.parent();	
	var $scroller_rec=$obj;
	
	var $target=$scroller.prevAll('.__apscrollbar_target');
	if (!$target || !$target.length){
		return;
	}
	
	var h=$target.height();
	var maxh=$target[0].scrollHeight;
	
	var auto=$obj.closest('.__apscrollbar_parent').data('autoscroll');
	
	
	if (maxh<=h){
		if (!auto){
			$scroller.hide();
			$target.scrollTop(0);
			$target.scrollLeft(0);
			$target.removeClass('__scrolled');
			$scroller.hide();
			return;	
		}else{
			$scroller_rec.hide();
			$target.addClass('__scrolled');
			return;
		}
	}
	
	$scroller.show();
	$scroller_rec.show();
	
	if (maxh<10 || h<10){
		/**
		 * @todo Finish this weird case 
		 */
		return;
	}
	
	var sh=$scroller.height();
	
	if (sh<=$obj.height()){
		$target.scrollTop(maxh-h);
		return;
	}
	
	var scale=$scroller.parent().data("scale");
	if (!scale){
		scale=1.0;
	}else{
		scale=parseFloat(scale);
	}
	
	scale=1.0;
	
	var ttop=(maxh-h)*offset.top*1.0/(sh-$obj.height());
	ttop=Math.floor(ttop);
	
	$target.scrollTop(ttop);
	$target.scrollLeft(0);
};



function plugin_scrollbar_onscroll($obj){
	var alwayshown=$obj.parent().data('autoscroll');
	var autohide=$obj.parent().data('autohide');
	
	if (!$obj.is(':visible')){
		return;
	}
	
	// $obj.scrollLeft(0);
	// return;
	
	var t=$obj.scrollTop();
	var h=$obj.height();
	
	if (!('scrollHeight' in $obj[0])){
		return;
	}
	
	
	
	var maxh=$obj[0].scrollHeight;
	var $scroller=$("#"+$obj.attr('id')+"__apscrollbar");
	
	if (maxh<h || maxh<10){
		if (!alwayshown){
			$obj.removeClass('__scrolled');
			$scroller.hide();	
		}
		return;
	}
	
	
	if (maxh==h){
		if (!alwayshown){
			$obj.removeClass('__scrolled');
			$scroller.hide();	
		}
		return;
	}
	
	
	if (!$obj.hasClass('__scrolled')){
		$obj.addClass('__scrolled');
	}
	
	
	$scroller.show();
	
	if (h<0){
		return;
	}
	
	
	
	var sh=$scroller.height();
	var scale=$scroller.parent().data("scale");
	
	if (!scale || typeof scale=="undefined"){
		scale=1.0;
	}else{
		scale=parseFloat(scale);
	}
	
	var scroller={}; 
	scroller.height=Math.floor((h*1.0/maxh)*(h*1.0/maxh) *sh)*scale;
	if (autohide){
		scroller.height=Math.floor((h*1.0/maxh)*sh)*scale;
	}
	
	if (scroller.height<50){
		scroller.height=50;
	}
	
	scroller.top=Math.floor(Math.min(t*1.0/(maxh-h), 1) * (sh-scroller.height));

	
	$scroller.children('.scroller').css({'top': scroller.top, 'height': scroller.height}).addClass('active').show();
	$scroller.find('.sinner').css('height',scroller.height-1);
};


AP.pageConfig=new function __APPageConfig(){
	this.data={};
	this.__data={};
	
	this.init=function(data){
		this.__data=shallowClone(data);
		this.data=data;
	};
	
	this.reset=function(){
		this.data=shallowClone(this.__data);
		if (!this.data){
			this.data={};
		}
	};
	
	this.set=function(key, val){
		if (typeof val=="undefined"){
			val=1;
		}
		
		this.data[key]=val;
	};
	
	this.get=function(key){
		if (key in this.data){
			return this.data[key];
		}
		
		return null;
	};
	
	
	this.test=function(){
		$.log(this.data);
		$.log(this.__data);
	}
};


/**
 * @desc Viewer Base Object
 */
var APViewer = new function _APViewer(){
	this.auth=function(){
		if (Client.viewer && Client.viewer.id && Client.viewer.id>0){
			return true;
		}
		return false;
	};
};
var MarkDown=new function __MarkDown(){
	this.render=function(element, options){
		options=$.extend({}, {math: false, code: true, toc: false, footnote: true}, options);
		$canvas=$(element);
		$canvas.addClass("md-display");
		
		if (options.math){
			$canvas.find(".md-imath").each(function(){
				katex.render($(this).text(), $(this)[0]);
			});
			
			$canvas.find(".md-math").each(function(){
				katex.render($(this).text(), $(this)[0], {displayMode: true});
			});
		}
		
		if (options.code){
			$canvas.find(".md-code").each(function(){
				$(this).showCode();
			});
			
			$canvas.find(".md-rawcode").each(function(){
				$(this).wrapInner("<pre class='md-raw'></pre>");
			});
			
			if (options.code && AP.data.isString(options.code)){
				$canvas.find(options.code).each(function(){
					$(this).addClass("md-code __codehl").showCode();
				});
			}
		}
		
		
		$canvas.find(".md-note-icon").each(function(){
			var h=parseInt($(this).height());
			var w=parseInt($(this).width());
			$(this).css("margin-top", -h/2);
			$(this).prev().css("margin-left", w+h/2);
		});
		
		$canvas.children().each(function(){
			$(this).addClass("md-line");
		})
		
		// Internal and footnote link
		$canvas.find(".md-doc-link, .md-fn-link").each(function(){
			var label=$(this).data("ref");
			
			if ($(this).hasClass("md-doc-link")){
				$(this).prepend("<span class='-ap icon-forward2'></span> ");
			}
			
			$(this).click(function(){
				var $box=$("#label-"+label);
				if (!$box.length){
					return;
				}
				
				var $p=$box.closest('.scrollin');
				var h=$box.closest(".md-line").position().top;
				var offset=$p.scrollTop();
				
				$p.animate({scrollTop: offset+h-20}, 300, function(){
					$box.animate({backgroundColor: "#FFFEDB"}, 1000).animate({backgroundColor: 'transparent'}, 1000);
				});
			});
		});
		
		
		
		// Table of content
		if (options.toc){
			
		}
	};
	
	
	this.textarea=function(){
		
	};
	
	
};


(function($){
	$.fn.markdownEditor=function(lh){
		if (!lh){
			 lh=22;
		}
		
		$(this).disableTab();
		$(this).css("line-height",lh+"px").css("overflow-y", "hidden");
		
		
		$(this).data("minh", $(this)[0].scrollHeight).on("keyup, keypress", function(e){
			var $this=$(this);
			var minh=$this.data("minh");
			
			$this.height(Math.max($this[0].scrollHeight, minh));
			
//			var minh=$this.data("minh");
//			var outerHeight = parseInt(window.getComputedStyle($this[0]).height, 10);
//			var diff = outerHeight - $this[0].clientHeight;
//			$this.height(0).height(Math.max(minh, $this[0].scrollHeight+diff));
			
//			var $this=$(this);
//			$this.height(0).height($this[0].scrollHeight);
		}).keypress();
		
		// Remove tab characters
		 var content=$(this).val();
		 if (content){
			 content=content.replace(/\t/g, '	');
			 $(this).val(content);
		}
	};
	
	
	$.fn.materialForm=function(){
		$(this).find("input, textarea").each(function(){
			$(this).on("focus",function(){
				$(this).parent().parent().addClass("active");
			}).on("blur", function(){
				var val=$.trim($(this).val());
				if (val){
					$(this).parent().parent().addClass("active");
				}else{
					$(this).parent().parent().removeClass("active");
				}
			}).blur();
		});
	};
	
	
})(jQuery);/* Javascript Syntax Highlighter
 * Highlights many different programming languages
 * Outputs valid XHTML, so can be used in XHTML pages!
 * Written by: Michiel van Eerd
 */
 
 /* IE doesn't understand indexOf() on arrays, so add it */
if (!Array.prototype.indexOf) {
		Array.prototype.indexOf = function(val) {
				var len = this.length;
				for (var i = 0; i < len; i++) {
						if (this[i] == val) return i;
				}
				return -1;
		};
};

var SyntaxHighlighter = {};

SyntaxHighlighter.language = {};

SyntaxHighlighter.xmlEntities = {
		"&" : "&amp;",
		"<" : "&lt;",
		">" : "&gt;",
		"\"" : "&quot;",
		"'" : "&#39;"
	};

SyntaxHighlighter.strToXHTML = function(str)
{
	var addLen = 0;
	
	for (var key in SyntaxHighlighter.xmlEntities)
	{
		str = str.replace(new RegExp(key, "g"),
			function(match, offset, s)
			{
				addLen += (SyntaxHighlighter.xmlEntities[key].length - 1);
				return SyntaxHighlighter.xmlEntities[key];
			}
		);
	}
	return {
		"str" : str,
		"addLen" : addLen
	};
};

SyntaxHighlighter.copyObject = function(ob){
	var newOb = {};
	for (var prop in ob) {
		newOb[prop] = ob[prop];
	}
	return newOb;
};

SyntaxHighlighter.highlightDocument = function(selector, showLineNumbers){
	var codeList = $(selector).get();
	for (var i = 0, len = codeList.length; i < len; i++){
		if (codeList[i].className && SyntaxHighlighter.language[codeList[i].className]){
			SyntaxHighlighter.highlight(codeList[i], showLineNumbers);
		}
	}
};

SyntaxHighlighter.highlight = function(codeEl, showLineNumbers){
	if (!codeEl){
		return;
	}
	var lang = SyntaxHighlighter.language[codeEl.className];
	if (!lang){
		return;
	}

	var span_comment_len = "<span class='comment'></span>".length;
	var span_quote_len = "<span class='quote'></span>".length;
	var span_operator_len = "<span class='operator'></span>".length;
	var span_keyword_len = "<span class='keyword'></span>".length;
	
	// Met \n of \r\n als regelbreak
	// data rewrites HTML entities to real characters
	codeEl.normalize();
	
	var lines = [];
	
	// Als er na de normalize nog meerder childNodes zijn, dan ga ik ervan uit dat men als linebreak <br> heeft
	// en NIET \n of \r.
	if (codeEl.childNodes.length > 1){
		// Met BR als regelbreak
		// Je mag alleen een lege lijn toevoegen bij de 2e keer achter elkaar geen data (dus <br><br> in de code).
		var hasBr = false;
		for (var i = 0; i < codeEl.childNodes.length; i++)
		{		
			if (!codeEl.childNodes[i].data)
			{
				if (hasBr)
				{
					lines.push("");
					hasBr = false;
				}
				else
				{
					hasBr = true;
				}
			}
			else
			{
				lines.push(codeEl.childNodes[i].data);
				hasBr = false;
			}
		}
	}
	else{
		// Er worden blijkbaar \n en \r als linebreak gebruikt.
		if (codeEl.firstChild){
			var str = codeEl.firstChild.data;
			lines = (str.indexOf("\n") != -1) ? str.split("\n") : str.split("\r");	
		}
	}
	
	var beginMultiCommentIndex = -1;
	
	forLineLoop:
	for (var lineIndex = 0, lineCount = lines.length; lineIndex < lineCount; lineIndex++)
	{
		var line = lines[lineIndex];
		var prop = {};
		
		forCharLoop:
		for (var charIndex = 0, lineLen = line.length; charIndex < lineLen; charIndex++)
		{
			var c = line.charAt(charIndex);
			
			// End multiline comment
			if (beginMultiCommentIndex != -1)
			{
				var endMultiCommentIndex = -1;
				for (; charIndex < lineLen; charIndex++)
				{
					c = line.charAt(charIndex);
					if (c == "\\")
					{
						charIndex++;
						continue;
					}
					if (c == lang.comment.multi.end.charAt(0))
					{
						endMultiCommentIndex = charIndex;
						for (var i = 0; i < lang.comment.multi.end.length; i++)
						{
							if (line.charAt(charIndex + i) != lang.comment.multi.end.charAt(i))
							{
								endMultiCommentIndex = -1;
								break;
							}
						}
						if (endMultiCommentIndex != -1)
						{
							charIndex += (lang.comment.multi.end.length - 1);
							endMultiCommentIndex = charIndex;
							break;
						}
					}
				}
				var realEndIndex = (endMultiCommentIndex != -1) ? endMultiCommentIndex : lineLen - 1;
				//var addLen = "<span class='comment'></span>".length;
				var substrOb = SyntaxHighlighter.strToXHTML(line.substr(beginMultiCommentIndex, realEndIndex - beginMultiCommentIndex + 1));
				line = line.substr(0, beginMultiCommentIndex) + "<span class='comment'>" + substrOb.str + "</span>" + line.substr(realEndIndex + 1);
				charIndex += (span_comment_len + substrOb.addLen);
				lineLen += (span_comment_len + substrOb.addLen);
				prop[beginMultiCommentIndex] = span_comment_len + substrOb.str.length;
				beginMultiCommentIndex = (endMultiCommentIndex != -1) ? -1 : 0;
				continue forCharLoop;
			}
			
			// Begin multiline comment
			if (lang.comment.multi && c == lang.comment.multi.start.charAt(0))
			{
				beginMultiCommentIndex = charIndex;
				for (var i = 0; i < lang.comment.multi.start.length; i++)
				{
					if (line.charAt(charIndex + i) != lang.comment.multi.start.charAt(i))
					{
						beginMultiCommentIndex = -1;
						break;
					}
				}
				if (beginMultiCommentIndex != -1)
				{
					charIndex += lang.comment.multi.start.length - 1;
					if (charIndex == lineLen - 1)
					{
						charIndex--;
					}
					continue forCharLoop;
				}
			}
			
			// Single comment
			if (lang.comment.single && c == lang.comment.single.start.charAt(0))
			{
				var beginSingleCommentIndex = charIndex;
				// Eventueel het begin van een single comment
				for (var i = 0; i < lang.comment.single.start.length; i++)
				{
					if (line.charAt(charIndex + i) != lang.comment.single.start.charAt(i))
					{
						beginSingleCommentIndex = -1;
						break;
					}
				}
				if (beginSingleCommentIndex != -1)
				{
					// Alles totaan einde van de regel is comment
					var substrOb = SyntaxHighlighter.strToXHTML(line.substr(beginSingleCommentIndex));
					//var addLen = "<span class='comment'></span>".length;
					line = line.substr(0, beginSingleCommentIndex) + "<span class='comment'>" + substrOb.str + "</span>";
					charIndex = line.length - 1;
					prop[beginSingleCommentIndex] = span_comment_len + substrOb.str.length;
					continue forCharLoop;
				}
			}
			
			// Quotes
			if (c == "\"" || c == "'")
			{
				var quote = c;
				var beginQuoteIndex = charIndex;
				// Hier doorgaan naar einde quote
				for (charIndex += 1; charIndex < lineLen; charIndex++)
				{
					c = line.charAt(charIndex);
					if (c == "\\")
					{
						charIndex++;
						continue;
					}
					if (c == quote)
					{
						// Einde
						var substrOb = SyntaxHighlighter.strToXHTML(line.substr(beginQuoteIndex, charIndex - beginQuoteIndex + 1));
						//var addLen = "<span class='quote'></span>".length;
						line = line.substr(0, beginQuoteIndex) + "<span class='quote'>" + substrOb.str + "</span>" + line.substr(charIndex + 1);
						prop[beginQuoteIndex] = span_quote_len + substrOb.str.length;
						charIndex += (span_quote_len + substrOb.addLen);
						lineLen += (span_quote_len + substrOb.addLen);
						continue forCharLoop;
					}
				}
			}
			
			// Operators
			if (lang.operator.indexOf(c) != -1)
			{
				c = (SyntaxHighlighter.xmlEntities[c]) ? SyntaxHighlighter.xmlEntities[c] : c;
				//var addLen = "<span class='operator'></span>".length + (c.length - 1);
				var addLen = span_operator_len + (c.length - 1);
				line = line.substr(0, charIndex) + "<span class='operator'>" + c + "</span>" + line.substr(charIndex + 1);
				prop[charIndex] = addLen + c.length;
				charIndex += addLen;
				lineLen += addLen;
				continue forCharLoop;
			}
		}
		
		// Keywords - not for each char, but each line
		for (var i = 0; i < lang.keyword.length; i++)
		{
			var keyword = lang.keyword[i];
			var keywordIndex = line.indexOf(keyword);
			while (keywordIndex != -1)
			{
				if (/\w/.test(line.charAt(keywordIndex - 1)) || /\w/.test(line.charAt(keywordIndex + keyword.length))) {
					keywordIndex = line.indexOf(keyword, keywordIndex + 1);
					continue;
				}
				
				var isKeyword = true;
				for (var key in prop) {
					if (keywordIndex >= parseInt(key) && keywordIndex < (parseInt(key) + parseInt(prop[key]))) {
						isKeyword = false;
						break;
					}
				}
				if (isKeyword) {
					//var addString = "<span class='keyword'></span>";
					//var addLen = addString.length; // dit is erbij gekomen
					//var addLen = span_keyword_len;
					line = line.substr(0, keywordIndex) + "<span class='keyword'>" + keyword + "</span>" + line.substr(keywordIndex + keyword.length);
					prop[keywordIndex] = keyword.length + span_keyword_len;
					var tmpOb = new Object();
					for (var key in prop) {
						if (parseInt(key) > keywordIndex) {
							var newIndex = parseInt(key) + span_keyword_len;
							tmpOb[newIndex] = prop[key];
						} else {
							tmpOb[key] = prop[key];
						}
					}
					prop = SyntaxHighlighter.copyObject(tmpOb);
					keywordIndex = line.indexOf(keyword, keywordIndex + span_keyword_len + keyword.length);
				} else {
					keywordIndex = line.indexOf(keyword, keywordIndex + 1);
				}
				
			}
		}
		
		//line.prop = prop;
		lines[lineIndex] = line;
	}
	
	// Print the lines
	var joinString = "";
	var showLineNumbersThisTime = showLineNumbers;
	var newLines = null;
	
	if (codeEl.parentNode.nodeName.toLowerCase() != "pre")
	{
		showLineNumbersThisTime = false;
	}
	
	if (showLineNumbersThisTime)
	{
		newLines = ["<ol>"];
		for (var i = 0; i < lineCount; i++) {
			newLines.push("<li><span>" + lines[i] + "</span></li>");
		}
		newLines.push("</ol>");
	}
	else
	{
		newLines = lines;
		if (codeEl.parentNode.nodeName.toLowerCase() == "pre")
		{
			joinString = "<br />";
		}
	}
	
	// appname check is necessary, because chrome knows also outerHTML!
	
	if (codeEl.parentNode.nodeName.toLowerCase() == "pre" && navigator.appName == "Microsoft Internet Explorer") {
		codeEl.parentNode.outerHTML = "<pre><code class='" + codeEl.className + "'>" + newLines.join(joinString) + "</code></pre>";
	} else {
		codeEl.innerHTML = newLines.join(joinString);
	}
	
	codeEl.className = codeEl.className + " highlighted";
};


SyntaxHighlighter.language.c = {
	"comment" : {
		"single" : {
			"start" : "//"
		},
		"multi" : {
			"start" : "/*",
			"end" : "*/"
		}
	},
	"keyword" : [
		"auto", "break", "case", "char", "const", "continue", "default", "do", "double", "else", "enum", "extern", "float", "for", "goto", "if", "int", "long", "register", "return", "short", "signed", "sizeof", "static", "struct", "switch", "typedef", "union", "unsigned", "void", "volatile", "wchar_t", "while"
	],
	"operator" : [
		"=", "(", ")", "{", "}", "*", "+", "-", "<", ">", "&", "|", "!", "?", "^", "/", ":", "~", "%", "[", "]"
	]
};


SyntaxHighlighter.language.csharp = {
	"comment" : {
		"single" : {
			"start" : "//"
		},
		"multi" : {
			"start" : "/*",
			"end" : "*/"
		}
	},
	"keyword" : [
		"#if", "#else", "#endif", "abstract", "as", "base", "bool", "break", "byte", "case", "catch", "char", "checked", "class", "const", "continue", "decimal", "default", "delegate", "do", "double", "else", "enum", "event", "explicit", "extern", "false", "finally", "fixed", "float", "for", "foreach", "goto", "get", "if", "implicit", "in", "int", "interface", "internal", "is", "locak", "long", "namespace", "new", "null", "object", "operator", "out", "override", "params", "partial", "private", "protected", "public", "readonly", "ref", "return", "sbyte", "sealed", "set", "short", "sizeof", "stackalloc", "static", "string", "struct", "switch", "this", "throw", "true", "try", "typeof", "uint", "ulong", "unchecked", "unsafe", "ushort", "using", "value", "virtual", "volatile", "void", "where", "while", "yield"
	],
	"operator" : [
		".", ",", "=", "(", ")", "{", "}", ";", "+", "-", "<", ">", "&", "|", "!", "?", "[", "]", "/", "%", "^", ":", "~"
	]
};


SyntaxHighlighter.language.js = {
	"comment" : {
		"single" : {
			"start" : "//"
		},
		"multi" : {
			"start" : "/*",
			"end" : "*/"
		}
	},
	"keyword" : [
		"arguments", "Array", "Boolean", "break", "case", "catch", "continue", "Date", "do", "each", "else", "Error", "false", "for", "Function", "function", "if", "Infinity", "Math", "NaN", "new", "null", "Number", "Object", "RegExp", "return", "String", "switch", "this", "throw", "true", "try", "undefined", "var", "while"
	],
	"operator" : [
		"=", "(", ")", "{", "}", "+", "-", "!", "?", "<", ">", ";", ".", "[", "]", "&"
	]
};


SyntaxHighlighter.language.sql = {
	"comment" : {
		"multi" : {
			"start" : "<!--",
			"end" : "-->"
		}
	},
	"keyword" : [
		"add", "alter", "and", "as", "column", "create", "database", "delete", "describe", "distinct", "do", "drop", "explain", "from", "group by", "handler", "index", "insert", "into", "left join", "limit", "on", "optimize", "order by", "rename", "replace", "select", "set", "show", "table", "update", "use", "where"
	],
	"operator" : [
		"<", ">", "=", "(", ")", "*", ";", "!", ","
	]
};

SyntaxHighlighter.language.php = {
	"comment" : {
		"single" : {
			"start" : "//"
		},
		"multi" : {
			"start" : "/*",
			"end" : "*/"
		}
	},
	"keyword" : [
		"abstract", "array", "as", "bool", "boolean", "break", "case", "catch", "class", "clone", "const", "continue", "declare", "default", "define", "do", "echo", "else", "elseif", "empty", "exit", "extends", "final", "for", "foreach", "function", "if", "implements", "include", "include_once", "int", "interface", "isset", "list", "new", "null", "object", "print", "private", "protected", "public", "php","require", "require_once", "return", "static", "string", "switch", "throw", "try", "unset", "while"
	],
	"operator" : [
		"=", "(", ")", "{", "}", "+", "-", "!", "?", "<", ">", "&", ";", ".", "[", "]", "%"
	]
};


SyntaxHighlighter.language.python = {
	"comment" : {
		"single" : {
			"start" : "#"
		},
		"multi" : {
			"start" : "\"\"\"",
			"end" : "\"\"\""
		}
	},
	"keyword" : [
		"and", "as", "assert", "break", "class", "continue", "def", "del", "elif", "else", "except", "exec", "False", "finally", "for", "from", "global", "if", "import", "in", "is", "lambda", "None", "not", "or", "pass", "print", "raise", "return", "True", "try", "while", "with", "yield"
	],
	"operator" : [
		"=", "(", ")", "{", "}", ":", "+", "-", "!", "<", ">", ";", ".", "%", "/", "[", "]", "|", "^", "~", "&", "@", "*"
	]
};


SyntaxHighlighter.language.vb = {
	"comment" : {
		"single" : {
			"start" : "'"
		}
	},
	"keyword" : [
		"AddHandler", "AddressOf", "Alias", "And", "AndAlso", "As", "Boolean", "ByRef", "Byte", "ByVal", "Call", "Case", "Catch", "CBool", "CByte", "CChar", "CDate", "CDec", "CDbl", "Char", "CInt", "Class", "CLng", "CObj", "Const", "Continue", "CSByte", "CShort", "CSng", "CStr", "CType", "CUInt", "CULong", "CUShort", "Date", "Decimal", "Declare", "Default", "Delegate", "Dim", "DirectCast", "Do", "Double", "Each", "Else", "ElseIf", "End", "Enum", "Erase", "Error", "Event", "Exit", "False", "Finally", "For", "Friend", "Function", "Get", "GetType", "Global", "GoTo", "Handles", "If", "Implements", "Imports", "In", "Inherits", "Integer", "Interface", "Is", "IsNot", "Lib", "Like", "Long", "Loop", "Me", "Mod", "Module", "MustInherit", "MustOverride", "MyBase", "MyClass", "Namespace", "Narrowing", "New", "Next", "Not", "Nothing", "NotInheritable", "NotOverridable", "Object", "Of", "On", "Operator", "Option", "Optional", "Or", "OrElse", "Overloads", "Overridable", "Overrides", "ParamArray", "Partial", "Private", "Property", "Protected", "Public", "RaiseEvent", "ReadOnly", "ReDim", "REM", "RemoveHandler", "Resume", "Return", "SByte", "Select", "Set", "Shadows", "Shared", "Short", "Single", "Static", "Step", "Stop", "String", "Structure", "Sub", "SyncLock", "Then", "Throw", "To", "True", "Try", "TryCast", "TypeOf", "UInteger", "ULong", "Until", "UShort", "Using", "When", "While", "Widening", "With", "WithEvents", "WriteOnly", "Xor"
	],
	"operator" : [
		"=", "(", ")", "+", "-", "<", ">", "&", "/", "^"
	]
};


SyntaxHighlighter.language.win32 = {
	"comment" : {
		"single" : {
			"start" : "//"
		},
		"multi" : {
			"start" : "/*",
			"end" : "*/"
		}
	},
	"keyword" : [
		"ATOM", "auto", "BOOL", "BOOLEAN", "break", "BYTE", "CALLBACK", "case", "char", "CHAR", "COLORREF", "const", "CONST", "continue", "default", "do", "double", "DWORD", "else", "enum", "extern", "float", "FLOAT", "for", "goto", "HANDLE", "HBITMAP", "HBRUSH", "HCOLORSPACE", "HCURSOR", "HDC", "HFILE", "HFONT", "HICON", "HINSTANCE", "HMENU", "HMODULE", "HPEN", "HRESULT", "HWND", "if", "int", "INT", "INT_PTR", "INT32", "INT64", "long", "LONG", "LONGLONG", "LONG_PTR", "LONG32", "LONG64", "LPARAM", "LPBOOL", "LPBYTE", "LPCSTR", "LPCTSTR", "LPCVOID", "LPCWSTR", "LPDWORD", "LPHANDLE", "LPINT", "LPLONG", "LPSTR", "LPTSTR", "LPVOID", "LPWORD", "LPWSTR", "LRESULT", "PBOOL", "PBOOLEAN", "PBYTE", "PCHAR", "PCSTR", "PCTSTR", "PCWSTR", "PDWORD", "PFLOAT", "PHANDLE", "PINT", "register", "return", "short", "SHORT", "signed", "sizeof", "static", "struct", "switch", "TCHAR", "typedef", "UCHAR", "UINT", "UINT32", "ULONG", "UNICODE_STRING", "union", "unsigned", "USHORT", "void", "VOID", "volatile", "WCHAR", "while", "WINAPI", "WORD", "WPARAM"
	],
	"operator" : [
		"=", "(", ")", "{", "}", ";", ".", ",", "*", "+", "-", "<", ">", "&", "|", "!", "?", "^", "/", ":", "~", "%"
	]
};/*!
 * Quill Editor v1.3.6
 * https://quilljs.com/
 * Copyright (c) 2014, Jason Chen
 * Copyright (c) 2013, salesforce.com
 */
!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.Quill=e():t.Quill=e()}("undefined"!=typeof self?self:this,function(){return function(t){function e(r){if(n[r])return n[r].exports;var o=n[r]={i:r,l:!1,exports:{}};return t[r].call(o.exports,o,o.exports,e),o.l=!0,o.exports}var n={};return e.m=t,e.c=n,e.d=function(t,n,r){e.o(t,n)||Object.defineProperty(t,n,{configurable:!1,enumerable:!0,get:r})},e.n=function(t){var n=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(n,"a",n),n},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="",e(e.s=45)}([function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=n(17),o=n(18),i=n(19),l=n(48),a=n(49),s=n(50),u=n(51),c=n(52),f=n(11),h=n(29),p=n(30),d=n(28),y=n(1),v={Scope:y.Scope,create:y.create,find:y.find,query:y.query,register:y.register,Container:r.default,Format:o.default,Leaf:i.default,Embed:u.default,Scroll:l.default,Block:s.default,Inline:a.default,Text:c.default,Attributor:{Attribute:f.default,Class:h.default,Style:p.default,Store:d.default}};e.default=v},function(t,e,n){"use strict";function r(t,e){var n=i(t);if(null==n)throw new s("Unable to create "+t+" blot");var r=n;return new r(t instanceof Node||t.nodeType===Node.TEXT_NODE?t:r.create(e),e)}function o(t,n){return void 0===n&&(n=!1),null==t?null:null!=t[e.DATA_KEY]?t[e.DATA_KEY].blot:n?o(t.parentNode,n):null}function i(t,e){void 0===e&&(e=p.ANY);var n;if("string"==typeof t)n=h[t]||u[t];else if(t instanceof Text||t.nodeType===Node.TEXT_NODE)n=h.text;else if("number"==typeof t)t&p.LEVEL&p.BLOCK?n=h.block:t&p.LEVEL&p.INLINE&&(n=h.inline);else if(t instanceof HTMLElement){var r=(t.getAttribute("class")||"").split(/\s+/);for(var o in r)if(n=c[r[o]])break;n=n||f[t.tagName]}return null==n?null:e&p.LEVEL&n.scope&&e&p.TYPE&n.scope?n:null}function l(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];if(t.length>1)return t.map(function(t){return l(t)});var n=t[0];if("string"!=typeof n.blotName&&"string"!=typeof n.attrName)throw new s("Invalid definition");if("abstract"===n.blotName)throw new s("Cannot register abstract class");if(h[n.blotName||n.attrName]=n,"string"==typeof n.keyName)u[n.keyName]=n;else if(null!=n.className&&(c[n.className]=n),null!=n.tagName){Array.isArray(n.tagName)?n.tagName=n.tagName.map(function(t){return t.toUpperCase()}):n.tagName=n.tagName.toUpperCase();var r=Array.isArray(n.tagName)?n.tagName:[n.tagName];r.forEach(function(t){null!=f[t]&&null!=n.className||(f[t]=n)})}return n}var a=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(e,n){function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();Object.defineProperty(e,"__esModule",{value:!0});var s=function(t){function e(e){var n=this;return e="[Parchment] "+e,n=t.call(this,e)||this,n.message=e,n.name=n.constructor.name,n}return a(e,t),e}(Error);e.ParchmentError=s;var u={},c={},f={},h={};e.DATA_KEY="__blot";var p;!function(t){t[t.TYPE=3]="TYPE",t[t.LEVEL=12]="LEVEL",t[t.ATTRIBUTE=13]="ATTRIBUTE",t[t.BLOT=14]="BLOT",t[t.INLINE=7]="INLINE",t[t.BLOCK=11]="BLOCK",t[t.BLOCK_BLOT=10]="BLOCK_BLOT",t[t.INLINE_BLOT=6]="INLINE_BLOT",t[t.BLOCK_ATTRIBUTE=9]="BLOCK_ATTRIBUTE",t[t.INLINE_ATTRIBUTE=5]="INLINE_ATTRIBUTE",t[t.ANY=15]="ANY"}(p=e.Scope||(e.Scope={})),e.create=r,e.find=o,e.query=i,e.register=l},function(t,e){"use strict";var n=Object.prototype.hasOwnProperty,r=Object.prototype.toString,o=function(t){return"function"==typeof Array.isArray?Array.isArray(t):"[object Array]"===r.call(t)},i=function(t){if(!t||"[object Object]"!==r.call(t))return!1;var e=n.call(t,"constructor"),o=t.constructor&&t.constructor.prototype&&n.call(t.constructor.prototype,"isPrototypeOf");if(t.constructor&&!e&&!o)return!1;var i;for(i in t);return void 0===i||n.call(t,i)};t.exports=function t(){var e,n,r,l,a,s,u=arguments[0],c=1,f=arguments.length,h=!1;for("boolean"==typeof u&&(h=u,u=arguments[1]||{},c=2),(null==u||"object"!=typeof u&&"function"!=typeof u)&&(u={});c<f;++c)if(null!=(e=arguments[c]))for(n in e)r=u[n],l=e[n],u!==l&&(h&&l&&(i(l)||(a=o(l)))?(a?(a=!1,s=r&&o(r)?r:[]):s=r&&i(r)?r:{},u[n]=t(h,s,l)):void 0!==l&&(u[n]=l));return u}},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function l(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function a(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return null==t?e:("function"==typeof t.formats&&(e=(0,f.default)(e,t.formats())),null==t.parent||"scroll"==t.parent.blotName||t.parent.statics.scope!==t.statics.scope?e:a(t.parent,e))}Object.defineProperty(e,"__esModule",{value:!0}),e.default=e.BlockEmbed=e.bubbleFormats=void 0;var s=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),u=function t(e,n,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,n,r)}if("value"in o)return o.value;var l=o.get;if(void 0!==l)return l.call(r)},c=n(2),f=r(c),h=n(4),p=r(h),d=n(0),y=r(d),v=n(14),b=r(v),g=n(5),m=r(g),_=n(8),O=r(_),w=function(t){function e(){return o(this,e),i(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return l(e,t),s(e,[{key:"attach",value:function(){u(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"attach",this).call(this),this.attributes=new y.default.Attributor.Store(this.domNode)}},{key:"delta",value:function(){return(new p.default).insert(this.value(),(0,f.default)(this.formats(),this.attributes.values()))}},{key:"format",value:function(t,e){var n=y.default.query(t,y.default.Scope.BLOCK_ATTRIBUTE);null!=n&&this.attributes.attribute(n,e)}},{key:"formatAt",value:function(t,e,n,r){this.format(n,r)}},{key:"insertAt",value:function(t,n,r){if("string"==typeof n&&n.endsWith("\n")){var o=y.default.create(x.blotName);this.parent.insertBefore(o,0===t?this:this.next),o.insertAt(0,n.slice(0,-1))}else u(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"insertAt",this).call(this,t,n,r)}}]),e}(y.default.Embed);w.scope=y.default.Scope.BLOCK_BLOT;var x=function(t){function e(t){o(this,e);var n=i(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return n.cache={},n}return l(e,t),s(e,[{key:"delta",value:function(){return null==this.cache.delta&&(this.cache.delta=this.descendants(y.default.Leaf).reduce(function(t,e){return 0===e.length()?t:t.insert(e.value(),a(e))},new p.default).insert("\n",a(this))),this.cache.delta}},{key:"deleteAt",value:function(t,n){u(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"deleteAt",this).call(this,t,n),this.cache={}}},{key:"formatAt",value:function(t,n,r,o){n<=0||(y.default.query(r,y.default.Scope.BLOCK)?t+n===this.length()&&this.format(r,o):u(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"formatAt",this).call(this,t,Math.min(n,this.length()-t-1),r,o),this.cache={})}},{key:"insertAt",value:function(t,n,r){if(null!=r)return u(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"insertAt",this).call(this,t,n,r);if(0!==n.length){var o=n.split("\n"),i=o.shift();i.length>0&&(t<this.length()-1||null==this.children.tail?u(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"insertAt",this).call(this,Math.min(t,this.length()-1),i):this.children.tail.insertAt(this.children.tail.length(),i),this.cache={});var l=this;o.reduce(function(t,e){return l=l.split(t,!0),l.insertAt(0,e),e.length},t+i.length)}}},{key:"insertBefore",value:function(t,n){var r=this.children.head;u(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"insertBefore",this).call(this,t,n),r instanceof b.default&&r.remove(),this.cache={}}},{key:"length",value:function(){return null==this.cache.length&&(this.cache.length=u(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"length",this).call(this)+1),this.cache.length}},{key:"moveChildren",value:function(t,n){u(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"moveChildren",this).call(this,t,n),this.cache={}}},{key:"optimize",value:function(t){u(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"optimize",this).call(this,t),this.cache={}}},{key:"path",value:function(t){return u(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"path",this).call(this,t,!0)}},{key:"removeChild",value:function(t){u(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"removeChild",this).call(this,t),this.cache={}}},{key:"split",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(n&&(0===t||t>=this.length()-1)){var r=this.clone();return 0===t?(this.parent.insertBefore(r,this),this):(this.parent.insertBefore(r,this.next),r)}var o=u(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"split",this).call(this,t,n);return this.cache={},o}}]),e}(y.default.Block);x.blotName="block",x.tagName="P",x.defaultChild="break",x.allowedChildren=[m.default,y.default.Embed,O.default],e.bubbleFormats=a,e.BlockEmbed=w,e.default=x},function(t,e,n){var r=n(54),o=n(12),i=n(2),l=n(20),a=String.fromCharCode(0),s=function(t){Array.isArray(t)?this.ops=t:null!=t&&Array.isArray(t.ops)?this.ops=t.ops:this.ops=[]};s.prototype.insert=function(t,e){var n={};return 0===t.length?this:(n.insert=t,null!=e&&"object"==typeof e&&Object.keys(e).length>0&&(n.attributes=e),this.push(n))},s.prototype.delete=function(t){return t<=0?this:this.push({delete:t})},s.prototype.retain=function(t,e){if(t<=0)return this;var n={retain:t};return null!=e&&"object"==typeof e&&Object.keys(e).length>0&&(n.attributes=e),this.push(n)},s.prototype.push=function(t){var e=this.ops.length,n=this.ops[e-1];if(t=i(!0,{},t),"object"==typeof n){if("number"==typeof t.delete&&"number"==typeof n.delete)return this.ops[e-1]={delete:n.delete+t.delete},this;if("number"==typeof n.delete&&null!=t.insert&&(e-=1,"object"!=typeof(n=this.ops[e-1])))return this.ops.unshift(t),this;if(o(t.attributes,n.attributes)){if("string"==typeof t.insert&&"string"==typeof n.insert)return this.ops[e-1]={insert:n.insert+t.insert},"object"==typeof t.attributes&&(this.ops[e-1].attributes=t.attributes),this;if("number"==typeof t.retain&&"number"==typeof n.retain)return this.ops[e-1]={retain:n.retain+t.retain},"object"==typeof t.attributes&&(this.ops[e-1].attributes=t.attributes),this}}return e===this.ops.length?this.ops.push(t):this.ops.splice(e,0,t),this},s.prototype.chop=function(){var t=this.ops[this.ops.length-1];return t&&t.retain&&!t.attributes&&this.ops.pop(),this},s.prototype.filter=function(t){return this.ops.filter(t)},s.prototype.forEach=function(t){this.ops.forEach(t)},s.prototype.map=function(t){return this.ops.map(t)},s.prototype.partition=function(t){var e=[],n=[];return this.forEach(function(r){(t(r)?e:n).push(r)}),[e,n]},s.prototype.reduce=function(t,e){return this.ops.reduce(t,e)},s.prototype.changeLength=function(){return this.reduce(function(t,e){return e.insert?t+l.length(e):e.delete?t-e.delete:t},0)},s.prototype.length=function(){return this.reduce(function(t,e){return t+l.length(e)},0)},s.prototype.slice=function(t,e){t=t||0,"number"!=typeof e&&(e=1/0);for(var n=[],r=l.iterator(this.ops),o=0;o<e&&r.hasNext();){var i;o<t?i=r.next(t-o):(i=r.next(e-o),n.push(i)),o+=l.length(i)}return new s(n)},s.prototype.compose=function(t){for(var e=l.iterator(this.ops),n=l.iterator(t.ops),r=new s;e.hasNext()||n.hasNext();)if("insert"===n.peekType())r.push(n.next());else if("delete"===e.peekType())r.push(e.next());else{var o=Math.min(e.peekLength(),n.peekLength()),i=e.next(o),a=n.next(o);if("number"==typeof a.retain){var u={};"number"==typeof i.retain?u.retain=o:u.insert=i.insert;var c=l.attributes.compose(i.attributes,a.attributes,"number"==typeof i.retain);c&&(u.attributes=c),r.push(u)}else"number"==typeof a.delete&&"number"==typeof i.retain&&r.push(a)}return r.chop()},s.prototype.concat=function(t){var e=new s(this.ops.slice());return t.ops.length>0&&(e.push(t.ops[0]),e.ops=e.ops.concat(t.ops.slice(1))),e},s.prototype.diff=function(t,e){if(this.ops===t.ops)return new s;var n=[this,t].map(function(e){return e.map(function(n){if(null!=n.insert)return"string"==typeof n.insert?n.insert:a;var r=e===t?"on":"with";throw new Error("diff() called "+r+" non-document")}).join("")}),i=new s,u=r(n[0],n[1],e),c=l.iterator(this.ops),f=l.iterator(t.ops);return u.forEach(function(t){for(var e=t[1].length;e>0;){var n=0;switch(t[0]){case r.INSERT:n=Math.min(f.peekLength(),e),i.push(f.next(n));break;case r.DELETE:n=Math.min(e,c.peekLength()),c.next(n),i.delete(n);break;case r.EQUAL:n=Math.min(c.peekLength(),f.peekLength(),e);var a=c.next(n),s=f.next(n);o(a.insert,s.insert)?i.retain(n,l.attributes.diff(a.attributes,s.attributes)):i.push(s).delete(n)}e-=n}}),i.chop()},s.prototype.eachLine=function(t,e){e=e||"\n";for(var n=l.iterator(this.ops),r=new s,o=0;n.hasNext();){if("insert"!==n.peekType())return;var i=n.peek(),a=l.length(i)-n.peekLength(),u="string"==typeof i.insert?i.insert.indexOf(e,a)-a:-1;if(u<0)r.push(n.next());else if(u>0)r.push(n.next(u));else{if(!1===t(r,n.next(1).attributes||{},o))return;o+=1,r=new s}}r.length()>0&&t(r,{},o)},s.prototype.transform=function(t,e){if(e=!!e,"number"==typeof t)return this.transformPosition(t,e);for(var n=l.iterator(this.ops),r=l.iterator(t.ops),o=new s;n.hasNext()||r.hasNext();)if("insert"!==n.peekType()||!e&&"insert"===r.peekType())if("insert"===r.peekType())o.push(r.next());else{var i=Math.min(n.peekLength(),r.peekLength()),a=n.next(i),u=r.next(i);if(a.delete)continue;u.delete?o.push(u):o.retain(i,l.attributes.transform(a.attributes,u.attributes,e))}else o.retain(l.length(n.next()));return o.chop()},s.prototype.transformPosition=function(t,e){e=!!e;for(var n=l.iterator(this.ops),r=0;n.hasNext()&&r<=t;){var o=n.peekLength(),i=n.peekType();n.next(),"delete"!==i?("insert"===i&&(r<t||!e)&&(t+=o),r+=o):t-=Math.min(o,t-r)}return t},t.exports=s},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function l(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0});var a=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),s=function t(e,n,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,n,r)}if("value"in o)return o.value;var l=o.get;if(void 0!==l)return l.call(r)},u=n(8),c=r(u),f=n(0),h=r(f),p=function(t){function e(){return o(this,e),i(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return l(e,t),a(e,[{key:"formatAt",value:function(t,n,r,o){if(e.compare(this.statics.blotName,r)<0&&h.default.query(r,h.default.Scope.BLOT)){var i=this.isolate(t,n);o&&i.wrap(r,o)}else s(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"formatAt",this).call(this,t,n,r,o)}},{key:"optimize",value:function(t){if(s(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"optimize",this).call(this,t),this.parent instanceof e&&e.compare(this.statics.blotName,this.parent.statics.blotName)>0){var n=this.parent.isolate(this.offset(),this.length());this.moveChildren(n),n.wrap(this)}}}],[{key:"compare",value:function(t,n){var r=e.order.indexOf(t),o=e.order.indexOf(n);return r>=0||o>=0?r-o:t===n?0:t<n?-1:1}}]),e}(h.default.Inline);p.allowedChildren=[p,h.default.Embed,c.default],p.order=["cursor","inline","underline","strike","italic","bold","script","link","code"],e.default=p},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function l(t,e){if(e=(0,N.default)(!0,{container:t,modules:{clipboard:!0,keyboard:!0,history:!0}},e),e.theme&&e.theme!==S.DEFAULTS.theme){if(e.theme=S.import("themes/"+e.theme),null==e.theme)throw new Error("Invalid theme "+e.theme+". Did you register it?")}else e.theme=T.default;var n=(0,N.default)(!0,{},e.theme.DEFAULTS);[n,e].forEach(function(t){t.modules=t.modules||{},Object.keys(t.modules).forEach(function(e){!0===t.modules[e]&&(t.modules[e]={})})});var r=Object.keys(n.modules).concat(Object.keys(e.modules)),o=r.reduce(function(t,e){var n=S.import("modules/"+e);return null==n?P.error("Cannot load "+e+" module. Are you sure you registered it?"):t[e]=n.DEFAULTS||{},t},{});return null!=e.modules&&e.modules.toolbar&&e.modules.toolbar.constructor!==Object&&(e.modules.toolbar={container:e.modules.toolbar}),e=(0,N.default)(!0,{},S.DEFAULTS,{modules:o},n,e),["bounds","container","scrollingContainer"].forEach(function(t){"string"==typeof e[t]&&(e[t]=document.querySelector(e[t]))}),e.modules=Object.keys(e.modules).reduce(function(t,n){return e.modules[n]&&(t[n]=e.modules[n]),t},{}),e}function a(t,e,n,r){if(this.options.strict&&!this.isEnabled()&&e===g.default.sources.USER)return new d.default;var o=null==n?null:this.getSelection(),i=this.editor.delta,l=t();if(null!=o&&(!0===n&&(n=o.index),null==r?o=u(o,l,e):0!==r&&(o=u(o,n,r,e)),this.setSelection(o,g.default.sources.SILENT)),l.length()>0){var a,s=[g.default.events.TEXT_CHANGE,l,i,e];if((a=this.emitter).emit.apply(a,[g.default.events.EDITOR_CHANGE].concat(s)),e!==g.default.sources.SILENT){var c;(c=this.emitter).emit.apply(c,s)}}return l}function s(t,e,n,r,o){var i={};return"number"==typeof t.index&&"number"==typeof t.length?"number"!=typeof e?(o=r,r=n,n=e,e=t.length,t=t.index):(e=t.length,t=t.index):"number"!=typeof e&&(o=r,r=n,n=e,e=0),"object"===(void 0===n?"undefined":c(n))?(i=n,o=r):"string"==typeof n&&(null!=r?i[n]=r:o=n),o=o||g.default.sources.API,[t,e,i,o]}function u(t,e,n,r){if(null==t)return null;var o=void 0,i=void 0;if(e instanceof d.default){var l=[t.index,t.index+t.length].map(function(t){return e.transformPosition(t,r!==g.default.sources.USER)}),a=f(l,2);o=a[0],i=a[1]}else{var s=[t.index,t.index+t.length].map(function(t){return t<e||t===e&&r===g.default.sources.USER?t:n>=0?t+n:Math.max(e,t+n)}),u=f(s,2);o=u[0],i=u[1]}return new x.Range(o,i-o)}Object.defineProperty(e,"__esModule",{value:!0}),e.default=e.overload=e.expandConfig=void 0;var c="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},f=function(){function t(t,e){var n=[],r=!0,o=!1,i=void 0;try{for(var l,a=t[Symbol.iterator]();!(r=(l=a.next()).done)&&(n.push(l.value),!e||n.length!==e);r=!0);}catch(t){o=!0,i=t}finally{try{!r&&a.return&&a.return()}finally{if(o)throw i}}return n}return function(e,n){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),h=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}();n(53);var p=n(4),d=r(p),y=n(57),v=r(y),b=n(9),g=r(b),m=n(7),_=r(m),O=n(0),w=r(O),x=n(22),k=r(x),E=n(2),N=r(E),j=n(10),A=r(j),q=n(32),T=r(q),P=(0,A.default)("quill"),S=function(){function t(e){var n=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(i(this,t),this.options=l(e,r),this.container=this.options.container,null==this.container)return P.error("Invalid Quill container",e);this.options.debug&&t.debug(this.options.debug);var o=this.container.innerHTML.trim();this.container.classList.add("ql-container"),this.container.innerHTML="",this.container.__quill=this,this.root=this.addContainer("ql-editor"),this.root.classList.add("ql-blank"),this.root.setAttribute("data-gramm",!1),this.scrollingContainer=this.options.scrollingContainer||this.root,this.emitter=new g.default,this.scroll=w.default.create(this.root,{emitter:this.emitter,whitelist:this.options.formats}),this.editor=new v.default(this.scroll),this.selection=new k.default(this.scroll,this.emitter),this.theme=new this.options.theme(this,this.options),this.keyboard=this.theme.addModule("keyboard"),this.clipboard=this.theme.addModule("clipboard"),this.history=this.theme.addModule("history"),this.theme.init(),this.emitter.on(g.default.events.EDITOR_CHANGE,function(t){t===g.default.events.TEXT_CHANGE&&n.root.classList.toggle("ql-blank",n.editor.isBlank())}),this.emitter.on(g.default.events.SCROLL_UPDATE,function(t,e){var r=n.selection.lastRange,o=r&&0===r.length?r.index:void 0;a.call(n,function(){return n.editor.update(null,e,o)},t)});var s=this.clipboard.convert("<div class='ql-editor' style=\"white-space: normal;\">"+o+"<p><br></p></div>");this.setContents(s),this.history.clear(),this.options.placeholder&&this.root.setAttribute("data-placeholder",this.options.placeholder),this.options.readOnly&&this.disable()}return h(t,null,[{key:"debug",value:function(t){!0===t&&(t="log"),A.default.level(t)}},{key:"find",value:function(t){return t.__quill||w.default.find(t)}},{key:"import",value:function(t){return null==this.imports[t]&&P.error("Cannot import "+t+". Are you sure it was registered?"),this.imports[t]}},{key:"register",value:function(t,e){var n=this,r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if("string"!=typeof t){var o=t.attrName||t.blotName;"string"==typeof o?this.register("formats/"+o,t,e):Object.keys(t).forEach(function(r){n.register(r,t[r],e)})}else null==this.imports[t]||r||P.warn("Overwriting "+t+" with",e),this.imports[t]=e,(t.startsWith("blots/")||t.startsWith("formats/"))&&"abstract"!==e.blotName?w.default.register(e):t.startsWith("modules")&&"function"==typeof e.register&&e.register()}}]),h(t,[{key:"addContainer",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if("string"==typeof t){var n=t;t=document.createElement("div"),t.classList.add(n)}return this.container.insertBefore(t,e),t}},{key:"blur",value:function(){this.selection.setRange(null)}},{key:"deleteText",value:function(t,e,n){var r=this,o=s(t,e,n),i=f(o,4);return t=i[0],e=i[1],n=i[3],a.call(this,function(){return r.editor.deleteText(t,e)},n,t,-1*e)}},{key:"disable",value:function(){this.enable(!1)}},{key:"enable",value:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.scroll.enable(t),this.container.classList.toggle("ql-disabled",!t)}},{key:"focus",value:function(){var t=this.scrollingContainer.scrollTop;this.selection.focus(),this.scrollingContainer.scrollTop=t,this.scrollIntoView()}},{key:"format",value:function(t,e){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:g.default.sources.API;return a.call(this,function(){var r=n.getSelection(!0),i=new d.default;if(null==r)return i;if(w.default.query(t,w.default.Scope.BLOCK))i=n.editor.formatLine(r.index,r.length,o({},t,e));else{if(0===r.length)return n.selection.format(t,e),i;i=n.editor.formatText(r.index,r.length,o({},t,e))}return n.setSelection(r,g.default.sources.SILENT),i},r)}},{key:"formatLine",value:function(t,e,n,r,o){var i=this,l=void 0,u=s(t,e,n,r,o),c=f(u,4);return t=c[0],e=c[1],l=c[2],o=c[3],a.call(this,function(){return i.editor.formatLine(t,e,l)},o,t,0)}},{key:"formatText",value:function(t,e,n,r,o){var i=this,l=void 0,u=s(t,e,n,r,o),c=f(u,4);return t=c[0],e=c[1],l=c[2],o=c[3],a.call(this,function(){return i.editor.formatText(t,e,l)},o,t,0)}},{key:"getBounds",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=void 0;n="number"==typeof t?this.selection.getBounds(t,e):this.selection.getBounds(t.index,t.length);var r=this.container.getBoundingClientRect();return{bottom:n.bottom-r.top,height:n.height,left:n.left-r.left,right:n.right-r.left,top:n.top-r.top,width:n.width}}},{key:"getContents",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.getLength()-t,n=s(t,e),r=f(n,2);return t=r[0],e=r[1],this.editor.getContents(t,e)}},{key:"getFormat",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.getSelection(!0),e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return"number"==typeof t?this.editor.getFormat(t,e):this.editor.getFormat(t.index,t.length)}},{key:"getIndex",value:function(t){return t.offset(this.scroll)}},{key:"getLength",value:function(){return this.scroll.length()}},{key:"getLeaf",value:function(t){return this.scroll.leaf(t)}},{key:"getLine",value:function(t){return this.scroll.line(t)}},{key:"getLines",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Number.MAX_VALUE;return"number"!=typeof t?this.scroll.lines(t.index,t.length):this.scroll.lines(t,e)}},{key:"getModule",value:function(t){return this.theme.modules[t]}},{key:"getSelection",value:function(){return arguments.length>0&&void 0!==arguments[0]&&arguments[0]&&this.focus(),this.update(),this.selection.getRange()[0]}},{key:"getText",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.getLength()-t,n=s(t,e),r=f(n,2);return t=r[0],e=r[1],this.editor.getText(t,e)}},{key:"hasFocus",value:function(){return this.selection.hasFocus()}},{key:"insertEmbed",value:function(e,n,r){var o=this,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:t.sources.API;return a.call(this,function(){return o.editor.insertEmbed(e,n,r)},i,e)}},{key:"insertText",value:function(t,e,n,r,o){var i=this,l=void 0,u=s(t,0,n,r,o),c=f(u,4);return t=c[0],l=c[2],o=c[3],a.call(this,function(){return i.editor.insertText(t,e,l)},o,t,e.length)}},{key:"isEnabled",value:function(){return!this.container.classList.contains("ql-disabled")}},{key:"off",value:function(){return this.emitter.off.apply(this.emitter,arguments)}},{key:"on",value:function(){return this.emitter.on.apply(this.emitter,arguments)}},{key:"once",value:function(){return this.emitter.once.apply(this.emitter,arguments)}},{key:"pasteHTML",value:function(t,e,n){this.clipboard.dangerouslyPasteHTML(t,e,n)}},{key:"removeFormat",value:function(t,e,n){var r=this,o=s(t,e,n),i=f(o,4);return t=i[0],e=i[1],n=i[3],a.call(this,function(){return r.editor.removeFormat(t,e)},n,t)}},{key:"scrollIntoView",value:function(){this.selection.scrollIntoView(this.scrollingContainer)}},{key:"setContents",value:function(t){var e=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:g.default.sources.API;return a.call(this,function(){t=new d.default(t);var n=e.getLength(),r=e.editor.deleteText(0,n),o=e.editor.applyDelta(t),i=o.ops[o.ops.length-1];return null!=i&&"string"==typeof i.insert&&"\n"===i.insert[i.insert.length-1]&&(e.editor.deleteText(e.getLength()-1,1),o.delete(1)),r.compose(o)},n)}},{key:"setSelection",value:function(e,n,r){if(null==e)this.selection.setRange(null,n||t.sources.API);else{var o=s(e,n,r),i=f(o,4);e=i[0],n=i[1],r=i[3],this.selection.setRange(new x.Range(e,n),r),r!==g.default.sources.SILENT&&this.selection.scrollIntoView(this.scrollingContainer)}}},{key:"setText",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:g.default.sources.API,n=(new d.default).insert(t);return this.setContents(n,e)}},{key:"update",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:g.default.sources.USER,e=this.scroll.update(t);return this.selection.update(t),e}},{key:"updateContents",value:function(t){var e=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:g.default.sources.API;return a.call(this,function(){return t=new d.default(t),e.editor.applyDelta(t,n)},n,!0)}}]),t}();S.DEFAULTS={bounds:null,formats:null,modules:{},placeholder:"",readOnly:!1,scrollingContainer:null,strict:!0,theme:"default"},S.events=g.default.events,S.sources=g.default.sources,S.version="1.3.6",S.imports={delta:d.default,parchment:w.default,"core/module":_.default,"core/theme":T.default},e.expandConfig=l,e.overload=s,e.default=S},function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0});var o=function t(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};r(this,t),this.quill=e,this.options=n};o.DEFAULTS={},e.default=o},function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0});var l=n(0),a=function(t){return t&&t.__esModule?t:{default:t}}(l),s=function(t){function e(){return r(this,e),o(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return i(e,t),e}(a.default.Text);e.default=s},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function l(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0});var a=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),s=function t(e,n,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,n,r)}if("value"in o)return o.value;var l=o.get;if(void 0!==l)return l.call(r)},u=n(58),c=r(u),f=n(10),h=r(f),p=(0,h.default)("quill:events");["selectionchange","mousedown","mouseup","click"].forEach(function(t){document.addEventListener(t,function(){for(var t=arguments.length,e=Array(t),n=0;n<t;n++)e[n]=arguments[n];[].slice.call(document.querySelectorAll(".ql-container")).forEach(function(t){if(t.__quill&&t.__quill.emitter){var n;(n=t.__quill.emitter).handleDOM.apply(n,e)}})})});var d=function(t){function e(){o(this,e);var t=i(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return t.listeners={},t.on("error",p.error),t}return l(e,t),a(e,[{key:"emit",value:function(){p.log.apply(p,arguments),s(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"emit",this).apply(this,arguments)}},{key:"handleDOM",value:function(t){for(var e=arguments.length,n=Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];(this.listeners[t.type]||[]).forEach(function(e){var r=e.node,o=e.handler;(t.target===r||r.contains(t.target))&&o.apply(void 0,[t].concat(n))})}},{key:"listenDOM",value:function(t,e,n){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push({node:e,handler:n})}}]),e}(c.default);d.events={EDITOR_CHANGE:"editor-change",SCROLL_BEFORE_UPDATE:"scroll-before-update",SCROLL_OPTIMIZE:"scroll-optimize",SCROLL_UPDATE:"scroll-update",SELECTION_CHANGE:"selection-change",TEXT_CHANGE:"text-change"},d.sources={API:"api",SILENT:"silent",USER:"user"},e.default=d},function(t,e,n){"use strict";function r(t){if(i.indexOf(t)<=i.indexOf(l)){for(var e,n=arguments.length,r=Array(n>1?n-1:0),o=1;o<n;o++)r[o-1]=arguments[o];(e=console)[t].apply(e,r)}}function o(t){return i.reduce(function(e,n){return e[n]=r.bind(console,n,t),e},{})}Object.defineProperty(e,"__esModule",{value:!0});var i=["error","warn","log","info"],l="warn";r.level=o.level=function(t){l=t},e.default=o},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=n(1),o=function(){function t(t,e,n){void 0===n&&(n={}),this.attrName=t,this.keyName=e;var o=r.Scope.TYPE&r.Scope.ATTRIBUTE;null!=n.scope?this.scope=n.scope&r.Scope.LEVEL|o:this.scope=r.Scope.ATTRIBUTE,null!=n.whitelist&&(this.whitelist=n.whitelist)}return t.keys=function(t){return[].map.call(t.attributes,function(t){return t.name})},t.prototype.add=function(t,e){return!!this.canAdd(t,e)&&(t.setAttribute(this.keyName,e),!0)},t.prototype.canAdd=function(t,e){return null!=r.query(t,r.Scope.BLOT&(this.scope|r.Scope.TYPE))&&(null==this.whitelist||("string"==typeof e?this.whitelist.indexOf(e.replace(/["']/g,""))>-1:this.whitelist.indexOf(e)>-1))},t.prototype.remove=function(t){t.removeAttribute(this.keyName)},t.prototype.value=function(t){var e=t.getAttribute(this.keyName);return this.canAdd(t,e)&&e?e:""},t}();e.default=o},function(t,e,n){function r(t){return null===t||void 0===t}function o(t){return!(!t||"object"!=typeof t||"number"!=typeof t.length)&&("function"==typeof t.copy&&"function"==typeof t.slice&&!(t.length>0&&"number"!=typeof t[0]))}function i(t,e,n){var i,c;if(r(t)||r(e))return!1;if(t.prototype!==e.prototype)return!1;if(s(t))return!!s(e)&&(t=l.call(t),e=l.call(e),u(t,e,n));if(o(t)){if(!o(e))return!1;if(t.length!==e.length)return!1;for(i=0;i<t.length;i++)if(t[i]!==e[i])return!1;return!0}try{var f=a(t),h=a(e)}catch(t){return!1}if(f.length!=h.length)return!1;for(f.sort(),h.sort(),i=f.length-1;i>=0;i--)if(f[i]!=h[i])return!1;for(i=f.length-1;i>=0;i--)if(c=f[i],!u(t[c],e[c],n))return!1;return typeof t==typeof e}var l=Array.prototype.slice,a=n(55),s=n(56),u=t.exports=function(t,e,n){return n||(n={}),t===e||(t instanceof Date&&e instanceof Date?t.getTime()===e.getTime():!t||!e||"object"!=typeof t&&"object"!=typeof e?n.strict?t===e:t==e:i(t,e,n))}},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function l(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0}),e.default=e.Code=void 0;var a=function(){function t(t,e){var n=[],r=!0,o=!1,i=void 0;try{for(var l,a=t[Symbol.iterator]();!(r=(l=a.next()).done)&&(n.push(l.value),!e||n.length!==e);r=!0);}catch(t){o=!0,i=t}finally{try{!r&&a.return&&a.return()}finally{if(o)throw i}}return n}return function(e,n){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),s=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),u=function t(e,n,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,n,r)}if("value"in o)return o.value;var l=o.get;if(void 0!==l)return l.call(r)},c=n(4),f=r(c),h=n(0),p=r(h),d=n(3),y=r(d),v=n(5),b=r(v),g=n(8),m=r(g),_=function(t){function e(){return o(this,e),i(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return l(e,t),e}(b.default);_.blotName="code",_.tagName="CODE";var O=function(t){function e(){return o(this,e),i(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return l(e,t),s(e,[{key:"delta",value:function(){var t=this,e=this.domNode.textContent;return e.endsWith("\n")&&(e=e.slice(0,-1)),e.split("\n").reduce(function(e,n){return e.insert(n).insert("\n",t.formats())},new f.default)}},{key:"format",value:function(t,n){if(t!==this.statics.blotName||!n){var r=this.descendant(m.default,this.length()-1),o=a(r,1),i=o[0];null!=i&&i.deleteAt(i.length()-1,1),u(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"format",this).call(this,t,n)}}},{key:"formatAt",value:function(t,n,r,o){if(0!==n&&null!=p.default.query(r,p.default.Scope.BLOCK)&&(r!==this.statics.blotName||o!==this.statics.formats(this.domNode))){var i=this.newlineIndex(t);if(!(i<0||i>=t+n)){var l=this.newlineIndex(t,!0)+1,a=i-l+1,s=this.isolate(l,a),u=s.next;s.format(r,o),u instanceof e&&u.formatAt(0,t-l+n-a,r,o)}}}},{key:"insertAt",value:function(t,e,n){if(null==n){var r=this.descendant(m.default,t),o=a(r,2),i=o[0],l=o[1];i.insertAt(l,e)}}},{key:"length",value:function(){var t=this.domNode.textContent.length;return this.domNode.textContent.endsWith("\n")?t:t+1}},{key:"newlineIndex",value:function(t){if(arguments.length>1&&void 0!==arguments[1]&&arguments[1])return this.domNode.textContent.slice(0,t).lastIndexOf("\n");var e=this.domNode.textContent.slice(t).indexOf("\n");return e>-1?t+e:-1}},{key:"optimize",value:function(t){this.domNode.textContent.endsWith("\n")||this.appendChild(p.default.create("text","\n")),u(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"optimize",this).call(this,t);var n=this.next;null!=n&&n.prev===this&&n.statics.blotName===this.statics.blotName&&this.statics.formats(this.domNode)===n.statics.formats(n.domNode)&&(n.optimize(t),n.moveChildren(this),n.remove())}},{key:"replace",value:function(t){u(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"replace",this).call(this,t),[].slice.call(this.domNode.querySelectorAll("*")).forEach(function(t){var e=p.default.find(t);null==e?t.parentNode.removeChild(t):e instanceof p.default.Embed?e.remove():e.unwrap()})}}],[{key:"create",value:function(t){var n=u(e.__proto__||Object.getPrototypeOf(e),"create",this).call(this,t);return n.setAttribute("spellcheck",!1),n}},{key:"formats",value:function(){return!0}}]),e}(y.default);O.blotName="code-block",O.tagName="PRE",O.TAB="  ",e.Code=_,e.default=O},function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0});var l=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),a=function t(e,n,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,n,r)}if("value"in o)return o.value;var l=o.get;if(void 0!==l)return l.call(r)},s=n(0),u=function(t){return t&&t.__esModule?t:{default:t}}(s),c=function(t){function e(){return r(this,e),o(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return i(e,t),l(e,[{key:"insertInto",value:function(t,n){0===t.children.length?a(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"insertInto",this).call(this,t,n):this.remove()}},{key:"length",value:function(){return 0}},{key:"value",value:function(){return""}}],[{key:"value",value:function(){}}]),e}(u.default.Embed);c.blotName="break",c.tagName="BR",e.default=c},function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function l(t,e){var n=document.createElement("a");n.href=t;var r=n.href.slice(0,n.href.indexOf(":"));return e.indexOf(r)>-1}Object.defineProperty(e,"__esModule",{value:!0}),e.sanitize=e.default=void 0;var a=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),s=function t(e,n,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,n,r)}if("value"in o)return o.value;var l=o.get;if(void 0!==l)return l.call(r)},u=n(5),c=function(t){return t&&t.__esModule?t:{default:t}}(u),f=function(t){function e(){return r(this,e),o(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return i(e,t),a(e,[{key:"format",value:function(t,n){if(t!==this.statics.blotName||!n)return s(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"format",this).call(this,t,n);n=this.constructor.sanitize(n),this.domNode.setAttribute("href",n)}}],[{key:"create",value:function(t){var n=s(e.__proto__||Object.getPrototypeOf(e),"create",this).call(this,t);return t=this.sanitize(t),n.setAttribute("href",t),n.setAttribute("target","_blank"),n}},{key:"formats",value:function(t){return t.getAttribute("href")}},{key:"sanitize",value:function(t){return l(t,this.PROTOCOL_WHITELIST)?t:this.SANITIZED_URL}}]),e}(c.default);f.blotName="link",f.tagName="A",f.SANITIZED_URL="about:blank",f.PROTOCOL_WHITELIST=["http","https","mailto","tel"],e.default=f,e.sanitize=l},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){t.setAttribute(e,!("true"===t.getAttribute(e)))}Object.defineProperty(e,"__esModule",{value:!0});var l="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},a=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),s=n(25),u=r(s),c=n(106),f=r(c),h=0,p=function(){function t(e){var n=this;o(this,t),this.select=e,this.container=document.createElement("span"),this.buildPicker(),this.select.style.display="none",this.select.parentNode.insertBefore(this.container,this.select),this.label.addEventListener("mousedown",function(){n.togglePicker()}),this.label.addEventListener("keydown",function(t){switch(t.keyCode){case u.default.keys.ENTER:n.togglePicker();break;case u.default.keys.ESCAPE:n.escape(),t.preventDefault()}}),this.select.addEventListener("change",this.update.bind(this))}return a(t,[{key:"togglePicker",value:function(){this.container.classList.toggle("ql-expanded"),i(this.label,"aria-expanded"),i(this.options,"aria-hidden")}},{key:"buildItem",value:function(t){var e=this,n=document.createElement("span");return n.tabIndex="0",n.setAttribute("role","button"),n.classList.add("ql-picker-item"),t.hasAttribute("value")&&n.setAttribute("data-value",t.getAttribute("value")),t.textContent&&n.setAttribute("data-label",t.textContent),n.addEventListener("click",function(){e.selectItem(n,!0)}),n.addEventListener("keydown",function(t){switch(t.keyCode){case u.default.keys.ENTER:e.selectItem(n,!0),t.preventDefault();break;case u.default.keys.ESCAPE:e.escape(),t.preventDefault()}}),n}},{key:"buildLabel",value:function(){var t=document.createElement("span");return t.classList.add("ql-picker-label"),t.innerHTML=f.default,t.tabIndex="0",t.setAttribute("role","button"),t.setAttribute("aria-expanded","false"),this.container.appendChild(t),t}},{key:"buildOptions",value:function(){var t=this,e=document.createElement("span");e.classList.add("ql-picker-options"),e.setAttribute("aria-hidden","true"),e.tabIndex="-1",e.id="ql-picker-options-"+h,h+=1,this.label.setAttribute("aria-controls",e.id),this.options=e,[].slice.call(this.select.options).forEach(function(n){var r=t.buildItem(n);e.appendChild(r),!0===n.selected&&t.selectItem(r)}),this.container.appendChild(e)}},{key:"buildPicker",value:function(){var t=this;[].slice.call(this.select.attributes).forEach(function(e){t.container.setAttribute(e.name,e.value)}),this.container.classList.add("ql-picker"),this.label=this.buildLabel(),this.buildOptions()}},{key:"escape",value:function(){var t=this;this.close(),setTimeout(function(){return t.label.focus()},1)}},{key:"close",value:function(){this.container.classList.remove("ql-expanded"),this.label.setAttribute("aria-expanded","false"),this.options.setAttribute("aria-hidden","true")}},{key:"selectItem",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=this.container.querySelector(".ql-selected");if(t!==n&&(null!=n&&n.classList.remove("ql-selected"),null!=t&&(t.classList.add("ql-selected"),this.select.selectedIndex=[].indexOf.call(t.parentNode.children,t),t.hasAttribute("data-value")?this.label.setAttribute("data-value",t.getAttribute("data-value")):this.label.removeAttribute("data-value"),t.hasAttribute("data-label")?this.label.setAttribute("data-label",t.getAttribute("data-label")):this.label.removeAttribute("data-label"),e))){if("function"==typeof Event)this.select.dispatchEvent(new Event("change"));else if("object"===("undefined"==typeof Event?"undefined":l(Event))){var r=document.createEvent("Event");r.initEvent("change",!0,!0),this.select.dispatchEvent(r)}this.close()}}},{key:"update",value:function(){var t=void 0;if(this.select.selectedIndex>-1){var e=this.container.querySelector(".ql-picker-options").children[this.select.selectedIndex];t=this.select.options[this.select.selectedIndex],this.selectItem(e)}else this.selectItem(null);var n=null!=t&&t!==this.select.querySelector("option[selected]");this.label.classList.toggle("ql-active",n)}}]),t}();e.default=p},function(t,e,n){"use strict";function r(t){var e=a.find(t);if(null==e)try{e=a.create(t)}catch(n){e=a.create(a.Scope.INLINE),[].slice.call(t.childNodes).forEach(function(t){e.domNode.appendChild(t)}),t.parentNode&&t.parentNode.replaceChild(e.domNode,t),e.attach()}return e}var o=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(e,n){function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();Object.defineProperty(e,"__esModule",{value:!0});var i=n(47),l=n(27),a=n(1),s=function(t){function e(e){var n=t.call(this,e)||this;return n.build(),n}return o(e,t),e.prototype.appendChild=function(t){this.insertBefore(t)},e.prototype.attach=function(){t.prototype.attach.call(this),this.children.forEach(function(t){t.attach()})},e.prototype.build=function(){var t=this;this.children=new i.default,[].slice.call(this.domNode.childNodes).reverse().forEach(function(e){try{var n=r(e);t.insertBefore(n,t.children.head||void 0)}catch(t){if(t instanceof a.ParchmentError)return;throw t}})},e.prototype.deleteAt=function(t,e){if(0===t&&e===this.length())return this.remove();this.children.forEachAt(t,e,function(t,e,n){t.deleteAt(e,n)})},e.prototype.descendant=function(t,n){var r=this.children.find(n),o=r[0],i=r[1];return null==t.blotName&&t(o)||null!=t.blotName&&o instanceof t?[o,i]:o instanceof e?o.descendant(t,i):[null,-1]},e.prototype.descendants=function(t,n,r){void 0===n&&(n=0),void 0===r&&(r=Number.MAX_VALUE);var o=[],i=r;return this.children.forEachAt(n,r,function(n,r,l){(null==t.blotName&&t(n)||null!=t.blotName&&n instanceof t)&&o.push(n),n instanceof e&&(o=o.concat(n.descendants(t,r,i))),i-=l}),o},e.prototype.detach=function(){this.children.forEach(function(t){t.detach()}),t.prototype.detach.call(this)},e.prototype.formatAt=function(t,e,n,r){this.children.forEachAt(t,e,function(t,e,o){t.formatAt(e,o,n,r)})},e.prototype.insertAt=function(t,e,n){var r=this.children.find(t),o=r[0],i=r[1];if(o)o.insertAt(i,e,n);else{var l=null==n?a.create("text",e):a.create(e,n);this.appendChild(l)}},e.prototype.insertBefore=function(t,e){if(null!=this.statics.allowedChildren&&!this.statics.allowedChildren.some(function(e){return t instanceof e}))throw new a.ParchmentError("Cannot insert "+t.statics.blotName+" into "+this.statics.blotName);t.insertInto(this,e)},e.prototype.length=function(){return this.children.reduce(function(t,e){return t+e.length()},0)},e.prototype.moveChildren=function(t,e){this.children.forEach(function(n){t.insertBefore(n,e)})},e.prototype.optimize=function(e){if(t.prototype.optimize.call(this,e),0===this.children.length)if(null!=this.statics.defaultChild){var n=a.create(this.statics.defaultChild);this.appendChild(n),n.optimize(e)}else this.remove()},e.prototype.path=function(t,n){void 0===n&&(n=!1);var r=this.children.find(t,n),o=r[0],i=r[1],l=[[this,t]];return o instanceof e?l.concat(o.path(i,n)):(null!=o&&l.push([o,i]),l)},e.prototype.removeChild=function(t){this.children.remove(t)},e.prototype.replace=function(n){n instanceof e&&n.moveChildren(this),t.prototype.replace.call(this,n)},e.prototype.split=function(t,e){if(void 0===e&&(e=!1),!e){if(0===t)return this;if(t===this.length())return this.next}var n=this.clone();return this.parent.insertBefore(n,this.next),this.children.forEachAt(t,this.length(),function(t,r,o){t=t.split(r,e),n.appendChild(t)}),n},e.prototype.unwrap=function(){this.moveChildren(this.parent,this.next),this.remove()},e.prototype.update=function(t,e){var n=this,o=[],i=[];t.forEach(function(t){t.target===n.domNode&&"childList"===t.type&&(o.push.apply(o,t.addedNodes),i.push.apply(i,t.removedNodes))}),i.forEach(function(t){if(!(null!=t.parentNode&&"IFRAME"!==t.tagName&&document.body.compareDocumentPosition(t)&Node.DOCUMENT_POSITION_CONTAINED_BY)){var e=a.find(t);null!=e&&(null!=e.domNode.parentNode&&e.domNode.parentNode!==n.domNode||e.detach())}}),o.filter(function(t){return t.parentNode==n.domNode}).sort(function(t,e){return t===e?0:t.compareDocumentPosition(e)&Node.DOCUMENT_POSITION_FOLLOWING?1:-1}).forEach(function(t){var e=null;null!=t.nextSibling&&(e=a.find(t.nextSibling));var o=r(t);o.next==e&&null!=o.next||(null!=o.parent&&o.parent.removeChild(n),n.insertBefore(o,e||void 0))})},e}(l.default);e.default=s},function(t,e,n){"use strict";var r=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(e,n){function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();Object.defineProperty(e,"__esModule",{value:!0});var o=n(11),i=n(28),l=n(17),a=n(1),s=function(t){function e(e){var n=t.call(this,e)||this;return n.attributes=new i.default(n.domNode),n}return r(e,t),e.formats=function(t){return"string"==typeof this.tagName||(Array.isArray(this.tagName)?t.tagName.toLowerCase():void 0)},e.prototype.format=function(t,e){var n=a.query(t);n instanceof o.default?this.attributes.attribute(n,e):e&&(null==n||t===this.statics.blotName&&this.formats()[t]===e||this.replaceWith(t,e))},e.prototype.formats=function(){var t=this.attributes.values(),e=this.statics.formats(this.domNode);return null!=e&&(t[this.statics.blotName]=e),t},e.prototype.replaceWith=function(e,n){var r=t.prototype.replaceWith.call(this,e,n);return this.attributes.copy(r),r},e.prototype.update=function(e,n){var r=this;t.prototype.update.call(this,e,n),e.some(function(t){return t.target===r.domNode&&"attributes"===t.type})&&this.attributes.build()},e.prototype.wrap=function(n,r){var o=t.prototype.wrap.call(this,n,r);return o instanceof e&&o.statics.scope===this.statics.scope&&this.attributes.move(o),o},e}(l.default);e.default=s},function(t,e,n){"use strict";var r=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(e,n){function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();Object.defineProperty(e,"__esModule",{value:!0});var o=n(27),i=n(1),l=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return r(e,t),e.value=function(t){return!0},e.prototype.index=function(t,e){return this.domNode===t||this.domNode.compareDocumentPosition(t)&Node.DOCUMENT_POSITION_CONTAINED_BY?Math.min(e,1):-1},e.prototype.position=function(t,e){var n=[].indexOf.call(this.parent.domNode.childNodes,this.domNode);return t>0&&(n+=1),[this.parent.domNode,n]},e.prototype.value=function(){return t={},t[this.statics.blotName]=this.statics.value(this.domNode)||!0,t;var t},e.scope=i.Scope.INLINE_BLOT,e}(o.default);e.default=l},function(t,e,n){function r(t){this.ops=t,this.index=0,this.offset=0}var o=n(12),i=n(2),l={attributes:{compose:function(t,e,n){"object"!=typeof t&&(t={}),"object"!=typeof e&&(e={});var r=i(!0,{},e);n||(r=Object.keys(r).reduce(function(t,e){return null!=r[e]&&(t[e]=r[e]),t},{}));for(var o in t)void 0!==t[o]&&void 0===e[o]&&(r[o]=t[o]);return Object.keys(r).length>0?r:void 0},diff:function(t,e){"object"!=typeof t&&(t={}),"object"!=typeof e&&(e={});var n=Object.keys(t).concat(Object.keys(e)).reduce(function(n,r){return o(t[r],e[r])||(n[r]=void 0===e[r]?null:e[r]),n},{});return Object.keys(n).length>0?n:void 0},transform:function(t,e,n){if("object"!=typeof t)return e;if("object"==typeof e){if(!n)return e;var r=Object.keys(e).reduce(function(n,r){return void 0===t[r]&&(n[r]=e[r]),n},{});return Object.keys(r).length>0?r:void 0}}},iterator:function(t){return new r(t)},length:function(t){return"number"==typeof t.delete?t.delete:"number"==typeof t.retain?t.retain:"string"==typeof t.insert?t.insert.length:1}};r.prototype.hasNext=function(){return this.peekLength()<1/0},r.prototype.next=function(t){t||(t=1/0);var e=this.ops[this.index];if(e){var n=this.offset,r=l.length(e);if(t>=r-n?(t=r-n,this.index+=1,this.offset=0):this.offset+=t,"number"==typeof e.delete)return{delete:t};var o={};return e.attributes&&(o.attributes=e.attributes),"number"==typeof e.retain?o.retain=t:"string"==typeof e.insert?o.insert=e.insert.substr(n,t):o.insert=e.insert,o}return{retain:1/0}},r.prototype.peek=function(){return this.ops[this.index]},r.prototype.peekLength=function(){return this.ops[this.index]?l.length(this.ops[this.index])-this.offset:1/0},r.prototype.peekType=function(){return this.ops[this.index]?"number"==typeof this.ops[this.index].delete?"delete":"number"==typeof this.ops[this.index].retain?"retain":"insert":"retain"},t.exports=l},function(t,e){var n=function(){"use strict";function t(t,e){return null!=e&&t instanceof e}function e(n,r,o,i,c){function f(n,o){if(null===n)return null;if(0===o)return n;var y,v;if("object"!=typeof n)return n;if(t(n,a))y=new a;else if(t(n,s))y=new s;else if(t(n,u))y=new u(function(t,e){n.then(function(e){t(f(e,o-1))},function(t){e(f(t,o-1))})});else if(e.__isArray(n))y=[];else if(e.__isRegExp(n))y=new RegExp(n.source,l(n)),n.lastIndex&&(y.lastIndex=n.lastIndex);else if(e.__isDate(n))y=new Date(n.getTime());else{if(d&&Buffer.isBuffer(n))return y=new Buffer(n.length),n.copy(y),y;t(n,Error)?y=Object.create(n):void 0===i?(v=Object.getPrototypeOf(n),y=Object.create(v)):(y=Object.create(i),v=i)}if(r){var b=h.indexOf(n);if(-1!=b)return p[b];h.push(n),p.push(y)}t(n,a)&&n.forEach(function(t,e){var n=f(e,o-1),r=f(t,o-1);y.set(n,r)}),t(n,s)&&n.forEach(function(t){var e=f(t,o-1);y.add(e)});for(var g in n){var m;v&&(m=Object.getOwnPropertyDescriptor(v,g)),m&&null==m.set||(y[g]=f(n[g],o-1))}if(Object.getOwnPropertySymbols)for(var _=Object.getOwnPropertySymbols(n),g=0;g<_.length;g++){var O=_[g],w=Object.getOwnPropertyDescriptor(n,O);(!w||w.enumerable||c)&&(y[O]=f(n[O],o-1),w.enumerable||Object.defineProperty(y,O,{enumerable:!1}))}if(c)for(var x=Object.getOwnPropertyNames(n),g=0;g<x.length;g++){var k=x[g],w=Object.getOwnPropertyDescriptor(n,k);w&&w.enumerable||(y[k]=f(n[k],o-1),Object.defineProperty(y,k,{enumerable:!1}))}return y}"object"==typeof r&&(o=r.depth,i=r.prototype,c=r.includeNonEnumerable,r=r.circular);var h=[],p=[],d="undefined"!=typeof Buffer;return void 0===r&&(r=!0),void 0===o&&(o=1/0),f(n,o)}function n(t){return Object.prototype.toString.call(t)}function r(t){return"object"==typeof t&&"[object Date]"===n(t)}function o(t){return"object"==typeof t&&"[object Array]"===n(t)}function i(t){return"object"==typeof t&&"[object RegExp]"===n(t)}function l(t){var e="";return t.global&&(e+="g"),t.ignoreCase&&(e+="i"),t.multiline&&(e+="m"),e}var a;try{a=Map}catch(t){a=function(){}}var s;try{s=Set}catch(t){s=function(){}}var u;try{u=Promise}catch(t){u=function(){}}return e.clonePrototype=function(t){if(null===t)return null;var e=function(){};return e.prototype=t,new e},e.__objToStr=n,e.__isDate=r,e.__isArray=o,e.__isRegExp=i,e.__getRegExpFlags=l,e}();"object"==typeof t&&t.exports&&(t.exports=n)},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)}function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function l(t,e){try{e.parentNode}catch(t){return!1}return e instanceof Text&&(e=e.parentNode),t.contains(e)}Object.defineProperty(e,"__esModule",{value:!0}),e.default=e.Range=void 0;var a=function(){function t(t,e){var n=[],r=!0,o=!1,i=void 0;try{for(var l,a=t[Symbol.iterator]();!(r=(l=a.next()).done)&&(n.push(l.value),!e||n.length!==e);r=!0);}catch(t){o=!0,i=t}finally{try{!r&&a.return&&a.return()}finally{if(o)throw i}}return n}return function(e,n){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),s=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),u=n(0),c=r(u),f=n(21),h=r(f),p=n(12),d=r(p),y=n(9),v=r(y),b=n(10),g=r(b),m=(0,g.default)("quill:selection"),_=function t(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;i(this,t),this.index=e,this.length=n},O=function(){function t(e,n){var r=this;i(this,t),this.emitter=n,this.scroll=e,this.composing=!1,this.mouseDown=!1,this.root=this.scroll.domNode,this.cursor=c.default.create("cursor",this),this.lastRange=this.savedRange=new _(0,0),this.handleComposition(),this.handleDragging(),this.emitter.listenDOM("selectionchange",document,function(){r.mouseDown||setTimeout(r.update.bind(r,v.default.sources.USER),1)}),this.emitter.on(v.default.events.EDITOR_CHANGE,function(t,e){t===v.default.events.TEXT_CHANGE&&e.length()>0&&r.update(v.default.sources.SILENT)}),this.emitter.on(v.default.events.SCROLL_BEFORE_UPDATE,function(){if(r.hasFocus()){var t=r.getNativeRange();null!=t&&t.start.node!==r.cursor.textNode&&r.emitter.once(v.default.events.SCROLL_UPDATE,function(){try{r.setNativeRange(t.start.node,t.start.offset,t.end.node,t.end.offset)}catch(t){}})}}),this.emitter.on(v.default.events.SCROLL_OPTIMIZE,function(t,e){if(e.range){var n=e.range,o=n.startNode,i=n.startOffset,l=n.endNode,a=n.endOffset;r.setNativeRange(o,i,l,a)}}),this.update(v.default.sources.SILENT)}return s(t,[{key:"handleComposition",value:function(){var t=this;this.root.addEventListener("compositionstart",function(){t.composing=!0}),this.root.addEventListener("compositionend",function(){if(t.composing=!1,t.cursor.parent){var e=t.cursor.restore();if(!e)return;setTimeout(function(){t.setNativeRange(e.startNode,e.startOffset,e.endNode,e.endOffset)},1)}})}},{key:"handleDragging",value:function(){var t=this;this.emitter.listenDOM("mousedown",document.body,function(){t.mouseDown=!0}),this.emitter.listenDOM("mouseup",document.body,function(){t.mouseDown=!1,t.update(v.default.sources.USER)})}},{key:"focus",value:function(){this.hasFocus()||(this.root.focus(),this.setRange(this.savedRange))}},{key:"format",value:function(t,e){if(null==this.scroll.whitelist||this.scroll.whitelist[t]){this.scroll.update();var n=this.getNativeRange();if(null!=n&&n.native.collapsed&&!c.default.query(t,c.default.Scope.BLOCK)){if(n.start.node!==this.cursor.textNode){var r=c.default.find(n.start.node,!1);if(null==r)return;if(r instanceof c.default.Leaf){var o=r.split(n.start.offset);r.parent.insertBefore(this.cursor,o)}else r.insertBefore(this.cursor,n.start.node);this.cursor.attach()}this.cursor.format(t,e),this.scroll.optimize(),this.setNativeRange(this.cursor.textNode,this.cursor.textNode.data.length),this.update()}}}},{key:"getBounds",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=this.scroll.length();t=Math.min(t,n-1),e=Math.min(t+e,n-1)-t;var r=void 0,o=this.scroll.leaf(t),i=a(o,2),l=i[0],s=i[1];if(null==l)return null;var u=l.position(s,!0),c=a(u,2);r=c[0],s=c[1];var f=document.createRange();if(e>0){f.setStart(r,s);var h=this.scroll.leaf(t+e),p=a(h,2);if(l=p[0],s=p[1],null==l)return null;var d=l.position(s,!0),y=a(d,2);return r=y[0],s=y[1],f.setEnd(r,s),f.getBoundingClientRect()}var v="left",b=void 0;return r instanceof Text?(s<r.data.length?(f.setStart(r,s),f.setEnd(r,s+1)):(f.setStart(r,s-1),f.setEnd(r,s),v="right"),b=f.getBoundingClientRect()):(b=l.domNode.getBoundingClientRect(),s>0&&(v="right")),{bottom:b.top+b.height,height:b.height,left:b[v],right:b[v],top:b.top,width:0}}},{key:"getNativeRange",value:function(){var t=document.getSelection();if(null==t||t.rangeCount<=0)return null;var e=t.getRangeAt(0);if(null==e)return null;var n=this.normalizeNative(e);return m.info("getNativeRange",n),n}},{key:"getRange",value:function(){var t=this.getNativeRange();return null==t?[null,null]:[this.normalizedToRange(t),t]}},{key:"hasFocus",value:function(){return document.activeElement===this.root}},{key:"normalizedToRange",value:function(t){var e=this,n=[[t.start.node,t.start.offset]];t.native.collapsed||n.push([t.end.node,t.end.offset]);var r=n.map(function(t){var n=a(t,2),r=n[0],o=n[1],i=c.default.find(r,!0),l=i.offset(e.scroll);return 0===o?l:i instanceof c.default.Container?l+i.length():l+i.index(r,o)}),i=Math.min(Math.max.apply(Math,o(r)),this.scroll.length()-1),l=Math.min.apply(Math,[i].concat(o(r)));return new _(l,i-l)}},{key:"normalizeNative",value:function(t){if(!l(this.root,t.startContainer)||!t.collapsed&&!l(this.root,t.endContainer))return null;var e={start:{node:t.startContainer,offset:t.startOffset},end:{node:t.endContainer,offset:t.endOffset},native:t};return[e.start,e.end].forEach(function(t){for(var e=t.node,n=t.offset;!(e instanceof Text)&&e.childNodes.length>0;)if(e.childNodes.length>n)e=e.childNodes[n],n=0;else{if(e.childNodes.length!==n)break;e=e.lastChild,n=e instanceof Text?e.data.length:e.childNodes.length+1}t.node=e,t.offset=n}),e}},{key:"rangeToNative",value:function(t){var e=this,n=t.collapsed?[t.index]:[t.index,t.index+t.length],r=[],o=this.scroll.length();return n.forEach(function(t,n){t=Math.min(o-1,t);var i=void 0,l=e.scroll.leaf(t),s=a(l,2),u=s[0],c=s[1],f=u.position(c,0!==n),h=a(f,2);i=h[0],c=h[1],r.push(i,c)}),r.length<2&&(r=r.concat(r)),r}},{key:"scrollIntoView",value:function(t){var e=this.lastRange;if(null!=e){var n=this.getBounds(e.index,e.length);if(null!=n){var r=this.scroll.length()-1,o=this.scroll.line(Math.min(e.index,r)),i=a(o,1),l=i[0],s=l;if(e.length>0){var u=this.scroll.line(Math.min(e.index+e.length,r));s=a(u,1)[0]}if(null!=l&&null!=s){var c=t.getBoundingClientRect();n.top<c.top?t.scrollTop-=c.top-n.top:n.bottom>c.bottom&&(t.scrollTop+=n.bottom-c.bottom)}}}}},{key:"setNativeRange",value:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:e,o=arguments.length>4&&void 0!==arguments[4]&&arguments[4];if(m.info("setNativeRange",t,e,n,r),null==t||null!=this.root.parentNode&&null!=t.parentNode&&null!=n.parentNode){var i=document.getSelection();if(null!=i)if(null!=t){this.hasFocus()||this.root.focus();var l=(this.getNativeRange()||{}).native;if(null==l||o||t!==l.startContainer||e!==l.startOffset||n!==l.endContainer||r!==l.endOffset){"BR"==t.tagName&&(e=[].indexOf.call(t.parentNode.childNodes,t),t=t.parentNode),"BR"==n.tagName&&(r=[].indexOf.call(n.parentNode.childNodes,n),n=n.parentNode);var a=document.createRange();a.setStart(t,e),a.setEnd(n,r),i.removeAllRanges(),i.addRange(a)}}else i.removeAllRanges(),this.root.blur(),document.body.focus()}}},{key:"setRange",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:v.default.sources.API;if("string"==typeof e&&(n=e,e=!1),m.info("setRange",t),null!=t){var r=this.rangeToNative(t);this.setNativeRange.apply(this,o(r).concat([e]))}else this.setNativeRange(null);this.update(n)}},{key:"update",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:v.default.sources.USER,e=this.lastRange,n=this.getRange(),r=a(n,2),o=r[0],i=r[1];if(this.lastRange=o,null!=this.lastRange&&(this.savedRange=this.lastRange),!(0,d.default)(e,this.lastRange)){var l;!this.composing&&null!=i&&i.native.collapsed&&i.start.node!==this.cursor.textNode&&this.cursor.restore();var s=[v.default.events.SELECTION_CHANGE,(0,h.default)(this.lastRange),(0,h.default)(e),t];if((l=this.emitter).emit.apply(l,[v.default.events.EDITOR_CHANGE].concat(s)),t!==v.default.sources.SILENT){var u;(u=this.emitter).emit.apply(u,s)}}}}]),t}();e.Range=_,e.default=O},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function l(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0});var a=n(0),s=r(a),u=n(3),c=r(u),f=function(t){function e(){return o(this,e),i(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return l(e,t),e}(s.default.Container);f.allowedChildren=[c.default,u.BlockEmbed,f],e.default=f},function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0}),e.ColorStyle=e.ColorClass=e.ColorAttributor=void 0;var l=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),a=function t(e,n,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,n,r)}if("value"in o)return o.value;var l=o.get;if(void 0!==l)return l.call(r)},s=n(0),u=function(t){return t&&t.__esModule?t:{default:t}}(s),c=function(t){function e(){return r(this,e),o(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return i(e,t),l(e,[{key:"value",value:function(t){var n=a(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"value",this).call(this,t);return n.startsWith("rgb(")?(n=n.replace(/^[^\d]+/,"").replace(/[^\d]+$/,""),"#"+n.split(",").map(function(t){return("00"+parseInt(t).toString(16)).slice(-2)}).join("")):n}}]),e}(u.default.Attributor.Style),f=new u.default.Attributor.Class("color","ql-color",{scope:u.default.Scope.INLINE}),h=new c("color","color",{scope:u.default.Scope.INLINE});e.ColorAttributor=c,e.ColorClass=f,e.ColorStyle=h},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function l(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function a(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function s(t,e){var n,r=t===D.keys.LEFT?"prefix":"suffix";return n={key:t,shiftKey:e,altKey:null},o(n,r,/^$/),o(n,"handler",function(n){var r=n.index;t===D.keys.RIGHT&&(r+=n.length+1);var o=this.quill.getLeaf(r);return!(b(o,1)[0]instanceof T.default.Embed)||(t===D.keys.LEFT?e?this.quill.setSelection(n.index-1,n.length+1,S.default.sources.USER):this.quill.setSelection(n.index-1,S.default.sources.USER):e?this.quill.setSelection(n.index,n.length+1,S.default.sources.USER):this.quill.setSelection(n.index+n.length+1,S.default.sources.USER),!1)}),n}function u(t,e){if(!(0===t.index||this.quill.getLength()<=1)){var n=this.quill.getLine(t.index),r=b(n,1),o=r[0],i={};if(0===e.offset){var l=this.quill.getLine(t.index-1),a=b(l,1),s=a[0];if(null!=s&&s.length()>1){var u=o.formats(),c=this.quill.getFormat(t.index-1,1);i=A.default.attributes.diff(u,c)||{}}}var f=/[\uD800-\uDBFF][\uDC00-\uDFFF]$/.test(e.prefix)?2:1;this.quill.deleteText(t.index-f,f,S.default.sources.USER),Object.keys(i).length>0&&this.quill.formatLine(t.index-f,f,i,S.default.sources.USER),this.quill.focus()}}function c(t,e){var n=/^[\uD800-\uDBFF][\uDC00-\uDFFF]/.test(e.suffix)?2:1;if(!(t.index>=this.quill.getLength()-n)){var r={},o=0,i=this.quill.getLine(t.index),l=b(i,1),a=l[0];if(e.offset>=a.length()-1){var s=this.quill.getLine(t.index+1),u=b(s,1),c=u[0];if(c){var f=a.formats(),h=this.quill.getFormat(t.index,1);r=A.default.attributes.diff(f,h)||{},o=c.length()}}this.quill.deleteText(t.index,n,S.default.sources.USER),Object.keys(r).length>0&&this.quill.formatLine(t.index+o-1,n,r,S.default.sources.USER)}}function f(t){var e=this.quill.getLines(t),n={};if(e.length>1){var r=e[0].formats(),o=e[e.length-1].formats();n=A.default.attributes.diff(o,r)||{}}this.quill.deleteText(t,S.default.sources.USER),Object.keys(n).length>0&&this.quill.formatLine(t.index,1,n,S.default.sources.USER),this.quill.setSelection(t.index,S.default.sources.SILENT),this.quill.focus()}function h(t,e){var n=this;t.length>0&&this.quill.scroll.deleteAt(t.index,t.length);var r=Object.keys(e.format).reduce(function(t,n){return T.default.query(n,T.default.Scope.BLOCK)&&!Array.isArray(e.format[n])&&(t[n]=e.format[n]),t},{});this.quill.insertText(t.index,"\n",r,S.default.sources.USER),this.quill.setSelection(t.index+1,S.default.sources.SILENT),this.quill.focus(),Object.keys(e.format).forEach(function(t){null==r[t]&&(Array.isArray(e.format[t])||"link"!==t&&n.quill.format(t,e.format[t],S.default.sources.USER))})}function p(t){return{key:D.keys.TAB,shiftKey:!t,format:{"code-block":!0},handler:function(e){var n=T.default.query("code-block"),r=e.index,o=e.length,i=this.quill.scroll.descendant(n,r),l=b(i,2),a=l[0],s=l[1];if(null!=a){var u=this.quill.getIndex(a),c=a.newlineIndex(s,!0)+1,f=a.newlineIndex(u+s+o),h=a.domNode.textContent.slice(c,f).split("\n");s=0,h.forEach(function(e,i){t?(a.insertAt(c+s,n.TAB),s+=n.TAB.length,0===i?r+=n.TAB.length:o+=n.TAB.length):e.startsWith(n.TAB)&&(a.deleteAt(c+s,n.TAB.length),s-=n.TAB.length,0===i?r-=n.TAB.length:o-=n.TAB.length),s+=e.length+1}),this.quill.update(S.default.sources.USER),this.quill.setSelection(r,o,S.default.sources.SILENT)}}}}function d(t){return{key:t[0].toUpperCase(),shortKey:!0,handler:function(e,n){this.quill.format(t,!n.format[t],S.default.sources.USER)}}}function y(t){if("string"==typeof t||"number"==typeof t)return y({key:t});if("object"===(void 0===t?"undefined":v(t))&&(t=(0,_.default)(t,!1)),"string"==typeof t.key)if(null!=D.keys[t.key.toUpperCase()])t.key=D.keys[t.key.toUpperCase()];else{if(1!==t.key.length)return null;t.key=t.key.toUpperCase().charCodeAt(0)}return t.shortKey&&(t[B]=t.shortKey,delete t.shortKey),t}Object.defineProperty(e,"__esModule",{value:!0}),e.SHORTKEY=e.default=void 0;var v="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},b=function(){function t(t,e){var n=[],r=!0,o=!1,i=void 0;try{for(var l,a=t[Symbol.iterator]();!(r=(l=a.next()).done)&&(n.push(l.value),!e||n.length!==e);r=!0);}catch(t){o=!0,i=t}finally{try{!r&&a.return&&a.return()}finally{if(o)throw i}}return n}return function(e,n){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),g=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),m=n(21),_=r(m),O=n(12),w=r(O),x=n(2),k=r(x),E=n(4),N=r(E),j=n(20),A=r(j),q=n(0),T=r(q),P=n(6),S=r(P),C=n(10),L=r(C),M=n(7),R=r(M),I=(0,L.default)("quill:keyboard"),B=/Mac/i.test(navigator.platform)?"metaKey":"ctrlKey",D=function(t){function e(t,n){i(this,e);var r=l(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n));return r.bindings={},Object.keys(r.options.bindings).forEach(function(e){("list autofill"!==e||null==t.scroll.whitelist||t.scroll.whitelist.list)&&r.options.bindings[e]&&r.addBinding(r.options.bindings[e])}),r.addBinding({key:e.keys.ENTER,shiftKey:null},h),r.addBinding({key:e.keys.ENTER,metaKey:null,ctrlKey:null,altKey:null},function(){}),/Firefox/i.test(navigator.userAgent)?(r.addBinding({key:e.keys.BACKSPACE},{collapsed:!0},u),r.addBinding({key:e.keys.DELETE},{collapsed:!0},c)):(r.addBinding({key:e.keys.BACKSPACE},{collapsed:!0,prefix:/^.?$/},u),r.addBinding({key:e.keys.DELETE},{collapsed:!0,suffix:/^.?$/},c)),r.addBinding({key:e.keys.BACKSPACE},{collapsed:!1},f),r.addBinding({key:e.keys.DELETE},{collapsed:!1},f),r.addBinding({key:e.keys.BACKSPACE,altKey:null,ctrlKey:null,metaKey:null,shiftKey:null},{collapsed:!0,offset:0},u),r.listen(),r}return a(e,t),g(e,null,[{key:"match",value:function(t,e){return e=y(e),!["altKey","ctrlKey","metaKey","shiftKey"].some(function(n){return!!e[n]!==t[n]&&null!==e[n]})&&e.key===(t.which||t.keyCode)}}]),g(e,[{key:"addBinding",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=y(t);if(null==r||null==r.key)return I.warn("Attempted to add invalid keyboard binding",r);"function"==typeof e&&(e={handler:e}),"function"==typeof n&&(n={handler:n}),r=(0,k.default)(r,e,n),this.bindings[r.key]=this.bindings[r.key]||[],this.bindings[r.key].push(r)}},{key:"listen",value:function(){var t=this;this.quill.root.addEventListener("keydown",function(n){if(!n.defaultPrevented){var r=n.which||n.keyCode,o=(t.bindings[r]||[]).filter(function(t){return e.match(n,t)});if(0!==o.length){var i=t.quill.getSelection();if(null!=i&&t.quill.hasFocus()){var l=t.quill.getLine(i.index),a=b(l,2),s=a[0],u=a[1],c=t.quill.getLeaf(i.index),f=b(c,2),h=f[0],p=f[1],d=0===i.length?[h,p]:t.quill.getLeaf(i.index+i.length),y=b(d,2),g=y[0],m=y[1],_=h instanceof T.default.Text?h.value().slice(0,p):"",O=g instanceof T.default.Text?g.value().slice(m):"",x={collapsed:0===i.length,empty:0===i.length&&s.length()<=1,format:t.quill.getFormat(i),offset:u,prefix:_,suffix:O};o.some(function(e){if(null!=e.collapsed&&e.collapsed!==x.collapsed)return!1;if(null!=e.empty&&e.empty!==x.empty)return!1;if(null!=e.offset&&e.offset!==x.offset)return!1;if(Array.isArray(e.format)){if(e.format.every(function(t){return null==x.format[t]}))return!1}else if("object"===v(e.format)&&!Object.keys(e.format).every(function(t){return!0===e.format[t]?null!=x.format[t]:!1===e.format[t]?null==x.format[t]:(0,w.default)(e.format[t],x.format[t])}))return!1;return!(null!=e.prefix&&!e.prefix.test(x.prefix))&&(!(null!=e.suffix&&!e.suffix.test(x.suffix))&&!0!==e.handler.call(t,i,x))})&&n.preventDefault()}}}})}}]),e}(R.default);D.keys={BACKSPACE:8,TAB:9,ENTER:13,ESCAPE:27,LEFT:37,UP:38,RIGHT:39,DOWN:40,DELETE:46},D.DEFAULTS={bindings:{bold:d("bold"),italic:d("italic"),underline:d("underline"),indent:{key:D.keys.TAB,format:["blockquote","indent","list"],handler:function(t,e){if(e.collapsed&&0!==e.offset)return!0;this.quill.format("indent","+1",S.default.sources.USER)}},outdent:{key:D.keys.TAB,shiftKey:!0,format:["blockquote","indent","list"],handler:function(t,e){if(e.collapsed&&0!==e.offset)return!0;this.quill.format("indent","-1",S.default.sources.USER)}},"outdent backspace":{key:D.keys.BACKSPACE,collapsed:!0,shiftKey:null,metaKey:null,ctrlKey:null,altKey:null,format:["indent","list"],offset:0,handler:function(t,e){null!=e.format.indent?this.quill.format("indent","-1",S.default.sources.USER):null!=e.format.list&&this.quill.format("list",!1,S.default.sources.USER)}},"indent code-block":p(!0),"outdent code-block":p(!1),"remove tab":{key:D.keys.TAB,shiftKey:!0,collapsed:!0,prefix:/\t$/,handler:function(t){this.quill.deleteText(t.index-1,1,S.default.sources.USER)}},tab:{key:D.keys.TAB,handler:function(t){this.quill.history.cutoff();var e=(new N.default).retain(t.index).delete(t.length).insert("\t");this.quill.updateContents(e,S.default.sources.USER),this.quill.history.cutoff(),this.quill.setSelection(t.index+1,S.default.sources.SILENT)}},"list empty enter":{key:D.keys.ENTER,collapsed:!0,format:["list"],empty:!0,handler:function(t,e){this.quill.format("list",!1,S.default.sources.USER),e.format.indent&&this.quill.format("indent",!1,S.default.sources.USER)}},"checklist enter":{key:D.keys.ENTER,collapsed:!0,format:{list:"checked"},handler:function(t){var e=this.quill.getLine(t.index),n=b(e,2),r=n[0],o=n[1],i=(0,k.default)({},r.formats(),{list:"checked"}),l=(new N.default).retain(t.index).insert("\n",i).retain(r.length()-o-1).retain(1,{list:"unchecked"});this.quill.updateContents(l,S.default.sources.USER),this.quill.setSelection(t.index+1,S.default.sources.SILENT),this.quill.scrollIntoView()}},"header enter":{key:D.keys.ENTER,collapsed:!0,format:["header"],suffix:/^$/,handler:function(t,e){var n=this.quill.getLine(t.index),r=b(n,2),o=r[0],i=r[1],l=(new N.default).retain(t.index).insert("\n",e.format).retain(o.length()-i-1).retain(1,{header:null});this.quill.updateContents(l,S.default.sources.USER),this.quill.setSelection(t.index+1,S.default.sources.SILENT),this.quill.scrollIntoView()}},"list autofill":{key:" ",collapsed:!0,format:{list:!1},prefix:/^\s*?(\d+\.|-|\*|\[ ?\]|\[x\])$/,handler:function(t,e){var n=e.prefix.length,r=this.quill.getLine(t.index),o=b(r,2),i=o[0],l=o[1];if(l>n)return!0;var a=void 0;switch(e.prefix.trim()){case"[]":case"[ ]":a="unchecked";break;case"[x]":a="checked";break;case"-":case"*":a="bullet";break;default:a="ordered"}this.quill.insertText(t.index," ",S.default.sources.USER),this.quill.history.cutoff();var s=(new N.default).retain(t.index-l).delete(n+1).retain(i.length()-2-l).retain(1,{list:a});this.quill.updateContents(s,S.default.sources.USER),this.quill.history.cutoff(),this.quill.setSelection(t.index-n,S.default.sources.SILENT)}},"code exit":{key:D.keys.ENTER,collapsed:!0,format:["code-block"],prefix:/\n\n$/,suffix:/^\s+$/,handler:function(t){var e=this.quill.getLine(t.index),n=b(e,2),r=n[0],o=n[1],i=(new N.default).retain(t.index+r.length()-o-2).retain(1,{"code-block":null}).delete(1);this.quill.updateContents(i,S.default.sources.USER)}},"embed left":s(D.keys.LEFT,!1),"embed left shift":s(D.keys.LEFT,!0),"embed right":s(D.keys.RIGHT,!1),"embed right shift":s(D.keys.RIGHT,!0)}},e.default=D,e.SHORTKEY=B},function(t,e,n){"use strict";t.exports={align:{"":n(75),center:n(76),right:n(77),justify:n(78)},background:n(79),blockquote:n(80),bold:n(81),clean:n(82),code:n(40),"code-block":n(40),color:n(83),direction:{"":n(84),rtl:n(85)},float:{center:n(86),full:n(87),left:n(88),right:n(89)},formula:n(90),header:{1:n(91),2:n(92)},italic:n(93),image:n(94),indent:{"+1":n(95),"-1":n(96)},link:n(97),list:{ordered:n(98),bullet:n(99),check:n(100)},script:{sub:n(101),super:n(102)},strike:n(103),underline:n(104),video:n(105)}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=n(1),o=function(){function t(t){this.domNode=t,this.domNode[r.DATA_KEY]={blot:this}}return Object.defineProperty(t.prototype,"statics",{get:function(){return this.constructor},enumerable:!0,configurable:!0}),t.create=function(t){if(null==this.tagName)throw new r.ParchmentError("Blot definition missing tagName");var e;return Array.isArray(this.tagName)?("string"==typeof t&&(t=t.toUpperCase(),parseInt(t).toString()===t&&(t=parseInt(t))),e="number"==typeof t?document.createElement(this.tagName[t-1]):this.tagName.indexOf(t)>-1?document.createElement(t):document.createElement(this.tagName[0])):e=document.createElement(this.tagName),this.className&&e.classList.add(this.className),e},t.prototype.attach=function(){null!=this.parent&&(this.scroll=this.parent.scroll)},t.prototype.clone=function(){var t=this.domNode.cloneNode(!1);return r.create(t)},t.prototype.detach=function(){null!=this.parent&&this.parent.removeChild(this),delete this.domNode[r.DATA_KEY]},t.prototype.deleteAt=function(t,e){this.isolate(t,e).remove()},t.prototype.formatAt=function(t,e,n,o){var i=this.isolate(t,e);if(null!=r.query(n,r.Scope.BLOT)&&o)i.wrap(n,o);else if(null!=r.query(n,r.Scope.ATTRIBUTE)){var l=r.create(this.statics.scope);i.wrap(l),l.format(n,o)}},t.prototype.insertAt=function(t,e,n){var o=null==n?r.create("text",e):r.create(e,n),i=this.split(t);this.parent.insertBefore(o,i)},t.prototype.insertInto=function(t,e){void 0===e&&(e=null),null!=this.parent&&this.parent.children.remove(this);var n=null;t.children.insertBefore(this,e),null!=e&&(n=e.domNode),this.domNode.parentNode==t.domNode&&this.domNode.nextSibling==n||t.domNode.insertBefore(this.domNode,n),this.parent=t,this.attach()},t.prototype.isolate=function(t,e){var n=this.split(t);return n.split(e),n},t.prototype.length=function(){return 1},t.prototype.offset=function(t){return void 0===t&&(t=this.parent),null==this.parent||this==t?0:this.parent.children.offset(this)+this.parent.offset(t)},t.prototype.optimize=function(t){null!=this.domNode[r.DATA_KEY]&&delete this.domNode[r.DATA_KEY].mutations},t.prototype.remove=function(){null!=this.domNode.parentNode&&this.domNode.parentNode.removeChild(this.domNode),this.detach()},t.prototype.replace=function(t){null!=t.parent&&(t.parent.insertBefore(this,t.next),t.remove())},t.prototype.replaceWith=function(t,e){var n="string"==typeof t?r.create(t,e):t;return n.replace(this),n},t.prototype.split=function(t,e){return 0===t?this:this.next},t.prototype.update=function(t,e){},t.prototype.wrap=function(t,e){var n="string"==typeof t?r.create(t,e):t;return null!=this.parent&&this.parent.insertBefore(n,this.next),n.appendChild(this),n},t.blotName="abstract",t}();e.default=o},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=n(11),o=n(29),i=n(30),l=n(1),a=function(){function t(t){this.attributes={},this.domNode=t,this.build()}return t.prototype.attribute=function(t,e){e?t.add(this.domNode,e)&&(null!=t.value(this.domNode)?this.attributes[t.attrName]=t:delete this.attributes[t.attrName]):(t.remove(this.domNode),delete this.attributes[t.attrName])},t.prototype.build=function(){var t=this;this.attributes={};var e=r.default.keys(this.domNode),n=o.default.keys(this.domNode),a=i.default.keys(this.domNode);e.concat(n).concat(a).forEach(function(e){var n=l.query(e,l.Scope.ATTRIBUTE);n instanceof r.default&&(t.attributes[n.attrName]=n)})},t.prototype.copy=function(t){var e=this;Object.keys(this.attributes).forEach(function(n){var r=e.attributes[n].value(e.domNode);t.format(n,r)})},t.prototype.move=function(t){var e=this;this.copy(t),Object.keys(this.attributes).forEach(function(t){e.attributes[t].remove(e.domNode)}),this.attributes={}},t.prototype.values=function(){var t=this;return Object.keys(this.attributes).reduce(function(e,n){return e[n]=t.attributes[n].value(t.domNode),e},{})},t}();e.default=a},function(t,e,n){"use strict";function r(t,e){return(t.getAttribute("class")||"").split(/\s+/).filter(function(t){return 0===t.indexOf(e+"-")})}var o=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(e,n){function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();Object.defineProperty(e,"__esModule",{value:!0});var i=n(11),l=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return o(e,t),e.keys=function(t){return(t.getAttribute("class")||"").split(/\s+/).map(function(t){return t.split("-").slice(0,-1).join("-")})},e.prototype.add=function(t,e){return!!this.canAdd(t,e)&&(this.remove(t),t.classList.add(this.keyName+"-"+e),!0)},e.prototype.remove=function(t){r(t,this.keyName).forEach(function(e){t.classList.remove(e)}),0===t.classList.length&&t.removeAttribute("class")},e.prototype.value=function(t){var e=r(t,this.keyName)[0]||"",n=e.slice(this.keyName.length+1);return this.canAdd(t,n)?n:""},e}(i.default);e.default=l},function(t,e,n){"use strict";function r(t){var e=t.split("-"),n=e.slice(1).map(function(t){return t[0].toUpperCase()+t.slice(1)}).join("");return e[0]+n}var o=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(e,n){function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();Object.defineProperty(e,"__esModule",{value:!0});var i=n(11),l=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return o(e,t),e.keys=function(t){return(t.getAttribute("style")||"").split(";").map(function(t){return t.split(":")[0].trim()})},e.prototype.add=function(t,e){return!!this.canAdd(t,e)&&(t.style[r(this.keyName)]=e,!0)},e.prototype.remove=function(t){t.style[r(this.keyName)]="",t.getAttribute("style")||t.removeAttribute("style")},e.prototype.value=function(t){var e=t.style[r(this.keyName)];return this.canAdd(t,e)?e:""},e}(i.default);e.default=l},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function l(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0});var a=function(){function t(t,e){var n=[],r=!0,o=!1,i=void 0;try{for(var l,a=t[Symbol.iterator]();!(r=(l=a.next()).done)&&(n.push(l.value),!e||n.length!==e);r=!0);}catch(t){o=!0,i=t}finally{try{!r&&a.return&&a.return()}finally{if(o)throw i}}return n}return function(e,n){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),s=function t(e,n,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,n,r)}if("value"in o)return o.value;var l=o.get;if(void 0!==l)return l.call(r)},u=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),c=n(0),f=r(c),h=n(8),p=r(h),d=function(t){function e(t,n){o(this,e);var r=i(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return r.selection=n,r.textNode=document.createTextNode(e.CONTENTS),r.domNode.appendChild(r.textNode),r._length=0,r}return l(e,t),u(e,null,[{key:"value",value:function(){}}]),u(e,[{key:"detach",value:function(){null!=this.parent&&this.parent.removeChild(this)}},{key:"format",value:function(t,n){if(0!==this._length)return s(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"format",this).call(this,t,n);for(var r=this,o=0;null!=r&&r.statics.scope!==f.default.Scope.BLOCK_BLOT;)o+=r.offset(r.parent),r=r.parent;null!=r&&(this._length=e.CONTENTS.length,r.optimize(),r.formatAt(o,e.CONTENTS.length,t,n),this._length=0)}},{key:"index",value:function(t,n){return t===this.textNode?0:s(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"index",this).call(this,t,n)}},{key:"length",value:function(){return this._length}},{key:"position",value:function(){return[this.textNode,this.textNode.data.length]}},{key:"remove",value:function(){s(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"remove",this).call(this),this.parent=null}},{key:"restore",value:function(){if(!this.selection.composing&&null!=this.parent){var t=this.textNode,n=this.selection.getNativeRange(),r=void 0,o=void 0,i=void 0;if(null!=n&&n.start.node===t&&n.end.node===t){var l=[t,n.start.offset,n.end.offset];r=l[0],o=l[1],i=l[2]}for(;null!=this.domNode.lastChild&&this.domNode.lastChild!==this.textNode;)this.domNode.parentNode.insertBefore(this.domNode.lastChild,this.domNode);if(this.textNode.data!==e.CONTENTS){var s=this.textNode.data.split(e.CONTENTS).join("");this.next instanceof p.default?(r=this.next.domNode,this.next.insertAt(0,s),this.textNode.data=e.CONTENTS):(this.textNode.data=s,this.parent.insertBefore(f.default.create(this.textNode),this),this.textNode=document.createTextNode(e.CONTENTS),this.domNode.appendChild(this.textNode))}if(this.remove(),null!=o){var u=[o,i].map(function(t){return Math.max(0,Math.min(r.data.length,t-1))}),c=a(u,2);return o=c[0],i=c[1],{startNode:r,startOffset:o,endNode:r,endOffset:i}}}}},{key:"update",value:function(t,e){var n=this;if(t.some(function(t){return"characterData"===t.type&&t.target===n.textNode})){var r=this.restore();r&&(e.range=r)}}},{key:"value",value:function(){return""}}]),e}(f.default.Embed);d.blotName="cursor",d.className="ql-cursor",d.tagName="span",d.CONTENTS="\ufeff",e.default=d},function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0});var o=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),i=function(){function t(e,n){r(this,t),this.quill=e,this.options=n,this.modules={}}return o(t,[{key:"init",value:function(){var t=this;Object.keys(this.options.modules).forEach(function(e){null==t.modules[e]&&t.addModule(e)})}},{key:"addModule",value:function(t){var e=this.quill.constructor.import("modules/"+t);return this.modules[t]=new e(this.quill,this.options.modules[t]||{}),this.modules[t]}}]),t}();i.DEFAULTS={modules:{}},i.themes={default:i},e.default=i},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function l(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0});var a=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),s=function t(e,n,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,n,r)}if("value"in o)return o.value;var l=o.get;if(void 0!==l)return l.call(r)},u=n(0),c=r(u),f=n(8),h=r(f),p="\ufeff",d=function(t){function e(t){o(this,e);var n=i(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return n.contentNode=document.createElement("span"),n.contentNode.setAttribute("contenteditable",!1),[].slice.call(n.domNode.childNodes).forEach(function(t){n.contentNode.appendChild(t)}),n.leftGuard=document.createTextNode(p),n.rightGuard=document.createTextNode(p),n.domNode.appendChild(n.leftGuard),n.domNode.appendChild(n.contentNode),n.domNode.appendChild(n.rightGuard),n}return l(e,t),a(e,[{key:"index",value:function(t,n){return t===this.leftGuard?0:t===this.rightGuard?1:s(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"index",this).call(this,t,n)}},{key:"restore",value:function(t){var e=void 0,n=void 0,r=t.data.split(p).join("");if(t===this.leftGuard)if(this.prev instanceof h.default){var o=this.prev.length();this.prev.insertAt(o,r),e={startNode:this.prev.domNode,startOffset:o+r.length}}else n=document.createTextNode(r),this.parent.insertBefore(c.default.create(n),this),e={startNode:n,startOffset:r.length};else t===this.rightGuard&&(this.next instanceof h.default?(this.next.insertAt(0,r),e={startNode:this.next.domNode,startOffset:r.length}):(n=document.createTextNode(r),this.parent.insertBefore(c.default.create(n),this.next),e={startNode:n,startOffset:r.length}));return t.data=p,e}},{key:"update",value:function(t,e){var n=this;t.forEach(function(t){if("characterData"===t.type&&(t.target===n.leftGuard||t.target===n.rightGuard)){var r=n.restore(t.target);r&&(e.range=r)}})}}]),e}(c.default.Embed);e.default=d},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.AlignStyle=e.AlignClass=e.AlignAttribute=void 0;var r=n(0),o=function(t){return t&&t.__esModule?t:{default:t}}(r),i={scope:o.default.Scope.BLOCK,whitelist:["right","center","justify"]},l=new o.default.Attributor.Attribute("align","align",i),a=new o.default.Attributor.Class("align","ql-align",i),s=new o.default.Attributor.Style("align","text-align",i);e.AlignAttribute=l,e.AlignClass=a,e.AlignStyle=s},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.BackgroundStyle=e.BackgroundClass=void 0;var r=n(0),o=function(t){return t&&t.__esModule?t:{default:t}}(r),i=n(24),l=new o.default.Attributor.Class("background","ql-bg",{scope:o.default.Scope.INLINE}),a=new i.ColorAttributor("background","background-color",{scope:o.default.Scope.INLINE});e.BackgroundClass=l,e.BackgroundStyle=a},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.DirectionStyle=e.DirectionClass=e.DirectionAttribute=void 0;var r=n(0),o=function(t){return t&&t.__esModule?t:{default:t}}(r),i={scope:o.default.Scope.BLOCK,whitelist:["rtl"]},l=new o.default.Attributor.Attribute("direction","dir",i),a=new o.default.Attributor.Class("direction","ql-direction",i),s=new o.default.Attributor.Style("direction","direction",i);e.DirectionAttribute=l,e.DirectionClass=a,e.DirectionStyle=s},function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0}),e.FontClass=e.FontStyle=void 0;var l=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),a=function t(e,n,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,n,r)}if("value"in o)return o.value;var l=o.get;if(void 0!==l)return l.call(r)},s=n(0),u=function(t){return t&&t.__esModule?t:{default:t}}(s),c={scope:u.default.Scope.INLINE,whitelist:["serif","monospace"]},f=new u.default.Attributor.Class("font","ql-font",c),h=function(t){function e(){return r(this,e),o(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return i(e,t),l(e,[{key:"value",value:function(t){return a(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"value",this).call(this,t).replace(/["']/g,"")}}]),e}(u.default.Attributor.Style),p=new h("font","font-family",c);e.FontStyle=p,e.FontClass=f},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.SizeStyle=e.SizeClass=void 0;var r=n(0),o=function(t){return t&&t.__esModule?t:{default:t}}(r),i=new o.default.Attributor.Class("size","ql-size",{scope:o.default.Scope.INLINE,whitelist:["small","large","huge"]}),l=new o.default.Attributor.Style("size","font-size",{scope:o.default.Scope.INLINE,whitelist:["10px","18px","32px"]});e.SizeClass=i,e.SizeStyle=l},function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0});var l=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),a=function t(e,n,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,n,r)}if("value"in o)return o.value;var l=o.get;if(void 0!==l)return l.call(r)},s=n(5),u=function(t){return t&&t.__esModule?t:{default:t}}(s),c=function(t){function e(){return r(this,e),o(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return i(e,t),l(e,[{key:"optimize",value:function(t){a(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"optimize",this).call(this,t),this.domNode.tagName!==this.statics.tagName[0]&&this.replaceWith(this.statics.blotName)}}],[{key:"create",value:function(){return a(e.__proto__||Object.getPrototypeOf(e),"create",this).call(this)}},{key:"formats",value:function(){return!0}}]),e}(u.default);c.blotName="bold",c.tagName=["STRONG","B"],e.default=c},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <polyline class="ql-even ql-stroke" points="5 7 3 9 5 11"></polyline> <polyline class="ql-even ql-stroke" points="13 7 15 9 13 11"></polyline> <line class=ql-stroke x1=10 x2=8 y1=5 y2=13></line> </svg>'},function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0});var l=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),a=function t(e,n,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,n,r)}if("value"in o)return o.value;var l=o.get;if(void 0!==l)return l.call(r)},s=n(16),u=function(t){return t&&t.__esModule?t:{default:t}}(s),c=function(t){function e(t,n){r(this,e);var i=o(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return i.label.innerHTML=n,i.container.classList.add("ql-color-picker"),[].slice.call(i.container.querySelectorAll(".ql-picker-item"),0,7).forEach(function(t){t.classList.add("ql-primary")}),i}return i(e,t),l(e,[{key:"buildItem",value:function(t){var n=a(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"buildItem",this).call(this,t);return n.style.backgroundColor=t.getAttribute("value")||"",n}},{key:"selectItem",value:function(t,n){a(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"selectItem",this).call(this,t,n);var r=this.label.querySelector(".ql-color-label"),o=t?t.getAttribute("data-value")||"":"";r&&("line"===r.tagName?r.style.stroke=o:r.style.fill=o)}}]),e}(u.default);e.default=c},function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0});var l=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),a=function t(e,n,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,n,r)}if("value"in o)return o.value;var l=o.get;if(void 0!==l)return l.call(r)},s=n(16),u=function(t){return t&&t.__esModule?t:{default:t}}(s),c=function(t){function e(t,n){r(this,e);var i=o(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return i.container.classList.add("ql-icon-picker"),[].forEach.call(i.container.querySelectorAll(".ql-picker-item"),function(t){t.innerHTML=n[t.getAttribute("data-value")||""]}),i.defaultItem=i.container.querySelector(".ql-selected"),i.selectItem(i.defaultItem),i}return i(e,t),l(e,[{key:"selectItem",value:function(t,n){a(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"selectItem",this).call(this,t,n),t=t||this.defaultItem,this.label.innerHTML=t.innerHTML}}]),e}(u.default);e.default=c},function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0});var o=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),i=function(){function t(e,n){var o=this;r(this,t),this.quill=e,this.boundsContainer=n||document.body,this.root=e.addContainer("ql-tooltip"),this.root.innerHTML=this.constructor.TEMPLATE,this.quill.root===this.quill.scrollingContainer&&this.quill.root.addEventListener("scroll",function(){o.root.style.marginTop=-1*o.quill.root.scrollTop+"px"}),this.hide()}return o(t,[{key:"hide",value:function(){this.root.classList.add("ql-hidden")}},{key:"position",value:function(t){var e=t.left+t.width/2-this.root.offsetWidth/2,n=t.bottom+this.quill.root.scrollTop;this.root.style.left=e+"px",this.root.style.top=n+"px",this.root.classList.remove("ql-flip");var r=this.boundsContainer.getBoundingClientRect(),o=this.root.getBoundingClientRect(),i=0;if(o.right>r.right&&(i=r.right-o.right,this.root.style.left=e+i+"px"),o.left<r.left&&(i=r.left-o.left,this.root.style.left=e+i+"px"),o.bottom>r.bottom){var l=o.bottom-o.top,a=t.bottom-t.top+l;this.root.style.top=n-a+"px",this.root.classList.add("ql-flip")}return i}},{key:"show",value:function(){this.root.classList.remove("ql-editing"),this.root.classList.remove("ql-hidden")}}]),t}();e.default=i},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function l(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function a(t){var e=t.match(/^(?:(https?):\/\/)?(?:(?:www|m)\.)?youtube\.com\/watch.*v=([a-zA-Z0-9_-]+)/)||t.match(/^(?:(https?):\/\/)?(?:(?:www|m)\.)?youtu\.be\/([a-zA-Z0-9_-]+)/);return e?(e[1]||"https")+"://www.youtube.com/embed/"+e[2]+"?showinfo=0":(e=t.match(/^(?:(https?):\/\/)?(?:www\.)?vimeo\.com\/(\d+)/))?(e[1]||"https")+"://player.vimeo.com/video/"+e[2]+"/":t}function s(t,e){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];e.forEach(function(e){var r=document.createElement("option");e===n?r.setAttribute("selected","selected"):r.setAttribute("value",e),t.appendChild(r)})}Object.defineProperty(e,"__esModule",{value:!0}),e.default=e.BaseTooltip=void 0;var u=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),c=function t(e,n,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,n,r)}if("value"in o)return o.value;var l=o.get;if(void 0!==l)return l.call(r)},f=n(2),h=r(f),p=n(4),d=r(p),y=n(9),v=r(y),b=n(25),g=r(b),m=n(32),_=r(m),O=n(41),w=r(O),x=n(42),k=r(x),E=n(16),N=r(E),j=n(43),A=r(j),q=[!1,"center","right","justify"],T=["#000000","#e60000","#ff9900","#ffff00","#008a00","#0066cc","#9933ff","#ffffff","#facccc","#ffebcc","#ffffcc","#cce8cc","#cce0f5","#ebd6ff","#bbbbbb","#f06666","#ffc266","#ffff66","#66b966","#66a3e0","#c285ff","#888888","#a10000","#b26b00","#b2b200","#006100","#0047b2","#6b24b2","#444444","#5c0000","#663d00","#666600","#003700","#002966","#3d1466"],P=[!1,"serif","monospace"],S=["1","2","3",!1],C=["small",!1,"large","huge"],L=function(t){function e(t,n){o(this,e);var r=i(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n)),l=function e(n){if(!document.body.contains(t.root))return document.body.removeEventListener("click",e);null==r.tooltip||r.tooltip.root.contains(n.target)||document.activeElement===r.tooltip.textbox||r.quill.hasFocus()||r.tooltip.hide(),null!=r.pickers&&r.pickers.forEach(function(t){t.container.contains(n.target)||t.close()})};return t.emitter.listenDOM("click",document.body,l),r}return l(e,t),u(e,[{key:"addModule",value:function(t){var n=c(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"addModule",this).call(this,t);return"toolbar"===t&&this.extendToolbar(n),n}},{key:"buildButtons",value:function(t,e){t.forEach(function(t){(t.getAttribute("class")||"").split(/\s+/).forEach(function(n){if(n.startsWith("ql-")&&(n=n.slice("ql-".length),null!=e[n]))if("direction"===n)t.innerHTML=e[n][""]+e[n].rtl;else if("string"==typeof e[n])t.innerHTML=e[n];else{var r=t.value||"";null!=r&&e[n][r]&&(t.innerHTML=e[n][r])}})})}},{key:"buildPickers",value:function(t,e){var n=this;this.pickers=t.map(function(t){if(t.classList.contains("ql-align"))return null==t.querySelector("option")&&s(t,q),new k.default(t,e.align);if(t.classList.contains("ql-background")||t.classList.contains("ql-color")){var n=t.classList.contains("ql-background")?"background":"color";return null==t.querySelector("option")&&s(t,T,"background"===n?"#ffffff":"#000000"),new w.default(t,e[n])}return null==t.querySelector("option")&&(t.classList.contains("ql-font")?s(t,P):t.classList.contains("ql-header")?s(t,S):t.classList.contains("ql-size")&&s(t,C)),new N.default(t)});var r=function(){n.pickers.forEach(function(t){t.update()})};this.quill.on(v.default.events.EDITOR_CHANGE,r)}}]),e}(_.default);L.DEFAULTS=(0,h.default)(!0,{},_.default.DEFAULTS,{modules:{toolbar:{handlers:{formula:function(){this.quill.theme.tooltip.edit("formula")},image:function(){var t=this,e=this.container.querySelector("input.ql-image[type=file]");null==e&&(e=document.createElement("input"),e.setAttribute("type","file"),e.setAttribute("accept","image/png, image/gif, image/jpeg, image/bmp, image/x-icon"),e.classList.add("ql-image"),e.addEventListener("change",function(){if(null!=e.files&&null!=e.files[0]){var n=new FileReader;n.onload=function(n){var r=t.quill.getSelection(!0);t.quill.updateContents((new d.default).retain(r.index).delete(r.length).insert({image:n.target.result}),v.default.sources.USER),t.quill.setSelection(r.index+1,v.default.sources.SILENT),e.value=""},n.readAsDataURL(e.files[0])}}),this.container.appendChild(e)),e.click()},video:function(){this.quill.theme.tooltip.edit("video")}}}}});var M=function(t){function e(t,n){o(this,e);var r=i(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n));return r.textbox=r.root.querySelector('input[type="text"]'),r.listen(),r}return l(e,t),u(e,[{key:"listen",value:function(){var t=this;this.textbox.addEventListener("keydown",function(e){g.default.match(e,"enter")?(t.save(),e.preventDefault()):g.default.match(e,"escape")&&(t.cancel(),e.preventDefault())})}},{key:"cancel",value:function(){this.hide()}},{key:"edit",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"link",e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;this.root.classList.remove("ql-hidden"),this.root.classList.add("ql-editing"),null!=e?this.textbox.value=e:t!==this.root.getAttribute("data-mode")&&(this.textbox.value=""),this.position(this.quill.getBounds(this.quill.selection.savedRange)),this.textbox.select(),this.textbox.setAttribute("placeholder",this.textbox.getAttribute("data-"+t)||""),this.root.setAttribute("data-mode",t)}},{key:"restoreFocus",value:function(){var t=this.quill.scrollingContainer.scrollTop;this.quill.focus(),this.quill.scrollingContainer.scrollTop=t}},{key:"save",value:function(){var t=this.textbox.value;switch(this.root.getAttribute("data-mode")){case"link":var e=this.quill.root.scrollTop;this.linkRange?(this.quill.formatText(this.linkRange,"link",t,v.default.sources.USER),delete this.linkRange):(this.restoreFocus(),this.quill.format("link",t,v.default.sources.USER)),this.quill.root.scrollTop=e;break;case"video":t=a(t);case"formula":if(!t)break;var n=this.quill.getSelection(!0);if(null!=n){var r=n.index+n.length;this.quill.insertEmbed(r,this.root.getAttribute("data-mode"),t,v.default.sources.USER),"formula"===this.root.getAttribute("data-mode")&&this.quill.insertText(r+1," ",v.default.sources.USER),this.quill.setSelection(r+2,v.default.sources.USER)}}this.textbox.value="",this.hide()}}]),e}(A.default);e.BaseTooltip=M,e.default=L},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}Object.defineProperty(e,"__esModule",{value:!0});var o=n(46),i=r(o),l=n(34),a=n(36),s=n(62),u=n(63),c=r(u),f=n(64),h=r(f),p=n(65),d=r(p),y=n(35),v=n(24),b=n(37),g=n(38),m=n(39),_=r(m),O=n(66),w=r(O),x=n(15),k=r(x),E=n(67),N=r(E),j=n(68),A=r(j),q=n(69),T=r(q),P=n(70),S=r(P),C=n(71),L=r(C),M=n(13),R=r(M),I=n(72),B=r(I),D=n(73),U=r(D),F=n(74),H=r(F),K=n(26),z=r(K),Z=n(16),V=r(Z),W=n(41),G=r(W),Y=n(42),X=r(Y),$=n(43),Q=r($),J=n(107),tt=r(J),et=n(108),nt=r(et);i.default.register({"attributors/attribute/direction":a.DirectionAttribute,"attributors/class/align":l.AlignClass,"attributors/class/background":y.BackgroundClass,"attributors/class/color":v.ColorClass,"attributors/class/direction":a.DirectionClass,"attributors/class/font":b.FontClass,"attributors/class/size":g.SizeClass,"attributors/style/align":l.AlignStyle,"attributors/style/background":y.BackgroundStyle,"attributors/style/color":v.ColorStyle,"attributors/style/direction":a.DirectionStyle,"attributors/style/font":b.FontStyle,"attributors/style/size":g.SizeStyle},!0),i.default.register({"formats/align":l.AlignClass,"formats/direction":a.DirectionClass,"formats/indent":s.IndentClass,"formats/background":y.BackgroundStyle,"formats/color":v.ColorStyle,"formats/font":b.FontClass,"formats/size":g.SizeClass,"formats/blockquote":c.default,"formats/code-block":R.default,"formats/header":h.default,"formats/list":d.default,"formats/bold":_.default,"formats/code":M.Code,"formats/italic":w.default,"formats/link":k.default,"formats/script":N.default,"formats/strike":A.default,"formats/underline":T.default,"formats/image":S.default,"formats/video":L.default,"formats/list/item":p.ListItem,"modules/formula":B.default,"modules/syntax":U.default,"modules/toolbar":H.default,"themes/bubble":tt.default,"themes/snow":nt.default,"ui/icons":z.default,"ui/picker":V.default,"ui/icon-picker":X.default,"ui/color-picker":G.default,"ui/tooltip":Q.default},!0),e.default=i.default},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}Object.defineProperty(e,"__esModule",{value:!0});var o=n(0),i=r(o),l=n(6),a=r(l),s=n(3),u=r(s),c=n(14),f=r(c),h=n(23),p=r(h),d=n(31),y=r(d),v=n(33),b=r(v),g=n(5),m=r(g),_=n(59),O=r(_),w=n(8),x=r(w),k=n(60),E=r(k),N=n(61),j=r(N),A=n(25),q=r(A);a.default.register({"blots/block":u.default,"blots/block/embed":s.BlockEmbed,"blots/break":f.default,"blots/container":p.default,"blots/cursor":y.default,"blots/embed":b.default,"blots/inline":m.default,"blots/scroll":O.default,"blots/text":x.default,"modules/clipboard":E.default,"modules/history":j.default,"modules/keyboard":q.default}),i.default.register(u.default,f.default,y.default,m.default,O.default,x.default),e.default=a.default},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(){this.head=this.tail=null,this.length=0}return t.prototype.append=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this.insertBefore(t[0],null),t.length>1&&this.append.apply(this,t.slice(1))},t.prototype.contains=function(t){for(var e,n=this.iterator();e=n();)if(e===t)return!0;return!1},t.prototype.insertBefore=function(t,e){t&&(t.next=e,null!=e?(t.prev=e.prev,null!=e.prev&&(e.prev.next=t),e.prev=t,e===this.head&&(this.head=t)):null!=this.tail?(this.tail.next=t,t.prev=this.tail,this.tail=t):(t.prev=null,this.head=this.tail=t),this.length+=1)},t.prototype.offset=function(t){for(var e=0,n=this.head;null!=n;){if(n===t)return e;e+=n.length(),n=n.next}return-1},t.prototype.remove=function(t){this.contains(t)&&(null!=t.prev&&(t.prev.next=t.next),null!=t.next&&(t.next.prev=t.prev),t===this.head&&(this.head=t.next),t===this.tail&&(this.tail=t.prev),this.length-=1)},t.prototype.iterator=function(t){return void 0===t&&(t=this.head),function(){var e=t;return null!=t&&(t=t.next),e}},t.prototype.find=function(t,e){void 0===e&&(e=!1);for(var n,r=this.iterator();n=r();){var o=n.length();if(t<o||e&&t===o&&(null==n.next||0!==n.next.length()))return[n,t];t-=o}return[null,0]},t.prototype.forEach=function(t){for(var e,n=this.iterator();e=n();)t(e)},t.prototype.forEachAt=function(t,e,n){if(!(e<=0))for(var r,o=this.find(t),i=o[0],l=o[1],a=t-l,s=this.iterator(i);(r=s())&&a<t+e;){var u=r.length();t>a?n(r,t-a,Math.min(e,a+u-t)):n(r,0,Math.min(u,t+e-a)),a+=u}},t.prototype.map=function(t){return this.reduce(function(e,n){return e.push(t(n)),e},[])},t.prototype.reduce=function(t,e){for(var n,r=this.iterator();n=r();)e=t(e,n);return e},t}();e.default=r},function(t,e,n){"use strict";var r=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(e,n){function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();Object.defineProperty(e,"__esModule",{value:!0});var o=n(17),i=n(1),l={attributes:!0,characterData:!0,characterDataOldValue:!0,childList:!0,subtree:!0},a=function(t){function e(e){var n=t.call(this,e)||this;return n.scroll=n,n.observer=new MutationObserver(function(t){n.update(t)}),n.observer.observe(n.domNode,l),n.attach(),n}return r(e,t),e.prototype.detach=function(){t.prototype.detach.call(this),this.observer.disconnect()},e.prototype.deleteAt=function(e,n){this.update(),0===e&&n===this.length()?this.children.forEach(function(t){t.remove()}):t.prototype.deleteAt.call(this,e,n)},e.prototype.formatAt=function(e,n,r,o){this.update(),t.prototype.formatAt.call(this,e,n,r,o)},e.prototype.insertAt=function(e,n,r){this.update(),t.prototype.insertAt.call(this,e,n,r)},e.prototype.optimize=function(e,n){var r=this;void 0===e&&(e=[]),void 0===n&&(n={}),t.prototype.optimize.call(this,n);for(var l=[].slice.call(this.observer.takeRecords());l.length>0;)e.push(l.pop());for(var a=function(t,e){void 0===e&&(e=!0),null!=t&&t!==r&&null!=t.domNode.parentNode&&(null==t.domNode[i.DATA_KEY].mutations&&(t.domNode[i.DATA_KEY].mutations=[]),e&&a(t.parent))},s=function(t){null!=t.domNode[i.DATA_KEY]&&null!=t.domNode[i.DATA_KEY].mutations&&(t instanceof o.default&&t.children.forEach(s),t.optimize(n))},u=e,c=0;u.length>0;c+=1){if(c>=100)throw new Error("[Parchment] Maximum optimize iterations reached");for(u.forEach(function(t){var e=i.find(t.target,!0);null!=e&&(e.domNode===t.target&&("childList"===t.type?(a(i.find(t.previousSibling,!1)),[].forEach.call(t.addedNodes,function(t){var e=i.find(t,!1);a(e,!1),e instanceof o.default&&e.children.forEach(function(t){a(t,!1)})})):"attributes"===t.type&&a(e.prev)),a(e))}),this.children.forEach(s),u=[].slice.call(this.observer.takeRecords()),l=u.slice();l.length>0;)e.push(l.pop())}},e.prototype.update=function(e,n){var r=this;void 0===n&&(n={}),e=e||this.observer.takeRecords(),e.map(function(t){var e=i.find(t.target,!0);return null==e?null:null==e.domNode[i.DATA_KEY].mutations?(e.domNode[i.DATA_KEY].mutations=[t],e):(e.domNode[i.DATA_KEY].mutations.push(t),null)}).forEach(function(t){null!=t&&t!==r&&null!=t.domNode[i.DATA_KEY]&&t.update(t.domNode[i.DATA_KEY].mutations||[],n)}),null!=this.domNode[i.DATA_KEY].mutations&&t.prototype.update.call(this,this.domNode[i.DATA_KEY].mutations,n),this.optimize(e,n)},e.blotName="scroll",e.defaultChild="block",e.scope=i.Scope.BLOCK_BLOT,e.tagName="DIV",e}(o.default);e.default=a},function(t,e,n){"use strict";function r(t,e){if(Object.keys(t).length!==Object.keys(e).length)return!1;for(var n in t)if(t[n]!==e[n])return!1;return!0}var o=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(e,n){function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();Object.defineProperty(e,"__esModule",{value:!0});var i=n(18),l=n(1),a=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return o(e,t),e.formats=function(n){if(n.tagName!==e.tagName)return t.formats.call(this,n)},e.prototype.format=function(n,r){var o=this;n!==this.statics.blotName||r?t.prototype.format.call(this,n,r):(this.children.forEach(function(t){t instanceof i.default||(t=t.wrap(e.blotName,!0)),o.attributes.copy(t)}),this.unwrap())},e.prototype.formatAt=function(e,n,r,o){if(null!=this.formats()[r]||l.query(r,l.Scope.ATTRIBUTE)){this.isolate(e,n).format(r,o)}else t.prototype.formatAt.call(this,e,n,r,o)},e.prototype.optimize=function(n){t.prototype.optimize.call(this,n);var o=this.formats();if(0===Object.keys(o).length)return this.unwrap();var i=this.next;i instanceof e&&i.prev===this&&r(o,i.formats())&&(i.moveChildren(this),i.remove())},e.blotName="inline",e.scope=l.Scope.INLINE_BLOT,e.tagName="SPAN",e}(i.default);e.default=a},function(t,e,n){"use strict";var r=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(e,n){function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();Object.defineProperty(e,"__esModule",{value:!0});var o=n(18),i=n(1),l=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return r(e,t),e.formats=function(n){var r=i.query(e.blotName).tagName;if(n.tagName!==r)return t.formats.call(this,n)},e.prototype.format=function(n,r){null!=i.query(n,i.Scope.BLOCK)&&(n!==this.statics.blotName||r?t.prototype.format.call(this,n,r):this.replaceWith(e.blotName))},e.prototype.formatAt=function(e,n,r,o){null!=i.query(r,i.Scope.BLOCK)?this.format(r,o):t.prototype.formatAt.call(this,e,n,r,o)},e.prototype.insertAt=function(e,n,r){if(null==r||null!=i.query(n,i.Scope.INLINE))t.prototype.insertAt.call(this,e,n,r);else{var o=this.split(e),l=i.create(n,r);o.parent.insertBefore(l,o)}},e.prototype.update=function(e,n){navigator.userAgent.match(/Trident/)?this.build():t.prototype.update.call(this,e,n)},e.blotName="block",e.scope=i.Scope.BLOCK_BLOT,e.tagName="P",e}(o.default);e.default=l},function(t,e,n){"use strict";var r=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(e,n){function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();Object.defineProperty(e,"__esModule",{value:!0});var o=n(19),i=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return r(e,t),e.formats=function(t){},e.prototype.format=function(e,n){t.prototype.formatAt.call(this,0,this.length(),e,n)},e.prototype.formatAt=function(e,n,r,o){0===e&&n===this.length()?this.format(r,o):t.prototype.formatAt.call(this,e,n,r,o)},e.prototype.formats=function(){return this.statics.formats(this.domNode)},e}(o.default);e.default=i},function(t,e,n){"use strict";var r=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(e,n){function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();Object.defineProperty(e,"__esModule",{value:!0});var o=n(19),i=n(1),l=function(t){function e(e){var n=t.call(this,e)||this;return n.text=n.statics.value(n.domNode),n}return r(e,t),e.create=function(t){return document.createTextNode(t)},e.value=function(t){var e=t.data;return e.normalize&&(e=e.normalize()),e},e.prototype.deleteAt=function(t,e){this.domNode.data=this.text=this.text.slice(0,t)+this.text.slice(t+e)},e.prototype.index=function(t,e){return this.domNode===t?e:-1},e.prototype.insertAt=function(e,n,r){null==r?(this.text=this.text.slice(0,e)+n+this.text.slice(e),this.domNode.data=this.text):t.prototype.insertAt.call(this,e,n,r)},e.prototype.length=function(){return this.text.length},e.prototype.optimize=function(n){t.prototype.optimize.call(this,n),this.text=this.statics.value(this.domNode),0===this.text.length?this.remove():this.next instanceof e&&this.next.prev===this&&(this.insertAt(this.length(),this.next.value()),this.next.remove())},e.prototype.position=function(t,e){return void 0===e&&(e=!1),[this.domNode,t]},e.prototype.split=function(t,e){if(void 0===e&&(e=!1),!e){if(0===t)return this;if(t===this.length())return this.next}var n=i.create(this.domNode.splitText(t));return this.parent.insertBefore(n,this.next),this.text=this.statics.value(this.domNode),n},e.prototype.update=function(t,e){var n=this;t.some(function(t){return"characterData"===t.type&&t.target===n.domNode})&&(this.text=this.statics.value(this.domNode))},e.prototype.value=function(){return this.text},e.blotName="text",e.scope=i.Scope.INLINE_BLOT,e}(o.default);e.default=l},function(t,e,n){"use strict";var r=document.createElement("div");if(r.classList.toggle("test-class",!1),r.classList.contains("test-class")){var o=DOMTokenList.prototype.toggle;DOMTokenList.prototype.toggle=function(t,e){return arguments.length>1&&!this.contains(t)==!e?e:o.call(this,t)}}String.prototype.startsWith||(String.prototype.startsWith=function(t,e){return e=e||0,this.substr(e,t.length)===t}),String.prototype.endsWith||(String.prototype.endsWith=function(t,e){var n=this.toString();("number"!=typeof e||!isFinite(e)||Math.floor(e)!==e||e>n.length)&&(e=n.length),e-=t.length;var r=n.indexOf(t,e);return-1!==r&&r===e}),Array.prototype.find||Object.defineProperty(Array.prototype,"find",{value:function(t){if(null===this)throw new TypeError("Array.prototype.find called on null or undefined");if("function"!=typeof t)throw new TypeError("predicate must be a function");for(var e,n=Object(this),r=n.length>>>0,o=arguments[1],i=0;i<r;i++)if(e=n[i],t.call(o,e,i,n))return e}}),document.addEventListener("DOMContentLoaded",function(){document.execCommand("enableObjectResizing",!1,!1),document.execCommand("autoUrlDetect",!1,!1)})},function(t,e){function n(t,e,n){if(t==e)return t?[[v,t]]:[];(n<0||t.length<n)&&(n=null);var o=l(t,e),i=t.substring(0,o);t=t.substring(o),e=e.substring(o),o=a(t,e);var s=t.substring(t.length-o);t=t.substring(0,t.length-o),e=e.substring(0,e.length-o);var c=r(t,e);return i&&c.unshift([v,i]),s&&c.push([v,s]),u(c),null!=n&&(c=f(c,n)),c=h(c)}function r(t,e){var r;if(!t)return[[y,e]];if(!e)return[[d,t]];var i=t.length>e.length?t:e,l=t.length>e.length?e:t,a=i.indexOf(l);if(-1!=a)return r=[[y,i.substring(0,a)],[v,l],[y,i.substring(a+l.length)]],t.length>e.length&&(r[0][0]=r[2][0]=d),r;if(1==l.length)return[[d,t],[y,e]];var u=s(t,e);if(u){var c=u[0],f=u[1],h=u[2],p=u[3],b=u[4],g=n(c,h),m=n(f,p);return g.concat([[v,b]],m)}return o(t,e)}function o(t,e){for(var n=t.length,r=e.length,o=Math.ceil((n+r)/2),l=o,a=2*o,s=new Array(a),u=new Array(a),c=0;c<a;c++)s[c]=-1,u[c]=-1;s[l+1]=0,u[l+1]=0;for(var f=n-r,h=f%2!=0,p=0,v=0,b=0,g=0,m=0;m<o;m++){for(var _=-m+p;_<=m-v;_+=2){var O,w=l+_;O=_==-m||_!=m&&s[w-1]<s[w+1]?s[w+1]:s[w-1]+1;for(var x=O-_;O<n&&x<r&&t.charAt(O)==e.charAt(x);)O++,x++;if(s[w]=O,O>n)v+=2;else if(x>r)p+=2;else if(h){var k=l+f-_;if(k>=0&&k<a&&-1!=u[k]){var E=n-u[k];if(O>=E)return i(t,e,O,x)}}}for(var N=-m+b;N<=m-g;N+=2){var E,k=l+N;E=N==-m||N!=m&&u[k-1]<u[k+1]?u[k+1]:u[k-1]+1;for(var j=E-N;E<n&&j<r&&t.charAt(n-E-1)==e.charAt(r-j-1);)E++,j++;if(u[k]=E,E>n)g+=2;else if(j>r)b+=2;else if(!h){var w=l+f-N;if(w>=0&&w<a&&-1!=s[w]){var O=s[w],x=l+O-w;if(E=n-E,O>=E)return i(t,e,O,x)}}}}return[[d,t],[y,e]]}function i(t,e,r,o){var i=t.substring(0,r),l=e.substring(0,o),a=t.substring(r),s=e.substring(o),u=n(i,l),c=n(a,s);return u.concat(c)}function l(t,e){if(!t||!e||t.charAt(0)!=e.charAt(0))return 0;for(var n=0,r=Math.min(t.length,e.length),o=r,i=0;n<o;)t.substring(i,o)==e.substring(i,o)?(n=o,i=n):r=o,o=Math.floor((r-n)/2+n);return o}function a(t,e){if(!t||!e||t.charAt(t.length-1)!=e.charAt(e.length-1))return 0;for(var n=0,r=Math.min(t.length,e.length),o=r,i=0;n<o;)t.substring(t.length-o,t.length-i)==e.substring(e.length-o,e.length-i)?(n=o,i=n):r=o,o=Math.floor((r-n)/2+n);return o}function s(t,e){function n(t,e,n){for(var r,o,i,s,u=t.substring(n,n+Math.floor(t.length/4)),c=-1,f="";-1!=(c=e.indexOf(u,c+1));){var h=l(t.substring(n),e.substring(c)),p=a(t.substring(0,n),e.substring(0,c));f.length<p+h&&(f=e.substring(c-p,c)+e.substring(c,c+h),r=t.substring(0,n-p),o=t.substring(n+h),i=e.substring(0,c-p),s=e.substring(c+h))}return 2*f.length>=t.length?[r,o,i,s,f]:null}var r=t.length>e.length?t:e,o=t.length>e.length?e:t;if(r.length<4||2*o.length<r.length)return null;var i,s=n(r,o,Math.ceil(r.length/4)),u=n(r,o,Math.ceil(r.length/2));if(!s&&!u)return null;i=u?s&&s[4].length>u[4].length?s:u:s;var c,f,h,p;return t.length>e.length?(c=i[0],f=i[1],h=i[2],p=i[3]):(h=i[0],p=i[1],c=i[2],f=i[3]),[c,f,h,p,i[4]]}function u(t){t.push([v,""]);for(var e,n=0,r=0,o=0,i="",s="";n<t.length;)switch(t[n][0]){case y:o++,s+=t[n][1],n++;break;case d:r++,i+=t[n][1],n++;break;case v:r+o>1?(0!==r&&0!==o&&(e=l(s,i),0!==e&&(n-r-o>0&&t[n-r-o-1][0]==v?t[n-r-o-1][1]+=s.substring(0,e):(t.splice(0,0,[v,s.substring(0,e)]),n++),s=s.substring(e),i=i.substring(e)),0!==(e=a(s,i))&&(t[n][1]=s.substring(s.length-e)+t[n][1],s=s.substring(0,s.length-e),i=i.substring(0,i.length-e))),0===r?t.splice(n-o,r+o,[y,s]):0===o?t.splice(n-r,r+o,[d,i]):t.splice(n-r-o,r+o,[d,i],[y,s]),n=n-r-o+(r?1:0)+(o?1:0)+1):0!==n&&t[n-1][0]==v?(t[n-1][1]+=t[n][1],t.splice(n,1)):n++,o=0,r=0,i="",s=""}""===t[t.length-1][1]&&t.pop();var c=!1;for(n=1;n<t.length-1;)t[n-1][0]==v&&t[n+1][0]==v&&(t[n][1].substring(t[n][1].length-t[n-1][1].length)==t[n-1][1]?(t[n][1]=t[n-1][1]+t[n][1].substring(0,t[n][1].length-t[n-1][1].length),t[n+1][1]=t[n-1][1]+t[n+1][1],t.splice(n-1,1),c=!0):t[n][1].substring(0,t[n+1][1].length)==t[n+1][1]&&(t[n-1][1]+=t[n+1][1],t[n][1]=t[n][1].substring(t[n+1][1].length)+t[n+1][1],t.splice(n+1,1),c=!0)),n++;c&&u(t)}function c(t,e){if(0===e)return[v,t];for(var n=0,r=0;r<t.length;r++){var o=t[r];if(o[0]===d||o[0]===v){var i=n+o[1].length;if(e===i)return[r+1,t];if(e<i){t=t.slice();var l=e-n,a=[o[0],o[1].slice(0,l)],s=[o[0],o[1].slice(l)];return t.splice(r,1,a,s),[r+1,t]}n=i}}throw new Error("cursor_pos is out of bounds!")}function f(t,e){var n=c(t,e),r=n[1],o=n[0],i=r[o],l=r[o+1];if(null==i)return t;if(i[0]!==v)return t;if(null!=l&&i[1]+l[1]===l[1]+i[1])return r.splice(o,2,l,i),p(r,o,2);if(null!=l&&0===l[1].indexOf(i[1])){r.splice(o,2,[l[0],i[1]],[0,i[1]]);var a=l[1].slice(i[1].length);return a.length>0&&r.splice(o+2,0,[l[0],a]),p(r,o,3)}return t}function h(t){for(var e=!1,n=function(t){return t.charCodeAt(0)>=56320&&t.charCodeAt(0)<=57343},r=2;r<t.length;r+=1)t[r-2][0]===v&&function(t){return t.charCodeAt(t.length-1)>=55296&&t.charCodeAt(t.length-1)<=56319}(t[r-2][1])&&t[r-1][0]===d&&n(t[r-1][1])&&t[r][0]===y&&n(t[r][1])&&(e=!0,t[r-1][1]=t[r-2][1].slice(-1)+t[r-1][1],t[r][1]=t[r-2][1].slice(-1)+t[r][1],t[r-2][1]=t[r-2][1].slice(0,-1));if(!e)return t;for(var o=[],r=0;r<t.length;r+=1)t[r][1].length>0&&o.push(t[r]);return o}function p(t,e,n){for(var r=e+n-1;r>=0&&r>=e-1;r--)if(r+1<t.length){var o=t[r],i=t[r+1];o[0]===i[1]&&t.splice(r,2,[o[0],o[1]+i[1]])}return t}var d=-1,y=1,v=0,b=n;b.INSERT=y,b.DELETE=d,b.EQUAL=v,t.exports=b},function(t,e){function n(t){var e=[];for(var n in t)e.push(n);return e}e=t.exports="function"==typeof Object.keys?Object.keys:n,e.shim=n},function(t,e){function n(t){return"[object Arguments]"==Object.prototype.toString.call(t)}function r(t){return t&&"object"==typeof t&&"number"==typeof t.length&&Object.prototype.hasOwnProperty.call(t,"callee")&&!Object.prototype.propertyIsEnumerable.call(t,"callee")||!1}var o="[object Arguments]"==function(){return Object.prototype.toString.call(arguments)}();e=t.exports=o?n:r,e.supported=n,e.unsupported=r},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function l(t,e){return Object.keys(e).reduce(function(n,r){return null==t[r]?n:(e[r]===t[r]?n[r]=e[r]:Array.isArray(e[r])?e[r].indexOf(t[r])<0&&(n[r]=e[r].concat([t[r]])):n[r]=[e[r],t[r]],n)},{})}function a(t){return t.reduce(function(t,e){if(1===e.insert){var n=(0,N.default)(e.attributes);return delete n.image,t.insert({image:e.attributes.image},n)}if(null==e.attributes||!0!==e.attributes.list&&!0!==e.attributes.bullet||(e=(0,N.default)(e),e.attributes.list?e.attributes.list="ordered":(e.attributes.list="bullet",delete e.attributes.bullet)),"string"==typeof e.insert){var r=e.insert.replace(/\r\n/g,"\n").replace(/\r/g,"\n");return t.insert(r,e.attributes)}return t.push(e)},new h.default)}Object.defineProperty(e,"__esModule",{value:!0});var s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},u=function(){function t(t,e){var n=[],r=!0,o=!1,i=void 0;try{for(var l,a=t[Symbol.iterator]();!(r=(l=a.next()).done)&&(n.push(l.value),!e||n.length!==e);r=!0);}catch(t){o=!0,i=t}finally{try{!r&&a.return&&a.return()}finally{if(o)throw i}}return n}return function(e,n){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),c=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),f=n(4),h=r(f),p=n(20),d=r(p),y=n(0),v=r(y),b=n(13),g=r(b),m=n(31),_=r(m),O=n(3),w=r(O),x=n(14),k=r(x),E=n(21),N=r(E),j=n(12),A=r(j),q=n(2),T=r(q),P=/^[ -~]*$/,S=function(){function t(e){i(this,t),this.scroll=e,this.delta=this.getDelta()}return c(t,[{key:"applyDelta",value:function(t){var e=this,n=!1;this.scroll.update();var r=this.scroll.length();return this.scroll.batchStart(),t=a(t),t.reduce(function(t,o){var i=o.retain||o.delete||o.insert.length||1,l=o.attributes||{};if(null!=o.insert){if("string"==typeof o.insert){var a=o.insert;a.endsWith("\n")&&n&&(n=!1,a=a.slice(0,-1)),t>=r&&!a.endsWith("\n")&&(n=!0),e.scroll.insertAt(t,a);var c=e.scroll.line(t),f=u(c,2),h=f[0],p=f[1],y=(0,T.default)({},(0,O.bubbleFormats)(h));if(h instanceof w.default){var b=h.descendant(v.default.Leaf,p),g=u(b,1),m=g[0];y=(0,T.default)(y,(0,O.bubbleFormats)(m))}l=d.default.attributes.diff(y,l)||{}}else if("object"===s(o.insert)){var _=Object.keys(o.insert)[0];if(null==_)return t;e.scroll.insertAt(t,_,o.insert[_])}r+=i}return Object.keys(l).forEach(function(n){e.scroll.formatAt(t,i,n,l[n])}),t+i},0),t.reduce(function(t,n){return"number"==typeof n.delete?(e.scroll.deleteAt(t,n.delete),t):t+(n.retain||n.insert.length||1)},0),this.scroll.batchEnd(),this.update(t)}},{key:"deleteText",value:function(t,e){return this.scroll.deleteAt(t,e),this.update((new h.default).retain(t).delete(e))}},{key:"formatLine",value:function(t,e){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return this.scroll.update(),Object.keys(r).forEach(function(o){if(null==n.scroll.whitelist||n.scroll.whitelist[o]){var i=n.scroll.lines(t,Math.max(e,1)),l=e;i.forEach(function(e){var i=e.length();if(e instanceof g.default){var a=t-e.offset(n.scroll),s=e.newlineIndex(a+l)-a+1;e.formatAt(a,s,o,r[o])}else e.format(o,r[o]);l-=i})}}),this.scroll.optimize(),this.update((new h.default).retain(t).retain(e,(0,N.default)(r)))}},{key:"formatText",value:function(t,e){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return Object.keys(r).forEach(function(o){n.scroll.formatAt(t,e,o,r[o])}),this.update((new h.default).retain(t).retain(e,(0,N.default)(r)))}},{key:"getContents",value:function(t,e){return this.delta.slice(t,t+e)}},{key:"getDelta",value:function(){return this.scroll.lines().reduce(function(t,e){return t.concat(e.delta())},new h.default)}},{key:"getFormat",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=[],r=[];0===e?this.scroll.path(t).forEach(function(t){var e=u(t,1),o=e[0];o instanceof w.default?n.push(o):o instanceof v.default.Leaf&&r.push(o)}):(n=this.scroll.lines(t,e),r=this.scroll.descendants(v.default.Leaf,t,e));var o=[n,r].map(function(t){if(0===t.length)return{};for(var e=(0,O.bubbleFormats)(t.shift());Object.keys(e).length>0;){var n=t.shift();if(null==n)return e;e=l((0,O.bubbleFormats)(n),e)}return e});return T.default.apply(T.default,o)}},{key:"getText",value:function(t,e){return this.getContents(t,e).filter(function(t){return"string"==typeof t.insert}).map(function(t){return t.insert}).join("")}},{key:"insertEmbed",value:function(t,e,n){return this.scroll.insertAt(t,e,n),this.update((new h.default).retain(t).insert(o({},e,n)))}},{key:"insertText",value:function(t,e){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return e=e.replace(/\r\n/g,"\n").replace(/\r/g,"\n"),this.scroll.insertAt(t,e),Object.keys(r).forEach(function(o){n.scroll.formatAt(t,e.length,o,r[o])}),this.update((new h.default).retain(t).insert(e,(0,N.default)(r)))}},{key:"isBlank",value:function(){if(0==this.scroll.children.length)return!0;if(this.scroll.children.length>1)return!1;var t=this.scroll.children.head;return t.statics.blotName===w.default.blotName&&(!(t.children.length>1)&&t.children.head instanceof k.default)}},{key:"removeFormat",value:function(t,e){var n=this.getText(t,e),r=this.scroll.line(t+e),o=u(r,2),i=o[0],l=o[1],a=0,s=new h.default;null!=i&&(a=i instanceof g.default?i.newlineIndex(l)-l+1:i.length()-l,s=i.delta().slice(l,l+a-1).insert("\n"));var c=this.getContents(t,e+a),f=c.diff((new h.default).insert(n).concat(s)),p=(new h.default).retain(t).concat(f);return this.applyDelta(p)}},{key:"update",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0,r=this.delta;if(1===e.length&&"characterData"===e[0].type&&e[0].target.data.match(P)&&v.default.find(e[0].target)){var o=v.default.find(e[0].target),i=(0,O.bubbleFormats)(o),l=o.offset(this.scroll),a=e[0].oldValue.replace(_.default.CONTENTS,""),s=(new h.default).insert(a),u=(new h.default).insert(o.value());t=(new h.default).retain(l).concat(s.diff(u,n)).reduce(function(t,e){return e.insert?t.insert(e.insert,i):t.push(e)},new h.default),this.delta=r.compose(t)}else this.delta=this.getDelta(),t&&(0,A.default)(r.compose(t),this.delta)||(t=r.diff(this.delta,n));return t}}]),t}();e.default=S},function(t,e){"use strict";function n(){}function r(t,e,n){this.fn=t,this.context=e,this.once=n||!1}function o(){this._events=new n,this._eventsCount=0}var i=Object.prototype.hasOwnProperty,l="~";Object.create&&(n.prototype=Object.create(null),(new n).__proto__||(l=!1)),o.prototype.eventNames=function(){var t,e,n=[];if(0===this._eventsCount)return n;for(e in t=this._events)i.call(t,e)&&n.push(l?e.slice(1):e);return Object.getOwnPropertySymbols?n.concat(Object.getOwnPropertySymbols(t)):n},o.prototype.listeners=function(t,e){var n=l?l+t:t,r=this._events[n];if(e)return!!r;if(!r)return[];if(r.fn)return[r.fn];for(var o=0,i=r.length,a=new Array(i);o<i;o++)a[o]=r[o].fn;return a},o.prototype.emit=function(t,e,n,r,o,i){var a=l?l+t:t;if(!this._events[a])return!1;var s,u,c=this._events[a],f=arguments.length;if(c.fn){switch(c.once&&this.removeListener(t,c.fn,void 0,!0),f){case 1:return c.fn.call(c.context),!0;case 2:return c.fn.call(c.context,e),!0;case 3:return c.fn.call(c.context,e,n),!0;case 4:return c.fn.call(c.context,e,n,r),!0;case 5:return c.fn.call(c.context,e,n,r,o),!0;case 6:return c.fn.call(c.context,e,n,r,o,i),!0}for(u=1,s=new Array(f-1);u<f;u++)s[u-1]=arguments[u];c.fn.apply(c.context,s)}else{var h,p=c.length;for(u=0;u<p;u++)switch(c[u].once&&this.removeListener(t,c[u].fn,void 0,!0),f){case 1:c[u].fn.call(c[u].context);break;case 2:c[u].fn.call(c[u].context,e);break;case 3:c[u].fn.call(c[u].context,e,n);break;case 4:c[u].fn.call(c[u].context,e,n,r);break;default:if(!s)for(h=1,s=new Array(f-1);h<f;h++)s[h-1]=arguments[h];c[u].fn.apply(c[u].context,s)}}return!0},o.prototype.on=function(t,e,n){var o=new r(e,n||this),i=l?l+t:t;return this._events[i]?this._events[i].fn?this._events[i]=[this._events[i],o]:this._events[i].push(o):(this._events[i]=o,this._eventsCount++),this},o.prototype.once=function(t,e,n){var o=new r(e,n||this,!0),i=l?l+t:t;return this._events[i]?this._events[i].fn?this._events[i]=[this._events[i],o]:this._events[i].push(o):(this._events[i]=o,this._eventsCount++),this},o.prototype.removeListener=function(t,e,r,o){var i=l?l+t:t;if(!this._events[i])return this;if(!e)return 0==--this._eventsCount?this._events=new n:delete this._events[i],this;var a=this._events[i];if(a.fn)a.fn!==e||o&&!a.once||r&&a.context!==r||(0==--this._eventsCount?this._events=new n:delete this._events[i]);else{for(var s=0,u=[],c=a.length;s<c;s++)(a[s].fn!==e||o&&!a[s].once||r&&a[s].context!==r)&&u.push(a[s]);u.length?this._events[i]=1===u.length?u[0]:u:0==--this._eventsCount?this._events=new n:delete this._events[i]}return this},o.prototype.removeAllListeners=function(t){var e;return t?(e=l?l+t:t,this._events[e]&&(0==--this._eventsCount?this._events=new n:delete this._events[e])):(this._events=new n,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prototype.setMaxListeners=function(){return this},o.prefixed=l,o.EventEmitter=o,void 0!==t&&(t.exports=o)},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function l(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function a(t){return t instanceof v.default||t instanceof y.BlockEmbed}Object.defineProperty(e,"__esModule",{value:!0});var s=function(){function t(t,e){var n=[],r=!0,o=!1,i=void 0;try{for(var l,a=t[Symbol.iterator]();!(r=(l=a.next()).done)&&(n.push(l.value),!e||n.length!==e);r=!0);}catch(t){o=!0,i=t}finally{try{!r&&a.return&&a.return()}finally{if(o)throw i}}return n}return function(e,n){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),u=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),c=function t(e,n,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,n,r)}if("value"in o)return o.value;var l=o.get;if(void 0!==l)return l.call(r)},f=n(0),h=r(f),p=n(9),d=r(p),y=n(3),v=r(y),b=n(14),g=r(b),m=n(13),_=r(m),O=n(23),w=r(O),x=function(t){function e(t,n){o(this,e);var r=i(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return r.emitter=n.emitter,Array.isArray(n.whitelist)&&(r.whitelist=n.whitelist.reduce(function(t,e){return t[e]=!0,t},{})),r.domNode.addEventListener("DOMNodeInserted",function(){}),r.optimize(),r.enable(),r}return l(e,t),u(e,[{key:"batchStart",value:function(){this.batch=!0}},{key:"batchEnd",value:function(){this.batch=!1,this.optimize()}},{key:"deleteAt",value:function(t,n){var r=this.line(t),o=s(r,2),i=o[0],l=o[1],a=this.line(t+n),u=s(a,1),f=u[0];if(c(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"deleteAt",this).call(this,t,n),null!=f&&i!==f&&l>0){if(i instanceof y.BlockEmbed||f instanceof y.BlockEmbed)return void this.optimize();if(i instanceof _.default){var h=i.newlineIndex(i.length(),!0);if(h>-1&&(i=i.split(h+1))===f)return void this.optimize()}else if(f instanceof _.default){var p=f.newlineIndex(0);p>-1&&f.split(p+1)}var d=f.children.head instanceof g.default?null:f.children.head;i.moveChildren(f,d),i.remove()}this.optimize()}},{key:"enable",value:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.domNode.setAttribute("contenteditable",t)}},{key:"formatAt",value:function(t,n,r,o){(null==this.whitelist||this.whitelist[r])&&(c(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"formatAt",this).call(this,t,n,r,o),this.optimize())}},{key:"insertAt",value:function(t,n,r){if(null==r||null==this.whitelist||this.whitelist[n]){if(t>=this.length())if(null==r||null==h.default.query(n,h.default.Scope.BLOCK)){var o=h.default.create(this.statics.defaultChild);this.appendChild(o),null==r&&n.endsWith("\n")&&(n=n.slice(0,-1)),o.insertAt(0,n,r)}else{var i=h.default.create(n,r);this.appendChild(i)}else c(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"insertAt",this).call(this,t,n,r);this.optimize()}}},{key:"insertBefore",value:function(t,n){if(t.statics.scope===h.default.Scope.INLINE_BLOT){var r=h.default.create(this.statics.defaultChild);r.appendChild(t),t=r}c(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"insertBefore",this).call(this,t,n)}},{key:"leaf",value:function(t){return this.path(t).pop()||[null,-1]}},{key:"line",value:function(t){return t===this.length()?this.line(t-1):this.descendant(a,t)}},{key:"lines",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Number.MAX_VALUE;return function t(e,n,r){var o=[],i=r;return e.children.forEachAt(n,r,function(e,n,r){a(e)?o.push(e):e instanceof h.default.Container&&(o=o.concat(t(e,n,i))),i-=r}),o}(this,t,e)}},{key:"optimize",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};!0!==this.batch&&(c(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"optimize",this).call(this,t,n),t.length>0&&this.emitter.emit(d.default.events.SCROLL_OPTIMIZE,t,n))}},{key:"path",value:function(t){return c(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"path",this).call(this,t).slice(1)}},{key:"update",value:function(t){if(!0!==this.batch){var n=d.default.sources.USER;"string"==typeof t&&(n=t),Array.isArray(t)||(t=this.observer.takeRecords()),t.length>0&&this.emitter.emit(d.default.events.SCROLL_BEFORE_UPDATE,n,t),c(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"update",this).call(this,t.concat([])),t.length>0&&this.emitter.emit(d.default.events.SCROLL_UPDATE,n,t)}}}]),e}(h.default.Scroll);x.blotName="scroll",x.className="ql-editor",x.tagName="DIV",x.defaultChild="block",x.allowedChildren=[v.default,y.BlockEmbed,w.default],e.default=x},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function l(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function a(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function s(t,e,n){return"object"===(void 0===e?"undefined":x(e))?Object.keys(e).reduce(function(t,n){return s(t,n,e[n])},t):t.reduce(function(t,r){return r.attributes&&r.attributes[e]?t.push(r):t.insert(r.insert,(0,j.default)({},o({},e,n),r.attributes))},new q.default)}function u(t){if(t.nodeType!==Node.ELEMENT_NODE)return{};return t["__ql-computed-style"]||(t["__ql-computed-style"]=window.getComputedStyle(t))}function c(t,e){for(var n="",r=t.ops.length-1;r>=0&&n.length<e.length;--r){var o=t.ops[r];if("string"!=typeof o.insert)break;n=o.insert+n}return n.slice(-1*e.length)===e}function f(t){return 0!==t.childNodes.length&&["block","list-item"].indexOf(u(t).display)>-1}function h(t,e,n){return t.nodeType===t.TEXT_NODE?n.reduce(function(e,n){return n(t,e)},new q.default):t.nodeType===t.ELEMENT_NODE?[].reduce.call(t.childNodes||[],function(r,o){var i=h(o,e,n);return o.nodeType===t.ELEMENT_NODE&&(i=e.reduce(function(t,e){return e(o,t)},i),i=(o[W]||[]).reduce(function(t,e){return e(o,t)},i)),r.concat(i)},new q.default):new q.default}function p(t,e,n){return s(n,t,!0)}function d(t,e){var n=P.default.Attributor.Attribute.keys(t),r=P.default.Attributor.Class.keys(t),o=P.default.Attributor.Style.keys(t),i={};return n.concat(r).concat(o).forEach(function(e){var n=P.default.query(e,P.default.Scope.ATTRIBUTE);null!=n&&(i[n.attrName]=n.value(t),i[n.attrName])||(n=Y[e],null==n||n.attrName!==e&&n.keyName!==e||(i[n.attrName]=n.value(t)||void 0),null==(n=X[e])||n.attrName!==e&&n.keyName!==e||(n=X[e],i[n.attrName]=n.value(t)||void 0))}),Object.keys(i).length>0&&(e=s(e,i)),e}function y(t,e){var n=P.default.query(t);if(null==n)return e;if(n.prototype instanceof P.default.Embed){var r={},o=n.value(t);null!=o&&(r[n.blotName]=o,e=(new q.default).insert(r,n.formats(t)))}else"function"==typeof n.formats&&(e=s(e,n.blotName,n.formats(t)));return e}function v(t,e){return c(e,"\n")||e.insert("\n"),e}function b(){return new q.default}function g(t,e){var n=P.default.query(t);if(null==n||"list-item"!==n.blotName||!c(e,"\n"))return e;for(var r=-1,o=t.parentNode;!o.classList.contains("ql-clipboard");)"list"===(P.default.query(o)||{}).blotName&&(r+=1),o=o.parentNode;return r<=0?e:e.compose((new q.default).retain(e.length()-1).retain(1,{indent:r}))}function m(t,e){return c(e,"\n")||(f(t)||e.length()>0&&t.nextSibling&&f(t.nextSibling))&&e.insert("\n"),e}function _(t,e){if(f(t)&&null!=t.nextElementSibling&&!c(e,"\n\n")){var n=t.offsetHeight+parseFloat(u(t).marginTop)+parseFloat(u(t).marginBottom);t.nextElementSibling.offsetTop>t.offsetTop+1.5*n&&e.insert("\n")}return e}function O(t,e){var n={},r=t.style||{};return r.fontStyle&&"italic"===u(t).fontStyle&&(n.italic=!0),r.fontWeight&&(u(t).fontWeight.startsWith("bold")||parseInt(u(t).fontWeight)>=700)&&(n.bold=!0),Object.keys(n).length>0&&(e=s(e,n)),parseFloat(r.textIndent||0)>0&&(e=(new q.default).insert("\t").concat(e)),e}function w(t,e){var n=t.data;if("O:P"===t.parentNode.tagName)return e.insert(n.trim());if(0===n.trim().length&&t.parentNode.classList.contains("ql-clipboard"))return e;if(!u(t.parentNode).whiteSpace.startsWith("pre")){var r=function(t,e){return e=e.replace(/[^\u00a0]/g,""),e.length<1&&t?" ":e};n=n.replace(/\r\n/g," ").replace(/\n/g," "),n=n.replace(/\s\s+/g,r.bind(r,!0)),(null==t.previousSibling&&f(t.parentNode)||null!=t.previousSibling&&f(t.previousSibling))&&(n=n.replace(/^\s+/,r.bind(r,!1))),(null==t.nextSibling&&f(t.parentNode)||null!=t.nextSibling&&f(t.nextSibling))&&(n=n.replace(/\s+$/,r.bind(r,!1)))}return e.insert(n)}Object.defineProperty(e,"__esModule",{value:!0}),e.matchText=e.matchSpacing=e.matchNewline=e.matchBlot=e.matchAttributor=e.default=void 0;var x="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},k=function(){function t(t,e){var n=[],r=!0,o=!1,i=void 0;try{for(var l,a=t[Symbol.iterator]();!(r=(l=a.next()).done)&&(n.push(l.value),!e||n.length!==e);r=!0);}catch(t){o=!0,i=t}finally{try{!r&&a.return&&a.return()}finally{if(o)throw i}}return n}return function(e,n){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),E=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),N=n(2),j=r(N),A=n(4),q=r(A),T=n(0),P=r(T),S=n(6),C=r(S),L=n(10),M=r(L),R=n(7),I=r(R),B=n(34),D=n(35),U=n(13),F=r(U),H=n(24),K=n(36),z=n(37),Z=n(38),V=(0,M.default)("quill:clipboard"),W="__ql-matcher",G=[[Node.TEXT_NODE,w],[Node.TEXT_NODE,m],["br",v],[Node.ELEMENT_NODE,m],[Node.ELEMENT_NODE,y],[Node.ELEMENT_NODE,_],[Node.ELEMENT_NODE,d],[Node.ELEMENT_NODE,O],["li",g],["b",p.bind(p,"bold")],["i",p.bind(p,"italic")],["style",b]],Y=[B.AlignAttribute,K.DirectionAttribute].reduce(function(t,e){return t[e.keyName]=e,t},{}),X=[B.AlignStyle,D.BackgroundStyle,H.ColorStyle,K.DirectionStyle,z.FontStyle,Z.SizeStyle].reduce(function(t,e){return t[e.keyName]=e,t},{}),$=function(t){function e(t,n){i(this,e);var r=l(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n));return r.quill.root.addEventListener("paste",r.onPaste.bind(r)),r.container=r.quill.addContainer("ql-clipboard"),r.container.setAttribute("contenteditable",!0),r.container.setAttribute("tabindex",-1),r.matchers=[],G.concat(r.options.matchers).forEach(function(t){var e=k(t,2),o=e[0],i=e[1];(n.matchVisual||i!==_)&&r.addMatcher(o,i)}),r}return a(e,t),E(e,[{key:"addMatcher",value:function(t,e){this.matchers.push([t,e])}},{key:"convert",value:function(t){if("string"==typeof t)return this.container.innerHTML=t.replace(/\>\r?\n +\</g,"><"),this.convert();var e=this.quill.getFormat(this.quill.selection.savedRange.index);if(e[F.default.blotName]){var n=this.container.innerText;return this.container.innerHTML="",(new q.default).insert(n,o({},F.default.blotName,e[F.default.blotName]))}var r=this.prepareMatching(),i=k(r,2),l=i[0],a=i[1],s=h(this.container,l,a);return c(s,"\n")&&null==s.ops[s.ops.length-1].attributes&&(s=s.compose((new q.default).retain(s.length()-1).delete(1))),V.log("convert",this.container.innerHTML,s),this.container.innerHTML="",s}},{key:"dangerouslyPasteHTML",value:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:C.default.sources.API;if("string"==typeof t)this.quill.setContents(this.convert(t),e),this.quill.setSelection(0,C.default.sources.SILENT);else{var r=this.convert(e);this.quill.updateContents((new q.default).retain(t).concat(r),n),this.quill.setSelection(t+r.length(),C.default.sources.SILENT)}}},{key:"onPaste",value:function(t){var e=this;if(!t.defaultPrevented&&this.quill.isEnabled()){var n=this.quill.getSelection(),r=(new q.default).retain(n.index),o=this.quill.scrollingContainer.scrollTop;this.container.focus(),this.quill.selection.update(C.default.sources.SILENT),setTimeout(function(){r=r.concat(e.convert()).delete(n.length),e.quill.updateContents(r,C.default.sources.USER),e.quill.setSelection(r.length()-n.length,C.default.sources.SILENT),e.quill.scrollingContainer.scrollTop=o,e.quill.focus()},1)}}},{key:"prepareMatching",value:function(){var t=this,e=[],n=[];return this.matchers.forEach(function(r){var o=k(r,2),i=o[0],l=o[1];switch(i){case Node.TEXT_NODE:n.push(l);break;case Node.ELEMENT_NODE:e.push(l);break;default:[].forEach.call(t.container.querySelectorAll(i),function(t){t[W]=t[W]||[],t[W].push(l)})}}),[e,n]}}]),e}(I.default);$.DEFAULTS={matchers:[],matchVisual:!0},e.default=$,e.matchAttributor=d,e.matchBlot=y,e.matchNewline=m,e.matchSpacing=_,e.matchText=w},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function l(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function a(t){var e=t.ops[t.ops.length-1];return null!=e&&(null!=e.insert?"string"==typeof e.insert&&e.insert.endsWith("\n"):null!=e.attributes&&Object.keys(e.attributes).some(function(t){return null!=f.default.query(t,f.default.Scope.BLOCK)}))}function s(t){var e=t.reduce(function(t,e){return t+=e.delete||0},0),n=t.length()-e;return a(t)&&(n-=1),n}Object.defineProperty(e,"__esModule",{value:!0}),e.getLastChangeIndex=e.default=void 0;var u=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),c=n(0),f=r(c),h=n(6),p=r(h),d=n(7),y=r(d),v=function(t){function e(t,n){o(this,e);var r=i(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n));return r.lastRecorded=0,r.ignoreChange=!1,r.clear(),r.quill.on(p.default.events.EDITOR_CHANGE,function(t,e,n,o){t!==p.default.events.TEXT_CHANGE||r.ignoreChange||(r.options.userOnly&&o!==p.default.sources.USER?r.transform(e):r.record(e,n))}),r.quill.keyboard.addBinding({key:"Z",shortKey:!0},r.undo.bind(r)),r.quill.keyboard.addBinding({key:"Z",shortKey:!0,shiftKey:!0},r.redo.bind(r)),/Win/i.test(navigator.platform)&&r.quill.keyboard.addBinding({key:"Y",shortKey:!0},r.redo.bind(r)),r}return l(e,t),u(e,[{key:"change",value:function(t,e){if(0!==this.stack[t].length){var n=this.stack[t].pop();this.stack[e].push(n),this.lastRecorded=0,this.ignoreChange=!0,this.quill.updateContents(n[t],p.default.sources.USER),this.ignoreChange=!1;var r=s(n[t]);this.quill.setSelection(r)}}},{key:"clear",value:function(){this.stack={undo:[],redo:[]}}},{key:"cutoff",value:function(){this.lastRecorded=0}},{key:"record",value:function(t,e){if(0!==t.ops.length){this.stack.redo=[];var n=this.quill.getContents().diff(e),r=Date.now();if(this.lastRecorded+this.options.delay>r&&this.stack.undo.length>0){var o=this.stack.undo.pop();n=n.compose(o.undo),t=o.redo.compose(t)}else this.lastRecorded=r;this.stack.undo.push({redo:t,undo:n}),this.stack.undo.length>this.options.maxStack&&this.stack.undo.shift()}}},{key:"redo",value:function(){this.change("redo","undo")}},{key:"transform",value:function(t){this.stack.undo.forEach(function(e){e.undo=t.transform(e.undo,!0),e.redo=t.transform(e.redo,!0)}),this.stack.redo.forEach(function(e){e.undo=t.transform(e.undo,!0),e.redo=t.transform(e.redo,!0)})}},{key:"undo",value:function(){this.change("undo","redo")}}]),e}(y.default);v.DEFAULTS={delay:1e3,maxStack:100,userOnly:!1},e.default=v,e.getLastChangeIndex=s},function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0}),e.IndentClass=void 0;var l=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),a=function t(e,n,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,n,r)}if("value"in o)return o.value;var l=o.get;if(void 0!==l)return l.call(r)},s=n(0),u=function(t){return t&&t.__esModule?t:{default:t}}(s),c=function(t){function e(){return r(this,e),o(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return i(e,t),l(e,[{key:"add",value:function(t,n){if("+1"===n||"-1"===n){var r=this.value(t)||0;n="+1"===n?r+1:r-1}return 0===n?(this.remove(t),!0):a(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"add",this).call(this,t,n)}},{key:"canAdd",value:function(t,n){return a(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"canAdd",this).call(this,t,n)||a(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"canAdd",this).call(this,t,parseInt(n))}},{key:"value",value:function(t){return parseInt(a(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"value",this).call(this,t))||void 0}}]),e}(u.default.Attributor.Class),f=new c("indent","ql-indent",{scope:u.default.Scope.BLOCK,whitelist:[1,2,3,4,5,6,7,8]});e.IndentClass=f},function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0});var l=n(3),a=function(t){return t&&t.__esModule?t:{default:t}}(l),s=function(t){function e(){return r(this,e),o(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return i(e,t),e}(a.default);s.blotName="blockquote",s.tagName="blockquote",e.default=s},function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0});var l=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),a=n(3),s=function(t){return t&&t.__esModule?t:{default:t}}(a),u=function(t){function e(){return r(this,e),o(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return i(e,t),l(e,null,[{key:"formats",value:function(t){return this.tagName.indexOf(t.tagName)+1}}]),e}(s.default);u.blotName="header",u.tagName=["H1","H2","H3","H4","H5","H6"],e.default=u},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function l(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function a(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0}),e.default=e.ListItem=void 0;var s=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),u=function t(e,n,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,n,r)}if("value"in o)return o.value;var l=o.get;if(void 0!==l)return l.call(r)},c=n(0),f=r(c),h=n(3),p=r(h),d=n(23),y=r(d),v=function(t){function e(){return i(this,e),l(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return a(e,t),s(e,[{key:"format",value:function(t,n){t!==b.blotName||n?u(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"format",this).call(this,t,n):this.replaceWith(f.default.create(this.statics.scope))}},{key:"remove",value:function(){null==this.prev&&null==this.next?this.parent.remove():u(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"remove",this).call(this)}},{key:"replaceWith",value:function(t,n){return this.parent.isolate(this.offset(this.parent),this.length()),t===this.parent.statics.blotName?(this.parent.replaceWith(t,n),this):(this.parent.unwrap(),u(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"replaceWith",this).call(this,t,n))}}],[{key:"formats",value:function(t){return t.tagName===this.tagName?void 0:u(e.__proto__||Object.getPrototypeOf(e),"formats",this).call(this,t)}}]),e}(p.default);v.blotName="list-item",v.tagName="LI";var b=function(t){function e(t){i(this,e);var n=l(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t)),r=function(e){if(e.target.parentNode===t){var r=n.statics.formats(t),o=f.default.find(e.target);"checked"===r?o.format("list","unchecked"):"unchecked"===r&&o.format("list","checked")}};return t.addEventListener("touchstart",r),t.addEventListener("mousedown",r),n}return a(e,t),s(e,null,[{key:"create",value:function(t){var n="ordered"===t?"OL":"UL",r=u(e.__proto__||Object.getPrototypeOf(e),"create",this).call(this,n);return"checked"!==t&&"unchecked"!==t||r.setAttribute("data-checked","checked"===t),r}},{key:"formats",value:function(t){return"OL"===t.tagName?"ordered":"UL"===t.tagName?t.hasAttribute("data-checked")?"true"===t.getAttribute("data-checked")?"checked":"unchecked":"bullet":void 0}}]),s(e,[{key:"format",value:function(t,e){this.children.length>0&&this.children.tail.format(t,e)}},{key:"formats",value:function(){return o({},this.statics.blotName,this.statics.formats(this.domNode))}},{key:"insertBefore",value:function(t,n){if(t instanceof v)u(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"insertBefore",this).call(this,t,n);else{var r=null==n?this.length():n.offset(this),o=this.split(r);o.parent.insertBefore(t,o)}}},{key:"optimize",value:function(t){u(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"optimize",this).call(this,t);var n=this.next;null!=n&&n.prev===this&&n.statics.blotName===this.statics.blotName&&n.domNode.tagName===this.domNode.tagName&&n.domNode.getAttribute("data-checked")===this.domNode.getAttribute("data-checked")&&(n.moveChildren(this),n.remove())}},{key:"replace",value:function(t){if(t.statics.blotName!==this.statics.blotName){var n=f.default.create(this.statics.defaultChild);t.moveChildren(n),this.appendChild(n)}u(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"replace",this).call(this,t)}}]),e}(y.default);b.blotName="list",b.scope=f.default.Scope.BLOCK_BLOT,b.tagName=["OL","UL"],b.defaultChild="list-item",b.allowedChildren=[v],e.ListItem=v,e.default=b},function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0});var l=n(39),a=function(t){return t&&t.__esModule?t:{default:t}}(l),s=function(t){function e(){return r(this,e),o(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return i(e,t),e}(a.default);s.blotName="italic",s.tagName=["EM","I"],e.default=s},function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0});var l=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),a=function t(e,n,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,n,r)}if("value"in o)return o.value;var l=o.get;if(void 0!==l)return l.call(r)},s=n(5),u=function(t){return t&&t.__esModule?t:{default:t}}(s),c=function(t){function e(){return r(this,e),o(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return i(e,t),l(e,null,[{key:"create",value:function(t){return"super"===t?document.createElement("sup"):"sub"===t?document.createElement("sub"):a(e.__proto__||Object.getPrototypeOf(e),"create",this).call(this,t)}},{key:"formats",value:function(t){return"SUB"===t.tagName?"sub":"SUP"===t.tagName?"super":void 0}}]),e}(u.default);c.blotName="script",c.tagName=["SUB","SUP"],e.default=c},function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0});var l=n(5),a=function(t){return t&&t.__esModule?t:{default:t}}(l),s=function(t){function e(){return r(this,e),o(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return i(e,t),e}(a.default);s.blotName="strike",s.tagName="S",e.default=s},function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0});var l=n(5),a=function(t){return t&&t.__esModule?t:{default:t}}(l),s=function(t){function e(){return r(this,e),o(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return i(e,t),e}(a.default);s.blotName="underline",s.tagName="U",e.default=s},function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0});var l=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),a=function t(e,n,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,n,r)}if("value"in o)return o.value;var l=o.get;if(void 0!==l)return l.call(r)},s=n(0),u=function(t){return t&&t.__esModule?t:{default:t}}(s),c=n(15),f=["alt","height","width"],h=function(t){function e(){return r(this,e),o(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return i(e,t),l(e,[{key:"format",value:function(t,n){f.indexOf(t)>-1?n?this.domNode.setAttribute(t,n):this.domNode.removeAttribute(t):a(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"format",this).call(this,t,n)}}],[{key:"create",value:function(t){var n=a(e.__proto__||Object.getPrototypeOf(e),"create",this).call(this,t);return"string"==typeof t&&n.setAttribute("src",this.sanitize(t)),n}},{key:"formats",value:function(t){return f.reduce(function(e,n){return t.hasAttribute(n)&&(e[n]=t.getAttribute(n)),e},{})}},{key:"match",value:function(t){return/\.(jpe?g|gif|png)$/.test(t)||/^data:image\/.+;base64/.test(t)}},{key:"sanitize",value:function(t){return(0,c.sanitize)(t,["http","https","data"])?t:"//:0"}},{key:"value",value:function(t){return t.getAttribute("src")}}]),e}(u.default.Embed);h.blotName="image",h.tagName="IMG",e.default=h},function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0});var l=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),a=function t(e,n,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,n,r)}if("value"in o)return o.value;var l=o.get;if(void 0!==l)return l.call(r)},s=n(3),u=n(15),c=function(t){return t&&t.__esModule?t:{default:t}}(u),f=["height","width"],h=function(t){function e(){return r(this,e),o(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return i(e,t),l(e,[{key:"format",value:function(t,n){f.indexOf(t)>-1?n?this.domNode.setAttribute(t,n):this.domNode.removeAttribute(t):a(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"format",this).call(this,t,n)}}],[{key:"create",value:function(t){var n=a(e.__proto__||Object.getPrototypeOf(e),"create",this).call(this,t);return n.setAttribute("frameborder","0"),n.setAttribute("allowfullscreen",!0),n.setAttribute("src",this.sanitize(t)),n}},{key:"formats",value:function(t){return f.reduce(function(e,n){return t.hasAttribute(n)&&(e[n]=t.getAttribute(n)),e},{})}},{key:"sanitize",value:function(t){return c.default.sanitize(t)}},{key:"value",value:function(t){return t.getAttribute("src")}}]),e}(s.BlockEmbed);h.blotName="video",h.className="ql-video",h.tagName="IFRAME",e.default=h},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function l(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0}),e.default=e.FormulaBlot=void 0;var a=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),s=function t(e,n,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,n,r)}if("value"in o)return o.value;var l=o.get;if(void 0!==l)return l.call(r)},u=n(33),c=r(u),f=n(6),h=r(f),p=n(7),d=r(p),y=function(t){function e(){return o(this,e),i(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return l(e,t),a(e,null,[{key:"create",value:function(t){var n=s(e.__proto__||Object.getPrototypeOf(e),"create",this).call(this,t);return"string"==typeof t&&(window.katex.render(t,n,{throwOnError:!1,errorColor:"#f00"}),n.setAttribute("data-value",t)),n}},{key:"value",value:function(t){return t.getAttribute("data-value")}}]),e}(c.default);y.blotName="formula",y.className="ql-formula",y.tagName="SPAN";var v=function(t){function e(){o(this,e);var t=i(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));if(null==window.katex)throw new Error("Formula module requires KaTeX.");return t}return l(e,t),a(e,null,[{key:"register",value:function(){h.default.register(y,!0)}}]),e}(d.default);e.FormulaBlot=y,e.default=v},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function l(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0}),e.default=e.CodeToken=e.CodeBlock=void 0;var a=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),s=function t(e,n,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,n,r)}if("value"in o)return o.value;var l=o.get;if(void 0!==l)return l.call(r)},u=n(0),c=r(u),f=n(6),h=r(f),p=n(7),d=r(p),y=n(13),v=r(y),b=function(t){function e(){return o(this,e),i(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return l(e,t),a(e,[{key:"replaceWith",value:function(t){this.domNode.textContent=this.domNode.textContent,this.attach(),s(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"replaceWith",this).call(this,t)}},{key:"highlight",value:function(t){var e=this.domNode.textContent;this.cachedText!==e&&((e.trim().length>0||null==this.cachedText)&&(this.domNode.innerHTML=t(e),this.domNode.normalize(),this.attach()),this.cachedText=e)}}]),e}(v.default);b.className="ql-syntax";var g=new c.default.Attributor.Class("token","hljs",{scope:c.default.Scope.INLINE}),m=function(t){function e(t,n){o(this,e);var r=i(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n));if("function"!=typeof r.options.highlight)throw new Error("Syntax module requires highlight.js. Please include the library on the page before Quill.");var l=null;return r.quill.on(h.default.events.SCROLL_OPTIMIZE,function(){clearTimeout(l),l=setTimeout(function(){r.highlight(),l=null},r.options.interval)}),r.highlight(),r}return l(e,t),a(e,null,[{key:"register",value:function(){h.default.register(g,!0),h.default.register(b,!0)}}]),a(e,[{key:"highlight",value:function(){var t=this;if(!this.quill.selection.composing){this.quill.update(h.default.sources.USER);var e=this.quill.getSelection();this.quill.scroll.descendants(b).forEach(function(e){e.highlight(t.options.highlight)}),this.quill.update(h.default.sources.SILENT),null!=e&&this.quill.setSelection(e,h.default.sources.SILENT)}}}]),e}(d.default);m.DEFAULTS={highlight:function(){return null==window.hljs?null:function(t){return window.hljs.highlightAuto(t).value}}(),interval:1e3},e.CodeBlock=b,e.CodeToken=g,e.default=m},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function l(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function a(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function s(t,e,n){var r=document.createElement("button");r.setAttribute("type","button"),r.classList.add("ql-"+e),null!=n&&(r.value=n),t.appendChild(r)}function u(t,e){Array.isArray(e[0])||(e=[e]),e.forEach(function(e){var n=document.createElement("span");n.classList.add("ql-formats"),e.forEach(function(t){if("string"==typeof t)s(n,t);else{var e=Object.keys(t)[0],r=t[e];Array.isArray(r)?c(n,e,r):s(n,e,r)}}),t.appendChild(n)})}function c(t,e,n){var r=document.createElement("select");r.classList.add("ql-"+e),n.forEach(function(t){var e=document.createElement("option");!1!==t?e.setAttribute("value",t):e.setAttribute("selected","selected"),r.appendChild(e)}),t.appendChild(r)}Object.defineProperty(e,"__esModule",{value:!0}),e.addControls=e.default=void 0;var f=function(){function t(t,e){var n=[],r=!0,o=!1,i=void 0;try{for(var l,a=t[Symbol.iterator]();!(r=(l=a.next()).done)&&(n.push(l.value),!e||n.length!==e);r=!0);}catch(t){o=!0,i=t}finally{try{!r&&a.return&&a.return()}finally{if(o)throw i}}return n}return function(e,n){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),h=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),p=n(4),d=r(p),y=n(0),v=r(y),b=n(6),g=r(b),m=n(10),_=r(m),O=n(7),w=r(O),x=(0,_.default)("quill:toolbar"),k=function(t){function e(t,n){i(this,e);var r=l(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n));if(Array.isArray(r.options.container)){var o=document.createElement("div");u(o,r.options.container),t.container.parentNode.insertBefore(o,t.container),r.container=o}else"string"==typeof r.options.container?r.container=document.querySelector(r.options.container):r.container=r.options.container;if(!(r.container instanceof HTMLElement)){var a;return a=x.error("Container required for toolbar",r.options),l(r,a)}return r.container.classList.add("ql-toolbar"),r.controls=[],r.handlers={},Object.keys(r.options.handlers).forEach(function(t){r.addHandler(t,r.options.handlers[t])}),[].forEach.call(r.container.querySelectorAll("button, select"),function(t){r.attach(t)}),r.quill.on(g.default.events.EDITOR_CHANGE,function(t,e){t===g.default.events.SELECTION_CHANGE&&r.update(e)}),r.quill.on(g.default.events.SCROLL_OPTIMIZE,function(){var t=r.quill.selection.getRange(),e=f(t,1),n=e[0];r.update(n)}),r}return a(e,t),h(e,[{key:"addHandler",value:function(t,e){this.handlers[t]=e}},{key:"attach",value:function(t){var e=this,n=[].find.call(t.classList,function(t){return 0===t.indexOf("ql-")});if(n){if(n=n.slice("ql-".length),"BUTTON"===t.tagName&&t.setAttribute("type","button"),null==this.handlers[n]){if(null!=this.quill.scroll.whitelist&&null==this.quill.scroll.whitelist[n])return void x.warn("ignoring attaching to disabled format",n,t);if(null==v.default.query(n))return void x.warn("ignoring attaching to nonexistent format",n,t)}var r="SELECT"===t.tagName?"change":"click";t.addEventListener(r,function(r){var i=void 0;if("SELECT"===t.tagName){if(t.selectedIndex<0)return;var l=t.options[t.selectedIndex];i=!l.hasAttribute("selected")&&(l.value||!1)}else i=!t.classList.contains("ql-active")&&(t.value||!t.hasAttribute("value")),r.preventDefault();e.quill.focus();var a=e.quill.selection.getRange(),s=f(a,1),u=s[0];if(null!=e.handlers[n])e.handlers[n].call(e,i);else if(v.default.query(n).prototype instanceof v.default.Embed){if(!(i=prompt("Enter "+n)))return;e.quill.updateContents((new d.default).retain(u.index).delete(u.length).insert(o({},n,i)),g.default.sources.USER)}else e.quill.format(n,i,g.default.sources.USER);e.update(u)}),this.controls.push([n,t])}}},{key:"update",value:function(t){var e=null==t?{}:this.quill.getFormat(t);this.controls.forEach(function(n){var r=f(n,2),o=r[0],i=r[1];if("SELECT"===i.tagName){var l=void 0;if(null==t)l=null;else if(null==e[o])l=i.querySelector("option[selected]");else if(!Array.isArray(e[o])){var a=e[o];"string"==typeof a&&(a=a.replace(/\"/g,'\\"')),l=i.querySelector('option[value="'+a+'"]')}null==l?(i.value="",i.selectedIndex=-1):l.selected=!0}else if(null==t)i.classList.remove("ql-active");else if(i.hasAttribute("value")){var s=e[o]===i.getAttribute("value")||null!=e[o]&&e[o].toString()===i.getAttribute("value")||null==e[o]&&!i.getAttribute("value");i.classList.toggle("ql-active",s)}else i.classList.toggle("ql-active",null!=e[o])})}}]),e}(w.default);k.DEFAULTS={},k.DEFAULTS={container:null,handlers:{clean:function(){var t=this,e=this.quill.getSelection();if(null!=e)if(0==e.length){var n=this.quill.getFormat();Object.keys(n).forEach(function(e){null!=v.default.query(e,v.default.Scope.INLINE)&&t.quill.format(e,!1)})}else this.quill.removeFormat(e,g.default.sources.USER)},direction:function(t){var e=this.quill.getFormat().align;"rtl"===t&&null==e?this.quill.format("align","right",g.default.sources.USER):t||"right"!==e||this.quill.format("align",!1,g.default.sources.USER),this.quill.format("direction",t,g.default.sources.USER)},indent:function(t){var e=this.quill.getSelection(),n=this.quill.getFormat(e),r=parseInt(n.indent||0);if("+1"===t||"-1"===t){var o="+1"===t?1:-1;"rtl"===n.direction&&(o*=-1),this.quill.format("indent",r+o,g.default.sources.USER)}},link:function(t){!0===t&&(t=prompt("Enter link URL:")),this.quill.format("link",t,g.default.sources.USER)},list:function(t){var e=this.quill.getSelection(),n=this.quill.getFormat(e);"check"===t?"checked"===n.list||"unchecked"===n.list?this.quill.format("list",!1,g.default.sources.USER):this.quill.format("list","unchecked",g.default.sources.USER):this.quill.format("list",t,g.default.sources.USER)}}},e.default=k,e.addControls=u},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <line class=ql-stroke x1=3 x2=15 y1=9 y2=9></line> <line class=ql-stroke x1=3 x2=13 y1=14 y2=14></line> <line class=ql-stroke x1=3 x2=9 y1=4 y2=4></line> </svg>'},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <line class=ql-stroke x1=15 x2=3 y1=9 y2=9></line> <line class=ql-stroke x1=14 x2=4 y1=14 y2=14></line> <line class=ql-stroke x1=12 x2=6 y1=4 y2=4></line> </svg>'},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <line class=ql-stroke x1=15 x2=3 y1=9 y2=9></line> <line class=ql-stroke x1=15 x2=5 y1=14 y2=14></line> <line class=ql-stroke x1=15 x2=9 y1=4 y2=4></line> </svg>'},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <line class=ql-stroke x1=15 x2=3 y1=9 y2=9></line> <line class=ql-stroke x1=15 x2=3 y1=14 y2=14></line> <line class=ql-stroke x1=15 x2=3 y1=4 y2=4></line> </svg>'},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <g class="ql-fill ql-color-label"> <polygon points="6 6.868 6 6 5 6 5 7 5.942 7 6 6.868"></polygon> <rect height=1 width=1 x=4 y=4></rect> <polygon points="6.817 5 6 5 6 6 6.38 6 6.817 5"></polygon> <rect height=1 width=1 x=2 y=6></rect> <rect height=1 width=1 x=3 y=5></rect> <rect height=1 width=1 x=4 y=7></rect> <polygon points="4 11.439 4 11 3 11 3 12 3.755 12 4 11.439"></polygon> <rect height=1 width=1 x=2 y=12></rect> <rect height=1 width=1 x=2 y=9></rect> <rect height=1 width=1 x=2 y=15></rect> <polygon points="4.63 10 4 10 4 11 4.192 11 4.63 10"></polygon> <rect height=1 width=1 x=3 y=8></rect> <path d=M10.832,4.2L11,4.582V4H10.708A1.948,1.948,0,0,1,10.832,4.2Z></path> <path d=M7,4.582L7.168,4.2A1.929,1.929,0,0,1,7.292,4H7V4.582Z></path> <path d=M8,13H7.683l-0.351.8a1.933,1.933,0,0,1-.124.2H8V13Z></path> <rect height=1 width=1 x=12 y=2></rect> <rect height=1 width=1 x=11 y=3></rect> <path d=M9,3H8V3.282A1.985,1.985,0,0,1,9,3Z></path> <rect height=1 width=1 x=2 y=3></rect> <rect height=1 width=1 x=6 y=2></rect> <rect height=1 width=1 x=3 y=2></rect> <rect height=1 width=1 x=5 y=3></rect> <rect height=1 width=1 x=9 y=2></rect> <rect height=1 width=1 x=15 y=14></rect> <polygon points="13.447 10.174 13.469 10.225 13.472 10.232 13.808 11 14 11 14 10 13.37 10 13.447 10.174"></polygon> <rect height=1 width=1 x=13 y=7></rect> <rect height=1 width=1 x=15 y=5></rect> <rect height=1 width=1 x=14 y=6></rect> <rect height=1 width=1 x=15 y=8></rect> <rect height=1 width=1 x=14 y=9></rect> <path d=M3.775,14H3v1H4V14.314A1.97,1.97,0,0,1,3.775,14Z></path> <rect height=1 width=1 x=14 y=3></rect> <polygon points="12 6.868 12 6 11.62 6 12 6.868"></polygon> <rect height=1 width=1 x=15 y=2></rect> <rect height=1 width=1 x=12 y=5></rect> <rect height=1 width=1 x=13 y=4></rect> <polygon points="12.933 9 13 9 13 8 12.495 8 12.933 9"></polygon> <rect height=1 width=1 x=9 y=14></rect> <rect height=1 width=1 x=8 y=15></rect> <path d=M6,14.926V15H7V14.316A1.993,1.993,0,0,1,6,14.926Z></path> <rect height=1 width=1 x=5 y=15></rect> <path d=M10.668,13.8L10.317,13H10v1h0.792A1.947,1.947,0,0,1,10.668,13.8Z></path> <rect height=1 width=1 x=11 y=15></rect> <path d=M14.332,12.2a1.99,1.99,0,0,1,.166.8H15V12H14.245Z></path> <rect height=1 width=1 x=14 y=15></rect> <rect height=1 width=1 x=15 y=11></rect> </g> <polyline class=ql-stroke points="5.5 13 9 5 12.5 13"></polyline> <line class=ql-stroke x1=11.63 x2=6.38 y1=11 y2=11></line> </svg>'},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <rect class="ql-fill ql-stroke" height=3 width=3 x=4 y=5></rect> <rect class="ql-fill ql-stroke" height=3 width=3 x=11 y=5></rect> <path class="ql-even ql-fill ql-stroke" d=M7,8c0,4.031-3,5-3,5></path> <path class="ql-even ql-fill ql-stroke" d=M14,8c0,4.031-3,5-3,5></path> </svg>'},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <path class=ql-stroke d=M5,4H9.5A2.5,2.5,0,0,1,12,6.5v0A2.5,2.5,0,0,1,9.5,9H5A0,0,0,0,1,5,9V4A0,0,0,0,1,5,4Z></path> <path class=ql-stroke d=M5,9h5.5A2.5,2.5,0,0,1,13,11.5v0A2.5,2.5,0,0,1,10.5,14H5a0,0,0,0,1,0,0V9A0,0,0,0,1,5,9Z></path> </svg>'},function(t,e){t.exports='<svg class="" viewbox="0 0 18 18"> <line class=ql-stroke x1=5 x2=13 y1=3 y2=3></line> <line class=ql-stroke x1=6 x2=9.35 y1=12 y2=3></line> <line class=ql-stroke x1=11 x2=15 y1=11 y2=15></line> <line class=ql-stroke x1=15 x2=11 y1=11 y2=15></line> <rect class=ql-fill height=1 rx=0.5 ry=0.5 width=7 x=2 y=14></rect> </svg>'},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <line class="ql-color-label ql-stroke ql-transparent" x1=3 x2=15 y1=15 y2=15></line> <polyline class=ql-stroke points="5.5 11 9 3 12.5 11"></polyline> <line class=ql-stroke x1=11.63 x2=6.38 y1=9 y2=9></line> </svg>'},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <polygon class="ql-stroke ql-fill" points="3 11 5 9 3 7 3 11"></polygon> <line class="ql-stroke ql-fill" x1=15 x2=11 y1=4 y2=4></line> <path class=ql-fill d=M11,3a3,3,0,0,0,0,6h1V3H11Z></path> <rect class=ql-fill height=11 width=1 x=11 y=4></rect> <rect class=ql-fill height=11 width=1 x=13 y=4></rect> </svg>'},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <polygon class="ql-stroke ql-fill" points="15 12 13 10 15 8 15 12"></polygon> <line class="ql-stroke ql-fill" x1=9 x2=5 y1=4 y2=4></line> <path class=ql-fill d=M5,3A3,3,0,0,0,5,9H6V3H5Z></path> <rect class=ql-fill height=11 width=1 x=5 y=4></rect> <rect class=ql-fill height=11 width=1 x=7 y=4></rect> </svg>'},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <path class=ql-fill d=M14,16H4a1,1,0,0,1,0-2H14A1,1,0,0,1,14,16Z /> <path class=ql-fill d=M14,4H4A1,1,0,0,1,4,2H14A1,1,0,0,1,14,4Z /> <rect class=ql-fill x=3 y=6 width=12 height=6 rx=1 ry=1 /> </svg>'},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <path class=ql-fill d=M13,16H5a1,1,0,0,1,0-2h8A1,1,0,0,1,13,16Z /> <path class=ql-fill d=M13,4H5A1,1,0,0,1,5,2h8A1,1,0,0,1,13,4Z /> <rect class=ql-fill x=2 y=6 width=14 height=6 rx=1 ry=1 /> </svg>'},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <path class=ql-fill d=M15,8H13a1,1,0,0,1,0-2h2A1,1,0,0,1,15,8Z /> <path class=ql-fill d=M15,12H13a1,1,0,0,1,0-2h2A1,1,0,0,1,15,12Z /> <path class=ql-fill d=M15,16H5a1,1,0,0,1,0-2H15A1,1,0,0,1,15,16Z /> <path class=ql-fill d=M15,4H5A1,1,0,0,1,5,2H15A1,1,0,0,1,15,4Z /> <rect class=ql-fill x=2 y=6 width=8 height=6 rx=1 ry=1 /> </svg>'},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <path class=ql-fill d=M5,8H3A1,1,0,0,1,3,6H5A1,1,0,0,1,5,8Z /> <path class=ql-fill d=M5,12H3a1,1,0,0,1,0-2H5A1,1,0,0,1,5,12Z /> <path class=ql-fill d=M13,16H3a1,1,0,0,1,0-2H13A1,1,0,0,1,13,16Z /> <path class=ql-fill d=M13,4H3A1,1,0,0,1,3,2H13A1,1,0,0,1,13,4Z /> <rect class=ql-fill x=8 y=6 width=8 height=6 rx=1 ry=1 transform="translate(24 18) rotate(-180)"/> </svg>'},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <path class=ql-fill d=M11.759,2.482a2.561,2.561,0,0,0-3.53.607A7.656,7.656,0,0,0,6.8,6.2C6.109,9.188,5.275,14.677,4.15,14.927a1.545,1.545,0,0,0-1.3-.933A0.922,0.922,0,0,0,2,15.036S1.954,16,4.119,16s3.091-2.691,3.7-5.553c0.177-.826.36-1.726,0.554-2.6L8.775,6.2c0.381-1.421.807-2.521,1.306-2.676a1.014,1.014,0,0,0,1.02.56A0.966,0.966,0,0,0,11.759,2.482Z></path> <rect class=ql-fill height=1.6 rx=0.8 ry=0.8 width=5 x=5.15 y=6.2></rect> <path class=ql-fill d=M13.663,12.027a1.662,1.662,0,0,1,.266-0.276q0.193,0.069.456,0.138a2.1,2.1,0,0,0,.535.069,1.075,1.075,0,0,0,.767-0.3,1.044,1.044,0,0,0,.314-0.8,0.84,0.84,0,0,0-.238-0.619,0.8,0.8,0,0,0-.594-0.239,1.154,1.154,0,0,0-.781.3,4.607,4.607,0,0,0-.781,1q-0.091.15-.218,0.346l-0.246.38c-0.068-.288-0.137-0.582-0.212-0.885-0.459-1.847-2.494-.984-2.941-0.8-0.482.2-.353,0.647-0.094,0.529a0.869,0.869,0,0,1,1.281.585c0.217,0.751.377,1.436,0.527,2.038a5.688,5.688,0,0,1-.362.467,2.69,2.69,0,0,1-.264.271q-0.221-.08-0.471-0.147a2.029,2.029,0,0,0-.522-0.066,1.079,1.079,0,0,0-.768.3A1.058,1.058,0,0,0,9,15.131a0.82,0.82,0,0,0,.832.852,1.134,1.134,0,0,0,.787-0.3,5.11,5.11,0,0,0,.776-0.993q0.141-.219.215-0.34c0.046-.076.122-0.194,0.223-0.346a2.786,2.786,0,0,0,.918,1.726,2.582,2.582,0,0,0,2.376-.185c0.317-.181.212-0.565,0-0.494A0.807,0.807,0,0,1,14.176,15a5.159,5.159,0,0,1-.913-2.446l0,0Q13.487,12.24,13.663,12.027Z></path> </svg>'},function(t,e){t.exports='<svg viewBox="0 0 18 18"> <path class=ql-fill d=M10,4V14a1,1,0,0,1-2,0V10H3v4a1,1,0,0,1-2,0V4A1,1,0,0,1,3,4V8H8V4a1,1,0,0,1,2,0Zm6.06787,9.209H14.98975V7.59863a.54085.54085,0,0,0-.605-.60547h-.62744a1.01119,1.01119,0,0,0-.748.29688L11.645,8.56641a.5435.5435,0,0,0-.022.8584l.28613.30762a.53861.53861,0,0,0,.84717.0332l.09912-.08789a1.2137,1.2137,0,0,0,.2417-.35254h.02246s-.01123.30859-.01123.60547V13.209H12.041a.54085.54085,0,0,0-.605.60547v.43945a.54085.54085,0,0,0,.605.60547h4.02686a.54085.54085,0,0,0,.605-.60547v-.43945A.54085.54085,0,0,0,16.06787,13.209Z /> </svg>'},function(t,e){t.exports='<svg viewBox="0 0 18 18"> <path class=ql-fill d=M16.73975,13.81445v.43945a.54085.54085,0,0,1-.605.60547H11.855a.58392.58392,0,0,1-.64893-.60547V14.0127c0-2.90527,3.39941-3.42187,3.39941-4.55469a.77675.77675,0,0,0-.84717-.78125,1.17684,1.17684,0,0,0-.83594.38477c-.2749.26367-.561.374-.85791.13184l-.4292-.34082c-.30811-.24219-.38525-.51758-.1543-.81445a2.97155,2.97155,0,0,1,2.45361-1.17676,2.45393,2.45393,0,0,1,2.68408,2.40918c0,2.45312-3.1792,2.92676-3.27832,3.93848h2.79443A.54085.54085,0,0,1,16.73975,13.81445ZM9,3A.99974.99974,0,0,0,8,4V8H3V4A1,1,0,0,0,1,4V14a1,1,0,0,0,2,0V10H8v4a1,1,0,0,0,2,0V4A.99974.99974,0,0,0,9,3Z /> </svg>'},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <line class=ql-stroke x1=7 x2=13 y1=4 y2=4></line> <line class=ql-stroke x1=5 x2=11 y1=14 y2=14></line> <line class=ql-stroke x1=8 x2=10 y1=14 y2=4></line> </svg>'},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <rect class=ql-stroke height=10 width=12 x=3 y=4></rect> <circle class=ql-fill cx=6 cy=7 r=1></circle> <polyline class="ql-even ql-fill" points="5 12 5 11 7 9 8 10 11 7 13 9 13 12 5 12"></polyline> </svg>'},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <line class=ql-stroke x1=3 x2=15 y1=14 y2=14></line> <line class=ql-stroke x1=3 x2=15 y1=4 y2=4></line> <line class=ql-stroke x1=9 x2=15 y1=9 y2=9></line> <polyline class="ql-fill ql-stroke" points="3 7 3 11 5 9 3 7"></polyline> </svg>'},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <line class=ql-stroke x1=3 x2=15 y1=14 y2=14></line> <line class=ql-stroke x1=3 x2=15 y1=4 y2=4></line> <line class=ql-stroke x1=9 x2=15 y1=9 y2=9></line> <polyline class=ql-stroke points="5 7 5 11 3 9 5 7"></polyline> </svg>'},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <line class=ql-stroke x1=7 x2=11 y1=7 y2=11></line> <path class="ql-even ql-stroke" d=M8.9,4.577a3.476,3.476,0,0,1,.36,4.679A3.476,3.476,0,0,1,4.577,8.9C3.185,7.5,2.035,6.4,4.217,4.217S7.5,3.185,8.9,4.577Z></path> <path class="ql-even ql-stroke" d=M13.423,9.1a3.476,3.476,0,0,0-4.679-.36,3.476,3.476,0,0,0,.36,4.679c1.392,1.392,2.5,2.542,4.679.36S14.815,10.5,13.423,9.1Z></path> </svg>'},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <line class=ql-stroke x1=7 x2=15 y1=4 y2=4></line> <line class=ql-stroke x1=7 x2=15 y1=9 y2=9></line> <line class=ql-stroke x1=7 x2=15 y1=14 y2=14></line> <line class="ql-stroke ql-thin" x1=2.5 x2=4.5 y1=5.5 y2=5.5></line> <path class=ql-fill d=M3.5,6A0.5,0.5,0,0,1,3,5.5V3.085l-0.276.138A0.5,0.5,0,0,1,2.053,3c-0.124-.247-0.023-0.324.224-0.447l1-.5A0.5,0.5,0,0,1,4,2.5v3A0.5,0.5,0,0,1,3.5,6Z></path> <path class="ql-stroke ql-thin" d=M4.5,10.5h-2c0-.234,1.85-1.076,1.85-2.234A0.959,0.959,0,0,0,2.5,8.156></path> <path class="ql-stroke ql-thin" d=M2.5,14.846a0.959,0.959,0,0,0,1.85-.109A0.7,0.7,0,0,0,3.75,14a0.688,0.688,0,0,0,.6-0.736,0.959,0.959,0,0,0-1.85-.109></path> </svg>'},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <line class=ql-stroke x1=6 x2=15 y1=4 y2=4></line> <line class=ql-stroke x1=6 x2=15 y1=9 y2=9></line> <line class=ql-stroke x1=6 x2=15 y1=14 y2=14></line> <line class=ql-stroke x1=3 x2=3 y1=4 y2=4></line> <line class=ql-stroke x1=3 x2=3 y1=9 y2=9></line> <line class=ql-stroke x1=3 x2=3 y1=14 y2=14></line> </svg>'},function(t,e){t.exports='<svg class="" viewbox="0 0 18 18"> <line class=ql-stroke x1=9 x2=15 y1=4 y2=4></line> <polyline class=ql-stroke points="3 4 4 5 6 3"></polyline> <line class=ql-stroke x1=9 x2=15 y1=14 y2=14></line> <polyline class=ql-stroke points="3 14 4 15 6 13"></polyline> <line class=ql-stroke x1=9 x2=15 y1=9 y2=9></line> <polyline class=ql-stroke points="3 9 4 10 6 8"></polyline> </svg>'},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <path class=ql-fill d=M15.5,15H13.861a3.858,3.858,0,0,0,1.914-2.975,1.8,1.8,0,0,0-1.6-1.751A1.921,1.921,0,0,0,12.021,11.7a0.50013,0.50013,0,1,0,.957.291h0a0.914,0.914,0,0,1,1.053-.725,0.81,0.81,0,0,1,.744.762c0,1.076-1.16971,1.86982-1.93971,2.43082A1.45639,1.45639,0,0,0,12,15.5a0.5,0.5,0,0,0,.5.5h3A0.5,0.5,0,0,0,15.5,15Z /> <path class=ql-fill d=M9.65,5.241a1,1,0,0,0-1.409.108L6,7.964,3.759,5.349A1,1,0,0,0,2.192,6.59178Q2.21541,6.6213,2.241,6.649L4.684,9.5,2.241,12.35A1,1,0,0,0,3.71,13.70722q0.02557-.02768.049-0.05722L6,11.036,8.241,13.65a1,1,0,1,0,1.567-1.24277Q9.78459,12.3777,9.759,12.35L7.316,9.5,9.759,6.651A1,1,0,0,0,9.65,5.241Z /> </svg>'},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <path class=ql-fill d=M15.5,7H13.861a4.015,4.015,0,0,0,1.914-2.975,1.8,1.8,0,0,0-1.6-1.751A1.922,1.922,0,0,0,12.021,3.7a0.5,0.5,0,1,0,.957.291,0.917,0.917,0,0,1,1.053-.725,0.81,0.81,0,0,1,.744.762c0,1.077-1.164,1.925-1.934,2.486A1.423,1.423,0,0,0,12,7.5a0.5,0.5,0,0,0,.5.5h3A0.5,0.5,0,0,0,15.5,7Z /> <path class=ql-fill d=M9.651,5.241a1,1,0,0,0-1.41.108L6,7.964,3.759,5.349a1,1,0,1,0-1.519,1.3L4.683,9.5,2.241,12.35a1,1,0,1,0,1.519,1.3L6,11.036,8.241,13.65a1,1,0,0,0,1.519-1.3L7.317,9.5,9.759,6.651A1,1,0,0,0,9.651,5.241Z /> </svg>'},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <line class="ql-stroke ql-thin" x1=15.5 x2=2.5 y1=8.5 y2=9.5></line> <path class=ql-fill d=M9.007,8C6.542,7.791,6,7.519,6,6.5,6,5.792,7.283,5,9,5c1.571,0,2.765.679,2.969,1.309a1,1,0,0,0,1.9-.617C13.356,4.106,11.354,3,9,3,6.2,3,4,4.538,4,6.5a3.2,3.2,0,0,0,.5,1.843Z></path> <path class=ql-fill d=M8.984,10C11.457,10.208,12,10.479,12,11.5c0,0.708-1.283,1.5-3,1.5-1.571,0-2.765-.679-2.969-1.309a1,1,0,1,0-1.9.617C4.644,13.894,6.646,15,9,15c2.8,0,5-1.538,5-3.5a3.2,3.2,0,0,0-.5-1.843Z></path> </svg>'},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <path class=ql-stroke d=M5,3V9a4.012,4.012,0,0,0,4,4H9a4.012,4.012,0,0,0,4-4V3></path> <rect class=ql-fill height=1 rx=0.5 ry=0.5 width=12 x=3 y=15></rect> </svg>'},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <rect class=ql-stroke height=12 width=12 x=3 y=3></rect> <rect class=ql-fill height=12 width=1 x=5 y=3></rect> <rect class=ql-fill height=12 width=1 x=12 y=3></rect> <rect class=ql-fill height=2 width=8 x=5 y=8></rect> <rect class=ql-fill height=1 width=3 x=3 y=5></rect> <rect class=ql-fill height=1 width=3 x=3 y=7></rect> <rect class=ql-fill height=1 width=3 x=3 y=10></rect> <rect class=ql-fill height=1 width=3 x=3 y=12></rect> <rect class=ql-fill height=1 width=3 x=12 y=5></rect> <rect class=ql-fill height=1 width=3 x=12 y=7></rect> <rect class=ql-fill height=1 width=3 x=12 y=10></rect> <rect class=ql-fill height=1 width=3 x=12 y=12></rect> </svg>'},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <polygon class=ql-stroke points="7 11 9 13 11 11 7 11"></polygon> <polygon class=ql-stroke points="7 7 9 5 11 7 7 7"></polygon> </svg>'},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function l(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0}),e.default=e.BubbleTooltip=void 0;var a=function t(e,n,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,n,r)}if("value"in o)return o.value;var l=o.get;if(void 0!==l)return l.call(r)},s=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),u=n(2),c=r(u),f=n(9),h=r(f),p=n(44),d=r(p),y=n(22),v=n(26),b=r(v),g=[["bold","italic","link"],[{header:1},{header:2},"blockquote"]],m=function(t){function e(t,n){o(this,e),null!=n.modules.toolbar&&null==n.modules.toolbar.container&&(n.modules.toolbar.container=g);var r=i(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n));return r.quill.container.classList.add("ql-bubble"),r}return l(e,t),s(e,[{key:"extendToolbar",value:function(t){this.tooltip=new _(this.quill,this.options.bounds),this.tooltip.root.appendChild(t.container),this.buildButtons([].slice.call(t.container.querySelectorAll("button")),b.default),this.buildPickers([].slice.call(t.container.querySelectorAll("select")),b.default)}}]),e}(d.default);m.DEFAULTS=(0,c.default)(!0,{},d.default.DEFAULTS,{modules:{toolbar:{handlers:{link:function(t){t?this.quill.theme.tooltip.edit():this.quill.format("link",!1)}}}}});var _=function(t){function e(t,n){o(this,e);var r=i(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n));return r.quill.on(h.default.events.EDITOR_CHANGE,function(t,e,n,o){if(t===h.default.events.SELECTION_CHANGE)if(null!=e&&e.length>0&&o===h.default.sources.USER){r.show(),r.root.style.left="0px",r.root.style.width="",r.root.style.width=r.root.offsetWidth+"px";var i=r.quill.getLines(e.index,e.length);if(1===i.length)r.position(r.quill.getBounds(e));else{var l=i[i.length-1],a=r.quill.getIndex(l),s=Math.min(l.length()-1,e.index+e.length-a),u=r.quill.getBounds(new y.Range(a,s));r.position(u)}}else document.activeElement!==r.textbox&&r.quill.hasFocus()&&r.hide()}),r}return l(e,t),s(e,[{key:"listen",value:function(){var t=this;a(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"listen",this).call(this),this.root.querySelector(".ql-close").addEventListener("click",function(){t.root.classList.remove("ql-editing")}),this.quill.on(h.default.events.SCROLL_OPTIMIZE,function(){setTimeout(function(){if(!t.root.classList.contains("ql-hidden")){var e=t.quill.getSelection();null!=e&&t.position(t.quill.getBounds(e))}},1)})}},{key:"cancel",value:function(){this.show()}},{key:"position",value:function(t){var n=a(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"position",this).call(this,t),r=this.root.querySelector(".ql-tooltip-arrow");if(r.style.marginLeft="",0===n)return n;r.style.marginLeft=-1*n-r.offsetWidth/2+"px"}}]),e}(p.BaseTooltip);_.TEMPLATE=['<span class="ql-tooltip-arrow"></span>','<div class="ql-tooltip-editor">','<input type="text" data-formula="e=mc^2" data-link="https://quilljs.com" data-video="Embed URL">','<a class="ql-close"></a>',"</div>"].join(""),e.BubbleTooltip=_,e.default=m},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function l(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0});var a=function(){function t(t,e){var n=[],r=!0,o=!1,i=void 0;try{for(var l,a=t[Symbol.iterator]();!(r=(l=a.next()).done)&&(n.push(l.value),!e||n.length!==e);r=!0);}catch(t){o=!0,i=t}finally{try{!r&&a.return&&a.return()}finally{if(o)throw i}}return n}return function(e,n){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),s=function t(e,n,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,n,r)}if("value"in o)return o.value;var l=o.get;if(void 0!==l)return l.call(r)},u=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),c=n(2),f=r(c),h=n(9),p=r(h),d=n(44),y=r(d),v=n(15),b=r(v),g=n(22),m=n(26),_=r(m),O=[[{header:["1","2","3",!1]}],["bold","italic","underline","link"],[{list:"ordered"},{list:"bullet"}],["clean"]],w=function(t){function e(t,n){o(this,e),null!=n.modules.toolbar&&null==n.modules.toolbar.container&&(n.modules.toolbar.container=O);var r=i(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n));return r.quill.container.classList.add("ql-snow"),r}return l(e,t),u(e,[{key:"extendToolbar",value:function(t){t.container.classList.add("ql-snow"),this.buildButtons([].slice.call(t.container.querySelectorAll("button")),_.default),this.buildPickers([].slice.call(t.container.querySelectorAll("select")),_.default),this.tooltip=new x(this.quill,this.options.bounds),t.container.querySelector(".ql-link")&&this.quill.keyboard.addBinding({key:"K",shortKey:!0},function(e,n){t.handlers.link.call(t,!n.format.link)})}}]),e}(y.default);w.DEFAULTS=(0,f.default)(!0,{},y.default.DEFAULTS,{modules:{toolbar:{handlers:{link:function(t){if(t){var e=this.quill.getSelection();if(null==e||0==e.length)return;var n=this.quill.getText(e);/^\S+@\S+\.\S+$/.test(n)&&0!==n.indexOf("mailto:")&&(n="mailto:"+n);this.quill.theme.tooltip.edit("link",n)}else this.quill.format("link",!1)}}}}});var x=function(t){function e(t,n){o(this,e);var r=i(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n));return r.preview=r.root.querySelector("a.ql-preview"),r}return l(e,t),u(e,[{key:"listen",value:function(){var t=this;s(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"listen",this).call(this),this.root.querySelector("a.ql-action").addEventListener("click",function(e){t.root.classList.contains("ql-editing")?t.save():t.edit("link",t.preview.textContent),e.preventDefault()}),this.root.querySelector("a.ql-remove").addEventListener("click",function(e){if(null!=t.linkRange){var n=t.linkRange;t.restoreFocus(),t.quill.formatText(n,"link",!1,p.default.sources.USER),delete t.linkRange}e.preventDefault(),t.hide()}),this.quill.on(p.default.events.SELECTION_CHANGE,function(e,n,r){if(null!=e){if(0===e.length&&r===p.default.sources.USER){var o=t.quill.scroll.descendant(b.default,e.index),i=a(o,2),l=i[0],s=i[1];if(null!=l){t.linkRange=new g.Range(e.index-s,l.length());var u=b.default.formats(l.domNode);return t.preview.textContent=u,t.preview.setAttribute("href",u),t.show(),void t.position(t.quill.getBounds(t.linkRange))}}else delete t.linkRange;t.hide()}})}},{key:"show",value:function(){s(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"show",this).call(this),this.root.removeAttribute("data-mode")}}]),e}(d.BaseTooltip);x.TEMPLATE=['<a class="ql-preview" target="_blank" href="about:blank"></a>','<input type="text" data-formula="e=mc^2" data-link="https://quilljs.com" data-video="Embed URL">','<a class="ql-action"></a>','<a class="ql-remove"></a>'].join(""),e.default=w}]).default});
/*
 Highcharts JS v7.2.1 (2019-10-31)

 (c) 2009-2018 Torstein Honsi

 License: www.highcharts.com/license
*/
(function(P,M){"object"===typeof module&&module.exports?(M["default"]=M,module.exports=P.document?M(P):M):"function"===typeof define&&define.amd?define("highcharts/highcharts",function(){return M(P)}):(P.Highcharts&&P.Highcharts.error(16,!0),P.Highcharts=M(P))})("undefined"!==typeof window?window:this,function(P){function M(c,f,F,G){c.hasOwnProperty(f)||(c[f]=G.apply(null,F))}var I={};M(I,"parts/Globals.js",[],function(){var c="undefined"!==typeof P?P:"undefined"!==typeof window?window:{},f=c.document,
F=c.navigator&&c.navigator.userAgent||"",G=f&&f.createElementNS&&!!f.createElementNS("http://www.w3.org/2000/svg","svg").createSVGRect,z=/(edge|msie|trident)/i.test(F)&&!c.opera,B=-1!==F.indexOf("Firefox"),t=-1!==F.indexOf("Chrome"),v=B&&4>parseInt(F.split("Firefox/")[1],10);return{product:"Highcharts",version:"7.2.1",deg2rad:2*Math.PI/360,doc:f,hasBidiBug:v,hasTouch:!!c.TouchEvent,isMS:z,isWebKit:-1!==F.indexOf("AppleWebKit"),isFirefox:B,isChrome:t,isSafari:!t&&-1!==F.indexOf("Safari"),isTouchDevice:/(Mobile|Android|Windows Phone)/.test(F),
SVG_NS:"http://www.w3.org/2000/svg",chartCount:0,seriesTypes:{},symbolSizes:{},svg:G,win:c,marginNames:["plotTop","marginRight","marginBottom","plotLeft"],noop:function(){},charts:[],dateFormats:{}}});M(I,"parts/Utilities.js",[I["parts/Globals.js"]],function(c){function f(a,d){return parseInt(a,d||10)}function F(a){return"string"===typeof a}function G(a){a=Object.prototype.toString.call(a);return"[object Array]"===a||"[object Array Iterator]"===a}function z(a,d){return!!a&&"object"===typeof a&&(!d||
!G(a))}function B(a){return z(a)&&"number"===typeof a.nodeType}function t(a){var d=a&&a.constructor;return!(!z(a,!0)||B(a)||!d||!d.name||"Object"===d.name)}function v(a){return"number"===typeof a&&!isNaN(a)&&Infinity>a&&-Infinity<a}function C(a){return"undefined"!==typeof a&&null!==a}function H(a,d,e){var b;F(d)?C(e)?a.setAttribute(d,e):a&&a.getAttribute&&((b=a.getAttribute(d))||"class"!==d||(b=a.getAttribute(d+"Name"))):n(d,function(d,e){a.setAttribute(e,d)});return b}function y(a,d){var e;a||(a=
{});for(e in d)a[e]=d[e];return a}function h(){for(var a=arguments,d=a.length,e=0;e<d;e++){var b=a[e];if("undefined"!==typeof b&&null!==b)return b}}function n(a,d,e){for(var b in a)Object.hasOwnProperty.call(a,b)&&d.call(e||a[b],a[b],b,a)}c.timers=[];var q=c.charts,g=c.doc,b=c.win;c.error=function(a,d,e,l){var g=v(a),h=g?"Highcharts error #"+a+": www.highcharts.com/errors/"+a+"/":a.toString(),p=function(){if(d)throw Error(h);b.console&&console.log(h)};if("undefined"!==typeof l){var u="";g&&(h+="?");
c.objectEach(l,function(a,d){u+="\n"+d+": "+a;g&&(h+=encodeURI(d)+"="+encodeURI(a))});h+=u}e?c.fireEvent(e,"displayError",{code:a,message:h,params:l},p):p()};c.Fx=function(a,d,e){this.options=d;this.elem=a;this.prop=e};c.Fx.prototype={dSetter:function(){var a=this.paths[0],d=this.paths[1],e=[],b=this.now,g=a.length;if(1===b)e=this.toD;else if(g===d.length&&1>b)for(;g--;){var c=parseFloat(a[g]);e[g]=isNaN(c)||"A"===d[g-4]||"A"===d[g-5]?d[g]:b*parseFloat(""+(d[g]-c))+c}else e=d;this.elem.attr("d",e,
null,!0)},update:function(){var a=this.elem,d=this.prop,e=this.now,b=this.options.step;if(this[d+"Setter"])this[d+"Setter"]();else a.attr?a.element&&a.attr(d,e,null,!0):a.style[d]=e+this.unit;b&&b.call(a,e,this)},run:function(a,d,e){var l=this,g=l.options,h=function(a){return h.stopped?!1:l.step(a)},p=b.requestAnimationFrame||function(a){setTimeout(a,13)},u=function(){for(var a=0;a<c.timers.length;a++)c.timers[a]()||c.timers.splice(a--,1);c.timers.length&&p(u)};a!==d||this.elem["forceAnimate:"+this.prop]?
(this.startTime=+new Date,this.start=a,this.end=d,this.unit=e,this.now=this.start,this.pos=0,h.elem=this.elem,h.prop=this.prop,h()&&1===c.timers.push(h)&&p(u)):(delete g.curAnim[this.prop],g.complete&&0===Object.keys(g.curAnim).length&&g.complete.call(this.elem))},step:function(a){var d=+new Date,e=this.options,b=this.elem,g=e.complete,c=e.duration,p=e.curAnim;if(b.attr&&!b.element)a=!1;else if(a||d>=c+this.startTime){this.now=this.end;this.pos=1;this.update();var u=p[this.prop]=!0;n(p,function(a){!0!==
a&&(u=!1)});u&&g&&g.call(b);a=!1}else this.pos=e.easing((d-this.startTime)/c),this.now=this.start+(this.end-this.start)*this.pos,this.update(),a=!0;return a},initPath:function(a,d,e){function b(a){for(A=a.length;A--;){var d="M"===a[A]||"L"===a[A];var e=/[a-zA-Z]/.test(a[A+3]);d&&e&&a.splice(A+1,0,a[A+1],a[A+2],a[A+1],a[A+2])}}function g(a,d){for(;a.length<h;){a[0]=d[h-a.length];var e=a.slice(0,r);[].splice.apply(a,[0,0].concat(e));w&&(e=a.slice(a.length-r),[].splice.apply(a,[a.length,0].concat(e)),
A--)}a[0]="M"}function c(a,d){for(var e=(h-a.length)/r;0<e&&e--;)x=a.slice().splice(a.length/m-r,r*m),x[0]=d[h-r-e*r],k&&(x[r-6]=x[r-2],x[r-5]=x[r-1]),[].splice.apply(a,[a.length/m,0].concat(x)),w&&e--}d=d||"";var p=a.startX,u=a.endX,k=-1<d.indexOf("C"),r=k?7:3,x,A;d=d.split(" ");e=e.slice();var w=a.isArea,m=w?2:1;k&&(b(d),b(e));if(p&&u){for(A=0;A<p.length;A++)if(p[A]===u[0]){var K=A;break}else if(p[0]===u[u.length-p.length+A]){K=A;var J=!0;break}else if(p[p.length-1]===u[u.length-p.length+A]){K=
p.length-A;break}"undefined"===typeof K&&(d=[])}if(d.length&&v(K)){var h=e.length+K*m*r;J?(g(d,e),c(e,d)):(g(e,d),c(d,e))}return[d,e]},fillSetter:function(){c.Fx.prototype.strokeSetter.apply(this,arguments)},strokeSetter:function(){this.elem.attr(this.prop,c.color(this.start).tweenTo(c.color(this.end),this.pos),null,!0)}};c.merge=function(){var a,d=arguments,e={},b=function(a,d){"object"!==typeof a&&(a={});n(d,function(e,k){!z(e,!0)||t(e)||B(e)?a[k]=d[k]:a[k]=b(a[k]||{},e)});return a};!0===d[0]&&
(e=d[1],d=Array.prototype.slice.call(d,2));var g=d.length;for(a=0;a<g;a++)e=b(e,d[a]);return e};c.clearTimeout=function(a){C(a)&&clearTimeout(a)};c.css=function(a,d){c.isMS&&!c.svg&&d&&"undefined"!==typeof d.opacity&&(d.filter="alpha(opacity="+100*d.opacity+")");y(a.style,d)};c.createElement=function(a,d,e,b,L){a=g.createElement(a);var l=c.css;d&&y(a,d);L&&l(a,{padding:"0",border:"none",margin:"0"});e&&l(a,e);b&&b.appendChild(a);return a};c.extendClass=function(a,d){var e=function(){};e.prototype=
new a;y(e.prototype,d);return e};c.pad=function(a,d,e){return Array((d||2)+1-String(a).replace("-","").length).join(e||"0")+a};c.relativeLength=function(a,d,e){return/%$/.test(a)?d*parseFloat(a)/100+(e||0):parseFloat(a)};c.wrap=function(a,d,e){var b=a[d];a[d]=function(){var a=Array.prototype.slice.call(arguments),d=arguments,l=this;l.proceed=function(){b.apply(l,arguments.length?arguments:d)};a.unshift(b);a=e.apply(this,a);l.proceed=null;return a}};c.datePropsToTimestamps=function(a){n(a,function(d,
e){z(d)&&"function"===typeof d.getTime?a[e]=d.getTime():(z(d)||G(d))&&c.datePropsToTimestamps(d)})};c.formatSingle=function(a,d,e){var b=/\.([0-9])/,g=c.defaultOptions.lang;/f$/.test(a)?(e=(e=a.match(b))?e[1]:-1,null!==d&&(d=c.numberFormat(d,e,g.decimalPoint,-1<a.indexOf(",")?g.thousandsSep:""))):d=(e||c.time).dateFormat(a,d);return d};c.format=function(a,d,e){for(var b="{",g=!1,h,p,u,k,r=[],x;a;){b=a.indexOf(b);if(-1===b)break;h=a.slice(0,b);if(g){h=h.split(":");p=h.shift().split(".");k=p.length;
x=d;for(u=0;u<k;u++)x&&(x=x[p[u]]);h.length&&(x=c.formatSingle(h.join(":"),x,e));r.push(x)}else r.push(h);a=a.slice(b+1);b=(g=!g)?"}":"{"}r.push(a);return r.join("")};c.getMagnitude=function(a){return Math.pow(10,Math.floor(Math.log(a)/Math.LN10))};c.normalizeTickInterval=function(a,d,e,b,g){var l=a;e=h(e,1);var p=a/e;d||(d=g?[1,1.2,1.5,2,2.5,3,4,5,6,8,10]:[1,2,2.5,5,10],!1===b&&(1===e?d=d.filter(function(a){return 0===a%1}):.1>=e&&(d=[1/e])));for(b=0;b<d.length&&!(l=d[b],g&&l*e>=a||!g&&p<=(d[b]+
(d[b+1]||d[b]))/2);b++);return l=c.correctFloat(l*e,-Math.round(Math.log(.001)/Math.LN10))};c.stableSort=function(a,d){var b=a.length,l,g;for(g=0;g<b;g++)a[g].safeI=g;a.sort(function(a,b){l=d(a,b);return 0===l?a.safeI-b.safeI:l});for(g=0;g<b;g++)delete a[g].safeI};c.correctFloat=function(a,d){return parseFloat(a.toPrecision(d||14))};c.animObject=function(a){return z(a)?c.merge(a):{duration:a?500:0}};c.timeUnits={millisecond:1,second:1E3,minute:6E4,hour:36E5,day:864E5,week:6048E5,month:24192E5,year:314496E5};
c.numberFormat=function(a,d,b,l){a=+a||0;d=+d;var e=c.defaultOptions.lang,g=(a.toString().split(".")[1]||"").split("e")[0].length,p=a.toString().split("e");if(-1===d)d=Math.min(g,20);else if(!v(d))d=2;else if(d&&p[1]&&0>p[1]){var u=d+ +p[1];0<=u?(p[0]=(+p[0]).toExponential(u).split("e")[0],d=u):(p[0]=p[0].split(".")[0]||0,a=20>d?(p[0]*Math.pow(10,p[1])).toFixed(d):0,p[1]=0)}var k=(Math.abs(p[1]?p[0]:a)+Math.pow(10,-Math.max(d,g)-1)).toFixed(d);g=String(f(k));u=3<g.length?g.length%3:0;b=h(b,e.decimalPoint);
l=h(l,e.thousandsSep);a=(0>a?"-":"")+(u?g.substr(0,u)+l:"");a+=g.substr(u).replace(/(\d{3})(?=\d)/g,"$1"+l);d&&(a+=b+k.slice(-d));p[1]&&0!==+a&&(a+="e"+p[1]);return a};Math.easeInOutSine=function(a){return-.5*(Math.cos(Math.PI*a)-1)};c.getStyle=function(a,d,e){if("width"===d)return d=Math.min(a.offsetWidth,a.scrollWidth),e=a.getBoundingClientRect&&a.getBoundingClientRect().width,e<d&&e>=d-1&&(d=Math.floor(e)),Math.max(0,d-c.getStyle(a,"padding-left")-c.getStyle(a,"padding-right"));if("height"===d)return Math.max(0,
Math.min(a.offsetHeight,a.scrollHeight)-c.getStyle(a,"padding-top")-c.getStyle(a,"padding-bottom"));b.getComputedStyle||c.error(27,!0);if(a=b.getComputedStyle(a,void 0))a=a.getPropertyValue(d),h(e,"opacity"!==d)&&(a=f(a));return a};c.inArray=function(a,d,b){return d.indexOf(a,b)};c.find=Array.prototype.find?function(a,d){return a.find(d)}:function(a,d){var b,l=a.length;for(b=0;b<l;b++)if(d(a[b],b))return a[b]};c.keys=Object.keys;c.offset=function(a){var d=g.documentElement;a=a.parentElement||a.parentNode?
a.getBoundingClientRect():{top:0,left:0};return{top:a.top+(b.pageYOffset||d.scrollTop)-(d.clientTop||0),left:a.left+(b.pageXOffset||d.scrollLeft)-(d.clientLeft||0)}};c.stop=function(a,b){for(var d=c.timers.length;d--;)c.timers[d].elem!==a||b&&b!==c.timers[d].prop||(c.timers[d].stopped=!0)};n({map:"map",each:"forEach",grep:"filter",reduce:"reduce",some:"some"},function(a,b){c[b]=function(b){return Array.prototype[a].apply(b,[].slice.call(arguments,1))}});c.addEvent=function(a,b,e,l){void 0===l&&(l=
{});var d=a.addEventListener||c.addEventListenerPolyfill;var g="function"===typeof a&&a.prototype?a.prototype.protoEvents=a.prototype.protoEvents||{}:a.hcEvents=a.hcEvents||{};c.Point&&a instanceof c.Point&&a.series&&a.series.chart&&(a.series.chart.runTrackerClick=!0);d&&d.call(a,b,e,!1);g[b]||(g[b]=[]);g[b].push({fn:e,order:"number"===typeof l.order?l.order:Infinity});g[b].sort(function(a,b){return a.order-b.order});return function(){c.removeEvent(a,b,e)}};c.removeEvent=function(a,b,e){function d(b,
d){var e=a.removeEventListener||c.removeEventListenerPolyfill;e&&e.call(a,b,d,!1)}function g(e){var l;if(a.nodeName){if(b){var k={};k[b]=!0}else k=e;n(k,function(a,b){if(e[b])for(l=e[b].length;l--;)d(b,e[b][l].fn)})}}var h;["protoEvents","hcEvents"].forEach(function(l,c){var k=(c=c?a:a.prototype)&&c[l];k&&(b?(h=k[b]||[],e?(k[b]=h.filter(function(a){return e!==a.fn}),d(b,e)):(g(k),k[b]=[])):(g(k),c[l]={}))})};c.fireEvent=function(a,b,e,l){var d;e=e||{};if(g.createEvent&&(a.dispatchEvent||a.fireEvent)){var c=
g.createEvent("Events");c.initEvent(b,!0,!0);y(c,e);a.dispatchEvent?a.dispatchEvent(c):a.fireEvent(b,c)}else e.target||y(e,{preventDefault:function(){e.defaultPrevented=!0},target:a,type:b}),function(b,l){void 0===b&&(b=[]);void 0===l&&(l=[]);var k=0,r=0,g=b.length+l.length;for(d=0;d<g;d++)!1===(b[k]?l[r]?b[k].order<=l[r].order?b[k++]:l[r++]:b[k++]:l[r++]).fn.call(a,e)&&e.preventDefault()}(a.protoEvents&&a.protoEvents[b],a.hcEvents&&a.hcEvents[b]);l&&!e.defaultPrevented&&l.call(a,e)};c.animate=function(a,
b,e){var d,g="",h,p;if(!z(e)){var u=arguments;e={duration:u[2],easing:u[3],complete:u[4]}}v(e.duration)||(e.duration=400);e.easing="function"===typeof e.easing?e.easing:Math[e.easing]||Math.easeInOutSine;e.curAnim=c.merge(b);n(b,function(k,l){c.stop(a,l);p=new c.Fx(a,e,l);h=null;"d"===l?(p.paths=p.initPath(a,a.d,b.d),p.toD=b.d,d=0,h=1):a.attr?d=a.attr(l):(d=parseFloat(c.getStyle(a,l))||0,"opacity"!==l&&(g="px"));h||(h=k);h&&h.match&&h.match("px")&&(h=h.replace(/px/g,""));p.run(d,h,g)})};c.seriesType=
function(a,b,e,l,g){var d=c.getOptions(),p=c.seriesTypes;d.plotOptions[a]=c.merge(d.plotOptions[b],e);p[a]=c.extendClass(p[b]||function(){},l);p[a].prototype.type=a;g&&(p[a].prototype.pointClass=c.extendClass(c.Point,g));return p[a]};c.uniqueKey=function(){var a=Math.random().toString(36).substring(2,9),b=0;return function(){return"highcharts-"+a+"-"+b++}}();c.isFunction=function(a){return"function"===typeof a};b.jQuery&&(b.jQuery.fn.highcharts=function(){var a=[].slice.call(arguments);if(this[0])return a[0]?
(new (c[F(a[0])?a.shift():"Chart"])(this[0],a[0],a[1]),this):q[H(this[0],"data-highcharts-chart")]});return{arrayMax:function(a){for(var b=a.length,e=a[0];b--;)a[b]>e&&(e=a[b]);return e},arrayMin:function(a){for(var b=a.length,e=a[0];b--;)a[b]<e&&(e=a[b]);return e},attr:H,defined:C,destroyObjectProperties:function(a,b){n(a,function(d,l){d&&d!==b&&d.destroy&&d.destroy();delete a[l]})},discardElement:function(a){var b=c.garbageBin;b||(b=c.createElement("div"));a&&b.appendChild(a);b.innerHTML=""},erase:function(a,
b){for(var d=a.length;d--;)if(a[d]===b){a.splice(d,1);break}},extend:y,isArray:G,isClass:t,isDOMElement:B,isNumber:v,isObject:z,isString:F,objectEach:n,pick:h,pInt:f,setAnimation:function(a,b){b.renderer.globalAnimation=h(a,b.options.chart.animation,!0)},splat:function(a){return G(a)?a:[a]},syncTimeout:function(a,b,e){if(0<b)return setTimeout(a,b,e);a.call(0,e);return-1}}});M(I,"parts/Color.js",[I["parts/Globals.js"],I["parts/Utilities.js"]],function(c,f){var F=f.isNumber,G=f.pInt,z=c.merge;c.Color=
function(f){if(!(this instanceof c.Color))return new c.Color(f);this.init(f)};c.Color.prototype={parsers:[{regex:/rgba\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]?(?:\.[0-9]+)?)\s*\)/,parse:function(c){return[G(c[1]),G(c[2]),G(c[3]),parseFloat(c[4],10)]}},{regex:/rgb\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*\)/,parse:function(c){return[G(c[1]),G(c[2]),G(c[3]),1]}}],names:{white:"#ffffff",black:"#000000"},init:function(f){var t,v;if((this.input=f=this.names[f&&
f.toLowerCase?f.toLowerCase():""]||f)&&f.stops)this.stops=f.stops.map(function(f){return new c.Color(f[1])});else{if(f&&f.charAt&&"#"===f.charAt()){var C=f.length;f=parseInt(f.substr(1),16);7===C?t=[(f&16711680)>>16,(f&65280)>>8,f&255,1]:4===C&&(t=[(f&3840)>>4|(f&3840)>>8,(f&240)>>4|f&240,(f&15)<<4|f&15,1])}if(!t)for(v=this.parsers.length;v--&&!t;){var B=this.parsers[v];(C=B.regex.exec(f))&&(t=B.parse(C))}}this.rgba=t||[]},get:function(c){var f=this.input,v=this.rgba;if(this.stops){var C=z(f);C.stops=
[].concat(C.stops);this.stops.forEach(function(f,v){C.stops[v]=[C.stops[v][0],f.get(c)]})}else C=v&&F(v[0])?"rgb"===c||!c&&1===v[3]?"rgb("+v[0]+","+v[1]+","+v[2]+")":"a"===c?v[3]:"rgba("+v.join(",")+")":f;return C},brighten:function(c){var f,v=this.rgba;if(this.stops)this.stops.forEach(function(f){f.brighten(c)});else if(F(c)&&0!==c)for(f=0;3>f;f++)v[f]+=G(255*c),0>v[f]&&(v[f]=0),255<v[f]&&(v[f]=255);return this},setOpacity:function(c){this.rgba[3]=c;return this},tweenTo:function(c,f){var v=this.rgba,
t=c.rgba;t.length&&v&&v.length?(c=1!==t[3]||1!==v[3],f=(c?"rgba(":"rgb(")+Math.round(t[0]+(v[0]-t[0])*(1-f))+","+Math.round(t[1]+(v[1]-t[1])*(1-f))+","+Math.round(t[2]+(v[2]-t[2])*(1-f))+(c?","+(t[3]+(v[3]-t[3])*(1-f)):"")+")"):f=c.input||"none";return f}};c.color=function(f){return new c.Color(f)}});M(I,"parts/SvgRenderer.js",[I["parts/Globals.js"],I["parts/Utilities.js"]],function(c,f){var F=f.attr,G=f.defined,z=f.destroyObjectProperties,B=f.erase,t=f.extend,v=f.isArray,C=f.isNumber,H=f.isObject,
y=f.isString,h=f.objectEach,n=f.pick,q=f.pInt,g=f.splat,b=c.addEvent,a=c.animate,d=c.charts,e=c.color,l=c.css,L=c.createElement,E=c.deg2rad,p=c.doc,u=c.hasTouch,k=c.isFirefox,r=c.isMS,x=c.isWebKit,A=c.merge,w=c.noop,m=c.removeEvent,K=c.stop,J=c.svg,U=c.SVG_NS,S=c.symbolSizes,Q=c.win;var O=c.SVGElement=function(){return this};t(O.prototype,{opacity:1,SVG_NS:U,textProps:"direction fontSize fontWeight fontFamily fontStyle color lineHeight width textAlign textDecoration textOverflow textOutline cursor".split(" "),
init:function(a,b){this.element="span"===b?L(b):p.createElementNS(this.SVG_NS,b);this.renderer=a;c.fireEvent(this,"afterInit")},animate:function(b,d,m){var D=c.animObject(n(d,this.renderer.globalAnimation,!0));n(p.hidden,p.msHidden,p.webkitHidden,!1)&&(D.duration=0);0!==D.duration?(m&&(D.complete=m),a(this,b,D)):(this.attr(b,void 0,m),h(b,function(a,b){D.step&&D.step.call(this,a,{prop:b,pos:1})},this));return this},complexColor:function(a,b,d){var D=this.renderer,m,e,w,N,k,l,g,r,x,p,K,J=[],T;c.fireEvent(this.renderer,
"complexColor",{args:arguments},function(){a.radialGradient?e="radialGradient":a.linearGradient&&(e="linearGradient");e&&(w=a[e],k=D.gradients,g=a.stops,p=d.radialReference,v(w)&&(a[e]=w={x1:w[0],y1:w[1],x2:w[2],y2:w[3],gradientUnits:"userSpaceOnUse"}),"radialGradient"===e&&p&&!G(w.gradientUnits)&&(N=w,w=A(w,D.getRadialAttr(p,N),{gradientUnits:"userSpaceOnUse"})),h(w,function(a,b){"id"!==b&&J.push(b,a)}),h(g,function(a){J.push(a)}),J=J.join(","),k[J]?K=k[J].attr("id"):(w.id=K=c.uniqueKey(),k[J]=l=
D.createElement(e).attr(w).add(D.defs),l.radAttr=N,l.stops=[],g.forEach(function(a){0===a[1].indexOf("rgba")?(m=c.color(a[1]),r=m.get("rgb"),x=m.get("a")):(r=a[1],x=1);a=D.createElement("stop").attr({offset:a[0],"stop-color":r,"stop-opacity":x}).add(l);l.stops.push(a)})),T="url("+D.url+"#"+K+")",d.setAttribute(b,T),d.gradient=J,a.toString=function(){return T})})},applyTextOutline:function(a){var b=this.element,D;-1!==a.indexOf("contrast")&&(a=a.replace(/contrast/g,this.renderer.getContrast(b.style.fill)));
a=a.split(" ");var d=a[a.length-1];if((D=a[0])&&"none"!==D&&c.svg){this.fakeTS=!0;a=[].slice.call(b.getElementsByTagName("tspan"));this.ySetter=this.xSetter;D=D.replace(/(^[\d\.]+)(.*?)$/g,function(a,b,D){return 2*b+D});this.removeTextOutline(a);var m=b.firstChild;a.forEach(function(a,e){0===e&&(a.setAttribute("x",b.getAttribute("x")),e=b.getAttribute("y"),a.setAttribute("y",e||0),null===e&&b.setAttribute("y",0));a=a.cloneNode(1);F(a,{"class":"highcharts-text-outline",fill:d,stroke:d,"stroke-width":D,
"stroke-linejoin":"round"});b.insertBefore(a,m)})}},removeTextOutline:function(a){for(var b=a.length,D;b--;)D=a[b],"highcharts-text-outline"===D.getAttribute("class")&&B(a,this.element.removeChild(D))},symbolCustomAttribs:"x y width height r start end innerR anchorX anchorY rounded".split(" "),attr:function(a,b,d,e){var D=this.element,m,w=this,N,k,l=this.symbolCustomAttribs;if("string"===typeof a&&void 0!==b){var g=a;a={};a[g]=b}"string"===typeof a?w=(this[a+"Getter"]||this._defaultGetter).call(this,
a,D):(h(a,function(b,d){N=!1;e||K(this,d);this.symbolName&&-1!==c.inArray(d,l)&&(m||(this.symbolAttr(a),m=!0),N=!0);!this.rotation||"x"!==d&&"y"!==d||(this.doTransform=!0);N||(k=this[d+"Setter"]||this._defaultSetter,k.call(this,b,d,D),!this.styledMode&&this.shadows&&/^(width|height|visibility|x|y|d|transform|cx|cy|r)$/.test(d)&&this.updateShadows(d,b,k))},this),this.afterSetters());d&&d.call(this);return w},afterSetters:function(){this.doTransform&&(this.updateTransform(),this.doTransform=!1)},updateShadows:function(a,
b,d){for(var D=this.shadows,e=D.length;e--;)d.call(D[e],"height"===a?Math.max(b-(D[e].cutHeight||0),0):"d"===a?this.d:b,a,D[e])},addClass:function(a,b){var D=b?"":this.attr("class")||"";a=(a||"").split(/ /g).reduce(function(a,b){-1===D.indexOf(b)&&a.push(b);return a},D?[D]:[]).join(" ");a!==D&&this.attr("class",a);return this},hasClass:function(a){return-1!==(this.attr("class")||"").split(" ").indexOf(a)},removeClass:function(a){return this.attr("class",(this.attr("class")||"").replace(y(a)?new RegExp(" ?"+
a+" ?"):a,""))},symbolAttr:function(a){var b=this;"x y r start end width height innerR anchorX anchorY clockwise".split(" ").forEach(function(D){b[D]=n(a[D],b[D])});b.attr({d:b.renderer.symbols[b.symbolName](b.x,b.y,b.width,b.height,b)})},clip:function(a){return this.attr("clip-path",a?"url("+this.renderer.url+"#"+a.id+")":"none")},crisp:function(a,b){b=b||a.strokeWidth||0;var D=Math.round(b)%2/2;a.x=Math.floor(a.x||this.x||0)+D;a.y=Math.floor(a.y||this.y||0)+D;a.width=Math.floor((a.width||this.width||
0)-2*D);a.height=Math.floor((a.height||this.height||0)-2*D);G(a.strokeWidth)&&(a.strokeWidth=b);return a},css:function(a){var b=this.styles,D={},d=this.element,e="",m=!b,w=["textOutline","textOverflow","width"];a&&a.color&&(a.fill=a.color);b&&h(a,function(a,d){a!==b[d]&&(D[d]=a,m=!0)});if(m){b&&(a=t(b,D));if(a)if(null===a.width||"auto"===a.width)delete this.textWidth;else if("text"===d.nodeName.toLowerCase()&&a.width)var k=this.textWidth=q(a.width);this.styles=a;k&&!J&&this.renderer.forExport&&delete a.width;
if(d.namespaceURI===this.SVG_NS){var g=function(a,b){return"-"+b.toLowerCase()};h(a,function(a,b){-1===w.indexOf(b)&&(e+=b.replace(/([A-Z])/g,g)+":"+a+";")});e&&F(d,"style",e)}else l(d,a);this.added&&("text"===this.element.nodeName&&this.renderer.buildText(this),a&&a.textOutline&&this.applyTextOutline(a.textOutline))}return this},getStyle:function(a){return Q.getComputedStyle(this.element||this,"").getPropertyValue(a)},strokeWidth:function(){if(!this.renderer.styledMode)return this["stroke-width"]||
0;var a=this.getStyle("stroke-width");if(a.indexOf("px")===a.length-2)a=q(a);else{var b=p.createElementNS(U,"rect");F(b,{width:a,"stroke-width":0});this.element.parentNode.appendChild(b);a=b.getBBox().width;b.parentNode.removeChild(b)}return a},on:function(a,b){var d=this,D=d.element;u&&"click"===a?(D.ontouchstart=function(a){d.touchEventFired=Date.now();a.preventDefault();b.call(D,a)},D.onclick=function(a){(-1===Q.navigator.userAgent.indexOf("Android")||1100<Date.now()-(d.touchEventFired||0))&&b.call(D,
a)}):D["on"+a]=b;return this},setRadialReference:function(a){var b=this.renderer.gradients[this.element.gradient];this.element.radialReference=a;b&&b.radAttr&&b.animate(this.renderer.getRadialAttr(a,b.radAttr));return this},translate:function(a,b){return this.attr({translateX:a,translateY:b})},invert:function(a){this.inverted=a;this.updateTransform();return this},updateTransform:function(){var a=this.translateX||0,b=this.translateY||0,d=this.scaleX,e=this.scaleY,m=this.inverted,w=this.rotation,k=
this.matrix,l=this.element;m&&(a+=this.width,b+=this.height);a=["translate("+a+","+b+")"];G(k)&&a.push("matrix("+k.join(",")+")");m?a.push("rotate(90) scale(-1,1)"):w&&a.push("rotate("+w+" "+n(this.rotationOriginX,l.getAttribute("x"),0)+" "+n(this.rotationOriginY,l.getAttribute("y")||0)+")");(G(d)||G(e))&&a.push("scale("+n(d,1)+" "+n(e,1)+")");a.length&&l.setAttribute("transform",a.join(" "))},toFront:function(){var a=this.element;a.parentNode.appendChild(a);return this},align:function(a,b,d){var e,
m={};var D=this.renderer;var w=D.alignedObjects;var k,l;if(a){if(this.alignOptions=a,this.alignByTranslate=b,!d||y(d))this.alignTo=e=d||"renderer",B(w,this),w.push(this),d=null}else a=this.alignOptions,b=this.alignByTranslate,e=this.alignTo;d=n(d,D[e],D);e=a.align;D=a.verticalAlign;w=(d.x||0)+(a.x||0);var N=(d.y||0)+(a.y||0);"right"===e?k=1:"center"===e&&(k=2);k&&(w+=(d.width-(a.width||0))/k);m[b?"translateX":"x"]=Math.round(w);"bottom"===D?l=1:"middle"===D&&(l=2);l&&(N+=(d.height-(a.height||0))/
l);m[b?"translateY":"y"]=Math.round(N);this[this.placed?"animate":"attr"](m);this.placed=!0;this.alignAttr=m;return this},getBBox:function(a,b){var d,e=this.renderer,m=this.element,D=this.styles,w=this.textStr,k,l=e.cache,N=e.cacheKeys,g=m.namespaceURI===this.SVG_NS;b=n(b,this.rotation,0);var r=e.styledMode?m&&O.prototype.getStyle.call(m,"font-size"):D&&D.fontSize;if(G(w)){var c=w.toString();-1===c.indexOf("<")&&(c=c.replace(/[0-9]/g,"0"));c+=["",b,r,this.textWidth,D&&D.textOverflow].join()}c&&!a&&
(d=l[c]);if(!d){if(g||e.forExport){try{(k=this.fakeTS&&function(a){[].forEach.call(m.querySelectorAll(".highcharts-text-outline"),function(b){b.style.display=a})})&&k("none"),d=m.getBBox?t({},m.getBBox()):{width:m.offsetWidth,height:m.offsetHeight},k&&k("")}catch(aa){""}if(!d||0>d.width)d={width:0,height:0}}else d=this.htmlGetBBox();e.isSVG&&(a=d.width,e=d.height,g&&(d.height=e={"11px,17":14,"13px,20":16}[D&&D.fontSize+","+Math.round(e)]||e),b&&(D=b*E,d.width=Math.abs(e*Math.sin(D))+Math.abs(a*Math.cos(D)),
d.height=Math.abs(e*Math.cos(D))+Math.abs(a*Math.sin(D))));if(c&&0<d.height){for(;250<N.length;)delete l[N.shift()];l[c]||N.push(c);l[c]=d}}return d},show:function(a){return this.attr({visibility:a?"inherit":"visible"})},hide:function(a){a?this.attr({y:-9999}):this.attr({visibility:"hidden"});return this},fadeOut:function(a){var b=this;b.animate({opacity:0},{duration:a||150,complete:function(){b.attr({y:-9999})}})},add:function(a){var b=this.renderer,d=this.element;a&&(this.parentGroup=a);this.parentInverted=
a&&a.inverted;void 0!==this.textStr&&b.buildText(this);this.added=!0;if(!a||a.handleZ||this.zIndex)var e=this.zIndexSetter();e||(a?a.element:b.box).appendChild(d);if(this.onAdd)this.onAdd();return this},safeRemoveChild:function(a){var b=a.parentNode;b&&b.removeChild(a)},destroy:function(){var a=this,b=a.element||{},d=a.renderer,e=d.isSVG&&"SPAN"===b.nodeName&&a.parentGroup,m=b.ownerSVGElement,w=a.clipPath;b.onclick=b.onmouseout=b.onmouseover=b.onmousemove=b.point=null;K(a);w&&m&&([].forEach.call(m.querySelectorAll("[clip-path],[CLIP-PATH]"),
function(a){-1<a.getAttribute("clip-path").indexOf(w.element.id)&&a.removeAttribute("clip-path")}),a.clipPath=w.destroy());if(a.stops){for(m=0;m<a.stops.length;m++)a.stops[m]=a.stops[m].destroy();a.stops=null}a.safeRemoveChild(b);for(d.styledMode||a.destroyShadows();e&&e.div&&0===e.div.childNodes.length;)b=e.parentGroup,a.safeRemoveChild(e.div),delete e.div,e=b;a.alignTo&&B(d.alignedObjects,a);h(a,function(b,d){a[d]&&a[d].parentGroup===a&&a[d].destroy&&a[d].destroy();delete a[d]})},shadow:function(a,
b,d){var e=[],m,w=this.element;if(!a)this.destroyShadows();else if(!this.shadows){var D=n(a.width,3);var k=(a.opacity||.15)/D;var l=this.parentInverted?"(-1,-1)":"("+n(a.offsetX,1)+", "+n(a.offsetY,1)+")";for(m=1;m<=D;m++){var g=w.cloneNode(0);var r=2*D+1-2*m;F(g,{stroke:a.color||"#000000","stroke-opacity":k*m,"stroke-width":r,transform:"translate"+l,fill:"none"});g.setAttribute("class",(g.getAttribute("class")||"")+" highcharts-shadow");d&&(F(g,"height",Math.max(F(g,"height")-r,0)),g.cutHeight=r);
b?b.element.appendChild(g):w.parentNode&&w.parentNode.insertBefore(g,w);e.push(g)}this.shadows=e}return this},destroyShadows:function(){(this.shadows||[]).forEach(function(a){this.safeRemoveChild(a)},this);this.shadows=void 0},xGetter:function(a){"circle"===this.element.nodeName&&("x"===a?a="cx":"y"===a&&(a="cy"));return this._defaultGetter(a)},_defaultGetter:function(a){a=n(this[a+"Value"],this[a],this.element?this.element.getAttribute(a):null,0);/^[\-0-9\.]+$/.test(a)&&(a=parseFloat(a));return a},
dSetter:function(a,b,d){a&&a.join&&(a=a.join(" "));/(NaN| {2}|^$)/.test(a)&&(a="M 0 0");this[b]!==a&&(d.setAttribute(b,a),this[b]=a)},dashstyleSetter:function(a){var b,d=this["stroke-width"];"inherit"===d&&(d=1);if(a=a&&a.toLowerCase()){a=a.replace("shortdashdotdot","3,1,1,1,1,1,").replace("shortdashdot","3,1,1,1").replace("shortdot","1,1,").replace("shortdash","3,1,").replace("longdash","8,3,").replace(/dot/g,"1,3,").replace("dash","4,3,").replace(/,$/,"").split(",");for(b=a.length;b--;)a[b]=q(a[b])*
d;a=a.join(",").replace(/NaN/g,"none");this.element.setAttribute("stroke-dasharray",a)}},alignSetter:function(a){var b={left:"start",center:"middle",right:"end"};b[a]&&(this.alignValue=a,this.element.setAttribute("text-anchor",b[a]))},opacitySetter:function(a,b,d){this[b]=a;d.setAttribute(b,a)},titleSetter:function(a){var b=this.element.getElementsByTagName("title")[0];b||(b=p.createElementNS(this.SVG_NS,"title"),this.element.appendChild(b));b.firstChild&&b.removeChild(b.firstChild);b.appendChild(p.createTextNode(String(n(a,
"")).replace(/<[^>]*>/g,"").replace(/&lt;/g,"<").replace(/&gt;/g,">")))},textSetter:function(a){a!==this.textStr&&(delete this.bBox,delete this.textPxLength,this.textStr=a,this.added&&this.renderer.buildText(this))},setTextPath:function(a,b){var d=this.element,e={textAnchor:"text-anchor"},m=!1,D=this.textPathWrapper,k=!D;b=A(!0,{enabled:!0,attributes:{dy:-5,startOffset:"50%",textAnchor:"middle"}},b);var l=b.attributes;if(a&&b&&b.enabled){this.options&&this.options.padding&&(l.dx=-this.options.padding);
D||(this.textPathWrapper=D=this.renderer.createElement("textPath"),m=!0);var g=D.element;(b=a.element.getAttribute("id"))||a.element.setAttribute("id",b=c.uniqueKey());if(k)for(a=d.getElementsByTagName("tspan");a.length;)a[0].setAttribute("y",0),g.appendChild(a[0]);m&&D.add({element:this.text?this.text.element:d});g.setAttributeNS("http://www.w3.org/1999/xlink","href",this.renderer.url+"#"+b);G(l.dy)&&(g.parentNode.setAttribute("dy",l.dy),delete l.dy);G(l.dx)&&(g.parentNode.setAttribute("dx",l.dx),
delete l.dx);h(l,function(a,b){g.setAttribute(e[b]||b,a)});d.removeAttribute("transform");this.removeTextOutline.call(D,[].slice.call(d.getElementsByTagName("tspan")));this.text&&!this.renderer.styledMode&&this.attr({fill:"none","stroke-width":0});this.applyTextOutline=this.updateTransform=w}else D&&(delete this.updateTransform,delete this.applyTextOutline,this.destroyTextPath(d,a));return this},destroyTextPath:function(a,b){var d;b.element.setAttribute("id","");for(d=this.textPathWrapper.element.childNodes;d.length;)a.firstChild.appendChild(d[0]);
a.firstChild.removeChild(this.textPathWrapper.element);delete b.textPathWrapper},fillSetter:function(a,b,d){"string"===typeof a?d.setAttribute(b,a):a&&this.complexColor(a,b,d)},visibilitySetter:function(a,b,d){"inherit"===a?d.removeAttribute(b):this[b]!==a&&d.setAttribute(b,a);this[b]=a},zIndexSetter:function(a,b){var d=this.renderer,e=this.parentGroup,m=(e||d).element||d.box,w=this.element,k=!1;d=m===d.box;var D=this.added;var l;G(a)?(w.setAttribute("data-z-index",a),a=+a,this[b]===a&&(D=!1)):G(this[b])&&
w.removeAttribute("data-z-index");this[b]=a;if(D){(a=this.zIndex)&&e&&(e.handleZ=!0);b=m.childNodes;for(l=b.length-1;0<=l&&!k;l--){e=b[l];D=e.getAttribute("data-z-index");var g=!G(D);if(e!==w)if(0>a&&g&&!d&&!l)m.insertBefore(w,b[l]),k=!0;else if(q(D)<=a||g&&(!G(a)||0<=a))m.insertBefore(w,b[l+1]||null),k=!0}k||(m.insertBefore(w,b[d?3:0]||null),k=!0)}return k},_defaultSetter:function(a,b,d){d.setAttribute(b,a)}});O.prototype.yGetter=O.prototype.xGetter;O.prototype.translateXSetter=O.prototype.translateYSetter=
O.prototype.rotationSetter=O.prototype.verticalAlignSetter=O.prototype.rotationOriginXSetter=O.prototype.rotationOriginYSetter=O.prototype.scaleXSetter=O.prototype.scaleYSetter=O.prototype.matrixSetter=function(a,b){this[b]=a;this.doTransform=!0};O.prototype["stroke-widthSetter"]=O.prototype.strokeSetter=function(a,b,d){this[b]=a;this.stroke&&this["stroke-width"]?(O.prototype.fillSetter.call(this,this.stroke,"stroke",d),d.setAttribute("stroke-width",this["stroke-width"]),this.hasStroke=!0):"stroke-width"===
b&&0===a&&this.hasStroke?(d.removeAttribute("stroke"),this.hasStroke=!1):this.renderer.styledMode&&this["stroke-width"]&&(d.setAttribute("stroke-width",this["stroke-width"]),this.hasStroke=!0)};f=c.SVGRenderer=function(){this.init.apply(this,arguments)};t(f.prototype,{Element:O,SVG_NS:U,init:function(a,d,e,m,w,g,r){var D=this.createElement("svg").attr({version:"1.1","class":"highcharts-root"});r||D.css(this.getStyle(m));m=D.element;a.appendChild(m);F(a,"dir","ltr");-1===a.innerHTML.indexOf("xmlns")&&
F(m,"xmlns",this.SVG_NS);this.isSVG=!0;this.box=m;this.boxWrapper=D;this.alignedObjects=[];this.url=(k||x)&&p.getElementsByTagName("base").length?Q.location.href.split("#")[0].replace(/<[^>]*>/g,"").replace(/([\('\)])/g,"\\$1").replace(/ /g,"%20"):"";this.createElement("desc").add().element.appendChild(p.createTextNode("Created with Highcharts 7.2.1"));this.defs=this.createElement("defs").add();this.allowHTML=g;this.forExport=w;this.styledMode=r;this.gradients={};this.cache={};this.cacheKeys=[];this.imgCount=
0;this.setSize(d,e,!1);var c;k&&a.getBoundingClientRect&&(d=function(){l(a,{left:0,top:0});c=a.getBoundingClientRect();l(a,{left:Math.ceil(c.left)-c.left+"px",top:Math.ceil(c.top)-c.top+"px"})},d(),this.unSubPixelFix=b(Q,"resize",d))},definition:function(a){function b(a,e){var m;g(a).forEach(function(a){var w=d.createElement(a.tagName),k={};h(a,function(a,b){"tagName"!==b&&"children"!==b&&"textContent"!==b&&(k[b]=a)});w.attr(k);w.add(e||d.defs);a.textContent&&w.element.appendChild(p.createTextNode(a.textContent));
b(a.children||[],w);m=w});return m}var d=this;return b(a)},getStyle:function(a){return this.style=t({fontFamily:'"Lucida Grande", "Lucida Sans Unicode", Arial, Helvetica, sans-serif',fontSize:"12px"},a)},setStyle:function(a){this.boxWrapper.css(this.getStyle(a))},isHidden:function(){return!this.boxWrapper.getBBox().width},destroy:function(){var a=this.defs;this.box=null;this.boxWrapper=this.boxWrapper.destroy();z(this.gradients||{});this.gradients=null;a&&(this.defs=a.destroy());this.unSubPixelFix&&
this.unSubPixelFix();return this.alignedObjects=null},createElement:function(a){var b=new this.Element;b.init(this,a);return b},draw:w,getRadialAttr:function(a,b){return{cx:a[0]-a[2]/2+b.cx*a[2],cy:a[1]-a[2]/2+b.cy*a[2],r:b.r*a[2]}},truncate:function(a,b,d,e,m,w,k){var l=this,D=a.rotation,g,r=e?1:0,c=(d||e).length,x=c,J=[],K=function(a){b.firstChild&&b.removeChild(b.firstChild);a&&b.appendChild(p.createTextNode(a))},N=function(w,D){D=D||w;if(void 0===J[D])if(b.getSubStringLength)try{J[D]=m+b.getSubStringLength(0,
e?D+1:D)}catch(ba){""}else l.getSpanWidth&&(K(k(d||e,w)),J[D]=m+l.getSpanWidth(a,b));return J[D]},A;a.rotation=0;var h=N(b.textContent.length);if(A=m+h>w){for(;r<=c;)x=Math.ceil((r+c)/2),e&&(g=k(e,x)),h=N(x,g&&g.length-1),r===c?r=c+1:h>w?c=x-1:r=x;0===c?K(""):d&&c===d.length-1||K(g||k(d||e,x))}e&&e.splice(0,x);a.actualWidth=h;a.rotation=D;return A},escapes:{"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"},buildText:function(a){var b=a.element,d=this,e=d.forExport,m=n(a.textStr,"").toString(),
w=-1!==m.indexOf("<"),k=b.childNodes,D,g=F(b,"x"),r=a.styles,c=a.textWidth,x=r&&r.lineHeight,K=r&&r.textOutline,A=r&&"ellipsis"===r.textOverflow,u=r&&"nowrap"===r.whiteSpace,L=r&&r.fontSize,E,f=k.length;r=c&&!a.added&&this.box;var S=function(a){var m;d.styledMode||(m=/(px|em)$/.test(a&&a.style.fontSize)?a.style.fontSize:L||d.style.fontSize||12);return x?q(x):d.fontMetrics(m,a.getAttribute("style")?a:b).h},v=function(a,b){h(d.escapes,function(d,m){b&&-1!==b.indexOf(d)||(a=a.toString().replace(new RegExp(d,
"g"),m))});return a},O=function(a,b){var d=a.indexOf("<");a=a.substring(d,a.indexOf(">")-d);d=a.indexOf(b+"=");if(-1!==d&&(d=d+b.length+1,b=a.charAt(d),'"'===b||"'"===b))return a=a.substring(d+1),a.substring(0,a.indexOf(b))},Q=/<br.*?>/g;var t=[m,A,u,x,K,L,c].join();if(t!==a.textCache){for(a.textCache=t;f--;)b.removeChild(k[f]);w||K||A||c||-1!==m.indexOf(" ")&&(!u||Q.test(m))?(r&&r.appendChild(b),w?(m=d.styledMode?m.replace(/<(b|strong)>/g,'<span class="highcharts-strong">').replace(/<(i|em)>/g,'<span class="highcharts-emphasized">'):
m.replace(/<(b|strong)>/g,'<span style="font-weight:bold">').replace(/<(i|em)>/g,'<span style="font-style:italic">'),m=m.replace(/<a/g,"<span").replace(/<\/(b|strong|i|em|a)>/g,"</span>").split(Q)):m=[m],m=m.filter(function(a){return""!==a}),m.forEach(function(m,w){var k=0,r=0;m=m.replace(/^\s+|\s+$/g,"").replace(/<span/g,"|||<span").replace(/<\/span>/g,"</span>|||");var x=m.split("|||");x.forEach(function(m){if(""!==m||1===x.length){var K={},N=p.createElementNS(d.SVG_NS,"tspan"),h,n;(h=O(m,"class"))&&
F(N,"class",h);if(h=O(m,"style"))h=h.replace(/(;| |^)color([ :])/,"$1fill$2"),F(N,"style",h);(n=O(m,"href"))&&!e&&(F(N,"onclick",'location.href="'+n+'"'),F(N,"class","highcharts-anchor"),d.styledMode||l(N,{cursor:"pointer"}));m=v(m.replace(/<[a-zA-Z\/](.|\n)*?>/g,"")||" ");if(" "!==m){N.appendChild(p.createTextNode(m));k?K.dx=0:w&&null!==g&&(K.x=g);F(N,K);b.appendChild(N);!k&&E&&(!J&&e&&l(N,{display:"block"}),F(N,"dy",S(N)));if(c){var T=m.replace(/([^\^])-/g,"$1- ").split(" ");K=!u&&(1<x.length||
w||1<T.length);n=0;var f=S(N);if(A)D=d.truncate(a,N,m,void 0,0,Math.max(0,c-parseInt(L||12,10)),function(a,b){return a.substring(0,b)+"\u2026"});else if(K)for(;T.length;)T.length&&!u&&0<n&&(N=p.createElementNS(U,"tspan"),F(N,{dy:f,x:g}),h&&F(N,"style",h),N.appendChild(p.createTextNode(T.join(" ").replace(/- /g,"-"))),b.appendChild(N)),d.truncate(a,N,null,T,0===n?r:0,c,function(a,b){return T.slice(0,b).join(" ").replace(/- /g,"-")}),r=a.actualWidth,n++}k++}}});E=E||b.childNodes.length}),A&&D&&a.attr("title",
v(a.textStr,["&lt;","&gt;"])),r&&r.removeChild(b),K&&a.applyTextOutline&&a.applyTextOutline(K)):b.appendChild(p.createTextNode(v(m)))}},getContrast:function(a){a=e(a).rgba;a[0]*=1;a[1]*=1.2;a[2]*=.5;return 459<a[0]+a[1]+a[2]?"#000000":"#FFFFFF"},button:function(a,d,m,e,w,k,l,g,c,x){var D=this.label(a,d,m,c,null,null,x,null,"button"),p=0,K=this.styledMode;D.attr(A({padding:8,r:2},w));if(!K){w=A({fill:"#f7f7f7",stroke:"#cccccc","stroke-width":1,style:{color:"#333333",cursor:"pointer",fontWeight:"normal"}},
w);var J=w.style;delete w.style;k=A(w,{fill:"#e6e6e6"},k);var N=k.style;delete k.style;l=A(w,{fill:"#e6ebf5",style:{color:"#000000",fontWeight:"bold"}},l);var h=l.style;delete l.style;g=A(w,{style:{color:"#cccccc"}},g);var u=g.style;delete g.style}b(D.element,r?"mouseover":"mouseenter",function(){3!==p&&D.setState(1)});b(D.element,r?"mouseout":"mouseleave",function(){3!==p&&D.setState(p)});D.setState=function(a){1!==a&&(D.state=p=a);D.removeClass(/highcharts-button-(normal|hover|pressed|disabled)/).addClass("highcharts-button-"+
["normal","hover","pressed","disabled"][a||0]);K||D.attr([w,k,l,g][a||0]).css([J,N,h,u][a||0])};K||D.attr(w).css(t({cursor:"default"},J));return D.on("click",function(a){3!==p&&e.call(D,a)})},crispLine:function(a,b){a[1]===a[4]&&(a[1]=a[4]=Math.round(a[1])-b%2/2);a[2]===a[5]&&(a[2]=a[5]=Math.round(a[2])+b%2/2);return a},path:function(a){var b=this.styledMode?{}:{fill:"none"};v(a)?b.d=a:H(a)&&t(b,a);return this.createElement("path").attr(b)},circle:function(a,b,d){a=H(a)?a:void 0===a?{}:{x:a,y:b,r:d};
b=this.createElement("circle");b.xSetter=b.ySetter=function(a,b,d){d.setAttribute("c"+b,a)};return b.attr(a)},arc:function(a,b,d,m,e,w){H(a)?(m=a,b=m.y,d=m.r,a=m.x):m={innerR:m,start:e,end:w};a=this.symbol("arc",a,b,d,d,m);a.r=d;return a},rect:function(a,b,d,m,e,w){e=H(a)?a.r:e;var k=this.createElement("rect");a=H(a)?a:void 0===a?{}:{x:a,y:b,width:Math.max(d,0),height:Math.max(m,0)};this.styledMode||(void 0!==w&&(a.strokeWidth=w,a=k.crisp(a)),a.fill="none");e&&(a.r=e);k.rSetter=function(a,b,d){k.r=
a;F(d,{rx:a,ry:a})};k.rGetter=function(){return k.r};return k.attr(a)},setSize:function(a,b,d){var m=this.alignedObjects,e=m.length;this.width=a;this.height=b;for(this.boxWrapper.animate({width:a,height:b},{step:function(){this.attr({viewBox:"0 0 "+this.attr("width")+" "+this.attr("height")})},duration:n(d,!0)?void 0:0});e--;)m[e].align()},g:function(a){var b=this.createElement("g");return a?b.attr({"class":"highcharts-"+a}):b},image:function(a,d,m,e,w,k){var l={preserveAspectRatio:"none"},g=function(a,
b){a.setAttributeNS?a.setAttributeNS("http://www.w3.org/1999/xlink","href",b):a.setAttribute("hc-svg-href",b)},r=function(b){g(c.element,a);k.call(c,b)};1<arguments.length&&t(l,{x:d,y:m,width:e,height:w});var c=this.createElement("image").attr(l);k?(g(c.element,"data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="),l=new Q.Image,b(l,"load",r),l.src=a,l.complete&&r({})):g(c.element,a);return c},symbol:function(a,b,m,e,w,k){var g=this,r=/^url\((.*?)\)$/,c=r.test(a),D=!c&&(this.symbols[a]?
a:"circle"),x=D&&this.symbols[D],K=G(b)&&x&&x.call(this.symbols,Math.round(b),Math.round(m),e,w,k);if(x){var J=this.path(K);g.styledMode||J.attr("fill","none");t(J,{symbolName:D,x:b,y:m,width:e,height:w});k&&t(J,k)}else if(c){var A=a.match(r)[1];J=this.image(A);J.imgwidth=n(S[A]&&S[A].width,k&&k.width);J.imgheight=n(S[A]&&S[A].height,k&&k.height);var h=function(){J.attr({width:J.width,height:J.height})};["width","height"].forEach(function(a){J[a+"Setter"]=function(a,b){var d={},m=this["img"+b],e=
"width"===b?"translateX":"translateY";this[b]=a;G(m)&&(k&&"within"===k.backgroundSize&&this.width&&this.height&&(m=Math.round(m*Math.min(this.width/this.imgwidth,this.height/this.imgheight))),this.element&&this.element.setAttribute(b,m),this.alignByTranslate||(d[e]=((this[b]||0)-m)/2,this.attr(d)))}});G(b)&&J.attr({x:b,y:m});J.isImg=!0;G(J.imgwidth)&&G(J.imgheight)?h():(J.attr({width:0,height:0}),L("img",{onload:function(){var a=d[g.chartIndex];0===this.width&&(l(this,{position:"absolute",top:"-999em"}),
p.body.appendChild(this));S[A]={width:this.width,height:this.height};J.imgwidth=this.width;J.imgheight=this.height;J.element&&h();this.parentNode&&this.parentNode.removeChild(this);g.imgCount--;if(!g.imgCount&&a&&a.onload)a.onload()},src:A}),this.imgCount++)}return J},symbols:{circle:function(a,b,d,m){return this.arc(a+d/2,b+m/2,d/2,m/2,{start:.5*Math.PI,end:2.5*Math.PI,open:!1})},square:function(a,b,d,m){return["M",a,b,"L",a+d,b,a+d,b+m,a,b+m,"Z"]},triangle:function(a,b,d,m){return["M",a+d/2,b,"L",
a+d,b+m,a,b+m,"Z"]},"triangle-down":function(a,b,d,m){return["M",a,b,"L",a+d,b,a+d/2,b+m,"Z"]},diamond:function(a,b,d,m){return["M",a+d/2,b,"L",a+d,b+m/2,a+d/2,b+m,a,b+m/2,"Z"]},arc:function(a,b,d,m,e){var w=e.start,k=e.r||d,l=e.r||m||d,g=e.end-.001;d=e.innerR;m=n(e.open,.001>Math.abs(e.end-e.start-2*Math.PI));var r=Math.cos(w),c=Math.sin(w),x=Math.cos(g);g=Math.sin(g);w=.001>e.end-w-Math.PI?0:1;e=["M",a+k*r,b+l*c,"A",k,l,0,w,n(e.clockwise,1),a+k*x,b+l*g];G(d)&&e.push(m?"M":"L",a+d*x,b+d*g,"A",d,
d,0,w,0,a+d*r,b+d*c);e.push(m?"":"Z");return e},callout:function(a,b,d,m,e){var w=Math.min(e&&e.r||0,d,m),k=w+6,l=e&&e.anchorX;e=e&&e.anchorY;var g=["M",a+w,b,"L",a+d-w,b,"C",a+d,b,a+d,b,a+d,b+w,"L",a+d,b+m-w,"C",a+d,b+m,a+d,b+m,a+d-w,b+m,"L",a+w,b+m,"C",a,b+m,a,b+m,a,b+m-w,"L",a,b+w,"C",a,b,a,b,a+w,b];l&&l>d?e>b+k&&e<b+m-k?g.splice(13,3,"L",a+d,e-6,a+d+6,e,a+d,e+6,a+d,b+m-w):g.splice(13,3,"L",a+d,m/2,l,e,a+d,m/2,a+d,b+m-w):l&&0>l?e>b+k&&e<b+m-k?g.splice(33,3,"L",a,e+6,a-6,e,a,e-6,a,b+w):g.splice(33,
3,"L",a,m/2,l,e,a,m/2,a,b+w):e&&e>m&&l>a+k&&l<a+d-k?g.splice(23,3,"L",l+6,b+m,l,b+m+6,l-6,b+m,a+w,b+m):e&&0>e&&l>a+k&&l<a+d-k&&g.splice(3,3,"L",l-6,b,l,b-6,l+6,b,d-w,b);return g}},clipRect:function(a,b,d,m){var e=c.uniqueKey()+"-",w=this.createElement("clipPath").attr({id:e}).add(this.defs);a=this.rect(a,b,d,m,0).add(w);a.id=e;a.clipPath=w;a.count=0;return a},text:function(a,b,d,m){var e={};if(m&&(this.allowHTML||!this.forExport))return this.html(a,b,d);e.x=Math.round(b||0);d&&(e.y=Math.round(d));
G(a)&&(e.text=a);a=this.createElement("text").attr(e);m||(a.xSetter=function(a,b,d){var m=d.getElementsByTagName("tspan"),e=d.getAttribute(b),w;for(w=0;w<m.length;w++){var k=m[w];k.getAttribute(b)===e&&k.setAttribute(b,a)}d.setAttribute(b,a)});return a},fontMetrics:function(a,b){a=!this.styledMode&&/px/.test(a)||!Q.getComputedStyle?a||b&&b.style&&b.style.fontSize||this.style&&this.style.fontSize:b&&O.prototype.getStyle.call(b,"font-size");a=/px/.test(a)?q(a):12;b=24>a?a+3:Math.round(1.2*a);return{h:b,
b:Math.round(.8*b),f:a}},rotCorr:function(a,b,d){var m=a;b&&d&&(m=Math.max(m*Math.cos(b*E),4));return{x:-a/3*Math.sin(b*E),y:m}},label:function(a,b,d,e,w,k,l,g,r){var c=this,x=c.styledMode,J=c.g("button"!==r&&"label"),p=J.text=c.text("",0,0,l).attr({zIndex:1}),K,h,D=0,u=3,L=0,n,N,E,U,f,q={},T,S,v=/^url\((.*?)\)$/.test(e),Q=x||v,y=function(){return x?K.strokeWidth()%2/2:(T?parseInt(T,10):0)%2/2};r&&J.addClass("highcharts-"+r);var R=function(){var a=p.element.style,b={};h=(void 0===n||void 0===N||f)&&
G(p.textStr)&&p.getBBox();J.width=(n||h.width||0)+2*u+L;J.height=(N||h.height||0)+2*u;S=u+Math.min(c.fontMetrics(a&&a.fontSize,p).b,h?h.height:Infinity);Q&&(K||(J.box=K=c.symbols[e]||v?c.symbol(e):c.rect(),K.addClass(("button"===r?"":"highcharts-label-box")+(r?" highcharts-"+r+"-box":"")),K.add(J),a=y(),b.x=a,b.y=(g?-S:0)+a),b.width=Math.round(J.width),b.height=Math.round(J.height),K.attr(t(b,q)),q={})};var B=function(){var a=L+u;var b=g?0:S;G(n)&&h&&("center"===f||"right"===f)&&(a+={center:.5,right:1}[f]*
(n-h.width));if(a!==p.x||b!==p.y)p.attr("x",a),p.hasBoxWidthChanged&&(h=p.getBBox(!0),R()),void 0!==b&&p.attr("y",b);p.x=a;p.y=b};var V=function(a,b){K?K.attr(a,b):q[a]=b};J.onAdd=function(){p.add(J);J.attr({text:a||0===a?a:"",x:b,y:d});K&&G(w)&&J.attr({anchorX:w,anchorY:k})};J.widthSetter=function(a){n=C(a)?a:null};J.heightSetter=function(a){N=a};J["text-alignSetter"]=function(a){f=a};J.paddingSetter=function(a){G(a)&&a!==u&&(u=J.padding=a,B())};J.paddingLeftSetter=function(a){G(a)&&a!==L&&(L=a,
B())};J.alignSetter=function(a){a={left:0,center:.5,right:1}[a];a!==D&&(D=a,h&&J.attr({x:E}))};J.textSetter=function(a){void 0!==a&&p.attr({text:a});R();B()};J["stroke-widthSetter"]=function(a,b){a&&(Q=!0);T=this["stroke-width"]=a;V(b,a)};x?J.rSetter=function(a,b){V(b,a)}:J.strokeSetter=J.fillSetter=J.rSetter=function(a,b){"r"!==b&&("fill"===b&&a&&(Q=!0),J[b]=a);V(b,a)};J.anchorXSetter=function(a,b){w=J.anchorX=a;V(b,Math.round(a)-y()-E)};J.anchorYSetter=function(a,b){k=J.anchorY=a;V(b,a-U)};J.xSetter=
function(a){J.x=a;D&&(a-=D*((n||h.width)+2*u),J["forceAnimate:x"]=!0);E=Math.round(a);J.attr("translateX",E)};J.ySetter=function(a){U=J.y=Math.round(a);J.attr("translateY",U)};var H=J.css;l={css:function(a){if(a){var b={};a=A(a);J.textProps.forEach(function(d){void 0!==a[d]&&(b[d]=a[d],delete a[d])});p.css(b);"width"in b&&R();"fontSize"in b&&(R(),B())}return H.call(J,a)},getBBox:function(){return{width:h.width+2*u,height:h.height+2*u,x:h.x-u,y:h.y-u}},destroy:function(){m(J.element,"mouseenter");
m(J.element,"mouseleave");p&&(p=p.destroy());K&&(K=K.destroy());O.prototype.destroy.call(J);J=c=R=B=V=null}};x||(l.shadow=function(a){a&&(R(),K&&K.shadow(a));return J});return t(J,l)}});c.Renderer=f});M(I,"parts/Html.js",[I["parts/Globals.js"],I["parts/Utilities.js"]],function(c,f){var F=f.attr,G=f.defined,z=f.extend,B=f.pick,t=f.pInt,v=c.createElement,C=c.css,H=c.isFirefox,y=c.isMS,h=c.isWebKit,n=c.SVGElement;f=c.SVGRenderer;var q=c.win;z(n.prototype,{htmlCss:function(g){var b="SPAN"===this.element.tagName&&
g&&"width"in g,a=B(b&&g.width,void 0);if(b){delete g.width;this.textWidth=a;var d=!0}g&&"ellipsis"===g.textOverflow&&(g.whiteSpace="nowrap",g.overflow="hidden");this.styles=z(this.styles,g);C(this.element,g);d&&this.htmlUpdateTransform();return this},htmlGetBBox:function(){var g=this.element;return{x:g.offsetLeft,y:g.offsetTop,width:g.offsetWidth,height:g.offsetHeight}},htmlUpdateTransform:function(){if(this.added){var g=this.renderer,b=this.element,a=this.translateX||0,d=this.translateY||0,e=this.x||
0,l=this.y||0,c=this.textAlign||"left",h={left:0,center:.5,right:1}[c],p=this.styles,u=p&&p.whiteSpace;C(b,{marginLeft:a,marginTop:d});!g.styledMode&&this.shadows&&this.shadows.forEach(function(b){C(b,{marginLeft:a+1,marginTop:d+1})});this.inverted&&[].forEach.call(b.childNodes,function(a){g.invertChild(a,b)});if("SPAN"===b.tagName){p=this.rotation;var k=this.textWidth&&t(this.textWidth),r=[p,c,b.innerHTML,this.textWidth,this.textAlign].join(),x;(x=k!==this.oldTextWidth)&&!(x=k>this.oldTextWidth)&&
((x=this.textPxLength)||(C(b,{width:"",whiteSpace:u||"nowrap"}),x=b.offsetWidth),x=x>k);x&&(/[ \-]/.test(b.textContent||b.innerText)||"ellipsis"===b.style.textOverflow)?(C(b,{width:k+"px",display:"block",whiteSpace:u||"normal"}),this.oldTextWidth=k,this.hasBoxWidthChanged=!0):this.hasBoxWidthChanged=!1;r!==this.cTT&&(u=g.fontMetrics(b.style.fontSize,b).b,!G(p)||p===(this.oldRotation||0)&&c===this.oldAlign||this.setSpanRotation(p,h,u),this.getSpanCorrection(!G(p)&&this.textPxLength||b.offsetWidth,
u,h,p,c));C(b,{left:e+(this.xCorr||0)+"px",top:l+(this.yCorr||0)+"px"});this.cTT=r;this.oldRotation=p;this.oldAlign=c}}else this.alignOnAdd=!0},setSpanRotation:function(g,b,a){var d={},e=this.renderer.getTransformKey();d[e]=d.transform="rotate("+g+"deg)";d[e+(H?"Origin":"-origin")]=d.transformOrigin=100*b+"% "+a+"px";C(this.element,d)},getSpanCorrection:function(g,b,a){this.xCorr=-g*a;this.yCorr=-b}});z(f.prototype,{getTransformKey:function(){return y&&!/Edge/.test(q.navigator.userAgent)?"-ms-transform":
h?"-webkit-transform":H?"MozTransform":q.opera?"-o-transform":""},html:function(g,b,a){var d=this.createElement("span"),e=d.element,l=d.renderer,c=l.isSVG,h=function(a,b){["opacity","visibility"].forEach(function(d){a[d+"Setter"]=function(e,k,l){var w=a.div?a.div.style:b;n.prototype[d+"Setter"].call(this,e,k,l);w&&(w[k]=e)}});a.addedSetters=!0};d.textSetter=function(a){a!==e.innerHTML&&(delete this.bBox,delete this.oldTextWidth);this.textStr=a;e.innerHTML=B(a,"");d.doTransform=!0};c&&h(d,d.element.style);
d.xSetter=d.ySetter=d.alignSetter=d.rotationSetter=function(a,b){"align"===b&&(b="textAlign");d[b]=a;d.doTransform=!0};d.afterSetters=function(){this.doTransform&&(this.htmlUpdateTransform(),this.doTransform=!1)};d.attr({text:g,x:Math.round(b),y:Math.round(a)}).css({position:"absolute"});l.styledMode||d.css({fontFamily:this.style.fontFamily,fontSize:this.style.fontSize});e.style.whiteSpace="nowrap";d.css=d.htmlCss;c&&(d.add=function(a){var b=l.box.parentNode,k=[];if(this.parentGroup=a){var g=a.div;
if(!g){for(;a;)k.push(a),a=a.parentGroup;k.reverse().forEach(function(a){function e(b,d){a[d]=b;"translateX"===d?m.left=b+"px":m.top=b+"px";a.doTransform=!0}var w=F(a.element,"class");g=a.div=a.div||v("div",w?{className:w}:void 0,{position:"absolute",left:(a.translateX||0)+"px",top:(a.translateY||0)+"px",display:a.display,opacity:a.opacity,pointerEvents:a.styles&&a.styles.pointerEvents},g||b);var m=g.style;z(a,{classSetter:function(a){return function(b){this.element.setAttribute("class",b);a.className=
b}}(g),on:function(){k[0].div&&d.on.apply({element:k[0].div},arguments);return a},translateXSetter:e,translateYSetter:e});a.addedSetters||h(a)})}}else g=b;g.appendChild(e);d.added=!0;d.alignOnAdd&&d.htmlUpdateTransform();return d});return d}})});M(I,"parts/Time.js",[I["parts/Globals.js"],I["parts/Utilities.js"]],function(c,f){var F=f.defined,G=f.extend,z=f.isObject,B=f.objectEach,t=f.pick,v=f.splat,C=c.merge,H=c.timeUnits,y=c.win;c.Time=function(c){this.update(c,!1)};c.Time.prototype={defaultOptions:{Date:void 0,
getTimezoneOffset:void 0,timezone:void 0,timezoneOffset:0,useUTC:!0},update:function(c){var h=t(c&&c.useUTC,!0),f=this;this.options=c=C(!0,this.options||{},c);this.Date=c.Date||y.Date||Date;this.timezoneOffset=(this.useUTC=h)&&c.timezoneOffset;this.getTimezoneOffset=this.timezoneOffsetFunction();(this.variableTimezone=!(h&&!c.getTimezoneOffset&&!c.timezone))||this.timezoneOffset?(this.get=function(g,b){var a=b.getTime(),d=a-f.getTimezoneOffset(b);b.setTime(d);g=b["getUTC"+g]();b.setTime(a);return g},
this.set=function(g,b,a){if("Milliseconds"===g||"Seconds"===g||"Minutes"===g&&0===b.getTimezoneOffset()%60)b["set"+g](a);else{var d=f.getTimezoneOffset(b);d=b.getTime()-d;b.setTime(d);b["setUTC"+g](a);g=f.getTimezoneOffset(b);d=b.getTime()+g;b.setTime(d)}}):h?(this.get=function(g,b){return b["getUTC"+g]()},this.set=function(g,b,a){return b["setUTC"+g](a)}):(this.get=function(g,b){return b["get"+g]()},this.set=function(g,b,a){return b["set"+g](a)})},makeTime:function(h,n,f,g,b,a){if(this.useUTC){var d=
this.Date.UTC.apply(0,arguments);var e=this.getTimezoneOffset(d);d+=e;var l=this.getTimezoneOffset(d);e!==l?d+=l-e:e-36E5!==this.getTimezoneOffset(d-36E5)||c.isSafari||(d-=36E5)}else d=(new this.Date(h,n,t(f,1),t(g,0),t(b,0),t(a,0))).getTime();return d},timezoneOffsetFunction:function(){var h=this,n=this.options,f=y.moment;if(!this.useUTC)return function(g){return 6E4*(new Date(g)).getTimezoneOffset()};if(n.timezone){if(f)return function(g){return 6E4*-f.tz(g,n.timezone).utcOffset()};c.error(25)}return this.useUTC&&
n.getTimezoneOffset?function(g){return 6E4*n.getTimezoneOffset(g)}:function(){return 6E4*(h.timezoneOffset||0)}},dateFormat:function(h,n,f){if(!F(n)||isNaN(n))return c.defaultOptions.lang.invalidDate||"";h=t(h,"%Y-%m-%d %H:%M:%S");var g=this,b=new this.Date(n),a=this.get("Hours",b),d=this.get("Day",b),e=this.get("Date",b),l=this.get("Month",b),L=this.get("FullYear",b),E=c.defaultOptions.lang,p=E.weekdays,u=E.shortWeekdays,k=c.pad;b=G({a:u?u[d]:p[d].substr(0,3),A:p[d],d:k(e),e:k(e,2," "),w:d,b:E.shortMonths[l],
B:E.months[l],m:k(l+1),o:l+1,y:L.toString().substr(2,2),Y:L,H:k(a),k:a,I:k(a%12||12),l:a%12||12,M:k(g.get("Minutes",b)),p:12>a?"AM":"PM",P:12>a?"am":"pm",S:k(b.getSeconds()),L:k(Math.floor(n%1E3),3)},c.dateFormats);B(b,function(a,b){for(;-1!==h.indexOf("%"+b);)h=h.replace("%"+b,"function"===typeof a?a.call(g,n):a)});return f?h.substr(0,1).toUpperCase()+h.substr(1):h},resolveDTLFormat:function(c){return z(c,!0)?c:(c=v(c),{main:c[0],from:c[1],to:c[2]})},getTimeTicks:function(c,n,f,g){var b=this,a=[],
d={};var e=new b.Date(n);var l=c.unitRange,h=c.count||1,E;g=t(g,1);if(F(n)){b.set("Milliseconds",e,l>=H.second?0:h*Math.floor(b.get("Milliseconds",e)/h));l>=H.second&&b.set("Seconds",e,l>=H.minute?0:h*Math.floor(b.get("Seconds",e)/h));l>=H.minute&&b.set("Minutes",e,l>=H.hour?0:h*Math.floor(b.get("Minutes",e)/h));l>=H.hour&&b.set("Hours",e,l>=H.day?0:h*Math.floor(b.get("Hours",e)/h));l>=H.day&&b.set("Date",e,l>=H.month?1:Math.max(1,h*Math.floor(b.get("Date",e)/h)));if(l>=H.month){b.set("Month",e,l>=
H.year?0:h*Math.floor(b.get("Month",e)/h));var p=b.get("FullYear",e)}l>=H.year&&b.set("FullYear",e,p-p%h);l===H.week&&(p=b.get("Day",e),b.set("Date",e,b.get("Date",e)-p+g+(p<g?-7:0)));p=b.get("FullYear",e);g=b.get("Month",e);var u=b.get("Date",e),k=b.get("Hours",e);n=e.getTime();b.variableTimezone&&(E=f-n>4*H.month||b.getTimezoneOffset(n)!==b.getTimezoneOffset(f));n=e.getTime();for(e=1;n<f;)a.push(n),n=l===H.year?b.makeTime(p+e*h,0):l===H.month?b.makeTime(p,g+e*h):!E||l!==H.day&&l!==H.week?E&&l===
H.hour&&1<h?b.makeTime(p,g,u,k+e*h):n+l*h:b.makeTime(p,g,u+e*h*(l===H.day?1:7)),e++;a.push(n);l<=H.hour&&1E4>a.length&&a.forEach(function(a){0===a%18E5&&"000000000"===b.dateFormat("%H%M%S%L",a)&&(d[a]="day")})}a.info=G(c,{higherRanks:d,totalRange:l*h});return a}}});M(I,"parts/Options.js",[I["parts/Globals.js"]],function(c){var f=c.color,F=c.merge;c.defaultOptions={colors:"#7cb5ec #434348 #90ed7d #f7a35c #8085e9 #f15c80 #e4d354 #2b908f #f45b5b #91e8e1".split(" "),symbols:["circle","diamond","square",
"triangle","triangle-down"],lang:{loading:"Loading...",months:"January February March April May June July August September October November December".split(" "),shortMonths:"Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec".split(" "),weekdays:"Sunday Monday Tuesday Wednesday Thursday Friday Saturday".split(" "),decimalPoint:".",numericSymbols:"kMGTPE".split(""),resetZoom:"Reset zoom",resetZoomTitle:"Reset zoom level 1:1",thousandsSep:" "},global:{},time:c.Time.prototype.defaultOptions,chart:{styledMode:!1,
borderRadius:0,colorCount:10,defaultSeriesType:"line",ignoreHiddenSeries:!0,spacing:[10,10,15,10],resetZoomButton:{theme:{zIndex:6},position:{align:"right",x:-10,y:10}},width:null,height:null,borderColor:"#335cad",backgroundColor:"#ffffff",plotBorderColor:"#cccccc"},title:{text:"Chart title",align:"center",margin:15,widthAdjust:-44},subtitle:{text:"",align:"center",widthAdjust:-44},caption:{margin:15,text:"",align:"left",verticalAlign:"bottom"},plotOptions:{},labels:{style:{position:"absolute",color:"#333333"}},
legend:{enabled:!0,align:"center",alignColumns:!0,layout:"horizontal",labelFormatter:function(){return this.name},borderColor:"#999999",borderRadius:0,navigation:{activeColor:"#003399",inactiveColor:"#cccccc"},itemStyle:{color:"#333333",cursor:"pointer",fontSize:"12px",fontWeight:"bold",textOverflow:"ellipsis"},itemHoverStyle:{color:"#000000"},itemHiddenStyle:{color:"#cccccc"},shadow:!1,itemCheckboxStyle:{position:"absolute",width:"13px",height:"13px"},squareSymbol:!0,symbolPadding:5,verticalAlign:"bottom",
x:0,y:0,title:{style:{fontWeight:"bold"}}},loading:{labelStyle:{fontWeight:"bold",position:"relative",top:"45%"},style:{position:"absolute",backgroundColor:"#ffffff",opacity:.5,textAlign:"center"}},tooltip:{enabled:!0,animation:c.svg,borderRadius:3,dateTimeLabelFormats:{millisecond:"%A, %b %e, %H:%M:%S.%L",second:"%A, %b %e, %H:%M:%S",minute:"%A, %b %e, %H:%M",hour:"%A, %b %e, %H:%M",day:"%A, %b %e, %Y",week:"Week from %A, %b %e, %Y",month:"%B %Y",year:"%Y"},footerFormat:"",padding:8,snap:c.isTouchDevice?
25:10,headerFormat:'<span style="font-size: 10px">{point.key}</span><br/>',pointFormat:'<span style="color:{point.color}">\u25cf</span> {series.name}: <b>{point.y}</b><br/>',backgroundColor:f("#f7f7f7").setOpacity(.85).get(),borderWidth:1,shadow:!0,style:{color:"#333333",cursor:"default",fontSize:"12px",pointerEvents:"none",whiteSpace:"nowrap"}},credits:{enabled:!0,href:"https://www.highcharts.com?credits",position:{align:"right",x:-10,verticalAlign:"bottom",y:-5},style:{cursor:"pointer",color:"#999999",
fontSize:"9px"},text:"Highcharts.com"}};c.setOptions=function(f){c.defaultOptions=F(!0,c.defaultOptions,f);(f.time||f.global)&&c.time.update(F(c.defaultOptions.global,c.defaultOptions.time,f.global,f.time));return c.defaultOptions};c.getOptions=function(){return c.defaultOptions};c.defaultPlotOptions=c.defaultOptions.plotOptions;c.time=new c.Time(F(c.defaultOptions.global,c.defaultOptions.time));c.dateFormat=function(f,z,B){return c.time.dateFormat(f,z,B)};""});M(I,"parts/Tick.js",[I["parts/Globals.js"],
I["parts/Utilities.js"]],function(c,f){var F=f.defined,G=f.destroyObjectProperties,z=f.extend,B=f.isNumber,t=f.pick,v=c.correctFloat,C=c.fireEvent,H=c.merge,y=c.deg2rad;c.Tick=function(c,n,f,g,b){this.axis=c;this.pos=n;this.type=f||"";this.isNewLabel=this.isNew=!0;this.parameters=b||{};this.tickmarkOffset=this.parameters.tickmarkOffset;this.options=this.parameters.options;f||g||this.addLabel()};c.Tick.prototype={addLabel:function(){var c=this,n=c.axis,f=n.options,g=n.chart,b=n.categories,a=n.names,
d=c.pos,e=t(c.options&&c.options.labels,f.labels),l=n.tickPositions,L=d===l[0],E=d===l[l.length-1];b=this.parameters.category||(b?t(b[d],a[d],d):d);var p=c.label;l=l.info;var u,k;if(n.isDatetimeAxis&&l){var r=g.time.resolveDTLFormat(f.dateTimeLabelFormats[!f.grid&&l.higherRanks[d]||l.unitName]);var x=r.main}c.isFirst=L;c.isLast=E;c.formatCtx={axis:n,chart:g,isFirst:L,isLast:E,dateTimeLabelFormat:x,tickPositionInfo:l,value:n.isLog?v(n.lin2log(b)):b,pos:d};f=n.labelFormatter.call(c.formatCtx,this.formatCtx);
if(k=r&&r.list)c.shortenLabel=function(){for(u=0;u<k.length;u++)if(p.attr({text:n.labelFormatter.call(z(c.formatCtx,{dateTimeLabelFormat:k[u]}))}),p.getBBox().width<n.getSlotWidth(c)-2*t(e.padding,5))return;p.attr({text:""})};if(F(p))p&&p.textStr!==f&&(!p.textWidth||e.style&&e.style.width||p.styles.width||p.css({width:null}),p.attr({text:f}),p.textPxLength=p.getBBox().width);else{if(c.label=p=F(f)&&e.enabled?g.renderer.text(f,0,0,e.useHTML).add(n.labelGroup):null)g.styledMode||p.css(H(e.style)),p.textPxLength=
p.getBBox().width;c.rotation=0}},getLabelSize:function(){return this.label?this.label.getBBox()[this.axis.horiz?"height":"width"]:0},handleOverflow:function(c){var h=this.axis,f=h.options.labels,g=c.x,b=h.chart.chartWidth,a=h.chart.spacing,d=t(h.labelLeft,Math.min(h.pos,a[3]));a=t(h.labelRight,Math.max(h.isRadial?0:h.pos+h.len,b-a[1]));var e=this.label,l=this.rotation,L={left:0,center:.5,right:1}[h.labelAlign||e.attr("align")],E=e.getBBox().width,p=h.getSlotWidth(this),u=p,k=1,r,x={};if(l||"justify"!==
t(f.overflow,"justify"))0>l&&g-L*E<d?r=Math.round(g/Math.cos(l*y)-d):0<l&&g+L*E>a&&(r=Math.round((b-g)/Math.cos(l*y)));else if(b=g+(1-L)*E,g-L*E<d?u=c.x+u*(1-L)-d:b>a&&(u=a-c.x+u*L,k=-1),u=Math.min(p,u),u<p&&"center"===h.labelAlign&&(c.x+=k*(p-u-L*(p-Math.min(E,u)))),E>u||h.autoRotation&&(e.styles||{}).width)r=u;r&&(this.shortenLabel?this.shortenLabel():(x.width=Math.floor(r),(f.style||{}).textOverflow||(x.textOverflow="ellipsis"),e.css(x)))},getPosition:function(h,n,f,g){var b=this.axis,a=b.chart,
d=g&&a.oldChartHeight||a.chartHeight;h={x:h?c.correctFloat(b.translate(n+f,null,null,g)+b.transB):b.left+b.offset+(b.opposite?(g&&a.oldChartWidth||a.chartWidth)-b.right-b.left:0),y:h?d-b.bottom+b.offset-(b.opposite?b.height:0):c.correctFloat(d-b.translate(n+f,null,null,g)-b.transB)};h.y=Math.max(Math.min(h.y,1E5),-1E5);C(this,"afterGetPosition",{pos:h});return h},getLabelPosition:function(c,n,f,g,b,a,d,e){var l=this.axis,h=l.transA,E=l.isLinked&&l.linkedParent?l.linkedParent.reversed:l.reversed,p=
l.staggerLines,u=l.tickRotCorr||{x:0,y:0},k=b.y,r=g||l.reserveSpaceDefault?0:-l.labelOffset*("center"===l.labelAlign?.5:1),x={};F(k)||(k=0===l.side?f.rotation?-8:-f.getBBox().height:2===l.side?u.y+8:Math.cos(f.rotation*y)*(u.y-f.getBBox(!1,0).height/2));c=c+b.x+r+u.x-(a&&g?a*h*(E?-1:1):0);n=n+k-(a&&!g?a*h*(E?1:-1):0);p&&(f=d/(e||1)%p,l.opposite&&(f=p-f-1),n+=l.labelOffset/p*f);x.x=c;x.y=Math.round(n);C(this,"afterGetLabelPosition",{pos:x,tickmarkOffset:a,index:d});return x},getMarkPath:function(c,
n,f,g,b,a){return a.crispLine(["M",c,n,"L",c+(b?0:-f),n+(b?f:0)],g)},renderGridLine:function(c,n,f){var g=this.axis,b=g.options,a=this.gridLine,d={},e=this.pos,l=this.type,h=t(this.tickmarkOffset,g.tickmarkOffset),E=g.chart.renderer,p=l?l+"Grid":"grid",u=b[p+"LineWidth"],k=b[p+"LineColor"];b=b[p+"LineDashStyle"];a||(g.chart.styledMode||(d.stroke=k,d["stroke-width"]=u,b&&(d.dashstyle=b)),l||(d.zIndex=1),c&&(n=0),this.gridLine=a=E.path().attr(d).addClass("highcharts-"+(l?l+"-":"")+"grid-line").add(g.gridGroup));
if(a&&(f=g.getPlotLinePath({value:e+h,lineWidth:a.strokeWidth()*f,force:"pass",old:c})))a[c||this.isNew?"attr":"animate"]({d:f,opacity:n})},renderMark:function(c,n,f){var g=this.axis,b=g.options,a=g.chart.renderer,d=this.type,e=d?d+"Tick":"tick",l=g.tickSize(e),h=this.mark,E=!h,p=c.x;c=c.y;var u=t(b[e+"Width"],!d&&g.isXAxis?1:0);b=b[e+"Color"];l&&(g.opposite&&(l[0]=-l[0]),E&&(this.mark=h=a.path().addClass("highcharts-"+(d?d+"-":"")+"tick").add(g.axisGroup),g.chart.styledMode||h.attr({stroke:b,"stroke-width":u})),
h[E?"attr":"animate"]({d:this.getMarkPath(p,c,l[0],h.strokeWidth()*f,g.horiz,a),opacity:n}))},renderLabel:function(c,n,f,g){var b=this.axis,a=b.horiz,d=b.options,e=this.label,l=d.labels,h=l.step;b=t(this.tickmarkOffset,b.tickmarkOffset);var E=!0,p=c.x;c=c.y;e&&B(p)&&(e.xy=c=this.getLabelPosition(p,c,e,a,l,b,g,h),this.isFirst&&!this.isLast&&!t(d.showFirstLabel,1)||this.isLast&&!this.isFirst&&!t(d.showLastLabel,1)?E=!1:!a||l.step||l.rotation||n||0===f||this.handleOverflow(c),h&&g%h&&(E=!1),E&&B(c.y)?
(c.opacity=f,e[this.isNewLabel?"attr":"animate"](c),this.isNewLabel=!1):(e.attr("y",-9999),this.isNewLabel=!0))},render:function(h,n,f){var g=this.axis,b=g.horiz,a=this.pos,d=t(this.tickmarkOffset,g.tickmarkOffset);a=this.getPosition(b,a,d,n);d=a.x;var e=a.y;g=b&&d===g.pos+g.len||!b&&e===g.pos?-1:1;f=t(f,1);this.isActive=!0;this.renderGridLine(n,f,g);this.renderMark(a,f,g);this.renderLabel(a,n,f,h);this.isNew=!1;c.fireEvent(this,"afterRender")},destroy:function(){G(this,this.axis)}}});M(I,"parts/Axis.js",
[I["parts/Globals.js"],I["parts/Utilities.js"]],function(c,f){var F=f.arrayMax,G=f.arrayMin,z=f.defined,B=f.destroyObjectProperties,t=f.extend,v=f.isArray,C=f.isNumber,H=f.isString,y=f.objectEach,h=f.pick,n=f.splat,q=f.syncTimeout,g=c.addEvent,b=c.animObject,a=c.color,d=c.correctFloat,e=c.defaultOptions,l=c.deg2rad,L=c.fireEvent,E=c.format,p=c.getMagnitude,u=c.merge,k=c.normalizeTickInterval,r=c.removeEvent,x=c.seriesTypes,A=c.Tick;f=function(){this.init.apply(this,arguments)};t(f.prototype,{defaultOptions:{dateTimeLabelFormats:{millisecond:{main:"%H:%M:%S.%L",
range:!1},second:{main:"%H:%M:%S",range:!1},minute:{main:"%H:%M",range:!1},hour:{main:"%H:%M",range:!1},day:{main:"%e. %b"},week:{main:"%e. %b"},month:{main:"%b '%y"},year:{main:"%Y"}},endOnTick:!1,labels:{enabled:!0,indentation:10,x:0,style:{color:"#666666",cursor:"default",fontSize:"11px"}},maxPadding:.01,minorTickLength:2,minorTickPosition:"outside",minPadding:.01,showEmpty:!0,startOfWeek:1,startOnTick:!1,tickLength:10,tickPixelInterval:100,tickmarkPlacement:"between",tickPosition:"outside",title:{align:"middle",
style:{color:"#666666"}},type:"linear",minorGridLineColor:"#f2f2f2",minorGridLineWidth:1,minorTickColor:"#999999",lineColor:"#ccd6eb",lineWidth:1,gridLineColor:"#e6e6e6",tickColor:"#ccd6eb"},defaultYAxisOptions:{endOnTick:!0,maxPadding:.05,minPadding:.05,tickPixelInterval:72,showLastLabel:!0,labels:{x:-8},startOnTick:!0,title:{rotation:270,text:"Values"},stackLabels:{allowOverlap:!1,enabled:!1,crop:!0,overflow:"justify",formatter:function(){return c.numberFormat(this.total,-1)},style:{color:"#000000",
fontSize:"11px",fontWeight:"bold",textOutline:"1px contrast"}},gridLineWidth:1,lineWidth:0},defaultLeftAxisOptions:{labels:{x:-15},title:{rotation:270}},defaultRightAxisOptions:{labels:{x:15},title:{rotation:90}},defaultBottomAxisOptions:{labels:{autoRotation:[-45],x:0},margin:15,title:{rotation:0}},defaultTopAxisOptions:{labels:{autoRotation:[-45],x:0},margin:15,title:{rotation:0}},init:function(a,b){var d=b.isX,m=this;m.chart=a;m.horiz=a.inverted&&!m.isZAxis?!d:d;m.isXAxis=d;m.coll=m.coll||(d?"xAxis":
"yAxis");L(this,"init",{userOptions:b});m.opposite=b.opposite;m.side=b.side||(m.horiz?m.opposite?0:2:m.opposite?1:3);m.setOptions(b);var e=this.options,w=e.type;m.labelFormatter=e.labels.formatter||m.defaultLabelFormatter;m.userOptions=b;m.minPixelPadding=0;m.reversed=e.reversed;m.visible=!1!==e.visible;m.zoomEnabled=!1!==e.zoomEnabled;m.hasNames="category"===w||!0===e.categories;m.categories=e.categories||m.hasNames;m.names||(m.names=[],m.names.keys={});m.plotLinesAndBandsGroups={};m.isLog="logarithmic"===
w;m.isDatetimeAxis="datetime"===w;m.positiveValuesOnly=m.isLog&&!m.allowNegativeLog;m.isLinked=z(e.linkedTo);m.ticks={};m.labelEdge=[];m.minorTicks={};m.plotLinesAndBands=[];m.alternateBands={};m.len=0;m.minRange=m.userMinRange=e.minRange||e.maxZoom;m.range=e.range;m.offset=e.offset||0;m.stacks={};m.oldStacks={};m.stacksTouched=0;m.max=null;m.min=null;m.crosshair=h(e.crosshair,n(a.options.tooltip.crosshairs)[d?0:1],!1);b=m.options.events;-1===a.axes.indexOf(m)&&(d?a.axes.splice(a.xAxis.length,0,m):
a.axes.push(m),a[m.coll].push(m));m.series=m.series||[];a.inverted&&!m.isZAxis&&d&&void 0===m.reversed&&(m.reversed=!0);y(b,function(a,b){c.isFunction(a)&&g(m,b,a)});m.lin2log=e.linearToLogConverter||m.lin2log;m.isLog&&(m.val2lin=m.log2lin,m.lin2val=m.lin2log);L(this,"afterInit")},setOptions:function(a){this.options=u(this.defaultOptions,"yAxis"===this.coll&&this.defaultYAxisOptions,[this.defaultTopAxisOptions,this.defaultRightAxisOptions,this.defaultBottomAxisOptions,this.defaultLeftAxisOptions][this.side],
u(e[this.coll],a));L(this,"afterSetOptions",{userOptions:a})},defaultLabelFormatter:function(){var a=this.axis,b=this.value,d=a.chart.time,k=a.categories,l=this.dateTimeLabelFormat,g=e.lang,r=g.numericSymbols;g=g.numericSymbolMagnitude||1E3;var x=r&&r.length,p=a.options.labels.format;a=a.isLog?Math.abs(b):a.tickInterval;if(p)var h=E(p,this,d);else if(k)h=b;else if(l)h=d.dateFormat(l,b);else if(x&&1E3<=a)for(;x--&&void 0===h;)d=Math.pow(g,x+1),a>=d&&0===10*b%d&&null!==r[x]&&0!==b&&(h=c.numberFormat(b/
d,-1)+r[x]);void 0===h&&(h=1E4<=Math.abs(b)?c.numberFormat(b,-1):c.numberFormat(b,-1,void 0,""));return h},getSeriesExtremes:function(){var a=this,b=a.chart,d;L(this,"getSeriesExtremes",null,function(){a.hasVisibleSeries=!1;a.dataMin=a.dataMax=a.threshold=null;a.softThreshold=!a.isXAxis;a.buildStacks&&a.buildStacks();a.series.forEach(function(m){if(m.visible||!b.options.chart.ignoreHiddenSeries){var e=m.options,w=e.threshold;a.hasVisibleSeries=!0;a.positiveValuesOnly&&0>=w&&(w=null);if(a.isXAxis){if(e=
m.xData,e.length){d=m.getXExtremes(e);var k=d.min;var c=d.max;C(k)||k instanceof Date||(e=e.filter(C),d=m.getXExtremes(e),k=d.min,c=d.max);e.length&&(a.dataMin=Math.min(h(a.dataMin,k),k),a.dataMax=Math.max(h(a.dataMax,c),c))}}else if(m.getExtremes(),c=m.dataMax,k=m.dataMin,z(k)&&z(c)&&(a.dataMin=Math.min(h(a.dataMin,k),k),a.dataMax=Math.max(h(a.dataMax,c),c)),z(w)&&(a.threshold=w),!e.softThreshold||a.positiveValuesOnly)a.softThreshold=!1}})});L(this,"afterGetSeriesExtremes")},translate:function(a,
b,d,e,k,c){var m=this.linkedParent||this,w=1,l=0,g=e?m.oldTransA:m.transA;e=e?m.oldMin:m.min;var r=m.minPixelPadding;k=(m.isOrdinal||m.isBroken||m.isLog&&k)&&m.lin2val;g||(g=m.transA);d&&(w*=-1,l=m.len);m.reversed&&(w*=-1,l-=w*(m.sector||m.len));b?(a=(a*w+l-r)/g+e,k&&(a=m.lin2val(a))):(k&&(a=m.val2lin(a)),a=C(e)?w*(a-e)*g+l+w*r+(C(c)?g*c:0):void 0);return a},toPixels:function(a,b){return this.translate(a,!1,!this.horiz,null,!0)+(b?0:this.pos)},toValue:function(a,b){return this.translate(a-(b?0:this.pos),
!0,!this.horiz,null,!0)},getPlotLinePath:function(a){var b=this,d=b.chart,e=b.left,w=b.top,k=a.old,c=a.value,l=a.translatedValue,g=a.lineWidth,r=a.force,x,p,A,u,n=k&&d.oldChartHeight||d.chartHeight,f=k&&d.oldChartWidth||d.chartWidth,E,q=b.transB,v=function(a,b,d){if("pass"!==r&&a<b||a>d)r?a=Math.min(Math.max(b,a),d):E=!0;return a};a={value:c,lineWidth:g,old:k,force:r,acrossPanes:a.acrossPanes,translatedValue:l};L(this,"getPlotLinePath",a,function(a){l=h(l,b.translate(c,null,null,k));l=Math.min(Math.max(-1E5,
l),1E5);x=A=Math.round(l+q);p=u=Math.round(n-l-q);C(l)?b.horiz?(p=w,u=n-b.bottom,x=A=v(x,e,e+b.width)):(x=e,A=f-b.right,p=u=v(p,w,w+b.height)):(E=!0,r=!1);a.path=E&&!r?null:d.renderer.crispLine(["M",x,p,"L",A,u],g||1)});return a.path},getLinearTickPositions:function(a,b,e){var m=d(Math.floor(b/a)*a);e=d(Math.ceil(e/a)*a);var w=[],k;d(m+a)===m&&(k=20);if(this.single)return[b];for(b=m;b<=e;){w.push(b);b=d(b+a,k);if(b===c)break;var c=b}return w},getMinorTickInterval:function(){var a=this.options;return!0===
a.minorTicks?h(a.minorTickInterval,"auto"):!1===a.minorTicks?null:a.minorTickInterval},getMinorTickPositions:function(){var a=this,b=a.options,d=a.tickPositions,e=a.minorTickInterval,k=[],c=a.pointRangePadding||0,l=a.min-c;c=a.max+c;var g=c-l;if(g&&g/e<a.len/3)if(a.isLog)this.paddedTicks.forEach(function(b,d,m){d&&k.push.apply(k,a.getLogTickPositions(e,m[d-1],m[d],!0))});else if(a.isDatetimeAxis&&"auto"===this.getMinorTickInterval())k=k.concat(a.getTimeTicks(a.normalizeTimeTickInterval(e),l,c,b.startOfWeek));
else for(b=l+(d[0]-l)%e;b<=c&&b!==k[0];b+=e)k.push(b);0!==k.length&&a.trimTicks(k);return k},adjustForMinRange:function(){var a=this.options,b=this.min,d=this.max,e,k,c,l,g;this.isXAxis&&void 0===this.minRange&&!this.isLog&&(z(a.min)||z(a.max)?this.minRange=null:(this.series.forEach(function(a){l=a.xData;for(k=g=a.xIncrement?1:l.length-1;0<k;k--)if(c=l[k]-l[k-1],void 0===e||c<e)e=c}),this.minRange=Math.min(5*e,this.dataMax-this.dataMin)));if(d-b<this.minRange){var r=this.dataMax-this.dataMin>=this.minRange;
var x=this.minRange;var p=(x-d+b)/2;p=[b-p,h(a.min,b-p)];r&&(p[2]=this.isLog?this.log2lin(this.dataMin):this.dataMin);b=F(p);d=[b+x,h(a.max,b+x)];r&&(d[2]=this.isLog?this.log2lin(this.dataMax):this.dataMax);d=G(d);d-b<x&&(p[0]=d-x,p[1]=h(a.min,d-x),b=F(p))}this.min=b;this.max=d},getClosest:function(){var a;this.categories?a=1:this.series.forEach(function(b){var d=b.closestPointRange,m=b.visible||!b.chart.options.chart.ignoreHiddenSeries;!b.noSharedTooltip&&z(d)&&m&&(a=z(a)?Math.min(a,d):d)});return a},
nameToX:function(a){var b=v(this.categories),d=b?this.categories:this.names,e=a.options.x;a.series.requireSorting=!1;z(e)||(e=!1===this.options.uniqueNames?a.series.autoIncrement():b?d.indexOf(a.name):h(d.keys[a.name],-1));if(-1===e){if(!b)var k=d.length}else k=e;void 0!==k&&(this.names[k]=a.name,this.names.keys[a.name]=k);return k},updateNames:function(){var a=this,b=this.names;0<b.length&&(Object.keys(b.keys).forEach(function(a){delete b.keys[a]}),b.length=0,this.minRange=this.userMinRange,(this.series||
[]).forEach(function(b){b.xIncrement=null;if(!b.points||b.isDirtyData)a.max=Math.max(a.max,b.xData.length-1),b.processData(),b.generatePoints();b.data.forEach(function(d,e){if(d&&d.options&&void 0!==d.name){var m=a.nameToX(d);void 0!==m&&m!==d.x&&(d.x=m,b.xData[e]=m)}})}))},setAxisTranslation:function(a){var b=this,d=b.max-b.min,e=b.axisPointRange||0,k=0,w=0,c=b.linkedParent,l=!!b.categories,g=b.transA,r=b.isXAxis;if(r||l||e){var p=b.getClosest();c?(k=c.minPointOffset,w=c.pointRangePadding):b.series.forEach(function(a){var d=
l?1:r?h(a.options.pointRange,p,0):b.axisPointRange||0,m=a.options.pointPlacement;e=Math.max(e,d);if(!b.single||l)a=x.xrange&&a instanceof x.xrange?!r:r,k=Math.max(k,a&&H(m)?0:d/2),w=Math.max(w,a&&"on"===m?0:d)});c=b.ordinalSlope&&p?b.ordinalSlope/p:1;b.minPointOffset=k*=c;b.pointRangePadding=w*=c;b.pointRange=Math.min(e,b.single&&l?1:d);r&&(b.closestPointRange=p)}a&&(b.oldTransA=g);b.translationSlope=b.transA=g=b.staticScale||b.len/(d+w||1);b.transB=b.horiz?b.left:b.bottom;b.minPixelPadding=g*k;L(this,
"afterSetAxisTranslation")},minFromRange:function(){return this.max-this.range},setTickInterval:function(a){var b=this,e=b.chart,w=b.options,l=b.isLog,g=b.isDatetimeAxis,r=b.isXAxis,x=b.isLinked,A=w.maxPadding,u=w.minPadding,n=w.tickInterval,f=w.tickPixelInterval,E=b.categories,q=C(b.threshold)?b.threshold:null,v=b.softThreshold;g||E||x||this.getTickAmount();var t=h(b.userMin,w.min);var y=h(b.userMax,w.max);if(x){b.linkedParent=e[b.coll][w.linkedTo];var B=b.linkedParent.getExtremes();b.min=h(B.min,
B.dataMin);b.max=h(B.max,B.dataMax);w.type!==b.linkedParent.options.type&&c.error(11,1,e)}else{if(!v&&z(q))if(b.dataMin>=q)B=q,u=0;else if(b.dataMax<=q){var H=q;A=0}b.min=h(t,B,b.dataMin);b.max=h(y,H,b.dataMax)}l&&(b.positiveValuesOnly&&!a&&0>=Math.min(b.min,h(b.dataMin,b.min))&&c.error(10,1,e),b.min=d(b.log2lin(b.min),16),b.max=d(b.log2lin(b.max),16));b.range&&z(b.max)&&(b.userMin=b.min=t=Math.max(b.dataMin,b.minFromRange()),b.userMax=y=b.max,b.range=null);L(b,"foundExtremes");b.beforePadding&&b.beforePadding();
b.adjustForMinRange();!(E||b.axisPointRange||b.usePercentage||x)&&z(b.min)&&z(b.max)&&(e=b.max-b.min)&&(!z(t)&&u&&(b.min-=e*u),!z(y)&&A&&(b.max+=e*A));C(w.softMin)&&!C(b.userMin)&&w.softMin<b.min&&(b.min=t=w.softMin);C(w.softMax)&&!C(b.userMax)&&w.softMax>b.max&&(b.max=y=w.softMax);C(w.floor)&&(b.min=Math.min(Math.max(b.min,w.floor),Number.MAX_VALUE));C(w.ceiling)&&(b.max=Math.max(Math.min(b.max,w.ceiling),h(b.userMax,-Number.MAX_VALUE)));v&&z(b.dataMin)&&(q=q||0,!z(t)&&b.min<q&&b.dataMin>=q?b.min=
b.options.minRange?Math.min(q,b.max-b.minRange):q:!z(y)&&b.max>q&&b.dataMax<=q&&(b.max=b.options.minRange?Math.max(q,b.min+b.minRange):q));b.tickInterval=b.min===b.max||void 0===b.min||void 0===b.max?1:x&&!n&&f===b.linkedParent.options.tickPixelInterval?n=b.linkedParent.tickInterval:h(n,this.tickAmount?(b.max-b.min)/Math.max(this.tickAmount-1,1):void 0,E?1:(b.max-b.min)*f/Math.max(b.len,f));r&&!a&&b.series.forEach(function(a){a.processData(b.min!==b.oldMin||b.max!==b.oldMax)});b.setAxisTranslation(!0);
b.beforeSetTickPositions&&b.beforeSetTickPositions();b.postProcessTickInterval&&(b.tickInterval=b.postProcessTickInterval(b.tickInterval));b.pointRange&&!n&&(b.tickInterval=Math.max(b.pointRange,b.tickInterval));a=h(w.minTickInterval,b.isDatetimeAxis&&b.closestPointRange);!n&&b.tickInterval<a&&(b.tickInterval=a);g||l||n||(b.tickInterval=k(b.tickInterval,null,p(b.tickInterval),h(w.allowDecimals,!(.5<b.tickInterval&&5>b.tickInterval&&1E3<b.max&&9999>b.max)),!!this.tickAmount));this.tickAmount||(b.tickInterval=
b.unsquish());this.setTickPositions()},setTickPositions:function(){var a=this.options,b=a.tickPositions;var d=this.getMinorTickInterval();var e=a.tickPositioner,k=a.startOnTick,l=a.endOnTick;this.tickmarkOffset=this.categories&&"between"===a.tickmarkPlacement&&1===this.tickInterval?.5:0;this.minorTickInterval="auto"===d&&this.tickInterval?this.tickInterval/5:d;this.single=this.min===this.max&&z(this.min)&&!this.tickAmount&&(parseInt(this.min,10)===this.min||!1!==a.allowDecimals);this.tickPositions=
d=b&&b.slice();!d&&(!this.ordinalPositions&&(this.max-this.min)/this.tickInterval>Math.max(2*this.len,200)?(d=[this.min,this.max],c.error(19,!1,this.chart)):d=this.isDatetimeAxis?this.getTimeTicks(this.normalizeTimeTickInterval(this.tickInterval,a.units),this.min,this.max,a.startOfWeek,this.ordinalPositions,this.closestPointRange,!0):this.isLog?this.getLogTickPositions(this.tickInterval,this.min,this.max):this.getLinearTickPositions(this.tickInterval,this.min,this.max),d.length>this.len&&(d=[d[0],
d.pop()],d[0]===d[1]&&(d.length=1)),this.tickPositions=d,e&&(e=e.apply(this,[this.min,this.max])))&&(this.tickPositions=d=e);this.paddedTicks=d.slice(0);this.trimTicks(d,k,l);this.isLinked||(this.single&&2>d.length&&!this.categories&&(this.min-=.5,this.max+=.5),b||e||this.adjustTickAmount());L(this,"afterSetTickPositions")},trimTicks:function(a,b,d){var e=a[0],m=a[a.length-1],k=this.minPointOffset||0;L(this,"trimTicks");if(!this.isLinked){if(b&&-Infinity!==e)this.min=e;else for(;this.min-k>a[0];)a.shift();
if(d)this.max=m;else for(;this.max+k<a[a.length-1];)a.pop();0===a.length&&z(e)&&!this.options.tickPositions&&a.push((m+e)/2)}},alignToOthers:function(){var a={},b,d=this.options;!1===this.chart.options.chart.alignTicks||!1===d.alignTicks||!1===d.startOnTick||!1===d.endOnTick||this.isLog||this.chart[this.coll].forEach(function(d){var e=d.options;e=[d.horiz?e.left:e.top,e.width,e.height,e.pane].join();d.series.length&&(a[e]?b=!0:a[e]=1)});return b},getTickAmount:function(){var a=this.options,b=a.tickAmount,
d=a.tickPixelInterval;!z(a.tickInterval)&&this.len<d&&!this.isRadial&&!this.isLog&&a.startOnTick&&a.endOnTick&&(b=2);!b&&this.alignToOthers()&&(b=Math.ceil(this.len/d)+1);4>b&&(this.finalTickAmt=b,b=5);this.tickAmount=b},adjustTickAmount:function(){var a=this.options,b=this.tickInterval,e=this.tickPositions,k=this.tickAmount,c=this.finalTickAmt,l=e&&e.length,g=h(this.threshold,this.softThreshold?0:null),r;if(this.hasData()){if(l<k){for(r=this.min;e.length<k;)e.length%2||r===g?e.push(d(e[e.length-
1]+b)):e.unshift(d(e[0]-b));this.transA*=(l-1)/(k-1);this.min=a.startOnTick?e[0]:Math.min(this.min,e[0]);this.max=a.endOnTick?e[e.length-1]:Math.max(this.max,e[e.length-1])}else l>k&&(this.tickInterval*=2,this.setTickPositions());if(z(c)){for(b=a=e.length;b--;)(3===c&&1===b%2||2>=c&&0<b&&b<a-1)&&e.splice(b,1);this.finalTickAmt=void 0}}},setScale:function(){var a=this.series.some(function(a){return a.isDirtyData||a.isDirty||a.xAxis&&a.xAxis.isDirty}),b;this.oldMin=this.min;this.oldMax=this.max;this.oldAxisLength=
this.len;this.setAxisSize();(b=this.len!==this.oldAxisLength)||a||this.isLinked||this.forceRedraw||this.userMin!==this.oldUserMin||this.userMax!==this.oldUserMax||this.alignToOthers()?(this.resetStacks&&this.resetStacks(),this.forceRedraw=!1,this.getSeriesExtremes(),this.setTickInterval(),this.oldUserMin=this.userMin,this.oldUserMax=this.userMax,this.isDirty||(this.isDirty=b||this.min!==this.oldMin||this.max!==this.oldMax)):this.cleanStacks&&this.cleanStacks();L(this,"afterSetScale")},setExtremes:function(a,
b,d,e,k){var m=this,w=m.chart;d=h(d,!0);m.series.forEach(function(a){delete a.kdTree});k=t(k,{min:a,max:b});L(m,"setExtremes",k,function(){m.userMin=a;m.userMax=b;m.eventArgs=k;d&&w.redraw(e)})},zoom:function(a,b){var d=this.dataMin,e=this.dataMax,m=this.options,k=Math.min(d,h(m.min,d)),w=Math.max(e,h(m.max,e));a={newMin:a,newMax:b};L(this,"zoom",a,function(a){var b=a.newMin,m=a.newMax;if(b!==this.min||m!==this.max)this.allowZoomOutside||(z(d)&&(b<k&&(b=k),b>w&&(b=w)),z(e)&&(m<k&&(m=k),m>w&&(m=w))),
this.displayBtn=void 0!==b||void 0!==m,this.setExtremes(b,m,!1,void 0,{trigger:"zoom"});a.zoomed=!0});return a.zoomed},setAxisSize:function(){var a=this.chart,b=this.options,d=b.offsets||[0,0,0,0],e=this.horiz,k=this.width=Math.round(c.relativeLength(h(b.width,a.plotWidth-d[3]+d[1]),a.plotWidth)),l=this.height=Math.round(c.relativeLength(h(b.height,a.plotHeight-d[0]+d[2]),a.plotHeight)),g=this.top=Math.round(c.relativeLength(h(b.top,a.plotTop+d[0]),a.plotHeight,a.plotTop));b=this.left=Math.round(c.relativeLength(h(b.left,
a.plotLeft+d[3]),a.plotWidth,a.plotLeft));this.bottom=a.chartHeight-l-g;this.right=a.chartWidth-k-b;this.len=Math.max(e?k:l,0);this.pos=e?b:g},getExtremes:function(){var a=this.isLog;return{min:a?d(this.lin2log(this.min)):this.min,max:a?d(this.lin2log(this.max)):this.max,dataMin:this.dataMin,dataMax:this.dataMax,userMin:this.userMin,userMax:this.userMax}},getThreshold:function(a){var b=this.isLog,d=b?this.lin2log(this.min):this.min;b=b?this.lin2log(this.max):this.max;null===a||-Infinity===a?a=d:Infinity===
a?a=b:d>a?a=d:b<a&&(a=b);return this.translate(a,0,1,0,1)},autoLabelAlign:function(a){var b=(h(a,0)-90*this.side+720)%360;a={align:"center"};L(this,"autoLabelAlign",a,function(a){15<b&&165>b?a.align="right":195<b&&345>b&&(a.align="left")});return a.align},tickSize:function(a){var b=this.options,d=b[a+"Length"],e=h(b[a+"Width"],"tick"===a&&this.isXAxis&&!this.categories?1:0);if(e&&d){"inside"===b[a+"Position"]&&(d=-d);var k=[d,e]}a={tickSize:k};L(this,"afterTickSize",a);return a.tickSize},labelMetrics:function(){var a=
this.tickPositions&&this.tickPositions[0]||0;return this.chart.renderer.fontMetrics(this.options.labels.style&&this.options.labels.style.fontSize,this.ticks[a]&&this.ticks[a].label)},unsquish:function(){var a=this.options.labels,b=this.horiz,e=this.tickInterval,k=e,c=this.len/(((this.categories?1:0)+this.max-this.min)/e),g,r=a.rotation,x=this.labelMetrics(),p,A=Number.MAX_VALUE,u,n=this.max-this.min,f=function(a){var b=a/(c||1);b=1<b?Math.ceil(b):1;b*e>n&&Infinity!==a&&Infinity!==c&&n&&(b=Math.ceil(n/
e));return d(b*e)};b?(u=!a.staggerLines&&!a.step&&(z(r)?[r]:c<h(a.autoRotationLimit,80)&&a.autoRotation))&&u.forEach(function(a){if(a===r||a&&-90<=a&&90>=a){p=f(Math.abs(x.h/Math.sin(l*a)));var b=p+Math.abs(a/360);b<A&&(A=b,g=a,k=p)}}):a.step||(k=f(x.h));this.autoRotation=u;this.labelRotation=h(g,r);return k},getSlotWidth:function(a){var b=this.chart,d=this.horiz,e=this.options.labels,k=Math.max(this.tickPositions.length-(this.categories?0:1),1),c=b.margin[3];return a&&a.slotWidth||d&&2>(e.step||
0)&&!e.rotation&&(this.staggerLines||1)*this.len/k||!d&&(e.style&&parseInt(e.style.width,10)||c&&c-b.spacing[3]||.33*b.chartWidth)},renderUnsquish:function(){var a=this.chart,b=a.renderer,d=this.tickPositions,e=this.ticks,k=this.options.labels,c=k&&k.style||{},l=this.horiz,g=this.getSlotWidth(),r=Math.max(1,Math.round(g-2*(k.padding||5))),x={},p=this.labelMetrics(),h=k.style&&k.style.textOverflow,A=0;H(k.rotation)||(x.rotation=k.rotation||0);d.forEach(function(a){(a=e[a])&&a.label&&a.label.textPxLength>
A&&(A=a.label.textPxLength)});this.maxLabelLength=A;if(this.autoRotation)A>r&&A>p.h?x.rotation=this.labelRotation:this.labelRotation=0;else if(g){var u=r;if(!h){var n="clip";for(r=d.length;!l&&r--;){var f=d[r];if(f=e[f].label)f.styles&&"ellipsis"===f.styles.textOverflow?f.css({textOverflow:"clip"}):f.textPxLength>g&&f.css({width:g+"px"}),f.getBBox().height>this.len/d.length-(p.h-p.f)&&(f.specificTextOverflow="ellipsis")}}}x.rotation&&(u=A>.5*a.chartHeight?.33*a.chartHeight:A,h||(n="ellipsis"));if(this.labelAlign=
k.align||this.autoLabelAlign(this.labelRotation))x.align=this.labelAlign;d.forEach(function(a){var b=(a=e[a])&&a.label,d=c.width,k={};b&&(b.attr(x),a.shortenLabel?a.shortenLabel():u&&!d&&"nowrap"!==c.whiteSpace&&(u<b.textPxLength||"SPAN"===b.element.tagName)?(k.width=u,h||(k.textOverflow=b.specificTextOverflow||n),b.css(k)):b.styles&&b.styles.width&&!k.width&&!d&&b.css({width:null}),delete b.specificTextOverflow,a.rotation=x.rotation)},this);this.tickRotCorr=b.rotCorr(p.b,this.labelRotation||0,0!==
this.side)},hasData:function(){return this.series.some(function(a){return a.hasData()})||this.options.showEmpty&&z(this.min)&&z(this.max)},addTitle:function(a){var b=this.chart.renderer,d=this.horiz,e=this.opposite,k=this.options.title,c,l=this.chart.styledMode;this.axisTitle||((c=k.textAlign)||(c=(d?{low:"left",middle:"center",high:"right"}:{low:e?"right":"left",middle:"center",high:e?"left":"right"})[k.align]),this.axisTitle=b.text(k.text,0,0,k.useHTML).attr({zIndex:7,rotation:k.rotation||0,align:c}).addClass("highcharts-axis-title"),
l||this.axisTitle.css(u(k.style)),this.axisTitle.add(this.axisGroup),this.axisTitle.isNew=!0);l||k.style.width||this.isRadial||this.axisTitle.css({width:this.len});this.axisTitle[a?"show":"hide"](a)},generateTick:function(a){var b=this.ticks;b[a]?b[a].addLabel():b[a]=new A(this,a)},getOffset:function(){var a=this,b=a.chart,d=b.renderer,e=a.options,k=a.tickPositions,c=a.ticks,l=a.horiz,g=a.side,r=b.inverted&&!a.isZAxis?[1,0,3,2][g]:g,x,p=0,A=0,u=e.title,n=e.labels,f=0,E=b.axisOffset;b=b.clipOffset;
var q=[-1,1,1,-1][g],v=e.className,t=a.axisParent;var C=a.hasData();a.showAxis=x=C||h(e.showEmpty,!0);a.staggerLines=a.horiz&&n.staggerLines;a.axisGroup||(a.gridGroup=d.g("grid").attr({zIndex:e.gridZIndex||1}).addClass("highcharts-"+this.coll.toLowerCase()+"-grid "+(v||"")).add(t),a.axisGroup=d.g("axis").attr({zIndex:e.zIndex||2}).addClass("highcharts-"+this.coll.toLowerCase()+" "+(v||"")).add(t),a.labelGroup=d.g("axis-labels").attr({zIndex:n.zIndex||7}).addClass("highcharts-"+a.coll.toLowerCase()+
"-labels "+(v||"")).add(t));C||a.isLinked?(k.forEach(function(b,d){a.generateTick(b,d)}),a.renderUnsquish(),a.reserveSpaceDefault=0===g||2===g||{1:"left",3:"right"}[g]===a.labelAlign,h(n.reserveSpace,"center"===a.labelAlign?!0:null,a.reserveSpaceDefault)&&k.forEach(function(a){f=Math.max(c[a].getLabelSize(),f)}),a.staggerLines&&(f*=a.staggerLines),a.labelOffset=f*(a.opposite?-1:1)):y(c,function(a,b){a.destroy();delete c[b]});if(u&&u.text&&!1!==u.enabled&&(a.addTitle(x),x&&!1!==u.reserveSpace)){a.titleOffset=
p=a.axisTitle.getBBox()[l?"height":"width"];var B=u.offset;A=z(B)?0:h(u.margin,l?5:10)}a.renderLine();a.offset=q*h(e.offset,E[g]?E[g]+(e.margin||0):0);a.tickRotCorr=a.tickRotCorr||{x:0,y:0};d=0===g?-a.labelMetrics().h:2===g?a.tickRotCorr.y:0;A=Math.abs(f)+A;f&&(A=A-d+q*(l?h(n.y,a.tickRotCorr.y+8*q):n.x));a.axisTitleMargin=h(B,A);a.getMaxLabelDimensions&&(a.maxLabelDimensions=a.getMaxLabelDimensions(c,k));l=this.tickSize("tick");E[g]=Math.max(E[g],a.axisTitleMargin+p+q*a.offset,A,k&&k.length&&l?l[0]+
q*a.offset:0);e=e.offset?0:2*Math.floor(a.axisLine.strokeWidth()/2);b[r]=Math.max(b[r],e);L(this,"afterGetOffset")},getLinePath:function(a){var b=this.chart,d=this.opposite,e=this.offset,k=this.horiz,c=this.left+(d?this.width:0)+e;e=b.chartHeight-this.bottom-(d?this.height:0)+e;d&&(a*=-1);return b.renderer.crispLine(["M",k?this.left:c,k?e:this.top,"L",k?b.chartWidth-this.right:c,k?e:b.chartHeight-this.bottom],a)},renderLine:function(){this.axisLine||(this.axisLine=this.chart.renderer.path().addClass("highcharts-axis-line").add(this.axisGroup),
this.chart.styledMode||this.axisLine.attr({stroke:this.options.lineColor,"stroke-width":this.options.lineWidth,zIndex:7}))},getTitlePosition:function(){var a=this.horiz,b=this.left,d=this.top,e=this.len,k=this.options.title,c=a?b:d,l=this.opposite,g=this.offset,r=k.x||0,x=k.y||0,p=this.axisTitle,A=this.chart.renderer.fontMetrics(k.style&&k.style.fontSize,p);p=Math.max(p.getBBox(null,0).height-A.h-1,0);e={low:c+(a?0:e),middle:c+e/2,high:c+(a?e:0)}[k.align];b=(a?d+this.height:b)+(a?1:-1)*(l?-1:1)*this.axisTitleMargin+
[-p,p,A.f,-p][this.side];a={x:a?e+r:b+(l?this.width:0)+g+r,y:a?b+x-(l?this.height:0)+g:e+x};L(this,"afterGetTitlePosition",{titlePosition:a});return a},renderMinorTick:function(a){var b=this.chart.hasRendered&&C(this.oldMin),d=this.minorTicks;d[a]||(d[a]=new A(this,a,"minor"));b&&d[a].isNew&&d[a].render(null,!0);d[a].render(null,!1,1)},renderTick:function(a,b){var d=this.isLinked,e=this.ticks,k=this.chart.hasRendered&&C(this.oldMin);if(!d||a>=this.min&&a<=this.max)e[a]||(e[a]=new A(this,a)),k&&e[a].isNew&&
e[a].render(b,!0,-1),e[a].render(b)},render:function(){var a=this,d=a.chart,e=a.options,k=a.isLog,l=a.isLinked,g=a.tickPositions,r=a.axisTitle,x=a.ticks,p=a.minorTicks,h=a.alternateBands,u=e.stackLabels,n=e.alternateGridColor,f=a.tickmarkOffset,E=a.axisLine,v=a.showAxis,t=b(d.renderer.globalAnimation),B,H;a.labelEdge.length=0;a.overlap=!1;[x,p,h].forEach(function(a){y(a,function(a){a.isActive=!1})});if(a.hasData()||l)a.minorTickInterval&&!a.categories&&a.getMinorTickPositions().forEach(function(b){a.renderMinorTick(b)}),
g.length&&(g.forEach(function(b,d){a.renderTick(b,d)}),f&&(0===a.min||a.single)&&(x[-1]||(x[-1]=new A(a,-1,null,!0)),x[-1].render(-1))),n&&g.forEach(function(b,e){H=void 0!==g[e+1]?g[e+1]+f:a.max-f;0===e%2&&b<a.max&&H<=a.max+(d.polar?-f:f)&&(h[b]||(h[b]=new c.PlotLineOrBand(a)),B=b+f,h[b].options={from:k?a.lin2log(B):B,to:k?a.lin2log(H):H,color:n},h[b].render(),h[b].isActive=!0)}),a._addedPlotLB||((e.plotLines||[]).concat(e.plotBands||[]).forEach(function(b){a.addPlotBandOrLine(b)}),a._addedPlotLB=
!0);[x,p,h].forEach(function(a){var b,e=[],k=t.duration;y(a,function(a,b){a.isActive||(a.render(b,!1,0),a.isActive=!1,e.push(b))});q(function(){for(b=e.length;b--;)a[e[b]]&&!a[e[b]].isActive&&(a[e[b]].destroy(),delete a[e[b]])},a!==h&&d.hasRendered&&k?k:0)});E&&(E[E.isPlaced?"animate":"attr"]({d:this.getLinePath(E.strokeWidth())}),E.isPlaced=!0,E[v?"show":"hide"](v));r&&v&&(e=a.getTitlePosition(),C(e.y)?(r[r.isNew?"attr":"animate"](e),r.isNew=!1):(r.attr("y",-9999),r.isNew=!0));u&&u.enabled&&a.renderStackTotals();
a.isDirty=!1;L(this,"afterRender")},redraw:function(){this.visible&&(this.render(),this.plotLinesAndBands.forEach(function(a){a.render()}));this.series.forEach(function(a){a.isDirty=!0})},keepProps:"extKey hcEvents names series userMax userMin".split(" "),destroy:function(a){var b=this,d=b.stacks,e=b.plotLinesAndBands,k;L(this,"destroy",{keepEvents:a});a||r(b);y(d,function(a,b){B(a);d[b]=null});[b.ticks,b.minorTicks,b.alternateBands].forEach(function(a){B(a)});if(e)for(a=e.length;a--;)e[a].destroy();
"stackTotalGroup axisLine axisTitle axisGroup gridGroup labelGroup cross scrollbar".split(" ").forEach(function(a){b[a]&&(b[a]=b[a].destroy())});for(k in b.plotLinesAndBandsGroups)b.plotLinesAndBandsGroups[k]=b.plotLinesAndBandsGroups[k].destroy();y(b,function(a,d){-1===b.keepProps.indexOf(d)&&delete b[d]})},drawCrosshair:function(b,d){var e,k=this.crosshair,c=h(k.snap,!0),l,g=this.cross;L(this,"drawCrosshair",{e:b,point:d});b||(b=this.cross&&this.cross.e);if(this.crosshair&&!1!==(z(d)||!c)){c?z(d)&&
(l=h("colorAxis"!==this.coll?d.crosshairPos:null,this.isXAxis?d.plotX:this.len-d.plotY)):l=b&&(this.horiz?b.chartX-this.pos:this.len-b.chartY+this.pos);z(l)&&(e=this.getPlotLinePath({value:d&&(this.isXAxis?d.x:h(d.stackY,d.y)),translatedValue:l})||null);if(!z(e)){this.hideCrosshair();return}c=this.categories&&!this.isRadial;g||(this.cross=g=this.chart.renderer.path().addClass("highcharts-crosshair highcharts-crosshair-"+(c?"category ":"thin ")+k.className).attr({zIndex:h(k.zIndex,2)}).add(),this.chart.styledMode||
(g.attr({stroke:k.color||(c?a("#ccd6eb").setOpacity(.25).get():"#cccccc"),"stroke-width":h(k.width,1)}).css({"pointer-events":"none"}),k.dashStyle&&g.attr({dashstyle:k.dashStyle})));g.show().attr({d:e});c&&!k.width&&g.attr({"stroke-width":this.transA});this.cross.e=b}else this.hideCrosshair();L(this,"afterDrawCrosshair",{e:b,point:d})},hideCrosshair:function(){this.cross&&this.cross.hide();L(this,"afterHideCrosshair")}});return c.Axis=f});M(I,"parts/DateTimeAxis.js",[I["parts/Globals.js"]],function(c){var f=
c.Axis,F=c.getMagnitude,G=c.normalizeTickInterval,z=c.timeUnits;f.prototype.getTimeTicks=function(){return this.chart.time.getTimeTicks.apply(this.chart.time,arguments)};f.prototype.normalizeTimeTickInterval=function(c,f){var v=f||[["millisecond",[1,2,5,10,20,25,50,100,200,500]],["second",[1,2,5,10,15,30]],["minute",[1,2,5,10,15,30]],["hour",[1,2,3,4,6,8,12]],["day",[1,2]],["week",[1,2]],["month",[1,2,3,4,6]],["year",null]];f=v[v.length-1];var t=z[f[0]],B=f[1],y;for(y=0;y<v.length&&!(f=v[y],t=z[f[0]],
B=f[1],v[y+1]&&c<=(t*B[B.length-1]+z[v[y+1][0]])/2);y++);t===z.year&&c<5*t&&(B=[1,2,5]);c=G(c/t,B,"year"===f[0]?Math.max(F(c/t),1):1);return{unitRange:t,count:c,unitName:f[0]}}});M(I,"parts/LogarithmicAxis.js",[I["parts/Globals.js"],I["parts/Utilities.js"]],function(c,f){var F=f.pick;f=c.Axis;var G=c.getMagnitude,z=c.normalizeTickInterval;f.prototype.getLogTickPositions=function(c,f,v,C){var t=this.options,y=this.len,h=[];C||(this._minorAutoInterval=null);if(.5<=c)c=Math.round(c),h=this.getLinearTickPositions(c,
f,v);else if(.08<=c){y=Math.floor(f);var n,q;for(t=.3<c?[1,2,4]:.15<c?[1,2,4,6,8]:[1,2,3,4,5,6,7,8,9];y<v+1&&!q;y++){var g=t.length;for(n=0;n<g&&!q;n++){var b=this.log2lin(this.lin2log(y)*t[n]);b>f&&(!C||a<=v)&&void 0!==a&&h.push(a);a>v&&(q=!0);var a=b}}}else f=this.lin2log(f),v=this.lin2log(v),c=C?this.getMinorTickInterval():t.tickInterval,c=F("auto"===c?null:c,this._minorAutoInterval,t.tickPixelInterval/(C?5:1)*(v-f)/((C?y/this.tickPositions.length:y)||1)),c=z(c,null,G(c)),h=this.getLinearTickPositions(c,
f,v).map(this.log2lin),C||(this._minorAutoInterval=c/5);C||(this.tickInterval=c);return h};f.prototype.log2lin=function(c){return Math.log(c)/Math.LN10};f.prototype.lin2log=function(c){return Math.pow(10,c)}});M(I,"parts/PlotLineOrBand.js",[I["parts/Globals.js"],I["parts/Axis.js"],I["parts/Utilities.js"]],function(c,f,F){var G=F.arrayMax,z=F.arrayMin,B=F.defined,t=F.destroyObjectProperties,v=F.erase,C=F.extend,H=F.objectEach,y=F.pick,h=c.merge;c.PlotLineOrBand=function(c,h){this.axis=c;h&&(this.options=
h,this.id=h.id)};c.PlotLineOrBand.prototype={render:function(){c.fireEvent(this,"render");var f=this,q=f.axis,g=q.horiz,b=f.options,a=b.label,d=f.label,e=b.to,l=b.from,L=b.value,E=B(l)&&B(e),p=B(L),u=f.svgElem,k=!u,r=[],x=b.color,A=y(b.zIndex,0),w=b.events;r={"class":"highcharts-plot-"+(E?"band ":"line ")+(b.className||"")};var m={},K=q.chart.renderer,J=E?"bands":"lines";q.isLog&&(l=q.log2lin(l),e=q.log2lin(e),L=q.log2lin(L));q.chart.styledMode||(p?(r.stroke=x||"#999999",r["stroke-width"]=y(b.width,
1),b.dashStyle&&(r.dashstyle=b.dashStyle)):E&&(r.fill=x||"#e6ebf5",b.borderWidth&&(r.stroke=b.borderColor,r["stroke-width"]=b.borderWidth)));m.zIndex=A;J+="-"+A;(x=q.plotLinesAndBandsGroups[J])||(q.plotLinesAndBandsGroups[J]=x=K.g("plot-"+J).attr(m).add());k&&(f.svgElem=u=K.path().attr(r).add(x));if(p)r=q.getPlotLinePath({value:L,lineWidth:u.strokeWidth(),acrossPanes:b.acrossPanes});else if(E)r=q.getPlotBandPath(l,e,b);else return;(k||!u.d)&&r&&r.length?(u.attr({d:r}),w&&H(w,function(a,b){u.on(b,
function(a){w[b].apply(f,[a])})})):u&&(r?(u.show(!0),u.animate({d:r})):u.d&&(u.hide(),d&&(f.label=d=d.destroy())));a&&(B(a.text)||B(a.formatter))&&r&&r.length&&0<q.width&&0<q.height&&!r.isFlat?(a=h({align:g&&E&&"center",x:g?!E&&4:10,verticalAlign:!g&&E&&"middle",y:g?E?16:10:E?6:-4,rotation:g&&!E&&90},a),this.renderLabel(a,r,E,A)):d&&d.hide();return f},renderLabel:function(c,h,g,b){var a=this.label,d=this.axis.chart.renderer;a||(a={align:c.textAlign||c.align,rotation:c.rotation,"class":"highcharts-plot-"+
(g?"band":"line")+"-label "+(c.className||"")},a.zIndex=b,b=this.getLabelText(c),this.label=a=d.text(b,0,0,c.useHTML).attr(a).add(),this.axis.chart.styledMode||a.css(c.style));d=h.xBounds||[h[1],h[4],g?h[6]:h[1]];h=h.yBounds||[h[2],h[5],g?h[7]:h[2]];g=z(d);b=z(h);a.align(c,!1,{x:g,y:b,width:G(d)-g,height:G(h)-b});a.show(!0)},getLabelText:function(c){return B(c.formatter)?c.formatter.call(this):c.text},destroy:function(){v(this.axis.plotLinesAndBands,this);delete this.axis;t(this)}};C(f.prototype,
{getPlotBandPath:function(c,h){var g=this.getPlotLinePath({value:h,force:!0,acrossPanes:this.options.acrossPanes}),b=this.getPlotLinePath({value:c,force:!0,acrossPanes:this.options.acrossPanes}),a=[],d=this.horiz,e=1;c=c<this.min&&h<this.min||c>this.max&&h>this.max;if(b&&g){if(c){var l=b.toString()===g.toString();e=0}for(c=0;c<b.length;c+=6)d&&g[c+1]===b[c+1]?(g[c+1]+=e,g[c+4]+=e):d||g[c+2]!==b[c+2]||(g[c+2]+=e,g[c+5]+=e),a.push("M",b[c+1],b[c+2],"L",b[c+4],b[c+5],g[c+4],g[c+5],g[c+1],g[c+2],"z"),
a.isFlat=l}return a},addPlotBand:function(c){return this.addPlotBandOrLine(c,"plotBands")},addPlotLine:function(c){return this.addPlotBandOrLine(c,"plotLines")},addPlotBandOrLine:function(h,f){var g=(new c.PlotLineOrBand(this,h)).render(),b=this.userOptions;if(g){if(f){var a=b[f]||[];a.push(h);b[f]=a}this.plotLinesAndBands.push(g)}return g},removePlotBandOrLine:function(c){for(var h=this.plotLinesAndBands,g=this.options,b=this.userOptions,a=h.length;a--;)h[a].id===c&&h[a].destroy();[g.plotLines||
[],b.plotLines||[],g.plotBands||[],b.plotBands||[]].forEach(function(b){for(a=b.length;a--;)b[a].id===c&&v(b,b[a])})},removePlotBand:function(c){this.removePlotBandOrLine(c)},removePlotLine:function(c){this.removePlotBandOrLine(c)}})});M(I,"parts/Tooltip.js",[I["parts/Globals.js"],I["parts/Utilities.js"]],function(c,f){var F=f.defined,G=f.discardElement,z=f.extend,B=f.isNumber,t=f.isString,v=f.pick,C=f.splat,H=f.syncTimeout;"";var y=c.doc,h=c.format,n=c.merge,q=c.timeUnits;c.Tooltip=function(){this.init.apply(this,
arguments)};c.Tooltip.prototype={init:function(c,b){this.chart=c;this.options=b;this.crosshairs=[];this.now={x:0,y:0};this.isHidden=!0;this.split=b.split&&!c.inverted;this.shared=b.shared||this.split;this.outside=v(b.outside,!(!c.scrollablePixelsX&&!c.scrollablePixelsY))},cleanSplit:function(c){this.chart.series.forEach(function(b){var a=b&&b.tt;a&&(!a.isActive||c?b.tt=a.destroy():a.isActive=!1)})},applyFilter:function(){var c=this.chart;c.renderer.definition({tagName:"filter",id:"drop-shadow-"+c.index,
opacity:.5,children:[{tagName:"feGaussianBlur","in":"SourceAlpha",stdDeviation:1},{tagName:"feOffset",dx:1,dy:1},{tagName:"feComponentTransfer",children:[{tagName:"feFuncA",type:"linear",slope:.3}]},{tagName:"feMerge",children:[{tagName:"feMergeNode"},{tagName:"feMergeNode","in":"SourceGraphic"}]}]});c.renderer.definition({tagName:"style",textContent:".highcharts-tooltip-"+c.index+"{filter:url(#drop-shadow-"+c.index+")}"})},getLabel:function(){var g=this,b=this.chart.renderer,a=this.chart.styledMode,
d=this.options,e="tooltip"+(F(d.className)?" "+d.className:""),l;if(!this.label){this.outside&&(this.container=l=c.doc.createElement("div"),l.className="highcharts-tooltip-container",c.css(l,{position:"absolute",top:"1px",pointerEvents:d.style&&d.style.pointerEvents,zIndex:3}),c.doc.body.appendChild(l),this.renderer=b=new c.Renderer(l,0,0,{},void 0,void 0,b.styledMode));this.split?this.label=b.g(e):(this.label=b.label("",0,0,d.shape||"callout",null,null,d.useHTML,null,e).attr({padding:d.padding,r:d.borderRadius}),
a||this.label.attr({fill:d.backgroundColor,"stroke-width":d.borderWidth}).css(d.style).shadow(d.shadow));a&&(this.applyFilter(),this.label.addClass("highcharts-tooltip-"+this.chart.index));if(g.outside&&!g.split){var h={x:this.label.xSetter,y:this.label.ySetter};this.label.xSetter=function(a,b){h[b].call(this.label,g.distance);l.style.left=a+"px"};this.label.ySetter=function(a,b){h[b].call(this.label,g.distance);l.style.top=a+"px"}}this.label.attr({zIndex:8}).add()}return this.label},update:function(c){this.destroy();
n(!0,this.chart.options.tooltip.userOptions,c);this.init(this.chart,n(!0,this.options,c))},destroy:function(){this.label&&(this.label=this.label.destroy());this.split&&this.tt&&(this.cleanSplit(this.chart,!0),this.tt=this.tt.destroy());this.renderer&&(this.renderer=this.renderer.destroy(),G(this.container));c.clearTimeout(this.hideTimer);c.clearTimeout(this.tooltipTimeout)},move:function(g,b,a,d){var e=this,l=e.now,h=!1!==e.options.animation&&!e.isHidden&&(1<Math.abs(g-l.x)||1<Math.abs(b-l.y)),f=
e.followPointer||1<e.len;z(l,{x:h?(2*l.x+g)/3:g,y:h?(l.y+b)/2:b,anchorX:f?void 0:h?(2*l.anchorX+a)/3:a,anchorY:f?void 0:h?(l.anchorY+d)/2:d});e.getLabel().attr(l);h&&(c.clearTimeout(this.tooltipTimeout),this.tooltipTimeout=setTimeout(function(){e&&e.move(g,b,a,d)},32))},hide:function(g){var b=this;c.clearTimeout(this.hideTimer);g=v(g,this.options.hideDelay,500);this.isHidden||(this.hideTimer=H(function(){b.getLabel()[g?"fadeOut":"hide"]();b.isHidden=!0},g))},getAnchor:function(c,b){var a=this.chart,
d=a.pointer,e=a.inverted,l=a.plotTop,g=a.plotLeft,h=0,p=0,f,k;c=C(c);this.followPointer&&b?(void 0===b.chartX&&(b=d.normalize(b)),c=[b.chartX-a.plotLeft,b.chartY-l]):c[0].tooltipPos?c=c[0].tooltipPos:(c.forEach(function(a){f=a.series.yAxis;k=a.series.xAxis;h+=a.plotX+(!e&&k?k.left-g:0);p+=(a.plotLow?(a.plotLow+a.plotHigh)/2:a.plotY)+(!e&&f?f.top-l:0)}),h/=c.length,p/=c.length,c=[e?a.plotWidth-p:h,this.shared&&!e&&1<c.length&&b?b.chartY-l:e?a.plotHeight-h:p]);return c.map(Math.round)},getPosition:function(c,
b,a){var d=this.chart,e=this.distance,l={},g=d.inverted&&a.h||0,h,p=this.outside,f=p?y.documentElement.clientWidth-2*e:d.chartWidth,k=p?Math.max(y.body.scrollHeight,y.documentElement.scrollHeight,y.body.offsetHeight,y.documentElement.offsetHeight,y.documentElement.clientHeight):d.chartHeight,r=d.pointer.getChartPosition(),x=d.containerScaling,A=function(a){return x?a*x.scaleX:a},w=function(a){return x?a*x.scaleY:a},m=function(l){var m="x"===l;return[l,m?f:k,m?c:b].concat(p?[m?A(c):w(b),m?r.left-e+
A(a.plotX+d.plotLeft):r.top-e+w(a.plotY+d.plotTop),0,m?f:k]:[m?c:b,m?a.plotX+d.plotLeft:a.plotY+d.plotTop,m?d.plotLeft:d.plotTop,m?d.plotLeft+d.plotWidth:d.plotTop+d.plotHeight])},n=m("y"),J=m("x"),q=!this.followPointer&&v(a.ttBelow,!d.inverted===!!a.negative),t=function(a,b,d,c,k,m,r){var x="y"===a?w(e):A(e),p=(d-c)/2,h=c<k-e,f=k+e+c<b,u=k-x-d+p;k=k+x-p;if(q&&f)l[a]=k;else if(!q&&h)l[a]=u;else if(h)l[a]=Math.min(r-c,0>u-g?u:u-g);else if(f)l[a]=Math.max(m,k+g+d>b?k:k+g);else return!1},C=function(a,
b,d,k,c){var m;c<e||c>b-e?m=!1:l[a]=c<d/2?1:c>b-k/2?b-k-2:c-d/2;return m},O=function(a){var b=n;n=J;J=b;h=a},D=function(){!1!==t.apply(0,n)?!1!==C.apply(0,J)||h||(O(!0),D()):h?l.x=l.y=0:(O(!0),D())};(d.inverted||1<this.len)&&O();D();return l},defaultFormatter:function(c){var b=this.points||C(this);var a=[c.tooltipFooterHeaderFormatter(b[0])];a=a.concat(c.bodyFormatter(b));a.push(c.tooltipFooterHeaderFormatter(b[0],!0));return a},refresh:function(g,b){var a=this.chart,d=this.options,e=g,l={},h=[],
f=d.formatter||this.defaultFormatter;l=this.shared;var p=a.styledMode;if(d.enabled){c.clearTimeout(this.hideTimer);this.followPointer=C(e)[0].series.tooltipOptions.followPointer;var u=this.getAnchor(e,b);b=u[0];var k=u[1];!l||e.series&&e.series.noSharedTooltip?l=e.getLabelConfig():(a.pointer.applyInactiveState(e),e.forEach(function(a){a.setState("hover");h.push(a.getLabelConfig())}),l={x:e[0].category,y:e[0].y},l.points=h,e=e[0]);this.len=h.length;a=f.call(l,this);f=e.series;this.distance=v(f.tooltipOptions.distance,
16);!1===a?this.hide():(this.split?this.renderSplit(a,C(g)):(g=this.getLabel(),d.style.width&&!p||g.css({width:this.chart.spacingBox.width}),g.attr({text:a&&a.join?a.join(""):a}),g.removeClass(/highcharts-color-[\d]+/g).addClass("highcharts-color-"+v(e.colorIndex,f.colorIndex)),p||g.attr({stroke:d.borderColor||e.color||f.color||"#666666"}),this.updatePosition({plotX:b,plotY:k,negative:e.negative,ttBelow:e.ttBelow,h:u[2]||0})),this.isHidden&&this.label&&this.label.attr({opacity:1}).show(),this.isHidden=
!1);c.fireEvent(this,"refresh")}},renderSplit:function(g,b){var a=this,d=[],e=this.chart,l=e.renderer,h=!0,f=this.options,p=0,u,k=this.getLabel(),r=e.plotTop;t(g)&&(g=[!1,g]);g.slice(0,b.length+1).forEach(function(c,m){if(!1!==c&&""!==c){m=b[m-1]||{isHeader:!0,plotX:b[0].plotX,plotY:e.plotHeight};var g=m.series||a,x=g.tt,w=m.series||{},A="highcharts-color-"+v(m.colorIndex,w.colorIndex,"none");x||(x={padding:f.padding,r:f.borderRadius},e.styledMode||(x.fill=f.backgroundColor,x["stroke-width"]=f.borderWidth),
g.tt=x=l.label(null,null,null,(m.isHeader?f.headerShape:f.shape)||"callout",null,null,f.useHTML).addClass(m.isHeader?"highcharts-tooltip-header ":"highcharts-tooltip-box "+A).attr(x).add(k));x.isActive=!0;x.attr({text:c});e.styledMode||x.css(f.style).shadow(f.shadow).attr({stroke:f.borderColor||m.color||w.color||"#333333"});c=x.getBBox();A=c.width+x.strokeWidth();m.isHeader?(p=c.height,e.xAxis[0].opposite&&(u=!0,r-=p),c=Math.max(0,Math.min(m.plotX+e.plotLeft-A/2,e.chartWidth+(e.scrollablePixelsX?
e.scrollablePixelsX-e.marginRight:0)-A))):c=m.plotX+e.plotLeft-v(f.distance,16)-A;0>c&&(h=!1);m.isHeader?w=u?-p:e.plotHeight+p:(w=w.yAxis,w=w.pos-r+Math.max(0,Math.min(m.plotY||0,w.len)));d.push({target:w,rank:m.isHeader?1:0,size:g.tt.getBBox().height+1,point:m,x:c,tt:x})}});this.cleanSplit();f.positioner&&d.forEach(function(b){var d=f.positioner.call(a,b.tt.getBBox().width,b.size,b.point);b.x=d.x;b.align=0;b.target=d.y;b.rank=v(d.rank,b.rank)});c.distribute(d,e.plotHeight+p);d.forEach(function(b){var d=
b.point,c=d.series,k=c&&c.yAxis;b.tt.attr({visibility:void 0===b.pos?"hidden":"inherit",x:h||d.isHeader||f.positioner?b.x:d.plotX+e.plotLeft+a.distance,y:b.pos+r,anchorX:d.isHeader?d.plotX+e.plotLeft:d.plotX+c.xAxis.pos,anchorY:d.isHeader?e.plotTop+e.plotHeight/2:k.pos+Math.max(0,Math.min(d.plotY,k.len))})});var x=a.container;g=a.renderer;if(a.outside&&x&&g){var A=e.pointer.getChartPosition();x.style.left=A.left+"px";x.style.top=A.top+"px";x=k.getBBox();g.setSize(x.width+x.x,x.height+x.y,!1)}},updatePosition:function(g){var b=
this.chart,a=b.pointer,d=this.getLabel(),e=g.plotX+b.plotLeft,l=g.plotY+b.plotTop;a=a.getChartPosition();g=(this.options.positioner||this.getPosition).call(this,d.width,d.height,g);if(this.outside){var h=(this.options.borderWidth||0)+2*this.distance;this.renderer.setSize(d.width+h,d.height+h,!1);if(b=b.containerScaling)c.css(this.container,{transform:"scale("+b.scaleX+", "+b.scaleY+")"}),e*=b.scaleX,l*=b.scaleY;e+=a.left-g.x;l+=a.top-g.y}this.move(Math.round(g.x),Math.round(g.y||0),e,l)},getDateFormat:function(c,
b,a,d){var e=this.chart.time,l=e.dateFormat("%m-%d %H:%M:%S.%L",b),g={millisecond:15,second:12,minute:9,hour:6,day:3},h="millisecond";for(p in q){if(c===q.week&&+e.dateFormat("%w",b)===a&&"00:00:00.000"===l.substr(6)){var p="week";break}if(q[p]>c){p=h;break}if(g[p]&&l.substr(g[p])!=="01-01 00:00:00.000".substr(g[p]))break;"week"!==p&&(h=p)}if(p)var f=e.resolveDTLFormat(d[p]).main;return f},getXDateFormat:function(c,b,a){b=b.dateTimeLabelFormats;var d=a&&a.closestPointRange;return(d?this.getDateFormat(d,
c.x,a.options.startOfWeek,b):b.day)||b.year},tooltipFooterHeaderFormatter:function(g,b){var a=b?"footer":"header",d=g.series,e=d.tooltipOptions,l=e.xDateFormat,f=d.xAxis,n=f&&"datetime"===f.options.type&&B(g.key),p=e[a+"Format"];b={isFooter:b,labelConfig:g};c.fireEvent(this,"headerFormatter",b,function(a){n&&!l&&(l=this.getXDateFormat(g,e,f));n&&l&&(g.point&&g.point.tooltipDateKeys||["key"]).forEach(function(a){p=p.replace("{point."+a+"}","{point."+a+":"+l+"}")});d.chart.styledMode&&(p=this.styledModeFormat(p));
a.text=h(p,{point:g,series:d},this.chart.time)});return b.text},bodyFormatter:function(c){return c.map(function(b){var a=b.series.tooltipOptions;return(a[(b.point.formatPrefix||"point")+"Formatter"]||b.point.tooltipFormatter).call(b.point,a[(b.point.formatPrefix||"point")+"Format"]||"")})},styledModeFormat:function(c){return c.replace('style="font-size: 10px"','class="highcharts-header"').replace(/style="color:{(point|series)\.color}"/g,'class="highcharts-color-{$1.colorIndex}"')}}});M(I,"parts/Pointer.js",
[I["parts/Globals.js"],I["parts/Utilities.js"]],function(c,f){var F=f.attr,G=f.defined,z=f.extend,B=f.isNumber,t=f.isObject,v=f.objectEach,C=f.pick,H=f.splat,y=c.addEvent,h=c.charts,n=c.color,q=c.css,g=c.find,b=c.fireEvent,a=c.offset,d=c.Tooltip;c.Pointer=function(a,b){this.init(a,b)};c.Pointer.prototype={init:function(a,b){this.options=b;this.chart=a;this.runChartClick=b.chart.events&&!!b.chart.events.click;this.pinchDown=[];this.lastValidTouch={};d&&(a.tooltip=new d(a,b.tooltip),this.followTouchMove=
C(b.tooltip.followTouchMove,!0));this.setDOMEvents()},zoomOption:function(a){var b=this.chart,d=b.options.chart,e=d.zoomType||"";b=b.inverted;/touch/.test(a.type)&&(e=C(d.pinchType,e));this.zoomX=a=/x/.test(e);this.zoomY=e=/y/.test(e);this.zoomHor=a&&!b||e&&b;this.zoomVert=e&&!b||a&&b;this.hasZoom=a||e},getChartPosition:function(){return this.chartPosition||(this.chartPosition=a(this.chart.container))},normalize:function(a,b){var d=a.touches?a.touches.length?a.touches.item(0):a.changedTouches[0]:
a;b||(b=this.getChartPosition());var e=d.pageX-b.left;b=d.pageY-b.top;if(d=this.chart.containerScaling)e/=d.scaleX,b/=d.scaleY;return z(a,{chartX:Math.round(e),chartY:Math.round(b)})},getCoordinates:function(a){var b={xAxis:[],yAxis:[]};this.chart.axes.forEach(function(d){b[d.isXAxis?"xAxis":"yAxis"].push({axis:d,value:d.toValue(a[d.horiz?"chartX":"chartY"])})});return b},findNearestKDPoint:function(a,b,d){var e;a.forEach(function(a){var c=!(a.noSharedTooltip&&b)&&0>a.options.findNearestPointBy.indexOf("y");
a=a.searchPoint(d,c);if((c=t(a,!0))&&!(c=!t(e,!0))){c=e.distX-a.distX;var k=e.dist-a.dist,l=(a.series.group&&a.series.group.zIndex)-(e.series.group&&e.series.group.zIndex);c=0<(0!==c&&b?c:0!==k?k:0!==l?l:e.series.index>a.series.index?-1:1)}c&&(e=a)});return e},getPointFromEvent:function(a){a=a.target;for(var b;a&&!b;)b=a.point,a=a.parentNode;return b},getChartCoordinatesFromPoint:function(a,b){var d=a.series,e=d.xAxis;d=d.yAxis;var c=C(a.clientX,a.plotX),l=a.shapeArgs;if(e&&d)return b?{chartX:e.len+
e.pos-c,chartY:d.len+d.pos-a.plotY}:{chartX:c+e.pos,chartY:a.plotY+d.pos};if(l&&l.x&&l.y)return{chartX:l.x,chartY:l.y}},getHoverData:function(a,b,d,c,h,f){var e,l=[];c=!(!c||!a);var x=b&&!b.stickyTracking?[b]:d.filter(function(a){return a.visible&&!(!h&&a.directTouch)&&C(a.options.enableMouseTracking,!0)&&a.stickyTracking});b=(e=c||!f?a:this.findNearestKDPoint(x,h,f))&&e.series;e&&(h&&!b.noSharedTooltip?(x=d.filter(function(a){return a.visible&&!(!h&&a.directTouch)&&C(a.options.enableMouseTracking,
!0)&&!a.noSharedTooltip}),x.forEach(function(a){var b=g(a.points,function(a){return a.x===e.x&&!a.isNull});t(b)&&(a.chart.isBoosting&&(b=a.getPoint(b)),l.push(b))})):l.push(e));return{hoverPoint:e,hoverSeries:b,hoverPoints:l}},runPointActions:function(a,b){var d=this.chart,e=d.tooltip&&d.tooltip.options.enabled?d.tooltip:void 0,l=e?e.shared:!1,g=b||d.hoverPoint,k=g&&g.series||d.hoverSeries;k=this.getHoverData(g,k,d.series,(!a||"touchmove"!==a.type)&&(!!b||k&&k.directTouch&&this.isDirectTouch),l,a);
g=k.hoverPoint;var r=k.hoverPoints;b=(k=k.hoverSeries)&&k.tooltipOptions.followPointer;l=l&&k&&!k.noSharedTooltip;if(g&&(g!==d.hoverPoint||e&&e.isHidden)){(d.hoverPoints||[]).forEach(function(a){-1===r.indexOf(a)&&a.setState()});if(d.hoverSeries!==k)k.onMouseOver();this.applyInactiveState(r);(r||[]).forEach(function(a){a.setState("hover")});d.hoverPoint&&d.hoverPoint.firePointEvent("mouseOut");if(!g.series)return;g.firePointEvent("mouseOver");d.hoverPoints=r;d.hoverPoint=g;e&&e.refresh(l?r:g,a)}else b&&
e&&!e.isHidden&&(g=e.getAnchor([{}],a),e.updatePosition({plotX:g[0],plotY:g[1]}));this.unDocMouseMove||(this.unDocMouseMove=y(d.container.ownerDocument,"mousemove",function(a){var b=h[c.hoverChartIndex];if(b)b.pointer.onDocumentMouseMove(a)}));d.axes.forEach(function(b){var d=C(b.crosshair.snap,!0),e=d?c.find(r,function(a){return a.series[b.coll]===b}):void 0;e||!d?b.drawCrosshair(a,e):b.hideCrosshair()})},applyInactiveState:function(a){var b=[],d;(a||[]).forEach(function(a){d=a.series;b.push(d);
d.linkedParent&&b.push(d.linkedParent);d.linkedSeries&&(b=b.concat(d.linkedSeries));d.navigatorSeries&&b.push(d.navigatorSeries)});this.chart.series.forEach(function(a){-1===b.indexOf(a)?a.setState("inactive",!0):a.options.inactiveOtherPoints&&a.setAllPointsToState("inactive")})},reset:function(a,b){var d=this.chart,e=d.hoverSeries,c=d.hoverPoint,g=d.hoverPoints,k=d.tooltip,l=k&&k.shared?g:c;a&&l&&H(l).forEach(function(b){b.series.isCartesian&&void 0===b.plotX&&(a=!1)});if(a)k&&l&&H(l).length&&(k.refresh(l),
k.shared&&g?g.forEach(function(a){a.setState(a.state,!0);a.series.isCartesian&&(a.series.xAxis.crosshair&&a.series.xAxis.drawCrosshair(null,a),a.series.yAxis.crosshair&&a.series.yAxis.drawCrosshair(null,a))}):c&&(c.setState(c.state,!0),d.axes.forEach(function(a){a.crosshair&&a.drawCrosshair(null,c)})));else{if(c)c.onMouseOut();g&&g.forEach(function(a){a.setState()});if(e)e.onMouseOut();k&&k.hide(b);this.unDocMouseMove&&(this.unDocMouseMove=this.unDocMouseMove());d.axes.forEach(function(a){a.hideCrosshair()});
this.hoverX=d.hoverPoints=d.hoverPoint=null}},scaleGroups:function(a,b){var d=this.chart,e;d.series.forEach(function(c){e=a||c.getPlotBox();c.xAxis&&c.xAxis.zoomEnabled&&c.group&&(c.group.attr(e),c.markerGroup&&(c.markerGroup.attr(e),c.markerGroup.clip(b?d.clipRect:null)),c.dataLabelsGroup&&c.dataLabelsGroup.attr(e))});d.clipRect.attr(b||d.clipBox)},dragStart:function(a){var b=this.chart;b.mouseIsDown=a.type;b.cancelClick=!1;b.mouseDownX=this.mouseDownX=a.chartX;b.mouseDownY=this.mouseDownY=a.chartY},
drag:function(a){var b=this.chart,d=b.options.chart,e=a.chartX,c=a.chartY,g=this.zoomHor,k=this.zoomVert,r=b.plotLeft,h=b.plotTop,A=b.plotWidth,w=b.plotHeight,m=this.selectionMarker,f=this.mouseDownX,J=this.mouseDownY,v=d.panKey&&a[d.panKey+"Key"];if(!m||!m.touch)if(e<r?e=r:e>r+A&&(e=r+A),c<h?c=h:c>h+w&&(c=h+w),this.hasDragged=Math.sqrt(Math.pow(f-e,2)+Math.pow(J-c,2)),10<this.hasDragged){var q=b.isInsidePlot(f-r,J-h);b.hasCartesianSeries&&(this.zoomX||this.zoomY)&&q&&!v&&!m&&(this.selectionMarker=
m=b.renderer.rect(r,h,g?1:A,k?1:w,0).attr({"class":"highcharts-selection-marker",zIndex:7}).add(),b.styledMode||m.attr({fill:d.selectionMarkerFill||n("#335cad").setOpacity(.25).get()}));m&&g&&(e-=f,m.attr({width:Math.abs(e),x:(0<e?0:e)+f}));m&&k&&(e=c-J,m.attr({height:Math.abs(e),y:(0<e?0:e)+J}));q&&!m&&d.panning&&b.pan(a,d.panning)}},drop:function(a){var d=this,e=this.chart,c=this.hasPinched;if(this.selectionMarker){var g={originalEvent:a,xAxis:[],yAxis:[]},h=this.selectionMarker,k=h.attr?h.attr("x"):
h.x,r=h.attr?h.attr("y"):h.y,x=h.attr?h.attr("width"):h.width,A=h.attr?h.attr("height"):h.height,w;if(this.hasDragged||c)e.axes.forEach(function(b){if(b.zoomEnabled&&G(b.min)&&(c||d[{xAxis:"zoomX",yAxis:"zoomY"}[b.coll]])){var e=b.horiz,m="touchend"===a.type?b.minPixelPadding:0,l=b.toValue((e?k:r)+m);e=b.toValue((e?k+x:r+A)-m);g[b.coll].push({axis:b,min:Math.min(l,e),max:Math.max(l,e)});w=!0}}),w&&b(e,"selection",g,function(a){e.zoom(z(a,c?{animation:!1}:null))});B(e.index)&&(this.selectionMarker=
this.selectionMarker.destroy());c&&this.scaleGroups()}e&&B(e.index)&&(q(e.container,{cursor:e._cursor}),e.cancelClick=10<this.hasDragged,e.mouseIsDown=this.hasDragged=this.hasPinched=!1,this.pinchDown=[])},onContainerMouseDown:function(a){a=this.normalize(a);2!==a.button&&(this.zoomOption(a),a.preventDefault&&a.preventDefault(),this.dragStart(a))},onDocumentMouseUp:function(a){h[c.hoverChartIndex]&&h[c.hoverChartIndex].pointer.drop(a)},onDocumentMouseMove:function(a){var b=this.chart,d=this.chartPosition;
a=this.normalize(a,d);!d||this.inClass(a.target,"highcharts-tracker")||b.isInsidePlot(a.chartX-b.plotLeft,a.chartY-b.plotTop)||this.reset()},onContainerMouseLeave:function(a){var b=h[c.hoverChartIndex];b&&(a.relatedTarget||a.toElement)&&(b.pointer.reset(),b.pointer.chartPosition=void 0)},onContainerMouseMove:function(a){var b=this.chart;G(c.hoverChartIndex)&&h[c.hoverChartIndex]&&h[c.hoverChartIndex].mouseIsDown||(c.hoverChartIndex=b.index);a=this.normalize(a);a.preventDefault||(a.returnValue=!1);
"mousedown"===b.mouseIsDown&&this.drag(a);!this.inClass(a.target,"highcharts-tracker")&&!b.isInsidePlot(a.chartX-b.plotLeft,a.chartY-b.plotTop)||b.openMenu||this.runPointActions(a)},inClass:function(a,b){for(var d;a;){if(d=F(a,"class")){if(-1!==d.indexOf(b))return!0;if(-1!==d.indexOf("highcharts-container"))return!1}a=a.parentNode}},onTrackerMouseOut:function(a){var b=this.chart.hoverSeries;a=a.relatedTarget||a.toElement;this.isDirectTouch=!1;if(!(!b||!a||b.stickyTracking||this.inClass(a,"highcharts-tooltip")||
this.inClass(a,"highcharts-series-"+b.index)&&this.inClass(a,"highcharts-tracker")))b.onMouseOut()},onContainerClick:function(a){var d=this.chart,e=d.hoverPoint,c=d.plotLeft,g=d.plotTop;a=this.normalize(a);d.cancelClick||(e&&this.inClass(a.target,"highcharts-tracker")?(b(e.series,"click",z(a,{point:e})),d.hoverPoint&&e.firePointEvent("click",a)):(z(a,this.getCoordinates(a)),d.isInsidePlot(a.chartX-c,a.chartY-g)&&b(d,"click",a)))},setDOMEvents:function(){var a=this,b=a.chart.container,d=b.ownerDocument;
b.onmousedown=function(b){a.onContainerMouseDown(b)};b.onmousemove=function(b){a.onContainerMouseMove(b)};b.onclick=function(b){a.onContainerClick(b)};this.unbindContainerMouseLeave=y(b,"mouseleave",a.onContainerMouseLeave);c.unbindDocumentMouseUp||(c.unbindDocumentMouseUp=y(d,"mouseup",a.onDocumentMouseUp));c.hasTouch&&(y(b,"touchstart",function(b){a.onContainerTouchStart(b)}),y(b,"touchmove",function(b){a.onContainerTouchMove(b)}),c.unbindDocumentTouchEnd||(c.unbindDocumentTouchEnd=y(d,"touchend",
a.onDocumentTouchEnd)))},destroy:function(){var a=this;a.unDocMouseMove&&a.unDocMouseMove();this.unbindContainerMouseLeave();c.chartCount||(c.unbindDocumentMouseUp&&(c.unbindDocumentMouseUp=c.unbindDocumentMouseUp()),c.unbindDocumentTouchEnd&&(c.unbindDocumentTouchEnd=c.unbindDocumentTouchEnd()));clearInterval(a.tooltipTimeout);v(a,function(b,d){a[d]=null})}}});M(I,"parts/TouchPointer.js",[I["parts/Globals.js"],I["parts/Utilities.js"]],function(c,f){var F=f.extend,G=f.pick,z=c.charts,B=c.noop;F(c.Pointer.prototype,
{pinchTranslate:function(c,f,C,B,y,h){this.zoomHor&&this.pinchTranslateDirection(!0,c,f,C,B,y,h);this.zoomVert&&this.pinchTranslateDirection(!1,c,f,C,B,y,h)},pinchTranslateDirection:function(c,f,C,B,y,h,n,q){var g=this.chart,b=c?"x":"y",a=c?"X":"Y",d="chart"+a,e=c?"width":"height",l=g["plot"+(c?"Left":"Top")],v,t,p=q||1,u=g.inverted,k=g.bounds[c?"h":"v"],r=1===f.length,x=f[0][d],A=C[0][d],w=!r&&f[1][d],m=!r&&C[1][d];C=function(){!r&&20<Math.abs(x-w)&&(p=q||Math.abs(A-m)/Math.abs(x-w));t=(l-A)/p+x;
v=g["plot"+(c?"Width":"Height")]/p};C();f=t;if(f<k.min){f=k.min;var K=!0}else f+v>k.max&&(f=k.max-v,K=!0);K?(A-=.8*(A-n[b][0]),r||(m-=.8*(m-n[b][1])),C()):n[b]=[A,m];u||(h[b]=t-l,h[e]=v);h=u?1/p:p;y[e]=v;y[b]=f;B[u?c?"scaleY":"scaleX":"scale"+a]=p;B["translate"+a]=h*l+(A-h*x)},pinch:function(c){var f=this,t=f.chart,z=f.pinchDown,y=c.touches,h=y.length,n=f.lastValidTouch,q=f.hasZoom,g=f.selectionMarker,b={},a=1===h&&(f.inClass(c.target,"highcharts-tracker")&&t.runTrackerClick||f.runChartClick),d={};
1<h&&(f.initiated=!0);q&&f.initiated&&!a&&c.preventDefault();[].map.call(y,function(a){return f.normalize(a)});"touchstart"===c.type?([].forEach.call(y,function(a,b){z[b]={chartX:a.chartX,chartY:a.chartY}}),n.x=[z[0].chartX,z[1]&&z[1].chartX],n.y=[z[0].chartY,z[1]&&z[1].chartY],t.axes.forEach(function(a){if(a.zoomEnabled){var b=t.bounds[a.horiz?"h":"v"],d=a.minPixelPadding,e=a.toPixels(Math.min(G(a.options.min,a.dataMin),a.dataMin)),c=a.toPixels(Math.max(G(a.options.max,a.dataMax),a.dataMax)),g=Math.max(e,
c);b.min=Math.min(a.pos,Math.min(e,c)-d);b.max=Math.max(a.pos+a.len,g+d)}}),f.res=!0):f.followTouchMove&&1===h?this.runPointActions(f.normalize(c)):z.length&&(g||(f.selectionMarker=g=F({destroy:B,touch:!0},t.plotBox)),f.pinchTranslate(z,y,b,g,d,n),f.hasPinched=q,f.scaleGroups(b,d),f.res&&(f.res=!1,this.reset(!1,0)))},touch:function(f,v){var t=this.chart,z;if(t.index!==c.hoverChartIndex)this.onContainerMouseLeave({relatedTarget:!0});c.hoverChartIndex=t.index;if(1===f.touches.length)if(f=this.normalize(f),
(z=t.isInsidePlot(f.chartX-t.plotLeft,f.chartY-t.plotTop))&&!t.openMenu){v&&this.runPointActions(f);if("touchmove"===f.type){v=this.pinchDown;var y=v[0]?4<=Math.sqrt(Math.pow(v[0].chartX-f.chartX,2)+Math.pow(v[0].chartY-f.chartY,2)):!1}G(y,!0)&&this.pinch(f)}else v&&this.reset();else 2===f.touches.length&&this.pinch(f)},onContainerTouchStart:function(c){this.zoomOption(c);this.touch(c,!0)},onContainerTouchMove:function(c){this.touch(c)},onDocumentTouchEnd:function(f){z[c.hoverChartIndex]&&z[c.hoverChartIndex].pointer.drop(f)}})});
M(I,"parts/MSPointer.js",[I["parts/Globals.js"],I["parts/Utilities.js"]],function(c,f){var F=f.extend,G=f.objectEach,z=c.addEvent,B=c.charts,t=c.css,v=c.doc,C=c.noop;f=c.Pointer;var H=c.removeEvent,y=c.win,h=c.wrap;if(!c.hasTouch&&(y.PointerEvent||y.MSPointerEvent)){var n={},q=!!y.PointerEvent,g=function(){var a=[];a.item=function(a){return this[a]};G(n,function(b){a.push({pageX:b.pageX,pageY:b.pageY,target:b.target})});return a},b=function(a,b,e,l){"touch"!==a.pointerType&&a.pointerType!==a.MSPOINTER_TYPE_TOUCH||
!B[c.hoverChartIndex]||(l(a),l=B[c.hoverChartIndex].pointer,l[b]({type:e,target:a.currentTarget,preventDefault:C,touches:g()}))};F(f.prototype,{onContainerPointerDown:function(a){b(a,"onContainerTouchStart","touchstart",function(a){n[a.pointerId]={pageX:a.pageX,pageY:a.pageY,target:a.currentTarget}})},onContainerPointerMove:function(a){b(a,"onContainerTouchMove","touchmove",function(a){n[a.pointerId]={pageX:a.pageX,pageY:a.pageY};n[a.pointerId].target||(n[a.pointerId].target=a.currentTarget)})},onDocumentPointerUp:function(a){b(a,
"onDocumentTouchEnd","touchend",function(a){delete n[a.pointerId]})},batchMSEvents:function(a){a(this.chart.container,q?"pointerdown":"MSPointerDown",this.onContainerPointerDown);a(this.chart.container,q?"pointermove":"MSPointerMove",this.onContainerPointerMove);a(v,q?"pointerup":"MSPointerUp",this.onDocumentPointerUp)}});h(f.prototype,"init",function(a,b,e){a.call(this,b,e);this.hasZoom&&t(b.container,{"-ms-touch-action":"none","touch-action":"none"})});h(f.prototype,"setDOMEvents",function(a){a.apply(this);
(this.hasZoom||this.followTouchMove)&&this.batchMSEvents(z)});h(f.prototype,"destroy",function(a){this.batchMSEvents(H);a.call(this)})}});M(I,"parts/Legend.js",[I["parts/Globals.js"],I["parts/Utilities.js"]],function(c,f){var F=f.defined,G=f.discardElement,z=f.isNumber,B=f.pick,t=f.setAnimation,v=c.addEvent,C=c.css,H=c.fireEvent;f=c.isFirefox;var y=c.marginNames,h=c.merge,n=c.stableSort,q=c.win,g=c.wrap;c.Legend=function(b,a){this.init(b,a)};c.Legend.prototype={init:function(b,a){this.chart=b;this.setOptions(a);
a.enabled&&(this.render(),v(this.chart,"endResize",function(){this.legend.positionCheckboxes()}),this.proximate?this.unchartrender=v(this.chart,"render",function(){this.legend.proximatePositions();this.legend.positionItems()}):this.unchartrender&&this.unchartrender())},setOptions:function(b){var a=B(b.padding,8);this.options=b;this.chart.styledMode||(this.itemStyle=b.itemStyle,this.itemHiddenStyle=h(this.itemStyle,b.itemHiddenStyle));this.itemMarginTop=b.itemMarginTop||0;this.itemMarginBottom=b.itemMarginBottom||
0;this.padding=a;this.initialItemY=a-5;this.symbolWidth=B(b.symbolWidth,16);this.pages=[];this.proximate="proximate"===b.layout&&!this.chart.inverted},update:function(b,a){var d=this.chart;this.setOptions(h(!0,this.options,b));this.destroy();d.isDirtyLegend=d.isDirtyBox=!0;B(a,!0)&&d.redraw();H(this,"afterUpdate")},colorizeItem:function(b,a){b.legendGroup[a?"removeClass":"addClass"]("highcharts-legend-item-hidden");if(!this.chart.styledMode){var d=this.options,e=b.legendItem,c=b.legendLine,g=b.legendSymbol,
h=this.itemHiddenStyle.color;d=a?d.itemStyle.color:h;var f=a?b.color||h:h,u=b.options&&b.options.marker,k={fill:f};e&&e.css({fill:d,color:d});c&&c.attr({stroke:f});g&&(u&&g.isMarker&&(k=b.pointAttribs(),a||(k.stroke=k.fill=h)),g.attr(k))}H(this,"afterColorizeItem",{item:b,visible:a})},positionItems:function(){this.allItems.forEach(this.positionItem,this);this.chart.isResizing||this.positionCheckboxes()},positionItem:function(b){var a=this.options,d=a.symbolPadding;a=!a.rtl;var e=b._legendItemPos,
c=e[0];e=e[1];var g=b.checkbox;if((b=b.legendGroup)&&b.element)b[F(b.translateY)?"animate":"attr"]({translateX:a?c:this.legendWidth-c-2*d-4,translateY:e});g&&(g.x=c,g.y=e)},destroyItem:function(b){var a=b.checkbox;["legendItem","legendLine","legendSymbol","legendGroup"].forEach(function(a){b[a]&&(b[a]=b[a].destroy())});a&&G(b.checkbox)},destroy:function(){function b(a){this[a]&&(this[a]=this[a].destroy())}this.getAllItems().forEach(function(a){["legendItem","legendGroup"].forEach(b,a)});"clipRect up down pager nav box title group".split(" ").forEach(b,
this);this.display=null},positionCheckboxes:function(){var b=this.group&&this.group.alignAttr,a=this.clipHeight||this.legendHeight,d=this.titleHeight;if(b){var e=b.translateY;this.allItems.forEach(function(c){var g=c.checkbox;if(g){var l=e+d+g.y+(this.scrollOffset||0)+3;C(g,{left:b.translateX+c.checkboxOffset+g.x-20+"px",top:l+"px",display:this.proximate||l>e-6&&l<e+a-6?"":"none"})}},this)}},renderTitle:function(){var b=this.options,a=this.padding,d=b.title,e=0;d.text&&(this.title||(this.title=this.chart.renderer.label(d.text,
a-3,a-4,null,null,null,b.useHTML,null,"legend-title").attr({zIndex:1}),this.chart.styledMode||this.title.css(d.style),this.title.add(this.group)),d.width||this.title.css({width:this.maxLegendWidth+"px"}),b=this.title.getBBox(),e=b.height,this.offsetWidth=b.width,this.contentGroup.attr({translateY:e}));this.titleHeight=e},setText:function(b){var a=this.options;b.legendItem.attr({text:a.labelFormat?c.format(a.labelFormat,b,this.chart.time):a.labelFormatter.call(b)})},renderItem:function(b){var a=this.chart,
d=a.renderer,e=this.options,c=this.symbolWidth,g=e.symbolPadding,f=this.itemStyle,p=this.itemHiddenStyle,u="horizontal"===e.layout?B(e.itemDistance,20):0,k=!e.rtl,r=b.legendItem,x=!b.series,A=!x&&b.series.drawLegendSymbol?b.series:b,w=A.options;w=this.createCheckboxForItem&&w&&w.showCheckbox;u=c+g+u+(w?20:0);var m=e.useHTML,n=b.options.className;r||(b.legendGroup=d.g("legend-item").addClass("highcharts-"+A.type+"-series highcharts-color-"+b.colorIndex+(n?" "+n:"")+(x?" highcharts-series-"+b.index:
"")).attr({zIndex:1}).add(this.scrollGroup),b.legendItem=r=d.text("",k?c+g:-g,this.baseline||0,m),a.styledMode||r.css(h(b.visible?f:p)),r.attr({align:k?"left":"right",zIndex:2}).add(b.legendGroup),this.baseline||(this.fontMetrics=d.fontMetrics(a.styledMode?12:f.fontSize,r),this.baseline=this.fontMetrics.f+3+this.itemMarginTop,r.attr("y",this.baseline)),this.symbolHeight=e.symbolHeight||this.fontMetrics.f,A.drawLegendSymbol(this,b),this.setItemEvents&&this.setItemEvents(b,r,m));w&&!b.checkbox&&this.createCheckboxForItem(b);
this.colorizeItem(b,b.visible);!a.styledMode&&f.width||r.css({width:(e.itemWidth||this.widthOption||a.spacingBox.width)-u});this.setText(b);a=r.getBBox();b.itemWidth=b.checkboxOffset=e.itemWidth||b.legendItemWidth||a.width+u;this.maxItemWidth=Math.max(this.maxItemWidth,b.itemWidth);this.totalItemWidth+=b.itemWidth;this.itemHeight=b.itemHeight=Math.round(b.legendItemHeight||a.height||this.symbolHeight)},layoutItem:function(b){var a=this.options,d=this.padding,e="horizontal"===a.layout,c=b.itemHeight,
g=this.itemMarginBottom,h=this.itemMarginTop,f=e?B(a.itemDistance,20):0,u=this.maxLegendWidth;a=a.alignColumns&&this.totalItemWidth>u?this.maxItemWidth:b.itemWidth;e&&this.itemX-d+a>u&&(this.itemX=d,this.lastLineHeight&&(this.itemY+=h+this.lastLineHeight+g),this.lastLineHeight=0);this.lastItemY=h+this.itemY+g;this.lastLineHeight=Math.max(c,this.lastLineHeight);b._legendItemPos=[this.itemX,this.itemY];e?this.itemX+=a:(this.itemY+=h+c+g,this.lastLineHeight=c);this.offsetWidth=this.widthOption||Math.max((e?
this.itemX-d-(b.checkbox?0:f):a)+d,this.offsetWidth)},getAllItems:function(){var b=[];this.chart.series.forEach(function(a){var d=a&&a.options;a&&B(d.showInLegend,F(d.linkedTo)?!1:void 0,!0)&&(b=b.concat(a.legendItems||("point"===d.legendType?a.data:a)))});H(this,"afterGetAllItems",{allItems:b});return b},getAlignment:function(){var b=this.options;return this.proximate?b.align.charAt(0)+"tv":b.floating?"":b.align.charAt(0)+b.verticalAlign.charAt(0)+b.layout.charAt(0)},adjustMargins:function(b,a){var d=
this.chart,e=this.options,c=this.getAlignment();c&&[/(lth|ct|rth)/,/(rtv|rm|rbv)/,/(rbh|cb|lbh)/,/(lbv|lm|ltv)/].forEach(function(g,l){g.test(c)&&!F(b[l])&&(d[y[l]]=Math.max(d[y[l]],d.legend[(l+1)%2?"legendHeight":"legendWidth"]+[1,-1,-1,1][l]*e[l%2?"x":"y"]+B(e.margin,12)+a[l]+(d.titleOffset[l]||0)))})},proximatePositions:function(){var b=this.chart,a=[],d="left"===this.options.align;this.allItems.forEach(function(e){var g=d;if(e.yAxis&&e.points){e.xAxis.options.reversed&&(g=!g);var h=c.find(g?e.points:
e.points.slice(0).reverse(),function(a){return z(a.plotY)});g=this.itemMarginTop+e.legendItem.getBBox().height+this.itemMarginBottom;var f=e.yAxis.top-b.plotTop;e.visible?(h=h?h.plotY:e.yAxis.height,h+=f-.3*g):h=f+e.yAxis.height;a.push({target:h,size:g,item:e})}},this);c.distribute(a,b.plotHeight);a.forEach(function(a){a.item._legendItemPos[1]=b.plotTop-b.spacing[0]+a.pos})},render:function(){var b=this.chart,a=b.renderer,d=this.group,e,g=this.box,f=this.options,q=this.padding;this.itemX=q;this.itemY=
this.initialItemY;this.lastItemY=this.offsetWidth=0;this.widthOption=c.relativeLength(f.width,b.spacingBox.width-q);var p=b.spacingBox.width-2*q-f.x;-1<["rm","lm"].indexOf(this.getAlignment().substring(0,2))&&(p/=2);this.maxLegendWidth=this.widthOption||p;d||(this.group=d=a.g("legend").attr({zIndex:7}).add(),this.contentGroup=a.g().attr({zIndex:1}).add(d),this.scrollGroup=a.g().add(this.contentGroup));this.renderTitle();p=this.getAllItems();n(p,function(a,b){return(a.options&&a.options.legendIndex||
0)-(b.options&&b.options.legendIndex||0)});f.reversed&&p.reverse();this.allItems=p;this.display=e=!!p.length;this.itemHeight=this.totalItemWidth=this.maxItemWidth=this.lastLineHeight=0;p.forEach(this.renderItem,this);p.forEach(this.layoutItem,this);p=(this.widthOption||this.offsetWidth)+q;var u=this.lastItemY+this.lastLineHeight+this.titleHeight;u=this.handleOverflow(u);u+=q;g||(this.box=g=a.rect().addClass("highcharts-legend-box").attr({r:f.borderRadius}).add(d),g.isNew=!0);b.styledMode||g.attr({stroke:f.borderColor,
"stroke-width":f.borderWidth||0,fill:f.backgroundColor||"none"}).shadow(f.shadow);0<p&&0<u&&(g[g.isNew?"attr":"animate"](g.crisp.call({},{x:0,y:0,width:p,height:u},g.strokeWidth())),g.isNew=!1);g[e?"show":"hide"]();b.styledMode&&"none"===d.getStyle("display")&&(p=u=0);this.legendWidth=p;this.legendHeight=u;e&&(a=b.spacingBox,g=a.y,/(lth|ct|rth)/.test(this.getAlignment())&&0<b.titleOffset[0]?g+=b.titleOffset[0]:/(lbh|cb|rbh)/.test(this.getAlignment())&&0<b.titleOffset[2]&&(g-=b.titleOffset[2]),g!==
a.y&&(a=h(a,{y:g})),d.align(h(f,{width:p,height:u,verticalAlign:this.proximate?"top":f.verticalAlign}),!0,a));this.proximate||this.positionItems();H(this,"afterRender")},handleOverflow:function(b){var a=this,d=this.chart,e=d.renderer,c=this.options,g=c.y,h=this.padding;g=d.spacingBox.height+("top"===c.verticalAlign?-g:g)-h;var f=c.maxHeight,u,k=this.clipRect,r=c.navigation,x=B(r.animation,!0),A=r.arrowSize||12,w=this.nav,m=this.pages,n,J=this.allItems,q=function(b){"number"===typeof b?k.attr({height:b}):
k&&(a.clipRect=k.destroy(),a.contentGroup.clip());a.contentGroup.div&&(a.contentGroup.div.style.clip=b?"rect("+h+"px,9999px,"+(h+b)+"px,0)":"auto")},v=function(b){a[b]=e.circle(0,0,1.3*A).translate(A/2,A/2).add(w);d.styledMode||a[b].attr("fill","rgba(0,0,0,0.0001)");return a[b]};"horizontal"!==c.layout||"middle"===c.verticalAlign||c.floating||(g/=2);f&&(g=Math.min(g,f));m.length=0;b>g&&!1!==r.enabled?(this.clipHeight=u=Math.max(g-20-this.titleHeight-h,0),this.currentPage=B(this.currentPage,1),this.fullHeight=
b,J.forEach(function(a,b){var d=a._legendItemPos[1],e=Math.round(a.legendItem.getBBox().height),c=m.length;if(!c||d-m[c-1]>u&&(n||d)!==m[c-1])m.push(n||d),c++;a.pageIx=c-1;n&&(J[b-1].pageIx=c-1);b===J.length-1&&d+e-m[c-1]>u&&d!==n&&(m.push(d),a.pageIx=c);d!==n&&(n=d)}),k||(k=a.clipRect=e.clipRect(0,h,9999,0),a.contentGroup.clip(k)),q(u),w||(this.nav=w=e.g().attr({zIndex:1}).add(this.group),this.up=e.symbol("triangle",0,0,A,A).add(w),v("upTracker").on("click",function(){a.scroll(-1,x)}),this.pager=
e.text("",15,10).addClass("highcharts-legend-navigation"),d.styledMode||this.pager.css(r.style),this.pager.add(w),this.down=e.symbol("triangle-down",0,0,A,A).add(w),v("downTracker").on("click",function(){a.scroll(1,x)})),a.scroll(0),b=g):w&&(q(),this.nav=w.destroy(),this.scrollGroup.attr({translateY:1}),this.clipHeight=0);return b},scroll:function(b,a){var d=this.pages,e=d.length,c=this.currentPage+b;b=this.clipHeight;var g=this.options.navigation,h=this.pager,f=this.padding;c>e&&(c=e);0<c&&(void 0!==
a&&t(a,this.chart),this.nav.attr({translateX:f,translateY:b+this.padding+7+this.titleHeight,visibility:"visible"}),[this.up,this.upTracker].forEach(function(a){a.attr({"class":1===c?"highcharts-legend-nav-inactive":"highcharts-legend-nav-active"})}),h.attr({text:c+"/"+e}),[this.down,this.downTracker].forEach(function(a){a.attr({x:18+this.pager.getBBox().width,"class":c===e?"highcharts-legend-nav-inactive":"highcharts-legend-nav-active"})},this),this.chart.styledMode||(this.up.attr({fill:1===c?g.inactiveColor:
g.activeColor}),this.upTracker.css({cursor:1===c?"default":"pointer"}),this.down.attr({fill:c===e?g.inactiveColor:g.activeColor}),this.downTracker.css({cursor:c===e?"default":"pointer"})),this.scrollOffset=-d[c-1]+this.initialItemY,this.scrollGroup.animate({translateY:this.scrollOffset}),this.currentPage=c,this.positionCheckboxes())}};c.LegendSymbolMixin={drawRectangle:function(b,a){var d=b.symbolHeight,e=b.options.squareSymbol;a.legendSymbol=this.chart.renderer.rect(e?(b.symbolWidth-d)/2:0,b.baseline-
d+1,e?d:b.symbolWidth,d,B(b.options.symbolRadius,d/2)).addClass("highcharts-point").attr({zIndex:3}).add(a.legendGroup)},drawLineMarker:function(b){var a=this.options,d=a.marker,e=b.symbolWidth,c=b.symbolHeight,g=c/2,f=this.chart.renderer,p=this.legendGroup;b=b.baseline-Math.round(.3*b.fontMetrics.b);var u={};this.chart.styledMode||(u={"stroke-width":a.lineWidth||0},a.dashStyle&&(u.dashstyle=a.dashStyle));this.legendLine=f.path(["M",0,b,"L",e,b]).addClass("highcharts-graph").attr(u).add(p);d&&!1!==
d.enabled&&e&&(a=Math.min(B(d.radius,g),g),0===this.symbol.indexOf("url")&&(d=h(d,{width:c,height:c}),a=0),this.legendSymbol=d=f.symbol(this.symbol,e/2-a,b-a,2*a,2*a,d).addClass("highcharts-point").add(p),d.isMarker=!0)}};(/Trident\/7\.0/.test(q.navigator&&q.navigator.userAgent)||f)&&g(c.Legend.prototype,"positionItem",function(b,a){var d=this,e=function(){a._legendItemPos&&b.call(d,a)};e();d.bubbleLegend||setTimeout(e)})});M(I,"parts/Chart.js",[I["parts/Globals.js"],I["parts/Utilities.js"]],function(c,
f){var F=f.attr,G=f.defined,z=f.discardElement,B=f.erase,t=f.extend,v=f.isArray,C=f.isNumber,H=f.isObject,y=f.isString,h=f.objectEach,n=f.pick,q=f.pInt,g=f.setAnimation,b=f.splat,a=f.syncTimeout,d=c.addEvent,e=c.animate,l=c.animObject,L=c.doc,E=c.Axis,p=c.createElement,u=c.defaultOptions,k=c.charts,r=c.css,x=c.find,A=c.fireEvent,w=c.Legend,m=c.marginNames,K=c.merge,J=c.Pointer,U=c.removeEvent,S=c.seriesTypes,Q=c.win,O=c.Chart=function(){this.getArgs.apply(this,arguments)};c.chart=function(a,b,d){return new O(a,
b,d)};t(O.prototype,{callbacks:[],getArgs:function(){var a=[].slice.call(arguments);if(y(a[0])||a[0].nodeName)this.renderTo=a.shift();this.init(a[0],a[1])},init:function(a,b){var e,g=a.series,m=a.plotOptions||{};A(this,"init",{args:arguments},function(){a.series=null;e=K(u,a);h(e.plotOptions,function(a,b){H(a)&&(a.tooltip=m[b]&&K(m[b].tooltip)||void 0)});e.tooltip.userOptions=a.chart&&a.chart.forExport&&a.tooltip.userOptions||a.tooltip;e.series=a.series=g;this.userOptions=a;var r=e.chart,l=r.events;
this.margin=[];this.spacing=[];this.bounds={h:{},v:{}};this.labelCollectors=[];this.callback=b;this.isResizing=0;this.options=e;this.axes=[];this.series=[];this.time=a.time&&Object.keys(a.time).length?new c.Time(a.time):c.time;this.styledMode=r.styledMode;this.hasCartesianSeries=r.showAxes;var f=this;f.index=k.length;k.push(f);c.chartCount++;l&&h(l,function(a,b){c.isFunction(a)&&d(f,b,a)});f.xAxis=[];f.yAxis=[];f.pointCount=f.colorCounter=f.symbolCounter=0;A(f,"afterInit");f.firstRender()})},initSeries:function(a){var b=
this.options.chart;b=a.type||b.type||b.defaultSeriesType;var d=S[b];d||c.error(17,!0,this,{missingModuleFor:b});b=new d;b.init(this,a);return b},orderSeries:function(a){var b=this.series;for(a=a||0;a<b.length;a++)b[a]&&(b[a].index=a,b[a].name=b[a].getName())},isInsidePlot:function(a,b,d){var e=d?b:a;a=d?a:b;return 0<=e&&e<=this.plotWidth&&0<=a&&a<=this.plotHeight},redraw:function(a){A(this,"beforeRedraw");var b=this.axes,d=this.series,e=this.pointer,c=this.legend,k=this.userOptions.legend,m=this.isDirtyLegend,
r=this.hasCartesianSeries,h=this.isDirtyBox,l=this.renderer,f=l.isHidden(),x=[];this.setResponsive&&this.setResponsive(!1);g(a,this);f&&this.temporaryDisplay();this.layOutTitles();for(a=d.length;a--;){var w=d[a];if(w.options.stacking){var p=!0;if(w.isDirty){var u=!0;break}}}if(u)for(a=d.length;a--;)w=d[a],w.options.stacking&&(w.isDirty=!0);d.forEach(function(a){a.isDirty&&("point"===a.options.legendType?(a.updateTotals&&a.updateTotals(),m=!0):k&&(k.labelFormatter||k.labelFormat)&&(m=!0));a.isDirtyData&&
A(a,"updatedData")});m&&c&&c.options.enabled&&(c.render(),this.isDirtyLegend=!1);p&&this.getStacks();r&&b.forEach(function(a){a.updateNames();a.setScale()});this.getMargins();r&&(b.forEach(function(a){a.isDirty&&(h=!0)}),b.forEach(function(a){var b=a.min+","+a.max;a.extKey!==b&&(a.extKey=b,x.push(function(){A(a,"afterSetExtremes",t(a.eventArgs,a.getExtremes()));delete a.eventArgs}));(h||p)&&a.redraw()}));h&&this.drawChartBox();A(this,"predraw");d.forEach(function(a){(h||a.isDirty)&&a.visible&&a.redraw();
a.isDirtyData=!1});e&&e.reset(!0);l.draw();A(this,"redraw");A(this,"render");f&&this.temporaryDisplay(!0);x.forEach(function(a){a.call()})},get:function(a){function b(b){return b.id===a||b.options&&b.options.id===a}var d=this.series,e;var c=x(this.axes,b)||x(this.series,b);for(e=0;!c&&e<d.length;e++)c=x(d[e].points||[],b);return c},getAxes:function(){var a=this,d=this.options,e=d.xAxis=b(d.xAxis||{});d=d.yAxis=b(d.yAxis||{});A(this,"getAxes");e.forEach(function(a,b){a.index=b;a.isX=!0});d.forEach(function(a,
b){a.index=b});e.concat(d).forEach(function(b){new E(a,b)});A(this,"afterGetAxes")},getSelectedPoints:function(){var a=[];this.series.forEach(function(b){a=a.concat((b[b.hasGroupedData?"points":"data"]||[]).filter(function(a){return n(a.selectedStaging,a.selected)}))});return a},getSelectedSeries:function(){return this.series.filter(function(a){return a.selected})},setTitle:function(a,b,d){this.applyDescription("title",a);this.applyDescription("subtitle",b);this.applyDescription("caption",void 0);
this.layOutTitles(d)},applyDescription:function(a,b){var d=this,e="title"===a?{color:"#333333",fontSize:this.options.isStock?"16px":"18px"}:{color:"#666666"};e=this.options[a]=K(!this.styledMode&&{style:e},this.options[a],b);var c=this[a];c&&b&&(this[a]=c=c.destroy());e&&!c&&(c=this.renderer.text(e.text,0,0,e.useHTML).attr({align:e.align,"class":"highcharts-"+a,zIndex:e.zIndex||4}).add(),c.update=function(b){d[{title:"setTitle",subtitle:"setSubtitle",caption:"setCaption"}[a]](b)},this.styledMode||
c.css(e.style),this[a]=c)},layOutTitles:function(a){var b=[0,0,0],d=this.renderer,e=this.spacingBox;["title","subtitle","caption"].forEach(function(a){var c=this[a],k=this.options[a],g=k.verticalAlign||"top";a="title"===a?-3:"top"===g?b[0]+2:0;if(c){if(!this.styledMode)var m=k.style.fontSize;m=d.fontMetrics(m,c).b;c.css({width:(k.width||e.width+(k.widthAdjust||0))+"px"});var r=Math.round(c.getBBox(k.useHTML).height);c.align(t({y:"bottom"===g?m:a+m,height:r},k),!1,"spacingBox");k.floating||("top"===
g?b[0]=Math.ceil(b[0]+r):"bottom"===g&&(b[2]=Math.ceil(b[2]+r)))}},this);b[0]&&"top"===(this.options.title.verticalAlign||"top")&&(b[0]+=this.options.title.margin);b[2]&&"bottom"===this.options.caption.verticalAlign&&(b[2]+=this.options.caption.margin);var c=!this.titleOffset||this.titleOffset.join(",")!==b.join(",");this.titleOffset=b;A(this,"afterLayOutTitles");!this.isDirtyBox&&c&&(this.isDirtyBox=this.isDirtyLegend=c,this.hasRendered&&n(a,!0)&&this.isDirtyBox&&this.redraw())},getChartSize:function(){var a=
this.options.chart,b=a.width;a=a.height;var d=this.renderTo;G(b)||(this.containerWidth=c.getStyle(d,"width"));G(a)||(this.containerHeight=c.getStyle(d,"height"));this.chartWidth=Math.max(0,b||this.containerWidth||600);this.chartHeight=Math.max(0,c.relativeLength(a,this.chartWidth)||(1<this.containerHeight?this.containerHeight:400))},temporaryDisplay:function(a){var b=this.renderTo;if(a)for(;b&&b.style;)b.hcOrigStyle&&(c.css(b,b.hcOrigStyle),delete b.hcOrigStyle),b.hcOrigDetached&&(L.body.removeChild(b),
b.hcOrigDetached=!1),b=b.parentNode;else for(;b&&b.style;){L.body.contains(b)||b.parentNode||(b.hcOrigDetached=!0,L.body.appendChild(b));if("none"===c.getStyle(b,"display",!1)||b.hcOricDetached)b.hcOrigStyle={display:b.style.display,height:b.style.height,overflow:b.style.overflow},a={display:"block",overflow:"hidden"},b!==this.renderTo&&(a.height=0),c.css(b,a),b.offsetWidth||b.style.setProperty("display","block","important");b=b.parentNode;if(b===L.body)break}},setClassName:function(a){this.container.className=
"highcharts-container "+(a||"")},getContainer:function(){var a=this.options,b=a.chart;var d=this.renderTo;var e=c.uniqueKey(),g,m;d||(this.renderTo=d=b.renderTo);y(d)&&(this.renderTo=d=L.getElementById(d));d||c.error(13,!0,this);var h=q(F(d,"data-highcharts-chart"));C(h)&&k[h]&&k[h].hasRendered&&k[h].destroy();F(d,"data-highcharts-chart",this.index);d.innerHTML="";b.skipClone||d.offsetWidth||this.temporaryDisplay();this.getChartSize();h=this.chartWidth;var l=this.chartHeight;r(d,{overflow:"hidden"});
this.styledMode||(g=t({position:"relative",overflow:"hidden",width:h+"px",height:l+"px",textAlign:"left",lineHeight:"normal",zIndex:0,"-webkit-tap-highlight-color":"rgba(0,0,0,0)"},b.style));this.container=d=p("div",{id:e},g,d);this._cursor=d.style.cursor;this.renderer=new (c[b.renderer]||c.Renderer)(d,h,l,null,b.forExport,a.exporting&&a.exporting.allowHTML,this.styledMode);this.setClassName(b.className);if(this.styledMode)for(m in a.defs)this.renderer.definition(a.defs[m]);else this.renderer.setStyle(b.style);
this.renderer.chartIndex=this.index;A(this,"afterGetContainer")},getMargins:function(a){var b=this.spacing,d=this.margin,e=this.titleOffset;this.resetMargins();e[0]&&!G(d[0])&&(this.plotTop=Math.max(this.plotTop,e[0]+b[0]));e[2]&&!G(d[2])&&(this.marginBottom=Math.max(this.marginBottom,e[2]+b[2]));this.legend&&this.legend.display&&this.legend.adjustMargins(d,b);A(this,"getMargins");a||this.getAxisMargins()},getAxisMargins:function(){var a=this,b=a.axisOffset=[0,0,0,0],d=a.colorAxis,e=a.margin,c=function(a){a.forEach(function(a){a.visible&&
a.getOffset()})};a.hasCartesianSeries?c(a.axes):d&&d.length&&c(d);m.forEach(function(d,c){G(e[c])||(a[d]+=b[c])});a.setChartSize()},reflow:function(b){var d=this,e=d.options.chart,k=d.renderTo,g=G(e.width)&&G(e.height),m=e.width||c.getStyle(k,"width");e=e.height||c.getStyle(k,"height");k=b?b.target:Q;if(!g&&!d.isPrinting&&m&&e&&(k===Q||k===L)){if(m!==d.containerWidth||e!==d.containerHeight)c.clearTimeout(d.reflowTimeout),d.reflowTimeout=a(function(){d.container&&d.setSize(void 0,void 0,!1)},b?100:
0);d.containerWidth=m;d.containerHeight=e}},setReflow:function(a){var b=this;!1===a||this.unbindReflow?!1===a&&this.unbindReflow&&(this.unbindReflow=this.unbindReflow()):(this.unbindReflow=d(Q,"resize",function(a){b.options&&b.reflow(a)}),d(this,"destroy",this.unbindReflow))},setSize:function(b,d,c){var k=this,m=k.renderer;k.isResizing+=1;g(c,k);k.oldChartHeight=k.chartHeight;k.oldChartWidth=k.chartWidth;void 0!==b&&(k.options.chart.width=b);void 0!==d&&(k.options.chart.height=d);k.getChartSize();
if(!k.styledMode){var h=m.globalAnimation;(h?e:r)(k.container,{width:k.chartWidth+"px",height:k.chartHeight+"px"},h)}k.setChartSize(!0);m.setSize(k.chartWidth,k.chartHeight,c);k.axes.forEach(function(a){a.isDirty=!0;a.setScale()});k.isDirtyLegend=!0;k.isDirtyBox=!0;k.layOutTitles();k.getMargins();k.redraw(c);k.oldChartHeight=null;A(k,"resize");a(function(){k&&A(k,"endResize",null,function(){--k.isResizing})},l(h).duration||0)},setChartSize:function(a){var b=this.inverted,d=this.renderer,e=this.chartWidth,
c=this.chartHeight,k=this.options.chart,g=this.spacing,m=this.clipOffset,r,h,l,f;this.plotLeft=r=Math.round(this.plotLeft);this.plotTop=h=Math.round(this.plotTop);this.plotWidth=l=Math.max(0,Math.round(e-r-this.marginRight));this.plotHeight=f=Math.max(0,Math.round(c-h-this.marginBottom));this.plotSizeX=b?f:l;this.plotSizeY=b?l:f;this.plotBorderWidth=k.plotBorderWidth||0;this.spacingBox=d.spacingBox={x:g[3],y:g[0],width:e-g[3]-g[1],height:c-g[0]-g[2]};this.plotBox=d.plotBox={x:r,y:h,width:l,height:f};
e=2*Math.floor(this.plotBorderWidth/2);b=Math.ceil(Math.max(e,m[3])/2);d=Math.ceil(Math.max(e,m[0])/2);this.clipBox={x:b,y:d,width:Math.floor(this.plotSizeX-Math.max(e,m[1])/2-b),height:Math.max(0,Math.floor(this.plotSizeY-Math.max(e,m[2])/2-d))};a||this.axes.forEach(function(a){a.setAxisSize();a.setAxisTranslation()});A(this,"afterSetChartSize",{skipAxes:a})},resetMargins:function(){A(this,"resetMargins");var a=this,b=a.options.chart;["margin","spacing"].forEach(function(d){var e=b[d],c=H(e)?e:[e,
e,e,e];["Top","Right","Bottom","Left"].forEach(function(e,k){a[d][k]=n(b[d+e],c[k])})});m.forEach(function(b,d){a[b]=n(a.margin[d],a.spacing[d])});a.axisOffset=[0,0,0,0];a.clipOffset=[0,0,0,0]},drawChartBox:function(){var a=this.options.chart,b=this.renderer,d=this.chartWidth,e=this.chartHeight,c=this.chartBackground,k=this.plotBackground,g=this.plotBorder,m=this.styledMode,r=this.plotBGImage,h=a.backgroundColor,l=a.plotBackgroundColor,f=a.plotBackgroundImage,x,w=this.plotLeft,p=this.plotTop,u=this.plotWidth,
n=this.plotHeight,J=this.plotBox,K=this.clipRect,q=this.clipBox,v="animate";c||(this.chartBackground=c=b.rect().addClass("highcharts-background").add(),v="attr");if(m)var y=x=c.strokeWidth();else{y=a.borderWidth||0;x=y+(a.shadow?8:0);h={fill:h||"none"};if(y||c["stroke-width"])h.stroke=a.borderColor,h["stroke-width"]=y;c.attr(h).shadow(a.shadow)}c[v]({x:x/2,y:x/2,width:d-x-y%2,height:e-x-y%2,r:a.borderRadius});v="animate";k||(v="attr",this.plotBackground=k=b.rect().addClass("highcharts-plot-background").add());
k[v](J);m||(k.attr({fill:l||"none"}).shadow(a.plotShadow),f&&(r?r.animate(J):this.plotBGImage=b.image(f,w,p,u,n).add()));K?K.animate({width:q.width,height:q.height}):this.clipRect=b.clipRect(q);v="animate";g||(v="attr",this.plotBorder=g=b.rect().addClass("highcharts-plot-border").attr({zIndex:1}).add());m||g.attr({stroke:a.plotBorderColor,"stroke-width":a.plotBorderWidth||0,fill:"none"});g[v](g.crisp({x:w,y:p,width:u,height:n},-g.strokeWidth()));this.isDirtyBox=!1;A(this,"afterDrawChartBox")},propFromSeries:function(){var a=
this,b=a.options.chart,d,e=a.options.series,c,k;["inverted","angular","polar"].forEach(function(g){d=S[b.type||b.defaultSeriesType];k=b[g]||d&&d.prototype[g];for(c=e&&e.length;!k&&c--;)(d=S[e[c].type])&&d.prototype[g]&&(k=!0);a[g]=k})},linkSeries:function(){var a=this,b=a.series;b.forEach(function(a){a.linkedSeries.length=0});b.forEach(function(b){var d=b.options.linkedTo;y(d)&&(d=":previous"===d?a.series[b.index-1]:a.get(d))&&d.linkedParent!==b&&(d.linkedSeries.push(b),b.linkedParent=d,b.visible=
n(b.options.visible,d.options.visible,b.visible))});A(this,"afterLinkSeries")},renderSeries:function(){this.series.forEach(function(a){a.translate();a.render()})},renderLabels:function(){var a=this,b=a.options.labels;b.items&&b.items.forEach(function(d){var e=t(b.style,d.style),c=q(e.left)+a.plotLeft,k=q(e.top)+a.plotTop+12;delete e.left;delete e.top;a.renderer.text(d.html,c,k).attr({zIndex:2}).css(e).add()})},render:function(){var a=this.axes,b=this.colorAxis,d=this.renderer,e=this.options,c=0,k=
function(a){a.forEach(function(a){a.visible&&a.render()})};this.setTitle();this.legend=new w(this,e.legend);this.getStacks&&this.getStacks();this.getMargins(!0);this.setChartSize();e=this.plotWidth;a.some(function(a){if(a.horiz&&a.visible&&a.options.labels.enabled&&a.series.length)return c=21,!0});var g=this.plotHeight=Math.max(this.plotHeight-c,0);a.forEach(function(a){a.setScale()});this.getAxisMargins();var m=1.1<e/this.plotWidth;var r=1.05<g/this.plotHeight;if(m||r)a.forEach(function(a){(a.horiz&&
m||!a.horiz&&r)&&a.setTickInterval(!0)}),this.getMargins();this.drawChartBox();this.hasCartesianSeries?k(a):b&&b.length&&k(b);this.seriesGroup||(this.seriesGroup=d.g("series-group").attr({zIndex:3}).add());this.renderSeries();this.renderLabels();this.addCredits();this.setResponsive&&this.setResponsive();this.updateContainerScaling();this.hasRendered=!0},addCredits:function(a){var b=this;a=K(!0,this.options.credits,a);a.enabled&&!this.credits&&(this.credits=this.renderer.text(a.text+(this.mapCredits||
""),0,0).addClass("highcharts-credits").on("click",function(){a.href&&(Q.location.href=a.href)}).attr({align:a.position.align,zIndex:8}),b.styledMode||this.credits.css(a.style),this.credits.add().align(a.position),this.credits.update=function(a){b.credits=b.credits.destroy();b.addCredits(a)})},updateContainerScaling:function(){var a=this.container;if(a.offsetWidth&&a.offsetHeight&&a.getBoundingClientRect){var b=a.getBoundingClientRect(),d=b.width/a.offsetWidth;a=b.height/a.offsetHeight;1!==d||1!==
a?this.containerScaling={scaleX:d,scaleY:a}:delete this.containerScaling}},destroy:function(){var a=this,b=a.axes,d=a.series,e=a.container,g,m=e&&e.parentNode;A(a,"destroy");a.renderer.forExport?B(k,a):k[a.index]=void 0;c.chartCount--;a.renderTo.removeAttribute("data-highcharts-chart");U(a);for(g=b.length;g--;)b[g]=b[g].destroy();this.scroller&&this.scroller.destroy&&this.scroller.destroy();for(g=d.length;g--;)d[g]=d[g].destroy();"title subtitle chartBackground plotBackground plotBGImage plotBorder seriesGroup clipRect credits pointer rangeSelector legend resetZoomButton tooltip renderer".split(" ").forEach(function(b){var d=
a[b];d&&d.destroy&&(a[b]=d.destroy())});e&&(e.innerHTML="",U(e),m&&z(e));h(a,function(b,d){delete a[d]})},firstRender:function(){var a=this,b=a.options;if(!a.isReadyToRender||a.isReadyToRender()){a.getContainer();a.resetMargins();a.setChartSize();a.propFromSeries();a.getAxes();(v(b.series)?b.series:[]).forEach(function(b){a.initSeries(b)});a.linkSeries();A(a,"beforeRender");J&&(a.pointer=new J(a,b));a.render();if(!a.renderer.imgCount&&a.onload)a.onload();a.temporaryDisplay(!0)}},onload:function(){this.callbacks.concat([this.callback]).forEach(function(a){a&&
void 0!==this.index&&a.apply(this,[this])},this);A(this,"load");A(this,"render");G(this.index)&&this.setReflow(this.options.chart.reflow);this.onload=null}})});M(I,"parts/ScrollablePlotArea.js",[I["parts/Globals.js"],I["parts/Utilities.js"]],function(c,f){var F=f.pick,G=c.addEvent;f=c.Chart;"";G(f,"afterSetChartSize",function(f){var z=this.options.chart.scrollablePlotArea,t=z&&z.minWidth;z=z&&z.minHeight;if(!this.renderer.forExport){if(t){if(this.scrollablePixelsX=t=Math.max(0,t-this.chartWidth)){this.plotWidth+=
t;this.inverted?(this.clipBox.height+=t,this.plotBox.height+=t):(this.clipBox.width+=t,this.plotBox.width+=t);var v={1:{name:"right",value:t}}}}else z&&(this.scrollablePixelsY=t=Math.max(0,z-this.chartHeight))&&(this.plotHeight+=t,this.inverted?(this.clipBox.width+=t,this.plotBox.width+=t):(this.clipBox.height+=t,this.plotBox.height+=t),v={2:{name:"bottom",value:t}});v&&!f.skipAxes&&this.axes.forEach(function(f){v[f.side]?f.getPlotLinePath=function(){var t=v[f.side].name,y=this[t];this[t]=y-v[f.side].value;
var h=c.Axis.prototype.getPlotLinePath.apply(this,arguments);this[t]=y;return h}:(f.setAxisSize(),f.setAxisTranslation())})}});G(f,"render",function(){this.scrollablePixelsX||this.scrollablePixelsY?(this.setUpScrolling&&this.setUpScrolling(),this.applyFixed()):this.fixedDiv&&this.applyFixed()});f.prototype.setUpScrolling=function(){var f={WebkitOverflowScrolling:"touch",overflowX:"hidden",overflowY:"hidden"};this.scrollablePixelsX&&(f.overflowX="auto");this.scrollablePixelsY&&(f.overflowY="auto");
this.scrollingContainer=c.createElement("div",{className:"highcharts-scrolling"},f,this.renderTo);this.innerContainer=c.createElement("div",{className:"highcharts-inner-container"},null,this.scrollingContainer);this.innerContainer.appendChild(this.container);this.setUpScrolling=null};f.prototype.moveFixedElements=function(){var c=this.container,f=this.fixedRenderer,t=".highcharts-contextbutton .highcharts-credits .highcharts-legend .highcharts-legend-checkbox .highcharts-navigator-series .highcharts-navigator-xaxis .highcharts-navigator-yaxis .highcharts-navigator .highcharts-reset-zoom .highcharts-scrollbar .highcharts-subtitle .highcharts-title".split(" "),
v;this.scrollablePixelsX&&!this.inverted?v=".highcharts-yaxis":this.scrollablePixelsX&&this.inverted?v=".highcharts-xaxis":this.scrollablePixelsY&&!this.inverted?v=".highcharts-xaxis":this.scrollablePixelsY&&this.inverted&&(v=".highcharts-yaxis");t.push(v,v+"-labels");t.forEach(function(v){[].forEach.call(c.querySelectorAll(v),function(c){(c.namespaceURI===f.SVG_NS?f.box:f.box.parentNode).appendChild(c);c.style.pointerEvents="auto"})})};f.prototype.applyFixed=function(){var f,B=!this.fixedDiv,t=this.options.chart.scrollablePlotArea;
B?(this.fixedDiv=c.createElement("div",{className:"highcharts-fixed"},{position:"absolute",overflow:"hidden",pointerEvents:"none",zIndex:2},null,!0),this.renderTo.insertBefore(this.fixedDiv,this.renderTo.firstChild),this.renderTo.style.overflow="visible",this.fixedRenderer=f=new c.Renderer(this.fixedDiv,this.chartWidth,this.chartHeight),this.scrollableMask=f.path().attr({fill:c.color(this.options.chart.backgroundColor||"#fff").setOpacity(F(t.opacity,.85)).get(),zIndex:-1}).addClass("highcharts-scrollable-mask").add(),
this.moveFixedElements(),G(this,"afterShowResetZoom",this.moveFixedElements),G(this,"afterLayOutTitles",this.moveFixedElements)):this.fixedRenderer.setSize(this.chartWidth,this.chartHeight);f=this.chartWidth+(this.scrollablePixelsX||0);var v=this.chartHeight+(this.scrollablePixelsY||0);c.stop(this.container);this.container.style.width=f+"px";this.container.style.height=v+"px";this.renderer.boxWrapper.attr({width:f,height:v,viewBox:[0,0,f,v].join(" ")});this.chartBackground.attr({width:f,height:v});
this.scrollablePixelsY&&(this.scrollingContainer.style.height=this.chartHeight+"px");B&&(t.scrollPositionX&&(this.scrollingContainer.scrollLeft=this.scrollablePixelsX*t.scrollPositionX),t.scrollPositionY&&(this.scrollingContainer.scrollTop=this.scrollablePixelsY*t.scrollPositionY));v=this.axisOffset;B=this.plotTop-v[0]-1;t=this.plotLeft-v[3]-1;f=this.plotTop+this.plotHeight+v[2]+1;v=this.plotLeft+this.plotWidth+v[1]+1;var C=this.plotLeft+this.plotWidth-(this.scrollablePixelsX||0),H=this.plotTop+this.plotHeight-
(this.scrollablePixelsY||0);B=this.scrollablePixelsX?["M",0,B,"L",this.plotLeft-1,B,"L",this.plotLeft-1,f,"L",0,f,"Z","M",C,B,"L",this.chartWidth,B,"L",this.chartWidth,f,"L",C,f,"Z"]:this.scrollablePixelsY?["M",t,0,"L",t,this.plotTop-1,"L",v,this.plotTop-1,"L",v,0,"Z","M",t,H,"L",t,this.chartHeight,"L",v,this.chartHeight,"L",v,H,"Z"]:["M",0,0];"adjustHeight"!==this.redrawTrigger&&this.scrollableMask.attr({d:B})}});M(I,"parts/Point.js",[I["parts/Globals.js"],I["parts/Utilities.js"]],function(c,f){var F=
f.defined,G=f.erase,z=f.extend,B=f.isArray,t=f.isNumber,v=f.isObject,C=f.pick,H,y=c.fireEvent,h=c.format,n=c.uniqueKey,q=c.removeEvent;c.Point=H=function(){};c.Point.prototype={init:function(c,b,a){this.series=c;this.applyOptions(b,a);this.id=F(this.id)?this.id:n();this.resolveColor();c.chart.pointCount++;y(this,"afterInit");return this},resolveColor:function(){var c=this.series;var b=c.chart.options.chart.colorCount;var a=c.chart.styledMode;a||this.options.color||(this.color=c.color);c.options.colorByPoint?
(a||(b=c.options.colors||c.chart.options.colors,this.color=this.color||b[c.colorCounter],b=b.length),a=c.colorCounter,c.colorCounter++,c.colorCounter===b&&(c.colorCounter=0)):a=c.colorIndex;this.colorIndex=C(this.colorIndex,a)},applyOptions:function(c,b){var a=this.series,d=a.options.pointValKey||a.pointValKey;c=H.prototype.optionsToObject.call(this,c);z(this,c);this.options=this.options?z(this.options,c):c;c.group&&delete this.group;c.dataLabels&&delete this.dataLabels;d&&(this.y=this[d]);this.formatPrefix=
(this.isNull=C(this.isValid&&!this.isValid(),null===this.x||!t(this.y)))?"null":"point";this.selected&&(this.state="select");"name"in this&&void 0===b&&a.xAxis&&a.xAxis.hasNames&&(this.x=a.xAxis.nameToX(this));void 0===this.x&&a&&(this.x=void 0===b?a.autoIncrement(this):b);return this},setNestedProperty:function(c,b,a){a.split(".").reduce(function(a,e,c,g){a[e]=g.length-1===c?b:v(a[e],!0)?a[e]:{};return a[e]},c);return c},optionsToObject:function(g){var b={},a=this.series,d=a.options.keys,e=d||a.pointArrayMap||
["y"],h=e.length,f=0,n=0;if(t(g)||null===g)b[e[0]]=g;else if(B(g))for(!d&&g.length>h&&(a=typeof g[0],"string"===a?b.name=g[0]:"number"===a&&(b.x=g[0]),f++);n<h;)d&&void 0===g[f]||(0<e[n].indexOf(".")?c.Point.prototype.setNestedProperty(b,g[f],e[n]):b[e[n]]=g[f]),f++,n++;else"object"===typeof g&&(b=g,g.dataLabels&&(a._hasPointLabels=!0),g.marker&&(a._hasPointMarkers=!0));return b},getClassName:function(){return"highcharts-point"+(this.selected?" highcharts-point-select":"")+(this.negative?" highcharts-negative":
"")+(this.isNull?" highcharts-null-point":"")+(void 0!==this.colorIndex?" highcharts-color-"+this.colorIndex:"")+(this.options.className?" "+this.options.className:"")+(this.zone&&this.zone.className?" "+this.zone.className.replace("highcharts-negative",""):"")},getZone:function(){var c=this.series,b=c.zones;c=c.zoneAxis||"y";var a=0,d;for(d=b[a];this[c]>=d.value;)d=b[++a];this.nonZonedColor||(this.nonZonedColor=this.color);this.color=d&&d.color&&!this.options.color?d.color:this.nonZonedColor;return d},
hasNewShapeType:function(){return this.graphic&&this.graphic.element.nodeName!==this.shapeType},destroy:function(){var c=this.series.chart,b=c.hoverPoints,a;c.pointCount--;b&&(this.setState(),G(b,this),b.length||(c.hoverPoints=null));if(this===c.hoverPoint)this.onMouseOut();if(this.graphic||this.dataLabel||this.dataLabels)q(this),this.destroyElements();this.legendItem&&c.legend.destroyItem(this);for(a in this)this[a]=null},destroyElements:function(c){var b=this,a=[],d;c=c||{graphic:1,dataLabel:1};
c.graphic&&a.push("graphic","shadowGroup");c.dataLabel&&a.push("dataLabel","dataLabelUpper","connector");for(d=a.length;d--;){var e=a[d];b[e]&&(b[e]=b[e].destroy())}["dataLabel","connector"].forEach(function(a){var d=a+"s";c[a]&&b[d]&&(b[d].forEach(function(a){a.element&&a.destroy()}),delete b[d])})},getLabelConfig:function(){return{x:this.category,y:this.y,color:this.color,colorIndex:this.colorIndex,key:this.name||this.category,series:this.series,point:this,percentage:this.percentage,total:this.total||
this.stackTotal}},tooltipFormatter:function(c){var b=this.series,a=b.tooltipOptions,d=C(a.valueDecimals,""),e=a.valuePrefix||"",g=a.valueSuffix||"";b.chart.styledMode&&(c=b.chart.tooltip.styledModeFormat(c));(b.pointArrayMap||["y"]).forEach(function(a){a="{point."+a;if(e||g)c=c.replace(RegExp(a+"}","g"),e+a+"}"+g);c=c.replace(RegExp(a+"}","g"),a+":,."+d+"f}")});return h(c,{point:this,series:this.series},b.chart.time)},firePointEvent:function(c,b,a){var d=this,e=this.series.options;(e.point.events[c]||
d.options&&d.options.events&&d.options.events[c])&&this.importEvents();"click"===c&&e.allowPointSelect&&(a=function(a){d.select&&d.select(null,a.ctrlKey||a.metaKey||a.shiftKey)});y(this,c,b,a)},visible:!0}});M(I,"parts/Series.js",[I["parts/Globals.js"],I["parts/Utilities.js"]],function(c,f){var F=f.arrayMax,G=f.arrayMin,z=f.defined,B=f.erase,t=f.extend,v=f.isArray,C=f.isNumber,H=f.isString,y=f.objectEach,h=f.pick,n=f.splat,q=f.syncTimeout,g=c.addEvent,b=c.animObject,a=c.correctFloat,d=c.defaultOptions,
e=c.defaultPlotOptions,l=c.fireEvent,L=c.merge,E=c.removeEvent,p=c.SVGElement,u=c.win;c.Series=c.seriesType("line",null,{lineWidth:2,allowPointSelect:!1,showCheckbox:!1,animation:{duration:1E3},events:{},marker:{lineWidth:0,lineColor:"#ffffff",enabledThreshold:2,radius:4,states:{normal:{animation:!0},hover:{animation:{duration:50},enabled:!0,radiusPlus:2,lineWidthPlus:1},select:{fillColor:"#cccccc",lineColor:"#000000",lineWidth:2}}},point:{events:{}},dataLabels:{align:"center",formatter:function(){return null===
this.y?"":c.numberFormat(this.y,-1)},padding:5,style:{fontSize:"11px",fontWeight:"bold",color:"contrast",textOutline:"1px contrast"},verticalAlign:"bottom",x:0,y:0},cropThreshold:300,opacity:1,pointRange:0,softThreshold:!0,states:{normal:{animation:!0},hover:{animation:{duration:50},lineWidthPlus:1,marker:{},halo:{size:10,opacity:.25}},select:{animation:{duration:0}},inactive:{animation:{duration:50},opacity:.2}},stickyTracking:!0,turboThreshold:1E3,findNearestPointBy:"x"},{axisTypes:["xAxis","yAxis"],
coll:"series",colorCounter:0,cropShoulder:1,directTouch:!1,isCartesian:!0,parallelArrays:["x","y"],pointClass:c.Point,requireSorting:!0,sorted:!0,init:function(a,b){l(this,"init",{options:b});var d=this,e=a.series,k;this.eventOptions=this.eventOptions||{};d.chart=a;d.options=b=d.setOptions(b);d.linkedSeries=[];d.bindAxes();t(d,{name:b.name,state:"",visible:!1!==b.visible,selected:!0===b.selected});var m=b.events;y(m,function(a,b){c.isFunction(a)&&d.eventOptions[b]!==a&&(c.isFunction(d.eventOptions[b])&&
E(d,b,d.eventOptions[b]),d.eventOptions[b]=a,g(d,b,a))});if(m&&m.click||b.point&&b.point.events&&b.point.events.click||b.allowPointSelect)a.runTrackerClick=!0;d.getColor();d.getSymbol();d.parallelArrays.forEach(function(a){d[a+"Data"]||(d[a+"Data"]=[])});d.points||d.data||d.setData(b.data,!1);d.isCartesian&&(a.hasCartesianSeries=!0);e.length&&(k=e[e.length-1]);d._i=h(k&&k._i,-1)+1;a.orderSeries(this.insert(e));l(this,"afterInit")},insert:function(a){var b=this.options.index,d;if(C(b)){for(d=a.length;d--;)if(b>=
h(a[d].options.index,a[d]._i)){a.splice(d+1,0,this);break}-1===d&&a.unshift(this);d+=1}else a.push(this);return h(d,a.length-1)},bindAxes:function(){var a=this,b=a.options,d=a.chart,e;l(this,"bindAxes",null,function(){(a.axisTypes||[]).forEach(function(k){d[k].forEach(function(d){e=d.options;if(b[k]===e.index||void 0!==b[k]&&b[k]===e.id||void 0===b[k]&&0===e.index)a.insert(d.series),a[k]=d,d.isDirty=!0});a[k]||a.optionalAxis===k||c.error(18,!0,d)})})},updateParallelArrays:function(a,b){var d=a.series,
c=arguments,e=C(b)?function(c){var e="y"===c&&d.toYData?d.toYData(a):a[c];d[c+"Data"][b]=e}:function(a){Array.prototype[b].apply(d[a+"Data"],Array.prototype.slice.call(c,2))};d.parallelArrays.forEach(e)},hasData:function(){return this.visible&&void 0!==this.dataMax&&void 0!==this.dataMin||this.visible&&this.yData&&0<this.yData.length},autoIncrement:function(){var a=this.options,b=this.xIncrement,d,c=a.pointIntervalUnit,e=this.chart.time;b=h(b,a.pointStart,0);this.pointInterval=d=h(this.pointInterval,
a.pointInterval,1);c&&(a=new e.Date(b),"day"===c?e.set("Date",a,e.get("Date",a)+d):"month"===c?e.set("Month",a,e.get("Month",a)+d):"year"===c&&e.set("FullYear",a,e.get("FullYear",a)+d),d=a.getTime()-b);this.xIncrement=b+d;return b},setOptions:function(a){var b=this.chart,c=b.options,e=c.plotOptions,k=b.userOptions||{};a=L(a);b=b.styledMode;var g={plotOptions:e,userOptions:a};l(this,"setOptions",g);var f=g.plotOptions[this.type],p=k.plotOptions||{};this.userOptions=g.userOptions;k=L(f,e.series,k.plotOptions&&
k.plotOptions[this.type],a);this.tooltipOptions=L(d.tooltip,d.plotOptions.series&&d.plotOptions.series.tooltip,d.plotOptions[this.type].tooltip,c.tooltip.userOptions,e.series&&e.series.tooltip,e[this.type].tooltip,a.tooltip);this.stickyTracking=h(a.stickyTracking,p[this.type]&&p[this.type].stickyTracking,p.series&&p.series.stickyTracking,this.tooltipOptions.shared&&!this.noSharedTooltip?!0:k.stickyTracking);null===f.marker&&delete k.marker;this.zoneAxis=k.zoneAxis;c=this.zones=(k.zones||[]).slice();
!k.negativeColor&&!k.negativeFillColor||k.zones||(e={value:k[this.zoneAxis+"Threshold"]||k.threshold||0,className:"highcharts-negative"},b||(e.color=k.negativeColor,e.fillColor=k.negativeFillColor),c.push(e));c.length&&z(c[c.length-1].value)&&c.push(b?{}:{color:this.color,fillColor:this.fillColor});l(this,"afterSetOptions",{options:k});return k},getName:function(){return h(this.options.name,"Series "+(this.index+1))},getCyclic:function(a,b,d){var c=this.chart,e=this.userOptions,k=a+"Index",g=a+"Counter",
f=d?d.length:h(c.options.chart[a+"Count"],c[a+"Count"]);if(!b){var r=h(e[k],e["_"+k]);z(r)||(c.series.length||(c[g]=0),e["_"+k]=r=c[g]%f,c[g]+=1);d&&(b=d[r])}void 0!==r&&(this[k]=r);this[a]=b},getColor:function(){this.chart.styledMode?this.getCyclic("color"):this.options.colorByPoint?this.options.color=null:this.getCyclic("color",this.options.color||e[this.type].color,this.chart.options.colors)},getSymbol:function(){this.getCyclic("symbol",this.options.marker.symbol,this.chart.options.symbols)},findPointIndex:function(a,
b){var d=a.id;a=a.x;var c=this.points,e;if(d){var k=(d=this.chart.get(d))&&d.index;void 0!==k&&(e=!0)}void 0===k&&C(a)&&(k=this.xData.indexOf(a,b));-1!==k&&void 0!==k&&this.cropped&&(k=k>=this.cropStart?k-this.cropStart:k);!e&&c[k]&&c[k].touched&&(k=void 0);return k},drawLegendSymbol:c.LegendSymbolMixin.drawLineMarker,updateData:function(a){var b=this.options,d=this.points,c=[],e,k,g,h=this.requireSorting,f=a.length===d.length,l=!0;this.xIncrement=null;a.forEach(function(a,k){var m=z(a)&&this.pointClass.prototype.optionsToObject.call({series:this},
a)||{};var r=m.x;if(m.id||C(r))if(r=this.findPointIndex(m,g),-1===r||void 0===r?c.push(a):d[r]&&a!==b.data[r]?(d[r].update(a,!1,null,!1),d[r].touched=!0,h&&(g=r+1)):d[r]&&(d[r].touched=!0),!f||k!==r||this.hasDerivedData)e=!0},this);if(e)for(a=d.length;a--;)(k=d[a])&&!k.touched&&k.remove(!1);else f?a.forEach(function(a,b){d[b].update&&a!==d[b].y&&d[b].update(a,!1,null,!1)}):l=!1;d.forEach(function(a){a&&(a.touched=!1)});if(!l)return!1;c.forEach(function(a){this.addPoint(a,!1,null,null,!1)},this);return!0},
setData:function(a,b,d,e){var k=this,g=k.points,f=g&&g.length||0,r,l=k.options,p=k.chart,x=null,A=k.xAxis;x=l.turboThreshold;var u=this.xData,n=this.yData,q=(r=k.pointArrayMap)&&r.length,y=l.keys,t=0,E=1,L;a=a||[];r=a.length;b=h(b,!0);!1!==e&&r&&f&&!k.cropped&&!k.hasGroupedData&&k.visible&&!k.isSeriesBoosting&&(L=this.updateData(a));if(!L){k.xIncrement=null;k.colorCounter=0;this.parallelArrays.forEach(function(a){k[a+"Data"].length=0});if(x&&r>x)if(x=k.getFirstValidPoint(a),C(x))for(d=0;d<r;d++)u[d]=
this.autoIncrement(),n[d]=a[d];else if(v(x))if(q)for(d=0;d<r;d++)e=a[d],u[d]=e[0],n[d]=e.slice(1,q+1);else for(y&&(t=y.indexOf("x"),E=y.indexOf("y"),t=0<=t?t:0,E=0<=E?E:1),d=0;d<r;d++)e=a[d],u[d]=e[t],n[d]=e[E];else c.error(12,!1,p);else for(d=0;d<r;d++)void 0!==a[d]&&(e={series:k},k.pointClass.prototype.applyOptions.apply(e,[a[d]]),k.updateParallelArrays(e,d));n&&H(n[0])&&c.error(14,!0,p);k.data=[];k.options.data=k.userOptions.data=a;for(d=f;d--;)g[d]&&g[d].destroy&&g[d].destroy();A&&(A.minRange=
A.userMinRange);k.isDirty=p.isDirtyBox=!0;k.isDirtyData=!!g;d=!1}"point"===l.legendType&&(this.processData(),this.generatePoints());b&&p.redraw(d)},processData:function(a){var b=this.xData,d=this.yData,e=b.length;var k=0;var g=this.xAxis,h=this.options;var f=h.cropThreshold;var l=this.getExtremesFromAll||h.getExtremesFromAll,p=this.isCartesian;h=g&&g.val2lin;var u=g&&g.isLog,n=this.requireSorting;if(p&&!this.isDirty&&!g.isDirty&&!this.yAxis.isDirty&&!a)return!1;if(g){a=g.getExtremes();var q=a.min;
var v=a.max}if(p&&this.sorted&&!l&&(!f||e>f||this.forceCrop))if(b[e-1]<q||b[0]>v)b=[],d=[];else if(this.yData&&(b[0]<q||b[e-1]>v)){k=this.cropData(this.xData,this.yData,q,v);b=k.xData;d=k.yData;k=k.start;var y=!0}for(f=b.length||1;--f;)if(e=u?h(b[f])-h(b[f-1]):b[f]-b[f-1],0<e&&(void 0===t||e<t))var t=e;else 0>e&&n&&(c.error(15,!1,this.chart),n=!1);this.cropped=y;this.cropStart=k;this.processedXData=b;this.processedYData=d;this.closestPointRange=this.basePointRange=t},cropData:function(a,b,d,e,c){var k=
a.length,g=0,f=k,r;c=h(c,this.cropShoulder);for(r=0;r<k;r++)if(a[r]>=d){g=Math.max(0,r-c);break}for(d=r;d<k;d++)if(a[d]>e){f=d+c;break}return{xData:a.slice(g,f),yData:b.slice(g,f),start:g,end:f}},generatePoints:function(){var a=this.options,b=a.data,d=this.data,e,c=this.processedXData,g=this.processedYData,f=this.pointClass,h=c.length,p=this.cropStart||0,u=this.hasGroupedData;a=a.keys;var q=[],v;d||u||(d=[],d.length=b.length,d=this.data=d);a&&u&&(this.options.keys=!1);for(v=0;v<h;v++){var y=p+v;if(u){var E=
(new f).init(this,[c[v]].concat(n(g[v])));E.dataGroup=this.groupMap[v];E.dataGroup.options&&(E.options=E.dataGroup.options,t(E,E.dataGroup.options),delete E.dataLabels)}else(E=d[y])||void 0===b[y]||(d[y]=E=(new f).init(this,b[y],c[v]));E&&(E.index=y,q[v]=E)}this.options.keys=a;if(d&&(h!==(e=d.length)||u))for(v=0;v<e;v++)v!==p||u||(v+=h),d[v]&&(d[v].destroyElements(),d[v].plotX=void 0);this.data=d;this.points=q;l(this,"afterGeneratePoints")},getXExtremes:function(a){return{min:G(a),max:F(a)}},getExtremes:function(a){var b=
this.xAxis,d=this.yAxis,e=this.processedXData||this.xData,c=[],k=0,g=0;var f=0;var h=this.requireSorting?this.cropShoulder:0,p=d?d.positiveValuesOnly:!1,u;a=a||this.stackedYData||this.processedYData||[];d=a.length;b&&(f=b.getExtremes(),g=f.min,f=f.max);for(u=0;u<d;u++){var n=e[u];var q=a[u];var y=(C(q)||v(q))&&(q.length||0<q||!p);n=this.getExtremesFromAll||this.options.getExtremesFromAll||this.cropped||!b||(e[u+h]||n)>=g&&(e[u-h]||n)<=f;if(y&&n)if(y=q.length)for(;y--;)C(q[y])&&(c[k++]=q[y]);else c[k++]=
q}this.dataMin=G(c);this.dataMax=F(c);l(this,"afterGetExtremes")},getFirstValidPoint:function(a){for(var b=null,d=a.length,e=0;null===b&&e<d;)b=a[e],e++;return b},translate:function(){this.processedXData||this.processData();this.generatePoints();var b=this.options,d=b.stacking,e=this.xAxis,c=e.categories,g=this.yAxis,m=this.points,f=m.length,p=!!this.modifyValue,u,n=this.pointPlacementToXValue(),q=C(n),y=b.threshold,t=b.startFromThreshold?y:0,E,L=this.zoneAxis||"y",B=Number.MAX_VALUE;for(u=0;u<f;u++){var H=
m[u],G=H.x;var F=H.y;var I=H.low,M=d&&g.stacks[(this.negStacks&&F<(t?0:y)?"-":"")+this.stackKey];g.positiveValuesOnly&&null!==F&&0>=F&&(H.isNull=!0);H.plotX=E=a(Math.min(Math.max(-1E5,e.translate(G,0,0,0,1,n,"flags"===this.type)),1E5));if(d&&this.visible&&M&&M[G]){var X=this.getStackIndicator(X,G,this.index);if(!H.isNull){var P=M[G];var Y=P.points[X.key]}}v(Y)&&(I=Y[0],F=Y[1],I===t&&X.key===M[G].base&&(I=h(C(y)&&y,g.min)),g.positiveValuesOnly&&0>=I&&(I=null),H.total=H.stackTotal=P.total,H.percentage=
P.total&&H.y/P.total*100,H.stackY=F,this.irregularWidths||P.setOffset(this.pointXOffset||0,this.barW||0));H.yBottom=z(I)?Math.min(Math.max(-1E5,g.translate(I,0,1,0,1)),1E5):null;p&&(F=this.modifyValue(F,H));H.plotY=F="number"===typeof F&&Infinity!==F?Math.min(Math.max(-1E5,g.translate(F,0,1,0,1)),1E5):void 0;H.isInside=void 0!==F&&0<=F&&F<=g.len&&0<=E&&E<=e.len;H.clientX=q?a(e.translate(G,0,0,0,1,n)):E;H.negative=H[L]<(b[L+"Threshold"]||y||0);H.category=c&&void 0!==c[H.x]?c[H.x]:H.x;if(!H.isNull){void 0!==
Z&&(B=Math.min(B,Math.abs(E-Z)));var Z=E}H.zone=this.zones.length&&H.getZone()}this.closestPointRangePx=B;l(this,"afterTranslate")},getValidPoints:function(a,b,d){var e=this.chart;return(a||this.points||[]).filter(function(a){return b&&!e.isInsidePlot(a.plotX,a.plotY,e.inverted)?!1:d||!a.isNull})},getClipBox:function(a,b){var d=this.options,e=this.chart,c=e.inverted,k=this.xAxis,g=k&&this.yAxis;a&&!1===d.clip&&g?a=c?{y:-e.chartWidth+g.len+g.pos,height:e.chartWidth,width:e.chartHeight,x:-e.chartHeight+
k.len+k.pos}:{y:-g.pos,height:e.chartHeight,width:e.chartWidth,x:-k.pos}:(a=this.clipBox||e.clipBox,b&&(a.width=e.plotSizeX,a.x=0));return b?{width:a.width,x:a.x}:a},setClip:function(a){var b=this.chart,d=this.options,e=b.renderer,c=b.inverted,k=this.clipBox,g=this.getClipBox(a),f=this.sharedClipKey||["_sharedClip",a&&a.duration,a&&a.easing,g.height,d.xAxis,d.yAxis].join(),h=b[f],l=b[f+"m"];h||(a&&(g.width=0,c&&(g.x=b.plotSizeX+(!1!==d.clip?0:b.plotTop)),b[f+"m"]=l=e.clipRect(c?b.plotSizeX+99:-99,
c?-b.plotLeft:-b.plotTop,99,c?b.chartWidth:b.chartHeight)),b[f]=h=e.clipRect(g),h.count={length:0});a&&!h.count[this.index]&&(h.count[this.index]=!0,h.count.length+=1);if(!1!==d.clip||a)this.group.clip(a||k?h:b.clipRect),this.markerGroup.clip(l),this.sharedClipKey=f;a||(h.count[this.index]&&(delete h.count[this.index],--h.count.length),0===h.count.length&&f&&b[f]&&(k||(b[f]=b[f].destroy()),b[f+"m"]&&(b[f+"m"]=b[f+"m"].destroy())))},animate:function(a){var d=this.chart,e=b(this.options.animation);
if(a)this.setClip(e);else{var c=this.sharedClipKey;a=d[c];var k=this.getClipBox(e,!0);a&&a.animate(k,e);d[c+"m"]&&d[c+"m"].animate({width:k.width+99,x:k.x-(d.inverted?0:99)},e);this.animate=null}},afterAnimate:function(){this.setClip();l(this,"afterAnimate");this.finishedAnimating=!0},drawPoints:function(){var a=this.points,b=this.chart,d,e=this.options.marker,c=this[this.specialGroup]||this.markerGroup;var g=this.xAxis;var f=h(e.enabled,!g||g.isRadial?!0:null,this.closestPointRangePx>=e.enabledThreshold*
e.radius);if(!1!==e.enabled||this._hasPointMarkers)for(g=0;g<a.length;g++){var l=a[g];var p=(d=l.graphic)?"animate":"attr";var u=l.marker||{};var n=!!l.marker;var q=f&&void 0===u.enabled||u.enabled;var v=!1!==l.isInside;if(q&&!l.isNull){var y=h(u.symbol,this.symbol);q=this.markerAttribs(l,l.selected&&"select");d?d[v?"show":"hide"](v).animate(q):v&&(0<q.width||l.hasImage)&&(l.graphic=d=b.renderer.symbol(y,q.x,q.y,q.width,q.height,n?u:e).add(c));if(d&&!b.styledMode)d[p](this.pointAttribs(l,l.selected&&
"select"));d&&d.addClass(l.getClassName(),!0)}else d&&(l.graphic=d.destroy())}},markerAttribs:function(a,b){var d=this.options.marker,e=a.marker||{},c=e.symbol||d.symbol,k=h(e.radius,d.radius);b&&(d=d.states[b],b=e.states&&e.states[b],k=h(b&&b.radius,d&&d.radius,k+(d&&d.radiusPlus||0)));a.hasImage=c&&0===c.indexOf("url");a.hasImage&&(k=0);a={x:Math.floor(a.plotX)-k,y:a.plotY-k};k&&(a.width=a.height=2*k);return a},pointAttribs:function(a,b){var d=this.options.marker,e=a&&a.options,c=e&&e.marker||{},
k=this.color,g=e&&e.color,f=a&&a.color;e=h(c.lineWidth,d.lineWidth);var l=a&&a.zone&&a.zone.color;a=1;k=g||l||f||k;g=c.fillColor||d.fillColor||k;k=c.lineColor||d.lineColor||k;b=b||"normal";d=d.states[b];b=c.states&&c.states[b]||{};e=h(b.lineWidth,d.lineWidth,e+h(b.lineWidthPlus,d.lineWidthPlus,0));g=b.fillColor||d.fillColor||g;k=b.lineColor||d.lineColor||k;a=h(b.opacity,d.opacity,a);return{stroke:k,"stroke-width":e,fill:g,opacity:a}},destroy:function(a){var b=this,d=b.chart,e=/AppleWebKit\/533/.test(u.navigator.userAgent),
k,g,f=b.data||[],h,n;l(b,"destroy");a||E(b);(b.axisTypes||[]).forEach(function(a){(n=b[a])&&n.series&&(B(n.series,b),n.isDirty=n.forceRedraw=!0)});b.legendItem&&b.chart.legend.destroyItem(b);for(g=f.length;g--;)(h=f[g])&&h.destroy&&h.destroy();b.points=null;c.clearTimeout(b.animationTimeout);y(b,function(a,b){a instanceof p&&!a.survive&&(k=e&&"group"===b?"hide":"destroy",a[k]())});d.hoverSeries===b&&(d.hoverSeries=null);B(d.series,b);d.orderSeries();y(b,function(d,e){a&&"hcEvents"===e||delete b[e]})},
getGraphPath:function(a,b,d){var e=this,c=e.options,k=c.step,g,f=[],h=[],l;a=a||e.points;(g=a.reversed)&&a.reverse();(k={right:1,center:2}[k]||k&&3)&&g&&(k=4-k);!c.connectNulls||b||d||(a=this.getValidPoints(a));a.forEach(function(g,m){var r=g.plotX,p=g.plotY,u=a[m-1];(g.leftCliff||u&&u.rightCliff)&&!d&&(l=!0);g.isNull&&!z(b)&&0<m?l=!c.connectNulls:g.isNull&&!b?l=!0:(0===m||l?m=["M",g.plotX,g.plotY]:e.getPointSpline?m=e.getPointSpline(a,g,m):k?(m=1===k?["L",u.plotX,p]:2===k?["L",(u.plotX+r)/2,u.plotY,
"L",(u.plotX+r)/2,p]:["L",r,u.plotY],m.push("L",r,p)):m=["L",r,p],h.push(g.x),k&&(h.push(g.x),2===k&&h.push(g.x)),f.push.apply(f,m),l=!1)});f.xMap=h;return e.graphPath=f},drawGraph:function(){var a=this,b=this.options,d=(this.gappedPath||this.getGraphPath).call(this),e=this.chart.styledMode,c=[["graph","highcharts-graph"]];e||c[0].push(b.lineColor||this.color||"#cccccc",b.dashStyle);c=a.getZonesGraphs(c);c.forEach(function(c,k){var g=c[0],f=a[g],h=f?"animate":"attr";f?(f.endX=a.preventGraphAnimation?
null:d.xMap,f.animate({d:d})):d.length&&(a[g]=f=a.chart.renderer.path(d).addClass(c[1]).attr({zIndex:1}).add(a.group));f&&!e&&(g={stroke:c[2],"stroke-width":b.lineWidth,fill:a.fillGraph&&a.color||"none"},c[3]?g.dashstyle=c[3]:"square"!==b.linecap&&(g["stroke-linecap"]=g["stroke-linejoin"]="round"),f[h](g).shadow(2>k&&b.shadow));f&&(f.startX=d.xMap,f.isArea=d.isArea)})},getZonesGraphs:function(a){this.zones.forEach(function(b,d){d=["zone-graph-"+d,"highcharts-graph highcharts-zone-graph-"+d+" "+(b.className||
"")];this.chart.styledMode||d.push(b.color||this.color,b.dashStyle||this.options.dashStyle);a.push(d)},this);return a},applyZones:function(){var a=this,b=this.chart,d=b.renderer,e=this.zones,c,g,f=this.clips||[],l,p=this.graph,u=this.area,n=Math.max(b.chartWidth,b.chartHeight),q=this[(this.zoneAxis||"y")+"Axis"],v=b.inverted,y,t,E,C=!1;if(e.length&&(p||u)&&q&&void 0!==q.min){var L=q.reversed;var z=q.horiz;p&&!this.showLine&&p.hide();u&&u.hide();var B=q.getExtremes();e.forEach(function(e,k){c=L?z?
b.plotWidth:0:z?0:q.toPixels(B.min)||0;c=Math.min(Math.max(h(g,c),0),n);g=Math.min(Math.max(Math.round(q.toPixels(h(e.value,B.max),!0)||0),0),n);C&&(c=g=q.toPixels(B.max));y=Math.abs(c-g);t=Math.min(c,g);E=Math.max(c,g);q.isXAxis?(l={x:v?E:t,y:0,width:y,height:n},z||(l.x=b.plotHeight-l.x)):(l={x:0,y:v?E:t,width:n,height:y},z&&(l.y=b.plotWidth-l.y));v&&d.isVML&&(l=q.isXAxis?{x:0,y:L?t:E,height:l.width,width:b.chartWidth}:{x:l.y-b.plotLeft-b.spacingBox.x,y:0,width:l.height,height:b.chartHeight});f[k]?
f[k].animate(l):f[k]=d.clipRect(l);p&&a["zone-graph-"+k].clip(f[k]);u&&a["zone-area-"+k].clip(f[k]);C=e.value>B.max;a.resetZones&&0===g&&(g=void 0)});this.clips=f}else a.visible&&(p&&p.show(!0),u&&u.show(!0))},invertGroups:function(a){function b(){["group","markerGroup"].forEach(function(b){d[b]&&(e.renderer.isVML&&d[b].attr({width:d.yAxis.len,height:d.xAxis.len}),d[b].width=d.yAxis.len,d[b].height=d.xAxis.len,d[b].invert(a))})}var d=this,e=d.chart;if(d.xAxis){var c=g(e,"resize",b);g(d,"destroy",
c);b(a);d.invertGroups=b}},plotGroup:function(a,b,d,e,c){var k=this[a],g=!k;g&&(this[a]=k=this.chart.renderer.g().attr({zIndex:e||.1}).add(c));k.addClass("highcharts-"+b+" highcharts-series-"+this.index+" highcharts-"+this.type+"-series "+(z(this.colorIndex)?"highcharts-color-"+this.colorIndex+" ":"")+(this.options.className||"")+(k.hasClass("highcharts-tracker")?" highcharts-tracker":""),!0);k.attr({visibility:d})[g?"attr":"animate"](this.getPlotBox());return k},getPlotBox:function(){var a=this.chart,
b=this.xAxis,d=this.yAxis;a.inverted&&(b=d,d=this.xAxis);return{translateX:b?b.left:a.plotLeft,translateY:d?d.top:a.plotTop,scaleX:1,scaleY:1}},render:function(){var a=this,d=a.chart,e=a.options,c=!!a.animate&&d.renderer.isSVG&&b(e.animation).duration,g=a.visible?"inherit":"hidden",f=e.zIndex,h=a.hasRendered,p=d.seriesGroup,u=d.inverted;l(this,"render");var n=a.plotGroup("group","series",g,f,p);a.markerGroup=a.plotGroup("markerGroup","markers",g,f,p);c&&a.animate(!0);n.inverted=a.isCartesian||a.invertable?
u:!1;a.drawGraph&&(a.drawGraph(),a.applyZones());a.visible&&a.drawPoints();a.drawDataLabels&&a.drawDataLabels();a.redrawPoints&&a.redrawPoints();a.drawTracker&&!1!==a.options.enableMouseTracking&&a.drawTracker();a.invertGroups(u);!1===e.clip||a.sharedClipKey||h||n.clip(d.clipRect);c&&a.animate();h||(a.animationTimeout=q(function(){a.afterAnimate()},c||0));a.isDirty=!1;a.hasRendered=!0;l(a,"afterRender")},redraw:function(){var a=this.chart,b=this.isDirty||this.isDirtyData,d=this.group,e=this.xAxis,
c=this.yAxis;d&&(a.inverted&&d.attr({width:a.plotWidth,height:a.plotHeight}),d.animate({translateX:h(e&&e.left,a.plotLeft),translateY:h(c&&c.top,a.plotTop)}));this.translate();this.render();b&&delete this.kdTree},kdAxisArray:["clientX","plotY"],searchPoint:function(a,b){var d=this.xAxis,e=this.yAxis,c=this.chart.inverted;return this.searchKDTree({clientX:c?d.len-a.chartY+d.pos:a.chartX-d.pos,plotY:c?e.len-a.chartX+e.pos:a.chartY-e.pos},b,a)},buildKDTree:function(a){function b(a,e,c){var g;if(g=a&&
a.length){var k=d.kdAxisArray[e%c];a.sort(function(a,b){return a[k]-b[k]});g=Math.floor(g/2);return{point:a[g],left:b(a.slice(0,g),e+1,c),right:b(a.slice(g+1),e+1,c)}}}this.buildingKdTree=!0;var d=this,e=-1<d.options.findNearestPointBy.indexOf("y")?2:1;delete d.kdTree;q(function(){d.kdTree=b(d.getValidPoints(null,!d.directTouch),e,e);d.buildingKdTree=!1},d.options.kdNow||a&&"touchstart"===a.type?0:1)},searchKDTree:function(a,b,d){function e(a,b,d,h){var l=b.point,m=c.kdAxisArray[d%h],p=l;var r=z(a[g])&&
z(l[g])?Math.pow(a[g]-l[g],2):null;var u=z(a[k])&&z(l[k])?Math.pow(a[k]-l[k],2):null;u=(r||0)+(u||0);l.dist=z(u)?Math.sqrt(u):Number.MAX_VALUE;l.distX=z(r)?Math.sqrt(r):Number.MAX_VALUE;m=a[m]-l[m];u=0>m?"left":"right";r=0>m?"right":"left";b[u]&&(u=e(a,b[u],d+1,h),p=u[f]<p[f]?u:l);b[r]&&Math.sqrt(m*m)<p[f]&&(a=e(a,b[r],d+1,h),p=a[f]<p[f]?a:p);return p}var c=this,g=this.kdAxisArray[0],k=this.kdAxisArray[1],f=b?"distX":"dist";b=-1<c.options.findNearestPointBy.indexOf("y")?2:1;this.kdTree||this.buildingKdTree||
this.buildKDTree(d);if(this.kdTree)return e(a,this.kdTree,b,b)},pointPlacementToXValue:function(){var a=this.xAxis,b=this.options.pointPlacement;"between"===b&&(b=a.reversed?-.5:.5);C(b)&&(b*=h(this.options.pointRange||a.pointRange));return b}});""});M(I,"parts/Stacking.js",[I["parts/Globals.js"],I["parts/Utilities.js"]],function(c,f){var F=f.defined,G=f.destroyObjectProperties,z=f.objectEach,B=f.pick;f=c.Axis;var t=c.Chart,v=c.correctFloat,C=c.format,H=c.Series;c.StackItem=function(c,f,n,q,g){var b=
c.chart.inverted;this.axis=c;this.isNegative=n;this.options=f=f||{};this.x=q;this.total=null;this.points={};this.stack=g;this.rightCliff=this.leftCliff=0;this.alignOptions={align:f.align||(b?n?"left":"right":"center"),verticalAlign:f.verticalAlign||(b?"middle":n?"bottom":"top"),y:f.y,x:f.x};this.textAlign=f.textAlign||(b?n?"right":"left":"center")};c.StackItem.prototype={destroy:function(){G(this,this.axis)},render:function(c){var f=this.axis.chart,n=this.options,q=n.format;q=q?C(q,this,f.time):n.formatter.call(this);
this.label?this.label.attr({text:q,visibility:"hidden"}):(this.label=f.renderer.label(q,null,null,n.shape,null,null,n.useHTML,!1,"stack-labels"),q={text:q,align:this.textAlign,rotation:n.rotation,padding:B(n.padding,0),visibility:"hidden"},this.label.attr(q),f.styledMode||this.label.css(n.style),this.label.added||this.label.add(c));this.label.labelrank=f.plotHeight},setOffset:function(c,f,n,q,g){var b=this.axis,a=b.chart;q=b.translate(b.usePercentage?100:q?q:this.total,0,0,0,1);n=b.translate(n?n:
0);n=F(q)&&Math.abs(q-n);c=B(g,a.xAxis[0].translate(this.x))+c;b=F(q)&&this.getStackBox(a,this,c,q,f,n,b);f=this.label;c=this.isNegative;g="justify"===B(this.options.overflow,"justify");if(f&&b){n=f.getBBox();var d=a.inverted?c?n.width:0:n.width/2,e=a.inverted?n.height/2:c?-4:n.height+4;this.alignOptions.x=B(this.options.x,0);f.align(this.alignOptions,null,b);q=f.alignAttr;f.show();q.y-=e;g&&(q.x-=d,H.prototype.justifyDataLabel.call(this.axis,f,this.alignOptions,q,n,b),q.x+=d);q.x=f.alignAttr.x;f.attr({x:q.x,
y:q.y});B(!g&&this.options.crop,!0)&&((a=a.isInsidePlot(f.x+(a.inverted?0:-n.width/2),f.y)&&a.isInsidePlot(f.x+(a.inverted?c?-n.width:n.width:n.width/2),f.y+n.height))||f.hide())}},getStackBox:function(c,f,n,q,g,b,a){var d=f.axis.reversed,e=c.inverted;c=a.height+a.pos-(e?c.plotLeft:c.plotTop);f=f.isNegative&&!d||!f.isNegative&&d;return{x:e?f?q:q-b:n,y:e?c-n-g:f?c-q-b:c-q,width:e?b:g,height:e?g:b}}};t.prototype.getStacks=function(){var c=this,f=c.inverted;c.yAxis.forEach(function(c){c.stacks&&c.hasVisibleSeries&&
(c.oldStacks=c.stacks)});c.series.forEach(function(h){var n=h.xAxis&&h.xAxis.options||{};!h.options.stacking||!0!==h.visible&&!1!==c.options.chart.ignoreHiddenSeries||(h.stackKey=[h.type,B(h.options.stack,""),f?n.top:n.left,f?n.height:n.width].join())})};f.prototype.buildStacks=function(){var c=this.series,f=B(this.options.reversedStacks,!0),n=c.length,q;if(!this.isXAxis){this.usePercentage=!1;for(q=n;q--;)c[f?q:n-q-1].setStackedPoints();for(q=0;q<n;q++)c[q].modifyStacks()}};f.prototype.renderStackTotals=
function(){var c=this.chart,f=c.renderer,n=this.stacks,q=this.stackTotalGroup;q||(this.stackTotalGroup=q=f.g("stack-labels").attr({visibility:"visible",zIndex:6}).add());q.translate(c.plotLeft,c.plotTop);z(n,function(c){z(c,function(b){b.render(q)})})};f.prototype.resetStacks=function(){var c=this,f=c.stacks;c.isXAxis||z(f,function(f){z(f,function(h,g){h.touched<c.stacksTouched?(h.destroy(),delete f[g]):(h.total=null,h.cumulative=null)})})};f.prototype.cleanStacks=function(){if(!this.isXAxis){if(this.oldStacks)var c=
this.stacks=this.oldStacks;z(c,function(c){z(c,function(c){c.cumulative=c.total})})}};H.prototype.setStackedPoints=function(){if(this.options.stacking&&(!0===this.visible||!1===this.chart.options.chart.ignoreHiddenSeries)){var f=this.processedXData,h=this.processedYData,n=[],q=h.length,g=this.options,b=g.threshold,a=B(g.startFromThreshold&&b,0),d=g.stack;g=g.stacking;var e=this.stackKey,l="-"+e,t=this.negStacks,E=this.yAxis,p=E.stacks,u=E.oldStacks,k,r;E.stacksTouched+=1;for(r=0;r<q;r++){var x=f[r];
var A=h[r];var w=this.getStackIndicator(w,x,this.index);var m=w.key;var K=(k=t&&A<(a?0:b))?l:e;p[K]||(p[K]={});p[K][x]||(u[K]&&u[K][x]?(p[K][x]=u[K][x],p[K][x].total=null):p[K][x]=new c.StackItem(E,E.options.stackLabels,k,x,d));K=p[K][x];null!==A?(K.points[m]=K.points[this.index]=[B(K.cumulative,a)],F(K.cumulative)||(K.base=m),K.touched=E.stacksTouched,0<w.index&&!1===this.singleStacks&&(K.points[m][0]=K.points[this.index+","+x+",0"][0])):K.points[m]=K.points[this.index]=null;"percent"===g?(k=k?e:
l,t&&p[k]&&p[k][x]?(k=p[k][x],K.total=k.total=Math.max(k.total,K.total)+Math.abs(A)||0):K.total=v(K.total+(Math.abs(A)||0))):K.total=v(K.total+(A||0));K.cumulative=B(K.cumulative,a)+(A||0);null!==A&&(K.points[m].push(K.cumulative),n[r]=K.cumulative)}"percent"===g&&(E.usePercentage=!0);this.stackedYData=n;E.oldStacks={}}};H.prototype.modifyStacks=function(){var c=this,f=c.stackKey,n=c.yAxis.stacks,q=c.processedXData,g,b=c.options.stacking;c[b+"Stacker"]&&[f,"-"+f].forEach(function(a){for(var d=q.length,
e,f;d--;)if(e=q[d],g=c.getStackIndicator(g,e,c.index,a),f=(e=n[a]&&n[a][e])&&e.points[g.key])c[b+"Stacker"](f,e,d)})};H.prototype.percentStacker=function(c,f,n){f=f.total?100/f.total:0;c[0]=v(c[0]*f);c[1]=v(c[1]*f);this.stackedYData[n]=c[1]};H.prototype.getStackIndicator=function(c,f,n,q){!F(c)||c.x!==f||q&&c.key!==q?c={x:f,index:0,key:q}:c.index++;c.key=[n,f,c.index].join();return c}});M(I,"parts/Dynamics.js",[I["parts/Globals.js"],I["parts/Utilities.js"]],function(c,f){var F=f.defined,G=f.erase,
z=f.extend,B=f.isArray,t=f.isNumber,v=f.isObject,C=f.isString,H=f.objectEach,y=f.pick,h=f.setAnimation,n=f.splat,q=c.addEvent,g=c.animate,b=c.Axis;f=c.Chart;var a=c.createElement,d=c.css,e=c.fireEvent,l=c.merge,L=c.Point,E=c.Series,p=c.seriesTypes;c.cleanRecursively=function(a,b){var d={};H(a,function(e,g){if(v(a[g],!0)&&!a.nodeType&&b[g])e=c.cleanRecursively(a[g],b[g]),Object.keys(e).length&&(d[g]=e);else if(v(a[g])||a[g]!==b[g])d[g]=a[g]});return d};z(f.prototype,{addSeries:function(a,b,d){var c,
g=this;a&&(b=y(b,!0),e(g,"addSeries",{options:a},function(){c=g.initSeries(a);g.isDirtyLegend=!0;g.linkSeries();e(g,"afterAddSeries",{series:c});b&&g.redraw(d)}));return c},addAxis:function(a,b,d,c){return this.createAxis(b?"xAxis":"yAxis",{axis:a,redraw:d,animation:c})},addColorAxis:function(a,b,d){return this.createAxis("colorAxis",{axis:a,redraw:b,animation:d})},createAxis:function(a,d){var e=this.options,g="colorAxis"===a,k=d.redraw,f=d.animation;d=l(d.axis,{index:this[a].length,isX:"xAxis"===
a});var h=g?new c.ColorAxis(this,d):new b(this,d);e[a]=n(e[a]||{});e[a].push(d);g&&(this.isDirtyLegend=!0,this.axes.forEach(function(a){a.series=[]}),this.series.forEach(function(a){a.bindAxes();a.isDirtyData=!0}));y(k,!0)&&this.redraw(f);return h},showLoading:function(b){var c=this,e=c.options,f=c.loadingDiv,h=e.loading,l=function(){f&&d(f,{left:c.plotLeft+"px",top:c.plotTop+"px",width:c.plotWidth+"px",height:c.plotHeight+"px"})};f||(c.loadingDiv=f=a("div",{className:"highcharts-loading highcharts-loading-hidden"},
null,c.container),c.loadingSpan=a("span",{className:"highcharts-loading-inner"},null,f),q(c,"redraw",l));f.className="highcharts-loading";c.loadingSpan.innerHTML=y(b,e.lang.loading,"");c.styledMode||(d(f,z(h.style,{zIndex:10})),d(c.loadingSpan,h.labelStyle),c.loadingShown||(d(f,{opacity:0,display:""}),g(f,{opacity:h.style.opacity||.5},{duration:h.showDuration||0})));c.loadingShown=!0;l()},hideLoading:function(){var a=this.options,b=this.loadingDiv;b&&(b.className="highcharts-loading highcharts-loading-hidden",
this.styledMode||g(b,{opacity:0},{duration:a.loading.hideDuration||100,complete:function(){d(b,{display:"none"})}}));this.loadingShown=!1},propsRequireDirtyBox:"backgroundColor borderColor borderWidth borderRadius plotBackgroundColor plotBackgroundImage plotBorderColor plotBorderWidth plotShadow shadow".split(" "),propsRequireReflow:"margin marginTop marginRight marginBottom marginLeft spacing spacingTop spacingRight spacingBottom spacingLeft".split(" "),propsRequireUpdateSeries:"chart.inverted chart.polar chart.ignoreHiddenSeries chart.type colors plotOptions time tooltip".split(" "),
collectionsWithUpdate:"xAxis yAxis zAxis colorAxis series pane".split(" "),update:function(a,b,d,g){var k=this,f={credits:"addCredits",title:"setTitle",subtitle:"setSubtitle",caption:"setCaption"},h,p,r,u=a.isResponsiveOptions,q=[];e(k,"update",{options:a});u||k.setResponsive(!1,!0);a=c.cleanRecursively(a,k.options);l(!0,k.userOptions,a);if(h=a.chart){l(!0,k.options.chart,h);"className"in h&&k.setClassName(h.className);"reflow"in h&&k.setReflow(h.reflow);if("inverted"in h||"polar"in h||"type"in h){k.propFromSeries();
var x=!0}"alignTicks"in h&&(x=!0);H(h,function(a,b){-1!==k.propsRequireUpdateSeries.indexOf("chart."+b)&&(p=!0);-1!==k.propsRequireDirtyBox.indexOf(b)&&(k.isDirtyBox=!0);u||-1===k.propsRequireReflow.indexOf(b)||(r=!0)});!k.styledMode&&"style"in h&&k.renderer.setStyle(h.style)}!k.styledMode&&a.colors&&(this.options.colors=a.colors);a.plotOptions&&l(!0,this.options.plotOptions,a.plotOptions);a.time&&this.time===c.time&&(this.time=new c.Time(a.time));H(a,function(a,b){if(k[b]&&"function"===typeof k[b].update)k[b].update(a,
!1);else if("function"===typeof k[f[b]])k[f[b]](a);"chart"!==b&&-1!==k.propsRequireUpdateSeries.indexOf(b)&&(p=!0)});this.collectionsWithUpdate.forEach(function(b){if(a[b]){if("series"===b){var c=[];k[b].forEach(function(a,b){a.options.isInternal||c.push(y(a.options.index,b))})}n(a[b]).forEach(function(a,e){(e=F(a.id)&&k.get(a.id)||k[b][c?c[e]:e])&&e.coll===b&&(e.update(a,!1),d&&(e.touched=!0));!e&&d&&k.collectionsWithInit[b]&&(k.collectionsWithInit[b][0].apply(k,[a].concat(k.collectionsWithInit[b][1]||
[]).concat([!1])).touched=!0)});d&&k[b].forEach(function(a){a.touched||a.options.isInternal?delete a.touched:q.push(a)})}});q.forEach(function(a){a.remove&&a.remove(!1)});x&&k.axes.forEach(function(a){a.update({},!1)});p&&k.series.forEach(function(a){a.update({},!1)});a.loading&&l(!0,k.options.loading,a.loading);x=h&&h.width;h=h&&h.height;C(h)&&(h=c.relativeLength(h,x||k.chartWidth));r||t(x)&&x!==k.chartWidth||t(h)&&h!==k.chartHeight?k.setSize(x,h,g):y(b,!0)&&k.redraw(g);e(k,"afterUpdate",{options:a,
redraw:b,animation:g})},setSubtitle:function(a,b){this.applyDescription("subtitle",a);this.layOutTitles(b)},setCaption:function(a,b){this.applyDescription("caption",a);this.layOutTitles(b)}});f.prototype.collectionsWithInit={xAxis:[f.prototype.addAxis,[!0]],yAxis:[f.prototype.addAxis,[!1]],colorAxis:[f.prototype.addColorAxis,[!1]],series:[f.prototype.addSeries]};z(L.prototype,{update:function(a,b,d,c){function e(){g.applyOptions(a);null===g.y&&f&&(g.graphic=f.destroy());v(a,!0)&&(f&&f.element&&a&&
a.marker&&void 0!==a.marker.symbol&&(g.graphic=f.destroy()),a&&a.dataLabels&&g.dataLabel&&(g.dataLabel=g.dataLabel.destroy()),g.connector&&(g.connector=g.connector.destroy()));h=g.index;k.updateParallelArrays(g,h);p.data[h]=v(p.data[h],!0)||v(a,!0)?g.options:y(a,p.data[h]);k.isDirty=k.isDirtyData=!0;!k.fixedBox&&k.hasCartesianSeries&&(l.isDirtyBox=!0);"point"===p.legendType&&(l.isDirtyLegend=!0);b&&l.redraw(d)}var g=this,k=g.series,f=g.graphic,h,l=k.chart,p=k.options;b=y(b,!0);!1===c?e():g.firePointEvent("update",
{options:a},e)},remove:function(a,b){this.series.removePoint(this.series.data.indexOf(this),a,b)}});z(E.prototype,{addPoint:function(a,b,d,c,g){var k=this.options,f=this.data,h=this.chart,l=this.xAxis;l=l&&l.hasNames&&l.names;var p=k.data,r=this.xData,n;b=y(b,!0);var u={series:this};this.pointClass.prototype.applyOptions.apply(u,[a]);var q=u.x;var x=r.length;if(this.requireSorting&&q<r[x-1])for(n=!0;x&&r[x-1]>q;)x--;this.updateParallelArrays(u,"splice",x,0,0);this.updateParallelArrays(u,x);l&&u.name&&
(l[q]=u.name);p.splice(x,0,a);n&&(this.data.splice(x,0,null),this.processData());"point"===k.legendType&&this.generatePoints();d&&(f[0]&&f[0].remove?f[0].remove(!1):(f.shift(),this.updateParallelArrays(u,"shift"),p.shift()));!1!==g&&e(this,"addPoint",{point:u});this.isDirtyData=this.isDirty=!0;b&&h.redraw(c)},removePoint:function(a,b,d){var c=this,e=c.data,g=e[a],k=c.points,f=c.chart,l=function(){k&&k.length===e.length&&k.splice(a,1);e.splice(a,1);c.options.data.splice(a,1);c.updateParallelArrays(g||
{series:c},"splice",a,1);g&&g.destroy();c.isDirty=!0;c.isDirtyData=!0;b&&f.redraw()};h(d,f);b=y(b,!0);g?g.firePointEvent("remove",null,l):l()},remove:function(a,b,d,c){function g(){k.destroy(c);k.remove=null;f.isDirtyLegend=f.isDirtyBox=!0;f.linkSeries();y(a,!0)&&f.redraw(b)}var k=this,f=k.chart;!1!==d?e(k,"remove",null,g):g()},update:function(a,b){a=c.cleanRecursively(a,this.userOptions);e(this,"update",{options:a});var d=this,g=d.chart,k=d.userOptions,f=d.initialType||d.type,h=a.type||k.type||g.options.chart.type,
n=!(this.hasDerivedData||a.dataGrouping||h&&h!==this.type||void 0!==a.pointStart||a.pointInterval||a.pointIntervalUnit||a.keys),u=p[f].prototype,q,v=["group","markerGroup","dataLabelsGroup","transformGroup"],t=["eventOptions","navigatorSeries","baseSeries"],E=d.finishedAnimating&&{animation:!1},C={};n&&(t.push("data","isDirtyData","points","processedXData","processedYData","xIncrement","_hasPointMarkers","_hasPointLabels","mapMap","mapData","minY","maxY","minX","maxX"),!1!==a.visible&&t.push("area",
"graph"),d.parallelArrays.forEach(function(a){t.push(a+"Data")}),a.data&&this.setData(a.data,!1));a=l(k,E,{index:void 0===k.index?d.index:k.index,pointStart:y(k.pointStart,d.xData[0])},!n&&{data:d.options.data},a);n&&a.data&&(a.data=d.options.data);t=v.concat(t);t.forEach(function(a){t[a]=d[a];delete d[a]});d.remove(!1,null,!1,!0);for(q in u)d[q]=void 0;p[h||f]?z(d,p[h||f].prototype):c.error(17,!0,g,{missingModuleFor:h||f});t.forEach(function(a){d[a]=t[a]});d.init(g,a);if(n&&this.points){var L=d.options;
!1===L.visible?(C.graphic=1,C.dataLabel=1):d._hasPointLabels||(h=L.marker,u=L.dataLabels,h&&(!1===h.enabled||"symbol"in h)&&(C.graphic=1),u&&!1===u.enabled&&(C.dataLabel=1));this.points.forEach(function(a){a&&a.series&&(a.resolveColor(),Object.keys(C).length&&a.destroyElements(C),!1===L.showInLegend&&a.legendItem&&g.legend.destroyItem(a))},this)}a.zIndex!==k.zIndex&&v.forEach(function(b){d[b]&&d[b].attr({zIndex:a.zIndex})});d.initialType=f;g.linkSeries();e(this,"afterUpdate");y(b,!0)&&g.redraw(n?
void 0:!1)},setName:function(a){this.name=this.options.name=this.userOptions.name=a;this.chart.isDirtyLegend=!0}});z(b.prototype,{update:function(a,b){var d=this.chart,c=a&&a.events||{};a=l(this.userOptions,a);d.options[this.coll].indexOf&&(d.options[this.coll][d.options[this.coll].indexOf(this.userOptions)]=a);H(d.options[this.coll].events,function(a,b){"undefined"===typeof c[b]&&(c[b]=void 0)});this.destroy(!0);this.init(d,z(a,{events:c}));d.isDirtyBox=!0;y(b,!0)&&d.redraw()},remove:function(a){for(var b=
this.chart,d=this.coll,c=this.series,e=c.length;e--;)c[e]&&c[e].remove(!1);G(b.axes,this);G(b[d],this);B(b.options[d])?b.options[d].splice(this.options.index,1):delete b.options[d];b[d].forEach(function(a,b){a.options.index=a.userOptions.index=b});this.destroy();b.isDirtyBox=!0;y(a,!0)&&b.redraw()},setTitle:function(a,b){this.update({title:a},b)},setCategories:function(a,b){this.update({categories:a},b)}})});M(I,"parts/AreaSeries.js",[I["parts/Globals.js"],I["parts/Utilities.js"]],function(c,f){var F=
f.objectEach,G=f.pick,z=c.color,B=c.Series;f=c.seriesType;f("area","line",{softThreshold:!1,threshold:0},{singleStacks:!1,getStackPoints:function(c){var f=[],t=[],z=this.xAxis,y=this.yAxis,h=y.stacks[this.stackKey],n={},q=this.index,g=y.series,b=g.length,a=G(y.options.reversedStacks,!0)?1:-1,d;c=c||this.points;if(this.options.stacking){for(d=0;d<c.length;d++)c[d].leftNull=c[d].rightNull=void 0,n[c[d].x]=c[d];F(h,function(a,b){null!==a.total&&t.push(b)});t.sort(function(a,b){return a-b});var e=g.map(function(a){return a.visible});
t.forEach(function(c,g){var l=0,p,u;if(n[c]&&!n[c].isNull)f.push(n[c]),[-1,1].forEach(function(k){var f=1===k?"rightNull":"leftNull",l=0,v=h[t[g+k]];if(v)for(d=q;0<=d&&d<b;)p=v.points[d],p||(d===q?n[c][f]=!0:e[d]&&(u=h[c].points[d])&&(l-=u[1]-u[0])),d+=a;n[c][1===k?"rightCliff":"leftCliff"]=l});else{for(d=q;0<=d&&d<b;){if(p=h[c].points[d]){l=p[1];break}d+=a}l=y.translate(l,0,1,0,1);f.push({isNull:!0,plotX:z.translate(c,0,0,0,1),x:c,plotY:l,yBottom:l})}})}return f},getGraphPath:function(c){var f=B.prototype.getGraphPath,
t=this.options,z=t.stacking,y=this.yAxis,h,n=[],q=[],g=this.index,b=y.stacks[this.stackKey],a=t.threshold,d=Math.round(y.getThreshold(t.threshold));t=G(t.connectNulls,"percent"===z);var e=function(e,f,k){var h=c[e];e=z&&b[h.x].points[g];var l=h[k+"Null"]||0;k=h[k+"Cliff"]||0;h=!0;if(k||l){var p=(l?e[0]:e[1])+k;var u=e[0]+k;h=!!l}else!z&&c[f]&&c[f].isNull&&(p=u=a);void 0!==p&&(q.push({plotX:L,plotY:null===p?d:y.getThreshold(p),isNull:h,isCliff:!0}),n.push({plotX:L,plotY:null===u?d:y.getThreshold(u),
doCurve:!1}))};c=c||this.points;z&&(c=this.getStackPoints(c));for(h=0;h<c.length;h++){z||(c[h].leftCliff=c[h].rightCliff=c[h].leftNull=c[h].rightNull=void 0);var l=c[h].isNull;var L=G(c[h].rectPlotX,c[h].plotX);var E=G(c[h].yBottom,d);if(!l||t)t||e(h,h-1,"left"),l&&!z&&t||(q.push(c[h]),n.push({x:h,plotX:L,plotY:E})),t||e(h,h+1,"right")}h=f.call(this,q,!0,!0);n.reversed=!0;l=f.call(this,n,!0,!0);l.length&&(l[0]="L");l=h.concat(l);f=f.call(this,q,!1,t);l.xMap=h.xMap;this.areaPath=l;return f},drawGraph:function(){this.areaPath=
[];B.prototype.drawGraph.apply(this);var c=this,f=this.areaPath,C=this.options,H=[["area","highcharts-area",this.color,C.fillColor]];this.zones.forEach(function(f,h){H.push(["zone-area-"+h,"highcharts-area highcharts-zone-area-"+h+" "+f.className,f.color||c.color,f.fillColor||C.fillColor])});H.forEach(function(v){var h=v[0],n=c[h],q=n?"animate":"attr",g={};n?(n.endX=c.preventGraphAnimation?null:f.xMap,n.animate({d:f})):(g.zIndex=0,n=c[h]=c.chart.renderer.path(f).addClass(v[1]).add(c.group),n.isArea=
!0);c.chart.styledMode||(g.fill=G(v[3],z(v[2]).setOpacity(G(C.fillOpacity,.75)).get()));n[q](g);n.startX=f.xMap;n.shiftUnit=C.step?2:1})},drawLegendSymbol:c.LegendSymbolMixin.drawRectangle});""});M(I,"parts/SplineSeries.js",[I["parts/Globals.js"],I["parts/Utilities.js"]],function(c,f){var F=f.pick;c=c.seriesType;c("spline","line",{},{getPointSpline:function(c,f,B){var t=f.plotX,v=f.plotY,C=c[B-1];B=c[B+1];if(C&&!C.isNull&&!1!==C.doCurve&&!f.isCliff&&B&&!B.isNull&&!1!==B.doCurve&&!f.isCliff){c=C.plotY;
var z=B.plotX;B=B.plotY;var y=0;var h=(1.5*t+C.plotX)/2.5;var n=(1.5*v+c)/2.5;z=(1.5*t+z)/2.5;var q=(1.5*v+B)/2.5;z!==h&&(y=(q-n)*(z-t)/(z-h)+v-q);n+=y;q+=y;n>c&&n>v?(n=Math.max(c,v),q=2*v-n):n<c&&n<v&&(n=Math.min(c,v),q=2*v-n);q>B&&q>v?(q=Math.max(B,v),n=2*v-q):q<B&&q<v&&(q=Math.min(B,v),n=2*v-q);f.rightContX=z;f.rightContY=q}f=["C",F(C.rightContX,C.plotX),F(C.rightContY,C.plotY),F(h,t),F(n,v),t,v];C.rightContX=C.rightContY=null;return f}});""});M(I,"parts/AreaSplineSeries.js",[I["parts/Globals.js"]],
function(c){var f=c.seriesTypes.area.prototype,F=c.seriesType;F("areaspline","spline",c.defaultPlotOptions.area,{getStackPoints:f.getStackPoints,getGraphPath:f.getGraphPath,drawGraph:f.drawGraph,drawLegendSymbol:c.LegendSymbolMixin.drawRectangle});""});M(I,"parts/ColumnSeries.js",[I["parts/Globals.js"],I["parts/Utilities.js"]],function(c,f){var F=f.defined,G=f.extend,z=f.isNumber,B=f.pick,t=c.animObject,v=c.color,C=c.merge,H=c.Series;f=c.seriesType;var y=c.svg;f("column","line",{borderRadius:0,crisp:!0,
groupPadding:.2,marker:null,pointPadding:.1,minPointLength:0,cropThreshold:50,pointRange:null,states:{hover:{halo:!1,brightness:.1},select:{color:"#cccccc",borderColor:"#000000"}},dataLabels:{align:null,verticalAlign:null,y:null},softThreshold:!1,startFromThreshold:!0,stickyTracking:!1,tooltip:{distance:6},threshold:0,borderColor:"#ffffff"},{cropShoulder:0,directTouch:!0,trackerGroups:["group","dataLabelsGroup"],negStacks:!0,init:function(){H.prototype.init.apply(this,arguments);var c=this,f=c.chart;
f.hasRendered&&f.series.forEach(function(f){f.type===c.type&&(f.isDirty=!0)})},getColumnMetrics:function(){var c=this,f=c.options,q=c.xAxis,g=c.yAxis,b=q.options.reversedStacks;b=q.reversed&&!b||!q.reversed&&b;var a,d={},e=0;!1===f.grouping?e=1:c.chart.series.forEach(function(b){var f=b.yAxis,k=b.options;if(b.type===c.type&&(b.visible||!c.chart.options.chart.ignoreHiddenSeries)&&g.len===f.len&&g.pos===f.pos){if(k.stacking){a=b.stackKey;void 0===d[a]&&(d[a]=e++);var h=d[a]}else!1!==k.grouping&&(h=
e++);b.columnIndex=h}});var l=Math.min(Math.abs(q.transA)*(q.ordinalSlope||f.pointRange||q.closestPointRange||q.tickInterval||1),q.len),v=l*f.groupPadding,t=(l-2*v)/(e||1);f=Math.min(f.maxPointWidth||q.len,B(f.pointWidth,t*(1-2*f.pointPadding)));c.columnMetrics={width:f,offset:(t-f)/2+(v+((c.columnIndex||0)+(b?1:0))*t-l/2)*(b?-1:1)};return c.columnMetrics},crispCol:function(c,f,q,g){var b=this.chart,a=this.borderWidth,d=-(a%2?.5:0);a=a%2?.5:1;b.inverted&&b.renderer.isVML&&(a+=1);this.options.crisp&&
(q=Math.round(c+q)+d,c=Math.round(c)+d,q-=c);g=Math.round(f+g)+a;d=.5>=Math.abs(f)&&.5<g;f=Math.round(f)+a;g-=f;d&&g&&(--f,g+=1);return{x:c,y:f,width:q,height:g}},translate:function(){var c=this,f=c.chart,q=c.options,g=c.dense=2>c.closestPointRange*c.xAxis.transA;g=c.borderWidth=B(q.borderWidth,g?0:1);var b=c.yAxis,a=q.threshold,d=c.translatedThreshold=b.getThreshold(a),e=B(q.minPointLength,5),l=c.getColumnMetrics(),v=l.width,t=c.barW=Math.max(v,1+2*g),p=c.pointXOffset=l.offset,u=c.dataMin,k=c.dataMax;
f.inverted&&(d-=.5);q.pointPadding&&(t=Math.ceil(t));H.prototype.translate.apply(c);c.points.forEach(function(g){var h=B(g.yBottom,d),l=999+Math.abs(h),r=v;l=Math.min(Math.max(-l,g.plotY),b.len+l);var m=g.plotX+p,n=t,q=Math.min(l,h),y=Math.max(l,h)-q;if(e&&Math.abs(y)<e){y=e;var E=!b.reversed&&!g.negative||b.reversed&&g.negative;g.y===a&&c.dataMax<=a&&b.min<a&&u!==k&&(E=!E);q=Math.abs(q-d)>e?h-e:d-(E?e:0)}F(g.options.pointWidth)&&(r=n=Math.ceil(g.options.pointWidth),m-=Math.round((r-v)/2));g.barX=
m;g.pointWidth=r;g.tooltipPos=f.inverted?[b.len+b.pos-f.plotLeft-l,c.xAxis.len-m-n/2,y]:[m+n/2,l+b.pos-f.plotTop,y];g.shapeType=c.pointClass.prototype.shapeType||"rect";g.shapeArgs=c.crispCol.apply(c,g.isNull?[m,d,n,0]:[m,q,n,y])})},getSymbol:c.noop,drawLegendSymbol:c.LegendSymbolMixin.drawRectangle,drawGraph:function(){this.group[this.dense?"addClass":"removeClass"]("highcharts-dense-data")},pointAttribs:function(c,f){var h=this.options,g=this.pointAttrToOptions||{};var b=g.stroke||"borderColor";
var a=g["stroke-width"]||"borderWidth",d=c&&c.color||this.color,e=c&&c[b]||h[b]||this.color||d,l=c&&c[a]||h[a]||this[a]||0;g=c&&c.options.dashStyle||h.dashStyle;var n=B(h.opacity,1);if(c&&this.zones.length){var t=c.getZone();d=c.options.color||t&&(t.color||c.nonZonedColor)||this.color;t&&(e=t.borderColor||e,g=t.dashStyle||g,l=t.borderWidth||l)}f&&(c=C(h.states[f],c.options.states&&c.options.states[f]||{}),f=c.brightness,d=c.color||void 0!==f&&v(d).brighten(c.brightness).get()||d,e=c[b]||e,l=c[a]||
l,g=c.dashStyle||g,n=B(c.opacity,n));b={fill:d,stroke:e,"stroke-width":l,opacity:n};g&&(b.dashstyle=g);return b},drawPoints:function(){var c=this,f=this.chart,q=c.options,g=f.renderer,b=q.animationLimit||250,a;c.points.forEach(function(d){var e=d.graphic,l=e&&f.pointCount<b?"animate":"attr";if(z(d.plotY)&&null!==d.y){a=d.shapeArgs;e&&d.hasNewShapeType()&&(e=e.destroy());if(e)e[l](C(a));else d.graphic=e=g[d.shapeType](a).add(d.group||c.group);if(q.borderRadius)e[l]({r:q.borderRadius});f.styledMode||
e[l](c.pointAttribs(d,d.selected&&"select")).shadow(!1!==d.allowShadow&&q.shadow,null,q.stacking&&!q.borderRadius);e.addClass(d.getClassName(),!0)}else e&&(d.graphic=e.destroy())})},animate:function(c){var f=this,h=this.yAxis,g=f.options,b=this.chart.inverted,a={},d=b?"translateX":"translateY";if(y)if(c)a.scaleY=.001,c=Math.min(h.pos+h.len,Math.max(h.pos,h.toPixels(g.threshold))),b?a.translateX=c-h.len:a.translateY=c,f.clipBox&&f.setClip(),f.group.attr(a);else{var e=f.group.attr(d);f.group.animate({scaleY:1},
G(t(f.options.animation),{step:function(b,c){a[d]=e+c.pos*(h.pos-e);f.group.attr(a)}}));f.animate=null}},remove:function(){var c=this,f=c.chart;f.hasRendered&&f.series.forEach(function(f){f.type===c.type&&(f.isDirty=!0)});H.prototype.remove.apply(c,arguments)}});""});M(I,"parts/BarSeries.js",[I["parts/Globals.js"]],function(c){c=c.seriesType;c("bar","column",null,{inverted:!0});""});M(I,"parts/ScatterSeries.js",[I["parts/Globals.js"]],function(c){var f=c.Series,F=c.seriesType;F("scatter","line",{lineWidth:0,
findNearestPointBy:"xy",jitter:{x:0,y:0},marker:{enabled:!0},tooltip:{headerFormat:'<span style="color:{point.color}">\u25cf</span> <span style="font-size: 10px"> {series.name}</span><br/>',pointFormat:"x: <b>{point.x}</b><br/>y: <b>{point.y}</b><br/>"}},{sorted:!1,requireSorting:!1,noSharedTooltip:!0,trackerGroups:["group","markerGroup","dataLabelsGroup"],takeOrdinalPosition:!1,drawGraph:function(){this.options.lineWidth&&f.prototype.drawGraph.call(this)},applyJitter:function(){var c=this,f=this.options.jitter,
B=this.points.length;f&&this.points.forEach(function(t,v){["x","y"].forEach(function(C,z){var y="plot"+C.toUpperCase();if(f[C]&&!t.isNull){var h=c[C+"Axis"];var n=f[C]*h.transA;if(h&&!h.isLog){var q=Math.max(0,t[y]-n);h=Math.min(h.len,t[y]+n);z=1E4*Math.sin(v+z*B);t[y]=q+(h-q)*(z-Math.floor(z));"x"===C&&(t.clientX=t.plotX)}}})})}});c.addEvent(f,"afterTranslate",function(){this.applyJitter&&this.applyJitter()});""});M(I,"mixins/centered-series.js",[I["parts/Globals.js"],I["parts/Utilities.js"]],function(c,
f){var F=f.isNumber,G=f.pick,z=c.deg2rad,B=c.relativeLength;c.CenteredSeriesMixin={getCenter:function(){var c=this.options,f=this.chart,C=2*(c.slicedOffset||0),z=f.plotWidth-2*C;f=f.plotHeight-2*C;var y=c.center;y=[G(y[0],"50%"),G(y[1],"50%"),c.size||"100%",c.innerSize||0];var h=Math.min(z,f),n;for(n=0;4>n;++n){var q=y[n];c=2>n||2===n&&/%$/.test(q);y[n]=B(q,[z,f,h,y[2]][n])+(c?C:0)}y[3]>y[2]&&(y[3]=y[2]);return y},getStartAndEndRadians:function(c,f){c=F(c)?c:0;f=F(f)&&f>c&&360>f-c?f:c+360;return{start:z*
(c+-90),end:z*(f+-90)}}}});M(I,"parts/PieSeries.js",[I["parts/Globals.js"],I["parts/Utilities.js"]],function(c,f){var F=f.defined,G=f.isNumber,z=f.pick,B=f.setAnimation,t=c.addEvent;f=c.CenteredSeriesMixin;var v=f.getStartAndEndRadians,C=c.merge,H=c.noop,y=c.Point,h=c.Series,n=c.seriesType,q=c.fireEvent;n("pie","line",{center:[null,null],clip:!1,colorByPoint:!0,dataLabels:{allowOverlap:!0,connectorPadding:5,distance:30,enabled:!0,formatter:function(){return this.point.isNull?void 0:this.point.name},
softConnector:!0,x:0,connectorShape:"fixedOffset",crookDistance:"70%"},fillColor:void 0,ignoreHiddenPoint:!0,inactiveOtherPoints:!0,legendType:"point",marker:null,size:null,showInLegend:!1,slicedOffset:10,stickyTracking:!1,tooltip:{followPointer:!0},borderColor:"#ffffff",borderWidth:1,lineWidth:void 0,states:{hover:{brightness:.1}}},{isCartesian:!1,requireSorting:!1,directTouch:!0,noSharedTooltip:!0,trackerGroups:["group","dataLabelsGroup"],axisTypes:[],pointAttribs:c.seriesTypes.column.prototype.pointAttribs,
animate:function(c){var b=this,a=b.points,d=b.startAngleRad;c||(a.forEach(function(a){var c=a.graphic,e=a.shapeArgs;c&&(c.attr({r:a.startR||b.center[3]/2,start:d,end:d}),c.animate({r:e.r,start:e.start,end:e.end},b.options.animation))}),b.animate=null)},hasData:function(){return!!this.processedXData.length},updateTotals:function(){var c,b=0,a=this.points,d=a.length,e=this.options.ignoreHiddenPoint;for(c=0;c<d;c++){var f=a[c];b+=e&&!f.visible?0:f.isNull?0:f.y}this.total=b;for(c=0;c<d;c++)f=a[c],f.percentage=
0<b&&(f.visible||!e)?f.y/b*100:0,f.total=b},generatePoints:function(){h.prototype.generatePoints.call(this);this.updateTotals()},getX:function(c,b,a){var d=this.center,e=this.radii?this.radii[a.index]:d[2]/2;return d[0]+(b?-1:1)*Math.cos(Math.asin(Math.max(Math.min((c-d[1])/(e+a.labelDistance),1),-1)))*(e+a.labelDistance)+(0<a.labelDistance?(b?-1:1)*this.options.dataLabels.padding:0)},translate:function(g){this.generatePoints();var b=0,a=this.options,d=a.slicedOffset,e=d+(a.borderWidth||0),f=v(a.startAngle,
a.endAngle),h=this.startAngleRad=f.start;f=(this.endAngleRad=f.end)-h;var n=this.points,p=a.dataLabels.distance;a=a.ignoreHiddenPoint;var u,k=n.length;g||(this.center=g=this.getCenter());for(u=0;u<k;u++){var r=n[u];var x=h+b*f;if(!a||r.visible)b+=r.percentage/100;var A=h+b*f;r.shapeType="arc";r.shapeArgs={x:g[0],y:g[1],r:g[2]/2,innerR:g[3]/2,start:Math.round(1E3*x)/1E3,end:Math.round(1E3*A)/1E3};r.labelDistance=z(r.options.dataLabels&&r.options.dataLabels.distance,p);r.labelDistance=c.relativeLength(r.labelDistance,
r.shapeArgs.r);this.maxLabelDistance=Math.max(this.maxLabelDistance||0,r.labelDistance);A=(A+x)/2;A>1.5*Math.PI?A-=2*Math.PI:A<-Math.PI/2&&(A+=2*Math.PI);r.slicedTranslation={translateX:Math.round(Math.cos(A)*d),translateY:Math.round(Math.sin(A)*d)};var w=Math.cos(A)*g[2]/2;var m=Math.sin(A)*g[2]/2;r.tooltipPos=[g[0]+.7*w,g[1]+.7*m];r.half=A<-Math.PI/2||A>Math.PI/2?1:0;r.angle=A;x=Math.min(e,r.labelDistance/5);r.labelPosition={natural:{x:g[0]+w+Math.cos(A)*r.labelDistance,y:g[1]+m+Math.sin(A)*r.labelDistance},
"final":{},alignment:0>r.labelDistance?"center":r.half?"right":"left",connectorPosition:{breakAt:{x:g[0]+w+Math.cos(A)*x,y:g[1]+m+Math.sin(A)*x},touchingSliceAt:{x:g[0]+w,y:g[1]+m}}}}q(this,"afterTranslate")},drawEmpty:function(){var c=this.options;if(0===this.total){var b=this.center[0];var a=this.center[1];this.graph||(this.graph=this.chart.renderer.circle(b,a,0).addClass("highcharts-graph").add(this.group));this.graph.animate({"stroke-width":c.borderWidth,cx:b,cy:a,r:this.center[2]/2,fill:c.fillColor||
"none",stroke:c.color||"#cccccc"})}else this.graph&&(this.graph=this.graph.destroy())},redrawPoints:function(){var c=this,b=c.chart,a=b.renderer,d,e,f,h,n=c.options.shadow;this.drawEmpty();!n||c.shadowGroup||b.styledMode||(c.shadowGroup=a.g("shadow").attr({zIndex:-1}).add(c.group));c.points.forEach(function(g){var l={};e=g.graphic;if(!g.isNull&&e){h=g.shapeArgs;d=g.getTranslate();if(!b.styledMode){var k=g.shadowGroup;n&&!k&&(k=g.shadowGroup=a.g("shadow").add(c.shadowGroup));k&&k.attr(d);f=c.pointAttribs(g,
g.selected&&"select")}g.delayedRendering?(e.setRadialReference(c.center).attr(h).attr(d),b.styledMode||e.attr(f).attr({"stroke-linejoin":"round"}).shadow(n,k),g.delayedRendering=!1):(e.setRadialReference(c.center),b.styledMode||C(!0,l,f),C(!0,l,h,d),e.animate(l));e.attr({visibility:g.visible?"inherit":"hidden"});e.addClass(g.getClassName())}else e&&(g.graphic=e.destroy())})},drawPoints:function(){var c=this.chart.renderer;this.points.forEach(function(b){b.graphic||(b.graphic=c[b.shapeType](b.shapeArgs).add(b.series.group),
b.delayedRendering=!0)})},searchPoint:H,sortByAngle:function(c,b){c.sort(function(a,d){return void 0!==a.angle&&(d.angle-a.angle)*b})},drawLegendSymbol:c.LegendSymbolMixin.drawRectangle,getCenter:f.getCenter,getSymbol:H,drawGraph:null},{init:function(){y.prototype.init.apply(this,arguments);var c=this;c.name=z(c.name,"Slice");var b=function(a){c.slice("select"===a.type)};t(c,"select",b);t(c,"unselect",b);return c},isValid:function(){return G(this.y)&&0<=this.y},setVisible:function(c,b){var a=this,
d=a.series,e=d.chart,f=d.options.ignoreHiddenPoint;b=z(b,f);c!==a.visible&&(a.visible=a.options.visible=c=void 0===c?!a.visible:c,d.options.data[d.data.indexOf(a)]=a.options,["graphic","dataLabel","connector","shadowGroup"].forEach(function(b){if(a[b])a[b][c?"show":"hide"](!0)}),a.legendItem&&e.legend.colorizeItem(a,c),c||"hover"!==a.state||a.setState(""),f&&(d.isDirty=!0),b&&e.redraw())},slice:function(c,b,a){var d=this.series;B(a,d.chart);z(b,!0);this.sliced=this.options.sliced=F(c)?c:!this.sliced;
d.options.data[d.data.indexOf(this)]=this.options;this.graphic.animate(this.getTranslate());this.shadowGroup&&this.shadowGroup.animate(this.getTranslate())},getTranslate:function(){return this.sliced?this.slicedTranslation:{translateX:0,translateY:0}},haloPath:function(c){var b=this.shapeArgs;return this.sliced||!this.visible?[]:this.series.chart.renderer.symbols.arc(b.x,b.y,b.r+c,b.r+c,{innerR:b.r-1,start:b.start,end:b.end})},connectorShapes:{fixedOffset:function(c,b,a){var d=b.breakAt;b=b.touchingSliceAt;
return["M",c.x,c.y].concat(a.softConnector?["C",c.x+("left"===c.alignment?-5:5),c.y,2*d.x-b.x,2*d.y-b.y,d.x,d.y]:["L",d.x,d.y]).concat(["L",b.x,b.y])},straight:function(c,b){b=b.touchingSliceAt;return["M",c.x,c.y,"L",b.x,b.y]},crookedLine:function(f,b,a){b=b.touchingSliceAt;var d=this.series,e=d.center[0],g=d.chart.plotWidth,h=d.chart.plotLeft;d=f.alignment;var n=this.shapeArgs.r;a=c.relativeLength(a.crookDistance,1);a="left"===d?e+n+(g+h-e-n)*(1-a):h+(e-n)*a;e=["L",a,f.y];if("left"===d?a>f.x||a<
b.x:a<f.x||a>b.x)e=[];return["M",f.x,f.y].concat(e).concat(["L",b.x,b.y])}},getConnectorPath:function(){var c=this.labelPosition,b=this.series.options.dataLabels,a=b.connectorShape,d=this.connectorShapes;d[a]&&(a=d[a]);return a.call(this,{x:c.final.x,y:c.final.y,alignment:c.alignment},c.connectorPosition,b)}});""});M(I,"parts/DataLabels.js",[I["parts/Globals.js"],I["parts/Utilities.js"]],function(c,f){var F=f.arrayMax,G=f.defined,z=f.extend,B=f.isArray,t=f.objectEach,v=f.pick,C=f.splat,H=c.format,
y=c.merge;f=c.noop;var h=c.relativeLength,n=c.Series,q=c.seriesTypes,g=c.stableSort;c.distribute=function(b,a,d){function e(a,b){return a.target-b.target}var f,h=!0,n=b,p=[];var u=0;var k=n.reducedLen||a;for(f=b.length;f--;)u+=b[f].size;if(u>k){g(b,function(a,b){return(b.rank||0)-(a.rank||0)});for(u=f=0;u<=k;)u+=b[f].size,f++;p=b.splice(f-1,b.length)}g(b,e);for(b=b.map(function(a){return{size:a.size,targets:[a.target],align:v(a.align,.5)}});h;){for(f=b.length;f--;)h=b[f],u=(Math.min.apply(0,h.targets)+
Math.max.apply(0,h.targets))/2,h.pos=Math.min(Math.max(0,u-h.size*h.align),a-h.size);f=b.length;for(h=!1;f--;)0<f&&b[f-1].pos+b[f-1].size>b[f].pos&&(b[f-1].size+=b[f].size,b[f-1].targets=b[f-1].targets.concat(b[f].targets),b[f-1].align=.5,b[f-1].pos+b[f-1].size>a&&(b[f-1].pos=a-b[f-1].size),b.splice(f,1),h=!0)}n.push.apply(n,p);f=0;b.some(function(b){var e=0;if(b.targets.some(function(){n[f].pos=b.pos+e;if(Math.abs(n[f].pos-n[f].target)>d)return n.slice(0,f+1).forEach(function(a){delete a.pos}),n.reducedLen=
(n.reducedLen||a)-.1*a,n.reducedLen>.1*a&&c.distribute(n,a,d),!0;e+=n[f].size;f++}))return!0});g(n,e)};n.prototype.drawDataLabels=function(){function b(a,b){var d=b.filter;return d?(b=d.operator,a=a[d.property],d=d.value,">"===b&&a>d||"<"===b&&a<d||">="===b&&a>=d||"<="===b&&a<=d||"=="===b&&a==d||"==="===b&&a===d?!0:!1):!0}function a(a,b){var d=[],c;if(B(a)&&!B(b))d=a.map(function(a){return y(a,b)});else if(B(b)&&!B(a))d=b.map(function(b){return y(a,b)});else if(B(a)||B(b))for(c=Math.max(a.length,
b.length);c--;)d[c]=y(a[c],b[c]);else d=y(a,b);return d}var d=this,e=d.chart,f=d.options,g=f.dataLabels,h=d.points,p,n=d.hasRendered||0,k=c.animObject(f.animation).duration,r=Math.min(k,200),q=!e.renderer.forExport&&v(g.defer,0<r),A=e.renderer;g=a(a(e.options.plotOptions&&e.options.plotOptions.series&&e.options.plotOptions.series.dataLabels,e.options.plotOptions&&e.options.plotOptions[d.type]&&e.options.plotOptions[d.type].dataLabels),g);c.fireEvent(this,"drawDataLabels");if(B(g)||g.enabled||d._hasPointLabels){var w=
d.plotGroup("dataLabelsGroup","data-labels",q&&!n?"hidden":"inherit",g.zIndex||6);q&&(w.attr({opacity:+n}),n||setTimeout(function(){var a=d.dataLabelsGroup;a&&(d.visible&&w.show(!0),a[f.animation?"animate":"attr"]({opacity:1},{duration:r}))},k-r));h.forEach(function(c){p=C(a(g,c.dlOptions||c.options&&c.options.dataLabels));p.forEach(function(a,g){var k=a.enabled&&(!c.isNull||c.dataLabelOnNull)&&b(c,a),h=c.dataLabels?c.dataLabels[g]:c.dataLabel,l=c.connectors?c.connectors[g]:c.connector,p=v(a.distance,
c.labelDistance),m=!h;if(k){var r=c.getLabelConfig();var n=v(a[c.formatPrefix+"Format"],a.format);r=G(n)?H(n,r,e.time):(a[c.formatPrefix+"Formatter"]||a.formatter).call(r,a);n=a.style;var u=a.rotation;e.styledMode||(n.color=v(a.color,n.color,d.color,"#000000"),"contrast"===n.color&&(c.contrastColor=A.getContrast(c.color||d.color),n.color=!G(p)&&a.inside||0>p||f.stacking?c.contrastColor:"#000000"),f.cursor&&(n.cursor=f.cursor));var q={r:a.borderRadius||0,rotation:u,padding:a.padding,zIndex:1};e.styledMode||
(q.fill=a.backgroundColor,q.stroke=a.borderColor,q["stroke-width"]=a.borderWidth);t(q,function(a,b){void 0===a&&delete q[b]})}!h||k&&G(r)?k&&G(r)&&(h?q.text=r:(c.dataLabels=c.dataLabels||[],h=c.dataLabels[g]=u?A.text(r,0,-9999).addClass("highcharts-data-label"):A.label(r,0,-9999,a.shape,null,null,a.useHTML,null,"data-label"),g||(c.dataLabel=h),h.addClass(" highcharts-data-label-color-"+c.colorIndex+" "+(a.className||"")+(a.useHTML?" highcharts-tracker":""))),h.options=a,h.attr(q),e.styledMode||h.css(n).shadow(a.shadow),
h.added||h.add(w),a.textPath&&!a.useHTML&&h.setTextPath(c.getDataLabelPath&&c.getDataLabelPath(h)||c.graphic,a.textPath),d.alignDataLabel(c,h,a,null,m)):(c.dataLabel=c.dataLabel&&c.dataLabel.destroy(),c.dataLabels&&(1===c.dataLabels.length?delete c.dataLabels:delete c.dataLabels[g]),g||delete c.dataLabel,l&&(c.connector=c.connector.destroy(),c.connectors&&(1===c.connectors.length?delete c.connectors:delete c.connectors[g])))})})}c.fireEvent(this,"afterDrawDataLabels")};n.prototype.alignDataLabel=
function(b,a,d,c,f){var e=this.chart,g=this.isCartesian&&e.inverted,h=v(b.dlBox&&b.dlBox.centerX,b.plotX,-9999),l=v(b.plotY,-9999),k=a.getBBox(),n=d.rotation,q=d.align,A=this.visible&&(b.series.forceDL||e.isInsidePlot(h,Math.round(l),g)||c&&e.isInsidePlot(h,g?c.x+1:c.y+c.height-1,g)),w="justify"===v(d.overflow,"justify");if(A){var m=e.renderer.fontMetrics(e.styledMode?void 0:d.style.fontSize,a).b;c=z({x:g?this.yAxis.len-l:h,y:Math.round(g?this.xAxis.len-h:l),width:0,height:0},c);z(d,{width:k.width,
height:k.height});n?(w=!1,h=e.renderer.rotCorr(m,n),h={x:c.x+d.x+c.width/2+h.x,y:c.y+d.y+{top:0,middle:.5,bottom:1}[d.verticalAlign]*c.height},a[f?"attr":"animate"](h).attr({align:q}),l=(n+720)%360,l=180<l&&360>l,"left"===q?h.y-=l?k.height:0:"center"===q?(h.x-=k.width/2,h.y-=k.height/2):"right"===q&&(h.x-=k.width,h.y-=l?0:k.height),a.placed=!0,a.alignAttr=h):(a.align(d,null,c),h=a.alignAttr);w&&0<=c.height?this.justifyDataLabel(a,d,h,k,c,f):v(d.crop,!0)&&(A=e.isInsidePlot(h.x,h.y)&&e.isInsidePlot(h.x+
k.width,h.y+k.height));if(d.shape&&!n)a[f?"attr":"animate"]({anchorX:g?e.plotWidth-b.plotY:b.plotX,anchorY:g?e.plotHeight-b.plotX:b.plotY})}A||(a.hide(!0),a.placed=!1)};n.prototype.justifyDataLabel=function(b,a,d,c,f,g){var e=this.chart,h=a.align,l=a.verticalAlign,k=b.box?0:b.padding||0;var n=d.x+k;if(0>n){"right"===h?(a.align="left",a.inside=!0):a.x=-n;var q=!0}n=d.x+c.width-k;n>e.plotWidth&&("left"===h?(a.align="right",a.inside=!0):a.x=e.plotWidth-n,q=!0);n=d.y+k;0>n&&("bottom"===l?(a.verticalAlign=
"top",a.inside=!0):a.y=-n,q=!0);n=d.y+c.height-k;n>e.plotHeight&&("top"===l?(a.verticalAlign="bottom",a.inside=!0):a.y=e.plotHeight-n,q=!0);q&&(b.placed=!g,b.align(a,null,f));return q};q.pie&&(q.pie.prototype.dataLabelPositioners={radialDistributionY:function(b){return b.top+b.distributeBox.pos},radialDistributionX:function(b,a,d,c){return b.getX(d<a.top+2||d>a.bottom-2?c:d,a.half,a)},justify:function(b,a,d){return d[0]+(b.half?-1:1)*(a+b.labelDistance)},alignToPlotEdges:function(b,a,d,c){b=b.getBBox().width;
return a?b+c:d-b-c},alignToConnectors:function(b,a,d,c){var e=0,f;b.forEach(function(a){f=a.dataLabel.getBBox().width;f>e&&(e=f)});return a?e+c:d-e-c}},q.pie.prototype.drawDataLabels=function(){var b=this,a=b.data,d,e=b.chart,f=b.options.dataLabels,g=f.connectorPadding,h,p=e.plotWidth,u=e.plotHeight,k=e.plotLeft,r=Math.round(e.chartWidth/3),q,A=b.center,w=A[2]/2,m=A[1],t,z,C,B,H=[[],[]],I,D,N,M,R=[0,0,0,0],P=b.dataLabelPositioners,W;b.visible&&(f.enabled||b._hasPointLabels)&&(a.forEach(function(a){a.dataLabel&&
a.visible&&a.dataLabel.shortened&&(a.dataLabel.attr({width:"auto"}).css({width:"auto",textOverflow:"clip"}),a.dataLabel.shortened=!1)}),n.prototype.drawDataLabels.apply(b),a.forEach(function(a){a.dataLabel&&(a.visible?(H[a.half].push(a),a.dataLabel._pos=null,!G(f.style.width)&&!G(a.options.dataLabels&&a.options.dataLabels.style&&a.options.dataLabels.style.width)&&a.dataLabel.getBBox().width>r&&(a.dataLabel.css({width:.7*r}),a.dataLabel.shortened=!0)):(a.dataLabel=a.dataLabel.destroy(),a.dataLabels&&
1===a.dataLabels.length&&delete a.dataLabels))}),H.forEach(function(a,h){var l=a.length,n=[],r;if(l){b.sortByAngle(a,h-.5);if(0<b.maxLabelDistance){var q=Math.max(0,m-w-b.maxLabelDistance);var x=Math.min(m+w+b.maxLabelDistance,e.plotHeight);a.forEach(function(a){0<a.labelDistance&&a.dataLabel&&(a.top=Math.max(0,m-w-a.labelDistance),a.bottom=Math.min(m+w+a.labelDistance,e.plotHeight),r=a.dataLabel.getBBox().height||21,a.distributeBox={target:a.labelPosition.natural.y-a.top+r/2,size:r,rank:a.y},n.push(a.distributeBox))});
q=x+r-q;c.distribute(n,q,q/5)}for(M=0;M<l;M++){d=a[M];C=d.labelPosition;t=d.dataLabel;N=!1===d.visible?"hidden":"inherit";D=q=C.natural.y;n&&G(d.distributeBox)&&(void 0===d.distributeBox.pos?N="hidden":(B=d.distributeBox.size,D=P.radialDistributionY(d)));delete d.positionIndex;if(f.justify)I=P.justify(d,w,A);else switch(f.alignTo){case "connectors":I=P.alignToConnectors(a,h,p,k);break;case "plotEdges":I=P.alignToPlotEdges(t,h,p,k);break;default:I=P.radialDistributionX(b,d,D,q)}t._attr={visibility:N,
align:C.alignment};t._pos={x:I+f.x+({left:g,right:-g}[C.alignment]||0),y:D+f.y-10};C.final.x=I;C.final.y=D;v(f.crop,!0)&&(z=t.getBBox().width,q=null,I-z<g&&1===h?(q=Math.round(z-I+g),R[3]=Math.max(q,R[3])):I+z>p-g&&0===h&&(q=Math.round(I+z-p+g),R[1]=Math.max(q,R[1])),0>D-B/2?R[0]=Math.max(Math.round(-D+B/2),R[0]):D+B/2>u&&(R[2]=Math.max(Math.round(D+B/2-u),R[2])),t.sideOverflow=q)}}}),0===F(R)||this.verifyDataLabelOverflow(R))&&(this.placeDataLabels(),this.points.forEach(function(a){W=y(f,a.options.dataLabels);
if(h=v(W.connectorWidth,1)){var d;q=a.connector;if((t=a.dataLabel)&&t._pos&&a.visible&&0<a.labelDistance){N=t._attr.visibility;if(d=!q)a.connector=q=e.renderer.path().addClass("highcharts-data-label-connector  highcharts-color-"+a.colorIndex+(a.className?" "+a.className:"")).add(b.dataLabelsGroup),e.styledMode||q.attr({"stroke-width":h,stroke:W.connectorColor||a.color||"#666666"});q[d?"attr":"animate"]({d:a.getConnectorPath()});q.attr("visibility",N)}else q&&(a.connector=q.destroy())}}))},q.pie.prototype.placeDataLabels=
function(){this.points.forEach(function(b){var a=b.dataLabel,d;a&&b.visible&&((d=a._pos)?(a.sideOverflow&&(a._attr.width=Math.max(a.getBBox().width-a.sideOverflow,0),a.css({width:a._attr.width+"px",textOverflow:(this.options.dataLabels.style||{}).textOverflow||"ellipsis"}),a.shortened=!0),a.attr(a._attr),a[a.moved?"animate":"attr"](d),a.moved=!0):a&&a.attr({y:-9999}));delete b.distributeBox},this)},q.pie.prototype.alignDataLabel=f,q.pie.prototype.verifyDataLabelOverflow=function(b){var a=this.center,
d=this.options,c=d.center,f=d.minSize||80,g=null!==d.size;if(!g){if(null!==c[0])var n=Math.max(a[2]-Math.max(b[1],b[3]),f);else n=Math.max(a[2]-b[1]-b[3],f),a[0]+=(b[3]-b[1])/2;null!==c[1]?n=Math.max(Math.min(n,a[2]-Math.max(b[0],b[2])),f):(n=Math.max(Math.min(n,a[2]-b[0]-b[2]),f),a[1]+=(b[0]-b[2])/2);n<a[2]?(a[2]=n,a[3]=Math.min(h(d.innerSize||0,n),n),this.translate(a),this.drawDataLabels&&this.drawDataLabels()):g=!0}return g});q.column&&(q.column.prototype.alignDataLabel=function(b,a,d,c,f){var e=
this.chart.inverted,g=b.series,h=b.dlBox||b.shapeArgs,l=v(b.below,b.plotY>v(this.translatedThreshold,g.yAxis.len)),k=v(d.inside,!!this.options.stacking);h&&(c=y(h),0>c.y&&(c.height+=c.y,c.y=0),h=c.y+c.height-g.yAxis.len,0<h&&(c.height-=h),e&&(c={x:g.yAxis.len-c.y-c.height,y:g.xAxis.len-c.x-c.width,width:c.height,height:c.width}),k||(e?(c.x+=l?0:c.width,c.width=0):(c.y+=l?c.height:0,c.height=0)));d.align=v(d.align,!e||k?"center":l?"right":"left");d.verticalAlign=v(d.verticalAlign,e||k?"middle":l?"top":
"bottom");n.prototype.alignDataLabel.call(this,b,a,d,c,f);d.inside&&b.contrastColor&&a.css({color:b.contrastColor})})});M(I,"modules/overlapping-datalabels.src.js",[I["parts/Globals.js"],I["parts/Utilities.js"]],function(c,f){var F=f.isArray,G=f.objectEach,z=f.pick;f=c.Chart;var B=c.addEvent,t=c.fireEvent;B(f,"render",function(){var c=[];(this.labelCollectors||[]).forEach(function(f){c=c.concat(f())});(this.yAxis||[]).forEach(function(f){f.options.stackLabels&&!f.options.stackLabels.allowOverlap&&
G(f.stacks,function(f){G(f,function(f){c.push(f.label)})})});(this.series||[]).forEach(function(f){var v=f.options.dataLabels;f.visible&&(!1!==v.enabled||f._hasPointLabels)&&f.points.forEach(function(f){f.visible&&(F(f.dataLabels)?f.dataLabels:f.dataLabel?[f.dataLabel]:[]).forEach(function(h){var n=h.options;h.labelrank=z(n.labelrank,f.labelrank,f.shapeArgs&&f.shapeArgs.height);n.allowOverlap||c.push(h)})})});this.hideOverlappingLabels(c)});f.prototype.hideOverlappingLabels=function(c){var f=this,
v=c.length,y=f.renderer,h,n,q;var g=function(a){var b=a.box?0:a.padding||0;var d=0;if(a&&(!a.alignAttr||a.placed)){var c=a.attr("x");var f=a.attr("y");c="number"===typeof c&&"number"===typeof f?{x:c,y:f}:a.alignAttr;f=a.parentGroup;a.width||(d=a.getBBox(),a.width=d.width,a.height=d.height,d=y.fontMetrics(null,a.element).h);return{x:c.x+(f.translateX||0)+b,y:c.y+(f.translateY||0)+b-d,width:a.width-2*b,height:a.height-2*b}}};for(n=0;n<v;n++)if(h=c[n])h.oldOpacity=h.opacity,h.newOpacity=1,h.absoluteBox=
g(h);c.sort(function(a,b){return(b.labelrank||0)-(a.labelrank||0)});for(n=0;n<v;n++){var b=(g=c[n])&&g.absoluteBox;for(h=n+1;h<v;++h){var a=(q=c[h])&&q.absoluteBox;!b||!a||g===q||0===g.newOpacity||0===q.newOpacity||a.x>b.x+b.width||a.x+a.width<b.x||a.y>b.y+b.height||a.y+a.height<b.y||((g.labelrank<q.labelrank?g:q).newOpacity=0)}}c.forEach(function(a){var b;if(a){var d=a.newOpacity;a.oldOpacity!==d&&(a.alignAttr&&a.placed?(d?a.show(!0):b=function(){a.hide(!0);a.placed=!1},a.alignAttr.opacity=d,a[a.isOld?
"animate":"attr"](a.alignAttr,null,b),t(f,"afterHideOverlappingLabels")):a.attr({opacity:d}));a.isOld=!0}})}});M(I,"parts/Interaction.js",[I["parts/Globals.js"],I["parts/Utilities.js"]],function(c,f){var F=f.defined,G=f.extend,z=f.isArray,B=f.isObject,t=f.objectEach,v=f.pick,C=c.addEvent;f=c.Chart;var H=c.createElement,y=c.css,h=c.defaultOptions,n=c.defaultPlotOptions,q=c.fireEvent,g=c.hasTouch,b=c.Legend,a=c.merge,d=c.Point,e=c.Series,l=c.seriesTypes,I=c.svg;var E=c.TrackerMixin={drawTrackerPoint:function(){var a=
this,b=a.chart,d=b.pointer,c=function(a){var b=d.getPointFromEvent(a);void 0!==b&&(d.isDirectTouch=!0,b.onMouseOver(a))},e;a.points.forEach(function(a){e=z(a.dataLabels)?a.dataLabels:a.dataLabel?[a.dataLabel]:[];a.graphic&&(a.graphic.element.point=a);e.forEach(function(b){b.div?b.div.point=a:b.element.point=a})});a._hasTracking||(a.trackerGroups.forEach(function(e){if(a[e]){a[e].addClass("highcharts-tracker").on("mouseover",c).on("mouseout",function(a){d.onTrackerMouseOut(a)});if(g)a[e].on("touchstart",
c);!b.styledMode&&a.options.cursor&&a[e].css(y).css({cursor:a.options.cursor})}}),a._hasTracking=!0);q(this,"afterDrawTracker")},drawTrackerGraph:function(){var a=this,b=a.options,d=b.trackByArea,c=[].concat(d?a.areaPath:a.graphPath),e=c.length,f=a.chart,h=f.pointer,l=f.renderer,n=f.options.tooltip.snap,v=a.tracker,t,y=function(){if(f.hoverSeries!==a)a.onMouseOver()},z="rgba(192,192,192,"+(I?.0001:.002)+")";if(e&&!d)for(t=e+1;t--;)"M"===c[t]&&c.splice(t+1,0,c[t+1]-n,c[t+2],"L"),(t&&"M"===c[t]||t===
e)&&c.splice(t,0,"L",c[t-2]+n,c[t-1]);v?v.attr({d:c}):a.graph&&(a.tracker=l.path(c).attr({visibility:a.visible?"visible":"hidden",zIndex:2}).addClass(d?"highcharts-tracker-area":"highcharts-tracker-line").add(a.group),f.styledMode||a.tracker.attr({"stroke-linejoin":"round",stroke:z,fill:d?z:"none","stroke-width":a.graph.strokeWidth()+(d?0:2*n)}),[a.tracker,a.markerGroup].forEach(function(a){a.addClass("highcharts-tracker").on("mouseover",y).on("mouseout",function(a){h.onTrackerMouseOut(a)});b.cursor&&
!f.styledMode&&a.css({cursor:b.cursor});if(g)a.on("touchstart",y)}));q(this,"afterDrawTracker")}};l.column&&(l.column.prototype.drawTracker=E.drawTrackerPoint);l.pie&&(l.pie.prototype.drawTracker=E.drawTrackerPoint);l.scatter&&(l.scatter.prototype.drawTracker=E.drawTrackerPoint);G(b.prototype,{setItemEvents:function(b,c,e){var f=this,g=f.chart.renderer.boxWrapper,k=b instanceof d,h="highcharts-legend-"+(k?"point":"series")+"-active",l=f.chart.styledMode;(e?c:b.legendGroup).on("mouseover",function(){b.visible&&
f.allItems.forEach(function(a){b!==a&&a.setState("inactive",!k)});b.setState("hover");b.visible&&g.addClass(h);l||c.css(f.options.itemHoverStyle)}).on("mouseout",function(){f.chart.styledMode||c.css(a(b.visible?f.itemStyle:f.itemHiddenStyle));f.allItems.forEach(function(a){b!==a&&a.setState("",!k)});g.removeClass(h);b.setState()}).on("click",function(a){var c=function(){b.setVisible&&b.setVisible();f.allItems.forEach(function(a){b!==a&&a.setState(b.visible?"inactive":"",!k)})};g.removeClass(h);a=
{browserEvent:a};b.firePointEvent?b.firePointEvent("legendItemClick",a,c):q(b,"legendItemClick",a,c)})},createCheckboxForItem:function(a){a.checkbox=H("input",{type:"checkbox",className:"highcharts-legend-checkbox",checked:a.selected,defaultChecked:a.selected},this.options.itemCheckboxStyle,this.chart.container);C(a.checkbox,"click",function(b){q(a.series||a,"checkboxClick",{checked:b.target.checked,item:a},function(){a.select()})})}});G(f.prototype,{showResetZoom:function(){function a(){b.zoomOut()}
var b=this,c=h.lang,d=b.options.chart.resetZoomButton,e=d.theme,f=e.states,g="chart"===d.relativeTo||"spaceBox"===d.relativeTo?null:"plotBox";q(this,"beforeShowResetZoom",null,function(){b.resetZoomButton=b.renderer.button(c.resetZoom,null,null,a,e,f&&f.hover).attr({align:d.position.align,title:c.resetZoomTitle}).addClass("highcharts-reset-zoom").add().align(d.position,!1,g)});q(this,"afterShowResetZoom")},zoomOut:function(){q(this,"selection",{resetSelection:!0},this.zoom)},zoom:function(a){var b=
this,c,d=b.pointer,e=!1,f=b.inverted?d.mouseDownX:d.mouseDownY;!a||a.resetSelection?(b.axes.forEach(function(a){c=a.zoom()}),d.initiated=!1):a.xAxis.concat(a.yAxis).forEach(function(a){var g=a.axis,k=b.inverted?g.left:g.top,h=b.inverted?k+g.width:k+g.height,l=g.isXAxis,m=!1;if(!l&&f>=k&&f<=h||l||!F(f))m=!0;d[l?"zoomX":"zoomY"]&&m&&(c=g.zoom(a.min,a.max),g.displayBtn&&(e=!0))});var g=b.resetZoomButton;e&&!g?b.showResetZoom():!e&&B(g)&&(b.resetZoomButton=g.destroy());c&&b.redraw(v(b.options.chart.animation,
a&&a.animation,100>b.pointCount))},pan:function(a,b){var c=this,d=c.hoverPoints,e;q(this,"pan",{originalEvent:a},function(){d&&d.forEach(function(a){a.setState()});("xy"===b?[1,0]:[1]).forEach(function(b){b=c[b?"xAxis":"yAxis"][0];var d=b.horiz,f=a[d?"chartX":"chartY"];d=d?"mouseDownX":"mouseDownY";var g=c[d],k=(b.pointRange||0)/2,h=b.reversed&&!c.inverted||!b.reversed&&c.inverted?-1:1,l=b.getExtremes(),p=b.toValue(g-f,!0)+k*h;h=b.toValue(g+b.len-f,!0)-k*h;var n=h<p;g=n?h:p;p=n?p:h;h=Math.min(l.dataMin,
k?l.min:b.toValue(b.toPixels(l.min)-b.minPixelPadding));k=Math.max(l.dataMax,k?l.max:b.toValue(b.toPixels(l.max)+b.minPixelPadding));n=h-g;0<n&&(p+=n,g=h);n=p-k;0<n&&(p=k,g-=n);b.series.length&&g!==l.min&&p!==l.max&&(b.setExtremes(g,p,!1,!1,{trigger:"pan"}),e=!0);c[d]=f});e&&c.redraw(!1);y(c.container,{cursor:"move"})})}});G(d.prototype,{select:function(a,b){var c=this,d=c.series,e=d.chart;this.selectedStaging=a=v(a,!c.selected);c.firePointEvent(a?"select":"unselect",{accumulate:b},function(){c.selected=
c.options.selected=a;d.options.data[d.data.indexOf(c)]=c.options;c.setState(a&&"select");b||e.getSelectedPoints().forEach(function(a){var b=a.series;a.selected&&a!==c&&(a.selected=a.options.selected=!1,b.options.data[b.data.indexOf(a)]=a.options,a.setState(e.hoverPoints&&b.options.inactiveOtherPoints?"inactive":""),a.firePointEvent("unselect"))})});delete this.selectedStaging},onMouseOver:function(a){var b=this.series.chart,c=b.pointer;a=a?c.normalize(a):c.getChartCoordinatesFromPoint(this,b.inverted);
c.runPointActions(a,this)},onMouseOut:function(){var a=this.series.chart;this.firePointEvent("mouseOut");this.series.options.inactiveOtherPoints||(a.hoverPoints||[]).forEach(function(a){a.setState()});a.hoverPoints=a.hoverPoint=null},importEvents:function(){if(!this.hasImportedEvents){var b=this,d=a(b.series.options.point,b.options).events;b.events=d;t(d,function(a,d){c.isFunction(a)&&C(b,d,a)});this.hasImportedEvents=!0}},setState:function(a,b){var c=this.series,d=this.state,e=c.options.states[a||
"normal"]||{},f=n[c.type].marker&&c.options.marker,g=f&&!1===f.enabled,h=f&&f.states&&f.states[a||"normal"]||{},l=!1===h.enabled,p=c.stateMarkerGraphic,u=this.marker||{},t=c.chart,y=c.halo,z,B=f&&c.markerAttribs;a=a||"";if(!(a===this.state&&!b||this.selected&&"select"!==a||!1===e.enabled||a&&(l||g&&!1===h.enabled)||a&&u.states&&u.states[a]&&!1===u.states[a].enabled)){this.state=a;B&&(z=c.markerAttribs(this,a));if(this.graphic){d&&this.graphic.removeClass("highcharts-point-"+d);a&&this.graphic.addClass("highcharts-point-"+
a);if(!t.styledMode){var C=c.pointAttribs(this,a);var H=v(t.options.chart.animation,e.animation);c.options.inactiveOtherPoints&&((this.dataLabels||[]).forEach(function(a){a&&a.animate({opacity:C.opacity},H)}),this.connector&&this.connector.animate({opacity:C.opacity},H));this.graphic.animate(C,H)}z&&this.graphic.animate(z,v(t.options.chart.animation,h.animation,f.animation));p&&p.hide()}else{if(a&&h){d=u.symbol||c.symbol;p&&p.currentSymbol!==d&&(p=p.destroy());if(z)if(p)p[b?"animate":"attr"]({x:z.x,
y:z.y});else d&&(c.stateMarkerGraphic=p=t.renderer.symbol(d,z.x,z.y,z.width,z.height).add(c.markerGroup),p.currentSymbol=d);!t.styledMode&&p&&p.attr(c.pointAttribs(this,a))}p&&(p[a&&this.isInside?"show":"hide"](),p.element.point=this)}a=e.halo;e=(p=this.graphic||p)&&p.visibility||"inherit";a&&a.size&&p&&"hidden"!==e?(y||(c.halo=y=t.renderer.path().add(p.parentGroup)),y.show()[b?"animate":"attr"]({d:this.haloPath(a.size)}),y.attr({"class":"highcharts-halo highcharts-color-"+v(this.colorIndex,c.colorIndex)+
(this.className?" "+this.className:""),visibility:e,zIndex:-1}),y.point=this,t.styledMode||y.attr(G({fill:this.color||c.color,"fill-opacity":a.opacity},a.attributes))):y&&y.point&&y.point.haloPath&&y.animate({d:y.point.haloPath(0)},null,y.hide);q(this,"afterSetState")}},haloPath:function(a){return this.series.chart.renderer.symbols.circle(Math.floor(this.plotX)-a,this.plotY-a,2*a,2*a)}});G(e.prototype,{onMouseOver:function(){var a=this.chart,b=a.hoverSeries;if(b&&b!==this)b.onMouseOut();this.options.events.mouseOver&&
q(this,"mouseOver");this.setState("hover");a.hoverSeries=this},onMouseOut:function(){var a=this.options,b=this.chart,c=b.tooltip,d=b.hoverPoint;b.hoverSeries=null;if(d)d.onMouseOut();this&&a.events.mouseOut&&q(this,"mouseOut");!c||this.stickyTracking||c.shared&&!this.noSharedTooltip||c.hide();b.series.forEach(function(a){a.setState("",!0)})},setState:function(a,b){var c=this,d=c.options,e=c.graph,f=d.inactiveOtherPoints,g=d.states,h=d.lineWidth,l=d.opacity,n=v(g[a||"normal"]&&g[a||"normal"].animation,
c.chart.options.chart.animation);d=0;a=a||"";if(c.state!==a&&([c.group,c.markerGroup,c.dataLabelsGroup].forEach(function(b){b&&(c.state&&b.removeClass("highcharts-series-"+c.state),a&&b.addClass("highcharts-series-"+a))}),c.state=a,!c.chart.styledMode)){if(g[a]&&!1===g[a].enabled)return;a&&(h=g[a].lineWidth||h+(g[a].lineWidthPlus||0),l=v(g[a].opacity,l));if(e&&!e.dashstyle)for(g={"stroke-width":h},e.animate(g,n);c["zone-graph-"+d];)c["zone-graph-"+d].attr(g),d+=1;f||[c.group,c.markerGroup,c.dataLabelsGroup,
c.labelBySeries].forEach(function(a){a&&a.animate({opacity:l},n)})}b&&f&&c.points&&c.setAllPointsToState(a)},setAllPointsToState:function(a){this.points.forEach(function(b){b.setState&&b.setState(a)})},setVisible:function(a,b){var c=this,d=c.chart,e=c.legendItem,f=d.options.chart.ignoreHiddenSeries,g=c.visible;var h=(c.visible=a=c.options.visible=c.userOptions.visible=void 0===a?!g:a)?"show":"hide";["group","dataLabelsGroup","markerGroup","tracker","tt"].forEach(function(a){if(c[a])c[a][h]()});if(d.hoverSeries===
c||(d.hoverPoint&&d.hoverPoint.series)===c)c.onMouseOut();e&&d.legend.colorizeItem(c,a);c.isDirty=!0;c.options.stacking&&d.series.forEach(function(a){a.options.stacking&&a.visible&&(a.isDirty=!0)});c.linkedSeries.forEach(function(b){b.setVisible(a,!1)});f&&(d.isDirtyBox=!0);q(c,h);!1!==b&&d.redraw()},show:function(){this.setVisible(!0)},hide:function(){this.setVisible(!1)},select:function(a){this.selected=a=this.options.selected=void 0===a?!this.selected:a;this.checkbox&&(this.checkbox.checked=a);
q(this,a?"select":"unselect")},drawTracker:E.drawTrackerGraph})});M(I,"parts/Responsive.js",[I["parts/Globals.js"],I["parts/Utilities.js"]],function(c,f){var F=f.isArray,G=f.isObject,z=f.objectEach,B=f.pick,t=f.splat;f=c.Chart;f.prototype.setResponsive=function(f,t){var v=this.options.responsive,y=[],h=this.currentResponsive;!t&&v&&v.rules&&v.rules.forEach(function(f){void 0===f._id&&(f._id=c.uniqueKey());this.matchResponsiveRule(f,y)},this);t=c.merge.apply(0,y.map(function(f){return c.find(v.rules,
function(c){return c._id===f}).chartOptions}));t.isResponsiveOptions=!0;y=y.toString()||void 0;y!==(h&&h.ruleIds)&&(h&&this.update(h.undoOptions,f,!0),y?(h=this.currentOptions(t),h.isResponsiveOptions=!0,this.currentResponsive={ruleIds:y,mergedOptions:t,undoOptions:h},this.update(t,f,!0)):this.currentResponsive=void 0)};f.prototype.matchResponsiveRule=function(c,f){var t=c.condition;(t.callback||function(){return this.chartWidth<=B(t.maxWidth,Number.MAX_VALUE)&&this.chartHeight<=B(t.maxHeight,Number.MAX_VALUE)&&
this.chartWidth>=B(t.minWidth,0)&&this.chartHeight>=B(t.minHeight,0)}).call(this)&&f.push(c._id)};f.prototype.currentOptions=function(c){function f(c,n,q,g){var b;z(c,function(a,c){if(!g&&-1<v.collectionsWithUpdate.indexOf(c))for(a=t(a),q[c]=[],b=0;b<a.length;b++)n[c][b]&&(q[c][b]={},f(a[b],n[c][b],q[c][b],g+1));else G(a)?(q[c]=F(a)?[]:{},f(a,n[c]||{},q[c],g+1)):q[c]=void 0===n[c]?null:n[c]})}var v=this,y={};f(c,this.options,y,0);return y}});M(I,"masters/highcharts.src.js",[I["parts/Globals.js"],
I["parts/Utilities.js"]],function(c,f){var F=f.extend;F(c,{arrayMax:f.arrayMax,arrayMin:f.arrayMin,attr:f.attr,defined:f.defined,erase:f.erase,extend:f.extend,isArray:f.isArray,isClass:f.isClass,isDOMElement:f.isDOMElement,isNumber:f.isNumber,isObject:f.isObject,isString:f.isString,objectEach:f.objectEach,pick:f.pick,pInt:f.pInt,setAnimation:f.setAnimation,splat:f.splat,syncTimeout:f.syncTimeout});return c});I["masters/highcharts.src.js"]._modules=I;return I["masters/highcharts.src.js"]});(function(t){t.fn.circliful=function(i){var e=t.extend({startdegree:0,fgcolor:"#556b2f",bgcolor:"#eee",fill:!1,width:15,dimension:200,fontsize:15,percent:50,animationstep:1,iconsize:"20px",iconcolor:"#999",border:"default",complete:null,bordersize:10},i);return this.each(function(){function a(i,e,a){t("<span></span>").appendTo(i).addClass(e).text(s).prepend(l).css({"line-height":a+"px","font-size":h.fontsize+"px"})}function n(i,e){t("<span></span>").appendTo(i).addClass("circle-info-half").css("line-height",h.dimension*e+"px").text(r)}function o(i){t.each(c,function(a,n){h[n]=void 0!=i.data(n)?i.data(n):t(e).attr(n),"fill"==n&&void 0!=i.data("fill")&&(m=!0)})}function d(e){u.clearRect(0,0,g.width,g.height),u.beginPath(),u.arc(x,b,w,z,y,!1),u.lineWidth=h.width+1,u.strokeStyle=h.bgcolor,u.stroke(),m&&(u.fillStyle=h.fill,u.fill()),u.beginPath(),u.arc(x,b,w,-k+T,C*e-k+T,!1),"outline"==h.border?u.lineWidth=h.width+13:"inline"==h.border&&(u.lineWidth=h.width-13),u.strokeStyle=h.fgcolor,u.stroke(),p>M&&(M+=I,requestAnimationFrame(function(){d(Math.min(M,p)/100)},f)),M==p&&S&&i!==void 0&&t.isFunction(i.complete)&&(i.complete(),S=!1)}var s,r,c=["fgcolor","bgcolor","fill","width","dimension","fontsize","animationstep","endPercent","icon","iconcolor","iconsize","border","startdegree","bordersize"],h={},l="",p=0,f=t(this),m=!1;if(f.addClass("circliful"),o(f),void 0!=f.data("text")&&(s=f.data("text"),void 0!=f.data("icon")&&(l=t("<i></i>").addClass("fa "+t(this).data("icon")).css({color:h.iconcolor,"font-size":h.iconsize})),void 0!=f.data("type")?(F=t(this).data("type"),"half"==F?a(f,"circle-text-half",h.dimension/1.45):a(f,"circle-text",h.dimension)):a(f,"circle-text",h.dimension)),void 0!=t(this).data("total")&&void 0!=t(this).data("part")){var v=t(this).data("total")/100;percent=(t(this).data("part")/v/100).toFixed(3),p=(t(this).data("part")/v).toFixed(3)}else void 0!=t(this).data("percent")?(percent=t(this).data("percent")/100,p=t(this).data("percent")):percent=e.percent/100;void 0!=t(this).data("info")&&(r=t(this).data("info"),void 0!=t(this).data("type")?(F=t(this).data("type"),"half"==F?n(f,.9):n(f,1.25)):n(f,1.25)),t(this).width(h.dimension+"px");var g=t("<canvas></canvas>").attr({width:h.dimension,height:h.dimension}).appendTo(t(this)).get(0),u=g.getContext("2d");t(g).parent();var x=g.width/2,b=g.height/2,P=360*h.percent;P*(Math.PI/180);var w=g.width/2.5,y=2.3*Math.PI,z=0,M=0===h.animationstep?p:0,I=Math.max(h.animationstep,0),C=2*Math.PI,k=Math.PI/2,F="",S=!0,T=h.startdegree/180*Math.PI;void 0!=t(this).data("type")&&(F=t(this).data("type"),"half"==F&&(y=2*Math.PI,z=3.13,C=Math.PI,k=Math.PI/.996)),d(M/100)})}})(jQuery);AP.chart = function(canvas, type){
	if (type=="pie"){
		return new ChartPie(canvas);
	}
	
	if (type=="bar"){
		return new ChartBar(canvas);
	}
	
	if (type=="radar"){
		return new ChartRadar(canvas);
	}
	
	if (type=="list" || type=="table" || type=="stacked"){
		return new ChartList(canvas, type);
	}
	
	if (type=="line"){
		return new ChartLine(canvas);
	}
	
	if (type=="series"){
		return new ChartSeries(canvas);
	}
	
	if (type=="percent"){
		return new ChartPercent(canvas);
	}
	
	if (type=="funnel"){
		return new ChartFunnel(canvas);
	}
};


AP.chartFX=new function __APChartFX(){
	this.exportData=function(data, options){
		var r=[];
		for (var i=0; i<data.length; i++){
			r.push(parseInt(data[i].value));
		}
		return r;
	};
	
	this.exportLabels=function(data, options){
		var r=[];
		for (var i=0; i<data.length; i++){
			if (data[i].name && !data[i].label){
				data[i].label=data[i].name;
			}
			
			r.push(data[i].label);
		}
		return r;
	};
	
	this.exportColors=function(data, options){
		var r=[];
		for (var i=0; i<data.length; i++){
			var c=data[i].color;
			if (!c){
				c=AP.color(i);
			}
			
			if (AP.data.isInt(c)){
				c=AP.color(c);
			}
			r.push(c);
		}
		return r;
	};
	
	
	this.exportHC=function(data, options, color){
		var r=[];
		for (var i=0; i<data.length; i++){
			var c=data[i].color;
			
			if (!c){
				c=AP.color(i);
			}
			
			if (data[i].name && !data[i].label){
				data[i].label=data[i].name;
			}
			
			r.push({name: data[i].label, y: parseInt(data[i].value), color: c});
		}
		return r;
	};
	
	
	this.exportFunnel=function(data, options){
		
		var r=[];
		for (var i=0; i<data.length; i++){
			var c=data[i].color;
			
			if (!c){
				c=AP.color(i);
			}
			
			r.push([data[i].label, parseInt(data[i].value)]);
		}
		return r;
	};
};


AP.series=function(opts){
	var r=[];
	for (var i=0; i<opts.labels.length; i++){
		var obj={};
		if (opts.stacked){
			obj={label: opts.labels[i], value: [parseFloat(opts.values[i])]};	
		}else{
			obj={label: opts.labels[i], value: parseFloat(opts.values[i])};
		}
		
		if (opts.colors){
			obj.color=opts.colors[i];
		}
			
		r.push(obj);
	}
	
	return r;
};




AP.color=function(code, alpha){
	var colors=["#6091e0", "#51cc90", "#ed912f", 
        "#6b5cd1", "#ba4cad", "#40b74e",
        "#FFEB3B","#00BCD4","#9C27B0", 
        "#f1c40f", "#009688", "#673AB7",
        "#FF9800","#4CAF50","#3F51B5"];
	
	var codes={
		"best":"#4CAF50",
		"good":"#8BC34A",
		"average":"#CDDC39",
		"bad":"#FF9800",
		"worst": "#FF5722",
		"gray":"#9E9E9E",
		"gray2": "#ccc"
	};
	
	var color="#000";
	
	if (AP.data.isInt(code)){
		var key= code % colors.length;
		color= colors[key];
	}else{
		var c=code.toLowerCase();
		if (code.charAt(0)=="#"){
			color=c;
		}else{
			if (c=="success"){
				c="good";
			}
			
			if (codes[c]){
				color= codes[c];
			}else{
				color= codes["gray2"];	
			}	
		}
	}
	

	if (alpha){
		if (alpha>0 && alpha<1){
			return UI.color.rgba(color, alpha);	
		}else{
			if (alpha>1){
				return UI.color.darken(color, alpha/100);
			}
		}
	}
	
	return color;
};


AP.statusColor=function(status, alpha){
	status=parseInt(status);
	var color="#aaaaaa";
	if (status==0){
		color="#aaaaaa";
	}
	
	if (status==1){
		color= "#f24a37";
	}
	
	if (status==2){
		color= "#f9c134";
	}
	
	if (status==3){
		color= "#bce222";
	}
	
	if (status==4){
		color= "#6de21f";
	}
	
	if (status==5){
		color= "#24d82d";
	}
	

	return AP.color(color, alpha)
};


function ChartList(canvas, type){
	this.type=type;
	this.box=canvas;
	
	
	this.show=function(data, options){
		var id=AP.uuid();
		$("<div id='"+id+"'></div>").appendTo(this.box);
		
		if (this.type=="list"){
			return showList(id, data, options);
		}
		
		Highcharts.chart(id, {
		    chart: {
		        type: 'bar',
		        height: (options.height?options.height:400),
		        style: {
		            fontFamily: 'Roboto'
		        }
		    },
		    title: {
	            text: (options.title?options.title:""),
	            enabled: (options.title?true:false),
	            style: {
	            	display: (options.title?'block':'none')
	            }
	        },
		    xAxis: {
		        categories: AP.chartFX.exportLabels(data, options)
		    },
		    yAxis: {
		        min: 0,
		        visible: false,
		        title: {
		            text: 'Total fruit consumption'
		        }
		    },
		    legend: {
		        reversed: true
		    },
		    plotOptions: {
		        series: {
		            stacking: 'normal'
		        }
		    },
		    series: AP.select(options.stacked, function(e, index){
		    	return {
		    		name: e,
		    		data: getStackedData(data, index)
		    	};
		    })
		});
	};
	
	
	
	function showList(id, data, options){
		Highcharts.chart(id, {
		    chart: {
		        type: 'bar',
		        height: (options.height?options.height:400),
		        style: {
		            fontFamily: 'Roboto'
		        }
		    },
		    title: {
	            text: (options.title?options.title:""),
	            enabled: (options.title?true:false),
	            style: {
	            	display: (options.title?'block':'none')
	            }
	        },
		    xAxis: {
		        categories: AP.chartFX.exportLabels(data, options)
		    },
		    yAxis: {
		        min: 0,
		        visible: false,
		        title: {
		            text: options.title
		        }
		    },
		    legend: {
		        reversed: true
		    },
		    colors: AP.chartFX.exportColors(data, options),
		    plotOptions: {
		        series: {
		            stacking: 'normal'
		        },
		        bar:{
		        	colors: AP.chartFX.exportColors(data, options),
		        	showInLegend: options.legend
		        }
		    },
		    series: [{
		        name: options.unit,
		        colorByPoint: true,
		        data: AP.chartFX.exportData(data, options, true)
		    }]
		  })
	};
	
	
	
	function getStackedData(data, index){
		var r=[];
		for (var i=0; i<data.length; i++){
			r.push(data[i].value[index]);
		}
		
		return r;
	};
};


function ChartPie(canvas){
	this.id=AP.uuid();
	$("<div class='center' id='"+this.id+"'></div>").appendTo(canvas);
	this.canvas=$("#"+this.id);
	
	this.show=function(data, options){
		options=$.extend({
			title: false,
			unit: ''
		}, options);
		
		
		if (options.height){
			this.canvas.css("height", options.height);
		}
		
		
		var dataLabels = {
            enabled: false
        };
		
		if (options.dataLabels){
			 dataLabels= {
                enabled: true,
                format: '<b>{point.name}</b>: {point.percentage:.1f} %',
                style: {
                    color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black'
                }
            };
		}
		
		var pie={
            allowPointSelect: true,
            cursor: 'pointer',
            dataLabels: dataLabels,
            showInLegend: options.legend,
        };
		
		if (options.doughnut){
			pie.innerSize= options.doughnut+'%';
		}
		
		// Build the chart
	    Highcharts.chart(this.id, {
	        chart: {
	            plotBackgroundColor: null,
	            plotBorderWidth: null,
	            plotShadow: false,
	            type: 'pie',
	            style: {
		            fontFamily: 'Roboto'
		        }
	        },
	        legend: {
                layout: "vertical"
            },
	        title: {
	            text: (options.title?options.title:""),
	            enabled: (options.title?true:false),
	            style: {
	            	display: (options.title?'block':'none')
	            }
	        },
	        tooltip: {
	            pointFormat: ' {series.name}: <b>{point.y}</b> | {point.percentage:.1f}%'
	        },
	        plotOptions: {
	        	pie: pie
	        },
	        series: [{
	            name: options.unit,
	            colorByPoint: true,
	            data: AP.chartFX.exportHC(data, options)
	        }]
	    });


	};
	
	
	
};


function ChartBar(canvas){
	this.id=AP.uuid();
	$("<div class='center' id='"+this.id+"'></div>").appendTo(canvas);
	this.canvas=$("#"+this.id);
	
	this.show=function(data, options){
		options=$.extend({
			title: false,
			unit: ''
		}, options);
		
		
		if (options.height){
			this.canvas.css("height", options.height);
		}
		
		
		var dataLabels = {
            enabled: false
        };
		
		if (options.dataLabels){
			 dataLabels= {
                enabled: true,
                format: '<b>{point.name}</b>: {point.percentage:.1f} %',
                style: {
                    color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black'
                }
            };
		}
		
		var points=AP.chartFX.exportData(data, options);
		
		if (data.length && "color" in data[0]){
			points= AP.chartFX.exportHC(data, options);
		}
		
		
		
		// Build the chart
	    Highcharts.chart(this.id, {
	        chart: {
	            plotBackgroundColor: null,
	            plotBorderWidth: null,
	            plotShadow: false,
	            style: {
		            fontFamily: 'Roboto'
		        },
		        backgroundColor:'rgba(255, 255, 255, 0.0)'
	        },
	        legend: {
                layout: "vertical",
            },
	        title: {
	            text: (options.title?options.title:""),
	            enabled: (options.title?true:false),
	            style: {
	            	display: (options.title?'block':'none')
	            }
	        },
	        tooltip: {
	            pointFormat: ' {series.name}: <b>{point.y}</b> | {point.percentage:.1f}%'
	        },
	        
	        plotOptions: {
	        	allowPointSelect: true,
	            cursor: 'pointer',
	            dataLabels: dataLabels,
	            showInLegend: options.legend,
	        },
	        xAxis: [{
	            categories: AP.chartFX.exportLabels(data, options),
	            crosshair: false,
                legend: false
	        }],
	        yAxis: {
	            title: {
	                text: options.unit
	            }
	        },
	        series: [{
	            type: 'column',
	            name: options.unit,
	            showInLegend: options.legend,
	            data: points
	        }]
	    });


	};
	
	
	
};


function ChartLine(canvas){
	this.id=AP.uuid();
	$("<div class='center' id='"+this.id+"'></div>").appendTo(canvas);
	this.canvas=$("#"+this.id);
	
	this.show=function(data, options){
		Highcharts.chart(this.id, {
			chart: {
	            plotBackgroundColor: null,
	            plotBorderWidth: null,
	            plotShadow: false,
	            style: {
		            fontFamily: 'Roboto'
		        },
		        height:300
	        },
	        title: {
	            text: (options.title?options.title:""),
	            enabled: (options.title?true:false),
	            style: {
	            	display: (options.title?'block':'none')
	            }
	        },

		    subtitle: {
		    	text: (options.subtitle?options.subtitle:""),
	            enabled: (options.subtitle?true:false),
	            style: {
	            	display: (options.subtitle?'block':'none')
	            }
		    },
		    
		    colors: AP.chartFX.exportColors(data, options),
		    
		    xAxis: {
		        categories: AP.chartFX.exportLabels(data, options)
		    },
		    
		    yAxis: {
		        title: {
		            text: options.unit
		        }
		    },
		    legend: {
		        layout: 'vertical',
		        align: 'right',
		        verticalAlign: 'middle'
		    },

		    plotOptions: {
		        series: {
		            pointWidth: 40
		        }
		    },

		    series: AP.select(options.stacked, function(e, index){
		    	return {
		    		name: e,
		    		data: getStackedData(data, index)
		    	};
		    })

		});
	};
	

	function getStackedData(data, index){
		var r=[];
		for (var i=0; i<data.length; i++){
			var v=data[i].value[index];
			if (AP.data.isInt(v)){
				v=parseInt(v);
			}else{
				v=parseFloat(v);
			}
			r.push(v);
		}
		
		return r;
	};
	
};


function ChartPercent(canvas){
	var id=AP.uuid();
	$("<div class='center relative js-percent-chart' style='margin:auto' id='"+id+"'></div>").appendTo(canvas);
	this.box=canvas;
	this.canvas="#"+id;
	
	
	this.show=function(percent, options){
		options.percent=percent;
		UI.graph.percent(this.canvas, options);
	};
};


AP.chartLegend=function(selector, data, options){
	$(selector).html(AP.render(data, function(e){
		return "<div class='cx-li'>" +
			"<div class='cx-dot'><span class='-ap icon-controller-stop' style='color:"+e.color+"'></span></div>" +
			"<div class='cx-label' style='color:"+e.color+"'>"+e.label+"</div>" +
			"<div class='cx-value'>"+AP.data.numberFormat(e.value)+"</div>" +
		"</div>";
	}));
};


function ChartFunnel(canvas){
	var id=AP.uuid();
	$("<div class='center' id='"+id+"'></div>").appendTo(canvas);
	this.box=canvas;
	// this.canvas=$(canvas).find("canvas")[0];
	this.id=id;
	
	this.show=function(data, options){
		if (options.legend){
			$(this.box).append("<div class='chart-legend'></div>");
		}
		
		
		Highcharts.chart(this.id, {
		    chart: {
		        type: 'funnel',
		        marginRight: 100,
		        height:300,
		        style: {
		            fontFamily: 'Roboto'
		        }
		    },
		    title: {
	            text: (options.title?options.title:""),
	            enabled: (options.title?true:false),
	            style: {
	            	display: (options.title?'block':'none')
	            },
	            x: -50
	        },
		    plotOptions: {
		        series: {
		            dataLabels: {
		                enabled: true,
		                format: '<b>{point.name}</b> ({point.y:,.0f})',
		                color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black',
		                softConnector: true
		            },
		            neckWidth: '30%',
		            neckHeight: '25%'

		            //-- Other available options
		            // height: pixels or percent
		            // width: pixels or percent
		        }
		    },
		    legend: {
		        enabled: false
		    },
		    colors: AP.chartFX.exportColors(data, options),
		    series: [{
		        name: options.unit,
		        'data': AP.chartFX.exportFunnel(data) 
		    }]
		});
	}
};



/**
 * @desc Samples
 * 	var data=[{label: "Expected", value: [1,2,3,4,5], color: "#555"},
 * 		{label: "Real", value: [5,4,3,2,1], color: "#333"}
 * 	];
 * 	
 * 	AP.chart("#radar", "radar").show(data,{
 * 		vertices: ["E1", "E2", "E3", "E4", "E5"],
 * 		legend: true,
 * 		title: optional
 * 	});
 * 
 * @param canvas
 * @returns
 */

function ChartRadar(canvas){
	$(canvas).find(".radar-chart").remove();
	this.id=AP.uuid();
	$("<div class='center radar-chart' id='"+this.id+"'></div>").appendTo(canvas);
	this.canvas=$("#"+this.id);
	
	this.show=function(data, options){
		options=$.extend({
			title: false,
			unit: ''
		}, options);
		
		
		Highcharts.chart( this.id, {
		    chart: {
		        polar: true,
		        type: 'line',
		        backgroundColor: null
		    },
		    
		    plotOptions:{
		    	line: {
		    		showInLegend: false
		    	}
		    },
		    
		    title: {
	            text: (options.title?options.title:""),
	            enabled: (options.title?true:false),
	            style: {
	            	display: (options.title?'block':'none')
	            },
	            x: -80
	        },

		    pane: {
		        size: '80%'
		    },

		    xAxis: {
		        categories: options.vertices,
		        tickmarkPlacement: 'on',
		        lineWidth: 0
		    },
		    
		    colors: AP.chartFX.exportColors(data, options),

		    yAxis: {
		        gridLineInterpolation: 'polygon',
		        lineWidth: 0,
		        min: 0,
		        max: 5
		    },

		    tooltip: {
		        shared: true,
		        pointFormat: '<span style="color:{series.color}">{series.name}: <b>{point.y:,.0f}</b><br/>'
		    },

		    legend: {
		        align: 'right',
		        verticalAlign: 'top',
		        y: 70,
		        layout: 'vertical'
		    },

		    series: AP.select(data, function(e, index){
		    	e.pointPlacement= 'on';
		    	e.name=e.label;
		    	e.data=e.value;
		    	return e;
		    })

		});
		
	}
	
	function getStackedData(data, index){
		var r=[];
		for (var i=0; i<data.length; i++){
			r.push(parseFloat(data[i].value[index]));
		}
		
		return r;
	};
};


function ChartSeries(canvas){
	this.id=AP.uuid();
	$("<div class='center' id='"+this.id+"'></div>").appendTo(canvas);
	this.canvas=$("#"+this.id);
	
	this.show=function(data, options){
		Highcharts.chart(this.id, {
			chart: {
	            plotBackgroundColor: null,
	            plotBorderWidth: null,
	            plotShadow: false,
	            style: {
		            fontFamily: 'Roboto'
		        },
		        height:300
	        },
	        title: {
	            text: (options.title?options.title:""),
	            enabled: (options.title?true:false),
	            style: {
	            	display: (options.title?'block':'none')
	            }
	        },

		    subtitle: {
		    	text: (options.subtitle?options.subtitle:""),
	            enabled: (options.subtitle?true:false),
	            style: {
	            	display: (options.subtitle?'block':'none')
	            }
		    },
		    
		    colors: AP.chartFX.exportColors(data, options),
		    
		    xAxis: {
		        categories: AP.chartFX.exportLabels(data, options)
		    },
		    
		    yAxis: {
		        title: {
		            text: options.unit
		        }
		    },
		    legend: {
		        layout: 'vertical',
		        align: 'right',
		        verticalAlign: 'middle'
		    },

		    plotOptions: {
		        series: {
		            pointWidth: 40
		        }
		    },

		    series: AP.select(data, function(e){
		    	var name=e.label;
		    	if (name in e){
		    		name=e.name;
		    	}
		    	var data=e.values;
		    	if (!data){
		    		data=e.value;
		    	}
		    	var type="line";
		    	if (e.type){
		    		type=e.type;
		    	}
		    	
		    	return {
		    		name: name,
		    		data: data,
		    		type: type
		    	};
		    })

		});
	};
	

	function getStackedData(data, index){
		var r=[];
		for (var i=0; i<data.length; i++){
			var v=data[i].value[index];
			if (AP.data.isInt(v)){
				v=parseInt(v);
			}else{
				v=parseFloat(v);
			}
			r.push(v);
		}
		
		return r;
	};
	
};


AP.sampleChart=function(canvas, type){
	if (canvas.charAt(0)=="#"){
		canvas=canvas.substr(1);
	}
	
	if (type=="pie"){

		// Build the chart
		Highcharts.chart(canvas, {
		    chart: {
		        plotBackgroundColor: null,
		        plotBorderWidth: null,
		        plotShadow: false,
		        type: 'pie',
		        backgroundColor:'rgba(255, 255, 255, 0.0)'
		    },
		    title: {
		        text: 'Browser market shares in January, 2018'
		    },
		    tooltip: {
		        pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
		    },
		    plotOptions: {
		        pie: {
		            allowPointSelect: true,
		            cursor: 'pointer',
		            dataLabels: {
		                enabled: false
		            },
		            showInLegend: true
		        }
		    },
		    series: [{
		        name: 'Brands',
		        colorByPoint: true,
		        data: [{
		            name: 'Chrome',
		            y: 61.41,
		            sliced: true,
		            selected: true
		        }, {
		            name: 'Internet Explorer',
		            y: 11.84
		        }, {
		            name: 'Firefox',
		            y: 10.85
		        }, {
		            name: 'Edge',
		            y: 4.67
		        }, {
		            name: 'Safari',
		            y: 4.18
		        }, {
		            name: 'Other',
		            y: 7.05
		        }]
		    }]
		});
	};
	
	if (type=="line"){
		Highcharts.chart(canvas, {
		    chart: {
		        zoomType: 'xy'
		    },
		    title: {
		        text: 'Average Monthly Temperature and Rainfall in Tokyo'
		    },
		    subtitle: {
		        text: 'Source: WorldClimate.com'
		    },
		    xAxis: [{
		        categories: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
		            'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
		        crosshair: true
		    }],
		    yAxis: [{ // Primary yAxis
		        labels: {
		            format: '{value}°C',
		            style: {
		                color: Highcharts.getOptions().colors[1]
		            }
		        },
		        title: {
		            text: 'Temperature',
		            style: {
		                color: Highcharts.getOptions().colors[1]
		            }
		        }
		    }, { // Secondary yAxis
		        title: {
		            text: 'Rainfall',
		            style: {
		                color: Highcharts.getOptions().colors[0]
		            }
		        },
		        labels: {
		            format: '{value} mm',
		            style: {
		                color: Highcharts.getOptions().colors[0]
		            }
		        },
		        opposite: true
		    }],
		    tooltip: {
		        shared: true
		    },
		    legend: {
		        layout: 'vertical',
		        align: 'left',
		        x: 120,
		        verticalAlign: 'top',
		        y: 100,
		        floating: true,
		        backgroundColor: (Highcharts.theme && Highcharts.theme.legendBackgroundColor) || '#FFFFFF'
		    },
		    series: [{
		        name: 'Rainfall',
		        type: 'column',
		        yAxis: 1,
		        data: [49.9, 71.5, 106.4, 129.2, 144.0, 176.0, 135.6, 148.5, 216.4, 194.1, 95.6, 54.4],
		        tooltip: {
		            valueSuffix: ' mm'
		        }

		    }, {
		        name: 'Temperature',
		        type: 'spline',
		        data: [7.0, 6.9, 9.5, 14.5, 18.2, 21.5, 25.2, 26.5, 23.3, 18.3, 13.9, 9.6],
		        tooltip: {
		            valueSuffix: '°C'
		        }
		    }]
		});
	}
	
	
	if (type=="bar"){

		Highcharts.chart(canvas, {
		    chart: {
		        type: 'column',
		        backgroundColor:'rgba(255, 255, 255, 0.0)'
		    },
		    title: {
		        text: 'Monthly Average Rainfall'
		    },
		    subtitle: {
		        text: 'Source: WorldClimate.com'
		    },
		    xAxis: {
		        categories: [
		            'Jan',
		            'Feb',
		            'Mar',
		            'Apr',
		            'May',
		            'Jun',
		            'Jul',
		            'Aug',
		            'Sep',
		            'Oct',
		            'Nov',
		            'Dec'
		        ],
		        crosshair: true
		    },
		    yAxis: {
		        min: 0,
		        title: {
		            text: 'Rainfall (mm)'
		        }
		    },
		    tooltip: {
		        headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
		        pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' +
		            '<td style="padding:0"><b>{point.y:.1f} mm</b></td></tr>',
		        footerFormat: '</table>',
		        shared: true,
		        useHTML: true
		    },
		    plotOptions: {
		        column: {
		            pointPadding: 0.2,
		            borderWidth: 0
		        }
		    },
		    series: [{
		        name: 'Tokyo',
		        data: [49.9, 71.5, 106.4, 129.2, 144.0, 176.0, 135.6, 148.5, 216.4, 194.1, 95.6, 54.4]

		    }, {
		        name: 'New York',
		        data: [83.6, 78.8, 98.5, 93.4, 106.0, 84.5, 105.0, 104.3, 91.2, 83.5, 106.6, 92.3]

		    }, {
		        name: 'London',
		        data: [48.9, 38.8, 39.3, 41.4, 47.0, 48.3, 59.0, 59.6, 52.4, 65.2, 59.3, 51.2]

		    }, {
		        name: 'Berlin',
		        data: [42.4, 33.2, 34.5, 39.7, 52.6, 75.5, 57.4, 60.4, 47.6, 39.1, 46.8, 51.1]

		    }]
		});
	}
};
//! moment.js
//! version : 2.16.0
//! authors : Tim Wood, Iskren Chernev, Moment.js contributors
//! license : MIT
//! momentjs.com
!function(a,b){"object"==typeof exports&&"undefined"!=typeof module?module.exports=b():"function"==typeof define&&define.amd?define(b):a.moment=b()}(this,function(){"use strict";function a(){return od.apply(null,arguments)}
// This is done to register the method called with moment()
// without creating circular dependencies.
function b(a){od=a}function c(a){return a instanceof Array||"[object Array]"===Object.prototype.toString.call(a)}function d(a){
// IE8 will treat undefined and null as object if it wasn't for
// input != null
return null!=a&&"[object Object]"===Object.prototype.toString.call(a)}function e(a){var b;for(b in a)
// even if its not own property I'd still call it non-empty
return!1;return!0}function f(a){return"number"==typeof value||"[object Number]"===Object.prototype.toString.call(a)}function g(a){return a instanceof Date||"[object Date]"===Object.prototype.toString.call(a)}function h(a,b){var c,d=[];for(c=0;c<a.length;++c)d.push(b(a[c],c));return d}function i(a,b){return Object.prototype.hasOwnProperty.call(a,b)}function j(a,b){for(var c in b)i(b,c)&&(a[c]=b[c]);return i(b,"toString")&&(a.toString=b.toString),i(b,"valueOf")&&(a.valueOf=b.valueOf),a}function k(a,b,c,d){return rb(a,b,c,d,!0).utc()}function l(){
// We need to deep clone this object.
return{empty:!1,unusedTokens:[],unusedInput:[],overflow:-2,charsLeftOver:0,nullInput:!1,invalidMonth:null,invalidFormat:!1,userInvalidated:!1,iso:!1,parsedDateParts:[],meridiem:null}}function m(a){return null==a._pf&&(a._pf=l()),a._pf}function n(a){if(null==a._isValid){var b=m(a),c=qd.call(b.parsedDateParts,function(a){return null!=a}),d=!isNaN(a._d.getTime())&&b.overflow<0&&!b.empty&&!b.invalidMonth&&!b.invalidWeekday&&!b.nullInput&&!b.invalidFormat&&!b.userInvalidated&&(!b.meridiem||b.meridiem&&c);if(a._strict&&(d=d&&0===b.charsLeftOver&&0===b.unusedTokens.length&&void 0===b.bigHour),null!=Object.isFrozen&&Object.isFrozen(a))return d;a._isValid=d}return a._isValid}function o(a){var b=k(NaN);return null!=a?j(m(b),a):m(b).userInvalidated=!0,b}function p(a){return void 0===a}function q(a,b){var c,d,e;if(p(b._isAMomentObject)||(a._isAMomentObject=b._isAMomentObject),p(b._i)||(a._i=b._i),p(b._f)||(a._f=b._f),p(b._l)||(a._l=b._l),p(b._strict)||(a._strict=b._strict),p(b._tzm)||(a._tzm=b._tzm),p(b._isUTC)||(a._isUTC=b._isUTC),p(b._offset)||(a._offset=b._offset),p(b._pf)||(a._pf=m(b)),p(b._locale)||(a._locale=b._locale),rd.length>0)for(c in rd)d=rd[c],e=b[d],p(e)||(a[d]=e);return a}
// Moment prototype object
function r(b){q(this,b),this._d=new Date(null!=b._d?b._d.getTime():NaN),
// Prevent infinite loop in case updateOffset creates new moment
// objects.
sd===!1&&(sd=!0,a.updateOffset(this),sd=!1)}function s(a){return a instanceof r||null!=a&&null!=a._isAMomentObject}function t(a){return a<0?Math.ceil(a)||0:Math.floor(a)}function u(a){var b=+a,c=0;return 0!==b&&isFinite(b)&&(c=t(b)),c}
// compare two arrays, return the number of differences
function v(a,b,c){var d,e=Math.min(a.length,b.length),f=Math.abs(a.length-b.length),g=0;for(d=0;d<e;d++)(c&&a[d]!==b[d]||!c&&u(a[d])!==u(b[d]))&&g++;return g+f}function w(b){a.suppressDeprecationWarnings===!1&&"undefined"!=typeof console&&console.warn&&console.warn("Deprecation warning: "+b)}function x(b,c){var d=!0;return j(function(){if(null!=a.deprecationHandler&&a.deprecationHandler(null,b),d){for(var e,f=[],g=0;g<arguments.length;g++){if(e="","object"==typeof arguments[g]){e+="\n["+g+"] ";for(var h in arguments[0])e+=h+": "+arguments[0][h]+", ";e=e.slice(0,-2)}else e=arguments[g];f.push(e)}w(b+"\nArguments: "+Array.prototype.slice.call(f).join("")+"\n"+(new Error).stack),d=!1}return c.apply(this,arguments)},c)}function y(b,c){null!=a.deprecationHandler&&a.deprecationHandler(b,c),td[b]||(w(c),td[b]=!0)}function z(a){return a instanceof Function||"[object Function]"===Object.prototype.toString.call(a)}function A(a){var b,c;for(c in a)b=a[c],z(b)?this[c]=b:this["_"+c]=b;this._config=a,
// Lenient ordinal parsing accepts just a number in addition to
// number + (possibly) stuff coming from _ordinalParseLenient.
this._ordinalParseLenient=new RegExp(this._ordinalParse.source+"|"+/\d{1,2}/.source)}function B(a,b){var c,e=j({},a);for(c in b)i(b,c)&&(d(a[c])&&d(b[c])?(e[c]={},j(e[c],a[c]),j(e[c],b[c])):null!=b[c]?e[c]=b[c]:delete e[c]);for(c in a)i(a,c)&&!i(b,c)&&d(a[c])&&(
// make sure changes to properties don't modify parent config
e[c]=j({},e[c]));return e}function C(a){null!=a&&this.set(a)}function D(a,b,c){var d=this._calendar[a]||this._calendar.sameElse;return z(d)?d.call(b,c):d}function E(a){var b=this._longDateFormat[a],c=this._longDateFormat[a.toUpperCase()];return b||!c?b:(this._longDateFormat[a]=c.replace(/MMMM|MM|DD|dddd/g,function(a){return a.slice(1)}),this._longDateFormat[a])}function F(){return this._invalidDate}function G(a){return this._ordinal.replace("%d",a)}function H(a,b,c,d){var e=this._relativeTime[c];return z(e)?e(a,b,c,d):e.replace(/%d/i,a)}function I(a,b){var c=this._relativeTime[a>0?"future":"past"];return z(c)?c(b):c.replace(/%s/i,b)}function J(a,b){var c=a.toLowerCase();Dd[c]=Dd[c+"s"]=Dd[b]=a}function K(a){return"string"==typeof a?Dd[a]||Dd[a.toLowerCase()]:void 0}function L(a){var b,c,d={};for(c in a)i(a,c)&&(b=K(c),b&&(d[b]=a[c]));return d}function M(a,b){Ed[a]=b}function N(a){var b=[];for(var c in a)b.push({unit:c,priority:Ed[c]});return b.sort(function(a,b){return a.priority-b.priority}),b}function O(b,c){return function(d){return null!=d?(Q(this,b,d),a.updateOffset(this,c),this):P(this,b)}}function P(a,b){return a.isValid()?a._d["get"+(a._isUTC?"UTC":"")+b]():NaN}function Q(a,b,c){a.isValid()&&a._d["set"+(a._isUTC?"UTC":"")+b](c)}
// MOMENTS
function R(a){return a=K(a),z(this[a])?this[a]():this}function S(a,b){if("object"==typeof a){a=L(a);for(var c=N(a),d=0;d<c.length;d++)this[c[d].unit](a[c[d].unit])}else if(a=K(a),z(this[a]))return this[a](b);return this}function T(a,b,c){var d=""+Math.abs(a),e=b-d.length,f=a>=0;return(f?c?"+":"":"-")+Math.pow(10,Math.max(0,e)).toString().substr(1)+d}
// token:    'M'
// padded:   ['MM', 2]
// ordinal:  'Mo'
// callback: function () { this.month() + 1 }
function U(a,b,c,d){var e=d;"string"==typeof d&&(e=function(){return this[d]()}),a&&(Id[a]=e),b&&(Id[b[0]]=function(){return T(e.apply(this,arguments),b[1],b[2])}),c&&(Id[c]=function(){return this.localeData().ordinal(e.apply(this,arguments),a)})}function V(a){return a.match(/\[[\s\S]/)?a.replace(/^\[|\]$/g,""):a.replace(/\\/g,"")}function W(a){var b,c,d=a.match(Fd);for(b=0,c=d.length;b<c;b++)Id[d[b]]?d[b]=Id[d[b]]:d[b]=V(d[b]);return function(b){var e,f="";for(e=0;e<c;e++)f+=d[e]instanceof Function?d[e].call(b,a):d[e];return f}}
// format date using native date object
function X(a,b){return a.isValid()?(b=Y(b,a.localeData()),Hd[b]=Hd[b]||W(b),Hd[b](a)):a.localeData().invalidDate()}function Y(a,b){function c(a){return b.longDateFormat(a)||a}var d=5;for(Gd.lastIndex=0;d>=0&&Gd.test(a);)a=a.replace(Gd,c),Gd.lastIndex=0,d-=1;return a}function Z(a,b,c){$d[a]=z(b)?b:function(a,d){return a&&c?c:b}}function $(a,b){return i($d,a)?$d[a](b._strict,b._locale):new RegExp(_(a))}
// Code from http://stackoverflow.com/questions/3561493/is-there-a-regexp-escape-function-in-javascript
function _(a){return aa(a.replace("\\","").replace(/\\(\[)|\\(\])|\[([^\]\[]*)\]|\\(.)/g,function(a,b,c,d,e){return b||c||d||e}))}function aa(a){return a.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}function ba(a,b){var c,d=b;for("string"==typeof a&&(a=[a]),f(b)&&(d=function(a,c){c[b]=u(a)}),c=0;c<a.length;c++)_d[a[c]]=d}function ca(a,b){ba(a,function(a,c,d,e){d._w=d._w||{},b(a,d._w,d,e)})}function da(a,b,c){null!=b&&i(_d,a)&&_d[a](b,c._a,c,a)}function ea(a,b){return new Date(Date.UTC(a,b+1,0)).getUTCDate()}function fa(a,b){return a?c(this._months)?this._months[a.month()]:this._months[(this._months.isFormat||ke).test(b)?"format":"standalone"][a.month()]:this._months}function ga(a,b){return a?c(this._monthsShort)?this._monthsShort[a.month()]:this._monthsShort[ke.test(b)?"format":"standalone"][a.month()]:this._monthsShort}function ha(a,b,c){var d,e,f,g=a.toLocaleLowerCase();if(!this._monthsParse)for(
// this is not used
this._monthsParse=[],this._longMonthsParse=[],this._shortMonthsParse=[],d=0;d<12;++d)f=k([2e3,d]),this._shortMonthsParse[d]=this.monthsShort(f,"").toLocaleLowerCase(),this._longMonthsParse[d]=this.months(f,"").toLocaleLowerCase();return c?"MMM"===b?(e=je.call(this._shortMonthsParse,g),e!==-1?e:null):(e=je.call(this._longMonthsParse,g),e!==-1?e:null):"MMM"===b?(e=je.call(this._shortMonthsParse,g),e!==-1?e:(e=je.call(this._longMonthsParse,g),e!==-1?e:null)):(e=je.call(this._longMonthsParse,g),e!==-1?e:(e=je.call(this._shortMonthsParse,g),e!==-1?e:null))}function ia(a,b,c){var d,e,f;if(this._monthsParseExact)return ha.call(this,a,b,c);
// TODO: add sorting
// Sorting makes sure if one month (or abbr) is a prefix of another
// see sorting in computeMonthsParse
for(this._monthsParse||(this._monthsParse=[],this._longMonthsParse=[],this._shortMonthsParse=[]),d=0;d<12;d++){
// test the regex
if(
// make the regex if we don't have it already
e=k([2e3,d]),c&&!this._longMonthsParse[d]&&(this._longMonthsParse[d]=new RegExp("^"+this.months(e,"").replace(".","")+"$","i"),this._shortMonthsParse[d]=new RegExp("^"+this.monthsShort(e,"").replace(".","")+"$","i")),c||this._monthsParse[d]||(f="^"+this.months(e,"")+"|^"+this.monthsShort(e,""),this._monthsParse[d]=new RegExp(f.replace(".",""),"i")),c&&"MMMM"===b&&this._longMonthsParse[d].test(a))return d;if(c&&"MMM"===b&&this._shortMonthsParse[d].test(a))return d;if(!c&&this._monthsParse[d].test(a))return d}}
// MOMENTS
function ja(a,b){var c;if(!a.isValid())
// No op
return a;if("string"==typeof b)if(/^\d+$/.test(b))b=u(b);else
// TODO: Another silent failure?
if(b=a.localeData().monthsParse(b),!f(b))return a;return c=Math.min(a.date(),ea(a.year(),b)),a._d["set"+(a._isUTC?"UTC":"")+"Month"](b,c),a}function ka(b){return null!=b?(ja(this,b),a.updateOffset(this,!0),this):P(this,"Month")}function la(){return ea(this.year(),this.month())}function ma(a){return this._monthsParseExact?(i(this,"_monthsRegex")||oa.call(this),a?this._monthsShortStrictRegex:this._monthsShortRegex):(i(this,"_monthsShortRegex")||(this._monthsShortRegex=ne),this._monthsShortStrictRegex&&a?this._monthsShortStrictRegex:this._monthsShortRegex)}function na(a){return this._monthsParseExact?(i(this,"_monthsRegex")||oa.call(this),a?this._monthsStrictRegex:this._monthsRegex):(i(this,"_monthsRegex")||(this._monthsRegex=oe),this._monthsStrictRegex&&a?this._monthsStrictRegex:this._monthsRegex)}function oa(){function a(a,b){return b.length-a.length}var b,c,d=[],e=[],f=[];for(b=0;b<12;b++)
// make the regex if we don't have it already
c=k([2e3,b]),d.push(this.monthsShort(c,"")),e.push(this.months(c,"")),f.push(this.months(c,"")),f.push(this.monthsShort(c,""));for(
// Sorting makes sure if one month (or abbr) is a prefix of another it
// will match the longer piece.
d.sort(a),e.sort(a),f.sort(a),b=0;b<12;b++)d[b]=aa(d[b]),e[b]=aa(e[b]);for(b=0;b<24;b++)f[b]=aa(f[b]);this._monthsRegex=new RegExp("^("+f.join("|")+")","i"),this._monthsShortRegex=this._monthsRegex,this._monthsStrictRegex=new RegExp("^("+e.join("|")+")","i"),this._monthsShortStrictRegex=new RegExp("^("+d.join("|")+")","i")}
// HELPERS
function pa(a){return qa(a)?366:365}function qa(a){return a%4===0&&a%100!==0||a%400===0}function ra(){return qa(this.year())}function sa(a,b,c,d,e,f,g){
//can't just apply() to create a date:
//http://stackoverflow.com/questions/181348/instantiating-a-javascript-object-by-calling-prototype-constructor-apply
var h=new Date(a,b,c,d,e,f,g);
//the date constructor remaps years 0-99 to 1900-1999
return a<100&&a>=0&&isFinite(h.getFullYear())&&h.setFullYear(a),h}function ta(a){var b=new Date(Date.UTC.apply(null,arguments));
//the Date.UTC function remaps years 0-99 to 1900-1999
return a<100&&a>=0&&isFinite(b.getUTCFullYear())&&b.setUTCFullYear(a),b}
// start-of-first-week - start-of-year
function ua(a,b,c){var// first-week day -- which january is always in the first week (4 for iso, 1 for other)
d=7+b-c,
// first-week day local weekday -- which local weekday is fwd
e=(7+ta(a,0,d).getUTCDay()-b)%7;return-e+d-1}
//http://en.wikipedia.org/wiki/ISO_week_date#Calculating_a_date_given_the_year.2C_week_number_and_weekday
function va(a,b,c,d,e){var f,g,h=(7+c-d)%7,i=ua(a,d,e),j=1+7*(b-1)+h+i;return j<=0?(f=a-1,g=pa(f)+j):j>pa(a)?(f=a+1,g=j-pa(a)):(f=a,g=j),{year:f,dayOfYear:g}}function wa(a,b,c){var d,e,f=ua(a.year(),b,c),g=Math.floor((a.dayOfYear()-f-1)/7)+1;return g<1?(e=a.year()-1,d=g+xa(e,b,c)):g>xa(a.year(),b,c)?(d=g-xa(a.year(),b,c),e=a.year()+1):(e=a.year(),d=g),{week:d,year:e}}function xa(a,b,c){var d=ua(a,b,c),e=ua(a+1,b,c);return(pa(a)-d+e)/7}
// HELPERS
// LOCALES
function ya(a){return wa(a,this._week.dow,this._week.doy).week}function za(){return this._week.dow}function Aa(){return this._week.doy}
// MOMENTS
function Ba(a){var b=this.localeData().week(this);return null==a?b:this.add(7*(a-b),"d")}function Ca(a){var b=wa(this,1,4).week;return null==a?b:this.add(7*(a-b),"d")}
// HELPERS
function Da(a,b){return"string"!=typeof a?a:isNaN(a)?(a=b.weekdaysParse(a),"number"==typeof a?a:null):parseInt(a,10)}function Ea(a,b){return"string"==typeof a?b.weekdaysParse(a)%7||7:isNaN(a)?null:a}function Fa(a,b){return a?c(this._weekdays)?this._weekdays[a.day()]:this._weekdays[this._weekdays.isFormat.test(b)?"format":"standalone"][a.day()]:this._weekdays}function Ga(a){return a?this._weekdaysShort[a.day()]:this._weekdaysShort}function Ha(a){return a?this._weekdaysMin[a.day()]:this._weekdaysMin}function Ia(a,b,c){var d,e,f,g=a.toLocaleLowerCase();if(!this._weekdaysParse)for(this._weekdaysParse=[],this._shortWeekdaysParse=[],this._minWeekdaysParse=[],d=0;d<7;++d)f=k([2e3,1]).day(d),this._minWeekdaysParse[d]=this.weekdaysMin(f,"").toLocaleLowerCase(),this._shortWeekdaysParse[d]=this.weekdaysShort(f,"").toLocaleLowerCase(),this._weekdaysParse[d]=this.weekdays(f,"").toLocaleLowerCase();return c?"dddd"===b?(e=je.call(this._weekdaysParse,g),e!==-1?e:null):"ddd"===b?(e=je.call(this._shortWeekdaysParse,g),e!==-1?e:null):(e=je.call(this._minWeekdaysParse,g),e!==-1?e:null):"dddd"===b?(e=je.call(this._weekdaysParse,g),e!==-1?e:(e=je.call(this._shortWeekdaysParse,g),e!==-1?e:(e=je.call(this._minWeekdaysParse,g),e!==-1?e:null))):"ddd"===b?(e=je.call(this._shortWeekdaysParse,g),e!==-1?e:(e=je.call(this._weekdaysParse,g),e!==-1?e:(e=je.call(this._minWeekdaysParse,g),e!==-1?e:null))):(e=je.call(this._minWeekdaysParse,g),e!==-1?e:(e=je.call(this._weekdaysParse,g),e!==-1?e:(e=je.call(this._shortWeekdaysParse,g),e!==-1?e:null)))}function Ja(a,b,c){var d,e,f;if(this._weekdaysParseExact)return Ia.call(this,a,b,c);for(this._weekdaysParse||(this._weekdaysParse=[],this._minWeekdaysParse=[],this._shortWeekdaysParse=[],this._fullWeekdaysParse=[]),d=0;d<7;d++){
// test the regex
if(
// make the regex if we don't have it already
e=k([2e3,1]).day(d),c&&!this._fullWeekdaysParse[d]&&(this._fullWeekdaysParse[d]=new RegExp("^"+this.weekdays(e,"").replace(".",".?")+"$","i"),this._shortWeekdaysParse[d]=new RegExp("^"+this.weekdaysShort(e,"").replace(".",".?")+"$","i"),this._minWeekdaysParse[d]=new RegExp("^"+this.weekdaysMin(e,"").replace(".",".?")+"$","i")),this._weekdaysParse[d]||(f="^"+this.weekdays(e,"")+"|^"+this.weekdaysShort(e,"")+"|^"+this.weekdaysMin(e,""),this._weekdaysParse[d]=new RegExp(f.replace(".",""),"i")),c&&"dddd"===b&&this._fullWeekdaysParse[d].test(a))return d;if(c&&"ddd"===b&&this._shortWeekdaysParse[d].test(a))return d;if(c&&"dd"===b&&this._minWeekdaysParse[d].test(a))return d;if(!c&&this._weekdaysParse[d].test(a))return d}}
// MOMENTS
function Ka(a){if(!this.isValid())return null!=a?this:NaN;var b=this._isUTC?this._d.getUTCDay():this._d.getDay();return null!=a?(a=Da(a,this.localeData()),this.add(a-b,"d")):b}function La(a){if(!this.isValid())return null!=a?this:NaN;var b=(this.day()+7-this.localeData()._week.dow)%7;return null==a?b:this.add(a-b,"d")}function Ma(a){if(!this.isValid())return null!=a?this:NaN;
// behaves the same as moment#day except
// as a getter, returns 7 instead of 0 (1-7 range instead of 0-6)
// as a setter, sunday should belong to the previous week.
if(null!=a){var b=Ea(a,this.localeData());return this.day(this.day()%7?b:b-7)}return this.day()||7}function Na(a){return this._weekdaysParseExact?(i(this,"_weekdaysRegex")||Qa.call(this),a?this._weekdaysStrictRegex:this._weekdaysRegex):(i(this,"_weekdaysRegex")||(this._weekdaysRegex=ue),this._weekdaysStrictRegex&&a?this._weekdaysStrictRegex:this._weekdaysRegex)}function Oa(a){return this._weekdaysParseExact?(i(this,"_weekdaysRegex")||Qa.call(this),a?this._weekdaysShortStrictRegex:this._weekdaysShortRegex):(i(this,"_weekdaysShortRegex")||(this._weekdaysShortRegex=ve),this._weekdaysShortStrictRegex&&a?this._weekdaysShortStrictRegex:this._weekdaysShortRegex)}function Pa(a){return this._weekdaysParseExact?(i(this,"_weekdaysRegex")||Qa.call(this),a?this._weekdaysMinStrictRegex:this._weekdaysMinRegex):(i(this,"_weekdaysMinRegex")||(this._weekdaysMinRegex=we),this._weekdaysMinStrictRegex&&a?this._weekdaysMinStrictRegex:this._weekdaysMinRegex)}function Qa(){function a(a,b){return b.length-a.length}var b,c,d,e,f,g=[],h=[],i=[],j=[];for(b=0;b<7;b++)
// make the regex if we don't have it already
c=k([2e3,1]).day(b),d=this.weekdaysMin(c,""),e=this.weekdaysShort(c,""),f=this.weekdays(c,""),g.push(d),h.push(e),i.push(f),j.push(d),j.push(e),j.push(f);for(
// Sorting makes sure if one weekday (or abbr) is a prefix of another it
// will match the longer piece.
g.sort(a),h.sort(a),i.sort(a),j.sort(a),b=0;b<7;b++)h[b]=aa(h[b]),i[b]=aa(i[b]),j[b]=aa(j[b]);this._weekdaysRegex=new RegExp("^("+j.join("|")+")","i"),this._weekdaysShortRegex=this._weekdaysRegex,this._weekdaysMinRegex=this._weekdaysRegex,this._weekdaysStrictRegex=new RegExp("^("+i.join("|")+")","i"),this._weekdaysShortStrictRegex=new RegExp("^("+h.join("|")+")","i"),this._weekdaysMinStrictRegex=new RegExp("^("+g.join("|")+")","i")}
// FORMATTING
function Ra(){return this.hours()%12||12}function Sa(){return this.hours()||24}function Ta(a,b){U(a,0,0,function(){return this.localeData().meridiem(this.hours(),this.minutes(),b)})}
// PARSING
function Ua(a,b){return b._meridiemParse}
// LOCALES
function Va(a){
// IE8 Quirks Mode & IE7 Standards Mode do not allow accessing strings like arrays
// Using charAt should be more compatible.
return"p"===(a+"").toLowerCase().charAt(0)}function Wa(a,b,c){return a>11?c?"pm":"PM":c?"am":"AM"}function Xa(a){return a?a.toLowerCase().replace("_","-"):a}
// pick the locale from the array
// try ['en-au', 'en-gb'] as 'en-au', 'en-gb', 'en', as in move through the list trying each
// substring from most specific to least, but move to the next array item if it's a more specific variant than the current root
function Ya(a){for(var b,c,d,e,f=0;f<a.length;){for(e=Xa(a[f]).split("-"),b=e.length,c=Xa(a[f+1]),c=c?c.split("-"):null;b>0;){if(d=Za(e.slice(0,b).join("-")))return d;if(c&&c.length>=b&&v(e,c,!0)>=b-1)
//the next array item is better than a shallower substring of this one
break;b--}f++}return null}function Za(a){var b=null;
// TODO: Find a better way to register and load all the locales in Node
if(!Be[a]&&"undefined"!=typeof module&&module&&module.exports)try{b=xe._abbr,require("./locale/"+a),
// because defineLocale currently also sets the global locale, we
// want to undo that for lazy loaded locales
$a(b)}catch(a){}return Be[a]}
// This function will load locale and then set the global locale.  If
// no arguments are passed in, it will simply return the current global
// locale key.
function $a(a,b){var c;
// moment.duration._locale = moment._locale = data;
return a&&(c=p(b)?bb(a):_a(a,b),c&&(xe=c)),xe._abbr}function _a(a,b){if(null!==b){var c=Ae;if(b.abbr=a,null!=Be[a])y("defineLocaleOverride","use moment.updateLocale(localeName, config) to change an existing locale. moment.defineLocale(localeName, config) should only be used for creating a new locale See http://momentjs.com/guides/#/warnings/define-locale/ for more info."),c=Be[a]._config;else if(null!=b.parentLocale){if(null==Be[b.parentLocale])return Ce[b.parentLocale]||(Ce[b.parentLocale]=[]),Ce[b.parentLocale].push({name:a,config:b}),null;c=Be[b.parentLocale]._config}
// backwards compat for now: also set the locale
// make sure we set the locale AFTER all child locales have been
// created, so we won't end up with the child locale set.
return Be[a]=new C(B(c,b)),Ce[a]&&Ce[a].forEach(function(a){_a(a.name,a.config)}),$a(a),Be[a]}
// useful for testing
return delete Be[a],null}function ab(a,b){if(null!=b){var c,d=Ae;
// MERGE
null!=Be[a]&&(d=Be[a]._config),b=B(d,b),c=new C(b),c.parentLocale=Be[a],Be[a]=c,
// backwards compat for now: also set the locale
$a(a)}else
// pass null for config to unupdate, useful for tests
null!=Be[a]&&(null!=Be[a].parentLocale?Be[a]=Be[a].parentLocale:null!=Be[a]&&delete Be[a]);return Be[a]}
// returns locale data
function bb(a){var b;if(a&&a._locale&&a._locale._abbr&&(a=a._locale._abbr),!a)return xe;if(!c(a)){if(
//short-circuit everything else
b=Za(a))return b;a=[a]}return Ya(a)}function cb(){return wd(Be)}function db(a){var b,c=a._a;return c&&m(a).overflow===-2&&(b=c[be]<0||c[be]>11?be:c[ce]<1||c[ce]>ea(c[ae],c[be])?ce:c[de]<0||c[de]>24||24===c[de]&&(0!==c[ee]||0!==c[fe]||0!==c[ge])?de:c[ee]<0||c[ee]>59?ee:c[fe]<0||c[fe]>59?fe:c[ge]<0||c[ge]>999?ge:-1,m(a)._overflowDayOfYear&&(b<ae||b>ce)&&(b=ce),m(a)._overflowWeeks&&b===-1&&(b=he),m(a)._overflowWeekday&&b===-1&&(b=ie),m(a).overflow=b),a}
// date from iso format
function eb(a){var b,c,d,e,f,g,h=a._i,i=De.exec(h)||Ee.exec(h);if(i){for(m(a).iso=!0,b=0,c=Ge.length;b<c;b++)if(Ge[b][1].exec(i[1])){e=Ge[b][0],d=Ge[b][2]!==!1;break}if(null==e)return void(a._isValid=!1);if(i[3]){for(b=0,c=He.length;b<c;b++)if(He[b][1].exec(i[3])){
// match[2] should be 'T' or space
f=(i[2]||" ")+He[b][0];break}if(null==f)return void(a._isValid=!1)}if(!d&&null!=f)return void(a._isValid=!1);if(i[4]){if(!Fe.exec(i[4]))return void(a._isValid=!1);g="Z"}a._f=e+(f||"")+(g||""),kb(a)}else a._isValid=!1}
// date from iso format or fallback
function fb(b){var c=Ie.exec(b._i);return null!==c?void(b._d=new Date(+c[1])):(eb(b),void(b._isValid===!1&&(delete b._isValid,a.createFromInputFallback(b))))}
// Pick the first defined of two or three arguments.
function gb(a,b,c){return null!=a?a:null!=b?b:c}function hb(b){
// hooks is actually the exported moment object
var c=new Date(a.now());return b._useUTC?[c.getUTCFullYear(),c.getUTCMonth(),c.getUTCDate()]:[c.getFullYear(),c.getMonth(),c.getDate()]}
// convert an array to a date.
// the array should mirror the parameters below
// note: all values past the year are optional and will default to the lowest possible value.
// [year, month, day , hour, minute, second, millisecond]
function ib(a){var b,c,d,e,f=[];if(!a._d){
// Default to current date.
// * if no year, month, day of month are given, default to today
// * if day of month is given, default month and year
// * if month is given, default only year
// * if year is given, don't default anything
for(d=hb(a),
//compute day of the year from weeks and weekdays
a._w&&null==a._a[ce]&&null==a._a[be]&&jb(a),
//if the day of the year is set, figure out what it is
a._dayOfYear&&(e=gb(a._a[ae],d[ae]),a._dayOfYear>pa(e)&&(m(a)._overflowDayOfYear=!0),c=ta(e,0,a._dayOfYear),a._a[be]=c.getUTCMonth(),a._a[ce]=c.getUTCDate()),b=0;b<3&&null==a._a[b];++b)a._a[b]=f[b]=d[b];
// Zero out whatever was not defaulted, including time
for(;b<7;b++)a._a[b]=f[b]=null==a._a[b]?2===b?1:0:a._a[b];
// Check for 24:00:00.000
24===a._a[de]&&0===a._a[ee]&&0===a._a[fe]&&0===a._a[ge]&&(a._nextDay=!0,a._a[de]=0),a._d=(a._useUTC?ta:sa).apply(null,f),
// Apply timezone offset from input. The actual utcOffset can be changed
// with parseZone.
null!=a._tzm&&a._d.setUTCMinutes(a._d.getUTCMinutes()-a._tzm),a._nextDay&&(a._a[de]=24)}}function jb(a){var b,c,d,e,f,g,h,i;if(b=a._w,null!=b.GG||null!=b.W||null!=b.E)f=1,g=4,
// TODO: We need to take the current isoWeekYear, but that depends on
// how we interpret now (local, utc, fixed offset). So create
// a now version of current config (take local/utc/offset flags, and
// create now).
c=gb(b.GG,a._a[ae],wa(sb(),1,4).year),d=gb(b.W,1),e=gb(b.E,1),(e<1||e>7)&&(i=!0);else{f=a._locale._week.dow,g=a._locale._week.doy;var j=wa(sb(),f,g);c=gb(b.gg,a._a[ae],j.year),
// Default to current week.
d=gb(b.w,j.week),null!=b.d?(
// weekday -- low day numbers are considered next week
e=b.d,(e<0||e>6)&&(i=!0)):null!=b.e?(
// local weekday -- counting starts from begining of week
e=b.e+f,(b.e<0||b.e>6)&&(i=!0)):
// default to begining of week
e=f}d<1||d>xa(c,f,g)?m(a)._overflowWeeks=!0:null!=i?m(a)._overflowWeekday=!0:(h=va(c,d,e,f,g),a._a[ae]=h.year,a._dayOfYear=h.dayOfYear)}
// date from string and format string
function kb(b){
// TODO: Move this to another part of the creation flow to prevent circular deps
if(b._f===a.ISO_8601)return void eb(b);b._a=[],m(b).empty=!0;
// This array is used to make a Date, either with "new Date" or "Date.UTC"
var c,d,e,f,g,h=""+b._i,i=h.length,j=0;for(e=Y(b._f,b._locale).match(Fd)||[],c=0;c<e.length;c++)f=e[c],d=(h.match($(f,b))||[])[0],
// console.log('token', token, 'parsedInput', parsedInput,
//         'regex', getParseRegexForToken(token, config));
d&&(g=h.substr(0,h.indexOf(d)),g.length>0&&m(b).unusedInput.push(g),h=h.slice(h.indexOf(d)+d.length),j+=d.length),
// don't parse if it's not a known token
Id[f]?(d?m(b).empty=!1:m(b).unusedTokens.push(f),da(f,d,b)):b._strict&&!d&&m(b).unusedTokens.push(f);
// add remaining unparsed input length to the string
m(b).charsLeftOver=i-j,h.length>0&&m(b).unusedInput.push(h),
// clear _12h flag if hour is <= 12
b._a[de]<=12&&m(b).bigHour===!0&&b._a[de]>0&&(m(b).bigHour=void 0),m(b).parsedDateParts=b._a.slice(0),m(b).meridiem=b._meridiem,
// handle meridiem
b._a[de]=lb(b._locale,b._a[de],b._meridiem),ib(b),db(b)}function lb(a,b,c){var d;
// Fallback
return null==c?b:null!=a.meridiemHour?a.meridiemHour(b,c):null!=a.isPM?(d=a.isPM(c),d&&b<12&&(b+=12),d||12!==b||(b=0),b):b}
// date from string and array of format strings
function mb(a){var b,c,d,e,f;if(0===a._f.length)return m(a).invalidFormat=!0,void(a._d=new Date(NaN));for(e=0;e<a._f.length;e++)f=0,b=q({},a),null!=a._useUTC&&(b._useUTC=a._useUTC),b._f=a._f[e],kb(b),n(b)&&(
// if there is any input that was not parsed add a penalty for that format
f+=m(b).charsLeftOver,
//or tokens
f+=10*m(b).unusedTokens.length,m(b).score=f,(null==d||f<d)&&(d=f,c=b));j(a,c||b)}function nb(a){if(!a._d){var b=L(a._i);a._a=h([b.year,b.month,b.day||b.date,b.hour,b.minute,b.second,b.millisecond],function(a){return a&&parseInt(a,10)}),ib(a)}}function ob(a){var b=new r(db(pb(a)));
// Adding is smart enough around DST
return b._nextDay&&(b.add(1,"d"),b._nextDay=void 0),b}function pb(a){var b=a._i,d=a._f;return a._locale=a._locale||bb(a._l),null===b||void 0===d&&""===b?o({nullInput:!0}):("string"==typeof b&&(a._i=b=a._locale.preparse(b)),s(b)?new r(db(b)):(g(b)?a._d=b:c(d)?mb(a):d?kb(a):qb(a),n(a)||(a._d=null),a))}function qb(b){var d=b._i;void 0===d?b._d=new Date(a.now()):g(d)?b._d=new Date(d.valueOf()):"string"==typeof d?fb(b):c(d)?(b._a=h(d.slice(0),function(a){return parseInt(a,10)}),ib(b)):"object"==typeof d?nb(b):f(d)?
// from milliseconds
b._d=new Date(d):a.createFromInputFallback(b)}function rb(a,b,f,g,h){var i={};
// object construction must be done this way.
// https://github.com/moment/moment/issues/1423
return f!==!0&&f!==!1||(g=f,f=void 0),(d(a)&&e(a)||c(a)&&0===a.length)&&(a=void 0),i._isAMomentObject=!0,i._useUTC=i._isUTC=h,i._l=f,i._i=a,i._f=b,i._strict=g,ob(i)}function sb(a,b,c,d){return rb(a,b,c,d,!1)}
// Pick a moment m from moments so that m[fn](other) is true for all
// other. This relies on the function fn to be transitive.
//
// moments should either be an array of moment objects or an array, whose
// first element is an array of moment objects.
function tb(a,b){var d,e;if(1===b.length&&c(b[0])&&(b=b[0]),!b.length)return sb();for(d=b[0],e=1;e<b.length;++e)b[e].isValid()&&!b[e][a](d)||(d=b[e]);return d}
// TODO: Use [].sort instead?
function ub(){var a=[].slice.call(arguments,0);return tb("isBefore",a)}function vb(){var a=[].slice.call(arguments,0);return tb("isAfter",a)}function wb(a){var b=L(a),c=b.year||0,d=b.quarter||0,e=b.month||0,f=b.week||0,g=b.day||0,h=b.hour||0,i=b.minute||0,j=b.second||0,k=b.millisecond||0;
// representation for dateAddRemove
this._milliseconds=+k+1e3*j+// 1000
6e4*i+// 1000 * 60
1e3*h*60*60,//using 1000 * 60 * 60 instead of 36e5 to avoid floating point rounding errors https://github.com/moment/moment/issues/2978
// Because of dateAddRemove treats 24 hours as different from a
// day when working around DST, we need to store them separately
this._days=+g+7*f,
// It is impossible translate months into days without knowing
// which months you are are talking about, so we have to store
// it separately.
this._months=+e+3*d+12*c,this._data={},this._locale=bb(),this._bubble()}function xb(a){return a instanceof wb}function yb(a){return a<0?Math.round(-1*a)*-1:Math.round(a)}
// FORMATTING
function zb(a,b){U(a,0,0,function(){var a=this.utcOffset(),c="+";return a<0&&(a=-a,c="-"),c+T(~~(a/60),2)+b+T(~~a%60,2)})}function Ab(a,b){var c=(b||"").match(a);if(null===c)return null;var d=c[c.length-1]||[],e=(d+"").match(Me)||["-",0,0],f=+(60*e[1])+u(e[2]);return 0===f?0:"+"===e[0]?f:-f}
// Return a moment from input, that is local/utc/zone equivalent to model.
function Bb(b,c){var d,e;
// Use low-level api, because this fn is low-level api.
return c._isUTC?(d=c.clone(),e=(s(b)||g(b)?b.valueOf():sb(b).valueOf())-d.valueOf(),d._d.setTime(d._d.valueOf()+e),a.updateOffset(d,!1),d):sb(b).local()}function Cb(a){
// On Firefox.24 Date#getTimezoneOffset returns a floating point.
// https://github.com/moment/moment/pull/1871
return 15*-Math.round(a._d.getTimezoneOffset()/15)}
// MOMENTS
// keepLocalTime = true means only change the timezone, without
// affecting the local hour. So 5:31:26 +0300 --[utcOffset(2, true)]-->
// 5:31:26 +0200 It is possible that 5:31:26 doesn't exist with offset
// +0200, so we adjust the time as needed, to be valid.
//
// Keeping the time actually adds/subtracts (one hour)
// from the actual represented time. That is why we call updateOffset
// a second time. In case it wants us to change the offset again
// _changeInProgress == true case, then we have to adjust, because
// there is no such time in the given timezone.
function Db(b,c){var d,e=this._offset||0;if(!this.isValid())return null!=b?this:NaN;if(null!=b){if("string"==typeof b){if(b=Ab(Xd,b),null===b)return this}else Math.abs(b)<16&&(b=60*b);return!this._isUTC&&c&&(d=Cb(this)),this._offset=b,this._isUTC=!0,null!=d&&this.add(d,"m"),e!==b&&(!c||this._changeInProgress?Tb(this,Ob(b-e,"m"),1,!1):this._changeInProgress||(this._changeInProgress=!0,a.updateOffset(this,!0),this._changeInProgress=null)),this}return this._isUTC?e:Cb(this)}function Eb(a,b){return null!=a?("string"!=typeof a&&(a=-a),this.utcOffset(a,b),this):-this.utcOffset()}function Fb(a){return this.utcOffset(0,a)}function Gb(a){return this._isUTC&&(this.utcOffset(0,a),this._isUTC=!1,a&&this.subtract(Cb(this),"m")),this}function Hb(){if(null!=this._tzm)this.utcOffset(this._tzm);else if("string"==typeof this._i){var a=Ab(Wd,this._i);null!=a?this.utcOffset(a):this.utcOffset(0,!0)}return this}function Ib(a){return!!this.isValid()&&(a=a?sb(a).utcOffset():0,(this.utcOffset()-a)%60===0)}function Jb(){return this.utcOffset()>this.clone().month(0).utcOffset()||this.utcOffset()>this.clone().month(5).utcOffset()}function Kb(){if(!p(this._isDSTShifted))return this._isDSTShifted;var a={};if(q(a,this),a=pb(a),a._a){var b=a._isUTC?k(a._a):sb(a._a);this._isDSTShifted=this.isValid()&&v(a._a,b.toArray())>0}else this._isDSTShifted=!1;return this._isDSTShifted}function Lb(){return!!this.isValid()&&!this._isUTC}function Mb(){return!!this.isValid()&&this._isUTC}function Nb(){return!!this.isValid()&&(this._isUTC&&0===this._offset)}function Ob(a,b){var c,d,e,g=a,
// matching against regexp is expensive, do it on demand
h=null;// checks for null or undefined
return xb(a)?g={ms:a._milliseconds,d:a._days,M:a._months}:f(a)?(g={},b?g[b]=a:g.milliseconds=a):(h=Ne.exec(a))?(c="-"===h[1]?-1:1,g={y:0,d:u(h[ce])*c,h:u(h[de])*c,m:u(h[ee])*c,s:u(h[fe])*c,ms:u(yb(1e3*h[ge]))*c}):(h=Oe.exec(a))?(c="-"===h[1]?-1:1,g={y:Pb(h[2],c),M:Pb(h[3],c),w:Pb(h[4],c),d:Pb(h[5],c),h:Pb(h[6],c),m:Pb(h[7],c),s:Pb(h[8],c)}):null==g?g={}:"object"==typeof g&&("from"in g||"to"in g)&&(e=Rb(sb(g.from),sb(g.to)),g={},g.ms=e.milliseconds,g.M=e.months),d=new wb(g),xb(a)&&i(a,"_locale")&&(d._locale=a._locale),d}function Pb(a,b){
// We'd normally use ~~inp for this, but unfortunately it also
// converts floats to ints.
// inp may be undefined, so careful calling replace on it.
var c=a&&parseFloat(a.replace(",","."));
// apply sign while we're at it
return(isNaN(c)?0:c)*b}function Qb(a,b){var c={milliseconds:0,months:0};return c.months=b.month()-a.month()+12*(b.year()-a.year()),a.clone().add(c.months,"M").isAfter(b)&&--c.months,c.milliseconds=+b-+a.clone().add(c.months,"M"),c}function Rb(a,b){var c;return a.isValid()&&b.isValid()?(b=Bb(b,a),a.isBefore(b)?c=Qb(a,b):(c=Qb(b,a),c.milliseconds=-c.milliseconds,c.months=-c.months),c):{milliseconds:0,months:0}}
// TODO: remove 'name' arg after deprecation is removed
function Sb(a,b){return function(c,d){var e,f;
//invert the arguments, but complain about it
return null===d||isNaN(+d)||(y(b,"moment()."+b+"(period, number) is deprecated. Please use moment()."+b+"(number, period). See http://momentjs.com/guides/#/warnings/add-inverted-param/ for more info."),f=c,c=d,d=f),c="string"==typeof c?+c:c,e=Ob(c,d),Tb(this,e,a),this}}function Tb(b,c,d,e){var f=c._milliseconds,g=yb(c._days),h=yb(c._months);b.isValid()&&(e=null==e||e,f&&b._d.setTime(b._d.valueOf()+f*d),g&&Q(b,"Date",P(b,"Date")+g*d),h&&ja(b,P(b,"Month")+h*d),e&&a.updateOffset(b,g||h))}function Ub(a,b){var c=a.diff(b,"days",!0);return c<-6?"sameElse":c<-1?"lastWeek":c<0?"lastDay":c<1?"sameDay":c<2?"nextDay":c<7?"nextWeek":"sameElse"}function Vb(b,c){
// We want to compare the start of today, vs this.
// Getting start-of-today depends on whether we're local/utc/offset or not.
var d=b||sb(),e=Bb(d,this).startOf("day"),f=a.calendarFormat(this,e)||"sameElse",g=c&&(z(c[f])?c[f].call(this,d):c[f]);return this.format(g||this.localeData().calendar(f,this,sb(d)))}function Wb(){return new r(this)}function Xb(a,b){var c=s(a)?a:sb(a);return!(!this.isValid()||!c.isValid())&&(b=K(p(b)?"millisecond":b),"millisecond"===b?this.valueOf()>c.valueOf():c.valueOf()<this.clone().startOf(b).valueOf())}function Yb(a,b){var c=s(a)?a:sb(a);return!(!this.isValid()||!c.isValid())&&(b=K(p(b)?"millisecond":b),"millisecond"===b?this.valueOf()<c.valueOf():this.clone().endOf(b).valueOf()<c.valueOf())}function Zb(a,b,c,d){return d=d||"()",("("===d[0]?this.isAfter(a,c):!this.isBefore(a,c))&&(")"===d[1]?this.isBefore(b,c):!this.isAfter(b,c))}function $b(a,b){var c,d=s(a)?a:sb(a);return!(!this.isValid()||!d.isValid())&&(b=K(b||"millisecond"),"millisecond"===b?this.valueOf()===d.valueOf():(c=d.valueOf(),this.clone().startOf(b).valueOf()<=c&&c<=this.clone().endOf(b).valueOf()))}function _b(a,b){return this.isSame(a,b)||this.isAfter(a,b)}function ac(a,b){return this.isSame(a,b)||this.isBefore(a,b)}function bc(a,b,c){var d,e,f,g;// 1000
// 1000 * 60
// 1000 * 60 * 60
// 1000 * 60 * 60 * 24, negate dst
// 1000 * 60 * 60 * 24 * 7, negate dst
return this.isValid()?(d=Bb(a,this),d.isValid()?(e=6e4*(d.utcOffset()-this.utcOffset()),b=K(b),"year"===b||"month"===b||"quarter"===b?(g=cc(this,d),"quarter"===b?g/=3:"year"===b&&(g/=12)):(f=this-d,g="second"===b?f/1e3:"minute"===b?f/6e4:"hour"===b?f/36e5:"day"===b?(f-e)/864e5:"week"===b?(f-e)/6048e5:f),c?g:t(g)):NaN):NaN}function cc(a,b){
// difference in months
var c,d,e=12*(b.year()-a.year())+(b.month()-a.month()),
// b is in (anchor - 1 month, anchor + 1 month)
f=a.clone().add(e,"months");
//check for negative zero, return zero if negative zero
// linear across the month
// linear across the month
return b-f<0?(c=a.clone().add(e-1,"months"),d=(b-f)/(f-c)):(c=a.clone().add(e+1,"months"),d=(b-f)/(c-f)),-(e+d)||0}function dc(){return this.clone().locale("en").format("ddd MMM DD YYYY HH:mm:ss [GMT]ZZ")}function ec(){var a=this.clone().utc();return 0<a.year()&&a.year()<=9999?z(Date.prototype.toISOString)?this.toDate().toISOString():X(a,"YYYY-MM-DD[T]HH:mm:ss.SSS[Z]"):X(a,"YYYYYY-MM-DD[T]HH:mm:ss.SSS[Z]")}/**
 * Return a human readable representation of a moment that can
 * also be evaluated to get a new moment which is the same
 *
 * @link https://nodejs.org/dist/latest/docs/api/util.html#util_custom_inspect_function_on_objects
 */
function fc(){if(!this.isValid())return"moment.invalid(/* "+this._i+" */)";var a="moment",b="";this.isLocal()||(a=0===this.utcOffset()?"moment.utc":"moment.parseZone",b="Z");var c="["+a+'("]',d=0<this.year()&&this.year()<=9999?"YYYY":"YYYYYY",e="-MM-DD[T]HH:mm:ss.SSS",f=b+'[")]';return this.format(c+d+e+f)}function gc(b){b||(b=this.isUtc()?a.defaultFormatUtc:a.defaultFormat);var c=X(this,b);return this.localeData().postformat(c)}function hc(a,b){return this.isValid()&&(s(a)&&a.isValid()||sb(a).isValid())?Ob({to:this,from:a}).locale(this.locale()).humanize(!b):this.localeData().invalidDate()}function ic(a){return this.from(sb(),a)}function jc(a,b){return this.isValid()&&(s(a)&&a.isValid()||sb(a).isValid())?Ob({from:this,to:a}).locale(this.locale()).humanize(!b):this.localeData().invalidDate()}function kc(a){return this.to(sb(),a)}
// If passed a locale key, it will set the locale for this
// instance.  Otherwise, it will return the locale configuration
// variables for this instance.
function lc(a){var b;return void 0===a?this._locale._abbr:(b=bb(a),null!=b&&(this._locale=b),this)}function mc(){return this._locale}function nc(a){
// the following switch intentionally omits break keywords
// to utilize falling through the cases.
switch(a=K(a)){case"year":this.month(0);/* falls through */
case"quarter":case"month":this.date(1);/* falls through */
case"week":case"isoWeek":case"day":case"date":this.hours(0);/* falls through */
case"hour":this.minutes(0);/* falls through */
case"minute":this.seconds(0);/* falls through */
case"second":this.milliseconds(0)}
// weeks are a special case
// quarters are also special
return"week"===a&&this.weekday(0),"isoWeek"===a&&this.isoWeekday(1),"quarter"===a&&this.month(3*Math.floor(this.month()/3)),this}function oc(a){
// 'date' is an alias for 'day', so it should be considered as such.
return a=K(a),void 0===a||"millisecond"===a?this:("date"===a&&(a="day"),this.startOf(a).add(1,"isoWeek"===a?"week":a).subtract(1,"ms"))}function pc(){return this._d.valueOf()-6e4*(this._offset||0)}function qc(){return Math.floor(this.valueOf()/1e3)}function rc(){return new Date(this.valueOf())}function sc(){var a=this;return[a.year(),a.month(),a.date(),a.hour(),a.minute(),a.second(),a.millisecond()]}function tc(){var a=this;return{years:a.year(),months:a.month(),date:a.date(),hours:a.hours(),minutes:a.minutes(),seconds:a.seconds(),milliseconds:a.milliseconds()}}function uc(){
// new Date(NaN).toJSON() === null
return this.isValid()?this.toISOString():null}function vc(){return n(this)}function wc(){return j({},m(this))}function xc(){return m(this).overflow}function yc(){return{input:this._i,format:this._f,locale:this._locale,isUTC:this._isUTC,strict:this._strict}}function zc(a,b){U(0,[a,a.length],0,b)}
// MOMENTS
function Ac(a){return Ec.call(this,a,this.week(),this.weekday(),this.localeData()._week.dow,this.localeData()._week.doy)}function Bc(a){return Ec.call(this,a,this.isoWeek(),this.isoWeekday(),1,4)}function Cc(){return xa(this.year(),1,4)}function Dc(){var a=this.localeData()._week;return xa(this.year(),a.dow,a.doy)}function Ec(a,b,c,d,e){var f;return null==a?wa(this,d,e).year:(f=xa(a,d,e),b>f&&(b=f),Fc.call(this,a,b,c,d,e))}function Fc(a,b,c,d,e){var f=va(a,b,c,d,e),g=ta(f.year,0,f.dayOfYear);return this.year(g.getUTCFullYear()),this.month(g.getUTCMonth()),this.date(g.getUTCDate()),this}
// MOMENTS
function Gc(a){return null==a?Math.ceil((this.month()+1)/3):this.month(3*(a-1)+this.month()%3)}
// HELPERS
// MOMENTS
function Hc(a){var b=Math.round((this.clone().startOf("day")-this.clone().startOf("year"))/864e5)+1;return null==a?b:this.add(a-b,"d")}function Ic(a,b){b[ge]=u(1e3*("0."+a))}
// MOMENTS
function Jc(){return this._isUTC?"UTC":""}function Kc(){return this._isUTC?"Coordinated Universal Time":""}function Lc(a){return sb(1e3*a)}function Mc(){return sb.apply(null,arguments).parseZone()}function Nc(a){return a}function Oc(a,b,c,d){var e=bb(),f=k().set(d,b);return e[c](f,a)}function Pc(a,b,c){if(f(a)&&(b=a,a=void 0),a=a||"",null!=b)return Oc(a,b,c,"month");var d,e=[];for(d=0;d<12;d++)e[d]=Oc(a,d,c,"month");return e}
// ()
// (5)
// (fmt, 5)
// (fmt)
// (true)
// (true, 5)
// (true, fmt, 5)
// (true, fmt)
function Qc(a,b,c,d){"boolean"==typeof a?(f(b)&&(c=b,b=void 0),b=b||""):(b=a,c=b,a=!1,f(b)&&(c=b,b=void 0),b=b||"");var e=bb(),g=a?e._week.dow:0;if(null!=c)return Oc(b,(c+g)%7,d,"day");var h,i=[];for(h=0;h<7;h++)i[h]=Oc(b,(h+g)%7,d,"day");return i}function Rc(a,b){return Pc(a,b,"months")}function Sc(a,b){return Pc(a,b,"monthsShort")}function Tc(a,b,c){return Qc(a,b,c,"weekdays")}function Uc(a,b,c){return Qc(a,b,c,"weekdaysShort")}function Vc(a,b,c){return Qc(a,b,c,"weekdaysMin")}function Wc(){var a=this._data;return this._milliseconds=Ze(this._milliseconds),this._days=Ze(this._days),this._months=Ze(this._months),a.milliseconds=Ze(a.milliseconds),a.seconds=Ze(a.seconds),a.minutes=Ze(a.minutes),a.hours=Ze(a.hours),a.months=Ze(a.months),a.years=Ze(a.years),this}function Xc(a,b,c,d){var e=Ob(b,c);return a._milliseconds+=d*e._milliseconds,a._days+=d*e._days,a._months+=d*e._months,a._bubble()}
// supports only 2.0-style add(1, 's') or add(duration)
function Yc(a,b){return Xc(this,a,b,1)}
// supports only 2.0-style subtract(1, 's') or subtract(duration)
function Zc(a,b){return Xc(this,a,b,-1)}function $c(a){return a<0?Math.floor(a):Math.ceil(a)}function _c(){var a,b,c,d,e,f=this._milliseconds,g=this._days,h=this._months,i=this._data;
// if we have a mix of positive and negative values, bubble down first
// check: https://github.com/moment/moment/issues/2166
// The following code bubbles up values, see the tests for
// examples of what that means.
// convert days to months
// 12 months -> 1 year
return f>=0&&g>=0&&h>=0||f<=0&&g<=0&&h<=0||(f+=864e5*$c(bd(h)+g),g=0,h=0),i.milliseconds=f%1e3,a=t(f/1e3),i.seconds=a%60,b=t(a/60),i.minutes=b%60,c=t(b/60),i.hours=c%24,g+=t(c/24),e=t(ad(g)),h+=e,g-=$c(bd(e)),d=t(h/12),h%=12,i.days=g,i.months=h,i.years=d,this}function ad(a){
// 400 years have 146097 days (taking into account leap year rules)
// 400 years have 12 months === 4800
return 4800*a/146097}function bd(a){
// the reverse of daysToMonths
return 146097*a/4800}function cd(a){var b,c,d=this._milliseconds;if(a=K(a),"month"===a||"year"===a)return b=this._days+d/864e5,c=this._months+ad(b),"month"===a?c:c/12;switch(
// handle milliseconds separately because of floating point math errors (issue #1867)
b=this._days+Math.round(bd(this._months)),a){case"week":return b/7+d/6048e5;case"day":return b+d/864e5;case"hour":return 24*b+d/36e5;case"minute":return 1440*b+d/6e4;case"second":return 86400*b+d/1e3;
// Math.floor prevents floating point math errors here
case"millisecond":return Math.floor(864e5*b)+d;default:throw new Error("Unknown unit "+a)}}
// TODO: Use this.as('ms')?
function dd(){return this._milliseconds+864e5*this._days+this._months%12*2592e6+31536e6*u(this._months/12)}function ed(a){return function(){return this.as(a)}}function fd(a){return a=K(a),this[a+"s"]()}function gd(a){return function(){return this._data[a]}}function hd(){return t(this.days()/7)}
// helper function for moment.fn.from, moment.fn.fromNow, and moment.duration.fn.humanize
function id(a,b,c,d,e){return e.relativeTime(b||1,!!c,a,d)}function jd(a,b,c){var d=Ob(a).abs(),e=of(d.as("s")),f=of(d.as("m")),g=of(d.as("h")),h=of(d.as("d")),i=of(d.as("M")),j=of(d.as("y")),k=e<pf.s&&["s",e]||f<=1&&["m"]||f<pf.m&&["mm",f]||g<=1&&["h"]||g<pf.h&&["hh",g]||h<=1&&["d"]||h<pf.d&&["dd",h]||i<=1&&["M"]||i<pf.M&&["MM",i]||j<=1&&["y"]||["yy",j];return k[2]=b,k[3]=+a>0,k[4]=c,id.apply(null,k)}
// This function allows you to set the rounding function for relative time strings
function kd(a){return void 0===a?of:"function"==typeof a&&(of=a,!0)}
// This function allows you to set a threshold for relative time strings
function ld(a,b){return void 0!==pf[a]&&(void 0===b?pf[a]:(pf[a]=b,!0))}function md(a){var b=this.localeData(),c=jd(this,!a,b);return a&&(c=b.pastFuture(+this,c)),b.postformat(c)}function nd(){
// for ISO strings we do not use the normal bubbling rules:
//  * milliseconds bubble up until they become hours
//  * days do not bubble at all
//  * months bubble up until they become years
// This is because there is no context-free conversion between hours and days
// (think of clock changes)
// and also not between days and months (28-31 days per month)
var a,b,c,d=qf(this._milliseconds)/1e3,e=qf(this._days),f=qf(this._months);
// 3600 seconds -> 60 minutes -> 1 hour
a=t(d/60),b=t(a/60),d%=60,a%=60,
// 12 months -> 1 year
c=t(f/12),f%=12;
// inspired by https://github.com/dordille/moment-isoduration/blob/master/moment.isoduration.js
var g=c,h=f,i=e,j=b,k=a,l=d,m=this.asSeconds();return m?(m<0?"-":"")+"P"+(g?g+"Y":"")+(h?h+"M":"")+(i?i+"D":"")+(j||k||l?"T":"")+(j?j+"H":"")+(k?k+"M":"")+(l?l+"S":""):"P0D"}var od,pd;pd=Array.prototype.some?Array.prototype.some:function(a){for(var b=Object(this),c=b.length>>>0,d=0;d<c;d++)if(d in b&&a.call(this,b[d],d,b))return!0;return!1};var qd=pd,rd=a.momentProperties=[],sd=!1,td={};a.suppressDeprecationWarnings=!1,a.deprecationHandler=null;var ud;ud=Object.keys?Object.keys:function(a){var b,c=[];for(b in a)i(a,b)&&c.push(b);return c};var vd,wd=ud,xd={sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[Last] dddd [at] LT",sameElse:"L"},yd={LTS:"h:mm:ss A",LT:"h:mm A",L:"MM/DD/YYYY",LL:"MMMM D, YYYY",LLL:"MMMM D, YYYY h:mm A",LLLL:"dddd, MMMM D, YYYY h:mm A"},zd="Invalid date",Ad="%d",Bd=/\d{1,2}/,Cd={future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"},Dd={},Ed={},Fd=/(\[[^\[]*\])|(\\)?([Hh]mm(ss)?|Mo|MM?M?M?|Do|DDDo|DD?D?D?|ddd?d?|do?|w[o|w]?|W[o|W]?|Qo?|YYYYYY|YYYYY|YYYY|YY|gg(ggg?)?|GG(GGG?)?|e|E|a|A|hh?|HH?|kk?|mm?|ss?|S{1,9}|x|X|zz?|ZZ?|.)/g,Gd=/(\[[^\[]*\])|(\\)?(LTS|LT|LL?L?L?|l{1,4})/g,Hd={},Id={},Jd=/\d/,Kd=/\d\d/,Ld=/\d{3}/,Md=/\d{4}/,Nd=/[+-]?\d{6}/,Od=/\d\d?/,Pd=/\d\d\d\d?/,Qd=/\d\d\d\d\d\d?/,Rd=/\d{1,3}/,Sd=/\d{1,4}/,Td=/[+-]?\d{1,6}/,Ud=/\d+/,Vd=/[+-]?\d+/,Wd=/Z|[+-]\d\d:?\d\d/gi,Xd=/Z|[+-]\d\d(?::?\d\d)?/gi,Yd=/[+-]?\d+(\.\d{1,3})?/,Zd=/[0-9]*['a-z\u00A0-\u05FF\u0700-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+|[\u0600-\u06FF\/]+(\s*?[\u0600-\u06FF]+){1,2}/i,$d={},_d={},ae=0,be=1,ce=2,de=3,ee=4,fe=5,ge=6,he=7,ie=8;vd=Array.prototype.indexOf?Array.prototype.indexOf:function(a){
// I know
var b;for(b=0;b<this.length;++b)if(this[b]===a)return b;return-1};var je=vd;
// FORMATTING
U("M",["MM",2],"Mo",function(){return this.month()+1}),U("MMM",0,0,function(a){return this.localeData().monthsShort(this,a)}),U("MMMM",0,0,function(a){return this.localeData().months(this,a)}),
// ALIASES
J("month","M"),
// PRIORITY
M("month",8),
// PARSING
Z("M",Od),Z("MM",Od,Kd),Z("MMM",function(a,b){return b.monthsShortRegex(a)}),Z("MMMM",function(a,b){return b.monthsRegex(a)}),ba(["M","MM"],function(a,b){b[be]=u(a)-1}),ba(["MMM","MMMM"],function(a,b,c,d){var e=c._locale.monthsParse(a,d,c._strict);
// if we didn't find a month name, mark the date as invalid.
null!=e?b[be]=e:m(c).invalidMonth=a});
// LOCALES
var ke=/D[oD]?(\[[^\[\]]*\]|\s)+MMMM?/,le="January_February_March_April_May_June_July_August_September_October_November_December".split("_"),me="Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec".split("_"),ne=Zd,oe=Zd;
// FORMATTING
U("Y",0,0,function(){var a=this.year();return a<=9999?""+a:"+"+a}),U(0,["YY",2],0,function(){return this.year()%100}),U(0,["YYYY",4],0,"year"),U(0,["YYYYY",5],0,"year"),U(0,["YYYYYY",6,!0],0,"year"),
// ALIASES
J("year","y"),
// PRIORITIES
M("year",1),
// PARSING
Z("Y",Vd),Z("YY",Od,Kd),Z("YYYY",Sd,Md),Z("YYYYY",Td,Nd),Z("YYYYYY",Td,Nd),ba(["YYYYY","YYYYYY"],ae),ba("YYYY",function(b,c){c[ae]=2===b.length?a.parseTwoDigitYear(b):u(b)}),ba("YY",function(b,c){c[ae]=a.parseTwoDigitYear(b)}),ba("Y",function(a,b){b[ae]=parseInt(a,10)}),
// HOOKS
a.parseTwoDigitYear=function(a){return u(a)+(u(a)>68?1900:2e3)};
// MOMENTS
var pe=O("FullYear",!0);
// FORMATTING
U("w",["ww",2],"wo","week"),U("W",["WW",2],"Wo","isoWeek"),
// ALIASES
J("week","w"),J("isoWeek","W"),
// PRIORITIES
M("week",5),M("isoWeek",5),
// PARSING
Z("w",Od),Z("ww",Od,Kd),Z("W",Od),Z("WW",Od,Kd),ca(["w","ww","W","WW"],function(a,b,c,d){b[d.substr(0,1)]=u(a)});var qe={dow:0,// Sunday is the first day of the week.
doy:6};
// FORMATTING
U("d",0,"do","day"),U("dd",0,0,function(a){return this.localeData().weekdaysMin(this,a)}),U("ddd",0,0,function(a){return this.localeData().weekdaysShort(this,a)}),U("dddd",0,0,function(a){return this.localeData().weekdays(this,a)}),U("e",0,0,"weekday"),U("E",0,0,"isoWeekday"),
// ALIASES
J("day","d"),J("weekday","e"),J("isoWeekday","E"),
// PRIORITY
M("day",11),M("weekday",11),M("isoWeekday",11),
// PARSING
Z("d",Od),Z("e",Od),Z("E",Od),Z("dd",function(a,b){return b.weekdaysMinRegex(a)}),Z("ddd",function(a,b){return b.weekdaysShortRegex(a)}),Z("dddd",function(a,b){return b.weekdaysRegex(a)}),ca(["dd","ddd","dddd"],function(a,b,c,d){var e=c._locale.weekdaysParse(a,d,c._strict);
// if we didn't get a weekday name, mark the date as invalid
null!=e?b.d=e:m(c).invalidWeekday=a}),ca(["d","e","E"],function(a,b,c,d){b[d]=u(a)});
// LOCALES
var re="Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),se="Sun_Mon_Tue_Wed_Thu_Fri_Sat".split("_"),te="Su_Mo_Tu_We_Th_Fr_Sa".split("_"),ue=Zd,ve=Zd,we=Zd;U("H",["HH",2],0,"hour"),U("h",["hh",2],0,Ra),U("k",["kk",2],0,Sa),U("hmm",0,0,function(){return""+Ra.apply(this)+T(this.minutes(),2)}),U("hmmss",0,0,function(){return""+Ra.apply(this)+T(this.minutes(),2)+T(this.seconds(),2)}),U("Hmm",0,0,function(){return""+this.hours()+T(this.minutes(),2)}),U("Hmmss",0,0,function(){return""+this.hours()+T(this.minutes(),2)+T(this.seconds(),2)}),Ta("a",!0),Ta("A",!1),
// ALIASES
J("hour","h"),
// PRIORITY
M("hour",13),Z("a",Ua),Z("A",Ua),Z("H",Od),Z("h",Od),Z("HH",Od,Kd),Z("hh",Od,Kd),Z("hmm",Pd),Z("hmmss",Qd),Z("Hmm",Pd),Z("Hmmss",Qd),ba(["H","HH"],de),ba(["a","A"],function(a,b,c){c._isPm=c._locale.isPM(a),c._meridiem=a}),ba(["h","hh"],function(a,b,c){b[de]=u(a),m(c).bigHour=!0}),ba("hmm",function(a,b,c){var d=a.length-2;b[de]=u(a.substr(0,d)),b[ee]=u(a.substr(d)),m(c).bigHour=!0}),ba("hmmss",function(a,b,c){var d=a.length-4,e=a.length-2;b[de]=u(a.substr(0,d)),b[ee]=u(a.substr(d,2)),b[fe]=u(a.substr(e)),m(c).bigHour=!0}),ba("Hmm",function(a,b,c){var d=a.length-2;b[de]=u(a.substr(0,d)),b[ee]=u(a.substr(d))}),ba("Hmmss",function(a,b,c){var d=a.length-4,e=a.length-2;b[de]=u(a.substr(0,d)),b[ee]=u(a.substr(d,2)),b[fe]=u(a.substr(e))});var xe,ye=/[ap]\.?m?\.?/i,ze=O("Hours",!0),Ae={calendar:xd,longDateFormat:yd,invalidDate:zd,ordinal:Ad,ordinalParse:Bd,relativeTime:Cd,months:le,monthsShort:me,week:qe,weekdays:re,weekdaysMin:te,weekdaysShort:se,meridiemParse:ye},Be={},Ce={},De=/^\s*((?:[+-]\d{6}|\d{4})-(?:\d\d-\d\d|W\d\d-\d|W\d\d|\d\d\d|\d\d))(?:(T| )(\d\d(?::\d\d(?::\d\d(?:[.,]\d+)?)?)?)([\+\-]\d\d(?::?\d\d)?|\s*Z)?)?$/,Ee=/^\s*((?:[+-]\d{6}|\d{4})(?:\d\d\d\d|W\d\d\d|W\d\d|\d\d\d|\d\d))(?:(T| )(\d\d(?:\d\d(?:\d\d(?:[.,]\d+)?)?)?)([\+\-]\d\d(?::?\d\d)?|\s*Z)?)?$/,Fe=/Z|[+-]\d\d(?::?\d\d)?/,Ge=[["YYYYYY-MM-DD",/[+-]\d{6}-\d\d-\d\d/],["YYYY-MM-DD",/\d{4}-\d\d-\d\d/],["GGGG-[W]WW-E",/\d{4}-W\d\d-\d/],["GGGG-[W]WW",/\d{4}-W\d\d/,!1],["YYYY-DDD",/\d{4}-\d{3}/],["YYYY-MM",/\d{4}-\d\d/,!1],["YYYYYYMMDD",/[+-]\d{10}/],["YYYYMMDD",/\d{8}/],
// YYYYMM is NOT allowed by the standard
["GGGG[W]WWE",/\d{4}W\d{3}/],["GGGG[W]WW",/\d{4}W\d{2}/,!1],["YYYYDDD",/\d{7}/]],He=[["HH:mm:ss.SSSS",/\d\d:\d\d:\d\d\.\d+/],["HH:mm:ss,SSSS",/\d\d:\d\d:\d\d,\d+/],["HH:mm:ss",/\d\d:\d\d:\d\d/],["HH:mm",/\d\d:\d\d/],["HHmmss.SSSS",/\d\d\d\d\d\d\.\d+/],["HHmmss,SSSS",/\d\d\d\d\d\d,\d+/],["HHmmss",/\d\d\d\d\d\d/],["HHmm",/\d\d\d\d/],["HH",/\d\d/]],Ie=/^\/?Date\((\-?\d+)/i;a.createFromInputFallback=x("value provided is not in a recognized ISO format. moment construction falls back to js Date(), which is not reliable across all browsers and versions. Non ISO date formats are discouraged and will be removed in an upcoming major release. Please refer to http://momentjs.com/guides/#/warnings/js-date/ for more info.",function(a){a._d=new Date(a._i+(a._useUTC?" UTC":""))}),
// constant that refers to the ISO standard
a.ISO_8601=function(){};var Je=x("moment().min is deprecated, use moment.max instead. http://momentjs.com/guides/#/warnings/min-max/",function(){var a=sb.apply(null,arguments);return this.isValid()&&a.isValid()?a<this?this:a:o()}),Ke=x("moment().max is deprecated, use moment.min instead. http://momentjs.com/guides/#/warnings/min-max/",function(){var a=sb.apply(null,arguments);return this.isValid()&&a.isValid()?a>this?this:a:o()}),Le=function(){return Date.now?Date.now():+new Date};zb("Z",":"),zb("ZZ",""),
// PARSING
Z("Z",Xd),Z("ZZ",Xd),ba(["Z","ZZ"],function(a,b,c){c._useUTC=!0,c._tzm=Ab(Xd,a)});
// HELPERS
// timezone chunker
// '+10:00' > ['10',  '00']
// '-1530'  > ['-15', '30']
var Me=/([\+\-]|\d\d)/gi;
// HOOKS
// This function will be called whenever a moment is mutated.
// It is intended to keep the offset in sync with the timezone.
a.updateOffset=function(){};
// ASP.NET json date format regex
var Ne=/^(\-)?(?:(\d*)[. ])?(\d+)\:(\d+)(?:\:(\d+)(\.\d*)?)?$/,Oe=/^(-)?P(?:(-?[0-9,.]*)Y)?(?:(-?[0-9,.]*)M)?(?:(-?[0-9,.]*)W)?(?:(-?[0-9,.]*)D)?(?:T(?:(-?[0-9,.]*)H)?(?:(-?[0-9,.]*)M)?(?:(-?[0-9,.]*)S)?)?$/;Ob.fn=wb.prototype;var Pe=Sb(1,"add"),Qe=Sb(-1,"subtract");a.defaultFormat="YYYY-MM-DDTHH:mm:ssZ",a.defaultFormatUtc="YYYY-MM-DDTHH:mm:ss[Z]";var Re=x("moment().lang() is deprecated. Instead, use moment().localeData() to get the language configuration. Use moment().locale() to change languages.",function(a){return void 0===a?this.localeData():this.locale(a)});
// FORMATTING
U(0,["gg",2],0,function(){return this.weekYear()%100}),U(0,["GG",2],0,function(){return this.isoWeekYear()%100}),zc("gggg","weekYear"),zc("ggggg","weekYear"),zc("GGGG","isoWeekYear"),zc("GGGGG","isoWeekYear"),
// ALIASES
J("weekYear","gg"),J("isoWeekYear","GG"),
// PRIORITY
M("weekYear",1),M("isoWeekYear",1),
// PARSING
Z("G",Vd),Z("g",Vd),Z("GG",Od,Kd),Z("gg",Od,Kd),Z("GGGG",Sd,Md),Z("gggg",Sd,Md),Z("GGGGG",Td,Nd),Z("ggggg",Td,Nd),ca(["gggg","ggggg","GGGG","GGGGG"],function(a,b,c,d){b[d.substr(0,2)]=u(a)}),ca(["gg","GG"],function(b,c,d,e){c[e]=a.parseTwoDigitYear(b)}),
// FORMATTING
U("Q",0,"Qo","quarter"),
// ALIASES
J("quarter","Q"),
// PRIORITY
M("quarter",7),
// PARSING
Z("Q",Jd),ba("Q",function(a,b){b[be]=3*(u(a)-1)}),
// FORMATTING
U("D",["DD",2],"Do","date"),
// ALIASES
J("date","D"),
// PRIOROITY
M("date",9),
// PARSING
Z("D",Od),Z("DD",Od,Kd),Z("Do",function(a,b){return a?b._ordinalParse:b._ordinalParseLenient}),ba(["D","DD"],ce),ba("Do",function(a,b){b[ce]=u(a.match(Od)[0],10)});
// MOMENTS
var Se=O("Date",!0);
// FORMATTING
U("DDD",["DDDD",3],"DDDo","dayOfYear"),
// ALIASES
J("dayOfYear","DDD"),
// PRIORITY
M("dayOfYear",4),
// PARSING
Z("DDD",Rd),Z("DDDD",Ld),ba(["DDD","DDDD"],function(a,b,c){c._dayOfYear=u(a)}),
// FORMATTING
U("m",["mm",2],0,"minute"),
// ALIASES
J("minute","m"),
// PRIORITY
M("minute",14),
// PARSING
Z("m",Od),Z("mm",Od,Kd),ba(["m","mm"],ee);
// MOMENTS
var Te=O("Minutes",!1);
// FORMATTING
U("s",["ss",2],0,"second"),
// ALIASES
J("second","s"),
// PRIORITY
M("second",15),
// PARSING
Z("s",Od),Z("ss",Od,Kd),ba(["s","ss"],fe);
// MOMENTS
var Ue=O("Seconds",!1);
// FORMATTING
U("S",0,0,function(){return~~(this.millisecond()/100)}),U(0,["SS",2],0,function(){return~~(this.millisecond()/10)}),U(0,["SSS",3],0,"millisecond"),U(0,["SSSS",4],0,function(){return 10*this.millisecond()}),U(0,["SSSSS",5],0,function(){return 100*this.millisecond()}),U(0,["SSSSSS",6],0,function(){return 1e3*this.millisecond()}),U(0,["SSSSSSS",7],0,function(){return 1e4*this.millisecond()}),U(0,["SSSSSSSS",8],0,function(){return 1e5*this.millisecond()}),U(0,["SSSSSSSSS",9],0,function(){return 1e6*this.millisecond()}),
// ALIASES
J("millisecond","ms"),
// PRIORITY
M("millisecond",16),
// PARSING
Z("S",Rd,Jd),Z("SS",Rd,Kd),Z("SSS",Rd,Ld);var Ve;for(Ve="SSSS";Ve.length<=9;Ve+="S")Z(Ve,Ud);for(Ve="S";Ve.length<=9;Ve+="S")ba(Ve,Ic);
// MOMENTS
var We=O("Milliseconds",!1);
// FORMATTING
U("z",0,0,"zoneAbbr"),U("zz",0,0,"zoneName");var Xe=r.prototype;Xe.add=Pe,Xe.calendar=Vb,Xe.clone=Wb,Xe.diff=bc,Xe.endOf=oc,Xe.format=gc,Xe.from=hc,Xe.fromNow=ic,Xe.to=jc,Xe.toNow=kc,Xe.get=R,Xe.invalidAt=xc,Xe.isAfter=Xb,Xe.isBefore=Yb,Xe.isBetween=Zb,Xe.isSame=$b,Xe.isSameOrAfter=_b,Xe.isSameOrBefore=ac,Xe.isValid=vc,Xe.lang=Re,Xe.locale=lc,Xe.localeData=mc,Xe.max=Ke,Xe.min=Je,Xe.parsingFlags=wc,Xe.set=S,Xe.startOf=nc,Xe.subtract=Qe,Xe.toArray=sc,Xe.toObject=tc,Xe.toDate=rc,Xe.toISOString=ec,Xe.inspect=fc,Xe.toJSON=uc,Xe.toString=dc,Xe.unix=qc,Xe.valueOf=pc,Xe.creationData=yc,
// Year
Xe.year=pe,Xe.isLeapYear=ra,
// Week Year
Xe.weekYear=Ac,Xe.isoWeekYear=Bc,
// Quarter
Xe.quarter=Xe.quarters=Gc,
// Month
Xe.month=ka,Xe.daysInMonth=la,
// Week
Xe.week=Xe.weeks=Ba,Xe.isoWeek=Xe.isoWeeks=Ca,Xe.weeksInYear=Dc,Xe.isoWeeksInYear=Cc,
// Day
Xe.date=Se,Xe.day=Xe.days=Ka,Xe.weekday=La,Xe.isoWeekday=Ma,Xe.dayOfYear=Hc,
// Hour
Xe.hour=Xe.hours=ze,
// Minute
Xe.minute=Xe.minutes=Te,
// Second
Xe.second=Xe.seconds=Ue,
// Millisecond
Xe.millisecond=Xe.milliseconds=We,
// Offset
Xe.utcOffset=Db,Xe.utc=Fb,Xe.local=Gb,Xe.parseZone=Hb,Xe.hasAlignedHourOffset=Ib,Xe.isDST=Jb,Xe.isLocal=Lb,Xe.isUtcOffset=Mb,Xe.isUtc=Nb,Xe.isUTC=Nb,
// Timezone
Xe.zoneAbbr=Jc,Xe.zoneName=Kc,
// Deprecations
Xe.dates=x("dates accessor is deprecated. Use date instead.",Se),Xe.months=x("months accessor is deprecated. Use month instead",ka),Xe.years=x("years accessor is deprecated. Use year instead",pe),Xe.zone=x("moment().zone is deprecated, use moment().utcOffset instead. http://momentjs.com/guides/#/warnings/zone/",Eb),Xe.isDSTShifted=x("isDSTShifted is deprecated. See http://momentjs.com/guides/#/warnings/dst-shifted/ for more information",Kb);var Ye=C.prototype;Ye.calendar=D,Ye.longDateFormat=E,Ye.invalidDate=F,Ye.ordinal=G,Ye.preparse=Nc,Ye.postformat=Nc,Ye.relativeTime=H,Ye.pastFuture=I,Ye.set=A,
// Month
Ye.months=fa,Ye.monthsShort=ga,Ye.monthsParse=ia,Ye.monthsRegex=na,Ye.monthsShortRegex=ma,
// Week
Ye.week=ya,Ye.firstDayOfYear=Aa,Ye.firstDayOfWeek=za,
// Day of Week
Ye.weekdays=Fa,Ye.weekdaysMin=Ha,Ye.weekdaysShort=Ga,Ye.weekdaysParse=Ja,Ye.weekdaysRegex=Na,Ye.weekdaysShortRegex=Oa,Ye.weekdaysMinRegex=Pa,
// Hours
Ye.isPM=Va,Ye.meridiem=Wa,$a("en",{ordinalParse:/\d{1,2}(th|st|nd|rd)/,ordinal:function(a){var b=a%10,c=1===u(a%100/10)?"th":1===b?"st":2===b?"nd":3===b?"rd":"th";return a+c}}),
// Side effect imports
a.lang=x("moment.lang is deprecated. Use moment.locale instead.",$a),a.langData=x("moment.langData is deprecated. Use moment.localeData instead.",bb);var Ze=Math.abs,$e=ed("ms"),_e=ed("s"),af=ed("m"),bf=ed("h"),cf=ed("d"),df=ed("w"),ef=ed("M"),ff=ed("y"),gf=gd("milliseconds"),hf=gd("seconds"),jf=gd("minutes"),kf=gd("hours"),lf=gd("days"),mf=gd("months"),nf=gd("years"),of=Math.round,pf={s:45,// seconds to minute
m:45,// minutes to hour
h:22,// hours to day
d:26,// days to month
M:11},qf=Math.abs,rf=wb.prototype;
// Deprecations
// Side effect imports
// FORMATTING
// PARSING
// Side effect imports
return rf.abs=Wc,rf.add=Yc,rf.subtract=Zc,rf.as=cd,rf.asMilliseconds=$e,rf.asSeconds=_e,rf.asMinutes=af,rf.asHours=bf,rf.asDays=cf,rf.asWeeks=df,rf.asMonths=ef,rf.asYears=ff,rf.valueOf=dd,rf._bubble=_c,rf.get=fd,rf.milliseconds=gf,rf.seconds=hf,rf.minutes=jf,rf.hours=kf,rf.days=lf,rf.weeks=hd,rf.months=mf,rf.years=nf,rf.humanize=md,rf.toISOString=nd,rf.toString=nd,rf.toJSON=nd,rf.locale=lc,rf.localeData=mc,rf.toIsoString=x("toIsoString() is deprecated. Please use toISOString() instead (notice the capitals)",nd),rf.lang=Re,U("X",0,0,"unix"),U("x",0,0,"valueOf"),Z("x",Vd),Z("X",Yd),ba("X",function(a,b,c){c._d=new Date(1e3*parseFloat(a,10))}),ba("x",function(a,b,c){c._d=new Date(u(a))}),a.version="2.16.0",b(sb),a.fn=Xe,a.min=ub,a.max=vb,a.now=Le,a.utc=k,a.unix=Lc,a.months=Rc,a.isDate=g,a.locale=$a,a.invalid=o,a.duration=Ob,a.isMoment=s,a.weekdays=Tc,a.parseZone=Mc,a.localeData=bb,a.isDuration=xb,a.monthsShort=Sc,a.weekdaysMin=Vc,a.defineLocale=_a,a.updateLocale=ab,a.locales=cb,a.weekdaysShort=Uc,a.normalizeUnits=K,a.relativeTimeRounding=kd,a.relativeTimeThreshold=ld,a.calendarFormat=Ub,a.prototype=Xe,a});// jquery.daterangepicker.js
// author : Chunlong Liu
// license : MIT
// www.jszen.com

(function(factory) {
    if (typeof define === 'function' && define.amd) {
        // AMD. Register as an anonymous module.
        define(['jquery', 'moment'], factory);
    } else if (typeof exports === 'object' && typeof module !== 'undefined') {
        // CommonJS. Register as a module
        module.exports = factory(require('jquery'), require('moment'));
    } else {
        // Browser globals
        factory(jQuery, moment);
    }
}(function($, moment) {
    'use strict';
    $.dateRangePickerLanguages = {
        "default": //default language: English
        {
            "selected": "Selected:",
            "day": "Day",
            "days": "Days",
            "apply": "Close",
            "week-1": "mo",
            "week-2": "tu",
            "week-3": "we",
            "week-4": "th",
            "week-5": "fr",
            "week-6": "sa",
            "week-7": "su",
            "week-number": "W",
            "month-name": ["january", "february", "march", "april", "may", "june", "july", "august", "september", "october", "november", "december"],
            "shortcuts": "Shortcuts",
            "custom-values": "Custom Values",
            "past": "Past",
            "following": "Following",
            "previous": "Previous",
            "prev-week": "Week",
            "prev-month": "Month",
            "prev-year": "Year",
            "next": "Next",
            "next-week": "Week",
            "next-month": "Month",
            "next-year": "Year",
            "less-than": "Date range should not be more than %d days",
            "more-than": "Date range should not be less than %d days",
            "default-more": "Please select a date range longer than %d days",
            "default-single": "Please select a date",
            "default-less": "Please select a date range less than %d days",
            "default-range": "Please select a date range between %d and %d days",
            "default-default": "Please select a date range",
            "time": "Time",
            "hour": "Hour",
            "minute": "Minute"
        },
        "id": {
            "selected": "Terpilih:",
            "day": "Hari",
            "days": "Hari",
            "apply": "Tutup",
            "week-1": "sen",
            "week-2": "sel",
            "week-3": "rab",
            "week-4": "kam",
            "week-5": "jum",
            "week-6": "sab",
            "week-7": "min",
            "week-number": "W",
            "month-name": ["januari", "februari", "maret", "april", "mei", "juni", "juli", "agustus", "september", "oktober", "november", "desember"],
            "shortcuts": "Pintas",
            "custom-values": "Nilai yang ditentukan",
            "past": "Yang Lalu",
            "following": "Mengikuti",
            "previous": "Sebelumnya",
            "prev-week": "Minggu",
            "prev-month": "Bulan",
            "prev-year": "Tahun",
            "next": "Selanjutnya",
            "next-week": "Minggu",
            "next-month": "Bulan",
            "next-year": "Tahun",
            "less-than": "Tanggal harus lebih dari %d hari",
            "more-than": "Tanggal harus kurang dari %d hari",
            "default-more": "Jarak tanggal harus lebih lama dari %d hari",
            "default-single": "Silakan pilih tanggal",
            "default-less": "Jarak rentang tanggal tidak boleh lebih lama dari %d hari",
            "default-range": "Rentang tanggal harus antara %d dan %d hari",
            "default-default": "Silakan pilih rentang tanggal",
            "time": "Waktu",
            "hour": "Jam",
            "minute": "Menit"
        },
        "az": {
            "selected": "Seçildi:",
            "day": " gün",
            "days": " gün",
            "apply": "tətbiq",
            "week-1": "1",
            "week-2": "2",
            "week-3": "3",
            "week-4": "4",
            "week-5": "5",
            "week-6": "6",
            "week-7": "7",
            "month-name": ["yanvar", "fevral", "mart", "aprel", "may", "iyun", "iyul", "avqust", "sentyabr", "oktyabr", "noyabr", "dekabr"],
            "shortcuts": "Qısayollar",
            "past": "Keçmiş",
            "following": "Növbəti",
            "previous": "&nbsp;&nbsp;&nbsp;",
            "prev-week": "Öncəki həftə",
            "prev-month": "Öncəki ay",
            "prev-year": "Öncəki il",
            "next": "&nbsp;&nbsp;&nbsp;",
            "next-week": "Növbəti həftə",
            "next-month": "Növbəti ay",
            "next-year": "Növbəti il",
            "less-than": "Tarix aralığı %d gündən çox olmamalıdır",
            "more-than": "Tarix aralığı %d gündən az olmamalıdır",
            "default-more": "%d gündən çox bir tarix seçin",
            "default-single": "Tarix seçin",
            "default-less": "%d gündən az bir tarix seçin",
            "default-range": "%d və %d gün aralığında tarixlər seçin",
            "default-default": "Tarix aralığı seçin"
        },
        "bg": {
            "selected": "Избрано:",
            "day": "Ден",
            "days": "Дни",
            "apply": "Затвори",
            "week-1": "пн",
            "week-2": "вт",
            "week-3": "ср",
            "week-4": "чт",
            "week-5": "пт",
            "week-6": "сб",
            "week-7": "нд",
            "week-number": "С",
            "month-name": ["януари", "февруари", "март", "април", "май", "юни", "юли", "август", "септември", "октомври", "ноември", "декември"],
            "shortcuts": "Преки пътища",
            "custom-values": "Персонализирани стойности",
            "past": "Минал",
            "following": "Следващ",
            "previous": "Предишен",
            "prev-week": "Седмица",
            "prev-month": "Месец",
            "prev-year": "Година",
            "next": "Следващ",
            "next-week": "Седмица",
            "next-month": "Месец",
            "next-year": "Година",
            "less-than": "Периодът от време не трябва да е повече от %d дни",
            "more-than": "Периодът от време не трябва да е по-малко от %d дни",
            "default-more": "Моля изберете период по-дълъг от %d дни",
            "default-single": "Моля изберете дата",
            "default-less": "Моля изберете период по-къс от %d дни",
            "default-range": "Моля изберете период между %d и %d дни",
            "default-default": "Моля изберете период",
            "time": "Време",
            "hour": "Час",
            "minute": "Минута"
        },
        "cn": //simplified chinese
        {
            "selected": "已选择:",
            "day": "天",
            "days": "天",
            "apply": "确定",
            "week-1": "一",
            "week-2": "二",
            "week-3": "三",
            "week-4": "四",
            "week-5": "五",
            "week-6": "六",
            "week-7": "日",
            "week-number": "周",
            "month-name": ["一月", "二月", "三月", "四月", "五月", "六月", "七月", "八月", "九月", "十月", "十一月", "十二月"],
            "shortcuts": "快捷选择",
            "past": "过去",
            "following": "将来",
            "previous": "&nbsp;&nbsp;&nbsp;",
            "prev-week": "上周",
            "prev-month": "上个月",
            "prev-year": "去年",
            "next": "&nbsp;&nbsp;&nbsp;",
            "next-week": "下周",
            "next-month": "下个月",
            "next-year": "明年",
            "less-than": "所选日期范围不能大于%d天",
            "more-than": "所选日期范围不能小于%d天",
            "default-more": "请选择大于%d天的日期范围",
            "default-less": "请选择小于%d天的日期范围",
            "default-range": "请选择%d天到%d天的日期范围",
            "default-single": "请选择一个日期",
            "default-default": "请选择一个日期范围",
            "time": "时间",
            "hour": "小时",
            "minute": "分钟"
        },
        "cz": {
            "selected": "Vybráno:",
            "day": "Den",
            "days": "Dny",
            "apply": "Zavřít",
            "week-1": "po",
            "week-2": "út",
            "week-3": "st",
            "week-4": "čt",
            "week-5": "pá",
            "week-6": "so",
            "week-7": "ne",
            "month-name": ["leden", "únor", "březen", "duben", "květen", "červen", "červenec", "srpen", "září", "říjen", "listopad", "prosinec"],
            "shortcuts": "Zkratky",
            "past": "po",
            "following": "následující",
            "previous": "předchozí",
            "prev-week": "týden",
            "prev-month": "měsíc",
            "prev-year": "rok",
            "next": "další",
            "next-week": "týden",
            "next-month": "měsíc",
            "next-year": "rok",
            "less-than": "Rozsah data by neměl být větší než %d dnů",
            "more-than": "Rozsah data by neměl být menší než %d dnů",
            "default-more": "Prosím zvolte rozsah data větší než %d dnů",
            "default-single": "Prosím zvolte datum",
            "default-less": "Prosím zvolte rozsah data menší než %d dnů",
            "default-range": "Prosím zvolte rozsah data mezi %d a %d dny",
            "default-default": "Prosím zvolte rozsah data"
        },
        "de": {
            "selected": "Auswahl:",
            "day": "Tag",
            "days": "Tage",
            "apply": "Schließen",
            "week-1": "mo",
            "week-2": "di",
            "week-3": "mi",
            "week-4": "do",
            "week-5": "fr",
            "week-6": "sa",
            "week-7": "so",
            "month-name": ["januar", "februar", "märz", "april", "mai", "juni", "juli", "august", "september", "oktober", "november", "dezember"],
            "shortcuts": "Schnellwahl",
            "past": "Vorherige",
            "following": "Folgende",
            "previous": "Vorherige",
            "prev-week": "Woche",
            "prev-month": "Monat",
            "prev-year": "Jahr",
            "next": "Nächste",
            "next-week": "Woche",
            "next-month": "Monat",
            "next-year": "Jahr",
            "less-than": "Datumsbereich darf nicht größer sein als %d Tage",
            "more-than": "Datumsbereich darf nicht kleiner sein als %d Tage",
            "default-more": "Bitte mindestens %d Tage auswählen",
            "default-single": "Bitte ein Datum auswählen",
            "default-less": "Bitte weniger als %d Tage auswählen",
            "default-range": "Bitte einen Datumsbereich zwischen %d und %d Tagen auswählen",
            "default-default": "Bitte ein Start- und Enddatum auswählen",
            "Time": "Zeit",
            "hour": "Stunde",
            "minute": "Minute"
        },
        "es": {
            "selected": "Seleccionado:",
            "day": "Día",
            "days": "Días",
            "apply": "Cerrar",
            "week-1": "lu",
            "week-2": "ma",
            "week-3": "mi",
            "week-4": "ju",
            "week-5": "vi",
            "week-6": "sa",
            "week-7": "do",
            "month-name": ["enero", "febrero", "marzo", "abril", "mayo", "junio", "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre"],
            "shortcuts": "Accesos directos",
            "past": "Pasado",
            "following": "Siguiente",
            "previous": "Anterior",
            "prev-week": "Semana",
            "prev-month": "Mes",
            "prev-year": "Año",
            "next": "Siguiente",
            "next-week": "Semana",
            "next-month": "Mes",
            "next-year": "Año",
            "less-than": "El rango no debería ser mayor de %d días",
            "more-than": "El rango no debería ser menor de %d días",
            "default-more": "Por favor selecciona un rango mayor a %d días",
            "default-single": "Por favor selecciona un día",
            "default-less": "Por favor selecciona un rango menor a %d días",
            "default-range": "Por favor selecciona un rango entre %d y %d días",
            "default-default": "Por favor selecciona un rango de fechas."
        },
        "fr": {
            "selected": "Sélection:",
            "day": "Jour",
            "days": "Jours",
            "apply": "Fermer",
            "week-1": "lu",
            "week-2": "ma",
            "week-3": "me",
            "week-4": "je",
            "week-5": "ve",
            "week-6": "sa",
            "week-7": "di",
            "month-name": ["janvier", "février", "mars", "avril", "mai", "juin", "juillet", "août", "septembre", "octobre", "novembre", "décembre"],
            "shortcuts": "Raccourcis",
            "past": "Passé",
            "following": "Suivant",
            "previous": "Précédent",
            "prev-week": "Semaine",
            "prev-month": "Mois",
            "prev-year": "Année",
            "next": "Suivant",
            "next-week": "Semaine",
            "next-month": "Mois",
            "next-year": "Année",
            "less-than": "L'intervalle ne doit pas être supérieure à %d jours",
            "more-than": "L'intervalle ne doit pas être inférieure à %d jours",
            "default-more": "Merci de choisir une intervalle supérieure à %d jours",
            "default-single": "Merci de choisir une date",
            "default-less": "Merci de choisir une intervalle inférieure %d jours",
            "default-range": "Merci de choisir une intervalle comprise entre %d et %d jours",
            "default-default": "Merci de choisir une date"
        },
        "hu": {
            "selected": "Kiválasztva:",
            "day": "Nap",
            "days": "Nap",
            "apply": "Ok",
            "week-1": "h",
            "week-2": "k",
            "week-3": "sz",
            "week-4": "cs",
            "week-5": "p",
            "week-6": "sz",
            "week-7": "v",
            "month-name": ["január", "február", "március", "április", "május", "június", "július", "augusztus", "szeptember", "október", "november", "december"],
            "shortcuts": "Gyorsválasztó",
            "past": "Múlt",
            "following": "Következő",
            "previous": "Előző",
            "prev-week": "Hét",
            "prev-month": "Hónap",
            "prev-year": "Év",
            "next": "Következő",
            "next-week": "Hét",
            "next-month": "Hónap",
            "next-year": "Év",
            "less-than": "A kiválasztás nem lehet több %d napnál",
            "more-than": "A kiválasztás nem lehet több %d napnál",
            "default-more": "Válassz ki egy időszakot ami hosszabb mint %d nap",
            "default-single": "Válassz egy napot",
            "default-less": "Válassz ki egy időszakot ami rövidebb mint %d nap",
            "default-range": "Válassz ki egy %d - %d nap hosszú időszakot",
            "default-default": "Válassz ki egy időszakot"
        },
        "it": {
            "selected": "Selezionati:",
            "day": "Giorno",
            "days": "Giorni",
            "apply": "Chiudi",
            "week-1": "lu",
            "week-2": "ma",
            "week-3": "me",
            "week-4": "gi",
            "week-5": "ve",
            "week-6": "sa",
            "week-7": "do",
            "month-name": ["gennaio", "febbraio", "marzo", "aprile", "maggio", "giugno", "luglio", "agosto", "settembre", "ottobre", "novembre", "dicembre"],
            "shortcuts": "Scorciatoie",
            "past": "Scorso",
            "following": "Successivo",
            "previous": "Precedente",
            "prev-week": "Settimana",
            "prev-month": "Mese",
            "prev-year": "Anno",
            "next": "Prossimo",
            "next-week": "Settimana",
            "next-month": "Mese",
            "next-year": "Anno",
            "less-than": "L'intervallo non dev'essere maggiore di %d giorni",
            "more-than": "L'intervallo non dev'essere minore di %d giorni",
            "default-more": "Seleziona un intervallo maggiore di %d giorni",
            "default-single": "Seleziona una data",
            "default-less": "Seleziona un intervallo minore di %d giorni",
            "default-range": "Seleziona un intervallo compreso tra i %d e i %d giorni",
            "default-default": "Seleziona un intervallo di date"
        },
        "ko": {
            "selected": "기간:",
            "day": "일",
            "days": "일간",
            "apply": "닫기",
            "week-1": "월",
            "week-2": "화",
            "week-3": "수",
            "week-4": "목",
            "week-5": "금",
            "week-6": "토",
            "week-7": "일",
            "week-number": "주",
            "month-name": ["1월", "2월", "3월", "4월", "5월", "6월", "7월", "8월", "9월", "10월", "11월", "12월"],
            "shortcuts": "단축키들",
            "past": "지난(오늘기준)",
            "following": "이후(오늘기준)",
            "previous": "이전",
            "prev-week": "1주",
            "prev-month": "1달",
            "prev-year": "1년",
            "next": "다음",
            "next-week": "1주",
            "next-month": "1달",
            "next-year": "1년",
            "less-than": "날짜 범위는 %d 일보다 많을 수 없습니다",
            "more-than": "날짜 범위는 %d 일보다 작을 수 없습니다",
            "default-more": "날짜 범위를 %d 일보다 길게 선택해 주세요",
            "default-single": "날짜를 선택해 주세요",
            "default-less": "%d 일보다 작은 날짜를 선택해 주세요",
            "default-range": "%d와 %d 일 사이의 날짜 범위를 선택해 주세요",
            "default-default": "날짜 범위를 선택해 주세요",
            "time": "시각",
            "hour": "시",
            "minute": "분"
        },
        "no": {
            "selected": "Valgt:",
            "day": "Dag",
            "days": "Dager",
            "apply": "Lukk",
            "week-1": "ma",
            "week-2": "ti",
            "week-3": "on",
            "week-4": "to",
            "week-5": "fr",
            "week-6": "lø",
            "week-7": "sø",
            "month-name": ["januar", "februar", "mars", "april", "mai", "juni", "juli", "august", "september", "oktober", "november", "desember"],
            "shortcuts": "Snarveier",
            "custom-values": "Egendefinerte Verdier",
            "past": "Over", // Not quite sure about the context of this one
            "following": "Følger",
            "previous": "Forrige",
            "prev-week": "Uke",
            "prev-month": "Måned",
            "prev-year": "År",
            "next": "Neste",
            "next-week": "Uke",
            "next-month": "Måned",
            "next-year": "År",
            "less-than": "Datoperioden skal ikkje være lengre enn %d dager",
            "more-than": "Datoperioden skal ikkje være kortere enn %d dager",
            "default-more": "Vennligst velg ein datoperiode lengre enn %d dager",
            "default-single": "Vennligst velg ein dato",
            "default-less": "Vennligst velg ein datoperiode mindre enn %d dager",
            "default-range": "Vennligst velg ein datoperiode mellom %d og %d dager",
            "default-default": "Vennligst velg ein datoperiode",
            "time": "Tid",
            "hour": "Time",
            "minute": "Minutter"
        },
        "nl": {
            "selected": "Geselecteerd:",
            "day": "Dag",
            "days": "Dagen",
            "apply": "Ok",
            "week-1": "ma",
            "week-2": "di",
            "week-3": "wo",
            "week-4": "do",
            "week-5": "vr",
            "week-6": "za",
            "week-7": "zo",
            "month-name": ["januari", "februari", "maart", "april", "mei", "juni", "juli", "augustus", "september", "oktober", "november", "december"],
            "shortcuts": "Snelkoppelingen",
            "custom-values": "Aangepaste waarden",
            "past": "Verleden",
            "following": "Komend",
            "previous": "Vorige",
            "prev-week": "Week",
            "prev-month": "Maand",
            "prev-year": "Jaar",
            "next": "Volgende",
            "next-week": "Week",
            "next-month": "Maand",
            "next-year": "Jaar",
            "less-than": "Interval moet langer dan %d dagen zijn",
            "more-than": "Interval mag niet minder dan %d dagen zijn",
            "default-more": "Selecteer een interval langer dan %dagen",
            "default-single": "Selecteer een datum",
            "default-less": "Selecteer een interval minder dan %d dagen",
            "default-range": "Selecteer een interval tussen %d en %d dagen",
            "default-default": "Selecteer een interval",
            "time": "Tijd",
            "hour": "Uur",
            "minute": "Minuut"
        },
        "ru": {
            "selected": "Выбрано:",
            "day": "День",
            "days": "Дней",
            "apply": "Применить",
            "week-1": "пн",
            "week-2": "вт",
            "week-3": "ср",
            "week-4": "чт",
            "week-5": "пт",
            "week-6": "сб",
            "week-7": "вс",
            "month-name": ["январь", "февраль", "март", "апрель", "май", "июнь", "июль", "август", "сентябрь", "октябрь", "ноябрь", "декабрь"],
            "shortcuts": "Быстрый выбор",
            "custom-values": "Пользовательские значения",
            "past": "Прошедшие",
            "following": "Следующие",
            "previous": "&nbsp;&nbsp;&nbsp;",
            "prev-week": "Неделя",
            "prev-month": "Месяц",
            "prev-year": "Год",
            "next": "&nbsp;&nbsp;&nbsp;",
            "next-week": "Неделя",
            "next-month": "Месяц",
            "next-year": "Год",
            "less-than": "Диапазон не может быть больше %d дней",
            "more-than": "Диапазон не может быть меньше %d дней",
            "default-more": "Пожалуйста выберите диапазон больше %d дней",
            "default-single": "Пожалуйста выберите дату",
            "default-less": "Пожалуйста выберите диапазон меньше %d дней",
            "default-range": "Пожалуйста выберите диапазон между %d и %d днями",
            "default-default": "Пожалуйста выберите диапазон",
            "time": "Время",
            "hour": "Часы",
            "minute": "Минуты"
        },
        "pl": {
            "selected": "Wybrany:",
            "day": "Dzień",
            "days": "Dni",
            "apply": "Zamknij",
            "week-1": "pon",
            "week-2": "wt",
            "week-3": "śr",
            "week-4": "czw",
            "week-5": "pt",
            "week-6": "so",
            "week-7": "nd",
            "month-name": ["styczeń", "luty", "marzec", "kwiecień", "maj", "czerwiec", "lipiec", "sierpień", "wrzesień", "październik", "listopad", "grudzień"],
            "shortcuts": "Skróty",
            "custom-values": "Niestandardowe wartości",
            "past": "Przeszłe",
            "following": "Następne",
            "previous": "Poprzednie",
            "prev-week": "tydzień",
            "prev-month": "miesiąc",
            "prev-year": "rok",
            "next": "Następny",
            "next-week": "tydzień",
            "next-month": "miesiąc",
            "next-year": "rok",
            "less-than": "Okres nie powinien być dłuższy niż %d dni",
            "more-than": "Okres nie powinien być krótszy niż  %d ni",
            "default-more": "Wybierz okres dłuższy niż %d dni",
            "default-single": "Wybierz datę",
            "default-less": "Wybierz okres krótszy niż %d dni",
            "default-range": "Wybierz okres trwający od %d do %d dni",
            "default-default": "Wybierz okres",
            "time": "Czas",
            "hour": "Godzina",
            "minute": "Minuta"
        },
        "se": {
            "selected": "Vald:",
            "day": "dag",
            "days": "dagar",
            "apply": "godkänn",
            "week-1": "ma",
            "week-2": "ti",
            "week-3": "on",
            "week-4": "to",
            "week-5": "fr",
            "week-6": "lö",
            "week-7": "sö",
            "month-name": ["januari", "februari", "mars", "april", "maj", "juni", "juli", "augusti", "september", "oktober", "november", "december"],
            "shortcuts": "genvägar",
            "custom-values": "Anpassade värden",
            "past": "över",
            "following": "följande",
            "previous": "förra",
            "prev-week": "vecka",
            "prev-month": "månad",
            "prev-year": "år",
            "next": "nästa",
            "next-week": "vecka",
            "next-month": "måned",
            "next-year": "år",
            "less-than": "Datumintervall bör inte vara mindre än %d dagar",
            "more-than": "Datumintervall bör inte vara mer än %d dagar",
            "default-more": "Välj ett datumintervall längre än %d dagar",
            "default-single": "Välj ett datum",
            "default-less": "Välj ett datumintervall mindre än %d dagar",
            "default-range": "Välj ett datumintervall mellan %d och %d dagar",
            "default-default": "Välj ett datumintervall",
            "time": "tid",
            "hour": "timme",
            "minute": "minut"
        },
        "pt": //Portuguese (European)
        {
            "selected": "Selecionado:",
            "day": "Dia",
            "days": "Dias",
            "apply": "Fechar",
            "week-1": "seg",
            "week-2": "ter",
            "week-3": "qua",
            "week-4": "qui",
            "week-5": "sex",
            "week-6": "sab",
            "week-7": "dom",
            "week-number": "N",
            "month-name": ["janeiro", "fevereiro", "março", "abril", "maio", "junho", "julho", "agosto", "setembro", "outubro", "novembro", "dezembro"],
            "shortcuts": "Atalhos",
            "custom-values": "Valores Personalizados",
            "past": "Passado",
            "following": "Seguinte",
            "previous": "Anterior",
            "prev-week": "Semana",
            "prev-month": "Mês",
            "prev-year": "Ano",
            "next": "Próximo",
            "next-week": "Próxima Semana",
            "next-month": "Próximo Mês",
            "next-year": "Próximo Ano",
            "less-than": "O período selecionado não deve ser maior que %d dias",
            "more-than": "O período selecionado não deve ser menor que %d dias",
            "default-more": "Selecione um período superior a %d dias",
            "default-single": "Selecione uma data",
            "default-less": "Selecione um período inferior a %d dias",
            "default-range": "Selecione um período de %d a %d dias",
            "default-default": "Selecione um período",
            "time": "Tempo",
            "hour": "Hora",
            "minute": "Minuto"
        },
        "tc": // traditional chinese
        {
            "selected": "已選擇:",
            "day": "天",
            "days": "天",
            "apply": "確定",
            "week-1": "一",
            "week-2": "二",
            "week-3": "三",
            "week-4": "四",
            "week-5": "五",
            "week-6": "六",
            "week-7": "日",
            "week-number": "周",
            "month-name": ["一月", "二月", "三月", "四月", "五月", "六月", "七月", "八月", "九月", "十月", "十一月", "十二月"],
            "shortcuts": "快速選擇",
            "past": "過去",
            "following": "將來",
            "previous": "&nbsp;&nbsp;&nbsp;",
            "prev-week": "上週",
            "prev-month": "上個月",
            "prev-year": "去年",
            "next": "&nbsp;&nbsp;&nbsp;",
            "next-week": "下周",
            "next-month": "下個月",
            "next-year": "明年",
            "less-than": "所選日期範圍不能大於%d天",
            "more-than": "所選日期範圍不能小於%d天",
            "default-more": "請選擇大於%d天的日期範圍",
            "default-less": "請選擇小於%d天的日期範圍",
            "default-range": "請選擇%d天到%d天的日期範圍",
            "default-single": "請選擇一個日期",
            "default-default": "請選擇一個日期範圍",
            "time": "日期",
            "hour": "小時",
            "minute": "分鐘"
        },
        "ja": {
            "selected": "選択しました:",
            "day": "日",
            "days": "日々",
            "apply": "閉じる",
            "week-1": "月",
            "week-2": "火",
            "week-3": "水",
            "week-4": "木",
            "week-5": "金",
            "week-6": "土",
            "week-7": "日",
            "month-name": ["1月", "2月", "3月", "4月", "5月", "6月", "7月", "8月", "9月", "10月", "11月", "12月"],
            "shortcuts": "クイック選択",
            "past": "過去",
            "following": "将来",
            "previous": "&nbsp;&nbsp;&nbsp;",
            "prev-week": "先週、",
            "prev-month": "先月",
            "prev-year": "昨年",
            "next": "&nbsp;&nbsp;&nbsp;",
            "next-week": "来週",
            "next-month": "来月",
            "next-year": "来年",
            "less-than": "日付の範囲は ％d 日以上にすべきではありません",
            "more-than": "日付の範囲は ％d 日を下回ってはいけません",
            "default-more": "％d 日よりも長い期間を選択してください",
            "default-less": "％d 日未満の期間を選択してください",
            "default-range": "％d と％ d日の間の日付範囲を選択してください",
            "default-single": "日付を選択してください",
            "default-default": "日付範囲を選択してください",
            "time": "時間",
            "hour": "時間",
            "minute": "分"
        },
        "da": {
            "selected": "Valgt:",
            "day": "Dag",
            "days": "Dage",
            "apply": "Luk",
            "week-1": "ma",
            "week-2": "ti",
            "week-3": "on",
            "week-4": "to",
            "week-5": "fr",
            "week-6": "lö",
            "week-7": "sö",
            "month-name": ["januar", "februar", "marts", "april", "maj", "juni", "juli", "august", "september", "oktober", "november", "december"],
            "shortcuts": "genveje",
            "custom-values": "Brugerdefinerede værdier",
            "past": "Forbi",
            "following": "Følgende",
            "previous": "Forrige",
            "prev-week": "uge",
            "prev-month": "månad",
            "prev-year": "år",
            "next": "Næste",
            "next-week": "Næste uge",
            "next-month": "Næste måned",
            "next-year": "Næste år",
            "less-than": "Dato interval bør ikke være med end %d dage",
            "more-than": "Dato interval bør ikke være mindre end %d dage",
            "default-more": "Vælg datointerval længere end %d dage",
            "default-single": "Vælg dato",
            "default-less": "Vælg datointerval mindre end %d dage",
            "default-range": "Vælg datointerval mellem %d og %d dage",
            "default-default": "Vælg datointerval",
            "time": "tid",
            "hour": "time",
            "minute": "minut"
        },
        "fi": // Finnish
        {
            "selected": "Valittu:",
            "day": "Päivä",
            "days": "Päivää",
            "apply": "Sulje",
            "week-1": "ma",
            "week-2": "ti",
            "week-3": "ke",
            "week-4": "to",
            "week-5": "pe",
            "week-6": "la",
            "week-7": "su",
            "week-number": "V",
            "month-name": ["tammikuu", "helmikuu", "maaliskuu", "huhtikuu", "toukokuu", "kesäkuu", "heinäkuu", "elokuu", "syyskuu", "lokakuu", "marraskuu", "joulukuu"],
            "shortcuts": "Pikavalinnat",
            "custom-values": "Mukautetut Arvot",
            "past": "Menneet",
            "following": "Tulevat",
            "previous": "Edellinen",
            "prev-week": "Viikko",
            "prev-month": "Kuukausi",
            "prev-year": "Vuosi",
            "next": "Seuraava",
            "next-week": "Viikko",
            "next-month": "Kuukausi",
            "next-year": "Vuosi",
            "less-than": "Aikajakson tulisi olla vähemmän kuin %d päivää",
            "more-than": "Aikajakson ei tulisi olla vähempää kuin %d päivää",
            "default-more": "Valitse pidempi aikajakso kuin %d päivää",
            "default-single": "Valitse päivä",
            "default-less": "Valitse lyhyempi aikajakso kuin %d päivää",
            "default-range": "Valitse aikajakso %d ja %d päivän väliltä",
            "default-default": "Valitse aikajakso",
            "time": "Aika",
            "hour": "Tunti",
            "minute": "Minuutti"
        },
        "cat": // Catala
        {
            "selected": "Seleccionats:",
            "day": "Dia",
            "days": "Dies",
            "apply": "Tanca",
            "week-1": "Dl",
            "week-2": "Dm",
            "week-3": "Dc",
            "week-4": "Dj",
            "week-5": "Dv",
            "week-6": "Ds",
            "week-7": "Dg",
            "week-number": "S",
            "month-name": ["gener", "febrer", "març", "abril", "maig", "juny", "juliol", "agost", "setembre", "octubre", "novembre", "desembre"],
            "shortcuts": "Dreçeres",
            "custom-values": "Valors personalitzats",
            "past": "Passat",
            "following": "Futur",
            "previous": "Anterior",
            "prev-week": "Setmana",
            "prev-month": "Mes",
            "prev-year": "Any",
            "next": "Següent",
            "next-week": "Setmana",
            "next-month": "Mes",
            "next-year": "Any",
            "less-than": "El període no hauria de ser de més de %d dies",
            "more-than": "El període no hauria de ser de menys de %d dies",
            "default-more": "Perfavor selecciona un període més gran de %d dies",
            "default-single": "Perfavor selecciona una data",
            "default-less": "Perfavor selecciona un període de menys de %d dies",
            "default-range": "Perfavor selecciona un període d'entre %d i %d dies",
            "default-default": "Perfavor selecciona un període",
            "time": "Temps",
            "hour": "Hora",
            "minute": "Minut"
        }
    };

    $.fn.dateRangePicker = function(opt) {
        if (!opt) opt = {};
        opt = $.extend(true, {
            autoClose: false,
            format: 'YYYY-MM-DD',
            separator: ' to ',
            language: 'auto',
            startOfWeek: 'sunday', // or monday
            getValue: function() {
                return $(this).val();
            },
            setValue: function(s) {
                if (!$(this).attr('readonly') && !$(this).is(':disabled') && s != $(this).val()) {
                    $(this).val(s);
                }
            },
            onSelect: null,
            startDate: false,
            endDate: false,
            time: {
                enabled: false
            },
            minDays: 0,
            maxDays: 0,
            showShortcuts: false,
            shortcuts: {
                //'prev-days': [1,3,5,7],
                // 'next-days': [3,5,7],
                //'prev' : ['week','month','year'],
                // 'next' : ['week','month','year']
            },
            customShortcuts: [],
            inline: false,
            container: 'body',
            alwaysOpen: false,
            singleDate: false,
            lookBehind: false,
            batchMode: false,
            duration: 200,
            stickyMonths: false,
            dayDivAttrs: [],
            dayTdAttrs: [],
            selectForward: false,
            selectBackward: false,
            applyBtnClass: '',
            singleMonth: 'auto',
            hoveringTooltip: function(days, startTime, hoveringTime) {
                return days > 1 ? days + ' ' + translate('days') : '';
            },
            showTopbar: true,
            swapTime: false,
            showWeekNumbers: false,
            getWeekNumber: function(date) //date will be the first day of a week
            {
                return moment(date).format('w');
            },
            customOpenAnimation: null,
            customCloseAnimation: null,
            customArrowPrevSymbol: null,
            customArrowNextSymbol: null,
            monthSelect: false,
            yearSelect: false
        }, opt);

        opt.start = false;
        opt.end = false;

        opt.startWeek = false;

        //detect a touch device
        opt.isTouchDevice = 'ontouchstart' in window || navigator.msMaxTouchPoints;

        //if it is a touch device, hide hovering tooltip
        if (opt.isTouchDevice) opt.hoveringTooltip = false;

        //show one month on mobile devices
        if (opt.singleMonth == 'auto') opt.singleMonth = $(window).width() < 480;
        if (opt.singleMonth) opt.stickyMonths = false;

        if (!opt.showTopbar) opt.autoClose = true;

        if (opt.startDate && typeof opt.startDate == 'string') opt.startDate = moment(opt.startDate, opt.format).toDate();
        if (opt.endDate && typeof opt.endDate == 'string') opt.endDate = moment(opt.endDate, opt.format).toDate();

        if (opt.yearSelect && typeof opt.yearSelect === 'boolean') {
            opt.yearSelect = function(current) { return [current - 5, current + 5]; }
        }

        var languages = getLanguages();
        var box;
        var initiated = false;
        var self = this;
        var selfDom = $(self).get(0);
        var domChangeTimer;

        $(this).unbind('.datepicker').bind('click.datepicker', function(evt) {
            var isOpen = box.is(':visible');
            if (!isOpen){
            	open(opt.duration);
            }else{
            	closeDatePicker();
            }
        }).bind('change.datepicker', function(evt) {
            checkAndSetDefaultValue();
        }).bind('keyup.datepicker', function() {
            try {
                clearTimeout(domChangeTimer);
            } catch (e) {}
            domChangeTimer = setTimeout(function() {
                checkAndSetDefaultValue();
            }, 2000);
        });

        init_datepicker.call(this);

        if (opt.alwaysOpen) {
            open(0);
        }

        // expose some api
        $(this).data('dateRangePicker', {
            setStart: function(d1) {
                if (typeof d1 == 'string') {
                    d1 = moment(d1, opt.format).toDate();
                }

                opt.end = false;
                setSingleDate(d1);

                return this;
            },
            setEnd: function(d2, silent) {
                var start = new Date();
                start.setTime(opt.start);
                if (typeof d2 == 'string') {
                    d2 = moment(d2, opt.format).toDate();
                }
                setDateRange(start, d2, silent);
                return this;
            },
            setDateRange: function(d1, d2, silent) {
                if (typeof d1 == 'string' && typeof d2 == 'string') {
                    d1 = moment(d1, opt.format).toDate();
                    d2 = moment(d2, opt.format).toDate();
                }
                setDateRange(d1, d2, silent);
            },
            clear: clearSelection,
            close: closeDatePicker,
            open: open,
            redraw: redrawDatePicker,
            getDatePicker: getDatePicker,
            resetMonthsView: resetMonthsView,
            destroy: function() {
                $(self).unbind('.datepicker');
                $(self).data('dateRangePicker', '');
                $(self).data('date-picker-opened', null);
                box.remove();
                $(window).unbind('resize.datepicker', calcPosition);
                $(document).unbind('click.datepicker', closeDatePicker);
            }
        });

        $(window).bind('resize.datepicker', calcPosition);

        return this;

        function IsOwnDatePickerClicked(evt, selfObj) {
            return (selfObj.contains(evt.target) || evt.target == selfObj || (selfObj.childNodes != undefined && $.inArray(evt.target, selfObj.childNodes) >= 0));
        }

        function init_datepicker() {
            var self = this;

            if ($(this).data('date-picker-opened')) {
                closeDatePicker();
                return;
            }
            
            $(this).data('date-picker-opened', true);


            box = createDom().hide();
            box.append('<div class="date-range-length-tip"></div>');

            $(opt.container).append(box);

            if (!opt.inline) {
                calcPosition();
            } else {
                box.addClass('inline-wrapper');
            }

            if (opt.alwaysOpen) {
                box.find('.apply-btn').hide();
            }

            var defaultTime = getDefaultTime();
            resetMonthsView(defaultTime);

            if (opt.time.enabled) {
                if ((opt.startDate && opt.endDate) || (opt.start && opt.end)) {
                    showTime(moment(opt.start || opt.startDate).toDate(), 'time1');
                    showTime(moment(opt.end || opt.endDate).toDate(), 'time2');
                } else {
                    var defaultEndTime = opt.defaultEndTime ? opt.defaultEndTime : defaultTime;
                    showTime(defaultTime, 'time1');
                    showTime(defaultEndTime, 'time2');
                }
            }

            //showSelectedInfo();


            var defaultTopText = '';
            if (opt.singleDate)
                defaultTopText = translate('default-single');
            else if (opt.minDays && opt.maxDays)
                defaultTopText = translate('default-range');
            else if (opt.minDays)
                defaultTopText = translate('default-more');
            else if (opt.maxDays)
                defaultTopText = translate('default-less');
            else
                defaultTopText = translate('default-default');

            box.find('.default-top').html(defaultTopText.replace(/\%d/, opt.minDays).replace(/\%d/, opt.maxDays));
            if (opt.singleMonth) {
                box.addClass('single-month');
            } else {
                box.addClass('two-months');
            }


            setTimeout(function() {
                updateCalendarWidth();
                initiated = true;
            }, 0);

            box.click(function(evt) {
                evt.stopPropagation();
            });

            //if user click other place of the webpage, close date range picker window
            $(document).bind('click.datepicker', function(evt) {
                if (!IsOwnDatePickerClicked(evt, self[0])) {
                    if (box.is(':visible')) closeDatePicker();
                }
            });

            box.find('.next').click(function() {
                if (!opt.stickyMonths)
                    gotoNextMonth(this);
                else
                    gotoNextMonth_stickily(this);
            });

            function gotoNextMonth(self) {
                var isMonth2 = $(self).parents('table').hasClass('month2');
                var month = isMonth2 ? opt.month2 : opt.month1;
                month = nextMonth(month);
                if (!opt.singleMonth && !opt.singleDate && !isMonth2 && compare_month(month, opt.month2) >= 0 || isMonthOutOfBounds(month)) return;
                showMonth(month, isMonth2 ? 'month2' : 'month1');
                showGap();
            }

            function gotoNextMonth_stickily(self) {
                var nextMonth1 = nextMonth(opt.month1);
                var nextMonth2 = nextMonth(opt.month2);
                if (isMonthOutOfBounds(nextMonth2)) return;
                if (!opt.singleDate && compare_month(nextMonth1, nextMonth2) >= 0) return;
                showMonth(nextMonth1, 'month1');
                showMonth(nextMonth2, 'month2');
                showSelectedDays();
            }


            box.find('.prev').click(function() {
                if (!opt.stickyMonths)
                    gotoPrevMonth(this);
                else
                    gotoPrevMonth_stickily(this);
            });

            function gotoPrevMonth(self) {
                var isMonth2 = $(self).parents('table').hasClass('month2');
                var month = isMonth2 ? opt.month2 : opt.month1;
                month = prevMonth(month);
                if (isMonth2 && compare_month(month, opt.month1) <= 0 || isMonthOutOfBounds(month)) return;
                showMonth(month, isMonth2 ? 'month2' : 'month1');
                showGap();
            }

            function gotoPrevMonth_stickily(self) {
                var prevMonth1 = prevMonth(opt.month1);
                var prevMonth2 = prevMonth(opt.month2);
                if (isMonthOutOfBounds(prevMonth1)) return;
                if (!opt.singleDate && compare_month(prevMonth2, prevMonth1) <= 0) return;
                showMonth(prevMonth2, 'month2');
                showMonth(prevMonth1, 'month1');
                showSelectedDays();
            }

            box.attr('unselectable', 'on')
                .css('user-select', 'none')
                .bind('selectstart', function(e) {
                    e.preventDefault();
                    return false;
                });

            box.find('.apply-btn').click(function() {
                closeDatePicker();
                var dateRange = getDateString(new Date(opt.start)) + opt.separator + getDateString(new Date(opt.end));
                $(self).trigger('datepicker-apply', {
                    'value': dateRange,
                    'date1': new Date(opt.start),
                    'date2': new Date(opt.end)
                });
            });

            box.find('[custom]').click(function() {
                var valueName = $(this).attr('custom');
                opt.start = false;
                opt.end = false;
                box.find('.day.checked').removeClass('checked');
                opt.setValue.call(selfDom, valueName);
                checkSelectionValid();
                showSelectedInfo(true);
                showSelectedDays();
                if (opt.autoClose) closeDatePicker();
            });

            box.find('[shortcut]').click(function() {
                var shortcut = $(this).attr('shortcut');
                var end = new Date(),
                    start = false;
                var dir;
                if (shortcut.indexOf('day') != -1) {
                    var day = parseInt(shortcut.split(',', 2)[1], 10);
                    start = new Date(new Date().getTime() + 86400000 * day);
                    end = new Date(end.getTime() + 86400000 * (day > 0 ? 1 : -1));
                } else if (shortcut.indexOf('week') != -1) {
                    dir = shortcut.indexOf('prev,') != -1 ? -1 : 1;
                    var stopDay;
                    if (dir == 1)
                        stopDay = opt.startOfWeek == 'monday' ? 1 : 0;
                    else
                        stopDay = opt.startOfWeek == 'monday' ? 0 : 6;

                    end = new Date(end.getTime() - 86400000);
                    while (end.getDay() != stopDay) end = new Date(end.getTime() + dir * 86400000);
                    start = new Date(end.getTime() + dir * 86400000 * 6);
                } else if (shortcut.indexOf('month') != -1) {
                    dir = shortcut.indexOf('prev,') != -1 ? -1 : 1;
                    if (dir == 1)
                        start = nextMonth(end);
                    else
                        start = prevMonth(end);
                    start.setDate(1);
                    end = nextMonth(start);
                    end.setDate(1);
                    end = new Date(end.getTime() - 86400000);
                } else if (shortcut.indexOf('year') != -1) {
                    dir = shortcut.indexOf('prev,') != -1 ? -1 : 1;
                    start = new Date();
                    start.setFullYear(end.getFullYear() + dir);
                    start.setMonth(0);
                    start.setDate(1);
                    end.setFullYear(end.getFullYear() + dir);
                    end.setMonth(11);
                    end.setDate(31);
                } else if (shortcut == 'custom') {
                    var name = $(this).html();
                    if (opt.customShortcuts && opt.customShortcuts.length > 0) {
                        for (var i = 0; i < opt.customShortcuts.length; i++) {
                            var sh = opt.customShortcuts[i];
                            if (sh.name == name) {
                                var data = [];
                                // try
                                // {
                                data = sh['dates'].call();
                                //}catch(e){}
                                if (data && data.length == 2) {
                                    start = data[0];
                                    end = data[1];
                                }

                                // if only one date is specified then just move calendars there
                                // move calendars to show this date's month and next months
                                if (data && data.length == 1) {
                                    var movetodate = data[0];
                                    showMonth(movetodate, 'month1');
                                    showMonth(nextMonth(movetodate), 'month2');
                                    showGap();
                                }

                                break;
                            }
                        }
                    }
                }
                if (start && end) {
                    setDateRange(start, end);
                    checkSelectionValid();
                    alert(1);
                }
            });

            box.find('.time1 input[type=range]').bind('change touchmove', function(e) {
                var target = e.target,
                    hour = target.name == 'hour' ? $(target).val().replace(/^(\d{1})$/, '0$1') : undefined,
                    min = target.name == 'minute' ? $(target).val().replace(/^(\d{1})$/, '0$1') : undefined;
                setTime('time1', hour, min);
            });

            box.find('.time2 input[type=range]').bind('change touchmove', function(e) {
                var target = e.target,
                    hour = target.name == 'hour' ? $(target).val().replace(/^(\d{1})$/, '0$1') : undefined,
                    min = target.name == 'minute' ? $(target).val().replace(/^(\d{1})$/, '0$1') : undefined;
                setTime('time2', hour, min);
            });

        }


        function calcPosition() {
            if (!opt.inline) {
                var offset = $(self).offset();
                if ($(opt.container).css('position') == 'relative') {
                    var containerOffset = $(opt.container).offset();
                    var leftIndent = Math.max(0, offset.left + box.outerWidth() - $('body').width() + 16);
                    box.css({
                        top: offset.top - containerOffset.top + $(self).outerHeight() + 4,
                        left: offset.left - containerOffset.left - leftIndent
                    });
                } else {
                    if (offset.left < 460) //left to right
                    {
                        box.css({
                            top: offset.top + $(self).outerHeight() + parseInt($('body').css('border-top') || 0, 10),
                            left: offset.left
                        });
                    } else {
                        box.css({
                            top: offset.top + $(self).outerHeight() + parseInt($('body').css('border-top') || 0, 10),
                            left: offset.left + $(self).width() - box.width() - 16
                        });
                    }
                }
            }
        }

        // Return the date picker wrapper element
        function getDatePicker() {
            return box;
        }

        function open(animationTime) {
            redrawDatePicker();
            checkAndSetDefaultValue();
            if (opt.customOpenAnimation) {
                opt.customOpenAnimation.call(box.get(0), function() {
                    $(self).trigger('datepicker-opened', {
                        relatedTarget: box
                    });
                });
            } else {
                box.slideDown(animationTime, function() {
                    $(self).trigger('datepicker-opened', {
                        relatedTarget: box
                    });
                });
            }
            $(self).trigger('datepicker-open', {
                relatedTarget: box
            });
            showGap();
            updateCalendarWidth();
            calcPosition();
        }

        function checkAndSetDefaultValue() {
            var __default_string = opt.getValue.call(selfDom);
            var defaults = __default_string ? __default_string.split(opt.separator) : '';

            if (defaults && ((defaults.length == 1 && opt.singleDate) || defaults.length >= 2)) {
                var ___format = opt.format;
                if (___format.match(/Do/)) {

                    ___format = ___format.replace(/Do/, 'D');
                    defaults[0] = defaults[0].replace(/(\d+)(th|nd|st)/, '$1');
                    if (defaults.length >= 2) {
                        defaults[1] = defaults[1].replace(/(\d+)(th|nd|st)/, '$1');
                    }
                }
                // set initiated  to avoid triggerring datepicker-change event
                initiated = false;
                if (defaults.length >= 2) {
                    setDateRange(getValidValue(defaults[0], ___format, moment.locale(opt.language)), getValidValue(defaults[1], ___format, moment.locale(opt.language)));
                } else if (defaults.length == 1 && opt.singleDate) {
                    setSingleDate(getValidValue(defaults[0], ___format, moment.locale(opt.language)));
                }

                initiated = true;
            }
        }

        function getValidValue(date, format, locale) {
            if (moment(date, format, locale).isValid()) {
                return moment(date, format, locale).toDate();
            } else {
                return moment().toDate();
            }
        }

        function updateCalendarWidth() {
            var gapMargin = box.find('.gap').css('margin-left');
            if (gapMargin) gapMargin = parseInt(gapMargin);
            var w1 = box.find('.month1').width();
            var w2 = box.find('.gap').width() + (gapMargin ? gapMargin * 2 : 0);
            var w3 = box.find('.month2').width();
            box.find('.month-wrapper').width(w1 + w2 + w3);
        }

        function renderTime(name, date) {
            box.find('.' + name + ' input[type=range].hour-range').val(moment(date).hours());
            box.find('.' + name + ' input[type=range].minute-range').val(moment(date).minutes());
            setTime(name, moment(date).format('HH'), moment(date).format('mm'));
        }

        function changeTime(name, date) {
            opt[name] = parseInt(
                moment(parseInt(date))
                .startOf('day')
                .add(moment(opt[name + 'Time']).format('HH'), 'h')
                .add(moment(opt[name + 'Time']).format('mm'), 'm').valueOf()
            );
        }

        function swapTime() {
            renderTime('time1', opt.start);
            renderTime('time2', opt.end);
        }

        function setTime(name, hour, minute) {
            hour && (box.find('.' + name + ' .hour-val').text(hour));
            minute && (box.find('.' + name + ' .minute-val').text(minute));
            switch (name) {
                case 'time1':
                    if (opt.start) {
                        setRange('start', moment(opt.start));
                    }
                    setRange('startTime', moment(opt.startTime || moment().valueOf()));
                    break;
                case 'time2':
                    if (opt.end) {
                        setRange('end', moment(opt.end));
                    }
                    setRange('endTime', moment(opt.endTime || moment().valueOf()));
                    break;
            }

            function setRange(name, timePoint) {
                var h = timePoint.format('HH'),
                    m = timePoint.format('mm');
                opt[name] = timePoint
                    .startOf('day')
                    .add(hour || h, 'h')
                    .add(minute || m, 'm')
                    .valueOf();
            }
            checkSelectionValid();
            showSelectedInfo();
            showSelectedDays();
        }

        function clearSelection() {
            opt.start = false;
            opt.end = false;
            box.find('.day.checked').removeClass('checked');
            box.find('.day.last-date-selected').removeClass('last-date-selected');
            box.find('.day.first-date-selected').removeClass('first-date-selected');
            opt.setValue.call(selfDom, '');
            checkSelectionValid();
            showSelectedInfo();
            showSelectedDays();
        }

        function handleStart(time) {
            var r = time;
            if (opt.batchMode === 'week-range') {
                if (opt.startOfWeek === 'monday') {
                    r = moment(parseInt(time)).startOf('isoweek').valueOf();
                } else {
                    r = moment(parseInt(time)).startOf('week').valueOf();
                }
            } else if (opt.batchMode === 'month-range') {
                r = moment(parseInt(time)).startOf('month').valueOf();
            }
            return r;
        }

        function handleEnd(time) {
            var r = time;
            if (opt.batchMode === 'week-range') {
                if (opt.startOfWeek === 'monday') {
                    r = moment(parseInt(time)).endOf('isoweek').valueOf();
                } else {
                    r = moment(parseInt(time)).endOf('week').valueOf();
                }
            } else if (opt.batchMode === 'month-range') {
                r = moment(parseInt(time)).endOf('month').valueOf();
            }
            return r;
        }


        function dayClicked(day) {
            if (day.hasClass('invalid')) return;
            var time = day.attr('time');
            day.addClass('checked');
            if (opt.singleDate) {
                opt.start = time;
                opt.end = false;
            } else if (opt.batchMode === 'week') {
                if (opt.startOfWeek === 'monday') {
                    opt.start = moment(parseInt(time)).startOf('isoweek').valueOf();
                    opt.end = moment(parseInt(time)).endOf('isoweek').valueOf();
                } else {
                    opt.end = moment(parseInt(time)).endOf('week').valueOf();
                    opt.start = moment(parseInt(time)).startOf('week').valueOf();
                }
            } else if (opt.batchMode === 'workweek') {
                opt.start = moment(parseInt(time)).day(1).valueOf();
                opt.end = moment(parseInt(time)).day(5).valueOf();
            } else if (opt.batchMode === 'weekend') {
                opt.start = moment(parseInt(time)).day(6).valueOf();
                opt.end = moment(parseInt(time)).day(7).valueOf();
            } else if (opt.batchMode === 'month') {
                opt.start = moment(parseInt(time)).startOf('month').valueOf();
                opt.end = moment(parseInt(time)).endOf('month').valueOf();
            } else if ((opt.start && opt.end) || (!opt.start && !opt.end)) {
                opt.start = handleStart(time);
                opt.end = false;
            } else if (opt.start) {
                opt.end = handleEnd(time);
                if (opt.time.enabled) {
                    changeTime('end', opt.end);
                }
            }

            //Update time in case it is enabled and timestamps are available
            if (opt.time.enabled) {
                if (opt.start) {
                    changeTime('start', opt.start);
                }
                if (opt.end) {
                    changeTime('end', opt.end);
                }
            }

            //In case the start is after the end, swap the timestamps
            if (!opt.singleDate && opt.start && opt.end && opt.start > opt.end) {
                var tmp = opt.end;
                opt.end = handleEnd(opt.start);
                opt.start = handleStart(tmp);
                if (opt.time.enabled && opt.swapTime) {
                    swapTime();
                }
            }

            opt.start = parseInt(opt.start);
            opt.end = parseInt(opt.end);

            clearHovering();
            if (opt.start && !opt.end) {
                $(self).trigger('datepicker-first-date-selected', {
                    'date1': new Date(opt.start)
                });
                dayHovering(day);
            }
            updateSelectableRange(time);

            checkSelectionValid();
            showSelectedInfo();
            showSelectedDays();
            autoclose();
            
            
            if (opt.onSelect && opt.start && opt.end){
                opt.onSelect.call(selfDom, Math.floor((new Date(opt.start)).getTime()/1000), Math.floor((new Date(opt.end)).getTime()/1000));	
            }
        }


        function weekNumberClicked(weekNumberDom) {
            var thisTime = parseInt(weekNumberDom.attr('data-start-time'), 10);
            var date1, date2;
            if (!opt.startWeek) {
                opt.startWeek = thisTime;
                weekNumberDom.addClass('week-number-selected');
                date1 = new Date(thisTime);
                opt.start = moment(date1).day(opt.startOfWeek == 'monday' ? 1 : 0).valueOf();
                opt.end = moment(date1).day(opt.startOfWeek == 'monday' ? 7 : 6).valueOf();
            } else {
                box.find('.week-number-selected').removeClass('week-number-selected');
                date1 = new Date(thisTime < opt.startWeek ? thisTime : opt.startWeek);
                date2 = new Date(thisTime < opt.startWeek ? opt.startWeek : thisTime);
                opt.startWeek = false;
                opt.start = moment(date1).day(opt.startOfWeek == 'monday' ? 1 : 0).valueOf();
                opt.end = moment(date2).day(opt.startOfWeek == 'monday' ? 7 : 6).valueOf();
            }
            updateSelectableRange();
            checkSelectionValid();
            showSelectedInfo();
            showSelectedDays();
            autoclose();
        }

        function isValidTime(time) {
            time = parseInt(time, 10);
            if (opt.startDate && compare_day(time, opt.startDate) < 0) return false;
            if (opt.endDate && compare_day(time, opt.endDate) > 0) return false;

            if (opt.start && !opt.end && !opt.singleDate) {
                //check maxDays and minDays setting
                if (opt.maxDays > 0 && countDays(time, opt.start) > opt.maxDays) return false;
                if (opt.minDays > 0 && countDays(time, opt.start) < opt.minDays) return false;

                //check selectForward and selectBackward
                if (opt.selectForward && time < opt.start) return false;
                if (opt.selectBackward && time > opt.start) return false;

                //check disabled days
                if (opt.beforeShowDay && typeof opt.beforeShowDay == 'function') {
                    var valid = true;
                    var timeTmp = time;
                    while (countDays(timeTmp, opt.start) > 1) {
                        var arr = opt.beforeShowDay(new Date(timeTmp));
                        if (!arr[0]) {
                            valid = false;
                            break;
                        }
                        if (Math.abs(timeTmp - opt.start) < 86400000) break;
                        if (timeTmp > opt.start) timeTmp -= 86400000;
                        if (timeTmp < opt.start) timeTmp += 86400000;
                    }
                    if (!valid) return false;
                }
            }
            return true;
        }


        function updateSelectableRange() {
            box.find('.day.invalid.tmp').removeClass('tmp invalid').addClass('valid');
            if (opt.start && !opt.end) {
                box.find('.day.toMonth.valid').each(function() {
                    var time = parseInt($(this).attr('time'), 10);
                    if (!isValidTime(time))
                        $(this).addClass('invalid tmp').removeClass('valid');
                    else
                        $(this).addClass('valid tmp').removeClass('invalid');
                });
            }

            return true;
        }


        function dayHovering(day) {
            var hoverTime = parseInt(day.attr('time'));
            var tooltip = '';

            if (day.hasClass('has-tooltip') && day.attr('data-tooltip')) {
                tooltip = '<span class="tooltip-content">' + day.attr('data-tooltip') + '</span>';
            } else if (!day.hasClass('invalid')) {
                if (opt.singleDate) {
                    box.find('.day.hovering').removeClass('hovering');
                    day.addClass('hovering');
                } else {
                    box.find('.day').each(function() {
                        var time = parseInt($(this).attr('time')),
                            start = opt.start,
                            end = opt.end;

                        if (time == hoverTime) {
                            $(this).addClass('hovering');
                        } else {
                            $(this).removeClass('hovering');
                        }

                        if (
                            (opt.start && !opt.end) &&
                            (
                                (opt.start < time && hoverTime >= time) ||
                                (opt.start > time && hoverTime <= time)
                            )
                        ) {
                            $(this).addClass('hovering');
                        } else {
                            $(this).removeClass('hovering');
                        }
                    });

                    if (opt.start && !opt.end) {
                        var days = countDays(hoverTime, opt.start);
                        if (opt.hoveringTooltip) {
                            if (typeof opt.hoveringTooltip == 'function') {
                                tooltip = opt.hoveringTooltip(days, opt.start, hoverTime);
                            } else if (opt.hoveringTooltip === true && days > 1) {
                                tooltip = days + ' ' + translate('days');
                            }
                        }
                    }
                }
            }

            if (tooltip) {
                var posDay = day.offset();
                var posBox = box.offset();

                var _left = posDay.left - posBox.left;
                var _top = posDay.top - posBox.top;
                _left += day.width() / 2;


                var $tip = box.find('.date-range-length-tip');
                var w = $tip.css({
                    'visibility': 'hidden',
                    'display': 'none'
                }).html(tooltip).width();
                var h = $tip.height();
                _left -= w / 2;
                _top -= h;
                setTimeout(function() {
                    $tip.css({
                        left: _left,
                        top: _top,
                        display: 'block',
                        'visibility': 'visible'
                    });
                }, 10);
            } else {
                box.find('.date-range-length-tip').hide();
            }
        }

        function clearHovering() {
            box.find('.day.hovering').removeClass('hovering');
            box.find('.date-range-length-tip').hide();
        }

        function dateChanged(date) {
            var value = date.val();
            var name = date.attr('name');
            var type = date.parents('table').hasClass('month1') ? 'month1' : 'month2';
            var oppositeType = type === 'month1' ? 'month2' : 'month1';
            var startDate = opt.startDate ? moment(opt.startDate) : false;
            var endDate = opt.endDate ? moment(opt.endDate) : false;
            var newDate = moment(opt[type])[name](value);


            if (startDate && newDate.isSameOrBefore(startDate)) {
                newDate = startDate.add(type === 'month2' ? 1 : 0, 'month');
            }

            if (endDate && newDate.isSameOrAfter(endDate)) {
                newDate = endDate.add(!opt.singleMonth && type === 'month1' ? -1 : 0, 'month');
            }

            showMonth(newDate, type);

            if (type === 'month1') {
                if (opt.stickyMonths || moment(newDate).isSameOrAfter(opt[oppositeType], 'month')) {
                    showMonth(moment(newDate).add(1, 'month'), oppositeType);
                }
            } else {
                if (opt.stickyMonths || moment(newDate).isSameOrBefore(opt[oppositeType], 'month')) {
                    showMonth(moment(newDate).add(-1, 'month'), oppositeType);
                }
            }

            showGap();
        }

        function autoclose() {
            if (opt.singleDate === true) {
                if (initiated && opt.start) {
                    if (opt.autoClose) closeDatePicker();
                }
            } else {
                if (initiated && opt.start && opt.end) {
                    if (opt.autoClose) closeDatePicker();
                }
            }
        }

        function checkSelectionValid() {
            var days = Math.ceil((opt.end - opt.start) / 86400000) + 1;
            if (opt.singleDate) { // Validate if only start is there
                if (opt.start && !opt.end)
                    box.find('.drp_top-bar').removeClass('error').addClass('normal');
                else
                    box.find('.drp_top-bar').removeClass('error').removeClass('normal');
            } else if (opt.maxDays && days > opt.maxDays) {
                opt.start = false;
                opt.end = false;
                box.find('.day').removeClass('checked');
                box.find('.drp_top-bar').removeClass('normal').addClass('error').find('.error-top').html(translate('less-than').replace('%d', opt.maxDays));
            } else if (opt.minDays && days < opt.minDays) {
                opt.start = false;
                opt.end = false;
                box.find('.day').removeClass('checked');
                box.find('.drp_top-bar').removeClass('normal').addClass('error').find('.error-top').html(translate('more-than').replace('%d', opt.minDays));
            } else {
                if (opt.start || opt.end)
                    box.find('.drp_top-bar').removeClass('error').addClass('normal');
                else
                    box.find('.drp_top-bar').removeClass('error').removeClass('normal');
            }

            if ((opt.singleDate && opt.start && !opt.end) || (!opt.singleDate && opt.start && opt.end)) {
                box.find('.apply-btn').removeClass('disabled');
            } else {
                box.find('.apply-btn').addClass('disabled');
            }

            if (opt.batchMode) {
                if (
                    (opt.start && opt.startDate && compare_day(opt.start, opt.startDate) < 0) ||
                    (opt.end && opt.endDate && compare_day(opt.end, opt.endDate) > 0)
                ) {
                    opt.start = false;
                    opt.end = false;
                    box.find('.day').removeClass('checked');
                }
            }
        }

        function showSelectedInfo(forceValid, silent) {
            box.find('.start-day').html('...');
            box.find('.end-day').html('...');
            box.find('.selected-days').hide();
            if (opt.start) {
                box.find('.start-day').html(getDateString(new Date(parseInt(opt.start))));
            }
            if (opt.end) {
                box.find('.end-day').html(getDateString(new Date(parseInt(opt.end))));
            }
            var dateRange;
            if (opt.start && opt.singleDate) {
                box.find('.apply-btn').removeClass('disabled');
                dateRange = getDateString(new Date(opt.start));
                opt.setValue.call(selfDom, dateRange, getDateString(new Date(opt.start)), getDateString(new Date(opt.end)));

                if (initiated && !silent) {
                    $(self).trigger('datepicker-change', {
                        'value': dateRange,
                        'date1': new Date(opt.start)
                    });
                }
            } else if (opt.start && opt.end) {
                box.find('.selected-days').show().find('.selected-days-num').html(countDays(opt.end, opt.start));
                box.find('.apply-btn').removeClass('disabled');
                dateRange = getDateString(new Date(opt.start)) + opt.separator + getDateString(new Date(opt.end));
                
                opt.setValue.call(selfDom, dateRange, getDateString(new Date(opt.start)), getDateString(new Date(opt.end)), Math.floor((new Date(opt.start)).getTime()/1000), Math.floor((new Date(opt.end)).getTime()/1000));
                if (initiated && !silent) {
                    $(self).trigger('datepicker-change', {
                        'value': dateRange,
                        'date1': new Date(opt.start),
                        'date2': new Date(opt.end)
                    });
                }
            } else if (forceValid) {
                box.find('.apply-btn').removeClass('disabled');
            } else {
                box.find('.apply-btn').addClass('disabled');
            }
        }

        function countDays(start, end) {
            return Math.abs(daysFrom1970(start) - daysFrom1970(end)) + 1;
        }

        function setDateRange(date1, date2, silent) {
            if (date1.getTime() > date2.getTime()) {
                var tmp = date2;
                date2 = date1;
                date1 = tmp;
                tmp = null;
            }
            var valid = true;
            if (opt.startDate && compare_day(date1, opt.startDate) < 0) valid = false;
            if (opt.endDate && compare_day(date2, opt.endDate) > 0) valid = false;
            if (!valid) {
                showMonth(opt.startDate, 'month1');
                showMonth(nextMonth(opt.startDate), 'month2');
                showGap();
                return;
            }

            opt.start = date1.getTime();
            opt.end = date2.getTime();

            if (opt.time.enabled) {
                renderTime('time1', date1);
                renderTime('time2', date2);
            }

            if (opt.stickyMonths || (compare_day(date1, date2) > 0 && compare_month(date1, date2) === 0)) {
                if (opt.lookBehind) {
                    date1 = prevMonth(date2);
                } else {
                    date2 = nextMonth(date1);
                }
            }

            if (opt.stickyMonths && opt.endDate !== false && compare_month(date2, opt.endDate) > 0) {
                date1 = prevMonth(date1);
                date2 = prevMonth(date2);
            }

            if (!opt.stickyMonths) {
                if (compare_month(date1, date2) === 0) {
                    if (opt.lookBehind) {
                        date1 = prevMonth(date2);
                    } else {
                        date2 = nextMonth(date1);
                    }
                }
            }

            showMonth(date1, 'month1');
            showMonth(date2, 'month2');
            showGap();
            checkSelectionValid();
            showSelectedInfo(false, silent);
            autoclose();
        }

        function setSingleDate(date1) {

            var valid = true;
            if (opt.startDate && compare_day(date1, opt.startDate) < 0) valid = false;
            if (opt.endDate && compare_day(date1, opt.endDate) > 0) valid = false;
            if (!valid) {
                showMonth(opt.startDate, 'month1');
                return;
            }

            opt.start = date1.getTime();


            if (opt.time.enabled) {
                renderTime('time1', date1);

            }
            showMonth(date1, 'month1');
            if (opt.singleMonth !== true) {
                var date2 = nextMonth(date1);
                showMonth(date2, 'month2');
            }
            showGap();
            showSelectedInfo();
            autoclose();
        }

        function showSelectedDays() {
            if (!opt.start && !opt.end) return;
            box.find('.day').each(function() {
                var time = parseInt($(this).attr('time')),
                    start = opt.start,
                    end = opt.end;
                if (opt.time.enabled) {
                    time = moment(time).startOf('day').valueOf();
                    start = moment(start || moment().valueOf()).startOf('day').valueOf();
                    end = moment(end || moment().valueOf()).startOf('day').valueOf();
                }
                if (
                    (opt.start && opt.end && end >= time && start <= time) ||
                    (opt.start && !opt.end && moment(start).format('YYYY-MM-DD') == moment(time).format('YYYY-MM-DD'))
                ) {
                    $(this).addClass('checked');
                } else {
                    $(this).removeClass('checked');
                }

                //add first-date-selected class name to the first date selected
                if (opt.start && moment(start).format('YYYY-MM-DD') == moment(time).format('YYYY-MM-DD')) {
                    $(this).addClass('first-date-selected');
                } else {
                    $(this).removeClass('first-date-selected');
                }
                //add last-date-selected
                if (opt.end && moment(end).format('YYYY-MM-DD') == moment(time).format('YYYY-MM-DD')) {
                    $(this).addClass('last-date-selected');
                } else {
                    $(this).removeClass('last-date-selected');
                }
            });

            box.find('.week-number').each(function() {
                if ($(this).attr('data-start-time') == opt.startWeek) {
                    $(this).addClass('week-number-selected');
                }
            });
        }

        function showMonth(date, month) {
            date = moment(date).toDate();
            var monthElement = generateMonthElement(date, month);
            var yearElement = generateYearElement(date, month);

            box.find('.' + month + ' .month-name').html(monthElement + ' ' + yearElement);
            box.find('.' + month + ' tbody').html(createMonthHTML(date));
            opt[month] = date;
            updateSelectableRange();
            bindEvents();
        }

        function generateMonthElement(date, month) {
            var range;
            var startDate = opt.startDate ? moment(opt.startDate).add(!opt.singleMonth && month === 'month2' ? 1 : 0, 'month') : false;
            var endDate = opt.endDate ? moment(opt.endDate).add(!opt.singleMonth && month === 'month1' ? -1 : 0, 'month') : false;
            date = moment(date);

            if (!opt.monthSelect ||
                startDate && endDate && startDate.isSame(endDate, 'month')) {
                return '<div class="month-element">' + nameMonth(date.get('month')) + '</div>';
            }

            range = [
                startDate && date.isSame(startDate, 'year') ? startDate.get('month') : 0,
                endDate && date.isSame(endDate, 'year') ? endDate.get('month') : 11
            ];

            if (range[0] === range[1]) {
                return '<div class="month-element">' + nameMonth(date.get('month')) + '</div>';
            }

            return generateSelect(
                'month',
                generateSelectData(
                    range,
                    date.get('month'),
                    function(value) { return nameMonth(value); }
                )
            );
        }

        function generateYearElement(date, month) {
            date = moment(date);
            var startDate = opt.startDate ? moment(opt.startDate).add(!opt.singleMonth && month === 'month2' ? 1 : 0, 'month') : false;
            var endDate = opt.endDate ? moment(opt.endDate).add(!opt.singleMonth && month === 'month1' ? -1 : 0, 'month') : false;
            var fullYear = date.get('year');
            var isYearFunction = opt.yearSelect && typeof opt.yearSelect === 'function';
            var range;

            if (!opt.yearSelect ||
                startDate && endDate && startDate.isSame(moment(endDate), 'year')) {
                return '<div class="month-element">' + fullYear + '</div>';
            }

            range = isYearFunction ? opt.yearSelect(fullYear) : opt.yearSelect.slice();

            range = [
                startDate ? Math.max(range[0], startDate.get('year')) : Math.min(range[0], fullYear),
                endDate ? Math.min(range[1], endDate.get('year')) : Math.max(range[1], fullYear)
            ];

            return generateSelect('year', generateSelectData(range, fullYear));
        }


        function generateSelectData(range, current, valueBeautifier) {
            var data = [];
            valueBeautifier = valueBeautifier || function(value) { return value; };

            for (var i = range[0]; i <= range[1]; i++) {
                data.push({
                    value: i,
                    text: valueBeautifier(i),
                    isCurrent: i === current
                });
            }

            return data;
        }

        function generateSelect(name, data) {
            var select = '<div class="select-wrapper"><select class="' + name + '" name="' + name + '">';
            var current;

            for (var i = 0, l = data.length; i < l; i++) {
                select += '<option value="' + data[i].value + '"' + (data[i].isCurrent ? ' selected' : '') + '>';
                select += data[i].text;
                select += '</option>';

                if (data[i].isCurrent) {
                    current = data[i].text;
                }
            }

            select += '</select>' + current + '</div>';

            return select;
        }

        function bindEvents() {
            box.find('.day').unbind("click").click(function(evt) {
                dayClicked($(this));
            });

            box.find('.day').unbind("mouseenter").mouseenter(function(evt) {
                dayHovering($(this));
            });

            box.find('.day').unbind("mouseleave").mouseleave(function(evt) {
                box.find('.date-range-length-tip').hide();
                if (opt.singleDate) {
                    clearHovering();
                }
            });

            box.find('.week-number').unbind("click").click(function(evt) {
                weekNumberClicked($(this));
            });

            box.find('.month').unbind("change").change(function(evt) {
                dateChanged($(this));
            });

            box.find('.year').unbind("change").change(function(evt) {
                dateChanged($(this));
            });
        }

        function showTime(date, name) {
            box.find('.' + name).append(getTimeHTML());
            renderTime(name, date);
        }

        function nameMonth(m) {
            return translate('month-name')[m];
        }

        function getDateString(d) {
            return moment(d).format(opt.format);
        }

        function showGap() {
            showSelectedDays();
            var m1 = parseInt(moment(opt.month1).format('YYYYMM'));
            var m2 = parseInt(moment(opt.month2).format('YYYYMM'));
            var p = Math.abs(m1 - m2);
            var shouldShow = (p > 1 && p != 89);
            if (shouldShow) {
                box.addClass('has-gap').removeClass('no-gap').find('.gap').css('visibility', 'visible');
            } else {
                box.removeClass('has-gap').addClass('no-gap').find('.gap').css('visibility', 'hidden');
            }
            var h1 = box.find('table.month1').height();
            var h2 = box.find('table.month2').height();
            box.find('.gap').height(Math.max(h1, h2) + 10);
        }

        function closeDatePicker() {
            if (opt.alwaysOpen) return;

            var afterAnim = function() {
                $(self).data('date-picker-opened', false);
                $(self).trigger('datepicker-closed', {
                    relatedTarget: box
                });
            };
            if (opt.customCloseAnimation) {
                opt.customCloseAnimation.call(box.get(0), afterAnim);
            } else {
                $(box).slideUp(opt.duration, afterAnim);
            }
            $(self).trigger('datepicker-close', {
                relatedTarget: box
            });
        }

        function redrawDatePicker() {
            showMonth(opt.month1, 'month1');
            showMonth(opt.month2, 'month2');
        }

        function compare_month(m1, m2) {
            var p = parseInt(moment(m1).format('YYYYMM')) - parseInt(moment(m2).format('YYYYMM'));
            if (p > 0) return 1;
            if (p === 0) return 0;
            return -1;
        }

        function compare_day(m1, m2) {
            var p = parseInt(moment(m1).format('YYYYMMDD')) - parseInt(moment(m2).format('YYYYMMDD'));
            if (p > 0) return 1;
            if (p === 0) return 0;
            return -1;
        }

        function nextMonth(month) {
            return moment(month).add(1, 'months').toDate();
        }

        function prevMonth(month) {
            return moment(month).add(-1, 'months').toDate();
        }

        function getTimeHTML() {
            return '<div>' +
                '<span>' + translate('Time') + ': <span class="hour-val">00</span>:<span class="minute-val">00</span></span>' +
                '</div>' +
                '<div class="hour">' +
                '<label>' + translate('Hour') + ': <input type="range" class="hour-range" name="hour" min="0" max="23"></label>' +
                '</div>' +
                '<div class="minute">' +
                '<label>' + translate('Minute') + ': <input type="range" class="minute-range" name="minute" min="0" max="59"></label>' +
                '</div>';
        }

        function createDom() {
            var html = '<div class="date-picker-wrapper';
            if (opt.extraClass) html += ' ' + opt.extraClass + ' ';
            if (opt.singleDate) html += ' single-date ';
            if (!opt.showShortcuts) html += ' no-shortcuts ';
            if (!opt.showTopbar) html += ' no-topbar ';
            if (opt.customTopBar) html += ' custom-topbar ';
            html += '">';

            if (opt.showTopbar) {
                html += '<div class="drp_top-bar">';

                if (opt.customTopBar) {
                    if (typeof opt.customTopBar == 'function') opt.customTopBar = opt.customTopBar();
                    html += '<div class="custom-top">' + opt.customTopBar + '</div>';
                } else {
                    html += '<div class="normal-top">' +
                        '<span class="selection-top">' + translate('selected') + ' </span> <b class="start-day">...</b>';
                    if (!opt.singleDate) {
                        html += ' <span class="separator-day">' + opt.separator + '</span> <b class="end-day">...</b> <i class="selected-days">(<span class="selected-days-num">3</span> ' + translate('days') + ')</i>';
                    }
                    html += '</div>';
                    html += '<div class="error-top">error</div>' +
                        '<div class="default-top">default</div>';
                }

                html += '<input type="button" class="apply-btn disabled' + getApplyBtnClass() + '" value="' + translate('apply') + '" />';
                html += '</div>';
            }

            var _colspan = opt.showWeekNumbers ? 6 : 5;

            var arrowPrev = '&lt;';
            if (opt.customArrowPrevSymbol) arrowPrev = opt.customArrowPrevSymbol;

            var arrowNext = '&gt;';
            if (opt.customArrowNextSymbol) arrowNext = opt.customArrowNextSymbol;

            html += '<div class="month-wrapper">' +
                '   <table class="month1" cellspacing="0" border="0" cellpadding="0">' +
                '       <thead>' +
                '           <tr class="caption">' +
                '               <th>' +
                '                   <span class="prev">' +
                arrowPrev +
                '                   </span>' +
                '               </th>' +
                '               <th colspan="' + _colspan + '" class="month-name">' +
                '               </th>' +
                '               <th>' +
                (opt.singleDate || !opt.stickyMonths ? '<span class="next">' + arrowNext + '</span>' : '') +
                '               </th>' +
                '           </tr>' +
                '           <tr class="week-name">' + getWeekHead() +
                '       </thead>' +
                '       <tbody></tbody>' +
                '   </table>';

            if (hasMonth2()) {
                html += '<div class="gap">' + getGapHTML() + '</div>' +
                    '<table class="month2" cellspacing="0" border="0" cellpadding="0">' +
                    '   <thead>' +
                    '   <tr class="caption">' +
                    '       <th>' +
                    (!opt.stickyMonths ? '<span class="prev">' + arrowPrev + '</span>' : '') +
                    '       </th>' +
                    '       <th colspan="' + _colspan + '" class="month-name">' +
                    '       </th>' +
                    '       <th>' +
                    '           <span class="next">' + arrowNext + '</span>' +
                    '       </th>' +
                    '   </tr>' +
                    '   <tr class="week-name">' + getWeekHead() +
                    '   </thead>' +
                    '   <tbody></tbody>' +
                    '</table>';

            }
            //+'</div>'
            html += '<div class="dp-clearfix"></div>' +
                '<div class="time">' +
                '<div class="time1"></div>';
            if (!opt.singleDate) {
                html += '<div class="time2"></div>';
            }
            html += '</div>' +
                '<div class="dp-clearfix"></div>' +
                '</div>';

            html += '<div class="footer">';
            if (opt.showShortcuts) {
                html += '<div class="shortcuts"><b>' + translate('shortcuts') + '</b>';

                var data = opt.shortcuts;
                if (data) {
                    var name;
                    if (data['prev-days'] && data['prev-days'].length > 0) {
                        html += '&nbsp;<span class="prev-days">' + translate('past');
                        for (var i = 0; i < data['prev-days'].length; i++) {
                            name = data['prev-days'][i];
                            name += (data['prev-days'][i] > 1) ? translate('days') : translate('day');
                            html += ' <a href="javascript:;" shortcut="day,-' + data['prev-days'][i] + '">' + name + '</a>';
                        }
                        html += '</span>';
                    }

                    if (data['next-days'] && data['next-days'].length > 0) {
                        html += '&nbsp;<span class="next-days">' + translate('following');
                        for (var i = 0; i < data['next-days'].length; i++) {
                            name = data['next-days'][i];
                            name += (data['next-days'][i] > 1) ? translate('days') : translate('day');
                            html += ' <a href="javascript:;" shortcut="day,' + data['next-days'][i] + '">' + name + '</a>';
                        }
                        html += '</span>';
                    }

                    if (data.prev && data.prev.length > 0) {
                        html += '&nbsp;<span class="prev-buttons">' + translate('previous');
                        for (var i = 0; i < data.prev.length; i++) {
                            name = translate('prev-' + data.prev[i]);
                            html += ' <a href="javascript:;" shortcut="prev,' + data.prev[i] + '">' + name + '</a>';
                        }
                        html += '</span>';
                    }

                    if (data.next && data.next.length > 0) {
                        html += '&nbsp;<span class="next-buttons">' + translate('next');
                        for (var i = 0; i < data.next.length; i++) {
                            name = translate('next-' + data.next[i]);
                            html += ' <a href="javascript:;" shortcut="next,' + data.next[i] + '">' + name + '</a>';
                        }
                        html += '</span>';
                    }
                }

                if (opt.customShortcuts) {
                    for (var i = 0; i < opt.customShortcuts.length; i++) {
                        var sh = opt.customShortcuts[i];
                        html += '&nbsp;<span class="custom-shortcut"><a href="javascript:;" shortcut="custom">' + sh.name + '</a></span>';
                    }
                }
                html += '</div>';
            }

            // Add Custom Values Dom
            if (opt.showCustomValues) {
                html += '<div class="customValues"><b>' + (opt.customValueLabel || translate('custom-values')) + '</b>';

                if (opt.customValues) {
                    for (var i = 0; i < opt.customValues.length; i++) {
                        var val = opt.customValues[i];
                        html += '&nbsp;<span class="custom-value"><a href="javascript:;" custom="' + val.value + '">' + val.name + '</a></span>';
                    }
                }
            }

            html += '</div></div>';


            return $(html);
        }

        function getApplyBtnClass() {
            var klass = '';
            if (opt.autoClose === true) {
                klass += ' hide';
            }
            if (opt.applyBtnClass !== '') {
                klass += ' ' + opt.applyBtnClass;
            }
            return klass;
        }

        function getWeekHead() {
            var prepend = opt.showWeekNumbers ? '<th>' + translate('week-number') + '</th>' : '';
            if (opt.startOfWeek == 'monday') {
                return prepend + '<th>' + translate('week-1') + '</th>' +
                    '<th>' + translate('week-2') + '</th>' +
                    '<th>' + translate('week-3') + '</th>' +
                    '<th>' + translate('week-4') + '</th>' +
                    '<th>' + translate('week-5') + '</th>' +
                    '<th>' + translate('week-6') + '</th>' +
                    '<th>' + translate('week-7') + '</th>';
            } else {
                return prepend + '<th>' + translate('week-7') + '</th>' +
                    '<th>' + translate('week-1') + '</th>' +
                    '<th>' + translate('week-2') + '</th>' +
                    '<th>' + translate('week-3') + '</th>' +
                    '<th>' + translate('week-4') + '</th>' +
                    '<th>' + translate('week-5') + '</th>' +
                    '<th>' + translate('week-6') + '</th>';
            }
        }

        function isMonthOutOfBounds(month) {
            month = moment(month);
            if (opt.startDate && month.endOf('month').isBefore(opt.startDate)) {
                return true;
            }
            if (opt.endDate && month.startOf('month').isAfter(opt.endDate)) {
                return true;
            }
            return false;
        }

        function getGapHTML() {
            var html = ['<div class="gap-top-mask"></div><div class="gap-bottom-mask"></div><div class="gap-lines">'];
            for (var i = 0; i < 20; i++) {
                html.push('<div class="gap-line">' +
                    '<div class="gap-1"></div>' +
                    '<div class="gap-2"></div>' +
                    '<div class="gap-3"></div>' +
                    '</div>');
            }
            html.push('</div>');
            return html.join('');
        }

        function hasMonth2() {
            return (!opt.singleMonth);
        }

        function attributesCallbacks(initialObject, callbacksArray, today) {
            var resultObject = $.extend(true, {}, initialObject);

            $.each(callbacksArray, function(cbAttrIndex, cbAttr) {
                var addAttributes = cbAttr(today);
                for (var attr in addAttributes) {
                    if (resultObject.hasOwnProperty(attr)) {
                        resultObject[attr] += addAttributes[attr];
                    } else {
                        resultObject[attr] = addAttributes[attr];
                    }
                }
            });

            var attrString = '';

            for (var attr in resultObject) {
                if (resultObject.hasOwnProperty(attr)) {
                    attrString += attr + '="' + resultObject[attr] + '" ';
                }
            }

            return attrString;
        }

        function daysFrom1970(t) {
            return Math.floor(toLocalTimestamp(t) / 86400000);
        }

        function toLocalTimestamp(t) {
            if (moment.isMoment(t)) t = t.toDate().getTime();
            if (typeof t == 'object' && t.getTime) t = t.getTime();
            if (typeof t == 'string' && !t.match(/\d{13}/)) t = moment(t, opt.format).toDate().getTime();
            t = parseInt(t, 10) - new Date().getTimezoneOffset() * 60 * 1000;
            return t;
        }

        function createMonthHTML(d) {
            var days = [];
            d.setDate(1);
            var lastMonth = new Date(d.getTime() - 86400000);
            var now = new Date();

            var dayOfWeek = d.getDay();
            if ((dayOfWeek === 0) && (opt.startOfWeek === 'monday')) {
                // add one week
                dayOfWeek = 7;
            }
            var today, valid;

            if (dayOfWeek > 0) {
                for (var i = dayOfWeek; i > 0; i--) {
                    var day = new Date(d.getTime() - 86400000 * i);
                    valid = isValidTime(day.getTime());
                    if (opt.startDate && compare_day(day, opt.startDate) < 0) valid = false;
                    if (opt.endDate && compare_day(day, opt.endDate) > 0) valid = false;
                    days.push({
                        date: day,
                        type: 'lastMonth',
                        day: day.getDate(),
                        time: day.getTime(),
                        valid: valid
                    });
                }
            }
            var toMonth = d.getMonth();
            for (var i = 0; i < 40; i++) {
                today = moment(d).add(i, 'days').toDate();
                valid = isValidTime(today.getTime());
                if (opt.startDate && compare_day(today, opt.startDate) < 0) valid = false;
                if (opt.endDate && compare_day(today, opt.endDate) > 0) valid = false;
                days.push({
                    date: today,
                    type: today.getMonth() == toMonth ? 'toMonth' : 'nextMonth',
                    day: today.getDate(),
                    time: today.getTime(),
                    valid: valid
                });
            }
            var html = [];
            for (var week = 0; week < 6; week++) {
                if (days[week * 7].type == 'nextMonth') break;
                html.push('<tr>');

                for (var day = 0; day < 7; day++) {
                    var _day = (opt.startOfWeek == 'monday') ? day + 1 : day;
                    today = days[week * 7 + _day];
                    var highlightToday = moment(today.time).format('L') == moment(now).format('L');
                    today.extraClass = '';
                    today.tooltip = '';
                    if (today.valid && opt.beforeShowDay && typeof opt.beforeShowDay == 'function') {
                        var _r = opt.beforeShowDay(moment(today.time).toDate());
                        today.valid = _r[0];
                        today.extraClass = _r[1] || '';
                        today.tooltip = _r[2] || '';
                        if (today.tooltip !== '') today.extraClass += ' has-tooltip ';
                    }

                    var todayDivAttr = {
                        time: today.time,
                        'data-tooltip': today.tooltip,
                        'class': 'day ' + today.type + ' ' + today.extraClass + ' ' + (today.valid ? 'valid' : 'invalid') + ' ' + (highlightToday ? 'real-today' : '')
                    };

                    if (day === 0 && opt.showWeekNumbers) {
                        html.push('<td><div class="week-number" data-start-time="' + today.time + '">' + opt.getWeekNumber(today.date) + '</div></td>');
                    }

                    html.push('<td ' + attributesCallbacks({}, opt.dayTdAttrs, today) + '><div ' + attributesCallbacks(todayDivAttr, opt.dayDivAttrs, today) + '>' + showDayHTML(today.time, today.day) + '</div></td>');
                }
                html.push('</tr>');
            }
            return html.join('');
        }

        function showDayHTML(time, date) {
            if (opt.showDateFilter && typeof opt.showDateFilter == 'function') return opt.showDateFilter(time, date);
            return date;
        }

        function getLanguages() {
            if (opt.language == 'auto') {
                var language = navigator.language ? navigator.language : navigator.browserLanguage;
                if (!language) {
                    return $.dateRangePickerLanguages['default'];
                }
                language = language.toLowerCase();
                if(language in $.dateRangePickerLanguages){
                    return $.dateRangePickerLanguages[language];
                }

                return $.dateRangePickerLanguages['default'];
            } else if (opt.language && opt.language in $.dateRangePickerLanguages) {
                return $.dateRangePickerLanguages[opt.language];
            } else {
                return $.dateRangePickerLanguages['default'];
            }
        }

        /**
         * Translate language string, try both the provided translation key, as the lower case version
         */
        function translate(translationKey) {
            var translationKeyLowerCase = translationKey.toLowerCase();
            var result = (translationKey in languages) ? languages[translationKey] : (translationKeyLowerCase in languages) ? languages[translationKeyLowerCase] : null;
            var defaultLanguage = $.dateRangePickerLanguages['default'];
            if (result == null) result = (translationKey in defaultLanguage) ? defaultLanguage[translationKey] : (translationKeyLowerCase in defaultLanguage) ? defaultLanguage[translationKeyLowerCase] : '';

            return result;
        }

        function getDefaultTime() {
            var defaultTime = opt.defaultTime ? opt.defaultTime : new Date();

            if (opt.lookBehind) {
                if (opt.startDate && compare_month(defaultTime, opt.startDate) < 0) defaultTime = nextMonth(moment(opt.startDate).toDate());
                if (opt.endDate && compare_month(defaultTime, opt.endDate) > 0) defaultTime = moment(opt.endDate).toDate();
            } else {
                if (opt.startDate && compare_month(defaultTime, opt.startDate) < 0) defaultTime = moment(opt.startDate).toDate();
                if (opt.endDate && compare_month(nextMonth(defaultTime), opt.endDate) > 0) defaultTime = prevMonth(moment(opt.endDate).toDate());
            }

            if (opt.singleDate) {
                if (opt.startDate && compare_month(defaultTime, opt.startDate) < 0) defaultTime = moment(opt.startDate).toDate();
                if (opt.endDate && compare_month(defaultTime, opt.endDate) > 0) defaultTime = moment(opt.endDate).toDate();
            }

            return defaultTime;
        }

        function resetMonthsView(time) {
            if (!time) {
                time = getDefaultTime();
            }

            if (opt.lookBehind) {
                showMonth(prevMonth(time), 'month1');
                showMonth(time, 'month2');
            } else {
                showMonth(time, 'month1');
                showMonth(nextMonth(time), 'month2');
            }

            if (opt.singleDate) {
                showMonth(time, 'month1');
            }

            showSelectedDays();
            showGap();
        }

    };
}));/*
 Highcharts JS v7.2.1 (2019-10-31)

 (c) 2016-2019 Highsoft AS
 Authors: Jon Arild Nygard

 License: www.highcharts.com/license
*/
(function(a){"object"===typeof module&&module.exports?(a["default"]=a,module.exports=a):"function"===typeof define&&define.amd?define("highcharts/modules/wordcloud",["highcharts"],function(k){a(k);a.Highcharts=k;return a}):a("undefined"!==typeof Highcharts?Highcharts:void 0)})(function(a){function k(a,e,z,l){a.hasOwnProperty(e)||(a[e]=l.apply(null,z))}a=a?a._modules:{};k(a,"mixins/draw-point.js",[],function(){var a=function(e){var a=this,l=a.graphic,q=e.animatableAttribs,r=e.onComplete,k=e.css,x=
e.renderer;if(a.shouldDraw())l||(a.graphic=l=x[e.shapeType](e.shapeArgs).add(e.group)),l.css(k).attr(e.attribs).animate(q,e.isNew?!1:void 0,r);else if(l){var t=function(){a.graphic=l=l.destroy();"function"===typeof r&&r()};Object.keys(q).length?l.animate(q,void 0,function(){t()}):t()}};return function(e){(e.attribs=e.attribs||{})["class"]=this.getClassName();a.call(this,e)}});k(a,"mixins/polygon.js",[a["parts/Globals.js"],a["parts/Utilities.js"]],function(a,e){var q=e.isArray,l=e.isNumber,k=a.deg2rad,
r=a.find,C=function(b,c){c=l(c)?c:14;c=Math.pow(10,c);return Math.round(b*c)/c},x=function(b,c){var h=c[0]-b[0];b=c[1]-b[1];return[[-b,h],[b,-h]]},t=function(b,c){b=b.map(function(b){return b[0]*c[0]+b[1]*c[1]});return{min:Math.min.apply(this,b),max:Math.max.apply(this,b)}},D=function(b,c){var h=b[0];b=b[1];var a=k*-c;c=Math.cos(a);a=Math.sin(a);return[C(h*c-b*a),C(h*a+b*c)]},y=function(b,c,a){b=D([b[0]-c[0],b[1]-c[1]],a);return[b[0]+c[0],b[1]+c[1]]},A=function(b){var c=b.axes;if(!q(c)){c=[];var a=
a=b.concat([b[0]]);a.reduce(function(b,a){var h=x(b,a)[0];r(c,function(b){return b[0]===h[0]&&b[1]===h[1]})||c.push(h);return a});b.axes=c}return c},E=function(b,c){b=A(b);c=A(c);return b.concat(c)};return{getBoundingBoxFromPolygon:function(b){return b.reduce(function(b,a){var c=a[0];a=a[1];b.left=Math.min(c,b.left);b.right=Math.max(c,b.right);b.bottom=Math.max(a,b.bottom);b.top=Math.min(a,b.top);return b},{left:Number.MAX_VALUE,right:-Number.MAX_VALUE,bottom:-Number.MAX_VALUE,top:Number.MAX_VALUE})},
getPolygon:function(b,a,h,e,l){var c=[b,a],w=b-h/2;b+=h/2;h=a-e/2;a+=e/2;return[[w,h],[b,h],[b,a],[w,a]].map(function(b){return y(b,c,-l)})},isPolygonsColliding:function(b,a){var c=E(b,a);return!r(c,function(c){var e=t(b,c);c=t(a,c);return!!(c.min>e.max||c.max<e.min)})},movePolygon:function(b,a,e){return e.map(function(c){return[c[0]+b,c[1]+a]})},rotate2DToOrigin:D,rotate2DToPoint:y}});k(a,"modules/wordcloud.src.js",[a["parts/Globals.js"],a["parts/Utilities.js"],a["mixins/draw-point.js"],a["mixins/polygon.js"]],
function(a,e,k,l){function q(g,d){var f=!1,b=g.rect,a=g.polygon,c=g.lastCollidedWith,e=function(d){var f=d.rect;(f=!(f.left>b.right||f.right<b.left||f.top>b.bottom||f.bottom<b.top))&&(g.rotation%90||d.rotation%90)&&(f=F(a,d.polygon));return f};c&&((f=e(c))||delete g.lastCollidedWith);f||(f=!!I(d,function(d){var f=e(d);f&&(g.lastCollidedWith=d);return f}));return f}function r(g,d){d=4*g;var f=Math.ceil((Math.sqrt(d)-1)/2),b=2*f+1,a=Math.pow(b,2),c=!1;--b;1E4>=g&&("boolean"===typeof c&&d>=a-b&&(c={x:f-
(a-d),y:-f}),a-=b,"boolean"===typeof c&&d>=a-b&&(c={x:-f,y:-f+(a-d)}),a-=b,"boolean"===typeof c&&(c=d>=a-b?{x:-f+(a-d),y:f}:{x:f,y:f-(a-d-b)}),c.x*=5,c.y*=5);return c}function C(g,d,f){var b=2*Math.max(Math.abs(f.top),Math.abs(f.bottom));f=2*Math.max(Math.abs(f.left),Math.abs(f.right));return Math.min(0<f?1/f*g:1,0<b?1/b*d:1)}function x(g,d,b){b=b.reduce(function(b,g){g=g.dimensions;var d=Math.max(g.width,g.height);b.maxHeight=Math.max(b.maxHeight,g.height);b.maxWidth=Math.max(b.maxWidth,g.width);
b.area+=d*d;return b},{maxHeight:0,maxWidth:0,area:0});b=Math.max(b.maxHeight,b.maxWidth,.85*Math.sqrt(b.area));var a=g>d?g/d:1;g=d>g?d/g:1;return{width:b*a,height:b*g,ratioX:a,ratioY:g}}function t(b,d,a,c){var g=!1;h(b)&&h(d)&&h(a)&&h(c)&&0<b&&-1<d&&c>a&&(g=a+d%b*((c-a)/(b-1||1)));return g}function D(b,d){var g,a=[];for(g=1;1E4>g;g++)a.push(b(g,d));return function(b){return 1E4>=b?a[b-1]:!1}}function y(b,d){var g=d.width/2,a=-(d.height/2),c=d.height/2;return!(-(d.width/2)<b.left&&g>b.right&&a<b.top&&
c>b.bottom)}function A(g,d){var a=d.placed,c=d.field,e=d.rectangle,h=d.polygon,l=d.spiral,k=1,p={x:0,y:0},n=g.rect=b({},e);g.polygon=h;for(g.rotation=d.rotation;!1!==p&&(q(g,a)||y(n,c));)p=l(k),w(p)&&(n.left=e.left+p.x,n.right=e.right+p.x,n.top=e.top+p.y,n.bottom=e.bottom+p.y,g.polygon=L(p.x,p.y,h)),k++;return p}function E(b,a){if(w(b)&&w(a)){var g=a.bottom-a.top;var d=a.right-a.left;a=b.ratioX;var c=b.ratioY;g=d*a>g*c?d:g;b=z(b,{width:b.width+g*a*2,height:b.height+g*c*2})}return b}var b=e.extend,
c=e.isArray,h=e.isNumber,w=e.isObject,z=a.merge;e=a.noop;var I=a.find,J=l.getBoundingBoxFromPolygon,K=l.getPolygon,F=l.isPolygonsColliding,L=l.movePolygon,B=a.Series;a.seriesType("wordcloud","column",{allowExtendPlayingField:!0,animation:{duration:500},borderWidth:0,clip:!1,colorByPoint:!0,minFontSize:1,maxFontSize:25,placementStrategy:"center",rotation:{from:0,orientations:2,to:90},showInLegend:!1,spiral:"rectangular",style:{fontFamily:"sans-serif",fontWeight:"900",whiteSpace:"nowrap"},tooltip:{followPointer:!0,
pointFormat:'<span style="color:{point.color}">\u25cf</span> {series.name}: <b>{point.weight}</b><br/>'}},{animate:B.prototype.animate,animateDrilldown:e,animateDrillupFrom:e,setClip:e,bindAxes:function(){var a={endOnTick:!1,gridLineWidth:0,lineWidth:0,maxPadding:0,startOnTick:!1,title:null,tickPositions:[]};B.prototype.bindAxes.call(this);b(this.yAxis.options,a);b(this.xAxis.options,a)},pointAttribs:function(b,d){b=a.seriesTypes.column.prototype.pointAttribs.call(this,b,d);delete b.stroke;delete b["stroke-width"];
return b},deriveFontSize:function(b,a,c){b=h(b)?b:0;a=h(a)?a:1;c=h(c)?c:1;return Math.floor(Math.max(c,b*a))},drawPoints:function(){var a=this,d=a.hasRendered,c=a.xAxis,e=a.yAxis,l=a.group,k=a.options,r=k.animation,t=k.allowExtendPlayingField,p=a.chart.renderer,n=p.text().add(l),q=[],y=a.placementStrategy[k.placementStrategy],z=k.rotation,F=a.points.map(function(b){return b.weight}),B=Math.max.apply(null,F),G=a.points.sort(function(b,a){return a.weight-b.weight});G.forEach(function(c){var d=a.deriveFontSize(1/
B*c.weight,k.maxFontSize,k.minFontSize);d=b({fontSize:d+"px"},k.style);n.css(d).attr({x:0,y:0,text:c.name});d=n.getBBox(!0);c.dimensions={height:d.height,width:d.width}});var u=x(c.len,e.len,G);var H=D(a.spirals[k.spiral],{field:u});G.forEach(function(c){var g=a.deriveFontSize(1/B*c.weight,k.maxFontSize,k.minFontSize);g=b({fontSize:g+"px"},k.style);var f=y(c,{data:G,field:u,placed:q,rotation:z}),e=b(a.pointAttribs(c,c.selected&&"select"),{align:"center","alignment-baseline":"middle",x:f.x,y:f.y,text:c.name,
rotation:f.rotation}),n=K(f.x,f.y,c.dimensions.width,c.dimensions.height,f.rotation),m=J(n),v=A(c,{rectangle:m,polygon:n,field:u,placed:q,spiral:H,rotation:f.rotation});!v&&t&&(u=E(u,m),v=A(c,{rectangle:m,polygon:n,field:u,placed:q,spiral:H,rotation:f.rotation}));if(w(v)){e.x+=v.x;e.y+=v.y;m.left+=v.x;m.right+=v.x;m.top+=v.y;m.bottom+=v.y;f=u;if(!h(f.left)||f.left>m.left)f.left=m.left;if(!h(f.right)||f.right<m.right)f.right=m.right;if(!h(f.top)||f.top>m.top)f.top=m.top;if(!h(f.bottom)||f.bottom<m.bottom)f.bottom=
m.bottom;u=f;q.push(c);c.isNull=!1}else c.isNull=!0;if(r){var x={x:e.x,y:e.y};d?(delete e.x,delete e.y):(e.x=0,e.y=0)}c.draw({animatableAttribs:x,attribs:e,css:g,group:l,renderer:p,shapeArgs:void 0,shapeType:"text"})});n=n.destroy();c=C(c.len,e.len,u);a.group.attr({scaleX:c,scaleY:c})},hasData:function(){return w(this)&&!0===this.visible&&c(this.points)&&0<this.points.length},placementStrategy:{random:function(b,a){var c=a.field;a=a.rotation;return{x:Math.round(c.width*(Math.random()+.5)/2)-c.width/
2,y:Math.round(c.height*(Math.random()+.5)/2)-c.height/2,rotation:t(a.orientations,b.index,a.from,a.to)}},center:function(b,a){a=a.rotation;return{x:0,y:0,rotation:t(a.orientations,b.index,a.from,a.to)}}},pointArrayMap:["weight"],spirals:{archimedean:function(b,a){var c=a.field;a=!1;c=c.width*c.width+c.height*c.height;var d=.8*b;1E4>=b&&(a={x:d*Math.cos(d),y:d*Math.sin(d)},Math.min(Math.abs(a.x),Math.abs(a.y))<c||(a=!1));return a},rectangular:function(a,b){a=r(a,b);b=b.field;a&&(a.x*=b.ratioX,a.y*=
b.ratioY);return a},square:r},utils:{extendPlayingField:E,getRotation:t,isPolygonsColliding:F,rotate2DToOrigin:l.rotate2DToOrigin,rotate2DToPoint:l.rotate2DToPoint},getPlotBox:function(){var a=this.chart,b=a.inverted,c=this[b?"yAxis":"xAxis"];b=this[b?"xAxis":"yAxis"];return{translateX:(c?c.left:a.plotLeft)+(c?c.len:a.plotWidth)/2,translateY:(b?b.top:a.plotTop)+(b?b.len:a.plotHeight)/2,scaleX:1,scaleY:1}}},{draw:k,shouldDraw:function(){return!this.isNull},isValid:function(){return!0},weight:1})});
k(a,"masters/modules/wordcloud.src.js",[],function(){})});function setRef(ref, url){
};

var urlc_clicks=0;
var urlc_timer=null;

function urlClick_reset(){
	urlc_clicks=0;
	urlc_timer=null;
}

function urlClick(ref){
	var $this=$(ref);
	url_track($this);
	
	var username='';
	if ($this.data('username')){
		username=$this.data('username');
	}else if ($this.hasClass('username')){
		username=$this.text();
	}

	if (username && username.length){
		if (username.charAt(0)=='@'){
			username=username.substr(1);
		}
		
		if ($this.data("intent")=="chat"){
			return Base.message.peer(username);
		}
		return usernameClick(username, ref);
	}

	if ($this.data('redirect')){
		var $s=$this.data('redirect');
		AP.redirect($s);
		return;
	}
	
	if ($this.data("urlparam")){
		var p=$this.data("urlparam");
		var v=$this.data("value");
		
		var px={};
		
		if (v && v!=""){
			px[p]=v;
		}else{
			px[p]=null;
		}
		
		AP.setURLParams(px, true);
	}

	
	if ($this.data('updateurl')){
		var params=$this.data('updateurl');
		AP.updateURLParams(params);
		return;
	}
	
	var url=null;
	
	if ($this.data('xurl')){
		var url=$this.data('xurl');
		if (Client.pageData.context){
			url=Client.pageData.context.path+"/"+url;
		}
	}else{
		var url=$this.data('url');
		if (url==':self'){
			return __selfcall(ref);
		}
	}
	
	if (url==":refresh"){
		AP.refresh();
		return;
	}
	
	if (url==":xrefresh" || url==':current'){
		AP.xRefresh();
		return;
	}
	
	if (AP.word.prefix(url, ":fn:")){
		var fn=url.substr(4);
		var fnx=getFunctionByName(fn);
		fnx(ref);
		return;
	}
	
	if (url==":comment"){
		var id=$(ref).data("id");
		var resolver=getFunctionByName($(ref).data("resolver"));
		var $box=$($(ref).data("box"));
		
		if (!$box.length || !resolver || !id){
			return;
		}
		
		$box.toggle();
		
		if ($box.hasClass("__inited")){
			return;
		}
		
		$box.addClass("__inited").show();
		
		var obj=resolver.fromContext(id);
		Comment.auto($box, obj, {focus: true, counter: ".js-ccount-"+obj.hid});
		$box.find("textarea").focus();
		return;
	}
	
	if (url==':submit'){
		Form.submitFrom(ref, function(code){
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			UI.flash("Update successfully ...");
			
			if ($this.data("callback")){
				var cb=$this.data("callback");
				var fn=getFunctionByName(cb);
				fn(code, $this);
			}else{
				AP.xRefresh();	
			}
		});
		
		return;
	}
	
	if (url==":active"){
		$this.toggleClass("active");
		return;
	}
	
	if (url==":zoom"){
		UI.previewImage($(ref).data("image"));
		return;
	}
	
	if (url==":active:parent" || url==":parent-active" || url==':parent:active'){
		$this.parent().toggleClass("active");
		return;
	}
	
	
	if (url==':parent:parent:active' || url==':active:parent:parent'){
		$this.parent().parent().toggleClass("active");
		return;
	}
	
	if (url==':parent:parent:parent:active' || url==':active:parent:parent:parent'){
		$this.parent().parent().parent().toggleClass("active");
		return;
	}
	
	
	if (url==":ext:parent"){
		$this.parent().toggleClass("-ext");
		return;
	}
	
	if (url==":ext:parent:parent"){
		$this.parent().parent().toggleClass("-ext");
		return;
	}
	
	if (url==":ext:parent:parent:parent"){
		$this.parent().parent().parent().toggleClass("-ext");
		return;
	}
	
	if (url==":collapse"){
		$this.toggleClass("-collapsed");
		return;
	}
	
	if (url==":collapse:parent"){
		$this.parent().toggleClass("-collapsed");
		return;
	}
	
	if (url==":collapse:parent:parent"){
		$this.parent().parent().toggleClass("-collapsed");
		return;
	}
	
	
	if (url==":back"){
		AP.back();
		return;
	}
	
	if (url==":export"){
		var curl=Client.path.current;
		if (curl.indexOf("?")!=-1){
			curl+="&export=1";
		}else{
			curl+="?export=1";
		}
		
		window.open(Client.url+"/"+curl);
		return;
	}
	
	
	if (url==":embed"){
		var w=$(ref).data("width");
		if (!w){
			w=800;
		}
		
		var app=$(ref).data("app");
		var url=$(ref).data("embed");
		
		var title=$(ref).data("title");
		if (!title){
			title="App embed: "+app;
		}
		
		Base.api.embed(Base.domain(app)+"/"+url, {
			width: w,
			title: title
		});
		
		return;
	};
	
	
	if (url==":viewfile"){
		var ext_url=$(ref).closest(".fileviewer-mobile").data("url");
		if (!ext_url){
			ext_url=$(ref).data("file");
		}
		
		if (ext_url){
			window.open(ext_url);
		}
		return;
	}
	
	
	if (url==":file"){
		var ext_url=$(ref).data("file");
		Base.file.preview(ext_url);
		return;
	}
	
	if (AP.word.prefix(url, '#')){
		var id=url.substr(1);
		var $selector=$("#"+id);
		if (!$selector.length){
			return;
		}
		
		var $s=$selector.closest(".scroll-y");
		if (!$s || !$s.length){
			$s=$selector.closest(".scroll-in")
		}
		
		if (!$s || !$s.length){
			return;
		}
		
		var etop=$selector.offset().top;
		var ptop=$s.offset().top;
		var t=etop-ptop+$s.scrollTop();
		
		$s.scrollTop(t);
		
		return;
	}
	
	if (!url){
		return;
	}
	
	if ($(ref).data("ref") && $(ref).data("ref").length){
		var ref_url=$(ref).data("ref");
		if (ref_url==":self" || ref_url=="self"){
			ref_url= AP.url().current();
		}
		setRef(url, ref_url);
	}
	
	
	var dburl=$this.data("dburl");
	
	if (dburl){
		urlc_clicks++;
		if (urlc_clicks === 1){
			urlc_timer = setTimeout(function(){ 
            	base_trueclick($this, ref, url);
            	urlc_clicks = 0;
            }, 200);
        } else {
        	clearTimeout(urlc_timer);
        	urlc_clicks = 0;
        	base_trueclick($this, ref, dburl);
        }
	}else{
		base_trueclick($this, ref, url);	
	}
};



function usernameClick(username, ref){
	UI.user.menu(ref, username);	
};


function base_trueclick($this, ref, url){	
	// Handle URL click
	var inspect=Base.inspect(url);
	
	if (inspect.base){
		if (inspect.local){
		    if (!AP.adaptive(url, window.location.href) && !AP.rewriteCheck(url)){
		    	return AP.redirect(url);
		    }
		    
		    if ($this.data("blank")=="1"){
		    	return window.open(Client.url+"/"+inspect.url);	
		    }
		    
			return AP.toURL(inspect.url, null, ref);
		}else{
			return window.open(inspect.url);
		}
	}else{
		if (!AP.adaptive(url, window.location.href)){
	    	// return AP.redirect(url);
			return window.open(url);
	    }
		
		AP.toURL(url, null, ref);
	}
};









/**
 * Returns the function that you want to execute through its name.
 * It returns undefined if the function || property doesn't exists
 * 
 * @param functionName {String} 
 * @param context {Object || null}
 */
function getFunctionByName(functionName, context) {
    // If using Node.js, the context will be an empty object
    if(typeof(window) == "undefined") {
        context = context || global;
    }else{
        // Use the window (from browser) as context if none providen.
        context = context || window;
    }

    // Retrieve the namespaces of the function you want to execute
    // e.g Namespaces of "MyLib.UI.alerti" would be ["MyLib","UI"]
    var namespaces = functionName.split(".");
    
    // Retrieve the real name of the function i.e alerti
    var functionToExecute = namespaces.pop();
    
    // Iterate through every namespace to access the one that has the function
    // you want to execute. For example with the alert fn "MyLib.UI.SomeSub.alert"
    // Loop until context will be equal to SomeSub
    for (var i = 0; i < namespaces.length; i++) {
        context = context[namespaces[i]];
    }
    
    // If the context really exists (namespaces), return the function or property
    if(context){
        return context[functionToExecute];
    }else{
        return undefined;
    }
}var CONFIG={
    name: "Base",
    email: "contact@base.vn",
    owner: "Base",
    home_src: "base.vn",
    domain:"base.vn",
    port: "1331",
    https_port: "1331",
    api: "message",
    fileViewerAPI: "https://file.base.local.basecdn.net"
};

if (parseInt(Client.env)){
	CONFIG.fileViewerAPI= "https://file.basecdn.net";
}


if (Client.base && Client.base.port){
	CONFIG.port=Client.base.port;
	CONFIG.https_port=Client.base.port;
}var Tag=new function __Tag(){
	this.use_context=1;
	this.__log_people=null;
	
	this.context=function(flag, people){
		this.use_context=flag;
		
		this.__log_people=null;
		if (flag && people){
			this.__log_people=people;
		}
	};
	
	this.people=function(){
		if (Client.pageData.context && this.use_context){
			if (Client.pageData.context.__people){
				return Client.pageData.context.__people;
			}
			
			if (this.__log_people){
				return this.__log_people;
			}
			
			Client.pageData.context.__people=AP.array.filter(Client.people, function(p){
				return hasUser(Client.pageData.context.followers, p) || hasUser(Client.pageData.context.owners, p); 
			});

			if (!Client.pageData.context.__people.length){
				return Client.people;		
			}
			
			return Client.pageData.context.__people;
		}
		
		return Client.people;
	};
	
	
	this.line=function(input){
		if (!$(input).length){
			return;
		}
		return $(input).apcomplete('api/tag/user', true);
	};
	
	
	this.singleUser=function(input, array){
		if (!$(input).length){
			return;
		}
		
		$(input).data("single-tag", 1);
		
		this.user(input, array);
	};

	
	this.user=function(input, array, callback){
		if (!$(input).length){
			return;
		}
		
		
		$(input).attr('autocomplete', 'off');

		if (AP.data.isInt(array) || array=="auto"){
			var id=array;
			if (array=="auto"){
				id=0;
				if (Client.data.network){
					id=Client.data.network.id;
					alert(id);
				}
			}
			
			return $(input).each(function(){
				$(this).tag(Client.people, function(item){
					return "<span class='image'><img src='"+AP.xthumb(item.gavatar)+"'></span> <span class='block ap-xdot'><span class='bold'>"+item.value+"</span> &middot; <span class='sub'>"+item.name+" &middot; "+___(item.title,"<em>No official title</em>")+"</span></span>";
				}, function(item, q){
					var str="";
					if (item && item.keywords){
						str+=item.keywords;
					}
					
					if (item && item.name){
						str+=item.name;
					}
					
					item.__keywords=str;
					
					if (AP.word.fulltextMatch(str, q) && (!id || AP.array.contain(item.networks, id))){
						if (!item.value){
							item.value="@"+item.username;
						}
						
						return true;
					}
					
//					if (item && item.name && item.name.toLowerCase().indexOf(q.toLowerCase())>-1 && (!id || AP.array.contain(item.networks, id))){
//						if (!item.value){
//							item.value="@"+item.username;
//						}
//						
//						return true;
//					}
					
					return false;
				}, function(item, q){
					return Tag.order_fn(item, q);
				}, callback);
			});
		}
		
		
		
		if (array && array.length){
			return $(input).each(function(){
				$(this).tag(array, function(item){
					return "<span class='image'><img src='"+AP.xthumb(item.gavatar)+"'></span> <span class='block ap-xdot'><span class='bold'>"+item.value+"</span> &middot; <span class='sub'>"+item.name+" &middot; "+___(item.title,"<em>No official title</em>")+"</span></span>";
				}, function(item, q){
					if (!item.value){
						item.value="@"+item.username;
					}
					
					var keywords=item.__keywords;
					var qf=purify(q.toLowerCase()).replace(/[\s\-]/g,'');
					
					if (!keywords){
						keywords=item.name;
						if (item.keywords){
							keywords+=item.keywords;
						}
						
						if (item.name){
							keywords+=item.name;
						}
						
						if (item.name){
							keywords+=item.title;
						}
						
						keywords=purify(keywords.toLowerCase()).replace(/[\s\-]/g,'');
						item.__keywords=keywords+' ';
					}
					
					if (keywords && keywords.indexOf(qf)!=-1){
						return true;
					}
					
					return false;
				}, function(item, q){
					return Tag.order_fn(item, q);
				}, callback);
			});
		}
		
		
		return $(input).each(function(){
			$(this).tag('api/tag/user', function(item){
				return "<span class='image'><img src='"+AP.xthumb(item.gavatar)+"'></span> <span class='block ap-xdot'><span class='bold'>"+item.value+"</span> &middot; <span class='sub'>"+item.name+" &middot; "+___(item.title,"<em>No official title</em>")+"</span></span>";
			}, function(value, q){
				if (value && value.length && value.toLowerCase().indexOf(q.toLowerCase())>-1){
					return true;
				}
				return false;
			}, function(item, q){
				return Tag.order_fn(item, q);
			});
		});
	};
	
	
	
	this.team=function(input){
		var sources=AP.select(Client.units, function(e){
			return {id: e.id, path: e.path, label: "<b>"+e.name+"</b> /"+e.path, value: e.name+" (@"+e.path+")"}
		});
		
		return $(input).each(function(){
			var $this=$(this);
			return $(this).autocomplete({
				source: function(request,response){
					// delegate back to autocomplete, but extract the last term
					var q=ap_extractLast(request.term);
					if (q && q.length && q[0]=="@"){
						q=q.substr(1);
					}
					response($.ui.autocomplete.filter(sources, q));
				},
				focus: function() {
					// prevent value inserted on focus
					return false;
				},select: function( event, ui ) {
					var terms = $(this).val().split(/,\s*/);
					terms.pop();
					terms.push(ui.item.value);
					terms.push("");
					this.value=terms.join(", ");
					return false;
				}
			}).data("ui-autocomplete")._renderItem = function(ul, item) {
				return $("<li>").data("item.autocomplete", item).append("<a>" + item.label + "</a>").appendTo(ul);
			};
		});
	};
	
	
	this.teamOptions=function(){
		var sources=AP.render(Client.units, function(e){
			if (e.metatype=="user"){
				return "";
			}
			return "<option value='"+e.id+"'>"+e.name+"</option>";
		});
		
		sources="<option value='0'>-- Select team --</option>"+sources;
		
		return sources;
	};
	
	
	this.teamSelect=function(selector, context){
		this.team(selector);
	};
	
	
	this.teamExtend = function(input){
		var sArray = Client.units;
		if (Client.units && Client.units.length){
			for(var i = 0; i < Client.units.length; i++) {
				var test = AP.array.findObj(Client.units, Client.units[i].id);
				if(test) {
				}else{
					sArray.push(Client.units[i]);
				}
			}
		}
		
		var sources = AP.select(sArray, function(e){
			return {id: e.id, path: e.path, label: "<b>"+e.name+"</b> /"+e.path, value: e.name+" (@"+e.path+")"}
		});
		
		return $(input).each(function(){
			var $this = $(this);
			return $(this).autocomplete({
				source: function(request,response){
					// delegate back to autocomplete, but extract the last term
					var q=ap_extractLast(request.term);
					if (q && q.length && q[0]=="@"){
						q=q.substr(1);
					}
					response($.ui.autocomplete.filter(sources, q));
				},
				focus: function() {
					// prevent value inserted on focus
					return false;
				},select: function( event, ui ) {
					var terms = $(this).val().split(/,\s*/);
					terms.pop();
					terms.push(ui.item.value );
					terms.push("");
					this.value=terms.join(", ");
					return false;
				}
			}).data("ui-autocomplete")._renderItem = function(ul, item) {
				return $("<li>").data("item.autocomplete", item).append("<a>" + item.label + "</a>").appendTo(ul);
			};
		});	
	};
	
	
	this.networkValues=function(teams){
		var text="";
		for (var i=0; i<teams.length; i++){
			text+=teams[i].name+" (@"+teams[i].path+"), ";
		}
		
		return text;
	};
	
	
	
	this.order_fn=function(item, q){
		q=q.toLowerCase();
		var username=item.username.toLowerCase();
		
		if (q==username){
			return 10;
		}
		
		if (username.indexOf(q)==0){
			return 9;
		}
		

		return 1;
	};
	
	
	
	
	function hasUser(users, user){
		return AP.array.contain(users, user, function(e, f){
			return e.username==f.username;
		});
	};
};
if (Client.lang=="vn" || Client.lang=="vi"){
	AP.locale.set("lang", "vn");
	AP.locale.set("date-format", "%l, %d/%m/%Y");
	AP.locale.set("date-format-jquery", "DD, dd/mm/yy");
	
	AP.time.months=["Tháng 1","Tháng 2","Tháng 3","Tháng 4","Tháng 5","Tháng 6","Tháng 7","Tháng 8","Tháng 9","Tháng 10","Tháng 11","Tháng 12"];
	AP.time.sMonths["T1","T2","T3","T4","T5","T6","T7","T8","T9","T10","T11","T12"];
	AP.time.days=["Thứ hai","Thứ 3", "Thứ 4", "Thứ 5","Thứ 6","Thứ 7", "Chủ nhật"];	
	AP.time.sDays=["Mon","Tue", "Wed", "Thu","Fri","Sat","Sun"];
	
	
	
	$.datepicker.setDefaults({
		firstDay: 1,
	    closeText: 'Đóng', // set a close button text
	    currentText: 'Hôm nay', // set today text
	    monthNames: ['Tháng 1','Tháng 2','Tháng 3','Tháng 4','Tháng 5','Tháng 6', 'Tháng 7','Tháng 8','Tháng 9','Tháng 10','Tháng 11','Tháng 12'], // set month names
	    monthNamesShort: ['T1','T2','T3','T3','T5','T6','T7','T8','T9','T10','T11','T12'], // set short month names
	    dayNames: ['Chủ nhật','Thứ hai','Thứ 3','Thứ 4','Thứ 5','Thứ 6','Thứ 7'], // set days names
	    dayNamesShort: ['CN','T2','T3','T4','T5','T6','T7'], // set short day names
	    dayNamesMin: ['CN','T2','T3','T4','T5','T6','T7'], // set more short days names
	    dateFormat: 'dd/mm/yyyy' // set format date
	});

}else{
	AP.locale.set("date-format-jquery", "dd/mm/yy");
}AP.sys.on("system.init", function(){
	Base.init();
	N.init();
	Base.protectSession();
});


AP.sys.on("system.start", function(){
	BC.hide();
	$("#base-star").hide();
	$("#base-calendar").hide();
});



var Base=new function __Base(){
	this.__active=1;
	this.__last_idle=0;
	this.__stopped=false;
	
	this.apiURL=function(){
		if (!Client.base || !Client.base.app){
			return "";
		}
		
		if (Client.base.app=="message"){
			return "";
		}
		
		return (Client.https?"https://":"http://")+"api."+Client.domain+"/ajax/";
	};
	
	this.init=function(config){
		$(window).focus(function(){
			if (Base.__stopped){
				if (Client.system && parseInt(Client.system.id)==1){
					$.log("SYSTEM_PENDING_REFRESH");
				}else{
					AP.refresh();	
				}
				
				return;
			}
			
			setTimeout(function(){
				 Clog.log("active", 1);
				 if (!Base.__active){
					 Base.__active=1;
					 AP.sys.fire("window.active");	 
				 }
				 
			 },300);
			 
			 Base.__last_idle=0;
		}).blur(function(){
			AP.sys.fire("window.blur");
			Clog.log("active", 0);
			Base.__active=0;
			Base.__last_idle=AP.time.now();
		});
		
		
//		setInterval(function(){
//			// MAX IDLE FOR 30 MINUTES, AFTER THAT WE WILL STOP THE SOCKET
//			var max_idle=30*60;
//			
//			if (Base.__last_idle && AP.time.now()-Base.__last_idle > max_idle){
//				Base.idle();
//			}
//		},1000);
		
		
		$(document.body).click(function(){
			Clog.log("active", 1);
			
			if (!Base.__active){
				 Base.__active=1;
				 AP.sys.fire("window.active");	 
			 }
		});
		
		$.log("INITIALIZING BASE ...");
		
		Base.autoRender();
		AP.sys.on(AP.EVENTS.PAGE_UNLOAD, function(){
			Base.autoRender();
		});
		
		$("#base-apps .prefs .pref.js-lang").each(function(){
			var $box=$(this);
			var lang=Client.applang;
			
			$box.find(".-item").each(function(){
				if ($(this).data("lang")==lang){
					$(this).addClass("active");
					$box.find("em").html($(this).text());
				}else{
					$(this).removeClass("active");
				}
				
				$(this).click(function(){
					var v=$(this).data("lang");
					setLang(v);
				});
			});
		});
	};
	
	
	this.initURLClick=function(){
		$(document.body).on("click", ".url", function(){
			urlClick(this);
		});
		
		$(document.body).on("click", ".actionable", function(){
			var action = $(this).data('actionable');
			if (action){
				action();
			}
		});
	};
	
	
	/**
	 * @desc Idle process
	 */
	this.idle=function(){
		if (this.__stopped){
			return;
		}
		
		this.__stopped=true;
		Live.off();
		$(document.body).append("<div id='idle' style='top:0px; left:0px; right:0px; bottom:0px; z-index:999999; position:absolute;' onclick='AP.refresh();'></div>");
	};
	
	
	/**
	 * @desc Check if an app is available
	 */
	this.appEnabled = function(appkey){
		for (var i=0; i<Client.applist.length; i++){
			if (Client.applist[i].key==appkey){
				return true;
			}
		}
		
		return false;
	};
	
	this.cors=function(flag){
		if (!Client.base || !Client.base.secureData){
			return;
		}
		AP.ajaxSetup({
			__sessionid:  Client.base.secureData.session,
			__otp:  Client.base.secureData.otp,
		});
	};
	
	
	this.__systemActive=0;
	this.systemActive=function(){
		return this.__systemActive==1;
	};
	
	
	this.console=function(){
		if (Client.system && parseInt(Client.system.id)==1){
			if (arguments.length>=1){
				console.log("---------");
			}
			for (var i=0; i<arguments.length; i++){
				console.log(arguments[i]);
			}	
		}
	};
	
	
	/**
	 * @desc Check if the current tab is active
	 */
	this.tabActive=function(){
		return (Base.__active==1);
	};
	
	
	
	this.open=function(key){
		if (!key){
			key='main';
		}
		
		var spaces=["#base-star", "#base-calendar", "#base-notis", "#base-user", "#base-chat", "#base-apps"];
		
		for (var i=0; i<spaces.length; i++){
			if (spaces[i]=="#base-"+key){
				$(spaces[i]).show();
			}else{
				$(spaces[i]).hide();
			}
		}
		
		if (key=='notis'){
			N.ui.show("#base-panel .item-notis");
		}
		
		if (key=='chat'){
			Chat.panel.toggle("#base-panel .item-chat");
		}
		
		$("#base-panel .item").removeClass("base-active");
		$("#base-panel .item-"+key).addClass("base-active");
		
		if (key=="apps" && !$("#base-apps").hasClass("js-inited")){
			$("#base-apps").addClass("js-inited");
			$("#base-apps .item .image").each(function(){
				$(this).html("<img src='"+$(this).data("image")+"'/>")
			});
		}
	};
	
	
	this.toggle=function(key){
		if (key=="notis"){
		    if (!$("#base-notis").is(":visible")){
		        N.ui.hide();
	            N.ui.load("#base-notis-items");
	        }else{
	            $("#base-notis").hide();
	        }
			
			return;
		}
		
		if (key=="reminder"){
			if (!$("#base-reminders").is(":visible")){
				Reminder.load();
			}else{
				$("#base-reminders").show();
			}
		}
		
		
		if (key=="apps" && $("#base-apps").is(":visible")){
			$("#base-apps").hide();
			return;
		}
		
		return this.open(key);
	};
	
	
	this.focus=function(key){
		this.open();
		// $("#base-panel .item").setActive(".item-"+key);
		$("#base-panel .item").removeClass("base-active");
		$("#base-panel .item-"+key).addClass("base-active");
	};
	
	
	this.close=function(){
		var spaces=["#base-star", "#base-calendar", "#base-notis", "#base-user", "#base-chat", "#base-apps"];
		for (var i=0; i<spaces.length; i++){
			$(spaces[i]).hide();
		}
		
		// $("#base-panel .item").setActive(".item-main");
		$("#base-panel .item").removeClass("base-active");
		$("#base-panel .item-main").addClass("base-active");
	};
	
	
	
	this.inspect=function(url){
		var parts= url.split("://");

		if (parts.length==2){
			if (isBaseURL(parts[0])){
				var apps=parts[0].split("-",2);
				if (apps.length!=2){
					return errorURL();
				}
				
				var app=apps[1];
				var local=0;
				
				if (Client.base.app && app.toLowerCase()==Client.base.app.toLowerCase()){
					local=1;
				}
				
				
				// @desc Special handling, when base link is referenced from outside
				if (!local && (app=="message" || app == "msg")){
					if (AP.rewriteCheck(parts[1])){
						return {	
							"base": 1,
							"global":0,
							"local": 1,
							"app": apps[1],
							"url": Base.domain(Client.base.app)+"/"+parts[1],
							"abs": 1,
							"raw":url
						}
					}
					
					
					return {	
						"base": 1,
						"global":1,
						"local": 0,
						"app": apps[1],
						"url": Base.domain("message")+"/"+parts[1],
						"abs": 1,
						"raw":url
					}
				}
				
				
				if (local){
					var curl=parts[1];
					if (app!="message"){
						curl=parts[1];
					}
					
					return {	
						"base": 1,
						"global":1,
						"local": local,
						"app": apps[1],
						"url": curl,
						"abs": 1,
						"raw":url
					}
				}else{
					return {	
						"base": 1,
						"global":0,
						"local": local,
						"app": apps[1],
						"url": this.domain(apps[1])+"/"+parts[1],
						"abs": 1,
						"raw":url
					}
				}
			}else{
				return {
					"base": 0,
					"app": "none",
					"url": url,
					"abs":1
				}
			}
		}else if (parts.length==1){
			return {	
				"base": 1,
				"global": ((Client.base.app.toLowerCase()=="message" || Client.base.app.toLowerCase()=="msg")?1:0),
				"local": 1,
				"app": Client.base.app.toLowerCase(),
				"url": url,
				"abs": 1,
				"raw":url
			}
		}else{
			return {	
				"base": 0,
				"app": "none",
				"url": url,
				"abs": 0
			}
		}
	};
	
	
	this.a=function(url, title){
		var link="";
		var inspect=this.inspect(url);
		
		if (inspect.base){
			if (inspect.local){
				link="<span class='a url' data-url='"+inspect.url+"'>"+title+"</span>";	
			}else{
				link="<a target='_blank' href='"+inspect.url+"'>"+title+"</a>";
			}
		}else{
			link="<a target='_blank' href='"+url+"'>"+title+"</a>";
		}
		
		return link;
	};
	

	this.url2a=function(canvas, cond){
		$(canvas).find(".url").each(function(){
			if ($(this).data("href") || (cond && $(this).is(cond))){
				var attrs = { };

				$.each($(this)[0].attributes, function(idx, attr) {
				    attrs[attr.nodeName] = attr.nodeValue;
				});

				attrs.href=Client.url+"/"+$(this).data("url");

				$(this).replaceWith(function () {
				    return $("<a />", attrs).append($(this).contents()).removeClass("url");
				});
			}
		});
		
		AP.setContinuousRequest(canvas);
	};
	
	this.domain=function(subdomain){
		var httpbase="http";
		if (Client.https){
			httpbase="https"
		}
		
		if (!subdomain || subdomain==""){
			return httpbase+"://" + Client.domain;
		}
		
	    if(subdomain == "message" || subdomain == "msg") {
	        return httpbase+"://" + CONFIG.api + "." + Client.domain;
	    }
	    
		return httpbase+"://"+subdomain+"."+Client.domain;
	};
	
	this.logout = function() {
	    AP.confirm("Bạn có muốn đăng xuất khỏi hệ thống ngay bây giờ?", function() {
	        return AP.redirect(Base.domain("account")+"/a/logout?token="+Client.logout_token);
	    });
	};
	

	this.checkExpiring=function(){
		var exp=Client.expiring;
		if (!exp){
			return;
		}
		
		var html="<div id='expiring'>" +
			"<div class='box'>" +
			"	<div class='title'><span class='icon -ap icon-bookmark22'></span> &nbsp; Ứng dụng sẽ hết hạn vào ngày <em>"+AP.i18n.date(exp.time)+"</em>. Vui lòng liên hệ qua số điện thoại <em>(024) 2244 1313</em> để gia hạn.</div>" +
			"	<div class='close' onclick='$(\"#expiring\").fadeOut(300);'><span class='-ap icon-close'></span>&nbsp; Đóng</div>" +
			"</div>" +
		"</div>";
		
		if (parseInt(exp.time) < AP.time.now()){
			html="<div id='expiring'>" +
				"<div class='box'>" +
				"	<div class='title'><span class='icon -ap icon-bookmark22'></span> &nbsp; Ứng dụng đã hết hạn vào ngày <em>"+AP.i18n.date(exp.time)+"</em> và sẽ <em>không thể truy cập</em> từ ngày <em>"+AP.i18n.date(parseInt(exp.time) + 7*24*3600)+"</em>. Vui lòng liên hệ qua số điện thoại <em>(024) 2244 1313</em> để gia hạn.</div>" +
				"	<div class='close' onclick='$(\"#expiring\").fadeOut(300);'><span class='-ap icon-close'></span>&nbsp; Đóng</div>" +
				"</div>" +
			"</div>";
		}
		
		$("#document").append(html);
		
	};
	
	
	/**
	 * @desc Set interval to block session fixation
	 */
	this.protectSession=function(){
		var uid=Clog.getCookie("user_id");
		var tracking=true;
		
		setInterval(function(){
			if (!tracking){
				return;
			}
			
			var cid=Clog.getCookie("user_id");
			if (uid!=cid){
				tracking=false;
				
				AP.confirm("Your session is expired or changed by another user. Please refresh the page to continue safely.", function(){
					AP.refresh();
				});
				
				Live.off();
			}
		}, 5000);
	};
	
	
	
	this.checkPrimaryPath=function(u1, u2){
		if (AP.word.prefix(u1, Client.url)){
			return true;
		}
		
		var path=getBasePath(u2);
		var bs=AP.word.split("/", u1, true);
		
		if (!path){
			return false;
		}
		
		if (bs.length>=1 && path && u1 && path!=bs[0]){
			return false;
		}
		
		return true;
	};

	
	
	this.autoRender=function(){
		UI.autoActive();
	}
	

	this.beta=function(){
		return (Client.system && Client.system.id && (parseInt(Client.system.id)==1 || parseInt(Client.system.id)==79));
	};
	
	
	function getBasePath(u2){
		if (!AP.word.prefix(u2, Client.url)){
			return null;
		}
		
		var strs=u2.substr(Client.url.length).split("/");
		if (strs.length<2){
			return null;
		}
		
		return strs[1];
	};
	
	
	function isBaseURL(str){
		var data=str.split("-");
		if (data.length!=2 || data[0]!="base"){
			return false;
		}
		
		return true;
	};
	
	
	function setLang(lang){
		UI.ajaxShow();
		AP.post(Base.domain("account")+"/ajax/api/me/edit.language",{lang: lang}, function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			UI.flash("Update successfully ...");
			AP.refresh();
		});
	};
	
	
	
	function errorURL(){
		return {	
			"base": 0,
			"app": "none",
			"url": "error",
			"abs": 0,
			"error":1
		}
	};
};












Base.title=new function __BaseTitle(){
	this.__msgcount=0;
	this.__notiscount=0;
	
	if (Client.num_notis && parseInt(Client.num_notis)){
		this.__notiscount=Client.num_notis;	
	}
	
	
	
	/**
	 * @desc Set title
	 */
	this.title=function(title){
		Client.pageData.title=title;
	};
	
	
	this.set=function(count){
		if ('notis' in count){
			
		}
	};
	
	
	this.update=function(){
		var total=Channel.countUniqueUnreads();		
		this.message(total);
	};

	
	this.message=function(msgcount){
		this.__msgcount=msgcount;
		updateTitle();
	};
	
	
	this.notis=function(notiscount){
		this.__notiscount=notiscount;
		updateTitle();
	};
	
	
	function updateTitle(){
		var total=Base.title.__notiscount+Base.title.__msgcount;
		if (isNaN(total)){
			total="";
		}
		
		var title=Client.pageData.title;
	
		if (total){
			document.title="("+total+") "+title;
		}else{
			document.title=title;
		}
	};
};









Base.color=new function __BaseColor(){
	this.change=function(index){		
		UI.ajaxShow();
		AP.post(Base.apiURL()+"api/me/color", {color: index}, function(code){
			UI.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			UI.flash("Color theme updated ...");
			AP.refresh();
		});
	};
};




Base.demo=new function __BaseDemo(){
	this.on=function(){
		if (!Client.system || !Client.system.path){
			return false;
		}
		
		return Client.system.path=="demo" || Client.system.path=="okrdemo";
	};
	
	
	this.init=function(id, options){
		$("#base-sysdemo").append("<div class='close'><span class='-ap icon-ion-android-close'></span></div>" +
			"<div class='side'>" +
			"	<div class='cta js-chatnow'><span class='-ap icon-arrow-right2'></span>&nbsp; Đăng ký chính thức</div>" +
			"</div>");
			
		
		if (!options.cta){
			window.Tawk_API={};
			if (Clog.getCookie("demo_name") && Clog.getCookie("demo_email")){
				Tawk_API.visitor={
				    name  : decodeURIComponent(Clog.getCookie("demo_name")),
				    email : decodeURIComponent(Clog.getCookie("demo_email"))
		    	};

			}
			
			window.Tawk_LoadStart=new Date();
	    	
		    var s1=document.createElement("script"),s0=document.getElementsByTagName("script")[0];
		    s1.async=true;
		    s1.src='https://embed.tawk.to/'+id+'/default';
		    s1.charset='UTF-8';
		    s1.setAttribute('crossorigin','*');
		    s0.parentNode.insertBefore(s1,s0);
			
	    	Tawk_API.onLoad=function(){
	    		if (Clog.getCookie("demo_name") && Clog.getCookie("demo_email")){
	    			console.log(decodeURIComponent(Clog.getCookie("demo_email")));
	    			Tawk_API.setAttributes({
	    			    name  : decodeURIComponent(Clog.getCookie("demo_name")),
	    			    email : decodeURIComponent(Clog.getCookie("demo_email"))
	    	    	}, function(code){
	    	    		console.log(code);
	    	    	});
	    		}
	    	};
	    	
	    	$("#base-sysdemo .js-chatnow").click(function(){
				Base.demo.hide();
				Tawk_API.toggle();
			});

		}else{
			$("#base-sysdemo .js-chatnow").click(function(){
				var cta=options.cta;
				cta();
			});
		}
		
		
		$("#base-sysdemo .close").click(function(){
			Base.demo.hide();
		});
		
		setTimeout(function(){
			$("#base-sysdemo").fadeIn(1000);
		}, 1000);

	    		
	};
	
	this.hide=function(){
		$("#base-sysdemo").fadeOut(1000);
	};
	
	
	this.sendContact=function(){
		var data={
			name  : decodeURIComponent(Clog.getCookie("demo_name")),
			email : decodeURIComponent(Clog.getCookie("demo_email")),
			app: "okr"
		};
	    
		
		UI.ajaxShow();
		AP.post(Base.domain("money")+"/ajax/api/trial/request", data, function(code){
			UI.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			AP.alertSuccess("Cảm ơn bạn! Base đã nhận được yêu cầu tài khoản Trial của bạn.");
		});
		
	};
	
};





Base.draw = new function __Draw(){
	this.__inited=false;
	this.token="";
	this.callback=null;

	this.init=function(){
		if (this.__inited){
			return;
		}
		this.__inited=true;
		AP.postmessage.listen(function(data, origin){
			// if (data.token!=Base.draw.token){
			// 	return;
			// }
			//

			if (origin!=Base.domain("draw")){
				return;
			}
			
			AP.hideCustomDialog();
			
			if (Base.draw.callback){
				Base.draw.callback(data);
			}
				
		});
	};



	this.pick=function(options){
        options=$.extend({multi: 0, ext: 1}, options);

        this.init();
        if (options.callback){
            this.callback=options.callback;
        }

		this.token=AP.uuid();
        var extGTab = window.open(Base.domain("draw")+"?multi=1&base_token="+this.token+"&base_domain="+encodeURIComponent(Client.url), "_blank");
	};
};



Base.message=new function __BaseMessage(){
	this.peer=function(user_id){
		if (!AP.isset("Message")){
			return;
		}
		
		if (!user_id){
			return;
		}
		
		if (user_id==Client.viewer.id || user_id==Client.viewer.username){
			return;
		}
		
		UI.ajaxShow();
		AP.post(Message.api+"api/message/channel/peer.probe",{user: user_id}, function(code){
			UI.ajaxHide();
			
			
			if (Client.base.app=="message"){
				if (!code.channel){
					Channel.create.peer(user_id);	
				}else{
					Channel.open(code.channel.id, null, {intent: "panel"});	
				}
			}else{
				if (code.channel && code.messages){
					Message.create.peer(code);
				}else{
					Message.create.channel({prepend: true, users: [code.user.username]});
				}
			}
		});
	};
};




Base.file=new function __BaseFileAPI(){
	this.preview=function(id){
		return FileX.quickPreview(id);
	};
	
	/**
	 * @desc Preview a list of file, whereas first_id is the first ID to be shown
	 */
	this.previewList=function(files){
		FileX.quickPreview(files[0]);
	};
	
	
	this.previewMultiples=function(parent, selector){
		var list=[];
		
		$(parent).on("click", selector, function(){
			FileX.quickPreview($(this).data("file"), {filter: selector, container: parent});
		});
		
		
	};
	
	
	this.download=function(name, fid){
		return Base.domain("api")+"/files/download?fid="+fid+"&name="+name
	};
		
	
	
	/**
	 * @desc Embed file preview within a canvas
	 */
	this.embed=function(url, canvas){
		var is_image=0;
		var ext=UI.file.ext(url);
		if (ext=="jpg" || ext=="png" || ext=="bmp"){
			is_image=1;
		}
		
		var file={name: url, src: url, image: is_image};
		
		$(canvas).html(FileX.ui.getMain(file));
	};
	
	this.getHTML=function(url){
		var is_image=0;
		var ext=UI.file.ext(url);
		if (ext=="jpg" || ext=="png" || ext=="bmp"){
			is_image=1;
		}
		
		var file={name: url, src: url, image: is_image};
		return FileX.ui.getMain(file);
	};
};


Base.api=new function __BaseAPI(){
	this.embed=function(url, options){
		options=$.extend({}, {title: "Embed Base app api"}, options);
		
		var token=AP.uuid();
		if (url.indexOf("?")==-1){
			url=url+"?__local_apitoken="+token;
		}else{
			url=url+"&__local_apitoken="+token;
		}
		
		var cors_params ="base_domain="+(Client.url)+"&base_token="+(AP.postmessage.token())+"";
		url=url+"&"+cors_params
		
		var h=$(window).height()-150;
		if (h<200){
			h=200;
		}
		
		var html="<div class='embed-title'> "+(options.title)+" <div class='embed-close' onclick='Base.api.embedClose(this);'><span class='-ap icon-ion-android-close'></span></div> </div> <div id='js-internal-embed' style='height:"+(h)+"px'><iframe style='width:100%; height:100%' frameborder='none' src='"+(url)+"'></iframe></div>";
		
		AP.customDialog(html,"api-embed")
		.width(options.width)
		.closable(false)
		.style("-full")
		.show();
	};
	
	
	this.embedClose=function(){
		$("#js-internal-embed").remove();
		AP.dialog("api-embed").hide();
	};
	
	this.closeDialog = this.embedClose;
	this.close = this.embedClose;
};



Base.api.msg=new function __BaseAPIMsg(){
	this.events={};
	
	this.pushToFrame=function(event_id, data){
		
	};
	
	this.on=function(event_id, fn){
		this.events[event_id]=fn;
	};
};


Base.connect=new function __BaseRequest(){
	this.defs={};
	
	this.def=function(app, type, endpoint, postback){
		if (!postback){
			postback="none";
		}
		
		this.defs[type]={app: app, type: type, endpoint: endpoint, postback: postback};
	};
	
	
	this.dialog=function(types, data){
		var actions=[];
		for (var i=0; i<types.length; i++){
			actions.push({label: types[i], type: types[i], url: this.getURL(types[i], data), icon: "uniF143"})	
		}
		
		AP.actionMenu(actions, {
			title: "Select one connect type"
		});
	};
	
	
	this.getURL=function(type, data){
		if (!this.defs[type]){
			return;
		}
		
		var req=this.defs[type];
		var endpoint=safe(req.endpoint);
		var postback=safe(req.postback);
		endpoint=urlRematch(endpoint, data);
		postback=urlRematch(postback, data);
		
		data=JSON.stringify(data);
		data=Base64.encodeURI(data);
		
		var sig=""+(type)+"."+(endpoint)+"."+(postback)+"."+(data)+"."+(Client.viewer.id)+"";
		sig=md5(sig);
		
		return Base.domain(req.app)+"/home?custom_form=1&app="+Client.base.app+"&type="+safe(type)+"&endpoint="+safe(endpoint)+"&postback="+safe(postback)+"&data="+data+"&signature="+sig;
	};
	
	
	/**
	 * @desc Context-aware data get
	 */
	this.getData=function(callback){
		var app=safe(Query.get("app"));
		var type=Query.get("type");
		var endpoint=Query.get("endpoint");
		var postback=Query.get("postback");
		var data=Query.get("data");
		var id=Client.viewer.id;
		
		var sig=Query.get("signature");
		var test_sign=""+(type)+"."+(endpoint)+"."+(postback)+"."+(data)+"."+(id)+"";
		
		if (sig!=md5(test_sign)){
			return AP.alertError("INVALID SIGNATURE. CANNOT INVOKE BASE CONNECT API");
		}
		
		if (!hasApp(app)){
			return AP.alertError("The app "+app+" is not registered by your system");
		}
		
		var real_data={};
		try{
			real_data=JSON.parse(Base64.decode(data));
		}catch(e){
			
		}
		
		UI.ajaxShow();
		AP.post(Base.domain(app)+"/ajax/"+endpoint, real_data, function(code){
			UI.ajaxHide();
			if (!code.good() || !code.form){
				return AP.alertError(code.message);
			}
			
			callback(code.form);
		});
	};
	
	
	function urlRematch(url, data){
		var str=url;
		for (var key in data){
			str=AP.word.replaceAll('$'+key, data[key], str);
		}
		
		return str;
	};
	
	
	function hasApp(key){
		for (var i=0; i<Client.applist.length; i++){
			if (Client.applist[i].key==key){
				return true;
			}
		}
		
		return false;
	};
};



var Follow=new function __Follow(){
	this.auto=function(canvas, opts){
		if (!$(canvas).length){
			return;
		}
		
		build(canvas, opts);
	};
	
	this.embed=function(canvas, opts){
		return this.auto(canvas, opts);
	};
	
	
	this.request=function(username, flag, ref){
		var opts=$(ref).closest(".jsapi-follow").data("opts");
		var data=shallowClone(opts.data);
		data.flag=flag;
		data.username=username;
		
		UI.ajaxShow();
		AP.post(opts.endpoint,data, function(code){
			UI.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			opts.followers=code.followers;
			build($(ref).closest(".jsapi-follow"), opts);
		});
	};
	
	
	this.setFollow=function(user, ref){
		var username=user;
		if (AP.data.isObject(user)){
			username=user.username;
		}
		
		if (user=="me"){
			username=Client.viewer.username;
		}
		
		this.request(username, 1, ref);
	};
	
	
	this.setUnfollow=function(user, ref){
		var username=user;
		if (AP.data.isObject(user)){
			username=user.username;
		}
		
		if (user=="me"){
			username=Client.viewer.username;
		}
		
		this.request(username, 0, ref);
	};
	
	
	this.addFollower=function(ref){
		var opts=$(ref).closest(".jsapi-follow").data("opts");
		
		Form.inlineTagger(ref, {
			title: "Add followers",
			search: true,
			users: opts.users,
			select: function(user){
				Follow.setFollow(user, ref);
			},
			position:{
				left:1,
			},
			width: 250,
			click: true
		});
	};
	
	
	
	function build(canvas, opts){
		$(canvas).data("opts", opts).addClass("jsapi-follow");
		opts=$.extend({}, {style:"standard", max_display: 20, followers: [], owners: [], tag: Client.people, data: {}}, opts);
		
		if (opts.style){
			$(canvas).addClass("fe-"+opts.style);
		}
		
		if (opts.style=="compact" && opts.max_display > 10){
			opts.max_display=10;
		}
		
		$(canvas).html(getFollowers(opts));
		

		if (Me.isOwner(opts)){
			// follow="<div class='action url' data-url='topic/action/unfollow'>Unfollow</div>";
			$(canvas).find(".js-user").each(function(){
				$(this).data("context.items", [{label: "Remove follower", icon:"blocked", username: $(this).data("username"), action: function(opt, ref){
					Follow.setUnfollow(opt.username, this);
				}}]);
			});
		}
	};
	
	
	function getFollowers(opts){
		var users=AP.render(opts.followers, function(e, index){
			var u=e;
			if (AP.data.isString(u) || AP.data.isInt(u)){
				u=People.get(u);
			}else{
				u=People.get(u.username);
			}
			
			if (opts.style=='list'){
				return "<div class='js-user fe-user url' data-username='"+(u.username)+"'> <div class='image avatar avatar-32 -circled'><img src='"+(AP.xthumb(u.gavatar))+"'/></div> <div class='uname'>"+(u.name)+"</div> <div class='uinfo ap-xdot'>"+(u.title)+"&nbsp;</div> </div>";
			}else if (opts.style=='inline'){
				return "<span class='js-user fe-user url' data-username='"+(u.username)+"'><span class='uname'>"+(u.name)+"</span></span>,";
			}
			
			return "<div class='js-user fe-avatar avatar avatar-32 -circled url' data-username='"+(u.username)+"'> <div class='image'><img src='"+(AP.xthumb(u.gavatar))+"'/></div> </div>";
		});
		
		if (opts.style=="inline"){
			if (users.length){
				users="Followed by "+(users)+"";
			}else{
				users="No followers &middot;";
			}
		}
		
		var follow="<div class='fe-action url is-follow' onclick='Follow.setFollow(\"me\",this);'><span class='ficon-check'></span> Follow</div>";
		if (opts.style=="inline"){
			follow="<div class='fe-action url is-follow' onclick='Follow.setFollow(\"me\",this);'>Follow</div>";
		}
		
		if (Me.isFollower(opts)){  
			follow="<div class='fe-action url is-unfollow' onclick='Follow.setUnfollow(\"me\",this);'>Unfollow</div>";
		}
		var actions=follow;
		
		if (Me.isOwner(opts)){
			actions="<div class='fe-action is-add-follower url' onclick='Follow.addFollower(this);'>Add followers</div>" + follow;
		}
		
		if (opts.style=="standard"){
			return "<div class='fe-title'> <div class='fe-label'>"+(opts.followers.length)+" people followed</div> <div class='fe-side'>"+(actions)+"</div> </div> <div class='fe-users'>"+(users)+"</div>";
		}else if (opts.style=='inline'){
			return "<div class='fe-users inline'>"+(users)+" <div class='fe-actions inline'>"+(actions)+"</div></div>";
		}else{
			return "<div class='fe-users clear-fix'>"+(users)+" <div class='fe-actions'>"+(actions)+"</div></div>";
		}
		
		
	};
};


Base.notis_opt=new function __BaseNotisOpt(){
	this.settings=function(){
		var url=Base.domain("account")+"/ajax/api/me/email.notis";
		
		var ui=UI.setting("Personalized Email notification settings");
		for (var key in Client.email_options){
			var opt=Client.email_options[key];
			ui.add({
				title: opt.name,
				options: {"yes": "Yes", "no": "No"},
				value: opt.value,
				name: opt.key,
				url: url
			});	
		};
		
		ui.callback(function(code, key, value){
			Client.email_options[key].value=value;
		})
		.show();
		
		Base.toggle("apps");
	};
};


function BaseTree(){
	this.nodes=null;
	this.fnodes=null;
	this.root=null;
	this.raw_nodes=[];
	
	var rnodes={};
	
	this.init=function(nodes){
		rnodes={};
		this.raw_nodes=nodes;
		
		if (this.root){
			return this.root;
		}
		
		this.build();
		
		var root={name: "The company"};
		root.level=0;
		root.metatype="root";
		root.id=0;
		root.nodes=this.nodes;
		this.root=root;
		
		setLevel(root, 0);
		// this.fnodes.unshift(root);
	};
	
	
	this.build=function(){
		var objs=this.raw_nodes; 
		
		if (!objs){
			return;
		}
		
		for (var i=0; i<objs.length; i++){
			objs[i].nodes=[];
//			objs[i].objs=AP.array.filter(Client.nodes, function(e){
//				return e.node_id==objs[i].id;
//			});
			
			if (!objs[i].parent_id){
				objs[i].parent_id=0;	
			}else{
				objs[i].parent_id=parseInt(objs[i].parent_id);
			}
			
			objs[i].id=parseInt(objs[i].id);
			objs[i].__used=0;
			objs[i].level=1;
			
			rnodes["r-"+objs[i].id]=objs[i];
		}
		

		for (var i=0; i<objs.length; i++){
			for (j=0; j<objs.length; j++){
				if (parseInt(objs[j].parent_id)==parseInt(objs[i].id)){
					objs[i].nodes.push(objs[j]);
					objs[j].__used=1;
					// objs[j].level=objs[i].level+1;
				}
			}
		}
		
		
		var r=[];
		for (var i=0; i<objs.length; i++){
			if (objs[i].__used){
				
			}else{
				r.push(objs[i]);
			}
		}
		
		this.nodes=r;
		this.flatten();
	};
	
	
	/**
	 * @desc Flatten tree to array, sorted consecutively
	 */
	this.flatten=function(){
		r=[];
		for (var i=0; i<this.nodes.length; i++){
			flattenNode(r, this.nodes[i]);
		}
		
		
		this.fnodes=r;
		for (var i=0; i<this.fnodes.length; i++){
			this.fnodes[i].parent=getNodeByID(this.fnodes[i].parent_id);
		}
		
		for (var i=0; i<this.fnodes.length; i++){
			this.fnodes[i].tree_name="---".repeat(this.fnodes[i].level-1)+" "+this.fnodes[i].name;
		}
		
		return this.fnodes;
	};
	
	
	function flattenNode(collector, node){
		collector.push(node);
		for (var i=0; i<node.nodes.length; i++){
			flattenNode(collector, node.nodes[i]);
		}
	};
	
	
	function getNodeByID(id){
		if (rnodes["r-"+id]){
			return rnodes["r-"+id];
		}
		
		return null;
	};
	
	
	function setLevel(node, level){
		node.level=level;
		if (!node.nodes || !node.nodes.length){
			return;
		}
		
		for (var i=0; i<node.nodes.length; i++){
			setLevel(node.nodes[i], level+1);
		}
	};
};


/**
 * @desc Viewer Object
 * @desc Just a place holder
 */
var Viewer = new function _Viewer(){
	
	inherits(this, APViewer);
	
	
	this.hasNetwork=function(network){
		if (AP.data.isArray(network)){
			for (var i=0; i<network.length; i++){
				if (viewerHasNetwork(network[i])){
					return true;
				}
			}
			
			return false;
		}else{
			return viewerHasNetwork(network);
		}
		
	};
	
	
	function viewerHasNetwork(network){
		return AP.array.contain(Client.viewer.networks, network, function(e, f){
			if (AP.data.isInt(e) && AP.data.isInt(f)){
				return parseInt(e)==parseInt(f);
			}
			
			return parseInt(e.id)==parseInt(f.id);
		});
	};
	

};


var TagManager=new function __TagManager(){
	this.endpoint="api/tagmanager";
	this.callback=null;
	
	this.init=function(origin, endpoint){
		this.origin=origin;
		this.tags=origin.tags;
		if (endpoint){
			this.endpoint=endpoint;
		}else{
			this.endpoint="api/tagmanager";
		}
		
		this.callback=null;
	};
	
	
	/**
	 * @desc Show TagManager on dialog
	 */
	this.dialog=function(callback){
		if (callback){
			this.callback=callback;
		}else{
			this.callback=null;
		}
		
		prepareCanvas();
		var canvas="#tagmanager";
		$(canvas).html("<div class='-close' onclick='AP.closeDialog(this);'><span class='-ap icon-close'></span></div> <div class='title'>Manage tags</div> <div class='body' id='js-edit-tags'> <div class='list tags'></div> <div class='tag-add'> <form method='POST' action='#'> <div class='square'><em class='-bg-alt0'></em></div> <input type='hidden' name='color' value='0'> <input type='hidden' name='id' value='"+(TagManager.origin.id)+"'> <div class='ip'> <input type='text' autocomplete='off' name='name' placeholder='Thêm nhãn mới'/> </div> <div class='submit'>Cập nhật</div> </form> </div> </div>");
		
		var context=this.origin;
		buildList();
		
		$(canvas).find("form").attr("action", TagManager.endpoint+"/edit");
		Form.inlineColorTagger($(canvas).find(".tag-add .square"),function(color){
			$(this).closest("form").find("input[name=color]").val(color);
			$(this).closest("form").find("input[name=name]").focus();
			$(this).closest(".square").find("em").removeClass().addClass("-bg-alt"+color);
		},{
			width: 200,
			left: 0
		}); 
		
		$(canvas).find(".tag-add .square em").click(function(){
			$(this).parent().find(".ap-inline-colors").toggle();
		});
		
		
		$(canvas).find(".ip input").click(function(){
			$(this).closest(".tag-add").addClass("active");
		}).enter(function(){
			updateTag(this);
		});
		
		$(canvas).find(".submit").click(function(){
			updateTag(this);
		});
		
		AP.dialog("#custom-tagmanager").balance();
	};
	
	
	this.remove=function(tag){
		AP.confirm("Remove this tag from the list?", function(){
			UI.ajaxShow();
			AP.post(TagManager.endpoint+"/remove",{name: tag, id: TagManager.origin.id}, function(code){
				UI.ajaxHide();
				
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				TagManager.tags=code.tags;
				TagManager.origin.tags=code.tags;
				
				buildList();
				setForm("", "auto");
				
				if (TagManager.callback){
					TagManager.callback(code.tags);
				}
			});
		});
	};
	
	
	this.list=function(tags){
		var html= AP.render(tags, function(t){
			var obj=AP.array.single(TagManager.tags, function(e){
				return purifyStrict(t)==purifyStrict(e.name);
			});
			
			var color=0;
			if (obj){
				color=obj.color;
			}
			
			return "<div class='ui-tag tag-alt"+(color)+"-more'>"+(t)+"</div>";
		});
		
		return "<div class='ui-tags'>"+(html)+"</div>";
	};
	
	
	this.taggable=function(input, tags, values){
		var $this=$(input);
		var $p=$this.parent();
		var tags_html=AP.render(tags, function(e){
			return "<div class='fi-tag' data-value='"+(e.name)+"' data-color='"+(e.color)+"'> <span class='square -bg-alt"+(e.color)+"'></span> "+(e.name)+" </div>";
		});
		
		if (tags_html && tags_html.length){
			tags_html="<div class='tags_box scroll-y forced-scroll'>"+(tags_html)+"</div>";
		}
		
		$p.find(".fi-tags").remove();
		$p.find(".selected-tags").unbind();
		
		
		tags_html+="<div class='fi-tag js-add-tag'> <span class='add-icon'></span> Add more tag ... </div>";
		
		var cta_html="<div class='none'>Please select tags</div>";
		
		$p.find(".selected-tags").click(function(){
			$(this).closest(".selected-tags-wrapper").addClass("taglist-activated");
			$(this).closest(".__dialogwrapper").addClass("xo");
		});
		
		$p.append("<div class='fi-tags unselectable'> <div class='r' onclick='TagManager.cancel(this);'></div> "+(tags_html)+" </div>");
		
		$this.parent().find(".fi-tag").click(function(){
			if ($(this).hasClass("js-add-tag")){
				TagManager.dialog(function(tags){
					TagManager.taggable(input, tags, value);
				});
				return;
			}
			
			var value=$(this).data(value);
			var color=$(this).data(color);
			if ($(this).hasClass("selected")){
				$(this).removeClass("selected");
			}else{
				$(this).addClass("selected");
			}
			
			syncInputValues($p);
		});
		
		if (values && AP.data.isArray(values) && values.length){
			for (var i=0; i<values.length; i++){
				var v=purifyStrict(values[i]);
				$this.parent().find(".fi-tag").each(function(){
					if (v==purifyStrict($(this).data("value"))){
						$(this).addClass("selected");
					}
				})
			}
			
			syncInputValues($p);
		}
	};
	
	
	this.cancel=function(ref){
		$(ref).closest(".selected-tags-wrapper").removeClass("taglist-activated");
		$(ref).closest(".__dialogwrapper").removeClass("xo");
	};
	
	
	function updateTag(ref){
		Form.submitFrom(ref, function(code){
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			TagManager.tags=code.tags;
			TagManager.origin.tags=code.tags;
			
			buildList();
			setForm("", "auto");
			
			if (TagManager.callback){
				TagManager.callback(code.tags);
			}
		});
	};
	
	
	function buildList(){
		var html=AP.render(TagManager.tags, function(e){
			return getTag(e);
		});
		
		if (!TagManager.tags.length){
			html="<div class='no-tag'>No tags here &middot; Enter the tag name in the below form to add</div>";
		}
		
		$("#js-edit-tags").find(".list").html(html);
		
		$("#js-edit-tags").find(".list .remove").click(function(){
			var key=$(this).closest(".tag").data("key");
			TagManager.remove(key);
		});
		
		$("#js-edit-tags").find(".list .js-name").click(function(){
			var key=$(this).closest(".tag").data("key");
			var name=$(this).closest(".tag").data("name");
			var color=$(this).closest(".tag").data("color");
			setForm(name, color);
		});
	};
	
	
	function setForm(name, color){
		if (color && AP.data.isInt(color)){
			$("#js-edit-tags .tag-add input[name=color]").val(color);
			Form.inlineColorTagger("#js-edit-tags .tag-add .square", "set", color);
			$("#js-edit-tags .tag-add .square em").removeClass().addClass("-bg-alt"+color);
		}
		
		$("#js-edit-tags .tag-add input[name=name]").val(name).click();
		setTimeout(function(){
			$("#js-edit-tags .tag-add input[name=name]").focus();
		}, 200);
		
	};
	
	
	function getTag(e){
		return "<div class='tag -bg-alt"+(e.color)+"-less text-alt"+(e.color)+"' data-key='"+(e.key)+"' data-name='"+(e.name)+"' data-color='"+(e.color)+"'> <div class='square -bg-alt"+(e.color)+"'></div> <span class='js-name name pointer'>"+(e.name)+"</span> <div class='remove' title='Remove this tag'><span class='-ap icon-close'></span></div> </div>";
	};
	
	
	function prepareCanvas(){
		AP.customDialog("<div id='tagmanager' class='tagmanager-dialog'></div>", "custom-tagmanager").addClass("-full").width(420).show();
	};
	
	
	
	function syncInputValues($p){
		var html='';
		var values='';
		
		$p.find(".fi-tag.selected").each(function(){
			var value=$(this).data("value");
			var color=$(this).data("color");
			html+="<span class='value tag-alt"+(color)+"'><span class='square -bg-alt"+(color)+"'></span>"+(value)+"</span>";
			values+=value+",";
		});
		
		if (!html || !html.length){
			html="<div class='none'>Please select tags</div>";
		}
		
		$p.find(".selected-tags").html(html);
		$p.find("input").val(values);
	};
	
};



Base.tagManager=TagManager;


Base.webhook=new function __BaseWebhook(){
	this.manage=function(opts, callback){
		opts=$.extend({title: "Manage webhooks", webhooks: {}, transformers: []}, opts);
		
		var obj=opts.origin;
		var st="";
		
		if (!obj.webhooks){
			obj.webhooks={};
		}
		
		if (obj.webhooks.server_token){
			st=obj.webhooks.server_token;
		}
		
		var data={id: obj.id, hid: obj.hid, token: obj.token, events: opts.events.join(",")};
		
		var form=Form.create('fly-webhook-fx',{'action': "api/webhook/update"})
		.row(
			Form.label({label: "Linked to",sublabel: ""}),
			Form.input({name: 'job_name', type: "fake"}).value(obj.name)
		);
		
		for (var i=0; i<opts.events.length; i++){
			var ev=opts.events[i];
			
			var v=[];
			if (obj.webhooks.events && obj.webhooks.events[ev]){
				v=obj.webhooks.events[ev];
				// v=v.join("<br><br>");
			}
			
			form.row(
				Form.label({label: "Webhook <code>"+ev+"</code>",sublabel: ""}),
				Form.input({name: "event-"+(ev)+"", type:"lines", placeholder:"Enter webhook URL and press Enter", role:"simple"}).css({height: 110}).value(v)
			);
		}
		
		form.rowSep();
		var current_max=2;
		if (obj.webhooks && obj.webhooks.transformers && obj.webhooks.transformers.length){
			current_max=obj.webhooks.transformers.length;
			
			for (var i=0; i<obj.webhooks.transformers.length; i++){
				var t=obj.webhooks.transformers[i];
				form.row(
					Form.label({label: "Transformer <code>"+(i+1)+"</code>",sublabel: ""}),
					Form.inputGroup([
						Form.input({name: "transform-"+(i)+"", type:"text", placeholder:"Final key"}).value(t.key),
						Form.input({name: "transform-org-"+(i)+"", type:"text", placeholder:"Original key"}).value(t.value)
					])
				).addClass("js-transformer");
			}	
		}else{
			form.custom("<div class='link center a std normal js-ts-link'>Add webhook transformers</div>");
			
			for (var i=0; i<current_max; i++){
				form.rowHidden(
					Form.label({label: "Transformer <code>"+(i+1)+"</code>",sublabel: ""}),
					Form.inputGroup([
						Form.input({name: "transform-"+(i)+"", type:"text", placeholder:"Final key"}),
						Form.input({name: "transform-org-"+(i)+"", type:"text", placeholder:"Original key"})
					])
				).addClass("js-transformer js-initial");
			}	
		}
		
		
		for (var i=current_max; i<20; i++){
			form.rowHidden(
				Form.label({label: "Transformer <code>"+(i+1)+"</code>",sublabel: ""}),
				Form.inputGroup([
					Form.input({name: "transform-"+(i)+"", type:"text", placeholder:"Final key"}),
					Form.input({name: "transform-org-"+(i)+"", type:"text", placeholder:"Original key"})
				])
			).addClass("js-transformer");
		}
		
		
		form.rowSep()
		.row(
			Form.label({label: "Shared URL secret",sublabel: "The shared server_token"}),
			Form.input({name: 'server_token', type: "text", placeholder: "webhook shared server_token"}).value(st)
		);
		
		if (opts.create){
			var create_url=Base.domain(Client.base.app)+"/webhook/"+opts.create;
			
			form.rowSep()
			.row(
				Form.label({label: "Create API endpoint",sublabel: "URL endpoint for creating action"}),
				Form.input({name: 'create_api_endpoint', type: "textarea"}).value(create_url).css({height: 100}).readOnly()
			);	
		}
		
		form.buttons([
		     {label: "Save", action: function(){
		    	 Form.submit("#fly-webhook-fx", function(code){
		    		 if (!code.good()){
		    			 return AP.alertError(code.message);
		    		 }

		    		 if (callback) callback(code);
		    		 AP.xRefresh();
		    	 })
		     }, style: 'ok -success -rounded bold'},
		     {label: "Hủy bỏ", action: function(){
		    	 Form.hide("fly-webhook-fx");
		     }, style:'cancel -passive-2 -rounded'}
		])
		.render(function(f){
			$("#fly-webhook-fx .js-ts-link").click(function(){
				$(this).parent().hide();
				$("#fly-webhook-fx .js-initial").show();
			});
			
			$("#fly-webhook-fx .js-transformer input").click(function(){
				var $row=$(this).closest(".row");
				var $next=$row.next();
				if ($next.length && $next.hasClass("js-transformer")){
					$next.show();
				}
			});
		})
		.hiddens(data);
	
		Form.pop({width: 720, label: opts.title}).setForm(form).show();
	};
	
	
	
	this.list=function(obj, canvas){
		
	};
};


Base.filter=function(opts){
	opts=$.extend({}, {canvas: "#page", handler: "#js-filter-button"}, opts);
	
	$("#js-master-filters .js-close").click(function(){
		$("#js-master-filters").hide("slide", {direction:"right"}, 200);
	});
	
	$("#js-master-filters .js-submit").click(function(){
		updateFilters(this);
	});
	
	
	setTimeout(function(){
		setValues();
	},100);
	
	$(opts.handler).click(function(){
		$("#js-master-filters").show("slide", {direction:"right"}, 200);
	});
	
	
	
	function updateFilters(ref){
		var data=assoc($("#js-master-filters :input").serializeArray());
		for (var key in data){
			if (data[key]===""){
				data[key]=null;
			}
		}
		
		AP.setURLParams(data, true);
	};
	
	
	function setValues(){
		// Setting current value
		
		var active=0;
		$("#js-master-filters :input").each(function(){
			var name=$(this).attr("name");
			var v=Query.get(name);
			if (v===null || v===""){
				return;
			}
			
			active++;
			$(this).val(v);
		});
		
		if (active){
			$(opts.handler).addClass("active").html("Filters ("+active+")");
		}
		
		Form.render("#js-master-filters");
	};
};


var Me=new function __Me(){
	this.isManagerOf=function(user){
		if (!user.manager || !user.manager.length){
			return false;
		}
		
		return AP.array.exist(user.manager, Client.viewer.username);
	};
	
	this.isManagedBy=function(user){
		var username=user;
		if (AP.data.isObject(user)){
			username=user.username;
		}
		
		if (!Client.viewer.manager || !Client.viewer.manager.length){
			return false;
		}
		
		return AP.array.exist(Client.viewer.manager, username);
	};
	
	this.shareManager=function(user){
		if (!user.manager || !user.manager.length){
			return false;
		}
		
		if (!Client.viewer.manager || !Client.viewer.manager.length){
			return false;
		}
		
		for (var i=0; i<user.manager.length; i++){
			if (Me.isManagedBy(user.manager[i])){
				return true;
			}
		}
		
		return false;
	};
	
	
	this.sameManager=this.shareManager;
	
	
	this.isSystemOwner=function(){
		var obj=Network.get(Client.system.root_network_id);
		return (obj && parseInt(obj.role)==Role.OWNER);
	};
	
	this.isSystemAdmin=function(){
		var obj=Network.get(Client.system.root_network_id);
		return (obj && (parseInt(obj.role)==Role.ADMIN || parseInt(obj.role)==Role.OWNER));
	};
	
	this.isNetworkOwner=function(network){
		var obj=null;
		
		if (AP.data.isString(network)){
			obj=Network.getByPath(network);
		}else{
			obj=Network.get(network.id);	
		}
		return (obj && parseInt(obj.role)==Role.OWNER);
	};
	
	this.isNetworkAdmin=function(network){
		if (!network){
			if (Client.pageData.network){
				network=Client.pageData.network;
			}else{
				network=Company.getRootNetwork();	
			}
		}
		
		if (!network){
			return false;
		}
		
		var obj=network;
		if (AP.data.isInt(network)){
			obj=Network.get(network);	
		}
		
		
		return (obj && (parseInt(obj.role)==Role.ADMIN || parseInt(obj.role)==Role.OWNER));
	};
	
	
	
	this.isFollower=function(obj){
		if (!obj){
			return false;
		}
		
		for (var i=0; i<obj.followers.length; i++){
			if (AP.data.isString(obj.followers[i])){
				if (obj.followers[i]==Client.viewer.username){
					return true;
				}
			}else{
				if (obj.followers[i].username==Client.viewer.username){
					return true;
				}	
			}
		}
		
		return false;
	};
	
	
	this.isOwner=function(obj){
		if (!obj){
			return false;
		}
		
		for (var i=0; i<obj.owners.length; i++){
			if (AP.data.isString(obj.owners[i]) && obj.owners[i]==Client.viewer.username){
				return true;
			}
			
			if (obj.owners[i].username==Client.viewer.username){
				return true;
			}
		}
		
		return false;
	};
	
	
	/**
	 * @desc Check if me is among a team owner of obj
	 */
	this.isTeamOwner=function(obj){
		if (!obj){
			return false;
		}
		
		for (var i=0; i<obj.teams.length; i++){
			if (AP.array.contain(Client.viewer.networks, obj.teams[i])){
				return true;
			}
		}
		
		return false;
	};
	
	
	this.isAppAdmin=function(appkey){
		if (!appkey && Client.base){
			appkey=Client.base.app;
		}
		
		if (Me.isSystemOwner()){
			return true;
		}
		
		if (AP.array.single(Client.viewer.sas, function(app){
			return app==appkey || app==appkey+".admin";
		})){
			return true;
		}
		
		return false;
	};
	
	
	this.isAssigned=function(obj){
		return (parseInt(Client.viewer.id)==parseInt(obj.assign_to));
	}
	
	
	this.isCreator=function(obj){
		if (!obj || !obj.user_id){
			return;
		}
		return (parseInt(Client.viewer.id)==parseInt(obj.user_id));
	}
	
	this.findObject=function(objs){
		for (var i=0; i<objs.length; i++){
			if (AP.data.isString(objs[i])){
				if (objs[i]==Client.viewer.username){
					return objs[i];
				}
			}else{
				if (objs[i].username==Client.viewer.username){
					return objs[i];
				}	
			}
		}
		
		return null;
	};
	
	
	this.getDirectReports=function(user){
		return AP.array.filter(Client.people, function(e){
			return AP.array.contain(e.manager, user.username);
		});
	};
	
	
	this.getManagers=function(){
		return People.collect(Client.viewer.manager);
	};
	
	
	this.join=function(hid, token){
		AP.confirm("Are you sure that you want to join this team?", function(){
			AP.post("api/network/member/join",{hid: hid, token: token}, function(code){
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				AP.alertSuccess("You've joined the team successfully!", function(){
					AP.refresh();
				});
			});
		});
	};
	
	
	this.favor=function(obj){
		return AP.array.contain(Client.favors, obj, function(elem, xobj){
			if (AP.data.isInt(elem)){
				return elem && elem==xobj.id;
			}
			return (elem && elem.hid && elem.hid==xobj.hid);
		});
	};
	
	
	this.setFavorite=function(id, callback){
		var data={};
		var identify=id;
		if (AP.data.isObject(id)){
			identify=id.hid;
			data={'id': id.id, hid: id.hid, token: id.token, object: 1};
		}else{
			data={id: id};
		}
		
		UI.ajaxShow();
		AP.post("api/me/favorite", data, function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			Client.favors=code.favors;
			if (AP.data.isObject(id)){
				Menu.buildFavorLists();
			}
			
			AP.fire("favor-"+identify);
			
			if (callback){
				callback(code.favors);	
			}
		});
	};
	

	
	this.getFavorites=function(){
		var r=[];
		for (var i=Client.favors.length-1; i>=0; i--){
			var id=Client.favors[i];
			if (AP.data.isObject(id)){
				r.push(id);
			}else{
				var team=Network.get(id);
				if (team){
					r.push(team);
				}	
			}
		};
		return r;
	};
	
	
	
	this.arrangeFavorites=function(id, callback){
		var teams=this.getFavorites();
				
		var options=[];
		for (var i=0; i<teams.length; i++){
			if (teams[i].ref && teams[i].ref==1){
				options.push({id: teams[i].hid, "label": teams[i].name, sublabel: teams[i].type+"", data: teams[i]});
			}else{
				options.push({id: teams[i].id, "label": teams[i].name, "sublabel": "/"+teams[i].path+"", data: teams[i]});
			}
		}
		
		
		UI.reorder(options, "api/me/favorite.reorder").callback(function(id, ord, code){
			Client.favors=code.favors;	
			Menu.buildFavorLists();
		},{"title":"Reorder favorites"});
	
	};
	
	
	this.removeFavorite=function(id, callback){
		var identify=id;
		if (AP.data.isObject(id)){
			identify=id.hid;
			data={hid: id.hid, token: id.token, object: 1};
		}else{
			data={id: id};
		}
		
		AP.post("api/me/favorite", {id: id, 'remove': 1}, function(code){
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			callback(code.favors);
			AP.fire("unfavor-"+identify);
		});
	};
	
	
	this.logout=function(){
		AP.confirm("Are you sure that you want to logout now?", function(){
			return AP.redirect("a/logout?token="+Client.viewer.token);
		});
	};
	
	this.chooseColor=function(){
		var form=Form.create('color-fx',{'action':'api/me/color'})
		.row(
			Form.label({label: "Hãy lựa chọn một màu cá nhân hóa cho riêng bạn<br><br>"}),
			Form.input({name: 'color', type:"colors", options:[
				{value:"1", label: "<div class='square box-alt1'><div class='square-in'></div></div>"},
				{value:"2", label: "<div class='square box-alt2'><div class='square-in'></div></div>"},
				{value:"3", label: "<div class='square box-alt3'><div class='square-in'></div></div>"},
				{value:"4", label: "<div class='square box-alt4'><div class='square-in'></div></div>"},
				{value:"5", label: "<div class='square box-alt5'><div class='square-in'></div></div>"},
				{value:"6", label: "<div class='square box-alt6'><div class='square-in'></div></div>"},
				{value:"7", label: "<div class='square box-alt7'><div class='square-in'></div></div>"},
				{value:"8", label: "<div class='square box-alt8'><div class='square-in'></div></div>"}
            ]}).value(Client.viewer.color)
		)
		.buttons([
		     {label: "Lưu lại", action: function(){
		    	 Form.submit("color-fx", function(code){
		    		 if (!code.good()){
		    			 return AP.alertError(code.message);
		    		 }
		    		 
		    		 if (Client.native){
		    			 Cache.set("color", code.color);
		    		 }
		    		 
		    		 Form.hide("color-fx");
		    		 UI.flash("Color set ...");
		    		 AP.refresh();
		    	 });
		     }, style: 'ok -success -rounded bold'},
		     {label: "Bỏ qua", action: function(){
		    	 Form.hide("color-fx");
		     }, style:'cancel -passive-2 -rounded'}
		]).settings({block: true});
	
		Form.pop({id:'color-fx-dx', width: 600, label: 'Chọn màu hiển thị'}).setForm(form).show();
	};
	
	
	this.arrangeTeams=function(){
		var options=[];
		for (var i=0; i<Client.networks.length; i++){
			var net=Client.networks[i];
			if (!AP.array.contain(Client.favors, net.id)){
				options.push({id: net.id, "label": net.name, "sublabel": "/"+net.path+""});	
			}
		}
		
		UI.reorder(options, "api/me/network/reorder").callback(function(id, ord){
			var $elem=$("#team-"+id);
			
			if (ord==-1){
				var $base=$elem.prev('.-team');
				
				if ($base && $base.length){
					$elem.insertBefore($base);
				}
			}else{
				var $base=$elem.next('.-team');
				if ($base && $base.length){
					$elem.insertAfter($base);
				}
			}
		});
	};
	
	
	this.chatWith=function(username){
		Chat.peer(username, "", true);
    	Context.hide();
	}
	
	this.addPost=function(){
		var form=Form.create('peer-post-fx',{'action':'api/update/post'})
		.warning("You are creating a <b>How to work with me</b> post. This will be shared to everyone.")
		.row(
			Form.label({label: "How to work with me"}),
			Form.input({name: 'name', "placeholder":"Enter a short title", role: "tag"})
		)
		.row(
			Form.label({label: "Full description"}),
			Form.input({name: 'content', type:'textarea', "placeholder":"The full description"}).css({height: '200px'})
		)
		.hiddens({
			"self":1
		})
		.buttons([
		     {label: "Save post", action: function(){
		    	 Form.submit("peer-post-fx", function(code){
		    		 if (!code.good()){
		    			 return AP.alertError(code.message);
		    		 }
		    		 
		    		 Form.hide("peer-post-fx");
		    		 UI.flash("Message sent");
		    		 
		    	 });
		     }, style: 'ok -success -rounded bold'},
		     {label: "Cancel", action: function(){
		    	 Form.hide("peer-mail-fx");
		     }, style:'cancel -rounded -passive-2'}
		]).settings({
			"block": true
		});
	
		
		Form.pop({id:'peer-post-fx-dx', width: 600, label: 'Add How-to-work-with-me'}).setForm(form).show().focus('name');
	};
	
	
	
	this.editOptions=function(){
		
		var options=[];
		
		if(Me.isSystemAdmin() && (Client.system.path == 'daily' || Client.system.path == 'uni')) {
		    options.push({
	            "label":"Edit title and unit info",
	            "icon":"v-card",
	            "action": function(){
	                Me.info.editUnit();
	            }
	        });
		}
		
		options.push({
			"label":"Edit primary account infos",
			"icon":"gear",
			"action": function(){
				Me.info.edit();
			}
		});
		
		
		options.push({
			"label":"Edit about me and other personal infos",
			"icon":"lightbulb",
			"action": function(){
				Me.info.editAdvanced();
			}
		});
		
		options.push({
			"label":"Edit social links (Facebook, Twitter, ...)",
			"icon":"feed",
			"action": function(){
				Me.info.editSocial();
			}
		});
		
		
		AP.actionMenu(options);
	};
	
	
	this.editUnitOptions=function(){
        var options=[];
        
        if(Me.isSystemAdmin() && (Client.system.path == 'daily' || Client.system.path == 'uni')) {
            options.push({
                "label":"Edit title and unit info",
                "icon":"v-card",
                "action": function(){
                    Me.info.editUnit();
                }
            });
        }
        AP.actionMenu(options);
    };
	
	this.profileInit=function(){
		if (Client.pageData.user && Client.pageData.user.username==Client.viewer.username){
			W.uploadable("#profile-bg-upload","api/me/bgupload", {}, function(code){
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				UI.flash("Background updated ...");
				AP.xRefresh();
			});
		}
		
		changeBackground();
//		AP.rtimeout(function(){
//			changeBackground();
//		},10000);
		
	};
	
	this.canPostAnnouncement = function(network) {
	    var settings = "";
	    settings = Client.pageData.settings_team;
        if (settings) {
            var ann_extra = " " + settings.announcement_extra + " ";
            if (ann_extra.indexOf(" " + Client.viewer.username+" ")>= 0){
                return true;
            } else {
                return false;
            }
        } else {
            return false;
        }
	};
	
	
	this.teamOptions=function(add_none){
		var opts= AP.select(Client.networks, function(e){
			return {label: e.name, value: e.id}
		});
		
		if (add_none){
			opts.unshift({label: "Please select a team", value:0});
		}
		
		return opts;
	};
	
	
	this.delegate=function(){
		var user=Client.viewer;
		var delegate=user.delegate;
		if (!delegate || !delegate.username){
			delegate={username:""};
		}
		
		var form=Form.create('edit-profile-fx',{'action':'api/me/delegate'})
		.row(
			Form.label({label: "Delegate to",sublabel: ""}),
			Form.input({name: 'username', "placeholder":"Type to tag", role:"tag"}).value("@"+delegate.username)
		)
		.row(
			Form.label({label: "From date",sublabel: ""}),
			Form.input({name: 'sdate', role:"date", placeholder:"From date"}).value(delegate.sdate)
		)
		.row(
			Form.label({label: "To date",sublabel: ""}),
			Form.input({name: 'edate', role:"date", placeholder:"To date"}).value(delegate.edate)
		)
		.buttons([
			 {label: "Save setting", action: function(){
				 Form.submit("edit-profile-fx", function(code){
					 if (!code.good()){
						 return AP.alertError(code.message);
					 }
				
					 Form.hide("edit-profile-fx");
					 AP.alertSuccess(code.message, function(){
						 AP.refresh();
					 });
				 });
			 }, style: 'ok -success -rounded bold'},
			 {label: "Cancel", action: function(){
				 Form.hide("edit-profile-fx");
			 }, style:'cancel -passive-2 -rounded'}
		]).settings();
	
		Form.pop({id:'edit-fx-dx', width: 450, label: 'Delegation on leave'}).setForm(form).show();
		
	};

	
	
	this.isMemberOf=function(network){
		var obj=null;
		
		if (AP.data.isString(network)){
			obj=Network.getByPath(network);
		}else{
			obj=Network.get(network.id);	
		}
		return (obj!=null);
	};

	
	
	
	
	this.cimg=0;
	
	function changeBackground(){
		if (!Client.pageData.user.bg || !Client.pageData.user.bg.length){
			var image= Client.share_url+"/bg/"+(parseInt(Client.pageData.user.color)%4)+".jpg";
			$("#profile-bg").html("<img src='"+image+"'/>");
			return;
		}
		
		var image=getBackgroundImage();
		$("#profile-bg").html("<img src='"+image+"'/>");
	};
	
	
	function getBackgroundImage(){
		// Me.cimg++;
		if (!Client.pageData.user.bg || !Client.pageData.user.bg.length){
			return Client.share_url+"/bg/"+(parseInt(Client.pageData.user.color)%4)+".jpg";
		}
		
		// Me.cimg=Me.cimg%(Client.pageData.user.bg.length);
		var index=Client.pageData.user.bg.length-1;
		return Client.pageData.user.bg[index];
	};
};


Me.pref=function(key){
	return new PersonalPreference();
};

Base.pref=Me.pref;


function PersonalPreference(){
	/**
	 * @desc Get a preference by its key
	 */
	this.get=function(key, df){
		if (!df){
			df=null;
		}
		
		var obj=AP.log.getObject("_pref");
		if (!obj || obj.id!=parseInt(Client.viewer.id)){
			this.destroy();
			return df;
		}
		
		var rkey="k"+trueKey(key);
		if (rkey in obj){
			return obj[rkey];
		}
		
		return df;
	};
	
	
	/**
	 * @desc Set a preference by its key and value
	 */
	this.set=function(key, value){
		var obj=AP.log.getObject("_pref");
		if (!obj || obj.id!=parseInt(Client.viewer.id)){
			this.destroy();
			obj={id: Client.viewer.id};
		}
		
		obj["k"+trueKey(key)]=value;
		AP.log.setObject("_pref", obj);
		return true;
	};
	
	
	/**
	 * @desc Destroy the preference
	 */
	this.destroy=function(){
		if (localStorage){
			localStorage.removeItem("_pref");
		}
	};
	
	
	/**
	 * @desc Get all preferences
	 */
	this.all=function(){
		return obj=AP.log.getObject("_pref");
	};
	
	
	function trueKey(key){
		if (AP.data.isArray(key)){
			return key.join("_");
		}
		
		return key;
	};
	
};


var ACL=new function __ACL(){
	this.getClass=function(acl, key){
		if (acl[key] && parseInt(acl[key])){
			return " enabled";
		}
		
		return " forced-hidden";
	};
};


var SVG=new function __SVG(){
	
	this.extends=function(obj){
		for (var key in obj){
			this[key]=obj[key];
		}
	};
	
	
	this.add=function(obj){
		for (var key in obj){
			this[key]=obj[key];
		}
	};
	
	this.alias = function(main, alias){
		this[alias] = this[main];
	}
	
	this.fa=function(icon){
		return "<span class='ficon-"+(icon)+" ap-f14'></span>";
	};
	
	this.ap=function(icon){
		return "<span class='-ap icon-"+(icon)+" ap-f16'></span>";
	};
	
	// LIST OF ICONS
	
	this.align_right="<svg width='12' height='11' viewBox='0 0 12 11' xmlns='http://www.w3.org/2000/svg'><rect width='12' height='1' rx='0.5' transform='matrix(-1 0 0 1 12 0)'/><rect width='12' height='1' rx='0.5' transform='matrix(-1 0 0 1 12 5)'/><rect width='8' height='1' rx='0.5' transform='matrix(-1 0 0 1 12 10)'/></svg>";
	this.align_left="<svg width='12' height='11' viewBox='0 0 12 11' xmlns='http://www.w3.org/2000/svg'><rect width='12' height='1' rx='0.5'/><rect y='5' width='12' height='1' rx='0.5'/><rect y='10' width='8' height='1' rx='0.5'/></svg>";

	this.arrow_right="<svg width='5' height='10' viewBox='0 0 5 10' fill='none' xmlns='http://www.w3.org/2000/svg'><path d='M0.499999 1.20711L4.29289 5L0.499999 8.79289L0.499999 1.20711Z'/></svg>";
	this.arrow_down="<svg width='10' height='5' viewBox='0 0 10 5' xmlns='http://www.w3.org/2000/svg'><path fill-rule='evenodd' clip-rule='evenodd' d='M5 5L0 0L10 8.74228e-07L5 5ZM7.58579 1L2.41421 1L5 3.58579L7.58579 1Z'/></svg>";
	
	this.tag_left="<svg enable-background='new 0 0 512 512' height='512' viewBox='0 0 512 512' width='512' xmlns='http://www.w3.org/2000/svg'><path d='m367.528 257.61 106.442-144.057c4.787-6.48-.005-15.943-8.043-15.943h-267.126c-2.68 0-5.248 1.076-7.127 2.986l-150 152.417c-3.82 3.881-3.77 10.324.114 14.142l150 147.582c1.87 1.841 4.389 2.872 7.013 2.872h267.127c8.038 0 12.83-9.463 8.043-15.942zm-164.632 140-139.953-137.696 140.047-142.304h243.116l-99.054 134.057c-2.609 3.532-2.609 8.354 0 11.886l99.054 134.058h-243.21z'/></svg>";
	
	this.arrow_up="<svg enable-background='new 0 0 512 512' height='512' viewBox='0 0 512 512' width='512' xmlns='http://www.w3.org/2000/svg'><path d='m462.745 359.117c-.706-1.221 7.473 9.309-184.413-232.698-11.435-18.649-38.623-18.633-49.999.087-183.867 242.355-176.004 231.933-176.351 232.535-11.192 19.387 2.553 43.73 25.381 43.73h360c22.809 0 36.564-24.287 25.382-43.654zm-25.382 23.654h-360c-7.16 0-11.363-7.244-8.312-13.193 183.325-241.705 175.643-231.41 176.251-232.465 3.575-6.193 12.535-6.231 16.123-.014.609 1.054-7.533-9.383 184.292 232.483 2.964 5.906-1.145 13.189-8.354 13.189z'/></svg>";
};


var Currency=new function __Currency(){
	this.unit="đ";

	this.format=function(val){
		return AP.currency.formatVND(val);
		// return "<span class='cvalue'>"+(AP.data.numberFormat(val))+"</span><span class='cunit'>"+(this.unit)+"</span>";
	};
	
	this.full=function(val){
		return "<div class='cur'><b>"+(AP.data.numberFormat(parseInt(val)))+"</b> <span class='unit'>VND</span></div>";
	};
	
	this.compact=function(val){
		return "<div class='cur2'><b>"+(AP.data.numberFormat(parseInt(val)))+"</b> <span class='unit'>VND</span></div>";
	};
	
	this.get=function(val){
		return this.format(val);
	};
};


Base.importer=new function __BaseImporter(){
	
	this.dialog=function(opts){
		opts=$.extend({hiddens: {}, rows:[], data: [], preview: 1, grouping: 0}, opts);
		
		var form=Form.create('dialog-excel-fx',{action: opts.action});
		
		for (var i=0; i<opts.data.length; i++){
			var row=opts.data[i];
			form.row(
				Form.label({label: row.label}),
				Form.input({name: row.name, type: row.type, role: row.role?row.role:"", "placeholder": row.placeholder?row.placeholder:row.label})
			);
		}
		
		form.rowHidden(	
			Form.label({label: "File"}),
			Form.input({name: 'file', type: "file"})
		)
		
		form.row(	
			Form.label({label: "Choose Excel file"}),
			Form.input({name: 'file', type: "placeholder", id: "internal-excel"})
		).addClass("-active");
		

		for (var i=0; i<opts.rows.length; i++){
			form.row(	
				Form.label({label: opts.rows[i].label||''}),
				Form.input({name: opts.rows[i].name, placeholder: opts.rows[i].placeholder, type: opts.rows[i].type}).value(opts.rows[i].value)
			);
		}

		var btn_label="Import";
		if (opts.preview){
			btn_label="Tiếp tục";
			opts.hiddens.preview=1;
		}
		
		form.hiddens(opts.hiddens);
		
		form.render(function(f){
			var html=getHTML(opts.columns);
			$("#internal-excel").html(html).data("grouping", opts.grouping);
			
			AP.dialog("dialog-excel-dx").balance();
			
			$("#internal-excel .excel-cols").sortable({
				items: ".ui-col",
				handle: ".sicon",
				helper: "clone",
				axis: "y",
				stop: function(event, ui){
					var names=[];
					$("#internal-excel .ui-col").each(function(index){
						$(this).find(".sicon").html(AP.data.zeroPrefix(index+1));
						names.push($(this).data("name"));
					});
					
					$("#internal-excel input[name=__excel_orders]").val(names.join(","));
				}
			});
			
			$("#internal-excel").closest(".row").addClass("-active");
			
			if (opts.preview){
				f.find("file").on("change", function(){
					if ($("#internal-excel .excel-table").length){
						$("#internal-excel .excel-live-preview").empty();
						f.find("preview").val(1);
						f.selector(".button.ok").html("Tiếp tục");
					}
				});
			}
		});
		
		form.buttons([
			{label: btn_label, action: function(){
				Form.submit("#dialog-excel-fx", function(code){
					if (!code.good()){
						return AP.alertError(code.message);
					}
			
					if (code.message=="FILE_PREVIEW"){
						previewRows(code.rows);
						return;
					}
					
					Form.hide("dialog-excel-fx");
					
					if (opts.callback){
						opts.callback(code);	
					}else{
						AP.alertSuccess(code.message, function(){
							AP.refresh();
						});
					}
					
				});
			}, style: 'ok -success -rounded -bold'},
			{label: "Bỏ qua", action: function(){
				Form.hide("dialog-excel-dx");
			}, style:'cancel -passive-2 -rounded'}
		]);
	
		Form.pop({id: 'dialog-excel-dx', width: 600, label: opts.title, layout: "flat", closable: false}).setForm(form).show();
	};
	
	/**
	 * @desc Preview the role
	 */
	function previewRows(rows){
		UI.flash("Please preview before uploading");
		
		var cols={};
		$("#internal-excel .excel-cols .ui-col").each(function(){
			cols[$(this).data("name")]={
				label: $(this).find(".col-label").text(),
				width: $(this).data("width")
			}
		});
		
		$("#internal-excel .excel-live-preview").html(getRows(cols, rows));
		var ch=$("#internal-excel .excel-live-preview .excel-table").height();
		if (ch>200){
			ch=200;
			$("#internal-excel .excel-table-canvas").css({height: ch});
		}
		
		$("#internal-excel").closest("form").find("input[name=preview]").val(0);
		$("#internal-excel").closest("form").find(".button.ok").html("Import");
		
		AP.dialog("dialog-excel-dx").balance();
	};
	
	
	
	/**
	 * @desc Get columns HTML and support drag/drop
	 */
	function getHTML(cols){
		var names=[];
		
		var html=AP.render(cols, function(c, index){
			var w=1;
			names.push(c.name);
			if (c.width){
				w=parseFloat(c.width);
			}
			return "<div class='ui-col' data-name='"+(c.name)+"' data-width='"+(w)+"'> <div class='sicon'>"+(AP.data.zeroPrefix(index+1))+".</div> <div class='col-label'>"+(c.label)+"</div> <div class='col-key'>"+(c.name)+"</div> </div>";
		});
		
		var values=names.join(",");
		return "<div class='input data'> <input type='file' name='file'/> </div> <div class='hidden'><input type='hidden' name='__excel_orders' value='"+(values)+"'/></div> <div class='col-note'>Please choose an Excel file with column orders as below. View sample file?</div> <div class='excel-live-preview'></div> <div class='excel-cols scroll-y'> "+(html)+" </div>";
	};
	
	
	function getRows(cols, rows){
		var grouping=$("#internal-excel").data("grouping");
		
		var header = '';
		var tw=48;
		
		for (var key in cols){
			var c=cols[key];
			var w=parseFloat(c.width)*200;
			
			header+= "<div class='th' style='width: "+(w)+"px'>"+(c.label)+"</div>";
			tw+=w;
		};
		
		var real_index=0;
		var html = AP.render(rows, function(r, index){
			if (index==0){
				return '';
			}
			
			var temp='';
			if (grouping){
				if (!r.name){
					return '';
				}
				
				if (AP.word.suffix(r.name, ":")){
					return "<div class='tr-group'><div class='tdg'>"+(r.name)+"</div></div>";
				}
			}
			
			real_index++;
			
			for (var k in cols){
				var w=cols[k].width * 200;
				
				if (r[k]){
					temp+= "<div class='td' style='width: "+(w)+"px'>"+(r[k])+"</div>";
				}else{
					temp+="<div class='td' style='width: "+(w)+"px'></div>";
				}
			}
			
			return "<div class='tr'><div class='td index' style='width:48px'>"+(real_index)+"</div>"+(temp)+"</div>";
		});
		
		
		return "<div class='excel-table-title'>Preview of file</div> <div class='excel-table-canvas'> <div class='excel-canvas scroll-x scroll-y forced-scroll'> <div class='excel-table' style='width: "+(tw)+"px'> <div class='thead'> <div class='th index' style='width:48px'>#</div> "+(header)+" </div> <div class='tbody'> <div class='td index' style='width:48px'></div> "+(html)+" </div> </div> </div> </div>";
	};
	
};





var Company=new function __Company(){
	
	this.getRootNetwork=function(){
		for (var i=0; i<Client.units.length; i++){
			if (Network.root(Client.units[i])){
				return Client.units[i];
			}
		}
		
		return null;
	};
	
	
	
	this.createSystem=function(){
		var form=Form.create('create-team-fx',{action: 'api/company/system/create'})
		.row(
			Form.label({label: "System name",sublabel: "The name of the system"}),
			Form.input({name: 'name', "placeholder":"System name"})
		)
		.row(
			Form.label({label: "Administrator email",sublabel: "We will send a link to setup the new system via this email"}),
			Form.input({name: 'email', "placeholder":"The administrator email"})
		)
		.rowHidden(
			Form.label({label: "Directory",sublabel: "The relative directory from your domain <i>"+Client.system.domain+"</i>"}),
			Form.input({name: 'path', "placeholder":"Team directory", render:"<div class='input-render'>http://"+Client.system.domain+"/</div>"})
		)
		.rowHidden(
			Form.label({label: "Description",sublabel: "Short description about the team"}),
			Form.input({name: 'about', 'type':'textarea', "placeholder":"Short description"})
				.css({height: '80px'})
		)
		.buttons([
		     {label: "Create a new system", action: function(){
		    	 Form.submit("#create-team-fx", function(code){
		    		 if (!code.good()){
		    			 return AP.alertError(code.message);
		    		 }
		    	
		    		 Form.hide("create-team-fx");
		    		 AP.alertSuccess("An email was sent to the system administrator to initialize the setup process.", function(){
		    			 AP.toURL(code.network.path);
		    		 });
		    	 });
		     }, style: 'ok -success -rounded -bold'},
		     {label: "Cancel", action: function(){
		    	 Form.hide("create-team-fx");
		     }, style:'cancel -passive-2 -rounded'}
		]).settings();
	
		Form.pop({id: 'create-team-fx-dx', width: 600, label: 'Create a new team'}).setForm(form).show();
		
	};
	
	
	
	this.createNetwork = function(){
		var form=Form.create('create-team-fx',{action: 'api/company/team/create'})
		.row(
			Form.label({label: "Name",sublabel: "The name of the team. Just remember that people can work on multiple teams."}),
			Form.input({name: 'name', "placeholder":"Team name"})
		)
		.row(
			Form.label({label: "Directory",sublabel: "The relative directory from your domain <i>"+Client.system.domain+"</i>"}),
			Form.input({name: 'path', "placeholder":"Team directory", render:"<div class='input-render'>http://"+Client.system.domain+"/</div>"})
		)
		.rowHidden(
			Form.label({label: "Description",sublabel: "Short description about the team"}),
			Form.input({name: 'about', 'type':'textarea', "placeholder":"Short description"})
				.css({height: '80px'})
		)
		.row(
			Form.label({label: "Membership", sublabel: "How people can view and join the team?"}),
			Form.input({name: 'type', 'type':'list', options: [
			    {value: 1, "label":"Public membership", "sublabel":"Everyone can see the team and join"},
			    {value: 3, "label":"Restricted membership", "sublabel":"The team is invisible to everyone and people outside can join by invitation only"}
			]}).value(1)
		)
		.row(
			Form.label({label: "Is this team official?", sublabel: "Official team will be visible to everyone in the organization chart (but only its members can view and read contents)"}),
			Form.input({name: 'official', 'type':'list', options: [
			    {value: 0, "label":"Not official", "sublabel":"This is a private team and will not be linked to the organization chart"},
			    {value: 1, "label":"It's an official team", "sublabel":"This is an official team and it will be linked to the organization chart"}
			]}).value(0)
		)
		.rowHidden(
			Form.label({label: "Set parent team", sublabel: "Select a parent unit of this team in the organization chart"}),
			Form.input({name: 'parent', 'type':'select', options: Company.chart.asOptions()})
		)
		.render(function(fobj){
			this.find('official').change(function(){
				var val=parseInt($(this).val());
				if (val==1){
					fobj.findRow('parent').show();
					fobj.findRow('leader').show();
				}else{
					fobj.findRow('leader').hide();
					fobj.findRow('parent').hide();
				}
			});
		})
		.hiddens(
			{
				token:Client.system.token
			}
		)
		.buttons([
		     {label: "Create a new team", action: function(){
		    	 Form.submit("#create-team-fx", function(code){
		    		 if (!code.good()){
		    			 return AP.alertError(code.message);
		    		 }
		    	
		    		 Form.hide("create-team-fx");
		    		 AP.alertSuccess("A new team was just created", function(){
		    			 AP.toURL(code.network.path, function() {
		    			     AP.refresh();
		    			 });
		    		 });
		    	 });
		     }, style: 'ok -success -rounded -bold'},
		     {label: "Cancel", action: function(){
		    	 Form.hide("create-team-fx");
		     }, style:'cancel -passive-2 -rounded'}
		]).settings();
	
		Form.pop({id: 'create-team-fx-dx', width: 600, label: 'Create a new team'}).setForm(form).show();
		
	};
	
	
	
	this.searchNetwork=function(){
		var options=[];
		for (var i=0; i<Client.networks.length; i++){
			options.push({label: Client.networks[i].name, data: Client.networks[i]});
		}
		
		AP.selectAction(options, function(e){
			AP.toURL(e.data.path);
		},{filter: true, label:"Search for a team"});
	};
	
	
	
	this.editNetwork = function(network){
		var form=Form.create('create-team-fx',{action: 'api/company/team/edit'})
		.row(
			Form.label({label: "Name",sublabel: "The name of the team. Just remember that people can work on multiple teams."}),
			Form.input({name: 'name', "placeholder":"Team name"}).value(network.name)
		)
		.row(
			Form.label({label: "Directory",sublabel: "The relative directory from your domain <i>"+Client.system.domain+"</i>"}),
			Form.input({type: 'fake', name: 'path', "placeholder":"Team directory", render:"<div class='input-render'>http://"+Client.system.domain+"/</div>"}).value("/"+network.path)
		)
//		.row(
//			Form.label({label: "Description",sublabel: "Short description about the team"}),
//			Form.input({name: 'about', 'type':'textarea', "placeholder":"Short description"})
//				.css({height: '80px'})
//		)
		.rowHidden(
			Form.label({label: "Membership", sublabel: "How people can view and join the team?"}),
			Form.input({name: 'type', 'type':'list', options: [
			    {value: 1, "label":"Public membership", "sublabel":"Everyone can see the team and join"},
			    {value: 3, "label":"Restricted membership", "sublabel":"The team is invisible to everyone and people outside can join by invitation only"}
			]}).value(network.type),
			!Network.root(network)
		)
		.rowHidden(
			Form.label({label: "Is this team official?", sublabel: "Official team will be visible to everyone in the organization chart (but only its members can view and read contents)"}),
			Form.input({name: 'official', 'type':'list', options: [
			    {value: 0, "label":"Not official", "sublabel":"This is a private team and will not be linked to the organization chart"},
			    {value: 1, "label":"It's an official team", "sublabel":"This is an official team and it will be linked to the organization chart"}
			]}).value(network.official)
		)
		.rowHidden(
			Form.label({label: "Set team leader", sublabel: "Please set the team leader"}),
			Form.input({name: 'leader', 'type':'text', "role":"user", placeholder: "Please set the team leader"}).value("@"+network.leader.username)
		)
		.rowHidden(
			Form.label({label: "Set parent team", sublabel: "Select a parent unit of this team in the organization chart"}),
			Form.input({name: 'parent', 'type':'select', options: Company.chart.asOptions()}).value(network.parent_id)
		)
		.render(function(fobj){
//			this.find('official').change(function(){
//				var val=parseInt($(this).val());
//				if (val==1){
//					fobj.findRow('parent').show();
//					fobj.findRow('leader').show();
//				}else{
//					fobj.findRow('parent').hide();
//					fobj.findRow('leader').hide();
//				}
//			}).change();
		})
		.hiddens({
			hid:network.hid,
			token: network.token
		})
		.buttons([
		     {label: "Edit team", action: function(){
		    	 Form.submit("#create-team-fx", function(code){
		    		 if (!code.good()){
		    			 return AP.alertError(code.message);
		    		 }
		    	
		    		 Form.hide("create-team-fx");
		    		 AP.alertSuccess("The user group info was just changed", function(){
		    			 AP.refresh();
		    		 });
		    	 });
		     }, style: 'ok -success -rounded -bold'},
		     {label: "Cancel", action: function(){
		    	 Form.hide("create-team-fx");
		     }, style:'cancel -passive-2 -rounded'}
		]).settings();
	
		Form.pop({id: 'create-team-fx-dx', width: 400, label: 'Edit user group'}).setForm(form).show();
		
	};
	
	
	
	this.closeNetwork=function(network){
		AP.confirm("Are you sure that you want to close this team?", function(){
			AP.hideAlert();
			AP.ajaxShow();
			
			AP.post("api/company/team/close",{hid: network.hid, token: network.token}, function(code){
				AP.ajaxHide();
				
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				UI.flash("Team just closed!");
				AP.refresh();
			});
		});
	};
	
	
	

	this.openNetwork=function(network){
		AP.confirm("Are you sure that you want to open this team?", function(){
			AP.hideAlert();
			AP.ajaxShow();
			
			AP.post("api/company/team/open",{hid: network.hid, token: network.token}, function(code){
				AP.ajaxHide();
				
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				UI.flash("Team just reopened!");
				AP.refresh();
			});
		});
	};
	
	
	this.invite=function(){
		Company.member.inviteDialog();
	};
	
	
	this.inviteList=function(content, callback, error){
		AP.post("api/company/invite",{list: 1, emails: content}, function(code){
			if (!code.good()){
				if (error){
					error(code.message);
				}
				return AP.alertError(code.message);
			}
			
			callback(code.emails);
		});
	};
	
	
	this.showPublicTeams=function(){
		AP.ajaxShow();
		AP.post("api/company/team/public", {}, function(code){
			AP.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			
			var actions=AP.select(code.teams, function(e){
				if (AP.array.findObj(Client.networks, e.id)){
					return {label: e.name, sublabel: "/"+e.path+" &middot; <i class='opt-80'>You joined this team</i>", "icon":"unlocked", path: e.path}
				}else{
					return {label: e.name, sublabel: "/"+e.path, "icon":"unlocked", path: e.path}	
				}
			});
			
			
			AP.selectAction(actions, function(act){
				AP.toURL(act.path);
			},{title: "Public teams @ "+Client.system.name, filter: true})
			
			
		});
	};
	
	
	
	this.showAllTeams=function(){
		AP.ajaxShow();
		AP.post("api/company/team/all", {}, function(code){
			AP.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			
			var actions=AP.select(code.teams, function(e){
				e.label=e.name;
				e.sublabel="/"+e.path;
				return e;
			});
			
			
			AP.selectAction(actions, function(act){
				
				var menu=[];
				menu.push({label: "Edit this team", "icon":"pencil", action: function(){
					Company.editNetwork(act);
				}});
				
				
				if (act.status==-1 || act.status=="-1"){
					menu.push({label: "Open this team", "icon":"open_in_browser", action: function(){
						Company.openNetwork(act);
					}});
				}else{
					menu.push({label: "Close this team", "icon":"close", action: function(){
						Company.closeNetwork(act);
					}});
				}
				
				
				AP.actionMenu(menu);
				
			},{title: "Manage teams", filter: true})
			
			
		});
	};
	
	
	
	this.settings=function(){
		var admin=Me.isSystemAdmin();
		if (!admin){
			return AP.toURL("home");
		}
		
		var options=[];
		
		options.push({"label":"Mời thêm thành viên", "icon":"add2", action: function(){
			Company.invite();
		}});
		
		options.push({"label":"Tùy chọn hệ thống", "icon":"cog3", action: function(){
			Company.preference();
		}});
		
		options.push({"label":"Tùy chọn hệ thống email notification", "icon":"envelope3", action: function(){
			Company.emailPreference();
		}});
		
		options.push({"label":"Điều khoản sử dụng WorkTime nội bộ", "icon":"file-text", action: function(){
            Company.tos();
        }});
		
		AP.actionMenu(options);
	
	};
	
	
	
	this.preference=function(){
		UI.setting("System settings")
		.add({
			title: "Hiển thị tên đầy đủ hay username?", 
			options: {"username":"Username","fullname":"Fullname"}, 
			value: Client.system.settings.name,
			name:"name",
			url: "api/company/setting/"+Client.system.hid
		})
		.add({
			title: "Cho phép thành viên chỉnh sửa title (chức vụ)?", 
			options: {"yes":"Yes","no":"No"}, 
			value: Client.system.settings.title,
			name:"title",
			url: "api/company/setting/"+Client.system.hid
		})
		.show();
	};

	
	
	this.getTeam=function(id){
		return AP.array.findObj(Client.units, id);
	};
	
};
 

Company.chart=new function __CompanyChart(){
	this.__built=false;
	this.inverses={};
	this.xcounter=0;
	this.root={fake: 1, level: 0, nodes: [], name: "Root"};
	this.extendedRoot={fake: 1, level: 0, nodes: [], name: "ExtRoot"};
	this.roots=[];
	
	this.getRoot=function(){
		if (!this.built()){
			this.buildChart();
		}
		if (!this.roots.length){
			return [];
		}
		
		return this.roots[0];
	};
	
	this.buildChart=function(){
		var networks=Client.units;
		
		networks=removePersonalBus(networks);
		initNodesArray(networks);
		
		this.roots=getRoots(networks);
		for (var i=0; i<this.roots.length; i++){
			setChildren(this.roots[i]);
		}
		
		this.root.nodes=this.roots;
		this.extendNetwork();
		this.__built=true;
	};
	
	
	this.extendNetwork=function(){
		this.extendedRoot={fake: 1, level: 0, nodes: [], name: "Extended Root"};
		this.extendedRoot.nodes=this.root.nodes.slice(0);
		
		
		for (var i=0; i<Client.units.length; i++){
			var test=AP.array.findObj(Client.units, Client.units[i].id);
			if (test){
			}else{
				Client.units[i].level=0;
				Client.units[i].parent_id=0;
				this.extendedRoot.nodes.push(Client.units[i]);
			}
		}
	};
	
	
	
	this.asOptions=function(node){
		if (!this.built()){
			this.buildChart();
		}
		
		if (!node){
			node=this.root;
		}
		
		var arr=[];
		getSelectArray(node, arr);
		
		return arr;
	};
	
	
	this.asExtendedOptions=function(){
		if (!this.built()){
			this.buildChart();
		}
		return this.asOptions(this.extendedRoot);
	}
	
	
	this.built=function(){
		return this.__built;
	};
	
	
	function removePersonalBus(teams){
		return AP.array.filter(teams, function(e){
			if (e.metatype=="user"){
				return null;
			}
			return e;
		})
	};
	
	
	function initNodesArray(teams){
		Company.chart.inverses={};
		Company.chart.xcounter=0;
		
		for (var i=0; i<teams.length; i++){
			if (parseInt(teams[i].parent_id)){
				if (!Company.chart.inverses["n"+teams[i].parent_id]){
					Company.chart.inverses["n"+teams[i].parent_id]=[teams[i]];
				}else{
					Company.chart.inverses["n"+teams[i].parent_id].push(teams[i]);	
				} 
			}
		}
	};
	
	
	function getRoots(teams){
		var r=[];
		for (var i=0; i<teams.length; i++){
			if (!parseInt(teams[i].parent_id)){
				teams[i].level=0;
				r.push(teams[i]);
			}
		}
		
		return r;
	};
	
	function setChildren(root){
		Company.chart.xcounter++;
		if (Company.chart.xcounter>1000){
			return; // Not too much loop please
		}
		
		var nodes=Company.chart.inverses["n"+root.id];
		if (!nodes){
			nodes=[];
		}
		
		root.nodes=nodes;
		
		if (!root.nodes || !root.nodes.length){
			return;
		}
		
		for (var i=0; i<root.nodes.length; i++){
			root.nodes[i].level=root.level+1;
			setChildren(root.nodes[i]);
		}
	};
	
	
	function getSelectArray(node, arr){
		if (!node.fake){
			arr.push({label: "--".repeat(node.level)+" "+node.name, value: node.id});
		}
		
		if (!node.nodes || !node.nodes.length){
			return;
		}
		
		for (var i=0; i<node.nodes.length; i++){
			getSelectArray(node.nodes[i], arr)
		}
		
		return;
	};
	
	
	function getSelectOptions(node){
		var opt="<option value='"+node.id+"'>"+node.name+"</option>";
		if (node.fake){
			opt="";
		}
		
		if (!node.nodes || !node.nodes.length){
			return opt;
		}
		
		return opt+AP.render(node.nodes, function(e){
			return getSelectOptions(e);
		});
	}
};


Company.member=new function __WCompanyMember(){
	
	this.inviteDialog=function(){
		AP.alertError("We are sorry. Invitation by email is currently disabled. Please add account directly!");
		return;
		
		var form=Form.create('invite-fx',{'action':'api/company/invite'})
			.row(
				Form.label({label: "",sublabel: "Enter emails of people to be invited (line by line or separated by a commas). A secret link will be sent to those emails to help people sign up."}),
				Form.input({name: 'emails', type:"textarea", "placeholder":"List of emails to send invitation, seperated by spaces or new-lines"})
					.css({height: '80px'})
			)
			.hiddens({
				"list":1
			})
			.buttons([
			     {label: "Invite to join "+Client.system.name, action: function(){
			    	 Form.submit("#invite-fx", function(code){
			    		 if (!code.good()){
			    			 return AP.alertError(code.message);
			    		 }
			    		 Form.hide("invite-fx");
			    		 AP.alertSuccess("Invitations successfully sent to: <ul>"+AP.render(code.emails, function(e){
			    			 return "<li><b>"+e+"</b></li>";
			    		 })+"</ul>");
			    	 });
			     }, style: 'ok -success -rounded bold'},
			     {label: "Cancel", action: function(){
			    	 Form.hide("invite-fx");
			     }, style:'cancel -passive-2 -rounded'}
			]).settings({block: true});
		
		Form.pop({id:'invite-fx-dx', width: 600, label: 'Invite people to '+Client.system.name}).setForm(form).show();
		
	};
	
	
	this.inviteDialogTeamUp = function(){
        var form=Form.create('invite-fx',{'action':'api/company/invite'})
            .row(
                Form.label({label: "",sublabel: "Mời tối thiểu 03 thành viên cùng bạn tham gia vào hệ thống để làm việc trên các dự án. Một đường link bí mật sẽ được gửi tới email thành viên được mời hỗ trợ thành viên đó đăng ký tham gia hệ thống."}),
                Form.input({name: 'emails', type:"textarea", "placeholder":"Danh sách email gửi thư mời tham gia hệ thống. Mỗi email một dòng hoặc cách nhau bởi dấu phẩy"})
                    .css({height: '80px'})
            )
            .hiddens({
                "list":1
            })
            .buttons([
                 {label: "Mời tham gia "+Client.system.name, action: function(){
                     Form.submit("#invite-fx", function(code){
                         if (!code.good()){
                             return AP.alertError(code.message);
                         }
                         Form.hide("invite-fx");
                         AP.alertSuccess("Thư mời đã được gửi thành công tới: <ul>"+AP.render(code.emails, function(e){
                             return "<li><b>"+e+"</b></li>";
                         })+"</ul>");
                     });
                 }, style: 'ok -success -rounded bold'},
                 {label: "Bỏ qua", action: function(){
                     Form.hide("invite-fx");
                 }, style:'cancel -passive-2 -rounded'}
            ]).settings({block: true});
        
        Form.pop({id:'invite-fx-dx', width: 600, label: 'Mời thành viên tham gia '+Client.system.name}).setForm(form).show();
        
    };
    
    this.inviteDialogTeamUpOnBoard = function(){
        var form=Form.create('invite-fx',{'action':'api/company/invite'})
            .row(
                Form.label({label: "",sublabel: "Mời tối thiểu 03 thành viên cùng bạn tham gia vào hệ thống để làm việc trên các dự án. Một đường link bí mật sẽ được gửi tới email thành viên được mời hỗ trợ thành viên đó đăng ký tham gia hệ thống."}),
                Form.input({name: 'emails', type:"textarea", "placeholder":"Danh sách email gửi thư mời tham gia hệ thống. Mỗi email một dòng hoặc cách nhau bởi dấu phẩy"})
                    .css({height: '80px'})
            )
            .hiddens({
                "list":1
            })
            .buttons([
                 {label: "Mời tham gia "+Client.system.name, action: function(){
                     Form.submit("#invite-fx", function(code){
                         if (!code.good()){
                             return AP.alertError(code.message);
                         }
                         Form.hide("invite-fx");
                         AP.alertSuccess("Thư mời đã được gửi thành công tới: <ul>"+AP.render(code.emails, function(e){
                             return "<li><b>"+e+"</b></li>";
                         })+"</ul>");
                     });
                 }, style: 'ok -success -rounded bold'},
                 {label: "Bỏ qua và xem dự án mẫu", action: function(){
                     return AP.redirect('demo');
                 }, style:'cancel -passive-2 -rounded'}
            ]).settings({block: true});
        
        Form.pop({id:'invite-fx-dx', width: 800, label: 'Mời thành viên tham gia '+Client.system.name}).setForm(form).show();
        
    };
	
	this.inviteInline=function(ref){
		UI.submitFrom(ref, function(code){
			if (!code.good()){
				return AP.alertError(code.message);
   		 	}
			AP.alertSuccess("Invitation sent.");
		});
	};
	
	
	this.earlyInvite = function(ref) {
	    $('#onboard .board .users .user .input').each(function() {
	        $(this).removeClass("-alert");
	    });
	    $('#err_msg').html("").hide();
	    
	    Form.submit("#earlyinvite-form", function(code){
            if (!code.good()){
                if(!code.data) {
                    return AP.alertError(code.message);
                } else {
                    var test = code.data.split('|');
                    var field_alert = "user_" + test[1] + "_" + test[0];
                    
                    $('input[name="' + field_alert + '"]').parent().addClass("-alert");
                    
                    $('#err_msg').html(code.message).show();
                    
                    Layout.scrollTo('#onboard');
                    return;
                }
                
            } else {
                AP.toURL("projects", function() {
                    AP.refresh();
                });
            }
        });
	};
};


var People=new function ___People(){
	this.__ids=null;
	this.uids=null;
	
	this.get=function(username){
		if (AP.data.isInt(username)){
			return this.getID(username);
		}
		var user=__getUserByUsername(username);
		if (!user){
			return {id:0, error: 1, uid:0, __invalid: 1, username: username, name: username, error:1, "gavatar": Client.data_url+"/image/noavatar.png"}
		}
		
		return user;
	};
	
	
	this.getID=function(id){
		var user=__getUserByID(id);
		if (!user){
			return {id: id, error: 1, uid:0, __invalid: 1, name: (parseInt(id)?"Deactivated":"none"), username:"none", title:"No title", "gavatar": Client.data_url+"/image/noavatar.png"}
		}
		
		return user;
	};
	
	
	this.getUID=function(uid){
		var user=__getUserByUID(uid);
		if (!user){
			return {id: 0, error: 1, uid: uid, __invalid: 1, name: "none", username:"none", title:"No title"}
		}
		
		return user;
	};
	
	
	this.sysowners=function(){
		return AP.array.filter(Client.people, function(e){
			return parseInt(e.role)==13;
		});
	};
	
	
	this.collect=function(){
		var users=[];
		var list=flatten(arguments);
		
		for (var i=0; i<list.length; i++){
			if (!list[i]){
				continue;
			}
			
			var u=null;
			if (AP.data.isObject(list[i])){
				u=People.get(list[i].username);
			}else{
				u=People.get(list[i]);
			}
			
			if (u){
				users.push(u);
			}
		}
		
		for (var i=0; i<users.length; i++){
			users[i].keywords=users[i].username+" "+users[i].name+" "+users[i].title;
		}
		
		
		return AP.array.unique(users, function(e1, e2){
			return e1.username==e2.username;
		});
	};
	
	
	this.getList=this.collect;
	
	
	this.merge=function(a1, a2){
		var obj=[];
		obj=obj.concat(a1);
		obj=obj.concat(a2);
		
		return AP.array.unique(obj, function(e1, e2){
			return e1.username==e2.username;
		});
	};
	
	this.getPeople=function(usernames){
		return this.collect(usernames);
	};
	
	this.getPeopleInTeam = function(team_id){
		var d=[];
		for (var i=0; i<Client.people.length; i++){
			if (AP.array.contain(Client.people[i].networks, team_id)){
				d.push(Client.people[i]);
			}
		}
		
		return d;
	};
	
	this.getPeopleInNetworks=function(networks){
		var r=[];
		for (var i=0; i<Client.people.length; i++){
			if (inNetworks(Client.people[i], networks)){
				r.push(Client.people[i]);
			}
		}
		
		return r;
	};
	
	this.isMemberOf=function(network){
		var obj= AP.array.find(Client.units, function(e){
			if (AP.data.isObject(network)){
				return e.id==network.id;	
			}
			
			return e.id==network;
		});
		
		return obj;
	};
	
	
	this.isDeactivated=function(user){
		if (!parseInt(user.uid)){
			return true;
		}
		
		return false;
	};
	
	
	/**
	 * @desc Export a list of users or usernames to id
	 */
	this.ids=function(users){
		var ids=[];
		for (var i=0; i<users.length; i++){
			var u=users[i];
			if (AP.data.isObject(u)){
				ids.push(u.id);
			}else if (AP.data.isString(u)){
				var temp=People.get(u);
				if (temp && !temp.error){
					ids.push(temp.id);
				}
			}else{
				ids.push(u);
			}
		}
		
		return ids;
	};
	
	
	function flatten(params){
		var u=[];
		for (var i=0; i<params.length; i++){
			if (AP.data.isArray(params[i])){
				u=u.concat(params[i]);
			}else{
				u.push(params[i]);
			}
		}
		return u;
	};
	
	
	
	function __getUserByID(id){
		if (!People.__ids){
			People.__ids=[];
			
			for (var i=0; i<Client.people.length; i++){
				People.__ids["uid-"+Client.people[i].id]=Client.people[i];
			}
		}
		
		if (!People.__ids["uid-"+id]){
			return null;
		}
		
		return People.__ids["uid-"+id];
	};
	
	
	
	function __getUserByUID(id){
		if (!People.uids){
			People.uids=[];
			
			for (var i=0; i<Client.people.length; i++){
				People.uids["uid-"+Client.people[i].uid]=Client.people[i];
			}
		}
		
		if (!People.uids["uid-"+id]){
			return null;
		}
		
		return People.uids["uid-"+id];
	};
	
	
	function inNetworks(person, networks){
		var mine=person.networks;
		for (var i=0; i<mine.length; i++){
			if (networks.indexOf(mine[i])!=-1){
				return true;
			}
		}
		
		return false;
	};
};



var Guest = new function __Guest(){
	this.addAccount=function(context, app){
		var data = {id: context.id, app: app};
        
        var form = Form.create('fly-proj-addmember-fx',{'action': "api/guest/add"})
        .row(
            Form.label({label: "Họ và tên *"}),
            Form.input({name: 'name', "placeholder":"Họ và tên khách hàng"})
        )
        .row(
            Form.label({label: "Địa chỉ email *"}),
            Form.input({name: 'email', "placeholder":"Email của khách hàng"})
        )
         .row(
            Form.label({label: "Username *"}),
            Form.input({name: 'username', "placeholder":"Username của khách hàng (dùng để @tag nhanh)"})
        )
        .buttons([
             {label: "Thêm tài khoản khách hàng", action: function(){
                 Form.submit("#fly-proj-addmember-fx", function(code){
                     if (!code.good()){
                         return AP.alertError(code.message);
                     }
                     
                     Form.hide("fly-proj-addmember-fx");
                     
                     UI.flash("Đã thêm tài khoản ...");
                     
                     AP.xRefresh();
                 })
             }, style: 'ok -success -rounded bold'},
             {label: "Hủy", action: function(){
                 Form.hide("fly-proj-addmember-fx");
             }, style:'cancel -passive-2 -rounded'}
        ]).hiddens(data);
        
        Form.pop({width: 420, label: 'Thêm tài khoản khách hàng', layout: 'flat'}).setForm(form).show().focus('followers');
	}
}



var UserGroup=new function __UserGroup(){
	this.__built=false;
	this.__ids={};
	this.__uds={};
	
	
	this.build=function(){
		this.__built=true;
		for (var i=0; i<Client.units.length; i++){
			this.__ids["i_"+Client.units[i].id]=Client.units[i];
			this.__uds["u_"+Client.units[i].path]=Client.units[i];
		}
	};
	
	this.get=function(id){
		if (!this.__built){
			this.build();
		}
		
		
		if (AP.data.isObject(id) && id.id){
			return this.get(id.id);
		}
		
		if (AP.data.isInt(id)){
			if (this.__ids["i_"+id]){
				return this.__ids["i_"+id];
			}
			
			return null;
			
			// return AP.array.findObj(Client.units, id);	
		}
		
		if (this.__uds["u_"+id]){
			return this.__uds["u_"+id];
		}
		
		return null;
		
//		return AP.array.single(Client.units, function(e){
//			return e.path==id;
//		});
	};
};



// BACKWARD COMPATIBLE
var UserTeam=UserGroup;
 

var Clog=new function __WLog(){
	this.log=function(key, value){
		$.cookie(key, value,{expires: 7*24*3600, path:'/', domain: Client.domain});
	};
	
	
	this.getLog=function(key){
		return $.cookie(key);
	};
	
	
	this.removeLog=function(key){
		return $.cookie(key, null);
	};
	
	this.setCookie=this.log;
	this.getCookie=this.getLog;
	this.removeCookie=this.removeLog;
	
	this.setAppCookie=function(key, value){
		if (Client.viewer && Client.viewer.id){
			$.cookie(key, value,{expires: 7*24*3600, path:'/', domain: Client.base.app+"."+Client.domain});	
		}
	};
	
	
	this.getAppCookie=this.getLog;
	this.clearAppCookie=this.removeLog;
	
	
	/**
	 * @desc Set a val to local storage (array)
	 * @example set("prefs", 1); // prefs -> [1]
	 * set("prefs", 2); // prefs -> [1, 2]
	 * set("prefs", 3); // prefs -> [1, 2, 3]
	 */
	this.set=function(key, val){
		var item=localStorage.getItem(key);
		if (!item){
			item=[];
		}else{
			item=JSON.parse(item);
		}
		
		var found=false;
		for (i=0; i<item.length; i++){
			if (AP.data.equal(item[i],val)){
				item.splice(i,1);
				item.unshift(val);
				found=true;
				break;
			}
		}
		
		if (!found){
			item.unshift(val);	
		}
		
		localStorage.setItem(key,JSON.stringify(item));
		
	};
	
	
	this.setAdv=function(key, obj){
		var item=localStorage.getItem(key);
		if (!item){
			item=[];
		}else{
			item=JSON.parse(item);
		}
		
		var found=false;
		for (i=0; i<item.length; i++){
			if (AP.data.equal(item[i].id,obj.id)){
				item.splice(i,1);
				item.unshift(obj);
				found=true;
				break;
			}
		}
		
		if (!found){
			item.unshift(obj);	
		}
		
		localStorage.setItem(key,JSON.stringify(item));
	};
	
	
	this.get=function(key){
		var item=localStorage.getItem(key);
		if (!item){
			item=[];
		}else{
			item=JSON.parse(item);
		}
		
		return item;
	};
	
	
	this.setObject=function(key, obj){
		localStorage.setItem(key, JSON.stringify(obj));
	};
	
	
	this.getObject=function(key){
		var item=localStorage.getItem(key);
		if (!item){
			item={};
		}else{
			item=JSON.parse(item);
		}
		
		return item;
	};
	
	
	this.setValue=function(key, value){
		localStorage.setItem(key, value);
	};
	
	
	this.getValue=function(key){
		var item=localStorage.getItem(key);
		if (!item){
			item="";
		}
		
		return item;
	};
	
	
	
	this.setArray=function(key, obj){
		localStorage.setItem(key, JSON.stringify(obj));
	};
	
	
	this.getArray=function(key){
		var item=localStorage.getItem(key);
		if (!item){
			item=[];
		}else{
			item=JSON.parse(item);
		}
		
		if (!AP.data.isArray(item)){
			return [];
		}
		return item;
	};
	
};


AP.log = Clog;
 

var WTAjaxDialogEngine=new function __WTAjaxDialogEngine(){
	
	this.canvas=function(){
		return $("#apdialogs");
	};
	
	/**
	 * @desc Render the dialog.
	 */
	this.render=function(dialog){	
		$(dialog.canvas()).append("" +
			"<div class='__wtajaxdialog' id='"+dialog.w(true)+"'>" +
				"<div class='__dialogwrapper'>" +
					"<div class='__dialogwrapper-inner'>" +
						"<div class='__dialogmain'>" +
							"<div class='__dialogtitle'>"+"&nbsp;</div>"+
							"<div class='__dialogcontent'><span style='font-size:32px' class='ficon-spinner ficon-spin'></span> <p>Processing</p></div>" +
						"</div>"+
					"</div>"+
				"</div>"+
			"</div>");
	};
	
	
	/**
	 * @desc Balancing the dialog.
	 */
	this.balance=function(dialog){
		var wid=dialog.w();
		var t=$(window).height()/2- $(wid+' .__dialogwrapper').outerHeight(true)/2-45;
		var l=$(window).width()/2- $(wid+' .__dialogwrapper').outerWidth(true)/2;
		if (t<50){
			t=50;
		}
		
		if (l<0){
			l=0;
		}
		
		$(wid+' .__dialogwrapper').css('top', t).css('left', l);
	};
};





var WTDialogEngine=new function __DialogEngine(){
	this.canvas=function(){
		return $("#apdialogs");
	};
	
	/**
	 * @desc Render the dialog.
	 */
	this.render=function(dialog){	
		$(dialog.canvas()).append("" +
			"<div class='__wtdialog' id='"+dialog.w(true)+"'>" +
				"<div class='__dialogwrapper'>" +
					"<div class='__dialogwrapper-inner'>" +
						"<div class='__dialogmain'>" +
							"<div class='__dialogtitle unselectable' onclick=\"AP.dialog('"+dialog.id()+"').balance();\">"+"&nbsp;</div>"+
							"<div class='__dialogclose' onclick=\"AP.dialog('"+dialog.id()+"').hide();\"><span class='-ap icon-close'></span> </div>"+
							"<div class='__dialogcontent'></div>" +
							"<div class='__dialogbuttons unselectable'></div>"+
						"</div>"+
					"</div>"+
				"</div>"+
			"</div>");
	};
	
	
	/**
	 * @desc Balancing the dialog.
	 */
	this.balance=function(dialog){
		var wid=dialog.w();
		var t=$(window).height()/2- $(wid+' .__dialogwrapper').outerHeight(true)/2-30;
		var l=$(window).width()/2- $(wid+' .__dialogwrapper').outerWidth(true)/2;
		if (t<50){
			t=50;
		}
		
		if (Client.mobile){
			l=0;
		}
		
		$(wid+' .__dialogwrapper').css('top', t).css('left', l);
		$(wid+' .__dialogwrapper .__buttons .button:last').focus();
	};
};









var FormDialogEngine=new function __FormDialogEngine(){
	this.canvas=function(){
		return $("#apdialogs");
	};
	
	/**
	 * @desc Render the dialog.
	 */
	this.render=function(dialog){	
		$(dialog.canvas()).append("<div class='__fdialog' id='"+(dialog.w(true))+"'> <div class='__fdialogwrapper scroll-y forced-scroll'> <div class='__dialogwrapper'> <div class='__dialogwrapper-inner'> <div class='__dialogmain'> <div class='__dialogtitlewrap'> <div class='left relative'> <div class='__dialogtitle unselectable ap-xdot' onclick='AP.dialog(\""+(dialog.id())+"\").balance();'> &nbsp; </div> <div class='__dialogtitlerender tx-fill'></div> </div> <div class='clear'></div> </div> <div class='__dialogclose' onclick='AP.dialog(\""+(dialog.id())+"\").hide();'> <span class='-ap icon-close'></span> </div> <div class='__dialogcontent'></div> </div> </div> </div> </div> </div>");
	};
	
	
	/**
	 * @desc Balancing the dialog.
	 */
	this.balance=function(dialog){
		var wid=dialog.w();
		var t=$(window).height()/2- $(wid+' .__dialogwrapper').outerHeight(true)/2-30;
		var l=$(window).width()/2- $(wid+' .__dialogwrapper').outerWidth(true)/2;
		if (t<50){
			t=50;
			
			if (Client.mobile){
				t=0;
			}
		}
		
		$(wid).css("right", $.sbWidth());
		$(wid+' .__dialogwrapper').css('top', t).css('left', l);
		$(wid+' .__dialogwrapper .__buttons .button:last').focus();
	};
};






var FormDialogEngine2=new function __FormDialogEngine(){
	this.canvas=function(){
		return $("#apdialogs");
	};
	
	/**
	 * @desc Render the dialog.
	 */
	this.render=function(dialog){	
		$(dialog.canvas()).append("" +
			"<div class='__fdialog' id='"+dialog.w(true)+"'>" +
				"<div class='__dialogwrapper'>" +
					"<div class='__dialogwrapper-inner'>" +
						"<div class='__dialogmain'>" +
							"<div class='__dialogtitlewrap nd'><div class='__dialogtitle unselectable' onclick=\"AP.dialog('"+dialog.id()+"').balance();\"></div></div>"+
							"<div class='__dialogclose' onclick=\"AP.dialog('"+dialog.id()+"').hide();\"><span class='-ap icon-close'></span> </div>"+
							"<div class='__dialogcontent'></div>" +
						"</div>"+
					"</div>"+
				"</div>"+
			"</div>");
	};
	
	
	/**
	 * @desc Balancing the dialog.
	 */
	this.balance=function(dialog){
		var wid=dialog.w();
		var t=$(window).height()/2- $(wid+' .__dialogwrapper').outerHeight(true)/2-30;
		var l=$(window).width()/2- $(wid+' .__dialogwrapper').outerWidth(true)/2;
		if (t<50){
			t=50;
		}
		
		$(wid+' .__dialogwrapper').css('top', t).css('left', l);
		$(wid+' .__dialogwrapper .__buttons .button:last').focus();
	};
	
	
	
};







var FormDialogMobile=new function __FormDialogMobile(){
	this.canvas=function(){
		return $("#apdialogs");
	};
	
	
	/**
	 * @desc Render the dialog.
	 */
	this.render=function(dialog){	
		$(dialog.canvas()).append("" +
			"<div class='__mobiledialog' id='"+dialog.w(true)+"'>" +
				"<div class='__dialogwrapper'>" +
					"<div class='__dialogwrapper-inner'>" +
						"<div class='__dialogmain'>" +
							"<div class='__dialogclose' onclick=\"AP.dialog('"+dialog.id()+"').hide();\"><span class='-ap icon-close'></span> </div>"+
							"<div class='__dialogtitle unselectable ap-xdot'>"+"</div>" +
							"<div class='__dialogcontent'></div>" +
						"</div>"+
					"</div>"+
				"</div>"+
			"</div>");
	};
	
	
	/**
	 * @desc Balancing the dialog.
	 */
	this.balance=function(dialog){
		return this;
	};
	
	
	this.width=function(w){
		return;
	};
};
 

var UploadDialogEngine=new function __UploadDialogEngine(){
	inherits(this, WTDialogEngine);
	
	/**
	 * @desc Render the dialog.
	 */
	this.render=function(dialog){		
		$(dialog.canvas()).append("" +
			"<div class='__uploaddialog unselectable' id='"+dialog.w(true)+"'>" +
				"<div class='__dialogwrapper'>" +
					"<div class='__dialogwrapper-inner'>" +
						"<div class='__dialogmain'>" +
							"<div class='__dialogtitle'>"+"&nbsp;</div>"+
							"<div class='__dialogclose' onclick=\"$('#"+dialog.data('form')+"').multiUpload('close');\"><div class='entypo ticon-cancel'></div> </div>"+
							"<div class='__dialogcontent'></div>" +
							"<div class='__dialogbuttons unselectable'></div>"+
						"</div>"+
					"</div>"+
				"</div>"+
			"</div>");
	};
};
 


var Lang=new function _Lang(){	
	this.data={};
	this.set=function(data){
		this.data=data;
	}
	
	this.message=function(msg){
		if (this.data[msg]){
			return this.data[msg];
		}
		return "?"+msg+"";
	};
};


/**
 * @desc Procedural calls of lang.
 * @param key
 * @param flag
 */
function lang(key, flag){
	return key;
	
	if (!flag){
		flag=null;
	}
	var msg=Lang.message(key);
	if (flag=='ucf'){
		return AP.W.ucf(msg);
	}
	if (flag=='ucw'){
		return AP.W.ucw(msg);
	}
	if (flag=='upper'){
		return AP.W.upper(msg);
	}
	return msg;
};

function L(key){
	var lang=parseInt(Client.lang);
	if (lang==2){
		return Lang.message(key);
	}else{
		return key;
	}
};

 

var Context=new function __Context(){
	this.closeCallback=null;
	
	this._inited=false;
	this.init=function(){
		if (this._inited){
			return;
		}
		
		this._inited=true;
		$("#context-menu-close").on("contextmenu", function(e){
			e.preventDefault();
			Context.close();
		});
		
		$("#context-menu").css("right", -$.sbWidth());
		$("#context-menu-main").wrap("<div class='context-canvas-slider'></div>");
		
		$(document.body).delegate("input","blur", function(){
			setTimeout(function(){
				$("#context-tag > .tags").hide();
			},200);
		}).on("click", function(){
			setTimeout(function(){
				$("#context-tag > .tags").hide();
			},200);
		});
	}
	
	this.close=function(){
		$("#context-menu").hide();
		if (Context.closeCallback){
			Context.closeCallback();
		}
	};
	
	this.menu=function(ref, options){
		this.init();
		return new ContextMenu(ref, options);
	};
	
	
	/**
	 * @desc Binding a context-menu on-click action
	 */
	this.bind=function(ref, menu, options){
		
	};
	
	this.direct=function(x, y, options){
		this.init();
		return new ContextMenu({'x': x, 'y': y, type: 'click'}, {menu: options});
	}
	
	this.hide=function(){
		return this.close();
	};
	
	this.gen=new function __ContextGen(){
		this.close=function(){
			$("#context-general").hide();
		};
		
		this.hide=function(){
			return this.close();
		};
		
		this.show=function(elem){
			var $after=$("#context-general .context-main").next();
			if ($after && $after.length){
				$after.remove();
			}
			$(elem).insertAfter("#context-general .context-main").addClass('context-real');
			$("#context-general").show();
			$("#context-items").hide();
		};
		
		
		this.showID=function(id){
			var $obj=$("#context-items").find(id);
			if (!$obj.length){
				$(id).appendTo("#context-items").addClass('top').show();	
			}else{
				$("#context-items").children().removeClass('top').hide();
				$(id).addClass('top').show();
			}
			
			$("#context-general .context-real").hide();
			$("#context-items").show();
			$("#context-general").show();
		};
	};
	
	
	

	this.v2=function(opts){
		opts=$.extend({
			menu: [],
			width: 300
		}, opts);
		
		if (AP.data.isObject(opts) && !AP.data.isArray(opts)){
			opts.menu = opts.menu.context();
		}
		
		Context.direct(opts.left, opts.top, opts.menu);
		
		$("#context-menu-main").width(opts.width);
	};
	
	
};


function ContextMenu(ref, options){
	this.opts=$.extend({}, {top:30, left:20, menu:[]}, options);
	
	if (this.opts.close){
		Context.closeCallback=this.opts.close;
	}else{
		Context.closeCallback=null;
	}
	
	var top=0;
	var left=0;
	if (ref && ref.x && ref.y && ref.type && ref.type=="click"){
		top=ref.y;
		left=ref.x;
	}else if (options.x && options.y && options.type && options.type=="click"){
		top=options.y;
		left=options.x;
	}else{
		var offset=$(ref).offset();
		top=offset.top+this.opts.top;
		left=offset.left+this.opts.left;	
	}
	
	
	if (options.event){
		$(ref).on(options.event, function(){
			$("#context-menu").show();	
		});
	}else{
		$("#context-menu").show();
	}
	
	
	$("#context-menu-main").removeClass().css({'top': top, 'left': left});
	if (this.opts.layout){
		$("#context-menu-main").addClass(this.opts.layout);
	}
	
	if (options.width){
		$("#context-menu-main").width(options.width);
	}else{
		$("#context-menu-main").css("width", "300");
	}
	
	$("#context-menu-main .menu").cleanUp().html("<div class='items'></div>");
	
	var $menu=$("#context-menu-main .menu .items");
	
	for (var i=0; i<options.menu.length; i++){
		addMenuItem(options.menu[i], $menu, ref);
	};
	
	$menu.click(function(){
		Context.close();
	});
	
	var ch=$("#context-menu-main").height();
	var maxh=$(window).height();
	
	
	var cw=$("#context-menu-main").width();
	var maxw=$(window).width();
	var minh=$("#context-menu").height();
	
	
	if (top+ch+50>maxh){
		// top=top-ch-this.opts.top;
		// $("#context-menu-main").css("top", top);
		
		$("#contex-menu .context-menu-slider").css({height: top+ch+50})
	}
	

	
	if (left+cw>maxw){
		left=left-cw-this.opts.left+13;
		$("#context-menu-main").css("left", left);
	}
	
	
	function addMenuItem(opt, $menu, ref){
		if (!opt){
			return;
		}
		
		if (AP.data.isString(opt)){
			if (opt=='---0'){
				return;
			}
			
			var $last=$menu.children().last();
			if ($last && $last.hasClass("item-sep")){
				return;
			}
			
			if (opt=="|" || opt=="sep" || opt=="---" || /^(\-+)/.test(opt) || /^(\-+)([0-9]+)/.test(opt)){
				return $("<div class='item-sep'></div>").appendTo($menu);
			}
			
			$menu.append(opt);
			return;
		}
		
		if ('enabled' in opt){
			if (!opt.enabled){
				return;
			}
		}
		
		if (opt.type){
			if (opt.type=='sep'){
				return $("<div class='item-sep'></div>").appendTo($menu);	
			}
			
			if (opt.type=='html'){
				return $("<div class='item-html'>"+opt.html+"</div>").appendTo($menu);	
			}
		}
		
		if (!opt.css){
			opt.css='';
		}
		
		var icon='';
		if (opt.icon){
			if (opt.icon.substr(0,5)=="icon-"){
				icon="<span class='icon'><span class='-ap "+opt.icon+"'></span></span>";	
			}else if (AP.word.prefix(opt.icon, "ficon-")){
				icon="<span class='icon'><span class='"+opt.icon+" ap-f14'></span></span>";
			}else{
				icon="<span class='icon'><span class='-ap icon-"+opt.icon+"'></span></span>";
			}
		}else{
			opt.css+=" -no-icon";
		}
		
		if (opt.url){
			var eid=AP.uuid();
			var target='';
			if (opt.target && (opt.target=='_blank' || opt.target=='blank')){
				target="data-blank='1'";
			}
			
			if (opt.blank){
				target="data-blank='1'";
			}
			
			$menu.append("<div title='"+(opt.label)+"' class='ap-xdot item url "+(opt.css)+"' id='"+(eid)+"' data-url='"+(opt.url)+"' "+(target)+">"+(icon)+" "+(opt.label)+"</div>");
			
			if (opt.data && opt.data!=undefined){
				for (var key in opt.data){
					$("#"+eid).data(key, opt.data[key]);
				}
			}
			
			return;
		}
		
		var html= "<div class='item "+opt.css+"'>"+icon+opt.label+"</div>";
		return $(html).appendTo($menu).data('opt', opt).click(function(){
			Context.hide();

			var opt=$(this).data('opt');
			var action=opt.action;
			
			if (AP.data.isString(action)){
				return AP.toURL(action);
			}else{
				action.apply(ref, [opt, this]);
			}
		});
	};
};


(function($) {
    $.fn.setContextMenu = function(actions){
    	$(this).on("contextmenu", function(e){
    		var pos=$(this).offset();
    		var obj={x: e.clientX, y: e.clientY, type: 'click'};
    		e.preventDefault();
    		
    		Context.menu(obj, {
    			top: e.pageX-pos.top,
    			left: e.pageY-pos.left,
        		menu: actions
        	});	
    	});
    	
    };
 
}(jQuery));
 

var BC=new function __BC(){
	this.title=function(title){
		$("#bcanvas .__title").html(title);
	};
	
	this.side=function(side){
		$("#bcanvas .__side").html(side);
	};
	
	
	this.main=function(content){
		$("#bcanvas .__canvas").html(content);
	};
	
	this.show=function(){
		if (mobile()){
			$(document.body).addClass("xo");
			$("#document").hide();
		}
		
		$("#bcanvas").show().removeClass("__simple").addClass("__ontop");
		this.normal();
		
		if (!$("#bcanvas").hasClass('__init')){
			$("#bcanvas").addClass('__init');
			Layout.scrollable("#bside");
		}else{
			$("#bside").find(".scrollin").height("100%").css("width", $("#bside").width()+$.sbWidth());
		}
		
	};
	
	
	this.noSide=function(){
		$("#bcanvas").show().addClass("__simple");
	};
	
	this.hide=function(){
		$("#bcanvas").find(".__canvas").html("");
		$("#bcanvas").find(".__side").html("");
		$("#bcanvas").find(".__postbottom").html("");
		$("#bcanvas").fadeOut(200);
		
		if (mobile()){
			$(document.body).removeClass("xo");
			$("#document").show();
		}
	};
	
	
	
	this.extend=function(){
		$("#bcanvas").addClass("extended");
	};
	
	this.unextend=function(){
		$("#bcanvas").removeClass("extended");
	};
	
	this.normal=function(){
		$("#bcanvas").removeClass("extended");
	};
};




BC.ui=new function __BCUIx(){
	this.followers=function(obj){
		if (obj.followers.length<=6){
			return "<div class='list users'> <div class='li-title'>Followers</div> <div class='items'>"+AP.render(obj.followers, followerHTML)+"</div></div>";
		}else{
			return "<div class='list users'> <div class='li-title'>Followers</div> <div class='items'>"+AP.render(obj.followers, followerHTML)+"</div></div>";
		}
	};
	
	
	
	
	function followerHTML(user){
		return "<div class='li url' data-username='"+user.username+"'><div class='avatar avatar-40 rounded xo'>" +
				"<div class='image'><img src='"+AP.xthumb(user.gavatar)+"'></div>" +
			"</div></div>";
	}
};


var LiveChat=new function __LiveChat(){
	this.lc=null;
	
	this.init=function(room, canvas){
		this.lc=new LiveChatInstance(room, canvas);
		this.lc.build();
	};
	
	/**
	 * @desc Listen to message
	 */
	this.listen=function(){
		if (!Live){
			return;
		}
		
		Live.on("livechat.msg", function(data){
			if (!LiveChat.lc || !LiveChat.lc.room || LiveChat.lc.room.hid!=data.room.hid){
				return LiveChat.notis(data);
			}
			
			var room=data.room;
			var msg=data.message;
			
			var $box=$("#js-livechat-"+room.hid);
			if ($box.length){
				LiveChat.lc.prepend(msg); 
			}
		});
		
		AP.sys.on("page.pre.transition", function(){
			if (LiveChat.lc){
				LiveChat.lc=null;
				Live.emit("custom.room", {leave: 1});	
			}
		});
	};
	
	/**
	 * @desc Notification on data
	 */
	this.notis=function(data){
		if (!data.onlines || !data.message || !data.room){
			return;
		}
		
		
		var u=People.get(data.message.user_id);
		
		if (AP.array.contain(data.onlines, Client.viewer, function(e, f){
			return parseInt(e)==parseInt(f);
		})){
			return;
		}
		
		DN.show({
			title: data.room.name,
			icon: AP.thumb(u.gavatar),
			body: u.name+": "+data.message.content,
			tag: data.room.hid+"-"+data.message.id,
		});
	};
};


setTimeout(function(){
	LiveChat.listen();
}, 1000);


function LiveChatInstance(room, canvas){
	this.canvas=canvas;
	this.room=room;
	
	/**
	 * @desc Build livechat
	 */
	this.build=function(){
		var room=this.room;
		Live.emit("custom.room", room);
		
		$(this.canvas).data("livechat", this).data("room", this.room);
		initCanvas(this.canvas, room);
		
		UI.ajaxHide();
		var that=this;
		
		var $c=$(this.canvas);
		$c.data("livechat", that);
		
		AP.post("api/livechat/load", {hid: this.room.hid, token: this.room.token}, function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			for (var i=0; i< code.messages.length; i++){
				that.insert(code.messages[i]);
			}
		});
		
		
		$(this.canvas).find(".js-chat-input").enter(function(){
			var v=$.trim($(this).val());
			if (v && v.length){
				sendMessage(v, this);
			}
		});
		
		AP.uploadable($(this.canvas).find(".action.-file"), {
			action: "api/livechat/send",
			data: {hid: this.room.hid, token: this.room.token}
		}, function(code){
			if (!code.good()){
				$.log("ERROR_MSG");
			}
			
			that.prepend(code.msg);
		});
	};
	
	
	this.insert=function(msg){
		var html=getHTML(msg);
		
		var $c=$(this.canvas);
		var $last=$c.find(".messages .js-message").last();
		var compact=false;
		
		if (!$last || !$last.length){
			compact=false;
		}else{
			var uid=parseInt($last.data("uid"));
			var time=parseInt($last.data("time"));
			
			if (uid==parseInt(msg.user_id) && parseInt(msg.since)-time<300){
				compact=true;
			}
		}
		
		if (compact){
			$(html).appendTo($c.find(".messages")).addClass("-compact");
		}else{
			$(html).appendTo($c.find(".messages"));
		}
	};
	
	
	
	this.prepend=function(msg){
		var html=getHTML(msg);
		
		var $c=$(this.canvas);
		var $last=$c.find(".messages .js-message").first();
		var compact=false;
		
		if (!$last || !$last.length){
			compact=false;
		}else{
			var uid=parseInt($last.data("uid"));
			var time=parseInt($last.data("time"));
			
			if (uid==parseInt(msg.user_id) && parseInt(msg.since)-time<300){
				compact=true;
			}
		}
		
		$(html).prependTo($c.find(".messages"));
		
		if (compact){
			$last.addClass("-compact");
		}
	};
	
	
	
	
	/**
	 * @desc Init a livechat canvas
	 */
	function initCanvas(canvas, room){
		$(canvas).html("<div class='mt-canvas' id='js-livechat-"+(room.hid)+"'> <div class='mt-messages scrollable' data-autoscroll='1' data-autohide='1'> <div class='messages'></div> </div> <div class='mt-form'> <div class='actions'> <div class='action -file'><span class='-ap icon-uniF10A'></span> </div> <div class='action -submit'><span class='txt'>Send</span></div> </div> <div class='textarea'> <textarea name='msg' placeholder='Send message' class='js-chat-input'></textarea> </div> </div> </div>");
		
		$(canvas).addClass("js-livechat-wrapper");
		Layout.scrollable(canvas+" .scrollable");
		
		Tag.user($(canvas).find(".js-chat-input"), Client.people);
	};
	
	
	/**
	 * @desc sendMessage
	 */
	function sendMessage(msg, ref){
		var $canvas=$(ref).closest(".js-livechat-wrapper");
		var room=$canvas.data("room");
		
		UI.ajaxShow();
		AP.post("api/livechat/send", {content:msg, hid: room.hid, token: room.token}, function(code){
			UI.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			// Clean up
			cleanupForm(ref);
			// $canvas.data("livechat").prepend(code.msg);
			
			broadcast(code.msg, room, code.origin.followers);
		});
	};
	
	
	function broadcast(message, room, users){
		Live.emit("livechat.msg", {message:message, room: room, users: People.ids(users), metatype:"users"});
	};
	
	
	function getHTML(msg){
		var u=People.get(msg.user_id);
		
		var is_me='';
		if (parseInt(msg.user_id)==parseInt(Client.viewer.id)){
			is_me=' -me';
		}
		
		var content=msg.content;
		if (msg.metatype=="upload" && msg.attachment){
			content=getFile(msg);
		}else{
			content=UI.parse(content);
		}
		
		var html="<div class='message js-message"+(is_me)+"' data-id='"+(msg.id)+"' data-time='"+(msg.since)+"' data-uid='"+(msg.user_id)+"'> <div class='avatar '><div class='image'><img src='"+(AP.xthumb(u.gavatar))+"'/></div></div> <div class='text'> <div class='user'> <b class='url' data-username='"+(u.username)+"'>"+(u.name)+"</b> &middot; <span class='time'>"+(AP.time.ago(msg.since))+"</span> </div> <div class='content'>"+(content)+"</div> </div> </div>";
		
		return html;
	};
	
	
	function getFile(msg){
		var att=msg.attachment;
		var f=UI.file.icon(att.name);
		
		return "<div class='msg-file'> <div class='ficon'><img src='"+(Client.share_url)+"/m2/"+(f)+".svg'/></div> <div class='fname'> <span class='url' data-url=':file' data-file='"+(att.src)+"'>"+(att.name)+"</span> </div> <div class='finfo'>"+(UI.file.kb(att.size))+" &middot; "+(AP.time.ago(att.since))+"</div> </div>";
	};
	
	
	/**
	 * @desc Cleanup a form
	 */
	function cleanupForm(ref){
		var $f=$(ref).closest(".mt-form");
		$f.find("textarea").val("");
	};
};
 var App = new function __App(){
	
	this.admin = function(){
		return Me.isAppAdmin();
	};
	
	this.sysowner = this.sysOwner = function(){
		return Me.isSysowner();
	};
	
	this.admins = function(){
		return this.sub.admins();
	};
	
};



App.role = new function __AppRole(){
	
	this.prefs = function(opts){
		var html=AP.render(opts.roles, function(e){
			return getPref(e, opts.values);
		});
		
		$(opts.canvas).html("<div class='app-prefs'>"+(html)+"</div>");
		
		$(opts.canvas).find(".pref").each(function(){
			var api=$(this).data("api");
			var key=$(this).data("key");
			
			setPrefValue(this, key);
			$(this).find(".pref-value").click(function(){
				
			});
		});
	};
	
	
	/**
	 * @desc Config for users
	 */
	this.users = function(opts){
		var html=AP.render(opts.users, function(e){
			if (AP.data.isObject(e)){
				return getUserRoles(e, opts);	
			}else{
				var u=People.get(e);
				if (!u.error){
					return getUserRoles(u, opts);	
				}
			}
		});
		
		$("#js-user-roles").html("<div class='user-roles'>"+(html)+"</div>");
	};
	
	
	
	function getPref(e, values){
		var val=0;
		if ("value" in e){
			val=e.value;
		}else if (typeof(values[e.key]) != "undefined"){
			val=values[e.key];
		}
		
		val=parseInt(val);
		var icon='';
		if (e.icon){
			icon="<span class='pref-icon'>"+(e.icon)+"</span>";
		}
		
		return "<div class='pref "+(icon?' -p32':'')+"'> "+(icon)+" <div class='pref-name'>"+(e.label)+"</div> <div class='pref-info'>"+(e.label)+"</div> <div class='hidden'><input type='hidden' name'"+(e.key)+"' value='val'/></div> <div class='pref-value'> <div class='onoff "+(val?'-on':'-off')+" -small'></div> </div> </div>";
	};
	
	
	function setPrefValue(){
		
	};
	
	
	function getUserRoles(u, opts){
		var html=AP.render(opts.roles, function(r){
			return "<div class='uri' data-key='"+(r.key)+"'> <div class='uri-name'>"+(r.label)+"</div> <div class='uri-info'>"+(r.label)+"</div> <div class='uri-value'>"+(getValue(u, r))+"</div> </div>";
		});
		
		return "<div class='ur'> <div class='ur-header url' data-url=':collapse:parent'> <div class='ur-image'><img src='"+(AP.xthumb(u.gavatar))+"'/></div> <div class='ur-title'>"+(u.name)+"</div> <div class='ur-info'>"+(u.title)+"&nbsp;</div> </div> <div class='ur-body'>"+(html)+"</div> </div>";
	};
	
	
	function getValue(u, r){
		var html=AP.render(r.values, function(e){
			return "<option value='"+(e)+"'>"+(e)+"</option>";
		});
		
		return "<select name='ur-"+(u.username)+"'>"+(html)+"</select>"
	};
};


App.sub = new function __AppSub(){
	
	this.admins = function(){
		return Client.people.slice(10,20);
	};
	
};
if (!Client.networks){
	Client.networks = Client.units;
}

var Network=new  function __Network(){
	this.favorMe=function(){
		if (!Client.data.network){
			return;
		}
		
		if (Me.favor(Client.data.network)){
			var id=Client.data.network.id;
			Me.removeFavorite(id, function(fs){
				Client.favors=fs;
				UI.flash("Team removed to from favourite!");
				
				$("#team-"+id).removeClass("-favour").slideUp(150, function(){
					$(this).prependTo("#teams").slideDown(400);
				});
			});
		}else{
			var id=Client.data.network.id;
			Me.setFavorite(id, function(fs){
				UI.ajaxHide();
				Client.favors=code.favors;
				UI.flash("Team set to favourite!");
				$("#team-"+id).addClass("-favour").slideUp(150, function(){
					$(this).insertAfter("#menu .section.-favorite .last").slideDown(400);
				});
			});
		}
	};
	
	this.leave=function(){
		if (!Client.data.network){
			return;
		}
		
		if (this.root()){
			return AP.alertError("You can not leave the company.");
		}
		
		AP.confirm("Are you sure that you want to leave the team <b>"+Client.data.network.name+"</b> now? This action cannot be undone.", function(){
			AP.ajaxShow();
			AP.post("api/network/member/leave",{hid: Client.data.network.hid, token: Client.data.network.token}, function(code){
				AP.ajaxHide();
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				AP.alertSuccess("You've just left the team!", function(){
					AP.redirect("home");
				});
			});
		});
		
	};
	
	this.root=function(network){
		if (network){
			return AP.data.equal(network.type, this.type.types.root)
		}
		
		return Client.data.network && AP.data.equal(Client.data.network.type, this.type.types.root);
	};
	
	
	this.select=function(title, callback){
		if (!callback){
			callback=null;
		}
		
		var actions=[];
		for (var i=0; i<Client.networks.length; i++){
			var e=Client.networks[i];
			actions.push({id:e.id, hid: e.hid, token: e.token, label: e.name, name:e.name, sublabel: Client.system.domain+"/"+e.path+" &middot; "+e.num_people+" people", value: 1});
		}
		
		AP.selectAction(actions, function(action){
			if (callback){
				callback(action);
			}
		},{title: title});
	};
	
	
	this.invite=function(){
		if (this.root() || !Client.data.network){
			return Company.member.inviteDialog();
		}else{
			return this.member.inviteDialog();
		}
	};
	
	
	this.inviteList=function(content, callback, error){
		AP.post("api/network/member/invite",{list: 1, network: Client.data.network.id, token: Client.data.network.token, usernames: content}, function(code){
			if (!code.good()){
				if (error){
					error(code.message);
				}
				return AP.alertError(code.message);
			}
			
			callback(code.usernames);
		});
	};
	
	
	
	this.get=function(id){
		if (AP.data.isInt(id)){
			return AP.array.findObj(Client.networks, id);	
		}
		
		
		for (var i=0; i<Client.networks.length; i++){
			if (Client.networks[i].path==id){
				return Client.networks[i];
			}
		}
		
		return null;
	};
	
	
	this.getByPath=function(path){
		for (var i=0; i<Client.networks.length; i++){
			if (Client.networks[i].path==path){
				return Client.networks[i];
			}
		}
		
		return null;
	};
	
	
	this.integrate=function(){
		var form=Form.create('d-integrate-fx',{'action':'api/network/integrate'})
		.row(
			Form.noLabel(),
			Form.input({name: 'praise', "type":"checkbox-list", "placeholder":"", label: "Praise",sublabel: "Praise people for their great works."}).value(Network.appVal('praise'))
		)
		.row(
			Form.noLabel(),
			Form.input({name: 'video', "type":"checkbox-list", "placeholder":"", label: "Video conference",sublabel: "Video conference for your team. Via Google hangout!"}).value(Network.appVal('video'))
		)
//		.row(
//			Form.noLabel(),
//			Form.input({name: 'deal', "type":"checkbox-list", "placeholder":"", "label": "Deal", "sublabel":"No more trouble managing deals. <b>Deal</b> helps the team keep track of all activities, share notes, post follow-ups, and never fail at any deals."}).value(Network.appVal('deal'))
//		)
//		.row(
//			Form.noLabel(),
//			Form.input({name: 'kbase', "type":"checkbox-list", "placeholder":"", "label": "Knowledgebase", "sublabel":"Your team's knowledge at once place. <b>Knowledgebase</b> helps the team save and discuss about static team information such as company regulation, working code, etc."}).value(Network.appVal('kbase'))
//		)
		.row(
			Form.noLabel(),
			Form.input({name: 'wiki', "type":"checkbox-list", "placeholder":"", "label": "Wiki", "sublabel":"Collaborative team wiki. Great for company policies and code documentations."}).value(Network.appVal('wiki'))
		)
		.hiddens({
			network: Client.data.network.id,
			'token': Client.data.network.token
		})
		.buttons([
		     {label: "Save and init apps", action: function(){
		    	 Form.submit("d-integrate-fx", function(code){
		    		 if (!code.good()){
		    			 return AP.alertError(code.message);
		    		 }
		    	
		    		 Form.hide("d-integrate-fx");
		    		 
		    		 AP.xRefresh(function(){
		    			 UI.flash("App preferences saved");
		    		 });
		    		 
		    		 Client.pageData.network_apps=code.network_apps;
		    		 
		    	 });
		     }, style: 'ok -success -rounded bold'},
		     {label: "Cancel", action: function(){
		    	 Form.hide("d-integrate-fx");
		     }, style:'cancel -passive-2 -rounded'}
		]).settings({"block": true});
	
		Form.pop({id:'d-integrate-fx-dx', width: 720, 
			label: "Apps integration for "+Client.data.network.name,
		}).setForm(form).show().addClass("full-content").focus('usernames');
	};
	
	
	this.appVal=function(key){
		var id=Client.pageData.network_apps.indexOf(key);
		if (id==-1){
			return 0;
		}
		return 1;
	};
	
	
	this.settings=function(){
		var admin=false;
		if (Client.data.network && Me.isNetworkAdmin(Client.data.network)){
			admin=true;
		}
		
		
		if (admin){
			var options=[];
			options.push({"label":"Edit team name &amp; privacy", "icon":"cog", action: function(){
				Network.editSelf();
			}});
			
			options.push({"label":"Invite more people", "icon":"person_add", action: function(){
				Network.invite();
			}});
			
			options.push({"label":"Team preferences &amp; settings", "icon":"lock_outline", action: function(){
				Network.preference();
			}});
			
			
			options.push({"label":"My personal preferences", "icon":"favorite_outline", action: function(){
				Network.personalPreference();
			}});
			
			if (!Network.root()){
				if (Client.data.network && Client.pageData.settings_team.leave=="yes"){
					options.push({"label":"Leave the team now", "icon":"power_settings_new", action: function(){
						Network.leave();
					}});	
				}	
			}
			
			AP.actionMenu(options);
			return;
		}else{
			var options=[];
			options.push({"label":"My personal preferences", "icon":"favorite_outline", action: function(){
				Network.personalPreference();
			}});
			
			if (Client.data.network && Client.pageData.settings_team.leave=="yes"){
				options.push({"label":"Leave the team now", "icon":"power_settings_new", action: function(){
					Network.leave();
				}});
			}
			
			AP.actionMenu(options);
			return;
		};	
	};
	
	
	
	this.preference=function(){
		UI.setting("Team preferences &amp; settings")
		.add({
			title: "Who can create regular posts?", 
			options: {"everyone":"Everyone","admin":"Team admins and owners", "owner":"Only team owners"}, 
			value: Client.pageData.settings_team.update,
			name:"update",
			url: "api/network/setting/"+Client.data.network.hid
		})
		.add({
			title: "Who can create new topics?", 
			options: {"everyone":"Everyone","admin":"Team admins and owners", "owner":"Only team owners"}, 
			value: Client.pageData.settings_team.topic,
			name:"topic",
			url:"api/network/setting/"+Client.data.network.hid
		})
		.add({
			title: "Who can post announcements?", 
			options: {"everyone":"Everyone","admin":"Team admins and owners", "owner":"Only team owners"}, 
			value: Client.pageData.settings_team.announcement,
			name:"announcement",
			url:"api/network/setting/"+Client.data.network.hid
		})
		.add({
			title: "Grant posting announcements permission to some extra users? <small><i>Note.</i> This is an exception.</small>", 
			options: ":custom:users", 
			value: Client.pageData.settings_team.announcement_extra,
			name:"announcement_extra",
			url:"api/network/setting/"+Client.data.network.hid
		})
		.add({
			title: "Who can use tag <b>@all</b> to tag everyone?", 
			options: {"everyone":"Everyone","admin":"Team admins and owners", "owner":"Only team owners"}, 
			value: Client.pageData.settings_team.tagall,
			name:"tagall",
			url:"api/network/setting/"+Client.data.network.hid
		})
		.add({
			title: "Share posts of this team to its members' home feeds? <small><i>Note.</i> Each member can also have his/her own preference.</small>", 
			options: {"yes":"Yes","no":"No"}, 
			value: Client.pageData.settings_team.share,
			name:"share",
			url:"api/network/setting/"+Client.data.network.hid
		})
		.add({
			title: "Allow team members to delete their own posts?", 
			options: {"yes":"Yes","no":"No"},
			value: Client.pageData.settings_team.delete_post,
			name:"delete_post",
			url:"api/network/setting/"+Client.data.network.hid
		})
		.add({
			title: "Allow team members to leave? <small><i>Note.</i> If allowed, team members can leave the team by themselves. In any cases, team owners can remove members.</small>", 
			options: {"yes":"Yes","no":"No"}, 
			value: Client.pageData.settings_team.leave,
			name:"leave",
			url:"api/network/setting/"+Client.data.network.hid,
		})
		.show();
	};
	
	
	
	
	this.personalPreference=function(){
		UI.setting("Personal preferences")
		.add({
			title: "Share posts from this team to my home's newsfeeds? <small>Note: Automatic means that this setting is based on the team's current setting.</small>", 
			options: {"auto":"Automatic","yes":"Yes","no":"No"}, 
			value: Client.pageData.settings_team.update,
			name:"update",
			url: "api/network/preference/"+Client.data.network.hid
		})
		.show();
	};
	
	
	
	
	this.editSelf=function(){
		Company.editNetwork(Client.data.network);
	};
};Network.type=new function __NetworkType(){
	this.types={
		'head':13,
		'root':13,
		'office_public':1,
		'office_private':2,
		'office_restriced':3
	};
	
	this.typeName=function(type){
		if (AP.data.equal(type, this.types.head)){
			return "Head office";
		}
		
		if (AP.data.equal(type, this.types.office_public)){
			return "Public office";
		}
		
		if (AP.data.equal(type, this.types.office_private)){
			return "Private office";
		}
		
		return "Restricted office";
	};
};Network.member=new  function __WnetworkMember(){
	this.invite=function(ref){
		Form.submitFrom(ref, function(code){
			if (!code.good()){
   			 return AP.alertError(code.message);
   		 }
   		 
   		 AP.alertSuccess(code.message);
		});
	};
	
	
	this.inviteDialog=function(){
		var form=Form.create('d-invite-fx',{'action':'api/network/member/invite'})
		.row(
			Form.noLabel(),
			Form.input({name: 'usernames', "type":"text", "placeholder":"Type @ to tag all people you want to invite"})
		)
		.hiddens({
			network: Client.data.network.id,
			'token': Client.data.network.token
		})
		.buttons([
		     {label: "Invite to "+Client.data.network.name, action: function(){
		    	 Form.submit("d-invite-fx", function(code){
		    		 if (!code.good()){
		    			 return AP.alertError(code.message);
		    		 }
		    	
		    		 Form.hide("d-invite-fx");
		    		 return AP.alertSuccess("Invite people successfully", function(){
		    			 AP.refresh();
		    		 });
		    	 });
		     }, style: 'ok -success -rounded bold'},
		     {label: "Cancel", action: function(){
		    	 Form.hide("d-invite-fx");
		     }, style:'cancel -passive-2 -rounded'}
		]).settings({"block": true});
	
		Form.pop({id:'d-invite-fx-dx', width: 600, 
			label: "Invite people to "+Client.data.network.name
		}).setForm(form).show().focus('usernames');
		
		Tag.user(form.find('usernames'), Client.people);
	};
	
};var Role=new function __Role(){
	
	this.OWNER=13;
	this.ADMIN = 10;
	this.REGULAR=1;
	this.BLOCKED=-1; 
	
	this.lists=
		[
		 	{id: 13, key:'owner', name:'Team Owner'},
		 	{id: 10, key:'admin', name:'Admin'},
		 	{id: 1, key:'member', name:'Member'},
		 	{id: -1, key:'blocked', name:'Blocked Member'},
		];
};





Role.collection=new function __RoleCollection(){
	this.get=function(id){
		id=parseInt(id);
		for (var i=0; i<Role.lists.length; i++){
			if (Role.lists[i].id==id){
				return Role.lists[i]; 
			}
		}
		
		return {id: 0, key:'unknown', name:'Unknown Role'};
	};
};var UI = new function __UI() {
	this.str2int = function (str) {
		var r = 3;
		for (var i = 0; i < str.length; i++) {
			r += str.charCodeAt(i) * str.charCodeAt(i);
		}

		return r % 8 + 1;
	};


	this.clean = function (content) {
		return AP.purify(content.replace(/\{\{\@[a-zA-Z0-9 ]+\}\}/g, function (match) {
			var key = match.substr(3, match.length - 5);
			return "@" + key + "";
		}));
	};


	this.parse = function (content) {
		return content.replace(/\{\{\@[a-zA-Z0-9\_]+\}\}/g, function (match) {
			var key = match.substr(3, match.length - 5);
			var u=People.get(key);
			if (u && parseInt(u.uid)){
				return "<em class='url pointer username inline-tag' data-username='"+(u.username)+"'>"+(u.name)+"</em>";
			}
			
			return "<em class='url pointer username inline-tag'>" + key + "</em>";
		});
	};

	this.fakeLoading = function (fn) {
		this.ajaxShow();
		setTimeout(function () {
			UI.ajaxHide();
			fn();
		}, 300);
	};

	this.ajaxShow = function () {
		$("#ajax-load-2").show();
	};

	this.ajaxHide = function () {
		$("#ajax-load-2").hide();
	};


	this.picker=function(objs, callback, opts){
		if (!opts){
			opts={};
		}
		
		opts=$.extend({}, {title: "Please select one", filter: true, search: true}, opts);
		
		var actions=[];
		for (var i=0; i<objs.length; i++){
			actions.push({label: objs[i].name, name: objs[i].name, id: objs[i].id, value: objs[i].id, data: objs[i]});
		}
		
		AP.selectAction(actions, function(e){
			callback(e.data);
		}, opts);
	};
	
	this.autoActive=function(){
		$(".auto-active-url").each(function(){
			var fb="home";
			if ($(this).data("default")){
				fb=$(this).data("default");
			}
			
			if ($(this).data("urlparam")){
				$(this).children(".url").setActiveURLParam($(this).data("urlparam"), 0);
			}else{
				$(this).children(".url").setActiveURL({fallback: fb});	
			}
		});
		
		$(".auto-url2a").each(function(){
			Base.url2a(this, ".url");
		});
	};
	
	this.tabView = function (tabs, sections, callback) {
		$(tabs).each(function () {
			$(this).click(function () {
				$(this).siblings().removeClass("active");
				$(this).addClass("active");
				var $this = $(this);
				var tab = $(this).data("tab");

				$(sections).each(function () {
					if ($(this).data("tab") == tab) {
						var status = false;

						if ($(this).hasClass("active")) {
						} else {
							status = true;
						}

						$(this).addClass("active");

						if (callback) {
							callback(tab, status, $this);
						}
					} else {
						$(this).removeClass("active");
					}
				});
			});

			if ($(this).hasClass("active")) {
				var tab = $(this).data("tab");
				var $this = $(this);
				$(sections).each(function () {
					if ($(this).data("tab") == tab) {
						$(this).addClass("active");
						if (callback) {
							callback(tab, true, $this);
						}
					} else {
						$(this).removeClass("active");
					}
				});
			}
		});
	};

	
	this.rangePicker=function(callback){
		var data={};
		var start=null, end=null;
		if (Client.pageData.range){
			start=Client.pageData.range.start;
			end=Client.pageData.range.end;
		}
		
		var form=Form.create('fly-rp-fx',{'action': "about:blank"})
		.row(
			Form.label({label: "Start date *"}),
			Form.input({name: 'start', placeholder: "Start date", role:"date"}).value(start)
		)
		.row(
			Form.label({label: "End date *"}),
			Form.input({name: 'end', placeholder: "End date", role:"date"}).value(end)
		)
		.buttons([
			 {label: "Okay", action: function(){
				 var start=$("#fly-rp-fx *[name=start]").val();
				 var end=$("#fly-rp-fx *[name=end]").val();
				 if (start && end){
					 callback(safe(start), safe(end));
					 Form.hide("fly-rp-fx");	 
				 }else{
					 AP.alertError("PLEASE SELECT ALL DATES");
				 }
				 
			 }, style: 'ok -success -rounded bold'},
			 {label: "Hủy", action: function(){
				 Form.hide("fly-rp-fx");
			 }, style:'cancel -passive-2 -rounded'}
		])
		.hiddens(data)
		.render(function(fref){
		});

		Form.pop({id:'fly-rp-dx', width: 480, label: "Select duration", layout: 'flat', closable: false}).setForm(form).show();
	};

	
	
	this.time = function (ts) {
		return AP.time.time("%h:%i %M %d", ts);
	};


	this.simpleTime = function (time) {
		var today = AP.time.time("%M %d", AP.time.now());
		var yesterday = AP.time.time("%M %d", AP.time.now() - 24 * 3600);
		var test = AP.time.time("%M %d", time);

		if (today == test) {
			return AP.time.time("%H:%i today", time);
		} else if (today == yesterday) {
			return AP.time.time("%H:%i yesterday", time);
		}

		return AP.time.time("%H:%i %M %d", time);
	};


	this.inputTime = function (time) {
		return AP.time.time(AP.i18n.dateFormat(), time);
	};


	this.inputDate = function (time) {
		return AP.time.time(AP.i18n.dateFormat(), time);
	};

	this.simpleDate = function (time) {
		return AP.time.time("%M %d, %Y", time);
	};


	this.progression = function (object, canvas, opts) {
		return this.graph.progression(object, canvas, opts);
	};


	this.dayOptions = function (selector) {
		var html = AP.render(range(1, 31), function (e) {
			return "<option value='" + e + "'>" + AP.data.zeroPrefix(e) + "</option>";
		});
		html = "<option value='0'>-- Select date --</option>" + html;

		$(selector).html(html);
	};


	this.monthOptions = function (selector) {
		var html = AP.render(range(1, 12), function (e) {
			return "<option value='" + e + "'>" + AP.data.zeroPrefix(e) + "</option>";
		});
		html = "<option value='0'>-- Select month --</option>" + html;

		$(selector).html(html);
	};


	this.yearOptions = function (selector) {
		var html = AP.render(range(1950, 2017), function (e) {
			return "<option value='" + e + "'>" + AP.data.zeroPrefix(e) + "</option>";
		});
		html = "<option value='0'>-- Select year --</option>" + html;

		$(selector).html(html);
	};


	this.searchable=function(ip){
		$(ip).enter(function(){
			var q=$(this).val();
			if (!q || !q.length){
				q=null;
			}
			AP.setURLParams({q: q}, true);
		});
		
		var q=Query.get("q");
		if (q){
			$(ip).val(q);
		}
	};
	
	
	this.previewImage = function (url) {
		function resizeImgBox(ref) {
			var h = $(ref).data("h");
			var w = $(ref).data("w");
			var mh = $("#image-dialog-previewer .image-wrap").height();

			if (!h || !mh) {
				return;
			}

			if (h > mh) {
				$(ref).css("height", mh).css("width", w * mh / h);
			}

			$(ref).dblclick(function () {
				var h = $(this).data("h");
				var w = $(this).data("w");
				var mh = $("#image-dialog-previewer .image-wrap").height();
				var s = $(this).data("s");

				if (s == 0) {
					s = 1;
				} else {
					s = 0;
				}

				$(this).data("s", s);

				if (s == 1) {
					$(ref).css({width: w, height: h});
				} else {
					$(ref).css("height", mh).css("width", w * mh / h);
				}
			});
		};


		$("#image-dialog-previewer").remove();

		$("<div id='image-dialog-previewer'></div>").appendTo(document.body);
		$("#image-dialog-previewer").html("" +
			"<div class='image-wrap'><div class='img'><img src='" + url + "'/></div></div>" +
			"<div class='image-actions'>" +
			"	<div class='action image-close'><span class='-ap icon-close'></span></div>" +
			"	<a class='action url' href='" + url + "' target='_blank'><span class='-ap icon-forward2'></span></a>" +
			"</div>");

		$("#image-dialog-previewer .image-close").click(function () {
			$("#image-dialog-previewer").remove();
		});

		// Draggable
		$("#image-dialog-previewer .image-wrap .img").draggable({
			// containment: 'parent'
		});

		$("#image-dialog-previewer .img img").load(function () {
			var h = $(this).height();
			var w = $(this).width();

			$(this).data("h", h);
			$(this).data("w", w);
			$(this).data("s", 0);

			resizeImgBox(this);
		});
		
		Context.close();
	};


	this.paginate = function (canvas, url) {
		if (!url){
			url=Client.path.base;
			if (!url){
				url="";
			}
			
			var cqs="";
			
			var qs=Query.all();
			for (var key in qs){
				if (key=="env" || key=="page" || !key){
					continue;
				}
				cqs+=key+"="+qs[key]+"&";
			}
			
			if (cqs.length){
				cqs=cqs.substr(0, cqs.length-1);
			}
			
			if (cqs){
				if (Client.path.current.indexOf("?")==-1 || cqs){
					url=url+"?"+cqs;
				}else{
					url=url+"&"+cqs;
				}
			}
		}
		
		var page = Query.getInt("page");
		if (!page) {
			page = 1;
		}

		var next_url = url + "?page=" + (page + 1);
		var prev_url = url + "?page=" + (page - 1);

		if (url.indexOf("?") != -1) {
			next_url = url + "&page=" + (page + 1);
			prev_url = url + "&page=" + (page - 1);
		}


		var html = "<div class='icons'>" +
			"<div class='prev url' data-url='" + prev_url + "'><span class='-ap icon-arrow-left2'></span></div>" +
			"<div class='label'>Page " + page + "</div>" +
			"<div class='next url' data-url='" + next_url + "'><span class='-ap icon-arrow-right2'></span></div>" +
			"</div>";


		if (page == 1) {
			html = "<div class='icons'>" +
				"<div class='prev disabled'><span class='-ap icon-arrow-left2'></span></div>" +
				"<div class='label'>Page " + page + "</div>" +
				"<div class='next url' data-url='" + next_url + "'><span class='-ap icon-arrow-right2'></span></div>" +
				"</div>";
		}

		$(canvas).addClass("apppages").html(html);
	};


	this.paginateEx = function (canvas, url, total_pages) {
		var page = Query.getInt("page");
		if (!page) {
			page = 1;
		}

		var next_url = url + "?page=" + (page + 1);
		var prev_url = url + "?page=" + (page - 1);

		if (url.indexOf("?") != -1) {
			next_url = url + "&page=" + (page + 1);
			prev_url = url + "&page=" + (page - 1);
		}


		var html = "<div class='icons'>" +
			"<div class='prev url' data-url='" + prev_url + "'><span class='-ap icon-arrow-left2'></span></div>" +
			"<div class='label'>Page " + page + "/" + total_pages + "</div>" +
			"<div class='next url' data-url='" + next_url + "'><span class='-ap icon-arrow-right2'></span></div>" +
			"</div>";


		if (page == 1) {
			html = "<div class='icons'>" +
				"<div class='prev disabled'><span class='-ap icon-arrow-left2'></span></div>" +
				"<div class='label'>Page " + page + "/" + total_pages + "</div>" +
				"<div class='next url' data-url='" + next_url + "'><span class='-ap icon-arrow-right2'></span></div>" +
				"</div>";
		}

		$(canvas).addClass("apppages").html(html);
	};


	this.editor = function (selector, action) {
		if (Client.native) {
			if (action == 'empty') {
				$(selector).val("");
				return;
			}
			return;
		}

		if (action == 'empty') {
			$(selector).trumbowyg('empty');
			return;
		}

		if (action == 'focus') {
			$(selector).closest(".trumbowyg-box").find(".trumbowyg-editor").focus();
			return;
		}

		
		var mh=$(selector).data("minheight");
		if (!mh){
			$(selector).data("minHeight");
		}
		
		if (!mh && AP.data.isObject(action)){
			mh=action.minHeight;
		}
		
		if (!mh){
			mh=300;
		}
		
		if (mh<10){
			mh=20;
		}
		
		if (AP.config && AP.config.editor=="summernote"){	
			var compact=$(selector).data("compact");
			var tb=[
				['style', ['style','bold', 'italic', 'underline', 'clear']],
//				['font', ['strikethrough', 'superscript', 'subscript']],
				['fontsize', ['fontsize']],
				['color', ['color']],
				['para', ['ul', 'ol', 'paragraph']],
				['insert', ['picture', 'link', 'table', 'hr']]
			];
			
			if (action && action.code){
				tb.push("custom", ["codeblock"]);
			}
			
			if (compact && parseInt(compact)){
				tb=[
					['style', ['bold', 'italic', 'underline', 'clear']],
//					['font', ['strikethrough', 'superscript', 'subscript']],
					['para', ['ul', 'ol', 'paragraph']]
				];
				
				if (parseInt(compact)==2){
					tb=[
//						['style', ['bold', 'italic', 'underline', 'clear']],
//						['font', ['strikethrough', 'superscript', 'subscript']],
					];
				}
			}
			
			
			var fs=parseInt($(selector).css("font-size"), 10);

			$(selector).summernote({
				tabsize: 2,
				minHeight: mh,
				toolbar: tb,
				placeholder: $(selector).attr("placeholder"),
				callbacks: {
					onPaste: function (e) {
					},
					onImageUpload: function (files, editor, welEditable) {
						for (var i = files.length - 1; i >= 0; i--) {
							editor_sendFile(files[i], this);
						}
					}
				},
				fontSize: fs,
				buttons: {
					codeblock:summernote_codeblock
				}
			});
			
			$(selector).parent().find(".note-editable").css("font-size", fs+"px");
			if ($(selector).data("dir")=="bottom"){
				$(selector).parent().find(".note-editor").addClass("editor-bottom")
			}
			
			if (AP.data.isObject(action) && action.value){
				$(selector).summernote("code", action.value);
			}
		}else if (AP.config && AP.config.editor=="quill"){
			var opts={};
			if (AP.data.isObject(action)){
				opts=action;
			}
			
			var compact=$(selector).data("compact");
			if (!compact){
				compact=opts.compact;
			}
			
			var toolbarOptions = [
				['bold', 'italic', 'underline', 'strike'], // toggled buttons
				['blockquote', 'code-block'],

				[{ 'header': 1 }, { 'header': 2 },],  // custom button values
				[{ 'list': 'ordered'}, { 'list': 'bullet' }],
				[{ 'script': 'sub'}, { 'script': 'super' }], // superscript/subscript
				[{ 'indent': '-1'}, { 'indent': '+1' }], // outdent/indent

				[{ 'color': [] }, { 'background': [] }], // dropdown with defaults from theme
				['clean'] // remove formatting button
			];
			
			if (compact==1){
				toolbarOptions = [
					['bold', 'italic', 'underline', 'strike'], // toggled buttons
					['blockquote', 'code-block'],

					[{ 'header': 1 }, { 'header': 2 },],  // custom button values
					[{ 'list': 'ordered'}, { 'list': 'bullet' }],

					[{ 'color': [] }, { 'background': [] }], // dropdown with defaults from theme
					['clean'] // remove formatting button
				];
			}else if (compact==2){
				toolbarOptions = [
					['bold', 'italic', 'underline'], // toggled buttons
					['blockquote', 'code-block'],
					[{ 'list': 'ordered'}, { 'list': 'bullet' }],
					['clean'] // remove formatting button
				];
			}
			
			var id=AP.uuid();
			var mh=300;
			if (opts.height){
				mh=opts.height;
			}else if (opts.minHeight){
				mh=opts.minHeight;
			}
			
			if (mh!="auto"){
				$(selector).hide().after("<div id='"+(id)+"' class='quill-wrapper' style='height:"+(mh)+"px'></div>");	
			}else{
				$(selector).hide().after("<div id='"+(id)+"' class='quill-wrapper'></div>");
			}
			
			
			var q=new Quill('#'+id, {
				modules: {
					toolbar: toolbarOptions
				},
				theme: "snow",
				placeholder:$(selector).attr("placeholder")
			});
			
			var $canvas=$("#"+id);
			$canvas.data("editor", q);
			$(selector).data("editor", q);
			
			if (opts.fit){
				$canvas.addClass("-editor-fit");
			}
			
			if (mh!="auto"){
				$canvas.find(".ql-editor").css({minHeight: mh});
				$canvas.data("mh", mh);
			}
			
			
			q.on("text-change", function(delta, oldDelta, source){
				var $qc=$(q.root).clone();
				$qc.find('.ql-indent-2').not('.ql-indent-2+.ql-indent-2').each(function(){
					$(this).nextUntil(':not(.ql-indent-2)').addBack().wrapAll("<li class='ql-temp-2'><ol></ol></li>");
				});
				
				$qc.find('.ql-indent-1').not('.ql-indent-1+.ql-indent-1').each(function(){
					$(this).nextUntil(':not(.ql-indent-1)').addBack().wrapAll("<li class='ql-temp-1'><ol></ol></li>");
				});
				
				$qc.find('.ql-temp-1').each(function(){
					var $prev=$(this).prev("li");
					if (!$prev.length){
						return;
					}
					
					$(this).find("ol").appendTo($prev);
					$(this).remove();
				});
				
				$qc.find('.ql-temp-2').each(function(){
					var $prev=$(this).prev("li");
					if (!$prev.length){
						return;
					}
					
					$(this).find("ol").appendTo($prev.find("li").last());
					$(this).remove();
				});
				
				
				$qc.find('.ql-indent-1').removeClass("ql-indent-1");
				$qc.find('.ql-indent-2').removeClass("ql-indent-2");
				
				var txt=(' '+$qc[0].innerHTML).slice(1);
				$qc.remove();
				
				$(selector).val(txt);
				
				if (mh!="auto"){
					quill_setHeight($canvas, q);
				}
			});
			
			if (opts.value){
				UI.editorValue(selector, opts.value);
				
				if (mh!="auto"){
					quill_setHeight($canvas, q);
				}
			}
		}else{
			  $.trumbowyg.svgPath = Client.share_url + "/plugins/editor.svg";
			  $.trumbowyg.hideButtonTexts = true;

			  var val = $(selector).val();
			  if (val == "" && !$(selector).attr("placeholder")) {
				  $(selector).val("<p></p>");
			  }
			  
			  $(selector).css("border", "none").addClass("js-editor").trumbowyg({
				  resetCss: false,
				  fullscreenable: false,
				  removeformatPasted: true,
				  autogrow: true,
				  btnsDef: {
					  // Customizables dropdowns
					  image: {
						  dropdown: ['insertImage', 'upload'],
						  ico: 'insertImage'
					  }
				  },
				  btns: [
					  ['formatting'], ['bold', 'italic', 'underline', 'strikethrough'], ['unorderedList', 'orderedList'], ['foreColor'],
					  ['link'],
					  ['image'],
					  'preformatted',
					  'removeformat',
					  ['viewHTML'],
				  ],
				  plugins: {
					  upload: {
						  serverPath: '/ajax/api/image/upload',
						  fileFieldName: 'image',
						  data: [{name: "__code", value: Client.code}, {name: "hid", value: Client.viewer.hid}],
						  success: function (data, trumbowyg, modal, values) {
							  var image = data.img;
							  if (image.status === 1) {
								  trumbowyg.execCmd('insertImage', image.url);
								  $('img[src="' + image.url + '"]:not([alt])', trumbowyg.$box).attr('alt', image.name);
								  setTimeout(function () {
									  trumbowyg.closeModal();
								  }, 250);
							  } else {
								  trumbowyg.addErrorOnModalField(
									  $('input[type=file]', modal),
									  trumbowyg.lang.uploadError || image.message
								  );
							  }
						  }
					  }
				  }
			  });

			 if (AP.isObject(action)) {
				var $cs = $(selector).closest(".trumbowyg-box");
				if (action.panel) {
					$cs.addClass("fix-panel-" + action.panel);
				}

				if (action.minHeight) {
					$cs.find(".trumbowyg-editor").css({minHeight: action.minHeight})
					$cs.css({minHeight: action.minHeight})
				}

				if (action.fit) {
					$cs.addClass("box-fit");
				}
			  }	
		}
	};

	
	function quill_setHeight($canvas, q){
		if ($canvas.hasClass("-editor-fit")){
			var rh=$canvas.find(".ql-editor").height();
			$canvas.height(rh);
			return;
		}
		
		var mh=$canvas.data("mh");
		if (!mh){
			mh=200;
		}
		
		var ih=0;
		$canvas.find(".ql-editor").first().children().each(function(){
			ih+=$(this).height();
		});
		
		if (ih + 50 < $canvas.height() && ih > mh){
			$canvas.css({height: ih+50});
		}
		
		var sh=$canvas.find(".ql-editor")[0].scrollHeight;
		var oh=$canvas.find(".ql-editor")[0].offsetHeight;
		
		
		if ((sh>oh+1) && !$canvas.hasClass("js-extended")){
			$canvas.css({height: sh+1});
		}
		
		if ((sh>mh*3+100 || sh>mh+400) && !$canvas.hasClass("js-extended")){
			$canvas.css({height: sh+5}).addClass("js-extended");
		}
	};
	
	
	function editor_sendFile(file, el){
		$.log(Client.base);
		
		var form_data = new FormData();
		form_data.append('file', file);
		form_data.append('__code', Client.code);
		form_data.append('__otp', Client.base.secureData.otp);
		form_data.append('__sessionid', Client.base.secureData.session);
		
		UI.ajaxShow();
		$.ajax({
			data: form_data,
			type: "POST",
			url: Base.domain("api")+"/ajax/api/file/upload",
			cache: false,
			contentType: false,
			processData: false,
			success: function(code){
				UI.ajaxHide();
				
				var c=new Code(code);
				if (!c.good()){
					return AP.alertError(code.message);
				}
				
				$(el).summernote('editor.insertImage', code.image);
			}
		});
	};
	
	

	this.editorValue = function (selector, value){
		if (AP.config && AP.config.editor=="quill"){
			var content=value.replace(/\&amp;/g,'&');
			var q=$(selector).parent().find(".quill-wrapper").data("editor");
			
			q.root.innerHTML=content;
			$(selector).val(q.root.innerHTML);
			$(selector).parent().find(".quill-wrapper pre").addClass("ql-syntax");
			
			$(selector).parent().find(".quill-wrapper pre").each(function(){
				$.log($(this).text());
			})
			
			return;
		}
		$(selector).trumbowyg('html', value);
	};


	this.mobileEditor = function (selector, action) {
		if (action == 'empty') {
			$(selector).trumbowyg('empty');
			return;
		}

		$(selector).css("border", "none").trumbowyg({
			resetCss: true,
			btns: [
				'bold', 'italic', 'underline',
				'|', 'link', 'insertImage',
				'|', 'formatting',
				'removeformat'
			],
			fullscreenable: false,
			removeformatPasted: true,
			autogrow: true
		});
	};


	this.flash = function (msg) {
		$("#flash-msg").show().html(msg).css({top: -80}).animate({top: 90}, 300).delay(1300).animate({top: -80}, 300, function () {
			$(this).hide();
		});
	};


	this.pickDeadline = function (input, callback) {
		$(input).data('callback', callback);

		$(input).on('click focus', function () {
			var html = buildDeadlinePicker();
			AP.customDialog(html, "#custom-deadline").addClass('-full').show();
			$("#deadline-picker").data("callback", $(this).data('callback'));
			$("#deadline-picker .custom .__date").selectDate();

			var val = $(this).val();

			if (val == "today" || val == "asap" || val == "tomorrow" || val == "weekend") {
				deadlinepicker_pick(val, true);
			}

			if (!val) {
				deadlinepicker_pick("custom", true);
			}
		});
	};

	
	/**
	 * @desc Click to show
	 */
	this.clickToShow=function(elem, opts){
		if (elem==="close"){
			$(opts).hide();
			$(opts).closest(".ui-overflow-fixed").toggleClass("extended");
			return;
		}
		
		opts=$.extend({}, {height: 100, bg:"#fff"}, opts);
		var h=$(elem).height();
		if (h<opts.height){
			return;
		}
		
		var sm="<div class='overflow-btn' onclick=\"UI.clickToShow('close', this)\" style='background-image: linear-gradient("+(Color.rgba(opts.bg, 0.2))+", "+(opts.bg)+", "+(opts.bg)+");'>Show more</div>";
		$(elem).addClass("ui-overflow-fixed").css({maxHeight: opts.height+"px"}).append(""+(sm)+"");
	};
	

	this.avatars = function (users) {
		if (!users || !users.length) {
			return "";
		}
		return AP.render(users, function (u) {
			return "<div class='url user username' data-username='" + u.username + "'><img src='" + AP.xthumb(u.gavatar) + "'/></div>";
		});
	};


	this.textAvatar = function (str, size, color, len) {
		if (!len) {
			len = 1;
		}

		if (!size) {
			size = 32;
		}

		if (!color) {
			color = UI.str2int(str);
		}

		var paths = str.split(" ");
		var txt = str.substr(0, len);

		if (paths.length >= 2) {
			txt = paths[0].charAt(0) + paths[1].charAt(0);
		}

		if (len == 1) {
			txt = str[0];
		}


		return "<div class='-tavatar -bg-alt" + color + "' style='line-height: " + size + "px; width: " + size + "px; height: " + size + "px'><span class='-txt'>" + txt + "</span></div>";
	};
};


UI.special = function (title, content, buttons) {
	var html = "<div class='title'>" + title + "</div><div class='content'>" + content + "</div><div class='buttons'></div>";

	$("#canvas-special .main").css({top: -500});
	$("#canvas-special").show();

	$("#canvas-special .main").html(html).animate({top: 100}, 500);
	for (var i = 0; i < buttons.length; i++) {
		var button = buttons[i];
		$("<div class='button button-" + i + " " + button.classes + "'>" + button.label + "<div class='sublabel'>" + button.sublabel + "</div></div>").click(button.action).appendTo("#canvas-special .buttons");
	}
	$("#canvas-special").show();
};

UI.hideSpecial = function () {
	$("#canvas-special .main").animate({top: -500}, 300, function () {
		$("#canvas-special").hide();
	});
};


UI.range = function (start, end, label) {
	var d = [{value: 0, "label": label}];
	if (start < end) {
		for (var i = start; i <= end; i++) {
			d.push({value: i, "label": i});
		}
	} else {
		for (var i = start; i >= end; i--) {
			d.push({value: i, "label": i});
		}
	}
	return d;
};


function icon(icm, size) {
	if (typeof size == 'undefined') {
		size = 16;
	}
	if (icm.indexOf(" ") != -1) {
		return "<span class='ap-f" + size + " normal " + icm + "'></span> &nbsp;";
	} else {
		return "<span class='ap-f" + size + " normal -ap icon-" + icm + "'></span> &nbsp;";
	}
};


function buildDeadlinePicker() {
	var selections = "<div class='tab active' onclick=\"deadlinepicker_pick('asap');\">Due ASAP</div> <div class='tab' onclick=\"deadlinepicker_pick('today');\">Due today</div> <div class='tab' onclick=\"deadlinepicker_pick('tomorrow');\">Due tomorrow</div> <div class='tab' onclick=\"deadlinepicker_pick('weekend');\">Due this weekend</div> <div class='tab' onclick=\"deadlinepicker_pick('custom');\">Choose a custom date and time</div>";


	var hours = [];
	for (var i = 0; i < 12; i++) {
		hours.push({label: i + "am", value: i});
	}

	for (var i = 1; i < 12; i++) {
		hours.push({label: i + "pm", value: i + 12});
	}

	var hour_opts = AP.render(hours, function (e) {
		return "<option value='" + e.value + "'>" + e.label + "</option>";
	});

	var min_opts = AP.render(["00", "05", "10", "15", "20", "25", "30", "35", "40", "45", "50", "55"], function (e) {
		return "<option value='" + e + "'>" + e + "</option>";
	});

	var html = "<div id='deadline-picker'>" +
		"<div class='tabs'><h3>Select deadline</h3>" + selections + "</div> <div class='canvas'></div>" +
		"<div class='custom hidden'><div class='box'>" +
		"	<h1>Choose a specific deadline date/time</h1>" +
		"	<div class='input'><input type='text' class='__date' name='custom-date' value='" + UI.inputTime(AP.time.now()) + "' placeholder='Select date'/></div>" +
		"	<div class='select'>" +
		"		<select name='custom-hour' class='std' style='float:left; width: 100px; margin-right:20px'>" + hour_opts + "</select>" +
		"		<select name='custom-min'  class='std' style='float:left; width: 100px;'>" + min_opts + "</select>" +
		"	</div>" +
		"</div></div>" +
		"<div class='footer'><div class='button -success -circled' onclick='deadlinepicker_callback(this);'>Continue</div></div>" +
		"</div>";


	return html;
};


function deadlinepicker_pick(type, initiate) {
	$("#deadline-picker").data("val", type);

	if (type == "asap") {
		$("#deadline-picker .tabs .tab").setActive(0);
		$("#deadline-picker .canvas").html("<div class='ft'>due <em>today, asap</em></div></div>");
	} else if (type == "today") {
		$("#deadline-picker .tabs .tab").setActive(1);
		$("#deadline-picker .canvas").html("<div class='ft'>due <em>today, 11:59pm</em></div></div>");
	} else if (type == "tomorrow") {
		$("#deadline-picker .tabs .tab").setActive(2);
		$("#deadline-picker .canvas").html("<div class='ft'>due <em>tomorrow, 11:59pm</em></div></div>");
	} else if (type == "weekend") {
		$("#deadline-picker .tabs .tab").setActive(3);
		$("#deadline-picker .canvas").html("<div class='ft'>due <em>this sunday, 11:59pm</em></div></div>");
	} else if (type == "custom") {
		$("#deadline-picker .tabs .tab").setActive(4);
		$("#deadline-picker .custom").show();
	}

	if (initiate || type == "custom") {

	} else {
		deadlinepicker_callback("#deadline-picker");
	}
};


function deadlinepicker_callback(ref) {
	var type = $("#deadline-picker").data("val");
	var date = 0;
	var time = 0;
	if (type == "custom") {
		// AP.alertError("Please pick a custom date and time.");
		var date = $("#deadline-picker input[name=custom-date]").val();
		var hour = $("#deadline-picker select[name=custom-hour]").val();
		var min = $("#deadline-picker select[name=custom-min]").val();

		date = date;
		time = hour + ":" + min;
	} else {

	}

	var fn = $("#deadline-picker").data("callback");
	fn(type, date, time);
	AP.closeDialog(ref);
};


function fiximg(url) {
	if (parseInt(Client.https)) {
		var check = Client.image_url.replace('https://', 'http://');
		if (url && url.indexOf(check) >= 0) {
			url = url.replace('https://', 'http://');
		}

		check = Client.data_url.replace('https://', 'http://');
		if (url && url.indexOf(check) >= 0) {
			url = url.replace('http://', 'https://');
		}
	}

	return url;
};


var summernote_codeblock=function(context){
	var ui = $.summernote.ui;
	
	var button = ui.button({
		contents: "<i class='ficon-code'/>",
		tooltip: 'Insert code block',
		click: function(){
			context.invoke('editor.pasteHTML', '<pre><code>Place your code here</code></pre>');
		}
	});
	
	return button.render();
};





UI.fav=new function __UIFav(){
	this.update=function(url, opts, callback){
		UI.ajaxShow();
		AP.post(url, {id: opts.target.id}, function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			
			if (parseInt(code.added)){
				opts.list.push(code.id);
				opts.list=AP.array.unique(opts.list, function(e, f){
					return parseInt(e)==parseInt(f);
				});
			}else{
				opts.list=AP.array.filter(opts.list, function(e){
					return parseInt(e)!=parseInt(code.id);
				});
			}
			
			callback(parseInt(code.added), opts.list, code);
		})
	};
	
	this.isFav=function(id, list){
		return AP.array.contain(list, id, function(e, f){
			return parseInt(e) == parseInt(f);
		});
	};
};


UI.profile=function(profile){
	return new UIProfile(profile);
};


function UIProfile(profile){
	this.__profile=null;
	if (profile){
		this.__profile=profile;	
	}
	
	this.__body=[];
	this.__buttons=[];
	this.__layout={};
	
	this.body=function(rows){
		this.__body=rows;
		return this;
	};
	
	this.buttons=function(bts){
		this.__buttons=bts;
		return this;
	};
	
	
	this.show=function(opts){
		if (!opts){
			opts={};
		}
		
		opts=$.extend({}, {width: 640, id: AP.uuid()}, opts);
		
		AP.customDialog("<div id='"+opts.id+"' class='js-profile' style='width:"+opts.width+"px; min-height:600px;'><div class='ui-profile'>"+render(this)+"</div></div>").addClass("-full-canvas -full-blank").closable(false).show();
		$("#"+opts.id).data("profile", this);
		
		$("#"+opts.id+" .uip-buttons .btn").click(function(){
			var index=$(this).index();
			var $this=$(this).closest(".js-profile").data("profile");
			if (!$this || !$this.__buttons || $this.__buttons.length<=index){
				return;
			}
			
			var fn=$this.__buttons[index].action;
			fn.apply($this, [this]);
		});
		
		$("#"+opts.id+" .uip-close").click(function(){
			UI.profile().close(this);
		});
	};
	
	
	this.close=function(ref){
		AP.hideCustomDialog();
	};
	
	function render(obj){
		return getHeader(obj)+getBody(obj)+getButtons(obj);
	};
	
	
	function getHeader(obj){
		return "<div class='uip-close'><span class='-ap icon-close'></span></div>" +
		"<div class='uip-header'>" +
			"<div class='uip-image'><img src='"+obj.__profile.image+"'/></div>" +
			"<div class='uip-main'>" +
			"	<div class='uip-name'>"+obj.__profile.name+"</div>" +
			"	<div class='uip-subtitle'>"+obj.__profile.subtitle+"</div>" +
			"	<div class='uip-rows'>"+AP.render(obj.__profile.rows, function(e){
				return getRow(e);
			})+"</div>" +
			"</div>" +
		"</div>";
	};
	
	
	function getBody(obj){
		return "<div class='uip-body'>"+AP.render(obj.__body, function(e){
			return getRow(e);
		})+"</div>";
	};
	
	
	function getButtons(obj){
		return "<div class='uip-buttons'>"+AP.render(obj.__buttons, function(e){
			return "<div class='btn is-"+e.type+"'>"+e.name+"</div>";
		})+"</div>";
	};
	
	
	function getRow(e){
		return "<div class='uip-row'>" +
		"	<div class='uip-icon'><span class='ficon-"+e.icon+"'></span></div>" +
		"	<div class='uip-rn'>"+e.name+"</div>" +
		"	<div class='uip-rc'>"+e.value+"</div>" +
		"</div>";
	};
};


UI.icon=new function __UIIcon(){
	this.picker=function(input, options){
		var tagname=$(input).tagName();
		if (tagname=="div" || tagname=="span"){
			var ic=$(input).data("icon");
			if (!ic && options.value){
				ic=options.value;
			}
			
			renderIcon(input, ic, options.set);
		}
		
		$(input).click(function(){
			var $this=this;
			dialog(options.set, options.range, function(icon){
				if (options.endpoint){
					UI.ajaxShow();
					AP.post(options.endpoint, {icon_icon: icon.index, icon_type: 'icon', icon_set: icon.set}, function(code){
						UI.ajaxHide();
						if (!code.good()){
							return AP.alertError(code.message);
						}
						
						UI.flash("Update successfully");
						renderIcon($this, icon.index, icon.set);
					});
				}
			});
		});
	};

	
	/**
	 * @desc Render an icon within a set
	 */
	function renderIcon(ref, index, set){
		if (index===0 || index==="0"){
			index=1;
		}
		
		var image="<img src='"+(set)+"/"+(index)+".svg'/>";
		$(ref).html(image);
	};
	
	function dialog(base_url, limit, callback, opts){
		opts=$.extend({title: "Please pick an icon"}, opts);
		
		var title="";
		if (opts.title && opts.title.length){
			title="<div class='title'>"+opts.title+"</div>"; 
		}
		
		AP.customDialog(title+"<div class='list list-icons -border'></div>","custom-selection").style("-full icon-picker-list").width(620).show();
		
		
		for (var i=1; i<=limit; i++){
			var e={type: "icon", index: i, set: base_url};
			
			var icon="<div class='-icon'><img src='"+base_url+"/"+i+".svg'/></div>";			
			var html="<div class='li js-item unselectable' onclick='__selfaction(this);'>"+icon+"</div>";
			$(html).appendTo("#custom-selection .list-icons").data("action", callback).data("__params", e);
		}
		
		AP.dialog("#custom-selection").balance();
	};

};


var BaseTable=new function __BaseTable(){
	this.opts={};
	
	this.init=function(canvas, opts){
		opts=$.extend({}, {
			height: "auto",
			header: "fixed",
			footer: "normal",
			fixed_left: ".js-fl",
			fixed_right: ".js-fr",
			sorter: false,
			padding: 10,
			layout: 'table',
			max_rows: 100,
			events: true 
		}, opts);
		
		if (opts.layout=='table'){
			opts.selector={
				header: 'thead',
				body: 'tbody',
				cell: 'td',
				row: 'tr',
				header_cell: 'thead th',
			};
		}else{
			opts.selector={
				header: '.thead',
				body: '.tbody',
				cell: '.td',
				row: '.tr',
				header_cell: '.th',
			};
		}
		
		this.opts=opts;
		
		var $this=$(canvas);
		$this.addClass("js-basetable");
		
		if (opts.layout=="table"){
			$this.addClass("basetable");	
		}
		
		var $p=$this.parent();
		
		if (opts.events){
			$p.addClass("basetable-wrapper scroll-x scroll-y")
		}else{
			$p.addClass("basetable-wrapper")	
		}
		
		
		this.$fls=$this.find(".-fl");
		this.$frs=$this.find(".-fr");
		this.$fhs=null;
		
		var num_cols=$this.find(opts.selector.row).length;
		var auto_position=1;
		if (num_cols>opts.max_rows){
			auto_position=0;
		}
		
		if (mobile() || !opts.events){
			auto_position=false;
		}
		
		if (!auto_position){
			
		}else{
			$p.on("scroll", function(){
				if (mobile()){
					return;
				}
				
				BaseTable.$fhs=$this.find(opts.selector.header);
				
				var t=$p.scrollTop();
				var l=$p.scrollLeft();
				var cw=$p.width();
				
				BaseTable.$fhs.css("top", t);
				
				BaseTable.$fls.each(function(){
					$(this).css("left", l);
					if (l>10){
						$(this).addClass("-fls");
					}else{
						$(this).removeClass("-fls");
					}
				});
				
				BaseTable.$frs.each(function(){
					var ch=$(this).closest(opts.selector.row).height();
					var ew=$(this).width();				
					
					if (opts.layout=="table"){
						$(this).css({"left": cw-ew+l-11-opts.padding*2, height: ch});
					}else{
						$(this).css({"left": cw-ew+l-11-opts.padding*2, height: ch});	
					}
					
				});
			});
		}
		
		
		fixSize($p, opts);
		
		AP.html.resize(function(){
			fixSize($p, opts);
		});
		

		var ws=[];
		$this.find(opts.selector.header_cell).each(function(){
			var hw=$(this).data("width");
			$(this).css("width", hw).css("minWidth", hw).css("maxWidth", hw);
			
			if ($(this).data("search")){
				$(this).append("<div class='bth-wrapper'><div class='bth-search'><input type='text' placeholder='Filter'/></div></div>")
			}
			
			ws.push(hw);
		});
		
		$this.find(opts.selector.header_cell+".-fr").each(function(){
			$(this).css("height", $(this).closest(opts.selector.row).height()).css("marginTop", "1px");
		});
		
		
		var t;
		$this.find(""+(opts.selector.body)+" "+(opts.selector.row)+"").each(function(){
			$(this).addClass("__basetable_done");
			
			t=0;
			$(this).find(opts.selector.cell).each(function(){
				$(this).data("fl", t);
				t+=$(this).data("width");
			});
			
			$(this).find(opts.selector.cell).each(function(){
				var index=$(this).index();
				var width=ws[index];
				
				var flag=$(this).data("width");
				if (flag=="disabled"){
					return;
				}else if (flag!=undefined && AP.data.isInt(flag)){
					$(this).data("width", flag).css("width", flag).css("minWidth", flag).css("maxWidth", flag);
				}else{
					$(this).data("width", width).css("width", width).css("minWidth", width).css("maxWidth", width);	
				}
			});
		});
		
		if (opts.width=="auto"){
		}else{
		}
		
		resetTotalWidth($this);
		
		if (auto_position){
			setTimeout(function(){
				var cw=$p.width();
				BaseTable.$frs.each(function(){
					var ew=$(this).width();
					$(this).css({"left": cw-ew+$p.scrollLeft()-11-opts.padding*2});
				});
			},100);
		}else{
			setTimeout(function(){
				$p.trigger("scroll");
				
				BaseTable.$frs.each(function(){
					$(this).css({right: 0});
				});
			}, 100);
		}
		
		// $p.trigger("scroll");
		
		if (opts.sorter){
			$this.tablesorter({
				sortInitialOrder: "desc"
			});
		}
	};
	
	
	this.balance=function(){
		$(window).resize();
		
		setTimeout(function(){
			$(window).resize();	
		},200);
		
		setTimeout(function(){
			$(window).resize();	
		},500);
	};
	
	
	/**
	 * @desc Set column width
	 */
	this.setColWidth=function($col, width){
		var index=$col.index();
		$col.css({width: width, minWidth: width, maxWidth: width}).data("width", width);
		
		var $table=$col.closest(".js-basetable");
		$table.find(BaseTable.opts.selector.body+" "+BaseTable.opts.selector.row).each(function(){
			$(this).find(BaseTable.opts.selector.cell+":nth-child("+(index+1)+")").data("width", width).css({width: width, minWidth: width, maxWidth: width});
		});
		
		
		resetTotalWidth($col.closest(".js-basetable"));
	};
	
	
	/**
	 * @desc Update a collection of rows (when data changed)
	 */
	this.onUpdate=function(row){
		var t;
		var $p=$(row).closest(".basetable-wrapper");
		var $canvas=$(row).closest(".js-basetable");
		
		
		this.$fls=$canvas.find(".-fl");
		this.$frs=$canvas.find(".-fr");
		
		
		$(row).each(function(){
			if ($(this).hasClass("__basetable_done")){
				return;
			}
			
			$(this).find(BaseTable.opts.selector.cell).each(function(){
				var index=$(this).index();
				var width=$canvas.find(BaseTable.opts.selector.header_cell+":eq("+index+")").data("width");
				$(this).data("width", width).css("width", width).css("minWidth", width);
			});
			
			
			t=$p.scrollTop();
			var l=$p.scrollLeft();
			
			$(this).find(BaseTable.opts.selector.header).css("top", t);
			
			$(this).find(".-fl").each(function(){
				$(this).css("left", l);
				if (l>10){
					$(this).addClass("-fls");
				}else{
					$(this).removeClass("-fls");
				}
			});
			
			$(this).find(".-fr").each(function(){
				$(this).css("left", $p.width()-$(this).width()+l-11-BaseTable.opts.padding*2);
			});
		});
	};
	
	
	/**
	 * @desc Alias
	 */
	this.update=this.onUpdate;
	
	
	function fixSize($p, opts){
		if (opts.width && opts.width=="auto"){
			
		}else{
			$p.css("width", $p.parent().width());	
		}
		
		if (opts.height && opts.height=="auto"){
		}else{
			if (opts.height && AP.data.isFunction(opts.height)){
				$p.css("height", opts.height($p));
			}else{
				$p.css("height", $(window).height()-90);	
			}	
		}
	};
	
	
	
	function resetTotalWidth($this){
		var total_width=0;
		$this.find(BaseTable.opts.selector.header_cell).each(function(){
			total_width+=$(this).data("width");
		});
		
		if (BaseTable.opts.selector.layout!="table"){
			$this.css("width", total_width+1);
		}else{
			$this.css("width", t).addClass("xo");	
		}
	};
};


var UIPag = new function __UIPagination() {
	this.callback_fn = null;
	this.contPaginate = function (canvas, url, last_id, per_page, loaded_items, callback) {
		this.callback_fn = callback;

		if (!url) {
			url = Client.path.current;
			var cpath = Client.path.full.join("/");
			var cqs = "";

			var qs = Query.all();
			for (var key in qs) {
				if (key == "env" || key == "last_id") {
					continue;
				}
				cqs += key + "=" + qs[key] + "&";
			}

			if (cqs.length) {
				cqs = cqs.substr(0, cqs.length - 1);
			}

			if (cpath.indexOf("?") == -1) {
				url = cpath + "?" + cqs;
			} else {
				url = cpath + "&" + cqs;
			}
		}
		
		$.log(url);

		var load_more_url = url;

		var more_class = "-more";
		if (loaded_items < per_page) {
			more_class = "";
			return;
		}


		var html = "<div class='icons pointer "+(more_class)+"' data-url='"+(load_more_url)+"' data-last_id='"+(last_id)+"' data-per_page='"+(per_page)+"'><div class='label box-main-edge'>Load more</div></div>";

		$(canvas).addClass("apppages").html(html);

		$(canvas).find('.-more').click(function() {
			AP.post($(this).data('url'), {last_id: $(this).data('last_id'), per_page: $(this).data('per_page')}, function(code) {
				if (!code.good()) {
					return AP.alertError(code.message);
				}

				if (UIPag.callback_fn) {
					return UIPag.callback_fn(code.data);
				};
			}, function (err) {
				$.log(err);
			});
		});
	};
};


function ActionManager(opts){
	if (!opts){
		opts={};
	}
	this.opts=$.extend({icon: true}, opts);
	this.actions=[];
	
	this.add=function(action){
		this.actions.push(action);
	};
	
	this.inline=function(){
		return AP.render(this.actions, function(action){
			if (action=="sep" || action=="---"){
				return "<div class='-item-sep'></div>";
			}
			var ec="";
			if (action.style){
				ec=" "+action.style;
			}
			return "<div class='-item url"+(ec)+"' data-url='"+(action.url)+"'>"+(action.label)+"</div>";
		});
	};
	
	this.context=function(){
		return this.actions;
	};
	
	this.length=function(){
		return this.actions.length;
	};
	
	this.text=this.inline;
};
UI.file=new function __UIFile(){
	this.ext=function(file){
		var ext="unknown";
		
		if (!file){
			return ext;
		}
		
		data=file.split(".");
		
		if (!data.length){
			return ext;
		}
		
		return data[data.length-1].toLowerCase();
	}
	
	this.icon=function(file){
		var ext="text2";
		
		if (!file){
			return ext;
		}
		
		data=file.split(".");
		var fext="";
		
		if (!data.length){
			return ext;
		}
		fext=data[data.length-1]; 
		fext=fext.toLowerCase();
		if (fext=="jpeg"){
			fext="jpg";
		}

		if (fext == "xls" || fext == "xlsx" || fext == "gsheet" || fext == "xlsm") {
			ext = "excel";
		} else if (fext == "gif" || fext == "png" || fext == "jpg" || fext == "ai" || fext == "svg" || fext == "psd" || fext == "jpeg") {
			ext = fext;
		} else if (fext == "doc" || fext == "docx" || fext == "gdoc") {
			ext = "word";
		} else if (fext == "ppt" || fext == "pptx" || fext == "gslides") {
			ext = "ppt";
		} else if (fext == "pdf") {
			ext = "pdf";
		} else if (fext == "zip") {
			ext = "zip";
		}
		

		if (["mp4","avi", "css", "csv", "fla", "svg", "eps", "js", "xml", "html"].indexOf(fext)!=-1){
			return fext;
		}
		
		return ext;
	};
	
	
	
	this.fontIcon=function(file){
		var ext="libreoffice";
		
		if (!file){
			return ext;
		}
		
		data=file.split(".");
		var fext="";
		
		if (!data.length){
			return ext;
		}
		fext=data[data.length-1]; 
		fext=fext.toLowerCase();
		if (fext=="jpeg"){
			fext="jpg";
		}
		
		if (fext=="xls" || fext=="xlsx" || fext=="gsheet"){
			ext="file-excel";
		}else if (fext=="gif" || fext=="png" || fext=="jpg" || fext=="psd" || fext=="svg" || fext=="ai" || fext=="jpeg"){
			ext="file-picture";
		}else if (fext=="doc" || fext=="docx" || fext=="gdoc"){
			ext="file-word";
		}else if (fext=="ppt" || fext=="pptx" || fext=="gslides"){
			ext="file-play";
		}else if (fext=="pdf"){
			ext="file-pdf";
		}else if (fext=="zip"){
			ext="file-zip";
		}
		
		return ext;
	};
	
	this.ficon=this.fontIcon;
	
	this.color=function(ext){
		if (ext=='excel'){
			return "3";
		}
		
		if (ext=='ppt'){
			return "2";
		}
		
		if (ext=='word'){
			return "8";
		}
		
		if (ext=='pdf' || ext=='pdfx'){
			return "5";
		}
		
		if (ext=='gif' || ext=='png' || ext=='jpg' || ext=="picture" || ext=="jpeg"){
			return "7";
		}
		
		return 2;
	};
	
	this.kb=function(size){
		var kb=Math.floor(size/1024);
		if (kb==0){
			return size+" B";
		}
		
		if (kb<1000){
			return kb+" KB";
		}
		
		return (kb/1024).toFixed(2)+" MB";
	};
	
	
	this.iconColor=function(icon){		
		if (icon=="pdf" || icon=="file-pdf"){
			return "#e73035";
		}
		
		if (icon=="xls" || icon=="xlsx" || icon=="file-xls" || icon=="file-xlsx" || icon=="file-excel"){
			return "#41b433";
		}
		
		if (icon=="ppt" || icon=="pptx" || icon=="file-ppt" || icon=="file-pptx" || icon=="file-play"){
			return "#d45a18";
		}
		
		
		if (icon=="doc" || icon=="docx" || icon=="file-doc" || icon=="file-docx" || icon=="file-word" || icon=="file-office"){
			return "#0662b0";
		}
		
		if (icon=="png" || icon=="jpg" || icon=="jpeg" || icon=="file-png" || icon=="file-jpg"){
			return "#f49402";
		}
		
		return "#666";
	};
	
	
	
	/**
	 * @desc Get HTML of a list of files
	 */
	this.list=function(files, opts){
		return AP.render(files, function(e){
			var icon=UI.file.icon(e.fid);
			
			var actions="<span class='file-actions'> <span class='file-action js-file-preview url' title='Preview' data-fid='"+(e.id)+"' data-url=':file' data-file='"+(e.url)+"'>Preview</span> <a class='file-action' title='Download file' target='_blank' href='"+(Base.file.download(e.name, e.fid))+"'>Download</a> <span class='file-action js-file-remove' title='Delete' data-fid='"+(e.id)+"'>Remove</span> </span>";
			
			return "<div class='file -file pointer'> <span class='file-icon'><img src='"+(Client.share_url)+"/mimex/"+(icon)+".png'/></span> <span class='file-name' data-file='"+(e.url)+"'>"+(e.name)+"</span> <span class='file-info'>"+(UI.file.kb(e.size))+" &middot; Uploaded "+(AP.time.ago(e.since))+" by @"+(e.username)+"</span> "+(actions)+" </div>";
		})
	};
	
	
	/**
	 * @desc Get HTML of a list of files
	 */
	this.listCompact=function(files, opts){
		return AP.render(files, function(e){
			var icon=UI.file.ext(e.fid);
			
			return "<div class='file -file pointer url' data-fid='"+(e.id)+"' data-url=':file' data-file='"+(e.url)+"'> <span class='file-icon'><img src='"+(Client.share_url)+"/m4/"+(icon)+".svg'/></span> <span class='file-name ap-xdot'>"+(e.name)+"</span> </div>";
		})
	};
};UI.reorder=function(data, endpoint){
	return (new UIFloatRearrangements(data, endpoint)).show();
};



UI.selection=function(data, endpoint){
	return (new UIFloatSelections(data, endpoint)).show();
};




function UIFloatSelections(data, endpoint){
	this.canvas="#float-opts";
	this.box="#float-box";
	
	
	this.show=function(){
		build_html(data);
		return this;
	};
	
	this.callback=function(callback){
		$(this.canvas).data("callback", callback);
	};
	
	function build_html(data){
		var options=data;		
		var html=get_options_html(options);
		var mh=$(window).height()-250;
		if (mh<500){
			mh=500;
		}
		html="<div style='max-height:"+mh+"px; overflow-y:auto;'>"+html+"</div>";
		
		html+="<div class='back pointer' onclick='ui_options_hide(this);'><span class='icon -ap icon-arrow-left2'></span> OK</div>";
		
		html="<div id='float-box'>"+html+"</div>";
		
		var dx=AP.dialog("#float-opts")
		.engine(FormDialogEngine)
		.closable()
		.style("float-opts")
		.width(600)
		.title("Please select")
		.content(html)
		.show()
		;
		
		$("#float-opts").data('endpoint', endpoint);
		
		return dx;
	};
	
	
	function get_options_html(options){
		var html="";
		for (var i=0; i<options.length; i++){
			var opt=options[i];
			
			var icon="<span class='-ap icon-square-uncheck ap-f24 text-9'></span>";
			if (parseInt(opt.selected)){
				icon="<span class='-ap icon-square-check ap-f24 text-success selected'></span>";
			}
			html+="<div class='opt with-icon' data-value='"+opt.id+"'>" +
				"<div class='updown pointer' style='top:15px;' onclick='ui_options_pick(this)'>"+icon+"</div>"+
				"<div class='label'>"+opt.label+"</div>" +
				(opt.sublabel?"<div class='sublabel'>"+opt.sublabel+"</div>":"") +
			"</div>";
		};
		
		return html;
	};
	
	
};



function UIFloatRearrangements(data, endpoint){
	this.canvas="#float-opts";
	this.box="#float-box";
	
	
	this.show=function(){
		build_html(data);
		return this;
	};
	
	this.callback=function(callback){
		$(this.canvas).data("callback", callback);
	};
	
	function build_html(data){
		var options=data;		
		var html=get_options_html(options);
		var mh=$(window).height()-250;
		if (mh<500){
			mh=500;
		}
		html="<div style='max-height:"+mh+"px; overflow-y:auto;'>"+html+"</div>";
		
		html+="<div class='back pointer' onclick='ui_options_hide(this);'><span class='icon -ap icon-arrow-left2'></span> OK</div>";
		
		html="<div id='float-box'>"+html+"</div>";
		
		var dx=AP.dialog("#float-opts")
		.engine(FormDialogEngine)
		.closable()
		.style("float-opts")
		.width(600)
		.title("Please select")
		.content(html)
		.show()
		;
		
		$("#float-opts").data('endpoint', endpoint);
		
		return dx;
	};
	
	
	function get_options_html(options){
		var html="";
		for (var i=0; i<options.length; i++){
			var opt=options[i];
			
			html+="<div class='opt with-icon' data-value='"+opt.id+"'>" +
				"<div class='updown'><div class='up' onclick='ui_arrange_move(this, -1);'><span class='ficon-caret-up'></span></div> <div class='down' onclick='ui_arrange_move(this, 1);'><span class='ficon-caret-down'></span></div> </div>"+
				"<div class='label'>"+opt.label+"</div>" +
				(opt.sublabel?"<div class='sublabel'>"+opt.sublabel+"</div>":"") +
			"</div>";
		};
		
		return html;
	};
	
	
};



function ui_arrange_move(ref, order){
	var $elem=$(ref).closest('.opt');
	if (!$elem.length){
		return;
	}
	
	var val=$elem.data("value");
	var url=$("#float-opts").data("endpoint");
	var callback=$("#float-opts").data("callback");
	
	if (order==-1){
		var $prev=$elem.prev('.opt');
		if (!$prev.length){
			return;
		}
		
		$elem.slideUp(400, function(){
			$(this).insertBefore($prev).slideDown(400);
		});
		
		ui_arrange_save(url, val, -1, callback);
	}else if (order==1){
		var $next=$elem.next('.opt');
		if (!$next.length){
			return;
		}
		
		$elem.slideUp(400, function(){
			$(this).insertAfter($next).slideDown(400);
		});
		
		ui_arrange_save(url, val, 1, callback);
	};
};


function ui_arrange_save(url, val, ord, callback){
	UI.ajaxShow();
	AP.post(url, {id: val, order: ord}, function(code){
		UI.ajaxHide();
		if (!code.good()){
			return AP.alertError("Oops .. something wrong. The last action was not saved.");
		}
		
		callback(val, ord, code);
	});
};


function ui_options_pick(ref, order){
	var $elem=$(ref).closest('.opt');
	if (!$elem.length){
		return;
	}
	
	var selected=$elem.find(".selected").length;
	var value=0;
	
	if (selected){
		value=0;
	}else{
		value=1;
	}
	
	
	var url=$("#float-opts").data("endpoint");
	var name=$elem.data("value");
	var callback=$("#float-opts").data("callback");
	
	UI.ajaxShow();
	AP.post(url, {id: name, value: value}, function(code){
		UI.ajaxHide();
		if (!code.good()){
			return AP.alertError("Oops .. something wrong. The last action was not saved.");
		}
		
		if (value==0){
			$elem.find(".updown").html("<span class='-ap icon-square-uncheck ap-f24 text-9'></span>");
		}else{
			$elem.find(".updown").html("<span class='-ap icon-square-check ap-f24 text-success'></span>");
		}
		
		callback(name, value, code);
	});
}UI.percent=new function __UIPercent(){
	this.colors=["FF6666","D57766","AA8866","55AA66","2BBB66","00CC66"];
	
	this.text=function(percent){
		var p=parseInt(percent);
		var c=getColor(p);
		return "<span style='color:#"+c+"'>"+percent+"%</span>";
	};
	
	
	this.box=function(percent){
		var p=parseInt(percent);
		var c=getColor(p);		
		return "<div class='-pbox' style='background-color:#"+c+"'><em>"+percent+"<span class='symbol'>%</span></em></div>";
	};
	
	this.color=function(p){
		return getColor(parseInt(p));
	};
	
	function getColor(p){
		var c=UI.percent.colors[0];
		
		if (p>=100){
			c=UI.percent.colors[6];
		}else if (p>=80){
			c=UI.percent.colors[5];
		}else if (p>=60){
			c=UI.percent.colors[4];
		}else if (p>=40){
			c=UI.percent.colors[3];
		}else if (p>=20){
			c=UI.percent.colors[2];
		}else if (p>=10){
			c=UI.percent.colors[1];
		}else{
			c=UI.percent.colors[0];
		}
		
		return c;
	};
};



UI.countdown=function(canvas){
	setInterval(function(){
		var collection=[];
		$(canvas).each(function(){
			var timer=$(this).data("timer");
			var alarm=$(this).data("alarm");
			if (!alarm){
				alarm=3600;
			}
			
			collection.push({timer: parseInt(timer), elem: $(this), alarm: parseInt(alarm)})
		});
		
		var time=AP.time.now();
		for (var i=0; i<collection.length; i++){
			var item=collection[i];
			var rem=item.timer-time;
			if (rem<0){
				item.elem.html("00:00:00").addClass('red');
			}else{
				var s=rem%60;
				var m=((rem-s)/60)%60;
				var h=Math.floor(rem/3600);
				var d=Math.floor(h/24);
				h=h%24;
				
				if (d==0){
					if (rem < item.alarm){
						item.elem.html(AP.data.zeroPrefix(h)+":"+AP.data.zeroPrefix(m)+":"+AP.data.zeroPrefix(s)).addClass("red").addClass("anim-showhide-inf");
					}else{
						item.elem.html(AP.data.zeroPrefix(h)+":"+AP.data.zeroPrefix(m)+":"+AP.data.zeroPrefix(s));
					}
						
				}else{
					item.elem.html(AP.data.zeroPrefix(d)+"d "+AP.data.zeroPrefix(h)+"h");
				}
			}
		}
	},500);
};




UI.liveCountdown=function(selector_string, show_full, format){
	function getFormatedString(format, d, h, m, s){
		return format.replace("%d", d).replace("%h", h).replace("%m", m).replace("%s", s);
	};
	
	AP.rtimeout(function(){
		var time=AP.time.now();
		$(selector_string).each(function(){
			var $item=$(this);
			var is_smart=$item.data("smart");
			var timer=parseInt($item.data('timer'));
			var ended=$item.data("ended");
			if (!ended){
				ended="00:00:00";
			}
			
			var rem=timer-time;
			
			if (rem<0){
				$item.html(ended).addClass('red').addClass("-ended");
			}else{
				var s=rem%60;
				var m=((rem-s)/60)%60;
				var h=Math.floor(rem/3600);
				var d=Math.floor(h/24);
				h=h%24;
				
				if (is_smart){
					if (d==0 || d==1){
						if (h==0 && d==0){
							$item.html("00:"+AP.data.zeroPrefix(m)+":"+AP.data.zeroPrefix(s));
							if (!$item.hasClass("red")){
								$item.addClass("red").addClass("anim-showhide-inf");
							}
						}else{
							h=h+d*24;
							$item.html(AP.data.zeroPrefix(h)+":"+AP.data.zeroPrefix(m)+":"+AP.data.zeroPrefix(s));
						}
					}else{
						$item.html(AP.time.time("%M %d", timer));
					}
				}else{
					if (d==0){
						if (h==0){
							$item.html("00:"+AP.data.zeroPrefix(m)+":"+AP.data.zeroPrefix(s));
							if (!$item.hasClass("red")){
								$item.addClass("red").addClass("anim-showhide-inf");
							}
						}else{
							$item.html(AP.data.zeroPrefix(h)+":"+AP.data.zeroPrefix(m)+":"+AP.data.zeroPrefix(s));
						}
					}else{
						if (show_full){
							if (format){
								$item.html(getFormatedString(format, AP.data.zeroPrefix(d), AP.data.zeroPrefix(h), AP.data.zeroPrefix(m), AP.data.zeroPrefix(s)));
							}else{
								$item.html(AP.data.zeroPrefix(d)+"d "+AP.data.zeroPrefix(h)+"h"+" "+AP.data.zeroPrefix(m)+"m "+AP.data.zeroPrefix(s)+"s");	
							}
						}else{
							$item.html(AP.data.zeroPrefix(d)+"d "+AP.data.zeroPrefix(h)+"h");	
						}
					}
				}
			}
		});
	},1000);
};


UI.pageCountdown=function(selector_string, show_full){
	return UI.liveCountdown(selector_string, show_full);
};


UI.listToUsernames=function(users){
	if (!users.length){
		return "";
	}
	return AP.render(users, function(u, index, total){
		if (total<=1){
			return "@<b class='url username'>"+u.username+"</b>";
		}else{
			if (index==total-1){
				return "and @<b>"+u.username+"</b>";
			}else if (index<total-2){
				return "@<b class='url username'>"+u.username+"</b>, ";
			}else{
				return "@<b class='url username'>"+u.username+"</b> ";
			}
		}
	});
};


UI.objectsToUsernames=function(users, pattern){
	if (!users || !users.length){
		return "";
	}
	
	return AP.word.join(users, " ",function(u){
		if (AP.data.isString(u)){
			if (!pattern){
				return "@"+u;	
			}else{
				return pattern.replace("$",u);
			}
		}else{
			if (!pattern){
				return "@"+u.username;
			}else{
				return pattern.replace("$",u.username);
			}
		}
	});
};



UI.prettyNames=function(users){
	if (!users.length){
		return "";
	}
	return AP.render(users, function(u, index, total){
		if (total<=1){
			return "@<b class='url username'>"+u+"</b>";
		}else{
			if (index==total-1){
				return "and @<b>"+u+"</b>";
			}else if (index<total-2){
				return "@<b class='url username'>"+u+"</b>, ";
			}else{
				return "@<b class='url username'>"+u+"</b> ";
			}
		}
	});
};


UI.users=function(users, size){
	if (!size){
		size=32;
	}
	return AP.render(users, function(u){
		return "<div data-username='"+u.username+"' class='url avatar avatar-"+size+" rounded'><div class='image'><img src='"+u.gavatar+"'/></div></div>";
	});
};








UI.popUsers=function(url){
	return new PUsers(url);
};



function PUsers(url){
	this.__url=url;
	this.__data={};
	this.__render=null;
	this.__title="";
	this.__title2="";
	
	this.title=function(t1, t2){
		this.__title=t1;
		this.__title2=t2;
		return this;
	}
	
	this.data=function(data){
		this.__data=data;
		return this;
	};
	
	this.render=function(render){
		this.__render=render;
		return this;
	};
	
	this.show=function(){
		var $this=this;
		AP.post(this.__url,this.__data, function(code){
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			var html=AP.render(code.users, function(u){
				return $this.__render(u);
			});
			
			html="<div class='list users-list'>"+html+"</div>";
			
			// Float dialog
			
			AP.dialog("users-dialog")
			.engine(FormDialogEngine2)
			.width(600)
			.title("<div class='title-1'>"+$this.__title+"</div><div class='title-2'>"+$this.__title2+"</div>")
			.content(html)
			.style("fs")
			.show();
			
			
		});
	};
};














UI.optionscb=null;

UI.options=function(data, callback){
	UI.optionscb=callback;
	return (new UIFloatOptions(data, callback));
};


function UIFloatOptions(data, callback){
	this.canvas="#float-opts";
	this.box="#float-box";
	$(this.canvas).data('callback', callback);
	
	this.show=function(){
		build_html(data);
		$(this.box+" .other .input-type-date").selectDate();
		$(this.box+" .other .input-type-time").selectTime({align: 'bottom'});
		return this;
	};
	
	
	function build_html(data){
		var options=data.options;
		var other=data.other;
		
		var html=get_options_html(options);
		if (other){
			html+=get_other_html(other);
		}
		
		if (data.back){
			html+="<div class='back pointer' onclick='ui_options_hide(this);'><span class='icon ficon-angle-left'></span> Back</div>";
		}
		
		html="<div id='float-box'>"+html+"</div>";
		
		var dx=AP.dialog("#float-opts")
		.engine(FormDialogEngine)
		.style("float-opts")
		.width(data.width)
		.title("Please select")
		.content(html)
		.show();
		
		$("#float-opts").data("options", options);
		
		return dx;
	};
	
	
	function get_options_html(options){
		var html="";
		for (var i=0; i<options.length; i++){
			var opt=options[i];
			
			html+="<div class='opt pointer"+(opt.icon?" with-icon":"")+"' onclick='ui_options_select(this);' data-value='"+opt.value+"'>" +
				(opt.icon?"<div class='icon'><div class='"+opt.icon+"'></div></div>":"") +
				"<div class='label'>"+opt.label+"</div>" +
				"<div class='ir'><span class='ficon-angle-right'></span></div>"+
				(opt.sublabel?"<div class='sublabel'>"+opt.sublabel+"</div>":"") +
			"</div>";
		};
		
		return html;
	};
	
	function get_other_html(other){
		var inputs="";
		for (var i=0; i<other.inputs.length; i++){
			var input=other.inputs[i];
			var w=Math.floor(80/other.inputs.length);
			inputs+="<div class='input left relative' style='width:"+w+"%'><div class='inputw'><input type='text' name='"+input.name+"' class='std input-type-"+input.type+"' placeholder='"+input.placeholder+"'/></div></div>";
		}
		
		inputs="<div class='inputs'>"+inputs+" <div class='ok right button button-edge success' onclick='ui_options_select_extra(this);'>OK</div> <div class='clear'></div></div>";
		
		var html="<div class='other opt'>" +
			"<div class='label'>"+other.label+"</div>" +
			inputs+
		"</div>";
		
		return html;
	};
};

function ui_options_hide(ref){
	AP.dialog("#float-opts").hide();
};

function ui_options_select(ref){
	var val=$(ref).data("value");
	var options=$("#float-opts").data("options");
	AP.dialog("#float-opts").hide();
	
	for (var i=0; i<options.length; i++){
		if (options[i].value==val){
			ui_options_callback(options[i], null);
			return;
		}
	}
};


function ui_options_select_extra(ref){
	var data={};
	AP.dialog("#float-opts").hide();
	$("#float-opts .other input").each(function(){
		var name=$(this).attr('name');
		var val=$(this).val();
		data[name]=val;
	});
	
	ui_options_callback({value: "other", "label":"Other", data: data});
};


function ui_options_callback(data){
	var callback=UI.optionscb;

	if (callback){
		callback(data);
	};
};







UI.user=new function __UIUser(){
	this.list=function(title, users){
		var html=AP.render(users, function(u){
			return simple(u);
		});
		
		var mh=$(window).height()-200;
		if (mh<200){
			mh=200;
		}
		
		html="<div class='title'>"+title+"<div class='-close' onclick='AP.closeDialog(this);'></div></div>" +
				"<div class='rh' style='max-height:"+mh+"px; overflow-y:auto;'><div class='list list-actions with-image -border'>"+html+"</div></div>";
		
		AP.customDialog(html,"custom-selection").style("-full").width(500).show();
		$("#custom-selection").addClass("__canvas");
	};
	
	
	this.listCompact=function(users, opts){
		opts=$.extend({}, {limit: 0}, opts);
		
		var html=AP.render(users, function(uid, index){
			if (opts.limit && index>=opts.limit){
				return "";
			}
			
			var u;
			
			if (AP.data.isObject(uid)){
				u=People.get(uid.username);
				if (!u.id || u.error){
					return "";
				}	
			}else{
				u=People.get(uid);
			}
			
			
			return "<div class='user url' title='"+(u.name)+"' data-username='"+(u.username)+"'> <div class='avatar avatar-32'><img src='"+(AP.thumb(u.gavatar))+"'></div> <div class='name'>"+(u.name)+"</div> <div class='info'>"+(u.title)+"&nbsp;</div> </div>";
		});
		
		if (opts.limit && users.length>opts.limit){
			html+="<div class='more'>+"+(users.length-opts.limit)+"</div>";
		}
		
		return html;
	};
	
	
	
	
	/**
	 * @desc User pickers, from dialogs
	 */
	this.picker=function(opts){
		opts=$.extend({multi: 1, ignore_me: 0}, opts);
		if (!opts.multi){
			opts.multi=0;
		}else{
			opts.multi=1;
		}
		
		Online.reorder(Client.people);
		var html=AP.render(Client.people, function(u){
			if (opts.ignore_me && parseInt(u.id)==parseInt(Client.viewer.id)){
				return "";
			}
			return render(u, opts.multi);
		});
		
		var mh=$(window).height()-270;
		if (mh<200){
			mh=200;
		}
		
		html="<div class='title'>"+(opts.title)+" <div class='-close' onclick='AP.closeDialog(this);'></div> </div> <div class='isearch'><input type='text' id='float-people-filter-ip' placeholder='Type here to quickly filter people'/></div> <div class='rh' style='max-height:"+(mh)+"px; min-height:150px; overflow-y:auto;'> <div class='list list-actions with-image -border'>"+(html)+"</div> </div>";
		
		if (opts.multi){
			html+="<div class='buttons -two'> <div class='button -first -passive-2 -rounded' onclick='AP.closeDialog(this);'>Cancel</div> <div class='button -second -success -rounded' onclick='__pickUserCallback(this); AP.closeDialog(this);'>OK</div> </div>";	
		}
		
		AP.customDialog(html,"custom-selection").style("-full").width(500).show();
		
		$("#custom-selection").data("callback", opts.callback).addClass("__canvas");
		
		$("#float-people-filter-ip").autofocus().on("input", function(){
			var q=$(this).val();
			UI.user.filter(q);
		});
	};
	
	
	this.pick=function(title, callback, ignore_me){
		Online.reorder(Client.people);
		var html=AP.render(Client.people, function(u){
			if (ignore_me && parseInt(u.id)==parseInt(Client.viewer.id)){
				return "";
			}
			return render(u);
		});
		
		var mh=$(window).height()-270;
		if (mh<200){
			mh=200;
		}
		
		html="<div class='title'>"+title+"<div class='-close' onclick='AP.closeDialog(this);'></div></div>" +
				"<div class='isearch'><input type='text' id='float-people-filter-ip' placeholder='Type here to quickly filter people'/></div>" +
				"<div class='rh' style='max-height:"+mh+"px; min-height:150px; overflow-y:auto;'><div class='list list-actions with-image -border'>"+html+"</div></div>";
		
		html+="<div class='buttons -two'> <div class='button -first -passive-2 -rounded' onclick='AP.closeDialog(this);'>Cancel</div> <div class='button -second -success -rounded' onclick='__pickUserCallback(this); AP.closeDialog(this);'>OK</div> </div>";
		
		AP.customDialog(html,"custom-selection").style("-full").width(500).show();
		
		$("#custom-selection").data("callback", callback).addClass("__canvas");
		
		$("#float-people-filter-ip").autofocus().on("input", function(){
			var q=$(this).val();
			UI.user.filter(q);
		});
	};
	
	
	
	
	this.menu=function(ref, username){
		var user=__getUserByUsername(username);
		var profile=null;
		
		if (user){
			profile={type: 'html', html:"<div class='-profile -with-image' data-uid='"+user.id+"'><div class='avatar avatar-40 -rounded'><div class='image url' data-url=':zoom' data-image='"+user.gavatar+"'><img src='"+AP.xthumb(user.gavatar)+"'/></div></div>" +
				"<div class='-text'>" +
					"<p class='-big'>"+user.name+"</p>" +
					"<p>@"+user.username+" &middot; "+___(user.title, "<i>No official title</i>")+"</p>" +
					"<p>"+___(user.phone, "<i>Phone number was not provided</i>")+"</p>" +
				"</div>"+
			"</div>"};	
		}else{
			return "";
		}
		
		var menu_items=[
			profile,
			{label: 'Xem profile', 'icon': 'icon-forward icm', action: function(){
   				AP.toURL(Base.domain("account")+"/user/"+username)
   			}},
			{label: 'Chat với <b>'+user.name+'</b>', 'icon': 'icon-comment icm', action: function(){
				Base.message.peer(user.id, {'from': 'context'});
				Context.hide();
			}}
		];	
		
		if (username==Client.viewer.username){
			menu_items= [
				profile,
				{label: 'View my profile', 'icon': 'icon-forward icm', action: function(){
					AP.toURL(Base.domain("account")+"/account")
				}},
			];
		}
		
		var data=$(ref).data("context.items");
		if (data && data.length){
			for (var i=0; i<data.length; i++){
				if (!data[i].icon){
					data[i].icon="icon-triangle-right";
				}
				menu_items.push(data[i]);
			}
		}
		
		return Context.menu(ref, {top: 24, left:20, menu: menu_items});
	};
	
	
	this.filter=function(q){
		if (q==":online"){
			$("#custom-selection  .li").each(function(){
				if ($(this).find(".avatar.-online").length){
					$(this).show();
				}else{
					$(this).hide();
				}
			});
		}else{
			$("#custom-selection  .li").each(function(){
				var matched=false;
				if (!q || !q.length){
					matched=true;
				}else{
					q=q.toLowerCase();
					var username="@"+$(this).find(".sub").text().toLowerCase();
					var name=$(this).find("b").text().toLowerCase();
					
					if (username.indexOf(q)>=0 || name.indexOf(q)>=0){
						matched=true;
					}
				}
				
				if (matched){
					$(this).show();
				}else{
					$(this).hide();
				}
			});
		}
	};
	
	
	this.avatars=function(usernames){
		return AP.render(usernames, function(e){
			var u=People.get(e);
			if (!u.id || !parseInt(u.id)){
				return "";
			}
			
			return "<div class='user url' title='"+(u.name)+"' data-username='"+(u.username)+"'> <div class='avatar avatar-32'><img src='"+(AP.thumb(u.gavatar))+"'></div> </div>";
		});
	};
	
	
	this.show=function(users){
		return AP.render(users, function(e){
			var u=People.get(e);
			if (!u.id || !parseInt(u.uid)){
				return "";
			}
			
			return "<div class='user url' title='"+(u.name)+"' data-username='"+(u.username)+"'> <div class='avatar avatar-32'><img src='"+(AP.thumb(u.gavatar))+"'></div> <div class='name'>"+(u.name)+"</div> <div class='info'>"+(u.title)+"&nbsp;</div> </div>";
		});
	}
	
	
	
	function render(user, is_multi){
		return "<div class='li item unselectable' data-multi='"+is_multi+"' data-user-id='"+user.id+"' onclick='__selectUser(this);'>" +
			"<div class='image'><div class='avatar "+(user.online?" -online":"")+"'><img src='"+AP.xthumb(user.gavatar)+"'/></div></div> <b>"+user.name+"</b><div class='sub'>@"+user.username+"</div>" +
			"<div class='-ricon'><span class='-select'></span></div>"+
		"</div>";
	}
	
	
	function simple(user){
		var sub=user.title;
		if (!user.title){
			sub="No job title";
		}
		return "<div class='li item unselectable url"+(sub.length?'':' -no-info')+"' data-username='@"+(user.username)+"'> <div class='image'><div class='avatar "+(user.online?' -online':'')+"'> <img src='"+(AP.xthumb(user.gavatar))+"'/> </div></div> <b>"+(user.name)+"</b> <div class='sub'>@"+(user.username)+" &middot; "+(sub)+"</div> <div class='-ricon'><span class='ficon-angle-right'></span></div> </div>";
	}
};
	

function __selectUser(ref){
	var id=$(ref).data("user_id");
	$(ref).toggleClass("selected");
	
	if ($(ref).data("multi")==0 && $(ref).hasClass("selected")){
		__pickUserCallback(ref);
	}
};



function __pickUserCallback(ref){
	var $canvas=$(ref).closest(".__canvas");
	var selected=[];
	
	$canvas.find(".li.item").each(function(){
		var id=$(this).data("user-id");
		if ($(this).hasClass("selected")){
			selected.push(id);
		}
	});
	
	AP.closeDialog(ref);	
	var fn=$canvas.data("callback");
	return fn(selected);
};



function ticon(name, size, color){
	name=name.toUpperCase();
	if (!size){
		size=32;
	}
	
	if (!color || color=="auto"){
		color=UI.str2int(name+"ab");
	};
	
	var txt=name.substr(0,2).toUpperCase();
	
	return "<div class='tavatar tavatar-"+size+" -bg-alt"+color+"'>"+txt+"</div>";
};UI.link=new function __UILink(){
	
	this.domain=function(url){
		 var domain;
	    //find & remove protocol (http, ftp, etc.) and get domain
	    if (url.indexOf("://") > -1) {
	        domain = url.split('/')[2];
	    }
	    else {
	        domain = url.split('/')[0];
	    }

	    //find & remove port number
	    domain = domain.split(':')[0];

	    return domain;
	};
	
};UI.setting=function __UISetting(title){
	return new UISetting(title);
};


function UISetting(title){
	this.options=[];
	this.title=title;
	this.__callback=null;
	
	this.add=function(opts){
		this.options.push(new UISettingOption(opts));
		return this;
	};
	
	this.callback=function(cb){
		for (var i=0; i<this.options.length; i++){
			this.options[i].callback=cb;
		}
		
		this.__callback=cb;
		return this;
	};
	
	this.show=function(canvas, callback){
		if (!callback) {
			callback = null;
		}
		
		if (canvas && canvas.length){
			return this.showInline(canvas, this.options);
		}else{
			if (!callback && this.__callback){
				callback=this.__callback;
			}
		}
		
		var html="<div class='title'>"+this.title+" <div class='close -close' onclick='AP.closeDialog(this)'></div></div>";
		html+="<div class='list -settings'>"+AP.render(this.options, function(e){
			return e.html();
		})+"</div>";
		
		
		AP.customDialog(html, "custom-settings").addClass("-full").width(640).show();
		Tag.user("#custom-settings input", Client.people);
		$("#custom-settings input").enter(function(){
			var val=$(this).val();
			var name=$(this).attr('name');
			var api=$(this).data("api");
			
			AP.ajaxShow("Updating ...");
			AP.post(api,{name: name, value: val}, function(code){
				AP.ajaxHide();
				if (!code.good()){
					return AP.alertError(code.message);
				}

				UI.flash("Preference saved!");
				if (callback) {
					callback(code, name, val);
				}
			});
		});
		
		
		$("#custom-settings select").change(function(){
			var val=$(this).val();
			var name=$(this).attr('name');
			var api=$(this).data("api");
			
			AP.ajaxShow("Updating ...");
			AP.post(api,{name: name, value: val}, function(code){
				AP.ajaxHide();
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				UI.flash("Preference saved!");
				if (callback) {
					callback(code, name, val);
				}
			});
		});
		
		return this;
	};
	
	
	this.showYesNo=function(canvas){
		$(canvas).html("<div class='setting-box'><div class='title'>"+this.title+"</div> <div class='js-setting-body values'></div></div>");

		for (var i=0; i<this.options.length; i++){
			addYesNoOption(canvas, this.options[i]);
		}
	};
	
	
	this.showInline=function(canvas, options){
		for (var i=0; i<options.length; i++){
			addInlineOption(canvas, options[i]);
		}
	};
	
	
	/**
	 * @desc Insert option
	 */
	function addInlineOption(canvas, option){
		option.appendTo(canvas);
	};
	
	
	function addYesNoOption(canvas, option){
		option.appendYesNo($(canvas).find(".js-setting-body"));
	};
	
};






function UISettingOption(opts){
	this.opts=$.extend({}, {value:''}, opts);
	
	this.html=function(){
		return "<div class='li'><div class='title'>"+this.opts.title+"</div> <div class='value'>"+showValue(this.opts)+"</div></div>";
	};
	
	
	this.appendTo=function(canvas){
		var id=AP.uuid();
		var html="<div class='setting-box is-checkbox' id='"+id+"'><div class='title'>"+this.opts.title+"</div> <div class='values'>"+showCheckbox(this.opts)+"</div></div>";
		$(html).appendTo(canvas);
		$(canvas).data("object", this).addClass("__sts");
		
		$("#"+id+" .st-opt").click(function(){
			var name=$(this).data("name");
			var value=$(this).data("value");
			var url=$(this).data("url");
			
			$(this).siblings().removeClass("selected");
			$(this).addClass("selected");
			
			
			UI.ajaxShow();
			AP.post(url, {name: name, value: value}, function(code){
				UI.ajaxHide();
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				var obj=$(this).closest(".__sts");
				if (obj && obj.callback){
					obj.callback(name, value);
				}
			});
		});
	};
	
	
	this.appendYesNo=function($box){
		var selected="";
		if (this.opts.value=="yes"){
			selected=" selected";
		}
		
		var id=AP.uuid();
		$box.append("<div class='st-opt-wrapper' id='"+id+"'><div class='st-opt"+selected+"' data-url='"+this.opts.url+"' data-cvalue='"+this.opts.value+"' data-name='"+this.opts.name+"'>"+this.opts.title+"</div></div>");
		
		$("#"+id+" .st-opt").click(function(){
			var name=$(this).data("name");
			var value=$(this).data("value");
			var url=$(this).data("url");
			
			var next_val="yes";
			if ($(this).hasClass("selected")){
				next_val="no";
			}
			
			if (next_val=="no"){
				$(this).removeClass("selected");	
			}else{
				$(this).addClass("selected");
			}
			
			
			UI.ajaxShow();
			AP.post(url, {name: name, value: next_val}, function(code){
				UI.ajaxHide();
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				var obj=$(this).closest(".__sts")
				if (obj && obj.callback){
					obj.callback(name, value);
				}
			});
		});
	};
	
	
	
	function showValue(opts){
		var html="";
		if (opts.options==":custom:users"){
			return "<div class='input'><input data-api='"+opts.url+"' class='std __select-users' name='"+opts.name+"' value='"+opts.value+"' placeholder='Type @ to tag - press Enter to save'/> <div class='hint'>Press Enter after selecting users to save</div></div>";
		}
		
		
		for (var opt in opts.options){
			if (opts.value && opts.value==opt){
				html+="<option value='"+opt+"' selected>"+opts.options[opt]+"</option>";	
			}else{
				html+="<option value='"+opt+"'>"+opts.options[opt]+"</option>";	
			}
		}
		
		return "<div class='select'><select class='std' name='"+opts.name+"' data-api='"+opts.url+"'>"+html+"</select></div>";
	};
	
	
	
	function showCheckbox(opts){
		var html="<div class='hidden'><input type='hidden' name='"+opts.name+"'/></div>";
		
		for (var opt in opts.options){
			if (opts.value && opts.value==opt){
				html+="<div class='st-opt selected' data-url='"+opts.url+"' data-name='"+opts.name+"' data-value='"+opt+"'>"+opts.options[opt]+"</div>";	
			}else{
				html+="<div class='st-opt' data-url='"+opts.url+"' data-name='"+opts.name+"' data-value='"+opt+"'>"+opts.options[opt]+"</div>";	
			}
		}
		
		return html;
	};
	
};
UI.tree=new function __UITree(){
	this.html=function(node, fn){
		return printTree(node, fn);
	};
	
	this.getTrace=function(root, node){
		var traces=[];
		buildTrace(root, node, traces);
		return traces.reverse();
	};
	
	
	this.findNode=function(root, nid){
		nid=parseInt(nid);
		if (parseInt(root.id)==nid){
			return root;
		}
		
		for (var i=0; i<root.nodes.length; i++){
			node=this.findNode(root.nodes[i], nid);
			if (node){
				return node;
			}
		}
		
		return null;
	};
	
	
	this.options=function(node, fn){
		var root=null;
		if (AP.data.isArray(node)){
			var root={id:0, nodes: node, name: "Root", level: 0, 'root': 1};
		}else{
			root=node;
		}
		
		return printTree(root, function(e, level){
			if (e.root && e.root==1){
				return "";
			}
			return "<option value='"+e.id+"'>"+("--").repeat(level-1)+" "+e.name+"</option>";
		});
		
	};
	
	
	function buildTrace(root, node, traces){
		if (parseInt(root.id)==parseInt(node.id)){
			return true;
		}
		
		for (var i=0; i<root.nodes.length; i++){
			if (buildTrace(root.nodes[i], node, traces)){
				traces.push(root.nodes[i]);
				return true;
			}
		}
		
		return false;
	};

	
	
	function printTree(node, render){
		return printNode(node, node.level, render);
	};
	
	

	function printNode(node, level, render){	
		var html=render(node, level);
		
		if (!node.nodes || !node.nodes.length){
			return html;
		}
		
		html+="<div class='box box-"+level+"' id='node-"+node.gid+"' data-level='"+level+"' data-id='"+node.id+"' data-hid='"+node.hid+"' data-token='"+node.token+"' data-name='"+node.name+"'>";
		for (var i=0; i<node.nodes.length; i++){
			html+=printNode(node.nodes[i], level+1, render);
		}
		html+="</div>";
		
		return html;
	};
};var Emoji=new function __Emoji(){
	this.icons=["angel","angry","anguished","beer","biglike","blushing","cat_grinning","cat_kissing","cat_lovely","cat_pouting","cat_sad", "cat_tear_joy","cat_wry_smile","cat_wth",
	            "cheer","chicken","chicken_egg","cold_sweat","confounded","confused","cool","crying","cup", "delicious", "disappointed", "donkey", "evil", "expressionless",
	            "fearful","flu", "frowning", "grinning", "grinning_evil", "happy_cry", "heart", "heart_gift", "hix", "huh", "hushed", "kissing", "lovely_evil", "meow", 
	            "neutral","nospeaking", "olala", "omg", "pensive", "pouting", "relieved", "sad", "screaming", "sleeping", "sleepy", "sleepy_face", "smiling", "smiling_closed_eye",
	            "smiling_eye","smiling_face", "smirking","surprised", "tears", "tired", "tongue", "tongue_closed_eyes", "unamused", "weary", "what_the_heck", "whistle",
	            "whistle_heart", "wink",
	            "tuzki_5ting", "tuzki_angry", "tuzki_ballet", "tuzki_bed", "tuzki_birthday", "tuzki_bored", "tuzki_bye", "tuzki_charmingly_refuse", "tuzki_chilling", "tuzki_chilling2", "tuzki_chilling3", "tuzki_crying", "tuzki_dancing", "tuzki_dancing2", "tuzki_daydreaming", "tuzki_depressed", "tuzki_disappointed", "tuzki_dispirited", "tuzki_droop", "tuzki_eating", "tuzki_feel_the_beat", "tuzki_giggling", "tuzki_headspin", "tuzki_heart", "tuzki_heroic", "tuzki_high_kick", "tuzki_hyperactive", "tuzki_idk", "tuzki_in_jail", "tuzki_killing", "tuzki_kissing", "tuzki_milk", "tuzki_mr_bean", "tuzki_out_of_my_way", "tuzki_panic", "tuzki_shocked", "tuzki_sleepy", "tuzki_star_reaching", "tuzki_superman", "tuzki_swag_buddy", "tuzki_swag2", "tuzki_swag3", "tuzki_swagging", "tuzki_sweating", "tuzki_taichi", "tuzki_wake_up"];
	
	this.pick=function(callback){
		var html="";
		for (var i=0; i< this.icons.length; i++){
			var key=this.icons[i];
			var img=Client.share_url+"/emojis/"+key+".png";
			if(key.substr(0, 6) == "tuzki_") {
			    img = Client.share_url + "/tuzki/" + key + ".gif";
			}
			html+="<div class='item' style='width:10%' title=':"+key+":' data-val=':"+key+":' onclick='__pickEmoji(this)'><div class='inner -full'><img src='"+img+"'/></div></div>";
		}
		
		html="<div class='list-emotions' style='width:500px' id='__pickemo'>"+html+"</div>";
		AP.selectOne("Click to select an emotion you like",html);
		$("#__pickemo").data("callback", callback);
	};
	
	
	this.match=function(r){
		r=r.replace(/\:\w+\:/gi, function(match){
			var test=match.substr(1, match.length-2);
			for (var i=0; i<Emoji.icons.length; i++){
				if (Emoji.icons[i]==test){
				    if(test.substr(0, 6) == "tuzki_") {
				        return "<img src='" + Client.share_url + "/tuzki/" + test + ".gif'/>";
				    }
					return "<img src='"+Client.share_url+"/emojis/"+test+".png'/>";
				}
			}
			
			return match;
		});
		
		return r;
	};
	
};UI.orgchart=new function __UIORGChart(){
	this.zoom=1;
	this.tree=null;
	
	this.display=function(tree, canvas, render, opts){
		if (!tree.id || !parseInt(tree.id)){
			tree.id=0;
		}
		
		opts=$.extend({}, {width: 150, height: 100, space: 100}, opts);
		opts.base={width: opts.width + opts.space, height: opts.height+60};
		
		tree.level=1;
		tree.height=1;
		tree.offset=0;
		tree.root=1;
		initOrgchart(tree);
		
		if (tree.nodes && opts.collapsed){
			for (var i=0; i<tree.nodes.length; i++){
				tree.nodes[i].orgchart.show=0;
			}
		}
		
		displayChart(tree, canvas, render, opts);
		
		if (opts.mousewheel){
			$(canvas).on("mousewheel", function(event){
				var factor=event.originalEvent;
				if (!factor){
					return;
				}
				
				if (factor.deltaY<0){
					UI.orgchart.zoomIn($(this).find(".orgchart-canvas"));
				}else if (factor.deltaY>0){
					UI.orgchart.zoomOut($(this).find(".orgchart-canvas"));
				}
			});
		}
		
		this.zoom=1;
		this.tree=tree;
		this.tree.__options=opts;
		this.tree.__canvas=canvas;
	};
	
	this.zoomIn=function(ref){
		this.zoom+=0.15;
		$(ref).closest(".orgchart").find('.orgchart-canvas').css("zoom",this.zoom);
	};
	
	
	this.zoomOut=function(ref){
		this.zoom-=0.15;
		if (this.zoom<0.4){
			this.zoom=0.4;
		}
		$(ref).closest(".orgchart").find('.orgchart-canvas').css("zoom",this.zoom);
	};
	
	
	this.collapse=function(ref){
		var id=$(ref).data("id");
		var $wrap=$(ref).closest(".wrap");
		var collapsed=1;
		
		if ($wrap.hasClass("-collapsed")){
			collapsed=0;
			$wrap.removeClass("-collapsed").children(".nodes").show();
		}else{
			$wrap.addClass("-collapsed").children(".nodes").hide();	
		}
		
		var $pwrap=$wrap.closest(".nodes");
		updateTreeData(this.tree, function(e){
			if (collapsed){
				if (parseInt(e.id)==parseInt(id)){
					e.orgchart.show=0;
				}
			}else{
				if (parseInt(e.id)==parseInt(id)){
					e.orgchart.show=1;
				}
			}
		});
		
		var opts=this.tree.__options;
		computeWidth(this.tree, opts);		
		
		var $canvas=$(this.tree.__canvas);
		
		updateTreeData(this.tree, function(node){
			if (!node.orgchart.offset){
				$canvas.find(".js-wrap-"+node.id).css("width", node.orgchart.width);	
			}else{
				$canvas.find(".js-wrap-"+node.id).css("left", node.orgchart.offset).css("width", node.orgchart.width);
			}
			
			if (node.nodes.length){
				var ll=node.nodes[0].orgchart.width/2+opts.space/2;
				var lr=node.nodes[node.nodes.length-1].orgchart.width/2 - opts.space/2;
				
				$canvas.find(".js-wrap-"+node.id+" > .nodes > .-line").css({left: ll, right: lr});
			}
			
			var left=(node.orgchart.width-opts.width+opts.space)*0.5;
			$canvas.find(".js-wrap-"+node.id+" > .nodew").css("left", left);
		});
		
	};
	
	
	function displayChart(tree, canvas, render, opts){
		$(canvas).html("<div class='orgchart'>" +
			"<div class='zoom'>" +
			"	<span class='-first' onclick='UI.orgchart.zoomIn(this);'><span class='-ap icon-plus4'></span></span>" +
			"	<span class='-second' onclick='UI.orgchart.zoomOut(this);'><span class='-ap icon-minus2'></span></span>" +
			"</div>" +
			"<div class='orgchart-outer-canvas'><div class='orgchart-canvas'></div></div>" +
		"</div>");
		
		show(tree, canvas, render, opts);
	};
	
	
	function show(tree, canvas, render, opts){
		computeWidth(tree, opts);
		testWidth(tree);
		var html=getGraphicDisplay(tree, render, opts);
		
		
		var $canvas=$(canvas);
		$canvas.find(".orgchart-canvas").html(html).css("width", tree.width+100).css("height",tree.height*opts.base.height);
		var l=(tree.width-$canvas.width())/2;
		$canvas.find(".orgchart-outer-canvas").css("width", tree.width+100).css("height",tree.height*opts.base.height).css("position","absolute").css("left", -l).css("top",30);
		$canvas.find(".orgchart-outer-canvas").draggable({cursor: "move"});
	};
	
	
	function balance(canvas){
		$(canvas).find('.orgchart-outer-canvas').css("width", Client.pageData.tree.width+100).css("height",Client.pageData.tree.height*opts.base.height).css("position","absolute").css("left", -l).css("top",30);
	};
	
	
	function getGraphicDisplay(node, render, opts){
		if (!node.nodes || !node.nodes.length){
			return "<div class='wrap js-wrap-"+node.id+"' style='z-index:"+((100-node.level)*5+100)+"; top:0px; left:"+node.orgchart.offset+"px; width:"+(node.orgchart.width)+"px'>"+showSingleNode(node, render, opts)+"</div>";
		}else{
			var ll=node.nodes[0].orgchart.width/2+opts.space/2;
			var lr=node.nodes[node.nodes.length-1].orgchart.width/2 - opts.space/2;
			
			var line="<div class='-line' style='left:"+ll+"px; right:"+lr+"px'></div>";
			return "<div class='wrap js-wrap-"+node.id+" "+((node.orgchart.show)?"":"-collapsed")+"' style='z-index:"+((100-node.level)*5+100)+"; top:0px; left:"+node.orgchart.offset+"px; width:"+(node.orgchart.width)+"px; height:"+(node.orgchart.height*opts.base.height)+"px'>"+
				showSingleNode(node, render, opts)+
				"<div class='nodes -nodes "+((node.orgchart.show)?"":"hidden")+"' style='top:"+opts.base.height+"px'>"+line + AP.render(node.nodes, function(e){
					return getGraphicDisplay(e, render, opts);
				})+"</div>" +
			"</div>";
		}
	};
	
	
	
	function showSingleNode(node, render, opts){
		var w=node.width;
		var level=node.level;
		var left=(node.orgchart.width-opts.width+opts.space)*0.5;
		var eclass="";
		if (!node.nodes || !node.nodes.length){
			eclass=" -leaf";
		}
		
		if (node.metatype && parseInt(node.metatype)){
			eclass+=" -exe";
		}
		var id=node.id;
		if (node.root){
			id=0;
		}
		
		var collapse_button="<div class='cbt' onclick='UI.orgchart.collapse(this);' data-id='"+node.id+"'><span></span></div>";
		if (!node.nodes || !node.nodes.length){
			collapse_button="";
		}
		
		return "<div class='nodew"+eclass+"' style='left:"+left+"px; width:"+opts.width+"px; height:"+opts.height+"px' data-cwidth='"+node.orgchart.width+"' data-cheight='"+node.orgchart.height+"'>" +
			"<div class='node' style='width:"+opts.width+"px; height:"+opts.height+"px'> " +
				render(node)+
				collapse_button +
			"</div>" +
		"</div>";
		
	};
	
	
	
	function initOrgchart(node){
		node.orgchart={show: 1};
		
		if (!node.nodes || !node.nodes.length){
		}else{
			for (var i=0; i<node.nodes.length; i++){
				initOrgchart(node.nodes[i]);
			}
		}
	};
	
	
	function updateTreeData(node, fx){
		fx(node);
		
		if (!node.nodes || !node.nodes.length){
		}else{
			for (var i=0; i<node.nodes.length; i++){
				updateTreeData(node.nodes[i], fx)
			}
		}
	};
	
	
	function testWidth(tree){
		updateTreeData(tree, function(e){
			$.log([e.name, e.orgchart.show, e.orgchart.width, e.orgchart.offset]);
		})
	};
	

	
	function computeWidth(node, opts){
		if (!node.nodes || !node.nodes.length){
			node.orgchart.width=opts.width + opts.space;
			node.orgchart.offset=opts.space/2;
			node.orgchart.height=1;
			return opts.base.width;
		}else if (!node.orgchart.show){
			node.orgchart.width=opts.width + opts.space;
			node.orgchart.offset=opts.space/2;
			node.orgchart.height=1;
			return opts.base.width;
		}else{
			var w=0;
			for (var i=0; i<node.nodes.length; i++){
				node.nodes[i].level=node.level+1
				w+=computeWidth(node.nodes[i], opts);
			}

			
			var offset=0;
			var max_height=1;
			for (var i=0; i<node.nodes.length; i++){
				node.nodes[i].orgchart.offset=offset;
				offset+=node.nodes[i].orgchart.width;
				if (node.nodes[i].orgchart.height>max_height){
					node.nodes[i].orgchart.height=max_height;
				}
			}
			
			node.orgchart.width=w;
			node.orgchart.height=max_height+1;
			return w;
		}
	};

};function getMainColor(){
	if (!Client.viewer || !Client.viewer.color){
		return "#000";
	}
	
	var c=parseInt(Client.viewer.color);
	if (c==0){
		c=1;
	}
	var list=["#2a91d6", "#00BCD4", "#26A69A", "#4CAF50", "#5969c5", "#FFC107", "#FF6F22", "#CF5555", "#ee59ba"];
	return list[c-1];
	
}

UI.color=new function __UIColor(){
	var colors=["#EB6450","#F7CF2D","#CEED5F","#A5E33B","#49E33B"];
	this.regs={};
	
	this.main=getMainColor();
	
	this.get=function(id){
		if (id=="success"){
			return "#14cc3f";
		}
		
		if (id=="error"){
			return "#c34343";
		}
		
		if (AP.data.isString(id) && this.regs[id]){
			return this.regs[id];
		}
		
		id=parseInt(id);
		if (id>=4){
			id=4;
		}
		return colors[id];
	};	
	
	this.register=function(key, val){
		this.regs[key]=val;
	};
	
	this.getRandom=function(){
		return this.get(AP.data.randomInteger(0,5));
	};
	
	this.rgba=function(hexcolor, a){
		if (hexcolor=="transparent"){
			return "transparent";
		}
		
		var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hexcolor);
		var rgb= result ? {
			r: parseInt(result[1], 16),
			g: parseInt(result[2], 16),
			b: parseInt(result[3], 16)
		} : null;
		
		if (rgb){
			return "rgba("+rgb.r+", "+rgb.g+", "+rgb.b+", "+a+")"
		}
		
		return "#000";
	};
	
	
	this.darken=function(hexcolor, point){
		return shadeColor(hexcolor, point);
	};
	
	this.adjust=function(hexcolor, x, y){
		if (hexcolor=="transparent"){
			return "transparent";
		}
		var hsl=rgbToHsl(hexcolor);
		if (x>=0){
			hsl.s=(1-hsl.s/100.0)*x+hsl.s;	
		}else{
			hsl.s=(-1+hsl.s/100.0)*x+hsl.s;
		}
		
		if (y>0){
			hsl.l=(1-hsl.l/100.0)*y+hsl.l;	
		}else{
			hsl.l=(-1+hsl.l/100.0)*y+hsl.l;
		}
		
		
		return hsl2rgb(hsl);
	};
	
	this.complete=function(percent){
		var x=parseFloat(percent);
		
		if (x<60){
			return colors[0];
		}
		
		if (x>=60 && x<80){
			return colors[1];
		}
		
		if (x>=80 && x<95){
			return colors[2];
		}
		
		if (x>=95 && x<100){
			return colors[3];
		}
		
		if (x>=100){
			return colors[4];
		}
	};
	
	
	this.incomplete=function(color){
		if (color>100){
			color=100;
		}
		
		return this.complete(100-color);
	};
	
	
	this.progress=function(obj){
		var x=0;
		var etime=parseInt(obj.etime);
		var stime=parseInt(obj.stime);
		var time=AP.time.now();
		
		if (obj.percent){
			var p=parseFloat(obj.percent);
			var target=100;
			var base=0;
			
			if (time> etime){
				x=parseInt(p);
			}else if (time > stime){
				var speed = (p - base)/(time-stime);
				var expected=(target-base)/(etime-stime);
				x=parseInt(speed*100.0/expected); // Expected speed
			}
		}else{
			var complete=parseInt(obj.complete);
			var target=100;
			var base=0;
			
			if (time> etime){
				x=parseInt(complete*100.0/target);
			}else if (time > stime){
				var speed = (complete - base)*1000.0/(time-stime);
				var expected=(target-base)*1000.0/(etime-stime);
				x=parseInt(speed*100.0/expected); // Expected speed
			}	
		}
		
		if (x<60){
			return colors[0];
		}
		
		if (x>=60 && x<80){
			return colors[1];
		}
		
		if (x>=80 && x<95){
			return colors[2];
		}
		
		if (x>=95 && x<100){
			return colors[3];
		}
		
		if (x>=100){
			return colors[4];
		}
	};
	
	
	this.percent=function(p){
		return this.complete(p);
	};
	
	
	this.picker=function(selector){
		$(selector).each(function(){
			if ($(this).hasClass("__jscolorpicker")){
				return;
			}
			
			$(this).addClass("__jscolorpicker");
			$(this)[0].autocomplete="off";
			
			$(this).on('click', function () {
				var obj = $(this)[0];
				if (!obj.hasPicker) {
					var picker = new jscolor(obj, {});  //
					obj.hasPicker = true;
					picker.show();
				}
			}); 
		});   
	};
	
	
	
	function shadeColor(hex, lum){
		// validate hex string
		hex = String(hex).replace(/[^0-9a-f]/gi, '');
		if (hex.length < 6) {
			hex = hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2];
		}
		lum = lum || 0;

		// convert to decimal and change luminosity
		var rgb = "#", c, i;
		for (i = 0; i < 3; i++) {
			c = parseInt(hex.substr(i*2,2), 16);
			c = Math.round(Math.min(Math.max(0, c + (c * lum)), 255)).toString(16);
			rgb += ("00"+c).substr(c.length);
		}

		return rgb;
	};
	
	
	function rgbToHsl(rgb){
		var shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
		var hex = rgb.replace(shorthandRegex, function(m, r, g, b) {
			return r + r + g + g + b + b;
		});
		
		var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
		
		var color= result ? {
			r: parseInt(result[1], 16),
			g: parseInt(result[2], 16),
			b: parseInt(result[3], 16)
		} : null;
		
		var r=color.r/255.0;
		var g=color.g/255.0;
		var b=color.b/255.0;
		
		
		var max = Math.max(r, g, b), min = Math.min(r, g, b);
		var h, s, l = (max + min) / 2;

		if(max == min){
			h = s = 0; // achromatic
		}else{
			var d = max - min;
			s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
			switch(max){
				case r: h = (g - b) / d + (g < b ? 6 : 0); break;
				case g: h = (b - r) / d + 2; break;
				case b: h = (r - g) / d + 4; break;
			}
			h /= 6;
		}

		return {h: Math.floor(h * 360), s: Math.floor(s * 100), l: Math.floor(l * 100)};
	};
	
	
	function hsl2rgb(hsl){
		var r, g, b;
		
		var h=hsl.h/360.0;
		var s=hsl.s/100.0;
		var l=hsl.l/100.0;
		

		if (s == 0) {
			r = g = b = l; // achromatic
		} else {
			var q = l < 0.5 ? l * (1 + s) : l + s - l * s;
			var p = 2 * l - q;

			r = hue2rgb(p, q, h + 1/3);
			g = hue2rgb(p, q, h);
			b = hue2rgb(p, q, h - 1/3);
		}

		return "#" + componentToHex(r*255) + componentToHex(g*255) + componentToHex(b*255);
	};
	
	
	function hue2rgb(p, q, t) {
		if (t < 0) t += 1;
		if (t > 1) t -= 1;
		if (t < 1/6) return p + (q - p) * 6 * t;
		if (t < 1/2) return q;
		if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
		return p;
	};
	
	function componentToHex(c) {
		c=parseInt(c);
		var hex = c.toString(16);
		return hex.length == 1 ? "0" + hex : hex;
	};
};


var Color=UI.color;UI.emoticons={
	':-)' : 'smile.gif',	
	':))'	: 'laughing.gif',
	':)'	: 'smile.gif',
	'::smile::' : 'smile.gif',
	';)'	: 'wink.gif',
	'::wink::' : 'wink.gif',
	':d'	: 'big.grin.gif',
	':-d'	: 'big.grin.gif',
	':-|'	: 'smile.gif',
	':|'	: 'straight.gif',
	':-s'	: 'worried.gif',
	':x' : 'love.gif',
	':*' : 'kiss.gif',
	':p' : 'tounge.gif',
	':((' : 'cry.gif',
	':(' : 'sad.gif',
	':-o'	: 'suprised.gif',
	'=))' : 'rolling.gif',
	'>-s'	: 'devil.gif',
	'::shocked::' : 'shocked.gif',
	'::angry::' : 'angry.gif',
	'::embarrassed::': 'embarrassed.gif',
	'::huh::':'huh.gif',
	'(y)':'biglike.png',
	':v':'pacman.png',
	':3':'colonthree.png',
	'b-)':'sunglasses.gif'
};

UI.emotion=function(text) {
	var emoticons = UI.emoticons;
	
	var icons = {
		'(y)' : 'thumbs-up2',
	},
		
	url = Client.share_url+"/emotions/", 
	patterns = [], ipatterns=[],
	metachars = /[[\]{}()*+?.\\|^$\-,&#\s]/g;

	
	// build a regex pattern for each defined property
	for (var i in emoticons) {
		if (emoticons.hasOwnProperty(i)){ // escape metacharacters
			patterns.push('('+i.replace(metachars, "\\$&")+'(\\b|&|\\.|\\,|$))');
		}
	}

	// build a regex pattern for each defined property
	for (var i in icons) {
		if (icons.hasOwnProperty(i)){ // escape metacharacters
			ipatterns.push('('+i.replace(metachars, "\\$&")+')');
		}
	}
	
	// build the regular expression and replace
	var r= Emoji.match(text);
	r= r.replace(new RegExp(patterns.join('|'),'ig'), function (match) {
	 var m=match.toLowerCase();
	 return typeof emoticons[m] != 'undefined' ?
					 '<img class="emo" src="'+url+emoticons[m]+'"/>' :
					 match;
	}).replace(new RegExp(ipatterns.join('|'),'ig'), function (match) {
		 var m=match.toLowerCase();
		 return typeof icons[m] != 'undefined' ?
					' &nbsp;<span class="-ap icon-'+icons[m]+' text-main ap-f32"></span>' :
					match;
	});
	
	return r;
};



UI.pickEmotion=function(callback){
	var html="";
	for (var key in UI.emoticons){
		var img=Client.share_url+"/emotions/"+UI.emoticons[key];
		html+="<div class='item' style='width:10%' title='"+key+"' data-val='"+key+"' onclick='__pickEmo(this)'><div class='inner'><img src='"+img+"'/></div></div>";
	}
	
	html="<div class='list-emotions' style='width:500px' id='__pickemo'>"+html+"</div>";
	AP.selectOne("Click to select an emotion you like",html);
	$("#__pickemo").data("callback", callback);
};


function __pickEmo(ref){
	var val=$(ref).data('val');
	var fn=$("#__pickemo").data("callback");
	
	AP.closeDialog(ref);
	fn(val+" ");
};


function __pickEmoji(ref){
	var val=$(ref).data('val');
	var fn=$("#__pickemo").data("callback");
	
	AP.closeDialog(ref);
	fn(val);
}UI.graph=new function __UIGraph(){
	this.getSpeed=function(obj){
		var x=0;
		var etime=parseInt(obj.etime);
		var stime=parseInt(obj.stime);
		var time=AP.time.now();
		
		var complete=parseInt(obj.complete);
		var target=100;
		var base=0;
		
		if (time> etime){
			x=parseInt(complete*100.0/target);
		}else if (time > stime){
			var speed = (complete - base)*1000.0/(time-stime);
			var expected=(target-base)*1000.0/(etime-stime);
			x=parseInt(speed*100.0/expected); // Expected speed
		}
		
		return x;
	};
	
	
	this.sector=function(selector, options){
		options=$.extend({thickness: 4, fontSize:10, color: "#888888", bgColor:"#eee"}, options);
		
		$(selector).css({"width": options.size, "height": options.size}).addClass("js-sector-chart").html("<div class='js-sector -circled' style='position:absolute; width:"+options.size+"px; height:"+options.size+"px; background-color:"+options.bgColor+"'></div>");
		
		var data = {
			size: options.size,
			sectors: [
				{
					percentage: options.percent/100,
					label: 'Thing 1',
					color: options.color
				}
			]
		};	

		sectors = calculateSectors(data);
		var newSVG = document.createElementNS("http://www.w3.org/2000/svg","svg" );
		newSVG.setAttributeNS(null, 'style', "width: "+data.size+"px; height: " + data.size+ "px");
		
		var $box=$(selector).find(".js-sector");
		$box[0].appendChild(newSVG)


		sectors.map(function(sector){
			var newSector = document.createElementNS("http://www.w3.org/2000/svg","path" );
			newSector.setAttributeNS(null, 'fill', sector.color);
			newSector.setAttributeNS(null, 'd', 'M' + sector.L + ',' + sector.L + ' L' + sector.L + ',0 A' + sector.L + ',' + sector.L + ' 0 ' + sector.arcSweep + ',1 ' + sector.X + ', ' + sector.Y + ' z');
			newSector.setAttributeNS(null, 'transform', 'rotate(' + sector.R + ', '+ sector.L+', '+ sector.L+')');

			newSVG.appendChild(newSector);
		});

		
		if (options.cutout){
			var midCircle = document.createElementNS( "http://www.w3.org/2000/svg","circle" );
			midCircle.setAttributeNS(null, 'cx', data.size * 0.5 );
			midCircle.setAttributeNS(null, 'cy', data.size * 0.5);
			midCircle.setAttributeNS(null, 'r', data.size * options.cutout/200 );
			midCircle.setAttributeNS(null, 'fill', options.bgColor );
			newSVG.appendChild(midCircle);	
		};
	};
	
	
	this.percent=function(selector, opts){
		opts=$.extend({thickness: 4, fontSize:10, color: "#888888", bgcolor:"#bbb"}, opts); 
		
		if (opts.text && opts.text.length){
			$(selector).data("text", opts.text);
		}
		
		if (opts.color && opts.color.length){
			$(selector).data("color", opts.color);
		}
		
		if (opts.percent && AP.data.isNumber(opts.percent)){
			$(selector).data("percent", opts.percent);
		}
		
		if (opts.size && AP.data.isInt(opts.size)){
			$(selector).data("size", opts.size);
		}
		
		
		$(selector).each(function(){
			$(this).data('fgcolor', $(this).data('color'));
			$(this).data('bgcolor', opts.bgcolor);
			$(this).attr('title', $(this).data('percent')+"%");
			
			$(this).circliful({
				dimension: $(this).data('size'), width: opts.thickness, fontsize: opts.fontSize, fillColor: '#333',  animationStep: 10, backgroundBorderWidth: 32
			});
		});
	};
	
	
	this.progression=function(object, canvas, opts, callback){
		opts=$.extend({}, {title: true, prediction: true, label: true}, opts);
		var title="<div class='title'>Tiến độ trong 30 ngày gần đây</div>";
		if (!opts.title){
			title="";
		}
		
		$(canvas).html("<div class='objbox -graph'> "+title+" <div class='graph'></div> <div class='none'></div> </div>  <div class='objbox -prediction'></div>");
		showProgressionGraph(object, $(canvas), opts, callback);
		
	};
	
	
	/**
	 * @desc Linear regression model
	 */
	this.learn=function(data){		
		var xavg=0;
		var yavg=0;
		
		for (var i=0; i<data.length; i++){
			var temp=parseFloat(data[i]);
			if (!temp){
				temp=0;
			}
			data[i]=temp;
			
			xavg=xavg+i;
			yavg=yavg+data[i];
		}
		
		xavg=xavg*1.0/data.length;
		yavg=yavg*1.0/data.length;
		
		var upper=0;
		var lower=0;
		
		for (var i=0; i<data.length; i++){
			upper+=(i-xavg)*(data[i]-yavg);
			lower+=(i-xavg)*(i-xavg); 
		}
		
		if (lower==0){
			return [0,0];
		}
		
		var a=upper*1.0/lower;
		var b=yavg - a*xavg;
		
		// Function is now: y(n)= a * x(n) + b for all n
		
		return [a,b];
	};
	
	
	
	
	function showProgressionGraph(objective, $outer_canvas, options, callback){
		var data=prepareProgressions(objective);
		var projection=prepareProjections(objective);
		
		if (data && !data.error){
			$outer_canvas.find(".objbox.-graph .none").hide();
			$outer_canvas.find(".objbox.-graph .graph").show();
			if (projection && !projection.error){
				intellichart(objective, $outer_canvas.find(".objbox.-graph .graph"), data, projection, options);
			}else{
				stdchart($outer_canvas.find(".objbox.-graph .graph"), data.labels, data.values, data.color, options);
			}
		}else{
			$outer_canvas.find(".objbox.-graph .none").show().html("<center style='color: #888;'>Không có dữ liệu để hiển thị</center>");	
		}
	};
	
	
	
	
	function prepareProgressions(objective){
		var time=objective.progressions.last;
		var data=objective.progressions.data;
		var labels=[];
		var values=[];
		
		if (!data || !data.length){
			return {error: 1};
		}
		
		var max_displays = 10;
		
		for (var i=0; i<data.length; i++){
			var num=parseFloat(data[i]);
			if (!num){
				num=0;
			}
			
			var text="";
			var displayed=true;
			
			if (displayed){
				labels.push(AP.time.time("%d/%m", AP.time.now()- (data.length-i-1)*24*3600));
			}else{
				labels.push("");
			}
			
			
			values.push(num.toFixed(2));
		}
		
		return {
			color: UI.color.progress({stime: objective.stime, etime: objective.etime, complete: objective.complete}),
			labels: labels,
			values: values,
			error: 0
		};
		
		// Log this up
		
	};
	
	
	
	
	function prepareProjections(objective){
		var data=objective.progressions.data;
		if (!data || !data.length || data.length<=1){
			return {error: 1};
		}
		
		var last=parseInt(objective.progressions.last);
		
		var xavg=0;
		var yavg=0;
		
		for (var i=0; i<data.length; i++){
			var temp=parseFloat(data[i]);
			if (!temp){
				temp=0;
			}
			data[i]=temp;
			
			xavg=xavg+i;
			yavg=yavg+data[i];
		}
		
		xavg=xavg*1.0/data.length;
		yavg=yavg*1.0/data.length;
		
		var upper=0;
		var lower=0;
		
		for (var i=0; i<data.length; i++){
			upper+=(i-xavg)*(data[i]-yavg);
			lower+=(i-xavg)*(i-xavg); 
		}
		
		var a=upper*1.0/lower;
		var b=yavg - a*xavg;
		
		// Function is now: y(n)= a * x(n) + b for all n
		
		var start=b;
		var end= a* (data.length-1)+b;
		var expected=end;
		
		if (parseInt(objective.etime) < last){
			expected=data[data.length-1];
		}
		
		if (a>0 && parseInt(objective.etime) >= last){
			var diff=Math.floor((parseInt(objective.etime)-last)/(24*3600))+data.length-1;
			expected = a * diff + b;
			
			if (expected < 0){
				expected = 0;
			}
		}
		
		
		
		var values=[];
		for (var i=0; i<data.length; i++){
			var temp=(a *i +b).toFixed(2);
			if (temp < 0){
				temp=0;
			}
			values.push(temp);
		}
		
		var last07=0;
		if (data.length>=7){
			last07=data[data.length-7];
		}
		
		return {'expected': expected.toFixed(2), 'start': start, 'end': end, 'length': data.length, 'a': a, 'b': b, 'values': values, 'color': "#2583E8", "last07":last07};
	};
	


	
	
	
	function stdchart(canvas, labels, values, color){
		var data = {
			labels: labels,
			datasets: [
				{
					label: "Current Progression",
					fillColor: UI.color.rgba(color, 0.3),
					strokeColor: color,
					pointColor: color,
					pointStrokeColor: "transparent",
					pointHighlightFill: "#fff",
					pointHighlightStroke: color,
					data: values
				}
			]
		};
		
		
		$(canvas).chartjs(data,{
			pointHitDetectionRadius : 5,
			bezierCurve : false,
			scaleShowVerticalLines: false,
			scaleShowHorizontalLines: true,
			pointDot : true,
			pointDotRadius : 1,
			pointDotStrokeWidth : 1,
			scaleGridLineWidth : 1,
			
			// datasetStrokeWidth : 2,
			// scaleOverride : true,
			// scaleSteps : 5,
			// scaleStepWidth : 100,
			// scaleStartValue : 0,
			// scaleShowGridLines: false,
			// scaleShowLabels: true,
			responsive: true
		});
	};
	
	
	
	function intellichart(objective, canvas, data, projection, options){
		var options=$.extend({}, {compact: false, compare: true, labels: true}, options);
		var labels=data.labels;
		
		if (options.labels==false){
			var ls=[];
			for (var i=0; i<labels.length; i++){
				ls.push("");
			}
			
			labels=ls;
		}
		
		
		var graphs = {
				labels: labels,
				
				datasets: [
					{
						label: "Current Progression",
						fillColor: UI.color.rgba(data.color, 0.3),
						strokeColor: data.color,
						pointColor: data.color,
						pointStrokeColor: "transparent",
						pointHighlightFill: "#fff",
						pointHighlightStroke: data.color,
						data: data.values,
						borderDashOffset: 0.0,
					},
					
					{
						label: "Preditected progression",
						fillColor: 'transparent',
						strokeColor: projection.color,
						pointColor: projection.color,
						pointStrokeColor: "transparent",
						pointHighlightFill: "#fff",
						pointHighlightStroke: projection.color,
						data: projection.values,
						borderDashOffset: 0.0,
						borderDash: [1,2],
					}
				]
			};
		
		if (options.compare){
			graphs.datasets.push({
				label: "Last 07 day progression",
				fillColor: "rgba(0,0,0,0.3)", // UI.color.rgba(data.color, 0.2),
				strokeColor: "rgba(0,0,0,0.3)",
				pointColor: "rgba(0,0,0,0.3)",
				pointStrokeColor: "transparent",
				pointHighlightFill: "#fff",
				pointHighlightStroke: "rgba(0,0,0,0.6)", // UI.color.rgba(data.color, 0.6),
				data: previousData(data.values, 7),
				borderDashOffset: 0.0,
			});
		}
		
		
		$(canvas).chartjs(graphs,{
			legend:{
				display: false,
			},
			height: (options.compact?100:150),
			 scales: {
				xAxes: [{
					display: false
				}],
				yAxes: [{
					display: false
				}]
			},
			legend: false,
			responsive: true
		});
		
		$.log(graphs);
		
		var html=getPrediction(objective, data, projection);
		$(canvas).closest('.side').find(".objbox.-prediction").html(html);
	};
	
	
	
	
	
	function getPrediction(objective, data, prediction){
		var expected=prediction.expected+"%";
		if (objective.plan && objective.plan.metatype=="kpi"){
			expected=AP.data.numberFormat(parseInt(prediction.expected))+objective.base.unit;
		}
		
		return "" +
				"<div class='infos'>" +
				"	<div class='row'>" +
				"		<span class='square top-left' style='background-color:"+data.color+"'></span> Tiến độ thực tế" +
				"	</div>" +
				"	<div class='row'>" +
				"		<span class='square top-left' style='background-color:#999'></span> Tiến độ 07 ngày trước" +
				"	</div>" +
				"	<div class='row'>" +
				"		<span class='square top-left' style='background-color:"+prediction.color+"'></span> Tiến độ dự báo" +
				"	</div>" +
				"</div>" +
				"<div class='prediction'>" +
				"	<div class='title ap-xdot'>Dự báo kết quả ("+AP.time.time("%d/%m/%Y", objective.deadline)+")</div>" +
				"	<div class='result' style='background-color:"+data.color+"'>"+expected+"</span>" +
				"</div>" +
			"";
	};
	
	
	
	
	function previousData(data, minus){
		var r=[];
		for (var i=0; i<minus; i++){
			r.push(null);
		}
		for (var i=minus; i<data.length; i++){
			r.push(data[i-minus]);
		}
		
		return r;
	};
	
	
	function calculateSectors(data) {
		var sectors = [];
		var l = data.size / 2
		var a = 0 // Angle
		var aRad = 0 // Angle in Rad
		var z = 0 // Size z
		var x = 0 // Side x
		var y = 0 // Side y
		var X = 0 // SVG X coordinate
		var Y = 0 // SVG Y coordinate
		var R = 0 // Rotation

		data.sectors.map(function(item, key) {
			a = 360 * item.percentage;
			aCalc = ( a > 180 ) ? 360 - a : a;
			aRad = aCalc * Math.PI / 180;
			z = Math.sqrt( 2*l*l - ( 2*l*l*Math.cos(aRad) ) );
			if( aCalc <= 90 ) {
				x = l*Math.sin(aRad);
			}
			else {
				x = l*Math.sin((180 - aCalc) * Math.PI/180 );
			}
			
			y = Math.sqrt( z*z - x*x );
			Y = y;

			if( a <= 180 ) {
				X = l + x;
				arcSweep = 0;
			}
			else {
				X = l - x;
				arcSweep = 1;
			}

			sectors.push({
				percentage: item.percentage,
				label: item.label,
				arcSweep: arcSweep,
				L: l,
				X: X,
				Y: Y,
				R: R,
				color: item.color
			});

			R = R + a;
		})


		return sectors
	};
};UI.table = new function __UITable(){
	this.sortable =function(table, options){
		$(table).find(options.header+" th").click(function(){
			var index=$(this).index();
		});
	};
};var Filter=new function __UIFilter(){
	this.opts={};
	this.name="";
	this.filters=[];
	this.id=null;
	
	this.init=function(opts){
		this.id=null;
		this.opts={};
		this.filters=[];
		opts=$.extend({}, {display: "dialog", color: 0}, opts);
		this.opts=opts;
		this.name="Custom filter";
		this.color=opts.color;
		if (!parseInt(this.color)){
			this.color=AP.data.randomNumber(1,9);
		}
	};
	
	this.create=function(url){
		if (url && url.length){
			this.filters=loadFilterFromURL(url);
		}
		$(".js-custom-filter").remove();
		this.display();
	};
	
	this.edit=function(id, name, url, color){
		if (!color){
			color=0;
		}
		
		this.create(url);
		this.update({
			id: id,
			color: color,
			name: name,
			url: url
		});
	};
	
	
	this.editCurrent=function(){
		var id=Query.getInt("filter");
		if (id){
			var filter=AP.array.findObj(Client.pageData.filters, id);
			if (filter){
				this.edit(filter.id, filter.name, filter.url, filter.color);
			}
		}
	};
	
	
	this.display=function(){
		this.id=AP.uuid();
		
		if (this.opts.display=="dialog"){
			$("<div id='"+this.id+"' class='js-custom-filter ui-custom-filter'><div class='wrap'>"+this.getHTML()+"</div></div>").appendTo("#document");
		}
		
		initHandlers(this.id);
	};
	
	
	this.getHTML=function(){
		return this.getHeader() + this.getBody() + this.getFooter();
	};
	
	
	this.getHeader=function(){
		return "<div class='header'>" +
			"<div class='hidden'><input type='hidden' name='id' value='0'/></div>" +
			"<div class='hidden'><input type='hidden' name='color' value='"+this.color+"'/></div>" +
			"<div class='txt'><input type='text' name='name' placeholder='Edit filter' value='Custom filter'/></div>" +
			"<div class='edit-icon' onclick='Filter.focusEdit(this);'><span class='-ap icon-mode_edit'></span></div>" +
			"<div class='color'><div class='s -bg-alt"+this.color+"'></div></div>" +
			"<div class='close' onclick='Filter.close(this);'><span class='-ap icon-close'></span></div>" +
		"</div>";
	};
	
	
	this.getBody=function(){
		return "<div class='body'>" +
			"<div class='js-select-form'>"+getForm(this.opts)+"</div>" +
			"<div class='js-query'></div>"+
			"<div class='js-display'></div>"+
		"</div>";
	};
	
	
	this.getFooter=function(){
		return "<div class='footer'>" +
			"<div class='save'>Save filter</div>" +
		"</div>";
	};
	
	
	this.getQuery=function(){
		var html="";
		for (var i=0; i<this.filters.length; i++){
			html+="&"+buildQuery(this.filters[i]);
		}
		
		return html;
	};
	
	
	/**
	 * @desc Add a filter
	 */
	this.addFilter=function(ref){
		var $box=$(ref).closest(".js-select-form");
		var key=$box.find("select[name=select-custom]").val();
		var opt=$box.find("select[name=operator]").val();
		var val=safe($box.find("*[name=val]").val());
		
		var found=false;
		for (var i=0; i<this.filters.length; i++){
			if (this.filters[i].key==key && this.filters[i].operator==opt){
				found=true;
				this.filters[i].value=val;
			}
		}
		
		if (!found){
			this.filters.push({key: key, operator: opt, value: val});
		}
		
		this.render();
		
	};
	
	
	/**
	 * @desc Render a filter
	 */
	this.render=function(){
		$("#"+this.id+" .js-query").html("<div class='query'>"+this.getQuery()+"</div>");
		$("#"+this.id+" .js-display").html("<div class='display'>"+AP.render(this.filters, function(e){return getItem(e);})+"</div>");
	};
	
	this.hide=function(){
		$(".js-custom-filter").remove();
	};
	
	
	/**
	 * @desc Close a filter
	 */
	this.close=function(ref){
		$(ref).closest(".js-custom-filter").remove();
	};
	
	
	this.save=function(url, callback, extra_data){
		if (!extra_data){
			extra_data={};
		}
		
		extra_data.id=$("#"+this.id+" input[name=id]").val();
		extra_data.color=$("#"+this.id+" input[name=color]").val();
		
		UI.ajaxShow();
		var data= $.extend({}, extra_data, {filter_name: $("#"+this.id+" .txt input[name=name]").val(), filter_url: this.getQuery()}, getAssoc(this.filters));
		
		AP.post(url, data, function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			callback(code, data);
		});
	};
	
	
	this.remove=function(url, callback, extra_data){
		this.save(url, callback, extra_data);
	};
	
	
	this.update=function(opts){
		$("#"+this.id+" .header input[name=name]").val(opts.name);
		$("#"+this.id+" .header input[name=id]").val(opts.id);
		
		if (opts.color){
			this.color=opts.color;
			$("#"+this.id+" .header input[name=color]").val(this.color);
			$("#"+this.id+" .header .color .s").replaceWith("<div class='s -bg-alt"+this.color+"'></div>");
		}
		
		
		this.render();
		
		if (opts.id && !$("#"+this.id+" .footer .remove").length && this.opts.remove){
			$("#"+this.id+" .footer").append("<div class='cancel'>Remove filter</div>");
			$("#"+this.id+" .footer .cancel").click(function(){
				AP.confirm("Are you sure that you want to remove this filter?", function(){
					Filter.opts.remove();
				});
			});
		}
	};
	
	
	this.focusEdit=function(ref){
		$(ref).closest(".header").find("input[name=name]").focus();
	};
	
	
	this.removeFilterItem=function(key, ref){
		this.filters=AP.array.filter(this.filters, function(e){
			return e.key!=key;
		});
		
		this.render();
	};
	
	
	function initHandlers(id){
		$("#"+id+" input[name=name]").on("focus", function(){
			$(this).closest(".header").addClass("active")
		}).on("blur", function(){
			$(this).closest(".header").removeClass("active")
		});
		
		$("#"+id+" select[name=select-custom]").on("change", function(){
			var val=$(this).val();
			if (!val || !val.length){
				$(this).closest(".select-fx").find(".js-select-create").empty();
			}else{
				var $box=$(this).closest(".select-fx").find(".js-select-create");
				
				var filter=AP.array.find(Filter.opts.filters, function(e){
					return e.key==val;
				});
				
				if (!filter){
					return;
				}
				
				var operators="<option value='equal'>Equal</option>";
				
				if (filter.type=="number"){
					operators="<option value='equal'>Equal</option>" +
					"<option value='not'>Not equal</option>" +
					"<option value='min'>Larger than</option>" +
					"<option value='max'>Smaller than</option>";
				}
				
				if (filter.type=="match"){
					operators="<option value='match'>Match</option>";
				}
				
				if (filter.type=="equal"){
					operators="<option value='equal'>Equal</option><option value='not'>Equal</option>";
				}
				
				var val="<input type='text' name='val' placeholder='Type the value'/>";
				if (filter.role=="date"){
					val="<input type='text' name='val' placeholder='Type the value' data-role='date'/>"
				}
				
				if (filter.role=="user"){
					val="<input type='text' name='val' placeholder='Type the value' data-role='tag'/>"
				}
				
				if (filter.options){
					var opts_html="";
					if (AP.data.isArray(filter.options)){
						opts_html = AP.render(filter.options, function(e){
							return "<option value='"+e.value+"'>"+e.label+"</option>";
						});
					}else{
						$.each(filter.options, function(key, val){
							opts_html+="<option value='"+key+"'>"+val+"</option>";
						});
					}
					val="<select name='val'>"+opts_html+"</select>";
				}
				
				$box.html("<div class='select'>" +
					"	<select name='operator'>" + operators +"</select>" +
					"</div>" +
					"	<div class='input -val'>" + val + "</div>" +
					"	<div class='button' onclick='Filter.addFilter(this);'>Add filter</div>");
				
				Form.render($box);
			}
		});
		
		$("#"+id+" .footer .apply").click(function(){
			Filter.opts.search(Filter.filters, Filter.getQuery(), Filter);
		});
		
		$("#"+id+" .footer .save").click(function(){
			// Filter.opts.save(Filter.filters, Filter.getQuery(), Filter);
			Filter.opts.save();
		});
		
		Form.inlineColorTagger("#"+id+" .color", function(color){
			$("#"+id+" .color .s").removeClass().addClass("s -bg-alt"+color);
			$("#"+id+" input[name=color]").val(color);
		},{
			auto: true,
			left: -5
		});
	};
	
	
	function getForm(opts){
		return "<div class='select-fx'>" +
			"<div class='select-top'><select name='select-custom'>" +
				"<option value=''>--- Select another filter ---</option>" +
				AP.render(opts.filters, function(e){
					return "<option value='"+e.key+"'>"+e.name+"</option>";
				})+
			"</select></div>" +
			"<div class='select-create clear-fix js-select-create'></div>" +
		"</div>";
	};
	
	
	function buildQuery(q){
		if (q.operator=="min"){
			return q.key+"_min="+q.value;	
		}
		
		if (q.operator=="max"){
			return q.key+"_max="+q.value;	
		}
		
		if (q.operator=="not"){
			return q.key+"_not="+q.value;	
		}
		
		return q.key+"="+q.value;
	};
	
	
	function getItem(q){
		var txt="";
		if (q.operator=="min"){
			txt= "<b>"+q.key+"</b> <em>is greater than</em> <span class='val'>"+q.value+"</span>";	
		}else if (q.operator=="max"){
			txt= "<b>"+q.key+"</b> <em>is smaller than</em> <span class='val'>"+q.value+"</span>";	
		}else if (q.operator=="match"){
			txt= "<b>"+q.key+"</b> <em>matches</em> <span class='val'>"+q.value+"</span>";
		}else if (q.operator=="not"){
			txt= "<b>"+q.key+"</b> <em>does not equal</em> <span class='val'>"+q.value+"</span>";
		}else{
			txt= "<b>"+q.key+"</b> <em>equals</em> <span class='val'>"+q.value+"</span>";
		}
		
		
		return "<div class='item' onclick=\"Filter.removeFilterItem('"+q.key+"');\">"+txt+" <div class='remove' title='Remove this filter'><span class='-ap icon-close'></span></div></div>";
	};
	
	
	function getAssoc(arr){
		var r={};
		for (var i=0; i<arr.length; i++){
			r[arr[i].key]=arr[i].value;
		};
		
		return r;
	};
	
	
	function loadFilterFromURL(url){
		var r=[];
		var parts=AP.word.split("&",url);
		for (var i=0; i<parts.length; i++){
			var ps=AP.word.split("=", parts[i]);
			if (ps.length!=2){
				continue;
			}
			
			var key=ps[0];
			var val=ps[1];
			
			if (AP.word.suffix(key,"_min")){
				$.log([key, val]);	
			}
			
			if (AP.word.suffix(key,"_min")){
				key=key.substr(0, key.length-4);
				r.push({
					key: key,
					operator: "min",
					value: val
				});
			}else if (AP.word.suffix(key,"_max")){
				key=key.substr(0, key.length-4);
				r.push({
					key: key,
					operator: "max",
					value: val
				});
			}else{
				r.push({
					key: key,
					operator: "match",
					value: val
				});
			}
		}
		
		return r;
	};
	
};var CONFIG={
    name: "Base",
    email: "contact@base.vn",
    owner: "Base",
    home_src: "base.vn",
    domain:"base.vn",
    port: "1331",
    https_port: "1331",
    api: "message",
    fileViewerAPI: "https://file.base.local.basecdn.net"
};

if (parseInt(Client.env)){
	CONFIG.fileViewerAPI= "https://file.basecdn.net";
}


if (Client.base && Client.base.port){
	CONFIG.port=Client.base.port;
	CONFIG.https_port=Client.base.port;
}Array.prototype.remove = function() {
	var what, a = arguments, L = a.length-1, ax;
	var fn=a[L];
	while (L && this.length) {
		what = a[--L];
		while ((ax = AP.array.indexOf(this,what, fn)) !== -1) {
			this.splice(ax, 1);
		}
	}
	
	return this;
};	


if (!Array.prototype.map){
	Array.prototype.map=function(mapper){
		var a=[];
		var len=this.length;
		
		for (var i=0; i<len; i++){
			a.push(mapper(this[i], i, len));
		}
		
		return a;
	};
};

String.prototype.repeat = function(count) {
	if (count < 1) return '';
	var result = '', pattern = this.valueOf();
	while (count > 1) {
		if (count & 1) result += pattern;
		count >>= 1, pattern += pattern;
	}
	return result + pattern;
};


String.prototype.contains = function(q) {
	return (this.toLowerCase().indexOf(q.toLowerCase())!==-1);
};



String.prototype.isAlphaNumeric = function() {
  var regExp = /^[A-Za-z0-9]+$/;
  return (this.match(regExp));
};


String.prototype.br2nl=function(){
	return this.replace(/(\r\n|\n\r|\r|\n)/g,'').replace(/<br>/g, "\r\n").replace(/<br\s*\/*>/g, "\r\n");
};

String.prototype.nl2br=function(){
	return this.replace(/(\r\n|\n\r|\r|\n)/g,"\n").replace(/\n/g, "<br>");
};


String.prototype.toTextarea=function(){
	return this.replace(/&#8220;|&#8221;|&#8216;|&#8217;/g,"'").replace("&#8217;","'").replace("&#8216;","'").br2nl();
};


function copyObject(obj, keys){
	var r={};
	var vars=AP.word.split(",", keys);
	for (var i=0; i<vars.length; i++){
		var index=$.trim(vars[i]);
		if (index && index in obj){
			r[index]=obj[index];
		}
	}
	return r;
};


function name(username){
	if (AP.data.isObject(username)){
		if (Client.system && Client.system.settings && Client.system.settings.name=="username"){
			return username.name;
		}
		
		return "@"+username.username;
	}
	
	var user=__getUserByUsername(username);
	if (!user){
		return "@"+username;
	}else{
		return user.name+"";
	}
};

function fullname(username){
	var user=People.get(username);
	if (!user){
		return "@<b class='url username' data-username='"+username+"'>"+username+"</b>";
	}
	
	return "<b class='url username' data-username='"+username+"'>"+user.name+"</b> <b class='url username' data-username='"+username+"'>@"+username+"</b> ("+user.title+")";
};


function fullnames(list){
	var html="";
	for (var i=0; i<list.length; i++){
		var username=list[i];
		if (AP.data.isObject(list[i])){
			username=list[i].username;
		}
		
		html+="<li>"+fullname(username)+"</li>";
	}
	
	return "<ul>"+html+"</ul>";
}


function __getUserByUsername(username){
	if (!Client.usernames){
		Client.usernames={};
		for (var i=0; i<Client.people.length; i++){
			Client.usernames[Client.people[i].username]=Client.people[i];
		}
	}
	
	if (Client.usernames[username]){
		return Client.usernames[username];
	}
	
	return null;
};


var cd_temp_timer=null;
AP.confirmDelete=function(msg, callback){
	function doCount(){
		cd_temp_timer=setTimeout(function(){
			var $b=$("#confirm-delete-box .button.danger span");
			if (!$b.length){
				return;
			}
			
			var v=$b.data("count");
			if (!v){
				$b.hide();
				$b.parent().addClass("ready");
			}else{
				v=parseInt(v);
				$b.html(" ("+v+")");
				$b.data("count", v-1);
			}
			
			doCount();
		}, 1000);
	};
	
	var html="<div id='confirm-delete-box'> <div class='icon'><img src='"+(Client.share_url)+"/svgs/alert.svg'/></div> <div class='cd-title'>Dangerous Action</div> <div class='cd-explain'>If you decide and confirm to delete, the data (and several linked data) WILL BE REMOVED AND WILL NOT be <u>recoverable</u></div> <div class='cd-explain-more'>"+(msg)+"</div> <div class='buttons'> <div class='button cancel left' onclick='AP.hideCustomDialog(\"#confirm-delete\")'>Cancel</div> <div class='button danger right'>Confirm to delete<span data-count='6'> (6)</span><div> </div> </div>";
	
	if (cd_temp_timer){
		clearTimeout(cd_temp_timer);
		temp_timer=null;
	}
	
	
	AP.customDialog(html, "confirm-delete").style("-full -strong-alert").closable(false).width(600).show();
	$("#confirm-delete-box .button.danger").data("action", callback).on("click", function(){
		if (!$(this).hasClass("ready")){
			return;
		}
		
		var fn=$(this).data("action");
		if (!fn){
			return;
		}
		
		AP.hideCustomDialog("#confirm-delete");
		fn();
	});
	
	doCount();
};



AP.bindSearch=function(input){
	var qname=$(input).data("query");
	if (!qname){
		qname="q";
	}
	
	
	$(input).enter(function(){
		var val=$(this).val();
		var qname=$(this).data("query");
		if (!qname){
			qname="q";
		}
		
		if (val=="" || !val.length){
			AP.setURLParams(assoc(qname, null), true);
		}else{
			AP.setURLParams(assoc(qname, val), true);
		}
	}).val(Query.get(qname)); 
	
	return $(input);
};



AP.xpost=function(url, data, callback){
	UI.ajaxShow();
	AP.post(Client.pageData.context.path+"/"+url, data, function(code){
		UI.ajaxHide();
		callback(code);
	})
};


AP.balanceDialog=function(id){
	AP.dialog(id).balance();
};

AP.customDialog=function(text, options){
	var id="";
	if (!options){
		options={};
		id="custom-dialog";
	}else if (AP.data.isString(options)){
		id=options;
		options={};
	}
	
	if (id[0]=="#"){
		id=id.substr(1);
	}
	
	var opts=$.extend({}, {id: id, padding: true, close_button: false, closable: true}, options);
	
	var dialog= AP.dialog(opts.id)
	.engine(CustomDialogEngine)
	.closeButton(opts.close_button)
	.closable(opts.closable)
	.content(text);
	
	// if (!dialog.padding){
	// 	dialog.addClass("-full");
	// }
	
	return dialog;
};



AP.hideCustomDialog=function(id){
	if (!id){
		id="#custom-dialog";
	}
	
	AP.dialog(id).hide();
};

AP.customCanvas=function(html, sticky){
	var closable=true;
	if (sticky){
		closable=false;
	}
	
	if (closable){
		return AP.customDialog(html).addClass("-full-canvas").closable(closable);	
	}else{
		return AP.customDialog(html).addClass("-full-canvas").closable(false); 
	}
};


AP.blankDialog=function(id){
	return AP.customDialog("<div id='"+id+"'></div>").addClass("-full-canvas -full-blank").closable(false).show();
};


AP.emptyDialog=function(html, opts){
	var opts=$.extend({}, {id: "custom-dialog", padding: true, close_button: false}, opts);
	
	var dialog= AP.dialog(opts.id)
	.engine(EmptyDialogEngine)
	.closeButton(false)
	.closable(true)
	.content(html);
	
	// if (!dialog.padding){
	// 	dialog.addClass("-full");
	// }
	
	dialog.addClass("-full-canvas -full-blank").closable(false).show().balance();
	return dialog;
};


AP.selectOne=function(title, html){
	AP.customDialog("<div class='title'>"+title+"<div class='-dx-close' onclick='AP.closeDialog(this);''></div></div>"+html,"custom-selection").style("-full").width(520).show();
};


AP.selectAction=function(actions, callback, opts){
	if (!opts){
		opts={};
	}
	
	var html=AP.render(actions, function(arr){
		var label="";
		if (arr.label){
			label="<div class='ap-xdot -name'>"+arr.label+"</div>";
		}
		if (arr.label_full){
			label="<div class='-name'>"+arr.label+"</div>";
		}
		
		var sub="";
		if (arr.sublabel){
			sub="<div class='sub'>"+arr.sublabel+"</div>";
		}
		return "<div class='li item unselectable' onclick='__selectItem(this);'>"+label+sub+" <div class='-ricon'><span class='ficon-angle-right'></span></div></div>";
	});
	
	
	var mh=$(window).height()-200;
	if (mh<200){
		mh=200;
	}
	
	html="<div class='rh' style='max-height:"+mh+"px; overflow-y:auto;'><div class='list list-actions no-icon -border'>"+html+"</div></div>";
	
	if (opts.filter || opts.search){
		html="<div class='isearch'><input type='text' id='selection-filter-ip' placeholder='Type to quickly search'/></div>" +html;
	}
	
	if (opts && opts.title){
		html="<div class='title'>"+opts.title+" <div class='-dx-close' onclick='AP.closeDialog(this);'></div></div>"+html;
	}
	
	if (!Client.mobile){
		AP.customDialog(html,"custom-selection").style("-full").width(500).show();	
	}else{
		AP.customDialog(html,"custom-selection").style("-full").show();
	}
	
	$("#custom-selection").data("object", actions).data("callback", callback).addClass("__canvas");
	if (opts.filter){
		$("#selection-filter-ip").on("input", function(){
			local_filter($(this).val());
		});
		if (!Client.native){
			$("#selection-filter-ip").autofocus();
		}
	}
	
	
	function local_filter(q){
		$("#custom-selection .li").each(function(){
			var matched=false;
			if (!q || !q.length){
				matched=true;
			}else{
				var str=$(this).text();
				matched= AP.word.fulltextMatch(str, q);
			}
			
			if (matched){
				$(this).show();
			}else{
				$(this).hide();
			}
		});
	};
};



AP.selectActions=function(actions, callback, opts){
	opts=$.extend({width: 600}, opts);
	
	var html=AP.render(actions, function(arr){
		var sub="";
		if (arr.sublabel){
			sub="<div class='sub'>"+arr.sublabel+"</div>";
		}
		var selected="";
		if (arr.selected){
			selected=" selected";
		}
		return "<div data-value='"+arr.value+"' class='li item unselectable"+selected+"' onclick='__selectItems(this);'> <div class='ap-xdot'>"+arr.label+"</div>"+sub+" <div class='-ricon'><span class='-select'></span></div></div>";
	});
	
	html="<div class='list list-actions no-icon -border -mlist'>"+html+"</div>";
	html+="<div class='buttons -two' style='border-top:2px solid #eee; margin:0; padding:20px; background-color:#f8f8f8;'> <div class='button -first -passive -rounded' onclick='AP.closeDialog(this);'>Cancel</div> <div class='button -second -success -rounded' onclick='__final_select_items(this);'>OK</div> </div>";
	
	if (opts && opts.title){
		html="<div class='title'>"+opts.title+"</div>"+html;
	}
	
	AP.customDialog(html,"custom-selection").style("-full selection-list").width(opts.width).show();
	$("#custom-selection").data("options", actions);
	$("#custom-selection").data("callback", callback);
	
	if (opts.selected){
		$("#custom-selection .li.item").each(function(){
			if (AP.array.contain(opts.selected, $(this).data("value"))){
				__selectItems(this);
			}
		});
	}
	
	if (opts.select_all){
		$("#custom-selection .li.item").each(function(){
			__selectItems(this);
		});
	}
	
	return;
};


/**
 * @desc Action menu
 */
AP.actionMenu=function(actions, opts){
	opts=$.extend({title: ""}, opts);
	
	var title="";
	if (opts.title && opts.title.length){
		title="<div class='title'>"+opts.title+"</div>"; 
	}
	
	AP.customDialog(title+"<div class='list list-actions -border'></div>","custom-selection").style("-full selection-list").width(400).show();
	
	AP.render(actions, function(e){
		var sublabel="";
		if (e.sublabel){
			sublabel="<small>"+e.sublabel+"</small>";
		}
		
		var icon="<span class='-ap icon-"+(e.icon)+"'></span>";
		if (AP.word.prefix(e.icon, "ficon-")){
			icon="<span class='ap-f14 "+(e.icon)+"'></span>";
		}
		
		var html="<div class='li item unselectable' onclick='__selfaction(this);'><span class='-icon'>"+(icon)+"</span> "+(e.label)+""+(sublabel)+" <div class='-ricon'><span class='ficon-angle-right'></span></div></div>";
		var id=AP.uuid();
		
		if (e.role=="url" || e.url){
			if (!AP.word.prefix(e.url,"http")){
				if (e.target && e.target=="blank"){
					html="<div class='li item unselectable url' data-url='"+e.url+"' data-blank='1'><span class='-icon'><span class='-ap icon-"+e.icon+"'></span></span> "+e.label+sublabel+" <span class='-ricon'><span class='ficon-angle-right'></span></span></div>";
				}else{
					html="<div class='li item unselectable url' data-url='"+e.url+"'><span class='-icon'><span class='-ap icon-"+e.icon+"'></span></span> "+e.label+sublabel+" <span class='-ricon'><span class='ficon-angle-right'></span></span></div>";	
				}
			}else{
				html="<a class='li item unselectable' target='_blank' href='"+e.url+"'><span class='-icon'><span class='-ap icon-"+e.icon+"'></span></span> "+e.label+sublabel+" <span class='-ricon'><span class='ficon-angle-right'></span></span></a>";	
			}
		}else if (e.role=="upload"){
			html="<div class='li item unselectable' id='"+id+"'><span class='-icon'><span class='-ap icon-"+e.icon+"'></span></span> "+e.label+sublabel+" <span class='-ricon'><span class='ficon-angle-right'></span></span></div>";
		}
		
		
		if (e.role=="upload"){
			$(html).appendTo("#custom-selection .list-actions").data("action", e.action).data("__params", e);
			AP.uploadable("#"+id, e.data, function(code){
				AP.dialog("#custom-selection").hide();
				e.callback(code);
			});
		}else{
			$(html).appendTo("#custom-selection .list-actions").data("action", e.action).data("__params", e);
		}
	});
	
	AP.dialog("#custom-selection").balance();
};



AP.boxMenu=function(actions, opts){
	opts=$.extend({title: ""}, opts);
	
	var title="";
	if (opts.title && opts.title.length){
		title="<div class='title'>"+opts.title+"</div>"; 
	}
	
	AP.customDialog(title+"<div class='list list-action-boxes -border'></div>","custom-selection").style("-full selection-list").width(602).show();
	
	AP.render(actions, function(e){
		var sublabel="";
		if (e.sublabel){
			sublabel="<small>"+e.sublabel+"</small>";
		}
		
		var icon="<div class='-icon'><img src='"+e.icon+"'/></div>";
		var label="<div class='label'>"+e.label+"</div>";
		
		var html="<div class='li js-item unselectable' onclick='__selfaction(this);'>"+icon + label+sublabel+"</div>";
		var id=AP.uuid();
		
		if (e.role=="url" || e.url){
			if (!AP.word.prefix(e.url,"http")){
				html="<div class='li js-item unselectable url' data-url='"+e.url+"'>"+icon+label+sublabel+"</div>";
			}else{
				html="<a class='li js-item unselectable' target='_blank' href='"+e.url+"'>"+icon+label+sublabel+"</a>";	
			}
		}else if (e.role=="upload"){
			html="<div class='li item unselectable' id='"+id+"'>"+icon+e.label+sublabel+"</div>";
		}
		
		
		if (e.role=="upload"){
			$(html).appendTo("#custom-selection .list-actions").data("action", e.action).data("__params", e);
			AP.uploadable("#"+id, e.data, function(code){
				AP.dialog("#custom-selection").hide();
				e.callback(code);
			});
		}else{
			$(html).appendTo("#custom-selection .list-action-boxes").data("action", e.action).data("__params", e);
		}
	});
	
	AP.dialog("#custom-selection").balance();
};




AP.pickable=function(canvas, options){
	if (!options){
		options={};
	}
	
	options=$.extend({}, {name: "file"}, options);
	
	options=$.extend({}, {name: options.name, format: 0, preview: 0, 'data': {}, multi: false}, options);
	var id=AP.uuid();
	var fid=AP.uuid();
	
	if (options.drive){
		$(canvas).click(function(){
			Base.drive.pick({multi: (options.multi?1:0), ext: 0, callback: function(files){
				options.callback.apply(this, [files]);
			}});
		});
		
		return;
	}
	
	if (!$(canvas).find(".upload-form").length){
		var html="<div class='upload-form'> <input type='file' name='"+(options.name)+"' id='"+(fid)+"' multiple/> </div>";
		$(canvas).append(html);	
	}else{
		$(canvas).find('.upload-form').empty().html("<input type='file' name='"+(options.name)+"' id='"+(fid)+"'/>");
	}
	
	$(canvas).find('.upload-form input').change(function(){
		var fn=getUploadFN($(this).val());
		options.callback.apply(this, [fn, this]); // YOU MUST REMOVE this
		AP.pickable(canvas, options);
	});
};


AP.uploadable=function(canvas, data, callback, $this){
	if (!data){
		data={};
	}
	
	data=$.extend({}, {name: 'file', format: 0, preview: 0, 'data': {}, multi: false}, data);
	
	if ($(canvas).hasClass('uploadable')){
		return;
	}
	
	if (data.drive){
		$(canvas).click(function(){
			var ext_val = 0;
			if (Client.system && (Client.system.id == 1 || Client.system.id == 79)) {
				ext_val = 1;
			}
			Base.drive.pick({multi: (data.multi?1:0), ext: ext_val, callback: function(files){
				var temp=shallowClone(data.data);
				Base.drive.append(temp, files);
				
				UI.ajaxShow();
				AP.post(data.action, temp, function(code){
					UI.ajaxHide();
					if (!code.good()){
						return AP.alertError(code.message);
					}
					
					callback(code);
					
//					if ($this){
//						callback.apply($this, [code]);
//					}else{
//						callback(code);	
//					}
				});
			}
		})});
		
		return;
	}
	
	
	
	
	$(canvas).addClass('uploadable');
	var id=AP.uuid();
	var fid=AP.uuid();
	var upload_icon="";
	
	if ($(canvas).data('format')){
		upload_icon="<span class='upload-icon icm icon-upload2'></span>"
	}
	
	var name=$(canvas).data("name");
	if (!name){
		name=data.name;
	}
	
	if (!name){
		name="file";
	}

	var show_preview=0;
	
	var action=$(canvas).data('action');
	if (!action){
		action=data.action;
	}
	
	var image_required=0;
	if ($(canvas).data('image')==1 || $(canvas).data('image')=='1' || data.image == 1){
		image_required=1;
	}
	
	if ($(canvas).data('preview')==1 || $(canvas).data('preview')=='1' || data.preview==1){
		show_preview=1;
	}
	
	var placeholder="";
	if (data.placeholder){
		placeholder="<div class='upload-placeholder'>"+data.placeholder+"</div>";
	}
	
	
	
	if (!action || !action.length){
		var preview_image="<div class='upload-preview'></div>";
		if (data.preview_image && data.preview_image.length){
			preview_image="<div class='upload-preview'><img src='"+data.preview_image+"'/></div>";
		}
		
		$("<div class='upload-form'>" +
			placeholder +
			upload_icon +
			preview_image+
			"<input type='file' name='"+name+"' id='"+fid+"'/>" +
		"</div><div class='upload-fn'></div>").appendTo(canvas);
		
		
		$("#"+fid).change(function(){
			if ('FileReader' in window && this.files.length && image_required){
				
				if (!this.files[0].type.match('image.*')) {
					return AP.alertError("Please select an image");
				}
			}
			
			var fname=getUploadFN($(this).val());
			$(canvas).addClass("-selected").find(".upload-fn").html("<span class='ap-xdot'>"+fname+"</span>");
			
			if (show_preview){
				if ('FileReader' in window && this.files.length){
					if (!this.files[0].type.match('image.*')) {
						return;
					}
					
					var reader=new FileReader;
					reader.onload=function(e){
						$(canvas).find(".upload-preview").html("<img src=''/>");
						$(canvas).find(".upload-preview img")[0].src=e.target.result;
					};
					reader.readAsDataURL(this.files[0]);
				}
			}
			
		});
		return;
	}
	
	
	var multi="";
	if (data.multi){
		multi=" multiple";
		$("<div class='upload-form'><form method='post' id='"+id+"' action='"+action+"'>" +
			"<input type='hidden' name='__multi' value='1'/>" +
			upload_icon+
			placeholder+
			"<input type='file' name='"+name+"[]' id='"+fid+"'"+multi+"/>" +
		"</form></div>").appendTo(canvas);
	}else{
		$("<div class='upload-form'><form method='post' id='"+id+"' action='"+action+"'>" +
			upload_icon+
			placeholder+
			"<input type='file' name='"+name+"' id='"+fid+"'/>" +
		"</form></div>").appendTo(canvas);
	}
	
	
	$("#"+fid).change(function(){
		var cid=$(this).closest('form').attr('id');
		$.log("FILE_CHANGED ...");
		
		AP.ajaxShow();
		AP.submit("#"+cid, function(code){
			AP.ajaxHide();
			
			$("#"+fid).val('');
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			if ($this){
				callback.apply($this, [code]);
			}else{
				callback(code);	
			}
			
		}, data.data);
	});
};


AP.dnd_lock=false;
AP.dnd=function(canvas, url, data, callback, options){
	options=$.extend({}, {name: 'file', layout: 'white', image: 0, max_files: 5, multi: true}, options);
	
	var $canvas=$(canvas);
	if ($canvas.hasClass("js-dndcanvas")){
		return;
	}
	
	var id=AP.uuid();
	$canvas.addClass("js-dndcanvas").append("<div class='js-dndicanvas' id='"+id+"'></div>");
	var $cx=$("#"+id);
	
	if (!$canvas.length){
		$.log("DND failed. Cannot find the canvas");
		$.log([canvas, url, data]);
		return;
	}
	
	if ($canvas.find(".dnd-mask").length){
		return;
	}
	
	this.dnd_lock=false;
	
	id=AP.uuid();
	$("<div id='"+id+"' class='dnd-mask'>" +
		"<div style='display:none'>" +
		"	<form name='dnd-form' id='"+id+"-form' action='"+url+"'></form>" +
		"</div>" +
		"<div class='mask full-mask'></div>" +
		"<div class='cancel' onclick='dnd_cancel(this);'>" +
		"	<span class='-ap icon-uniF109'></span>" +
		"	<div class='text'>Cancel</div>" +
		"</div>" +
		"<div class='dnd-main'><div class='inner'>" +
		"	<div class='dnd-image'><img src='"+Client.share_url+"/messages/uploadbg.png'/></div>" +
		"	<div class='dnd-title'>Drop the file to start uploading ...</div>" +
		"</div></div>" +
	"</div>").appendTo($cx);
	
	var $box=$("#"+id);
	if (options.layout=='dark'){
		$box.addClass('-dark');
	}
	
	var supported = function() {
		  var div = $box[0];
		  return (('draggable' in div) || ('ondragstart' in div && 'ondrop' in div)) && 'FormData' in window && 'FileReader' in window;
	}();
	
	if (!supported){
		$.log("FILE DRAG AND DROP DISABLED");
		return;
	}
	
	$canvas.on("dragstart dragover", function(e){
		var dt = e.originalEvent.dataTransfer;
		if (dt && dt.types && (dt.types.indexOf ? dt.types.indexOf('Files') != -1 : dt.types.contains('Files'))) {
			$cx.addClass('-dragover');
		}
	});
	
	$cx.on('drag dragstart dragend dragover dragenter dragleave drop', function(e) {
		e.preventDefault();
		e.stopPropagation();
	}).on("dragstart", function(e){
		$cx.addClass('-dragover');
	})
	.on('dragover dragenter', function(){
		$cx.addClass('-dragover');
	})
	.on('dragleave dragend', function(){
		$cx.removeClass("-dragover");
	})
	.on('drop', function(e) {
		$cx.removeClass('-dragover');
		var droppedFiles = e.originalEvent.dataTransfer.files;
		if (AP.dnd_lock || !droppedFiles.length){
			return;
		}
		
		if (options.confirm){
			return AP.confirm(options.confirm, function(){
				AP.dnd_lock=true;
				dnd_upload("#"+id+"-form", droppedFiles, function(code){
					AP.dnd_lock=false;
					callback(code);
				},data, options);
			});
		}
		
		
		AP.dnd_lock=true;
		dnd_upload("#"+id+"-form", droppedFiles, function(code){
			AP.dnd_lock=false;
			callback(code);
		},data, options);
	});
};


AP.fileExt = function(fname) {
	var regEx = /(?:\.([^.]+))?$/;
	return regEx.exec(fname)[1];
};

function dnd_cancel(ref){
	$(ref).closest(".dnd-mask").parent().removeClass("-dragover");
};

function dnd_upload(form, files, callback, data, options){
	var $form=$(form);
	var formData=new FormData($form.get(0));
	
	for (var key in data){
		formData.set(key, data[key]);
	}
	
	for (var key in AP.ajax_data){
		formData.set(key, AP.ajax_data[key]);
	}
	
	
	formData.set("dnd", 1);
	formData.set("__code", Client.code);
	
	
	var nf=0;
	$.each(files, function(i, file) {
		if (nf > options.max_files){
			return;
		}
		
		
		if (options.image){
			var name=options.name+"-"+nf;
			if (!options.multi){
				name=options.name;
			}
			
			var imageType = /image.*/;
			if (file.type.match(imageType)) {
				formData.append(name, file, file.name);
				nf++;
			}else{
				
			}
		}else{
			var name=options.name+"-"+nf;
			if (!options.multi){
				name=options.name;
			}
			
			formData.append(name, file, file.name);
			nf++;
		}
	});
	
	formData.set("nf", nf);
	
	UI.ajaxShow();
	var url=$form.attr("action");
	if (!AP.word.isURL(url)){
		url=Client.ajax_url+"/"+url;
	}
	
	$.ajax({
		url: url,
		type: "POST",
		dataType: 'json',
		data: formData,
		processData: false,  // tell jQuery not to process the data
		contentType: false,   // tell jQuery not to set contentType,
		complete: function(){
			
		},
		success: function(data){
			UI.ajaxHide();
			var code = new Code(data);
			callback(code);
		},
		error: function(e){
			console.log(e);
			
			UI.ajaxHide();
			callback(new Code({code: 0, message: "Something wrong, or the file was too big"}));
		}
	});
	
};



function __selfaction(ref){
	var action=$(ref).data("action");
	if (action){
		var params=$(ref).data("__params");
		action(params);
	}
	
	AP.closeDialog(ref);
};

function __selectItems(ref){
	$(ref).toggleClass('selected');
	var value=parseInt($(ref).data("value"));
	var saved=$(ref).hasClass("selected");
	
	var data=$("#custom-selection").data("options");
	
	data=AP.select(data, function(e){
		if (e.value && parseInt(e.value)==value){
			if (saved){
				e.selected=1;
			}else{
				e.selected=0;
			}
		}
		return e;
	});
	
	$("#custom-selection").data("options", data)
};



function __selectItem(ref){
	var index=$(ref).parent().find(".li").index(ref);
	var $canvas=$(ref).closest(".__canvas");
	var $fn=$canvas.data("callback");
	AP.closeDialog(ref);
	
	return $fn($canvas.data("object")[index]); 
};




function __final_select_items(ref){
	var $canvas=$(ref).closest(".__canvas");
	var data=$("#custom-selection").data("options");
	var $fn=$("#custom-selection").data("callback");
	
	data=AP.select(data, function(e){
		if (e.selected){
			return e;
		}
		return null;
	});
	
	$fn(data);
	AP.closeDialog(ref);
};




var CustomDialogEngine=new function __CustomDialogEngine(){
	
	this.canvas=function(){
		return $("#apdialogs");
	};
	
	/**
	 * @desc Render the dialog.
	 */
	this.render=function(dialog){	
		var close_button="";
		if (dialog._close_button){
			close_button="<div class='__close_button' onclick='AP.closeDialog(this);'><span class='-ap icon-close'></span></div>";
		}
		
		
		var closable="<div class='full-mask' onclick='AP.closeDialog(this);'></div>";
		if (!dialog._closable){
			closable="<div class='full-mask'></div>";
		}
		
		
		$(dialog.canvas()).append("" +
			"<div class='__customdialog' id='"+dialog.w(true)+"'>" +
				"<div class='__dialogwrapperscroller scroll-y forced-scroll'>"+
					closable +
					"<div class='__dialogwrapper'>" +
						"<div class='__dialogwrapper-inner'>" +
							"<div class='__dialogmain'>" +
								"<div class='__dialogtitle ap-xdot'>"+"&nbsp;</div>"+
								close_button+
								"<div class='__dialogcontent simple-form'></div>" +
							"</div>"+
						"</div>"+
					"</div>" +
					"<div class='clear'></div>"+
				"</div>"+
			"</div>");
	};
	
	
	/**
	 * @desc Balancing the dialog.
	 */
	this.balance=function(dialog){
		var wid=dialog.w();
		$(wid).css("right", $.sbWidth());
		
		var t=$(window).height()/2- $(wid+' .__dialogwrapper').height()/2-45;
		if (!Client.native && !Client.mobile){
			var l=$(window).width()/2- $(wid+' .__dialogwrapper').outerWidth(true)/2;
			$(wid+' .__dialogwrapper').css('left', l);
		}else{
			if (dialog._data && dialog._data.full){
				$(wid+' .__dialogwrapper').css({float: 'none'}).css({width: '100%'}).css({margin: 'auto'});				
			}else{
				$(wid+' .__dialogwrapper').css({float: 'none'}).css({width: '90%'}).css({margin: 'auto'});
			}

		}
		
		if (t<50){
			t=50;
		}
		
		if (dialog._data && dialog._data.full){
			$(wid+' .__dialogwrapper').css('top', 0).css('bottom', 0);
		}else{
			$(wid+' .__dialogwrapper').css('top', t);	
		}
	};
};






var EmptyDialogEngine=new function __EmptyDialogEngine(){
	
	this.canvas=function(){
		return $("#apdialogs");
	};
	
	/**
	 * @desc Render the dialog.
	 */
	this.render=function(dialog){	
		var closable="<div class='full-mask' onclick='AP.closeDialog(this);'></div>";
		if (!dialog._closable){
			closable="<div class='full-mask'></div>";
		}
		
		$(dialog.canvas()).append("" +
			"<div class='__customdialog __emptydialog' id='"+dialog.w(true)+"'>" +
				closable +
				"<div class='__dialogwrapper'>" +
					"<div class='__dialogwrapper-inner'>" +
						"<div class='__dialogmain'>" +
							"<div class='__dialogcontent'></div>" +
						"</div>"+
					"</div>"+
				"</div>"+
			"</div>");
	};
	
	
	/**
	 * @desc Balancing the dialog.
	 */
	this.balance=function(dialog){
		var wid=dialog.w();
		var t=$(window).height()/2- $(wid+' .__dialogwrapper').outerHeight(true)/2-45;
		if (!Client.native && !Client.mobile){
			var l=$(window).width()/2- $(wid+' .__dialogwrapper').outerWidth(true)/2;
			$(wid+' .__dialogwrapper').css('left', l);
		}else{
			if (dialog._data && dialog._data.full){
				$(wid+' .__dialogwrapper').css({float: 'none'}).css({width: '100%'}).css({margin: 'auto'});				
			}else{
				$(wid+' .__dialogwrapper').css({float: 'none'}).css({width: '90%'}).css({margin: 'auto'});
			}

		}
		
		if (t<50){
			t=50;
		}
		
		if (dialog._data && dialog._data.full){
			$(wid+' .__dialogwrapper').css('top', 0).css('bottom', 0);
		}else{
			$(wid+' .__dialogwrapper').css('top', t);	
		}
	};
};
















var styles = [
 'color: #2a91d6', 'display: block', 'margin: 5px 0', 'line-height: 40px', 'text-align: center', 
 'font-size: 22px', , 'font-weight: bold'
].join(';');

//http://baseinc.talent.vn/
console.log('%c Wow, you find us! Join Base.vn now >>> https://baseinc.talent.vn ', styles);
var Tag=new function __Tag(){
	this.use_context=1;
	this.__log_people=null;
	
	this.context=function(flag, people){
		this.use_context=flag;
		
		this.__log_people=null;
		if (flag && people){
			this.__log_people=people;
		}
	};
	
	this.people=function(){
		if (Client.pageData.context && this.use_context){
			if (Client.pageData.context.__people){
				return Client.pageData.context.__people;
			}
			
			if (this.__log_people){
				return this.__log_people;
			}
			
			Client.pageData.context.__people=AP.array.filter(Client.people, function(p){
				return hasUser(Client.pageData.context.followers, p) || hasUser(Client.pageData.context.owners, p); 
			});

			if (!Client.pageData.context.__people.length){
				return Client.people;		
			}
			
			return Client.pageData.context.__people;
		}
		
		return Client.people;
	};
	
	
	this.line=function(input){
		if (!$(input).length){
			return;
		}
		return $(input).apcomplete('api/tag/user', true);
	};
	
	
	this.singleUser=function(input, array){
		if (!$(input).length){
			return;
		}
		
		$(input).data("single-tag", 1);
		
		this.user(input, array);
	};

	
	this.user=function(input, array, callback){
		if (!$(input).length){
			return;
		}
		
		
		$(input).attr('autocomplete', 'off');

		if (AP.data.isInt(array) || array=="auto"){
			var id=array;
			if (array=="auto"){
				id=0;
				if (Client.data.network){
					id=Client.data.network.id;
					alert(id);
				}
			}
			
			return $(input).each(function(){
				$(this).tag(Client.people, function(item){
					return "<span class='image'><img src='"+AP.xthumb(item.gavatar)+"'></span> <span class='block ap-xdot'><span class='bold'>"+item.value+"</span> &middot; <span class='sub'>"+item.name+" &middot; "+___(item.title,"<em>No official title</em>")+"</span></span>";
				}, function(item, q){
					var str="";
					if (item && item.keywords){
						str+=item.keywords;
					}
					
					if (item && item.name){
						str+=item.name;
					}
					
					item.__keywords=str;
					
					if (AP.word.fulltextMatch(str, q) && (!id || AP.array.contain(item.networks, id))){
						if (!item.value){
							item.value="@"+item.username;
						}
						
						return true;
					}
					
//					if (item && item.name && item.name.toLowerCase().indexOf(q.toLowerCase())>-1 && (!id || AP.array.contain(item.networks, id))){
//						if (!item.value){
//							item.value="@"+item.username;
//						}
//						
//						return true;
//					}
					
					return false;
				}, function(item, q){
					return Tag.order_fn(item, q);
				}, callback);
			});
		}
		
		
		
		if (array && array.length){
			return $(input).each(function(){
				$(this).tag(array, function(item){
					return "<span class='image'><img src='"+AP.xthumb(item.gavatar)+"'></span> <span class='block ap-xdot'><span class='bold'>"+item.value+"</span> &middot; <span class='sub'>"+item.name+" &middot; "+___(item.title,"<em>No official title</em>")+"</span></span>";
				}, function(item, q){
					if (!item.value){
						item.value="@"+item.username;
					}
					
					var keywords=item.__keywords;
					var qf=purify(q.toLowerCase()).replace(/[\s\-]/g,'');
					
					if (!keywords){
						keywords=item.name;
						if (item.keywords){
							keywords+=item.keywords;
						}
						
						if (item.name){
							keywords+=item.name;
						}
						
						if (item.name){
							keywords+=item.title;
						}
						
						keywords=purify(keywords.toLowerCase()).replace(/[\s\-]/g,'');
						item.__keywords=keywords+' ';
					}
					
					if (keywords && keywords.indexOf(qf)!=-1){
						return true;
					}
					
					return false;
				}, function(item, q){
					return Tag.order_fn(item, q);
				}, callback);
			});
		}
		
		
		return $(input).each(function(){
			$(this).tag('api/tag/user', function(item){
				return "<span class='image'><img src='"+AP.xthumb(item.gavatar)+"'></span> <span class='block ap-xdot'><span class='bold'>"+item.value+"</span> &middot; <span class='sub'>"+item.name+" &middot; "+___(item.title,"<em>No official title</em>")+"</span></span>";
			}, function(value, q){
				if (value && value.length && value.toLowerCase().indexOf(q.toLowerCase())>-1){
					return true;
				}
				return false;
			}, function(item, q){
				return Tag.order_fn(item, q);
			});
		});
	};
	
	
	
	this.team=function(input){
		var sources=AP.select(Client.units, function(e){
			return {id: e.id, path: e.path, label: "<b>"+e.name+"</b> /"+e.path, value: e.name+" (@"+e.path+")"}
		});
		
		return $(input).each(function(){
			var $this=$(this);
			return $(this).autocomplete({
				source: function(request,response){
					// delegate back to autocomplete, but extract the last term
					var q=ap_extractLast(request.term);
					if (q && q.length && q[0]=="@"){
						q=q.substr(1);
					}
					response($.ui.autocomplete.filter(sources, q));
				},
				focus: function() {
					// prevent value inserted on focus
					return false;
				},select: function( event, ui ) {
					var terms = $(this).val().split(/,\s*/);
					terms.pop();
					terms.push(ui.item.value);
					terms.push("");
					this.value=terms.join(", ");
					return false;
				}
			}).data("ui-autocomplete")._renderItem = function(ul, item) {
				return $("<li>").data("item.autocomplete", item).append("<a>" + item.label + "</a>").appendTo(ul);
			};
		});
	};
	
	
	this.teamOptions=function(){
		var sources=AP.render(Client.units, function(e){
			if (e.metatype=="user"){
				return "";
			}
			return "<option value='"+e.id+"'>"+e.name+"</option>";
		});
		
		sources="<option value='0'>-- Select team --</option>"+sources;
		
		return sources;
	};
	
	
	this.teamSelect=function(selector, context){
		this.team(selector);
	};
	
	
	this.teamExtend = function(input){
		var sArray = Client.units;
		if (Client.units && Client.units.length){
			for(var i = 0; i < Client.units.length; i++) {
				var test = AP.array.findObj(Client.units, Client.units[i].id);
				if(test) {
				}else{
					sArray.push(Client.units[i]);
				}
			}
		}
		
		var sources = AP.select(sArray, function(e){
			return {id: e.id, path: e.path, label: "<b>"+e.name+"</b> /"+e.path, value: e.name+" (@"+e.path+")"}
		});
		
		return $(input).each(function(){
			var $this = $(this);
			return $(this).autocomplete({
				source: function(request,response){
					// delegate back to autocomplete, but extract the last term
					var q=ap_extractLast(request.term);
					if (q && q.length && q[0]=="@"){
						q=q.substr(1);
					}
					response($.ui.autocomplete.filter(sources, q));
				},
				focus: function() {
					// prevent value inserted on focus
					return false;
				},select: function( event, ui ) {
					var terms = $(this).val().split(/,\s*/);
					terms.pop();
					terms.push(ui.item.value );
					terms.push("");
					this.value=terms.join(", ");
					return false;
				}
			}).data("ui-autocomplete")._renderItem = function(ul, item) {
				return $("<li>").data("item.autocomplete", item).append("<a>" + item.label + "</a>").appendTo(ul);
			};
		});	
	};
	
	
	this.networkValues=function(teams){
		var text="";
		for (var i=0; i<teams.length; i++){
			text+=teams[i].name+" (@"+teams[i].path+"), ";
		}
		
		return text;
	};
	
	
	
	this.order_fn=function(item, q){
		q=q.toLowerCase();
		var username=item.username.toLowerCase();
		
		if (q==username){
			return 10;
		}
		
		if (username.indexOf(q)==0){
			return 9;
		}
		

		return 1;
	};
	
	
	
	
	function hasUser(users, user){
		return AP.array.contain(users, user, function(e, f){
			return e.username==f.username;
		});
	};
};
var Form=new function __Form(){
	this.render=function(canvas, options){
		if (!options){
			options={};
		}
		
		var $c=$(canvas);
		if ($c.data("role")=="material" || $c.data("role")=="flat" || options.role=="flat"){
			$c.materialForm();
		}
		
		$c.find(".select-m").each(function(){
			var $this=$(this);
			$this.find(".option").each(function(){
				setMState(this);
				
				$(this).click(function(){
					updateMState(this);
				});
			});
		});
		
		$c.find("input, select, textarea").each(function(){
			var tagname=$(this)[0].nodeName.toLowerCase();
			
			if (tagname=="select"){
				var val=$(this).data("value");
				if (val===null || typeof val=="undefined" || val===""){
				}else{
					$(this).val(val);
				}
			}
			
			if ($(this).is(':checkbox')){
				var val=$(this).data("value");
				if (val==1 || parseInt(val)==1){
					$(this).prop("checked", true);
				}else{
					$(this).prop("checked", false);
				}
				
				return;
			}
			
			if ($(this).data("cid")){
				if (tagname=="input" || tagname=="textarea"){
					var val=$(this).data("value");
					if (val===null || typeof val=="undefined"){
					}else{
						$(this).val(val);
					}
				}
			}
			
			if (tagname=="textarea"){
				if ($(this).data("autoexpand") || $(this).data("autoextend")){
					$(this).autoExpand();
				}
			}
			
			if ($(this).data("unit")){
				var unit=$(this).data('unit');
				var icon="<span class='unit-text' style='position: absolute; right:10px; top:9px; color:#aaa; font-size:12px; text-transform:uppercase'>"+(unit)+"</span>";
				$(this).parent().append(icon);
			}
			
			if ($(this).data("label") && tagname=="input"){
				var label=$(this).data('label');
				var icon="<span style='position: absolute; display:none; right:10px; top:9px; color:#aaa; font-size:12px;' class='unit-text js-input-xlabel'>"+(label)+"</span>";
				$(this).parent().append(icon);
				$(this).on("input focus", function(){
					var v=$(this).val();
					if (v && v.length){
						$(this).parent().find(".js-input-xlabel").show();
					}else{
						$(this).parent().find(".js-input-xlabel").hide();
					}
				}).trigger("input");
			}
			
			var role=$(this).data("role");
			if (!role || !role.length){
				return;
			}
			
			if (role=="markdown"){
				return $(this).markdownEditor();
			}
			
			if (role=="date"){
				var val=$(this).data("value");
				if (val){
					$(this).data("ts", val);
				}else{
					val=$(this).val();
					if (val && val.length && AP.data.isInt(val)){
						$(this).data("ts", val);	
					}	
				}
				
				$(this).attr("autocomplete", "off");
				return $(this).selectDate();
			}
			
			if (role=="drive"){
				Base.drive.init(this, $(this).data("multi"));
			}
			
			if (role=="editor"){
				var height=$(this).data("height");
				if (!height){
					height=200;
				}
				
				return UI.editor(this,{
					minHeight: height
				});
			}
			
			if (role=="day" && tagname=="select"){
				var opts="<option> -- Chọn ngày --</option>";
				for (var i=1; i<=31; i++){
					opts+="<option value='"+i+"'>"+AP.data.zeroPrefix(i)+"</option>";
				}
				$(this).html(opts);
			}
			
			
			if (role=="month" && tagname=="select"){
				var opts="<option> -- Chọn tháng --</option>";
				for (var i=1; i<=12; i++){
					opts+="<option value='"+i+"'>"+AP.data.zeroPrefix(i)+"</option>";
				}
				$(this).html(opts);
			}
			
			
			if (role=="year" && tagname=="select"){
				var opts="<option> -- Chọn năm --</option>";
				for (var i=2015; i>1960; i--){
					opts+="<option value='"+i+"'>"+AP.data.zeroPrefix(i)+"</option>";
				}
				$(this).html(opts);
			}
			
			if (role=="time"){
				return $(this).selectTime();
			}
			
			if (role=="teams"){
				return Tag.team(this, $(this).data("context"));
			}
			
			if (role=="team"){
				return Tag.teamSelect(this, $(this).data("context"));
			}

			if (role=="users" || role=="tag"){
				var context=$(this).data("context");
				if (context && context=="global"){
					return Tag.user(this, Client.people);
				}
				
				if (context){
					return Tag.user(this);
				}else{
					return Tag.user(this, Tag.people());
				}
			}
			
			if (role=="user"){
				Tag.singleUser(this, Tag.people());
			}
			
			
			if (role=="int"){
				return better_int_enter($(this));
			}

		});
		
		$c.find("input, select, textarea").each(function(){
			var tagname=$(this).tagName();
			if ($(this).data("display")==1){
				var v=$(this).val();
				if (tagname=="select"){
					v=$(this).find("option:selected").text();
				}
				
				if (v===null || v==""){
					v="--- &nbsp;";
				}
				
				if (tagname=="textarea"){
					v=v.nl2br();
				}
				
				if ($(this).attr("type")=="hidden"){
					return;
				}
				
				$(this).hide().after("<div class='vd' data-name='"+$(this).attr('name')+"' title='"+tagname+"'>"+v+"</div>");
			}
		});
		
		$c.find(".js-select-tags").each(function(){
			
		});
		
	};
	
	this.edit=function(options, callback){
		options=$.extend({},{type: "input","name":"input", "button":"Edit now","placeholder":"content", data:{}, editor: 0}, options);
		options.callback=callback;
		
		var id=AP.uuid();
		var style='';
		if (options.height){
			style='height: '+options.height+"px;";
		}
		
		var title='<br>';
		if (options.title){
			title="<div class='bold ap-f18 center'>"+options.title+"</div><br>";
		}
		
		if (!options.content){
			options.content='';
		}
		
		if (!options.editor){
			options.content=safe(options.content);
			options.content=options.content.replace(/\{\{\@([a-zA-Z0-9]+)\}\}/g,'@$1');
		}else{
			
		}		
		
		
		var html="<form id='"+id+"' action='"+options.action+"'>" +title+
				"<textarea class='__input' name='"+options.name+"' placeholder='"+options.placeholder+"' style='"+style+"'>"+options.content+"</textarea>" +
				"<div class='buttons -two'>" +
				"	<div class='button -first -passive-2 -rounded' onclick='AP.closeDialog(this)'>Cancel</div>" +
				"	<div class='button -second -success -rounded' onclick='Form.editNow(this);'>"+options.button+"</div>" +
				"</div>" +
			"</form>";
		
		AP.customDialog(html).width(500).show();
		$("#"+id).data("object", options).find(".__input").autofocus();
		
		if (options.editor){
			UI.editor("#"+id+" textarea");
			$("#"+id+" textarea").closest('.trumbowyg-box').css("border","1px solid #ddd");
		}
	};
	
	
	this.editNow=function(ref){
		var $form=$(ref).closest("form");
		var obj=$form.data("object");
		AP.ajaxShow();
		
		AP.submit($form, function(code){
			AP.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			AP.closeDialog(ref);
			obj.callback(code);
		},obj.data);
	};
	
	
	this.convert=function(data, filter){
		if (filter){
			var f=AP.array.filter(data, filter);
			
			return AP.array.select(f, function(e){
				return {label: e.name, value: e.id};
			});
		}
		
		return AP.array.select(data, function(e){
			if ("id" in e){
				return {label: e.name, value: e.id};
			}
			
			return {label: e.value, value: e.key};
		});
	};
	
	this.create= function(id, options){
		return new UIForm(id, options);
	};
	
	
	this.pop=function(options){
		return new UIPopForm(options);
	};
	
	this.hide=function(ref){
		if (AP.data.isString(ref) && ref.charAt(0)!="#"){
			ref="#"+ref;
		}
		
		if (Client.native){
			var dx=$(ref).closest(".page");
			if (dx && dx.length){
				return Page.back();
			}
		}
		
		var dx=$(ref).closest(".__apdialog");
		if (dx && dx.length){
			AP.dialog("#"+dx.attr('id')).hide();	
		}
	};
	
	
	this.balance=function(ref){
		if (AP.data.isString(ref) && ref.charAt(0)!="#"){
			ref="#"+ref;
		}
		
		var dx=$(ref).closest(".__apdialog");
		if (dx && dx.length){
			AP.dialog("#"+dx.attr('id')).balance();	
		}
	};
	
	
	this.submit=function(ref, callback, data){
		if (!data){
			data={};
		}
		
		if (ref.charAt(0)!="#"){
			ref="#"+ref;
		}
		
		UI.ajaxShow();
		AP.submit(ref, function(code){
			UI.ajaxHide();
			callback(code);
		}, data);
	};
	
	
	this.submitFrom= function(ref, callback, data){
		if (!data){
			data={};
		}
		
		var form=$(ref).closest('form');
		if (!form || !form.length){
			$.log("No form can be founed.");
			return;
		}
		
		var id;
		
		if (!form.attr('id') || !form.attr('id').length){
			var tid=AP.uuid();
			form.attr('id',tid);
			id=tid;
		}else{
			id=form.attr('id');
		}
		
		id='#'+id;
		
		AP.ajaxShow();
		AP.submit(id, function(code){
			AP.ajaxHide();
			callback(code);
		}, data);
	};
	
	
	this.val=function(form, data){
		$("input, textarea, select", form).each(function(){
			var name=$(this).attr('name');
			if (name && name.length){
				if (!data[name]){
					data[name]="Not provided";
				}
				$(this).val(data[name]);
			}
		});
	};
	
	
	this.radioVal=function(canvas, name, preset_val){
		$(canvas).find(".li").each(function(){
			var name=$(this).data('name');
			var val=$(this).data('value');
			if (name.length){
				if (AP.data.equal(val, preset_val)){
					$(this).find(".radio-button").addClass('active');
				}
			}
		});
	};

	

	this.match=function(form, data){
		$("input, textarea", form).each(function(){
			var name=$(this).attr('name');
			if (name && name.length){
				if (!data[name]){
					data[name]="Not provided";
				}
				$(this).val(data[name]);
				$(this).hide();
				$(this).parent().addClass("real-display");
				$(this).after("<div class='real'>"+data[name]+"</div>")
			}
		});
	};
	

	
	this.objSelection=function(arr){
		return AP.array.select(arr, function(e){
			return {label: e.name, value:e.id};
		})
	};
	
	
	this.label= function(data){
		return new UILabel(data);
	};
	
	
	this.noLabel = function(){
		return new UILabel(null);
	};
	

	this.row=function(label, input){
		return new UIRow(label, input);
	};
	
	this.placeholder=function(id, raw_html){
		if (!raw_html){
			raw_html='';
		}
		
		return new UIRow(id, {raw_html: raw_html}, "placeholder");
	};
	
	this.rowHidden=function(label, input){
		input.hidden=true;
		return new UIRow(label, input);
	};
	
	this.rowNone=function(label, input){}
	
	this.noRow=function(label){
		return new UIRow(label, null);
	};

	
	this.rowCustom=function(html, opts){
		return new UIRow(html, opts, "custom-html");
	};
	
	
	this.note=function(note, type){
		return (new UIRow(note, type,"note")).setType("note");
	};
	
	
	this.input=function(data){
		return new UIInput(data);
	};
	
	this.inputHTML=function(html){
		return new UIInputHTML(html);
	};
	
	this.inputGroup=function(data){
		return new UIInputGroup(data);
	};
	
	this.wrapper=function(label, id){
		return new UIRow(label, id, "wrapper");
	};

	
	this.inlineCleaner=function(canvas){
		$(canvas).click(function(e){
			$(canvas).find(".activated").each(function(){
				if ($.contains(this, e.target) || this==e.target || $(e.target).closest(".ui-datepicker-header").length){
				}else{
					$(this).removeClass("activated");
				}
			});
		});
	};
	
	
	this.inlineDatePicker=function(selector, callback, options){
		options=$.extend({
			clickOut: false,
			click: false,
			auto: true
		}, options);
		
		var id=AP.uuid();
		
		if ($(selector).hasClass("ap-inline-datepicker-wrap")){
			return;
		}else{
			$(selector).addClass("ap-inline-datepicker-wrap unselectable");
			$(selector).append("<div class='ap-inline-datepicker'><div class='ap-datepicker' id='"+id+"'></div></div>");
		}
		
		if (options.position){
			if (options.position.top){
				$(selector).find(".ap-inline-datepicker").css("top", options.position.top);
			}
			
			if (options.position.left){
				$(selector).find(".ap-inline-datepicker").css("left", options.position.left);
			}
			
			if (options.position.right){
				$(selector).find(".ap-inline-datepicker").css({"left": "auto", "right": options.position.right});
			}
		}
		
		
		var dd=0;
		if (options.value){
			dd=new Date(parseInt(options.value) * 1000);
		}
		
		$("#"+id).datepicker({
			firstDay: 1,
			defaultDate: dd,
			onSelect: function(dateText, inst){
				var day=new Date(dateText);
				var ms = day.valueOf();
				var s = Math.floor(ms / 1000);
				callback.call($(this).closest(".ap-inline-datepicker-wrap")[0], s);
				$("#"+id).closest(".ap-inline-datepicker-wrap").removeClass("activated");
			}
		});
	
		if (options.clickOut){
			$(selector).click(function(){
				$(this).toggleClass("activated");
			}).clickOut(function(){
				$(this).removeClass("activated");
			});
		}else{
			$(selector).data("__jsoptions", options);
			$(selector).click(function(e){
				if ($(e.target).closest(".ui-datepicker-header").length){
				}else{
					if (options.click){
						$(this).addClass("activated");
					}else if (options.auto){
						$(this).toggleClass("activated");
					}
				}
				
				if (!$(this).hasClass("activated")){
					var $box=$(this).closest(".ap-inline-datepicker-wrap");
					var opts=$box.data("__jsoptions");
					if (opts.hide){
						opts.hide.apply($box, []);
					}
				}
			});
		}
		
		if (options.click){
			$(selector).click();
			return;
		}
	};
	
	
	/**
	 * @desc Inline color selector
	 */
	this.inlineColorTagger=function(selector, callback, options){
		if (callback=="set"){
			
			$(selector).find(".ap-color").each(function(){
				var val=$(this).data("color");
				if (parseInt(val)==parseInt(options)){
					$(this).addClass("selected");
					$(this).siblings().removeClass("selected");	
				}
			});
			
			return;
		}
		
		
		if ($(selector).hasClass("ap-inline-colors-wrap")){
			
		}else{
			var colors=AP.render(range(0,9), function(e){
				return "<div class='ap-color -bg-alt"+e+"' data-color='"+e+"'></div>";
			});
			
			$(selector).addClass("ap-inline-colors-wrap unselectable").append("<div class='ap-inline-colors'>" +
				"<div class='apir'></div>" +
				"<div class='ap-inline-title'>Select color</div>" +
				"<div class='ap-inline-box'>"+colors+"</div>" +
			"</div>");
			
			$(selector).find(".ap-color").click(function(){
				var color=$(this).data("color");
				$(this).addClass("selected");
				$(this).siblings().removeClass("selected");
				
				if (callback){
					$(this).closest(".ap-inline-colors").hide();
					callback.call(this, color);
				}
			});
			
			if (options.auto){
				$(selector).click(function(e){
					if (!$(e.target).hasClass("ap-color")){
						$(this).find(".ap-inline-colors").toggle();	
					}
				});
				
			}
			
			if (options.left){
				$(selector).find(".ap-inline-colors").css({left: options.left}).find(".apir").css({left: -options.left+10});
			}
			
			if (options.click && !$(selector).hasClass("__inited")){
				$(selector).addClass("__inited").find(".ap-inline-colors").show();
			}
		}
	};
	
	
	this.inlineTagger=function(selector, options){
		if ($(selector).hasClass("ap-inline-tagger-wrap unselectable")){
			if (options.click){
				// $(selector).find(".-close").click();
				// $(selector).addClass("activated");
			}
			
			return;
		}
		
		options=$.extend({}, {label: "Type to search", multi: false, users: Client.people}, options);
		var multi="multi";
		if (!options.multi){
			multi="single";
		}
		
		var users=AP.render(options.users, function(e){
			if (options.filter && !options.filter(e)){
				return "";
			}
			
			return "<div class='api-user' data-username='"+e.username+"' data-kw='"+e.name+" "+e.username+" "+e.title+"'>" +
				"<div class='avatar avatar-24 -circled'><div class='image'><img src='"+AP.xthumb(e.gavatar)+"'/></div></div>" +
				"<div class='api-context'><div class='api-name'>"+e.name+"</div> <div class='api-info ap-xdot'>"+e.title+"</div></div>" +
			"</div>";
		});
		
		if (options.remove){
			users+="<div class='api-user' data-kw='' data-cancel='1'>" +
				"<div class='avatar avatar-24 -circled'><div class='c'><div class='-ap icon-close' style='padding-top:2px;'></div></div></div>" +
				"<div class='api-context'><div class='api-name'><div class='red normal' style='padding-top:4px'>Remove</div></div></div>" +
			"</div>";
		}
		
		
		var id=AP.uuid();
		$(selector).addClass("ap-inline-tagger-wrap unselectable");
		
		var title="";
		if (options.title){
			title="<div class='api-title'>"+options.title+"</div>";
		}
		
		var footer="";
		if (options.footer){
			footer="<div class='api-footer'>"+(options.footer)+"</div>";
		}
		
		$(selector).append("<div class='-close full-mask'></div> <div class='ap-inline-tagger'><div id='"+id+"' class='ap-tagger is"+multi+"'>" +
			title +
			"<div class='api-sb'><input type='text' placeholder='"+options.label+"'/></div>" +
			"<div class='api-users'>"+users+"</div>" +
			footer+
		"</div></div>");
		
		
		
		
		if (options.width){
			$(selector).find(".ap-inline-tagger").css("width", options.width);
		}
		
		if (options.position){
			if (options.position.top){
				$(selector).find(".ap-inline-tagger").css("top", options.position.top);	
			}
			
			if (options.position.left){
				$(selector).find(".ap-inline-tagger").css("left", options.position.left);	
			}
			
			if (options.position.right){
				$(selector).find(".ap-inline-tagger").css({"right": options.position.right, left: "auto"});	
			}
		}
		
		$(selector).data("__jsoptions", options);
		$(selector).find(".-close").click(function(){
			$(this).parent().toggleClass("activated");
			
			if (!$(this).parent().hasClass("activated")){
				var $box=$(this).closest(".ap-inline-tagger-wrap");
				var opts=$box.data("__jsoptions");
				if (opts.hide){
					opts.hide.apply($box, []);
				}
			}
		});			
		
		
		$(selector).find(".api-user").on("click", function(){
			var cancel=$(this).data("cancel");
			if (cancel){
				var $box=$(this).closest(".ap-inline-tagger-wrap");
				var opts=$box.data("__jsoptions");
				opts.remove.apply($box, []);
				$(this).closest(".ap-inline-tagger-wrap").removeClass("activated");
				return;
			}
			
			var username=$(this).data("username");
			var user=People.get(username);
			if (user){
				options.select.apply($(this).closest(".ap-inline-tagger-wrap"), [user, $(this).closest(".ap-inline-tagger-wrap")]);
				$(this).closest(".ap-inline-tagger-wrap").removeClass("activated");
			}
		});
		
		
		if (options.search || $(selector).find(".api-sb").length){
			$(selector).find(".api-sb input").quickFilter($(selector).find(".api-users .api-user"),function($e, q){
				q=AP.purify(q);
				var kw=$e.data("kw").toLowerCase();
				if (kw.indexOf(q.toLowerCase())!=-1){
					return true;
				}
				
				return false;
			});
		}
		
		
		if (options.click){
			$(selector).find(".-close").click();
		}
	};
	
	
	

	this.inlineLabelTagger=function(selector, callback, options){
		options=$.extend({}, {label: "Type to search", multi: false, search: false, click: false, fill: false, multi: false}, options);
		
		if ($(selector).hasClass("ap-inline-tagger-wrap")){
			if (options.click){
				// $(selector).find(".-close").click();
			}
			return;
		}
		
		var multi="multi";
		if (!options.multi){
			multi="single";
		}
		
		var tags=AP.render(options.labels, function(e){
			if (options.filter && !options.filter(e)){
				return "";
			}
			
			if (options.render){
				return "<div class='js-tagitem' data-color='"+(e.color)+"' data-name='"+(e.name)+"' data-id='"+(e.id)+"' data-key='"+(e.key)+"'> "+(options.render(e))+" </div>";
			}
			
			return "<div class='api-tag js-tagitem' data-color='"+(e.color)+"' data-name='"+(e.name)+"' data-id='"+(e.id)+"' data-key='"+(e.key)+"'> <div class='square -bg-alt"+(e.color)+"'></div> <div class='api-context'><div class='api-txt'>"+(e.name)+"</div></div> </div>";
		});
		
		
		var id=AP.uuid();
		$(selector).addClass("ap-inline-tagger-wrap unselectable");
		
		
		var title="";
		if (options.title){
			title="<div class='api-title'>"+options.title+"</div>";
		}
		
		$(selector).append("<div class='-close full-mask'></div> <div class='ap-inline-tagger -compact'><div id='"+id+"' class='ap-tagger is"+multi+"'>" +
			title +
			(options.search?("<div class='api-sb'><input type='text' placeholder='"+options.label+"'/></div>"):"") +
			"<div class='api-tags'>"+tags+"</div>" +
		"</div></div>");
		
		if (options.width){
			$(selector).find(".ap-inline-tagger").css("width", options.width);
		}
		
		if (options.position){
			if (options.position.top){
				$(selector).find(".ap-inline-tagger").css("top", options.position.top);	
			}
			
			if (options.position.left){
				$(selector).find(".ap-inline-tagger").css("left", options.position.left);	
			}
			
			if (options.position.right){
				$(selector).find(".ap-inline-tagger").css({"right": options.position.right, left: "auto"});	
			}
		}
		
		
		if (!options.click){
			$(selector).find(".-close").click(function(){
				$(this).parent().toggleClass("activated");
			});	
		}else{
			$(selector).click(function(){
				$(this).toggleClass("activated");
			});
		}
		
		
		$(selector).find(".js-tagitem").on("click", function(){
			// var item=$(this).closest(".ap-tag");
			
			if (!options.multi){
				$(this).closest(".ap-inline-tagger-wrap").removeClass("activated");	
			}else{
				$(this).toggleClass("selected");
			}
			
			callback.apply($(this).closest(".ap-inline-tagger-wrap"), [this]);
		});
		
		
		if (options.search){
			$(selector).find(".api-sb input").quickFilter($(selector).find(".api-tags .api-tag"),function($e, q){
				var kw=$e.data("kw").toLowerCase();
				if (kw.indexOf(q.toLowerCase())!=-1){
					return true;
				}
				
				return false;
			});
		}
		
		if (options.selected && options.selected.length){
			$(selector).find(".js-tagitem").each(function(){
				var id=$(this).data("id");
				if (AP.data.isInt(id)){
					id=parseInt(id);
				}
				
				if (AP.array.contain(options.selected, id)){
					$(this).addClass("-selected");
				}
			});
		}
		
		if (options.click){
			$(selector).addClass("activated");
		}
	};
	
	
	
	this.editorEscape=function(content){
		content=AP.word.replaceAll('&#8221;', '\"', content);
		content=AP.word.replaceAll('&#8220;', '\"', content);
		content=AP.word.replaceAll('&#8216;', "'", content);
		
		content=AP.word.replaceAll('<br>', "\n", content);
		content=AP.word.replaceAll('"', '\"', content);
		
		return content;
	};
	
	
	
	function setMState(ref){
		var val=$(ref).data("value");
		var $input=$(ref).closest(".select-m").find("input");
		var vals=AP.word.split(",", $input.val());
		if (vals.indexOf(val)!=-1){
			active=1;
		}else{
			active=0;
		}
		
		$input.val(vals.join(","));
		
		if (active){
			$(ref).addClass("active");
		}else{
			$(ref).removeClass("active");
		}
	};
	
	
	function updateMState(ref){
		var val=$(ref).data("value");
		var $input=$(ref).closest(".select-m").find("input");
		var vals=AP.word.split(",", $input.val());
		var active=0;
		
		if (vals.indexOf(val)!=-1){
			vals=AP.array.remove(vals, val);
			active=0;
		}else{
			vals.push(val);
			active=1;
		}
		
		
		$input.val(vals.join(","));
		
		if (active){
			$(ref).addClass("active");
		}else{
			$(ref).removeClass("active");
		}
	};
};












function UIPopForm(options){
	options=$.extend({}, {id: 'popform','width': 800, label: 'Form dialog', closable: true}, options);
	this.options=options;
	this.formobj=null;
	this.html="";

	
	this.setForm=function(formObj){
		var inline="form-inline";
		if (formObj.__settings.block || Client.native || options.layout=="flat" ||  options.layout=="block" || Client.mobile){
			inline="";
		}
		
		if (Client.native){
			this.html="<div class='form form-dialog "+inline+"'><form method='post' id='"+formObj.__id+"' action='"+formObj.__options.action+"'><div class='form-main'><div class='form-scroll'>"+formObj.html()+"</div></div><div class='form-buttons'></div></form></div>";	
		}else{
			this.html="<div class='form form-dialog "+inline+"'><form method='post' id='"+formObj.__id+"' action='"+formObj.__options.action+"'>"+formObj.html()+"<div class='form-buttons'></div></form></div>";
		}
		
		
		this.formObj=formObj;
		return this;
	};
	
	this.show=function(){
		if (Client.mobile){
			this.options.width='100%';
		}
		
		if (Client.native){
			this.options.engine=FormDialogMobile;
			AP.dialog(this.options.id, FormDialogMobile)
			.title("<div class='title-1 ap-xdot'>"+this.options.label+"</div>")
			.content(this.html)
			.show();
		}else{
			if (this.options.sublabel){
				this.options.engine=FormDialogEngine2;
				AP.dialog(this.options.id)
				.engine(FormDialogEngine2)
				.width(this.options.width, AP.mobile)
				.title("<div class='title-1'>"+this.options.label+"</div><div class='title-2'>"+this.options.sublabel+"</div>")
				.content(this.html)
				.closable(this.options.closable)
				.show();
			}else{
				this.options.engine=FormDialogEngine;
				AP.dialog(this.options.id)
				.engine(FormDialogEngine)
				.width(this.options.width, AP.mobile)
				.title(this.options.label)
				.content(this.html)
				.closable(this.options.closable)
				.show();	
			}
		}
		
		

		
		this.placeButtons(this.formObj);
		this.update();
		if (this.formObj.__callback){
			(this.formObj.__callback).apply(this.formObj, [this.formObj]);
		};
		
		$("input, textarea","#"+this.formObj.__id).each(function(){
			var role=$(this).data("role");
			if (role=="date"){
				$(this).selectDate();
			}
			
			if (role=="time"){
				$(this).selectTime();
			}
			
			if (role=="tag"){
				if ($(this).data("context")=="global"){
					Tag.user(this, Client.people);
				}else{
					Tag.user(this, Tag.people());	
				}
			}
			
			if (role=="teams"){
				Tag.teamExtend(this);
			}
			if (role=="user"){
				Tag.singleUser(this, Tag.people());
			}
			
			if (role=="int"){
				better_int_enter($(this));
			}
			
			if (role=="editor"){
				
			}
		});
		
		
		$(document).on("keypress", "#"+this.formObj.__id+" input", function(event){
			if (event.keyCode == 13) {
		        event.preventDefault();
		    }
		});
		
		if (this.options.layout=="flat"){
			$("#"+this.formObj.__id).parent().addClass("-flat");
			$("#"+this.formObj.__id).find(".input-fake, select").closest(".row").addClass("-active");
			$("#"+this.formObj.__id).find("input[type=file]").closest(".row").addClass("-active");
			$("#"+this.formObj.__id).find(".input.xflat").closest(".row").addClass("-active noflat");
			
			$("#"+this.formObj.__id).find("input, textarea").each(function(){
				if ($(this)[0].type=="file"){
					return;
				}
						
				var $temp=$(this).closest(".row");
				var phv=$(this).attr('placeholder');
				if (!phv || !phv.length){
					phv=false;
				}else{
					phv=true;
				}
				
				if ($temp.hasClass("noflat") || phv){
					$temp.addClass("-active");
					return;
				}
				
				$(this).focus(function(){
					$(this).closest(".row").addClass("-active");
				}).blur(function(){
					var val=$(this).val();
					if (!val || !val.length){
						$(this).closest(".row").removeClass("-active");	
					}
				});
				
				var val=$(this).val();
				if (val && val.length){
					$(this).closest(".row").addClass("-active");
				}
			})
		}
		
		return this;
	};
	
	
	
	this.closable=function(opt){
		AP.dialog(this.options.id).closable(opt)
		
		return this;
	};
	
	
	
	this.placeButtons=function(form){
		var html=form.renderButtons();
		var count="";
		var bcount=form.__buttons.length;
		if (bcount==1){
			count="-one";
		}
		if (bcount==2){
			count="-two";
		}
		if (bcount==3){
			count="-three";
		}
		$(".form-buttons", "#"+this.options.id).html(html).addClass(count);
		
		$(".form-buttons .button", "#"+this.options.id).each(function(index){
			$(this).data("action", form.getButton(index).action);
			$(this).click(function(){
				var action=$(this).data("action");
				action();
			});
		});
	};
	
	this.update=function(){
		this.formObj.update();
		AP.dialog(this.options.id, this.options.engine).balance();
	};
	
	this.focus=function(name){
		this.formObj.focus(name);
		return this;
	};
	
	this.addClass=function(name){
		$("#"+this.options.id).closest(".__dialog").addClass(name);
		return this;
	};
	
	
};


function inputIntegerFormat(input){
	better_int_enter($(input));
};

function better_int_enter($input){
	$input.on("input", function(){
		var val=$(this).val();
		if (val.length && val.charAt(val.length-1)=="."){
			return;
		}
		
		val=val.replace(/,/g,"");

		if (AP.data.isNumber(val)){
			val=AP.data.numberFormat(val);
			$input.val(val);
		}
	}).trigger("input");
};




Form.icon=new function __FormIcon(){
	// this.icons={"heartbeat":, "idea", "grow", "star",  "box", "book", "office", "paper", "health", "report", "alarm", "chart", "time", "connect", "todo", "contact", "folder", "pin", "tag","cart", "heart"};
	
	this.icons={"heartbeat": "Health", "h-square":"House", "heart":"Heart", "gittip": "Heart 2", "wpforms": "Note form", "delicious":"Square", "adn": "A label", "bandcamp": "Trepeziod", "google-wallet": "Wallet", "pie-chart": "Pie chart", "dot-circle-o": "Dot circle", "plane":"Plane", "sun-o":"Sunny", "adjust": "Contrast", "automobile": "Automobile", "bicycle": "Bicycle", "briefcase": "Briefcase", "bug": "Bug", "bus": "Bus", "cab": "Cab", "bullseye": "Bullseye", "cutlery": "Cutlery", "birthday-cake":"Birthday Cake", "fax":"Phone & Fax", "mortar-board": "Education", "plug": "Plug", "print": "Print", "recycle":"Recycle", "shopping-bag":"Shopping Bag", "support":"Life buoy", "tv":"Television", "truck": "Truck", "tree":"Tree", "video-camera":"Camrea", "train":"Train", "credit-card":"Credit card", "ticket":"Ticket"};
	this.fav_icons=range(1,60);
	
	
	this.render=function(options){
		return "<div class='input data pointer' onclick=\"$(this).toggleClass('active')\"'> <input id='"+options.id+"' type='text' name='"+options.name+"' placeholder='Click to select icon' readonly/> <div class='icon-display' style='position:absolute; font-size:14px; color:#aaa; right:0px; bottom:9px;'></div><div class='form-icons'>"+getIcons(this.icons)+"</div></div>";
	};
	
	
	this.renderFav=function(options){
		return "<div class='input data pointer' onclick=\"$(this).toggleClass('active')\"'> <input id='"+options.id+"' type='text' name='"+options.name+"' placeholder='Click to select icon' readonly/> <div class='icon-display' style='position:absolute; font-size:14px; color:#aaa; right:0px; bottom:9px;'></div><div class='form-icons'>"+getFavIcons(this.fav_icons)+"</div></div>";
	};
	
	
	this.inlinePicker=function(){
		var html="";
		for (var i=0; i<this.fav_icons.length; i++){
			var key = this.fav_icons[i];
			html+= "<div class='sx-icon' data-value='"+(key)+"' onclick='Form.icon.selectInline(this);'> <img style='width:16px; height:16px;' src='"+(Client.share_url)+"/fav_icons/"+(key)+".png'/> </div>";
		}
		
		return "<div class='sx-icons'>"+(html)+"</div>";
	};
	
	
	
	this.select=function(ref){
		var $canvas=$(ref).closest(".input");
		var v=$(ref).data("value");
		
		$canvas.find("input").val(v);
		$canvas.find(".icon-display").html("<span class='ficon-"+v+"'></span>");
	};
	
	
	this.selectInline=function(ref){
		var $this=$(ref);
		var v=$this.data("value");
		$this.closest(".inline-icon-picker").find(".icon-display").html("<img src='"+(Client.share_url)+"/fav_icons/"+(v)+".png'/>");
		$this.closest(".inline-icon-picker").removeClass("active");
		$this.closest(".inline-icon-picker").find("*[name=icon]").val(v);
	};
	
	
	function getIcons(icons){
		var html="";
		for (var key in icons){
			html+= "<div class='form-icon' data-value='"+key+"' onclick='Form.icon.select(this);'><span class='inline ap-f14' style='width: 20px;'><span class='ficon-"+key+"'></span></span> "+icons[key]+"</div>";
		}
		return html;
	};
	
	
	function getFavIcons(icons){
		var html="";
		for (var i=0; i<icons.length; i++){
			var key = icons[i];
			html+= "<div class='form-icon' data-value='"+key+"' onclick='Form.icon.select(this);'><span class='inline ap-f14' style='width: 20px;'><img style='width:16px; height:16px;' src='"+Client.share_url+"/fav_icons/"+key+".png'/></span></div>";
		}
		return html;
	};
	
};


function __FormTouch(url, data){
	this.url=url;
	this.data={};
	
	if (url){
		this.url=url;
	}
	
	if (data){
		this.data=data;
	}
	
	this.msg_confirm=null;
	this.msg_success=null;
	
	this.success=function(msg, fn){
		this.msg_success=msg;
		this.success_fn=fn;
		return this;
	};
	
	this.confirm=function(msg){
		this.msg_confirm=msg;
		return this;
	};
	
	this.run=function(){
		if (this.msg_confirm){
			var $this=this;
			AP.confirm(this.msg_confirm, function(){
				$this.execute();
			});
			
			return;
		}else{
			this.execute();
		}
	};
	
	
	this.execute=function(){
		UI.ajaxShow();
		
		var $this=this;
		AP.post(this.url, this.data, function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			UI.flash($this.msg_success);
			$this.success_fn(code);
		});
	};
};

Form.touch=function(url, data){
	return new __FormTouch(url, data);
};


Form.list=new function __FormList(){
	this.init=function(input, options){
		options=$.extend({}, {url: "", data: {}, placeholder:"Type the next line here"}, options);
		if (options.__data){
			options.data=$.extend(options.data, options.__data);
		}
		
		options.name=$(input).attr("name");
		
		$(input).each(function(){
			var $input=$(this);
			var simple=($input.data("role")=="simple");
			
			var id=AP.uuid();
			$input.addClass("-js-value").wrap("<div class='line-inputs' id='"+id+"'></div>");
			$input.wrap("<div class='hidden'></div>");
			$("#"+id+"").data("options", options).append("<div class='js-lines'></div>");
			
			var value="";
			if (options.value){
				value=options.value;
			}
			
			if (!value && $input.val() && $input.val().length){
				value=$input.val();
			}
			
			initRow($input[0], value);
		});
	};
	
	
	/**
	 * @desc Directly set values
	 */
	this.setValue=function(input, value){
		$(input).each(function(){
			initRow(this, value);
			$(this).closest(".line-inputs").find(".hidden .-js-value").val(value);
		});
	};
	
	
	/**
	 * @desc Remove the line containing ref, update JS/textarea content
	 */
	this.removeLine=function(ref){
		var $last=$(ref).closest(".js-lines").find(".line-input.last");
		$(ref).closest(".line-input").remove();
		
		updateContent($last[0]);
	};
	
	
	function initRow(ref, value){
		var $c=$(ref).closest(".line-inputs");
		var id=$c.attr("id");
		var options=$c.data("options");
		var html="";
		var attrs="";
		if (options.data.taggable){
			attrs+="data-role='tag'";
		}
		
		if (AP.data.isArray(value)){
			var rv="";
			html=AP.render(value, function(line){
				var lx=line;
				
				if (AP.data.isObject(line)){
					lx=line;
				}else{
					lx={key: AP.random.word(32), value: lx};
				}
				
				rv+=""+(lx.key)+":"+(lx.value)+"\n";
				return "<div class='line-input -real'> <textarea name='line-"+(lx.key)+"' "+(attrs)+" data-rid='"+(lx.key)+"'>"+(lx.value)+"</textarea> <div class='line-actions'> <div class='-action red' onclick='Form.list.removeLine(this)'>Remove</div> </div> </div>";
			});
			
			$(ref).val(rv);
		}else{
			var lines=value.split("\n");
			html=AP.render(lines, function(line){
				var p=safeSplit(line, ":", 2);
				if (p.length!=2){
					return "";
				}
				
				return "<div class='line-input -real'> <textarea name='line-"+(p[0])+"' "+(attrs)+" data-rid='"+(p[0])+"'>"+(p[1])+"</textarea> <div class='line-actions'> <div class='-action red' onclick='Form.list.removeLine(this)'>Remove</div> </div> </div>";
			});	
		}
		
		if (options){
			html+="<div class='line-input focus last'><textarea name='temp' "+(attrs)+" placeholder='"+(options.placeholder)+"'></textarea></div>";	
		}
		
		
		$("#"+id+" .js-lines").empty().html(html);
		Form.render("#"+id+" .js-lines");
		bindEvents("#"+id, options);
	};
	
	
	function bindEvents(canvas, options){
		$(canvas).find(".line-input textarea").each(function(){
			$(this).enter(function(){
				updateContent(this);
				saveContent(this);
			}).on("input change", function(){
				silentSync(this);
			});
		});
	};
	
	
	function updateContent(ref){
		var $c= $(ref).closest(".line-inputs");
		var html="";
		$c.find(".line-input textarea").each(function(){
			var rid=$(this).data("rid");
			var content=safe($(this).val());
			if (!content || !content.length){
				return;
			}
			
			if (!rid){
				rid=AP.random.word(32);
			}
			
			html+=rid+":"+content+"\n";
		});
		
		$c.find("textarea.-js-value").val(html);
	};
	
	
	function syncBackContent(ref){
		var $c= $(ref).closest(".line-inputs");
		var val=$c.find("textarea.-js-value").val();
		initRow(ref, val);
		$c.find(".line-input.last textarea").focus();
	};
	
	function silentSync(ref){
		var $cs= $(ref).closest(".line-inputs");
		var val="";
		
		$cs.find(".line-input textarea").each(function(){
			var rid=$(this).data("rid");
			var content=safe($(this).val());
			if (!content || !content.length){
				return;
			}
			
			if (!rid){
				rid=AP.random.word(32);
			}
			
			val+=rid+":"+content+"\n";
		});
		
		$cs.find("textarea.-js-value").val(val)
	};
	
	
	function saveContent(ref){
		var $c=$(ref).closest(".line-inputs");
		var opts=$c.data("options");
		var name=opts.name;
		
		var rid=$(ref).data("rid");
		
		if (!opts.url || !opts.url.length){
			syncBackContent(ref);
			return;
		}
		
		var data=shallowClone(opts.data);
		data[name]=$c.find("textarea.-js-value").val();
		
		UI.ajaxShow();
		AP.post(opts.url, data, function(code){
			UI.ajaxHide();
			if (code.good()){
				syncBackContent(ref);
			}
		});
	};
	
	
	
	function safeSplit(line, splitter, limit){
		var p=line.split(splitter);
		if (p.length<limit){
			return p;
		}
		
		// p.length >= limit
		
		var s=[];
		for (var i=0; i<limit-1; i++){
			s.push(p[i]);
		}
		
		var tail="";
		for (var i=limit-1; i<p.length; i++){
			tail+=p[i];
			if (i<p.length-1){
				tail+=splitter;
			}
		}
		
		s.push(tail);
		return s;
	};
};


Form.select=new function(){
	this.improve=function(selector, opts){
		$(selector).each(function(){
			Form.improveSelect(this, opts);
		});
	}
};

Form.improveSelect=function(selector, opts){
	if (!$(selector).length){
		return;
	}
	
	$(selector).hide();
	var placeholder=$(selector)[0].placeholder;
	if (!placeholder){
		placeholder='---';
	}
	
	var items=[];
	var emp=null;
	var cv=$(selector).val();
	
	opts=$.extend({search: true, with_empty: 1}, opts);
	
	$(selector).find("optgroup").each(function(){
		items.push({label: $(this).attr("label"), type: "optgroup"});
		
		$(this).find("option").each(function(){
			if (AP.data.equal(this.value, opts.empty)){
				emp="<em>"+$(this).text()+"</em>";
			}else{
				items.push({label: $(this).text(), value: this.value, selected: this.selected?1:0});	
			}
		});
	});
	
	if (!items.length){
		$(selector).find("option").each(function(){
			if (AP.data.equal(this.value, opts.empty)){
				emp="<em>"+$(this).text()+"</em>";
			}else{
				items.push({label: $(this).text(), value: this.value, selected: this.selected?1:0});	
			}
		});	
	}
	
	
	if (opts.items && !items.lenth){
		items=AP.select(opts.items, function(e){
			return {label: e.name, value: e.id};
		});
		
		if (opts.empty){
			items.unshift({label:"---", value: ""});
		}
		
		$(selector).html(AP.render(items, function(e){
			return "<option value='"+(e.value)+"'>"+(e.label)+"</option>";
		}));
	}
	
	if (placeholder=="---" && emp){
		placeholder=emp;
	}
	
	
	var $p=$(selector).parent();
	var items_html=AP.render(items, function(e){
		if (e.type && e.type=="optgroup"){
			return "<div class='is-label'>"+(e.label)+"</div>";
		}
		
		var label=e.label;
		if (opts.render){
			var fn=opts.render;
			label=fn(e.value, label);
		}
		
		return "<div class='is-item' onclick='Form.improveSelectHelper.pickup(this);' data-value='"+(e.value)+"'>"+(label)+"</div>";
	});
	
	var name=AP.uuid();
	var search="<div class='is-search'><input type='text' name='"+(name)+"' placeholder='Quick filter'/></div>";
	if (!opts.search){
		search='';
	}
	
	var html="<div class='improve-select unselectable'> <div class='is-display url' data-url=':active:parent'><div class='ap-xdot'>"+(placeholder)+"</div></div> <div class='is-box'> "+(search)+" <div class='is-scroll scroll-y url' data-url=':active:parent:parent'> <div class='is-items'>"+(items_html)+"</div> </div> </div> </div>";
	
	$p.append(html).addClass("js-improved-select");
	var tname=$p.find("select").attr("name");
	
	if (opts.multiple || opts.multi){
		$p.find("select").hide().attr("name", AP.uuid()).after("<input type='hidden' class='js-select' name='"+(tname)+"'/>");
		$p.data("multiple", 1);
	}else{
		// $p.find("select").hide().attr("name", AP.uuid()).after("<input type='hidden' class='js-select' name='"+(tname)+"'/>");
	}
	
	$p.find("input[name="+name+"]").on("input keypress", function(){
		var v=$(this).val();
		if (!v || !v.length){
			$p.find(".is-scroll").find(".is-item").show();
			return;
		}
		
		$p.find(".is-scroll").find(".is-item").each(function(){
			var txt=$(this).text();
			if (AP.word.fulltextMatch(txt, v)){
				$(this).show();
			}else{
				$(this).hide();
			}
		});
	});
	
	if (opts.multi || opts.multiple){
		if (opts.value && opts.value.length){
			$p.find(".is-item").each(function(){
				if (AP.array.contain(cv, $(this).data("value"))){
					$(this).click();
					$p.find(".improve-select").removeClass("active");
				}
			});	
		}
		
		return;
	}
	
	
	// Set current value
	if (!cv && "value" in opts){
		cv=opts.value;
	}
	
	
	$p.find(".is-item").each(function(){
		if (AP.data.equal(cv, $(this).data("value"))){
			$(this).click();
			$p.find(".improve-select").removeClass("active");
		}
	});
};



Form.improveSelectHelper=new function __FormIMPHelper(){
	this.pickup=function(ref){
		var $p=$(ref).closest(".js-improved-select");
		
		if ($p.data("multiple")){
			return this.pickupMulti(ref);
		}
		
		
		var label=$(ref).text();
		
		$(ref).siblings().removeClass("active");
		$(ref).toggleClass("active");
		
		var value=$(ref).data("value");
		if (!$(ref).hasClass("active")){
			value="";
			$p.find(".is-display div").html("---");
		}else{
			$p.find(".is-display div").html(safe(label));
		}
		
		$p.find("select").val(value).trigger("change");	
		
	};
	
	
	this.pickupMulti=function(ref){
		$(ref).toggleClass("active");
		var $p=$(ref).closest(".js-improved-select");
		
		var value=[];
		var label=[];
		
		$p.find(".is-item.active").each(function(){
			var lab=safe($(this).text());
			label.push("<span class='is-itag'>"+(lab)+"</span>");
			value.push($(this).data("value"));
		});
		
		value=AP.array.unique(value);
		
		$p.find(".is-display div").html(label.join(" ")+"&nbsp;").removeClass("ap-xdot");
		$p.find(".js-select").val(value.join(", ")).trigger("change");

	};
};


Form.v2=function(opts){
	opts=$.extend({}, {width: 450, layout:"flat"}, opts)
	var form = Form.create('form-v2-fx', {'action': opts.action});
	var focus= 'name';
	
	var hiddens = {};
	if (opts.hiddens){
		hiddens=opts.hiddens;
	}
	
	if (opts.data){
		hiddens=opts.data;
	}
	
	for (var i=0; i< opts.rows.length; i++){
		var r=opts.rows[i];
		
		if (AP.data.isArray(r)){
			var gs=[Form.v2.getIPData(r[0]), Form.v2.getIPData(r[1])];
			
			form.row(
				Form.label({label: r[0].label, extra_label: r[1].label}),
				Form.inputGroup(gs)
			).addClass("-active");
		}else{
			var ip= Form.v2.getIPData(r);
			
			if (r.type=="placeholder"){
				form.row(
					Form.label({label: r.label}),
					Form.input({name: r.name, type: "placeholder", id: r.id})
				).addClass("-active");
			}else if (r.type=="html"){
				var id=AP.uuid();
				form.placeholder(id, r.html);
			}else{
				var cx=(r.classes?r.classes:"");
				if (!cx && r.style){
					cx=r.style;
				}
				
				if (!r.label){
					cx+=" -upper";
				}
				
				if (r.hidden){
					form.rowHidden(
						Form.label({label: r.label}),
						ip
					);
				}else{
					form.row(
						Form.label({label: r.label}),
						ip
					).addClass("-active "+cx);
				}
				
				if (r.focus){
					focus=r.name;
				}
			}	
		}
	}
	
	if (opts.buttons){
		if (AP.data.isArray(opts.buttons)){
			form.buttons(opts.buttons);
		}else{
			form.buttons(opts.buttons.release());
		}
	}
	
	form.hiddens(hiddens).render(function(f){
		if (opts.render){
			opts.render.apply(f);	
		}
	});

	Form.pop({id: "form-v2-dx", width: opts.width, label: opts.title, layout: opts.layout}).setForm(form).show().focus(focus);
	
};


Form.v2.getIPData=function(r){
	if (!r.label){
		r.label="";
	}
	
	var ip_data={name: r.name, type: r.type, placeholder: r.placeholder?r.placeholder:r.label};
	
	if (r.role){
		ip_data.role=r.role;
	}
	
	if (r.data){
		ip_data.data=r.data;
	}
	
	if (r.color_picker){
		ip_data.color_picker=r.color_picker;
	}
	
	if (r.color){
		ip_data.color=r.color;
	}
	
	if (r.icon_picker){
		ip_data.icon_picker=r.icon_picker;
	}
	
	if (r.options){
		var opts = r.options;
		if (!AP.data.isArray(opts)){
			opts=[];
			for (var key in r.options){
				opts.push({value: key, label: r.options[key]});
			}
		}
		
		ip_data.options = opts;
		
		if (!ip_data.type || ip_data.type=="text"){
			ip_data.type="select";	
		}
		
		if (r.multiple || (r.data && r.data.multiple)){
			ip_data.multiple=1;
		}
	};
	
	if (r.groups){
		ip_data.optgroups = r.groups;
		ip_data.type="select";
	}
	
	if (!ip_data.type){
		ip_data.type="text";
	}
	
	if (r.empty && ip_data.type=="select"){
		ip_data.empty={label:"-- Please select --", value: 0};
		if (AP.data.isString(r.empty)){
			ip_data.empty={label: r.empty, value: 0};
		}
	}
	
	if (r.minHeight){
		ip_data.height=r.minHeight;
	}else if (r.height){
		ip_data.height=r.height;
	}
	
	if (r.unit){
		ip_data.unit=r.unit;
	}
	
	var ip=Form.input(ip_data).valueIf(r.value, "value" in r);
	if (r.css){
		ip.css(r.css);
	}
	
	if (r.height && r.role!="editor"){
		ip.css({minHeight: r.height+"px"})
	}
	
	if (r.extra){
		ip.extra(r.extra);
	}
	
	return ip;
}


Form.v2.hide=function(){
	return Form.hide("form-v2-fx");
};

Form.v2.submit=function(callback){
	return Form.submit("#form-v2-fx", callback);
};

Form.v2.balance=function(){
	return AP.dialog("form-v2-dx").balance();
};

Form.button=function(btn, cb){
	return new FormButtonV2(btn, cb);
};



function FormButtonV2(btn, cb){
	this.btns=[];
	this.button=function(btn){
		if (btn==":cancel"){
			btn={label: "Bỏ qua", action: function(){
				Form.v2.hide();
			}};
		}else if (btn==":submit"){
			btn={
				label: "Lưu lại", style: "ok", action: function(){
					Form.v2.submit(function(code){
						if (!code.good()){
							return AP.alertError(code.message);
						}
						
						if (!cb){
							AP.xRefresh();	
						}else{
							cb(code);
						}
					});
				}
			};
		}else if (btn==":submit-refresh"){
			btn={
					label: "Lưu lại", style: "ok", action: function(){
						Form.v2.submit(function(code){
							if (!code.good()){
								return AP.alertError(code.message);
							}
							
							AP.refresh();
						});
					}
				};
			}
		
		
		if (btn.type=="good" || btn.style=="good" || btn.type=="ok" || btn.style=="ok"){
			btn.style="ok -success -rounded bold";
		}else{
			btn.style="cancel -passive-2 -rounded";
		}
		
		this.btns.push(btn);
		return this;
	};
	
	if (btn){
		this.button(btn);	
	}
	
	this.release=function(){
		return this.btns;
	}
};
function UIForm(id, options){
	if (typeof id=='undefined'){
		id=null;
	}
	
	if (typeof options=='undefined'){
		options={};
	}
	
	if (id && id.charAt(0)=='#'){
		id=id.substr(1);
	}
	
	this.__id=id;
	this.__rows=[];
	this.__hiddens={'__code': Client.code};
	this.__buttons=[];
	this.__settings={};
	this.__options=$.extend({},{action: '', method: 'POST'}, options);
	this.__warning=null;
	
	this.find=function(name){
		return $("*[name="+name+"]", "#"+this.__id);
	};
	
	
	this.findRow=function(name){
		return $("[name^="+name+"]", "#"+this.__id).closest(".row");
	};
	
	
	this.matchRow=function(selector){
		return $(selector, "#"+this.__id).closest(".row");
	};
	
	
	this.elem=function(name){
		return $(name, "#"+this.__id);
	};
	
	this.selector=function(name){
		return this.elem(name);
	};
	
	this.row=function(label, input){
		this.__rows.push(Form.row(label, input));
		return this;
	};
	
	this.placeholder=function(id, raw_html){
		this.__rows.push(Form.placeholder(id, raw_html));
		return this;
	};
	
	this.inline=function(html){
		this.__rows[this.__rows.length-1].inline(html);
		return this;
	};
	
	
	this.css=function(css){
		this.__rows[this.__rows.length-1].css(css);
		return this;
	};
	
	this.addClass=function(classname){
		this.__rows[this.__rows.length-1].addClass(classname);
		return this;
	};
	
	
	this.option=function(opts){
		this.__rows[this.__rows.length-1].setOptions(opts);
		return this;
	};
	
	
	this.rowIf=function(label, input, cond){
		if (!cond){
			return this;
		}
		this.__rows.push(Form.row(label, input));
		return this;
	};
	
	this.rowHidden=function(label, input){
		this.__rows.push(Form.rowHidden(label, input));
		return this;
	};
	
	this.rowNone=function(label, input){
		return this;
	};
	
	this.customForm=function(cform, values){
		cForm.attach(this, cform, values);
		return this;
	};
	
	
	this.custom=function(html, opts){
		opts = $.extend({}, {display: 'block', id: AP.uuid()}, opts);
		this.__rows.push(Form.rowCustom(html, opts));
		return this;
	};
	
	
	this.wrap=function(title, id){
		this.__rows.push(Form.wrapper(title, id));
		return this;
	};
	
	this.noRow=function(label){
		this.__rows.push(Form.noRow(label, null));
		return this;
	};
	
	
	this.note=function(label, type){
		this.__rows.push(Form.note(label, "note", type));
		return this;
	};
	
	
	this.plain=function(label, type){
		this.__rows.push(Form.note(label, "plain", type));
		return this;
	};
	
	
	this.rowHTML=function(html){
		this.__rows.push(Form.note(html, "html"));
		return this;
	};

	
	this.rowSep=function(str){
		if (str && str.length){
			return this.rowHTML("<div class='row-hr'><span class='hr-label'>"+str+"</span></div>");	
		}
		
		return this.rowHTML("<div class='row-hr'></div>");
	};
	
	this.hiddens=function(hiddens){
		for (var key in hiddens){
			this.__hiddens[key]=hiddens[key];
		};
		
		return this;
	};
	
	
	this.buttons=function(buttons){
		for (var i=0; i<buttons.length; i++){
			this.__buttons.push(buttons[i]);
		};
		
		return this;
	};
	
	
	
	this.settings=function(settings){
		for (var key in settings){
			this.__settings[key]=settings[key];
		};
		
		return this;
	};
	
	
	this.__callback=null;
	
	this.render=function(callback){
		this.__callback=callback;
		return this;
	};
	
	
	this.html=function(){
		var html="";
		
		if (this.__warning){
			html+="<div class='warning'>"+this.__warning+"</div>";
		}
		
		for (var i=0; i<this.__rows.length; i++){
			html+=this.__rows[i].html();
		}
		
		var hidden="";
		for (key in this.__hiddens){
			hidden+="<input type='hidden' name='"+key+"' value='"+this.__hiddens[key]+"'/>";
		}
		
		
		return html+"<div style='display:none'>"+hidden+"</div>";
	};
	
	
	this.update=function(){
		for (var i=0; i<this.__rows.length; i++){
			if (this.__rows[i].good){
				this.__rows[i].input.update();
				this.__rows[i].update(this.__rows[i]);
			}
		}
	};
	
	
	this.getButton=function(index){
		return this.__buttons[index];
	};
	
	
	
	this.renderButtons=function(){
		var html="";
		for (var i=0; i<this.__buttons.length; i++){
			html+=this.renderButton(this.__buttons[i]);
		}
		return html;
	};
	
	
	this.renderButton=function(button){
		return "<div class='button "+button.style+"'>"+button.label+"</div>";
	};
	
	this.placeTo=function(id){
		var html=this.html();
		$(id).html(html);
		this.update();
	};
	
	this.focus=function(name){
		$("*[name="+name+"]", "#"+this.__id).autofocus();
	};
	
	this.warning=function(w){
		this.__warning=w;
		return this;
	};
	
	this.balance=function(){
		AP.dialog(this.id).balance();
	};
};function UILabel(data){
	this.real=true;
	this.options="";
	
	if (data===null){
		this.real=false;
	}else{
		if (AP.data.isObject(data)){
			this.options=$.extend({}, {label:"Label", sublabel:"", role:"", extra_label:""}, data);
		}else{
			this.options=$.extend({}, {label:data, sublabel:"", role:"", extra_label:""});
		}
	}
	
	this.html=function(){
		if (!this.real){
			return '';
		}
		var sublabel="";
		if (this.options.sublabel && this.options.sublabel.length){
			sublabel="<div class='sublabel'>"+this.options.sublabel+"</div>";
		}
		
		var extra_label='';
		if (this.options.extra_label && this.options.extra_label.length){
			extra_label="<div class='absolute' style='left:50%; padding-left:15px;'>"+(this.options.extra_label)+"</div>";
		}
		
		return "<div class='label "+(this.options.label && this.options.label.length?"":"-empty")+"'>"+extra_label + this.options.label+sublabel+"</div>";
	};
	
	
	
};


function UIInputGroup(data){
	this.length=data.length;
	this.data=[];
	for (var i=0; i<data.length; i++){
		this.data.push(data[i]);
	}
	
	this.html=function(){
		var html="";
		var w=100.0/this.data.length; 
		
		for (var i=0; i<this.data.length; i++){
			html+="<div class='gi' style='width: "+w+"%'>"+this.data[i].html()+"</div>";
		}
		return "<div class='input-group -count-"+this.data.length+"'>"+html+"<div class='clear'></div></div>";
	};
	
	this.update=function(){
		for (var i=0; i<this.data.length; i++){
			this.data[i].update();
		}
	};
};



function UIInputHTML(html){
	this.__html=html;
	
	this.html=function(){
		return "<div class='input data'>"+html+"</div>";
	}
	
	this.update=function(){
		return;
	}
};	


function UIInput(data){
	if (data.type && data.type=="colors" && !data.options){
		data.options=[{value:"1", label: "<div class='square box-alt1'><div class='square-in'></div></div>"},
			{value:"2", label: "<div class='square box-alt2'><div class='square-in'></div></div>"},
			{value:"3", label: "<div class='square box-alt3'><div class='square-in'></div></div>"},
			{value:"4", label: "<div class='square box-alt4'><div class='square-in'></div></div>"},
			{value:"5", label: "<div class='square box-alt5'><div class='square-in'></div></div>"},
			{value:"6", label: "<div class='square box-alt6'><div class='square-in'></div></div>"},
			{value:"7", label: "<div class='square box-alt7'><div class='square-in'></div></div>"},
			{value:"8", label: "<div class='square box-alt8'><div class='square-in'></div></div>"},
			{value:"9", label: "<div class='square box-alt9'><div class='square-in'></div></div>"}
		];
		
		if (data.role=="heatmap"){
			data.options=[
				{value:"1", label: "<div class='square' style='background-color:#f44242'><div class='square-in'></div></div>"},
	  			{value:"2", label: "<div class='square' style='background-color:#f4a341'><div class='square-in'></div></div>"},
	  			{value:"3", label: "<div class='square' style='background-color:#f7e411'><div class='square-in'></div></div>"},
	  			{value:"4", label: "<div class='square' style='background-color:#96e530'><div class='square-in'></div></div>"},
	  			{value:"5", label: "<div class='square' style='background-color:#2cd64c'><div class='square-in'></div></div>"}
			  ];
		}
	};
	
	this.__value=null;
	this.__data=null;
	this.__css={};
	this.options=$.extend({}, {type:"text", name:"input", "placeholder":"", css:"", id: AP.uuid(), 'class':'', readOnly: false, role: "", extra: {}}, data);
	this.__fx=null;
	this.__extra="";
	
	this.value=function(value){
		if (this.options && this.options.type && (this.options.type=="textarea"|| this.options.type=="text")){
			if (this.options.role!="editor"){
				value=cleanText(value);	
			}
		}
		
		if ($.isFunction(value)){
			this.__value=value();
		}else{
			this.__value=value;	
		}
		return this;
	};
	
	
	/**
	 * @desc Set extra HTML below the row
	 */
	this.extra=function(extra_html){
		this.options.__extra=extra_html;
		return this;
	};
	
	this.valueIf=function(value, cond){
		if (!cond){
			return this;
		}
		
		return this.value(value);
	};
	
	
	this.data=function(data){
		this.__data=data;
		return this;
	};
	
	
	this.autoSubmit=function(){
		this.__autos=1;
		return this;
	};
	
	
	this.readOnly=function(){
		this.options.readOnly=true;
		return this;
	}
	
	this.css=function(css){
		this.__css=css;
		return this;
	};
	
	this.fx=function(fx){
		this.__fx=fx;
		return this;
	};
	
	this.on=function(cond, fx){
		if (cond){
			fx.apply(this);
		}
		
		return this;
	};
	
	this.html=function(){
		if (this.options.type=='placeholder'){
			return UIInputRender.placeholder(this.options);
		}
		
		if (this.options.type=='text'){
			return UIInputRender.text(this.options);
		}
		
		if (this.options.type=='textarea'){
			return UIInputRender.textarea(this.options);
		}
		
		if (this.options.type=='icons'){
			return Form.icon.render(this.options);
		}
		
		if (this.options.type=='fav'){
			return Form.icon.renderFav(this.options);
		}
		
		if (this.options.type=='select'){
			return UIInputRender.select(this.options);
		}
		
		if (this.options.type=='fake'){
			return UIInputRender.fake(this.options, this.__value);
		}
		
		if (this.options.type=='file'){
			return UIInputRender.file(this.options, this.__value);
		}
		
		if (this.options.type=='files' || this.options.type=='filelist'){
			return UIInputRender.files(this.options, this.__value);
		}
		
		if (this.options.type=='password'){
			return UIInputRender.password(this.options);
		}
		
		if (this.options.type=='checkbox'){
			return UIInputRender.checkbox(this.options);
		}
		
		if (this.options.type=='checkboxes'){
			return UIInputRender.checkboxes(this.options);
		}
		
		if (this.options.type=='checkbox-list'){
			return UIInputRender.checkboxList(this.options);
		}
		
		if (this.options.type=='colors'){
			return UIInputRender.pickColors(this.options);
		}
		
		if (this.options.type=='orgchart' || this.options.type=='usergroup'){
			return UIInputRender.pickOrgchart(this.options);
		}
		
		if (this.options.type=='datetime'){
			return UIInputRender.datetime(this.options);
		}
		
		if (this.options.type=='tags'){
			return UIInputRender.tags(this.options);
		}
		
		if (this.options.type=='dob'){
			return UIInputRender.dob(this.options);
		}
		
		if (this.options.type=='list'){
			return UIInputRender.list(this.options);
		}
		
		if (this.options.type=='lines'){
			return UIInputRender.lines(this.options);
		}
		
		return "";
	};
	
	this.update=function(canvas){
		if (this.__data!==null){
			for (var key in this.__data){
				$("#"+this.options.id).data(key, this.__data[key]);
			}
		}
		
		if (this.__value!==null){
			if (this.options.type=='checkbox'){
				if (parseInt(this.__value)){
					$("#"+this.options.id).prop("checked", true);
				}else{
					$("#"+this.options.id).prop("checked", false);
				}
			}else if (this.options.type=='colors'){
				uiinput_pick_by_id(this.options.id, this.__value);
			}else if (this.options.type=='datetime'){
				if (this.__value && parseInt(this.__value)){
					$("#"+this.options.id+"-date").val(UI.inputDate(this.__value));
					$("#"+this.options.id+"-time").val(AP.time.time("%H:%i", this.__value));	
				}
			}else if (this.options.role=='time'){
				if (AP.data.isInt(this.__value)){
					$("#"+this.options.id+"").val(AP.time.time("%H:%i", this.__value));
				}else{
					$("#"+this.options.id+"").val(this.__value);
				}
				
			}else if (this.options.role=='date'){
				var val=this.__value;
				if (AP.data.isInt(val) && val!="0"){
					val=UI.inputDate(val);
				}
				$("#"+this.options.id+"").val(val);
			}else if (this.options.role=='tag' || this.options.role=='user'){
				var val=this.__value;
				if (AP.data.isArray(val)){
					val=AP.word.join(val, " ",function(e){
						if (AP.data.isObject(e)){
							return "@"+e.username;
						}
						return "@"+e;
					});
				}else if (val && AP.data.isString(val)){
					if (!AP.word.prefix(val, "@")){
						val="@"+val;	
					}
				}
				$("#"+this.options.id+"").val(val);
			}else if (this.options.role=='teams'){
				var val=this.__value;
				var e_val="";
				if (AP.data.isArray(val)){
					e_val=AP.word.join(val, " ",function(e){
						if (AP.data.isString(e)){
							var ts=UserGroup.get(e);
							
							if (ts){
								return ts.name+" (@"+ts.path+"), ";
							}
						}else if (AP.data.isInt(e)){
							var ts=UserGroup.get(e);
							if (ts){
								return ts.name+" (@"+ts.path+"), ";
							}
						}
						
						return e.name+" (@"+e.path+"), ";
					});
				}
				
				$("#"+this.options.id+"").val(e_val);
			}else if (this.options.type=='checkbox-list'){
				uiinput_check_setval($("#"+this.options.id).closest('.list-checkbox'), null, this.__value);
			}else if (this.options.type=='checkboxes'){
				if (this.__value && this.__value.length){
					var __value=this.__value;
					$("#"+this.options.id+" input[type=checkbox]").each(function(){
						var value=$(this).data("dvalue");
						if (__value==":all" || AP.array.contain(__value, value)){
							$(this).prop("checked", true);
						}
					});
				}
			}else if (this.options.type=='list'){
				// uiinput_pick($("#"+this.options.id).closest('.list-checkbox'), null, this.__value);
				uiinput_pick_by_id(this.options.id, this.__value);
			}else if (this.options.type!='fake' && this.options.type!='file'){
				$("#"+this.options.id).val(this.__value);
			}else if (this.options.type=='lines'){
				$.log([$("#"+this.options.id)]);
			}
		};
		
		$("#"+this.options.id).css(this.__css);
		if (this.__fx){
			this.__fx.apply($("#"+this.options.id));
		}
		
		
		if (this.__autos){
			$("#"+this.options.id).enter(function(){
				$(this).closest("form").find(".form-buttons .button.ok").click();
			});
		}
		
		if (this.options.role=="editor"){
			var mh=200;
			if (this.options.minHeight){
				mh=this.options.minHeight;
			}else if (this.options.height){
				mh=this.options.height;
			}
			
			$("#"+this.options.id).css("min-height", mh);
			
			UI.editor("#"+this.options.id, {
				panel: "bottom",
				minHeight: mh
			});
			
			if (this.__value && AP.config && AP.config.editor=="quill"){
				UI.editorValue("#"+this.options.id, this.__value);
			}
			
			return;
		}
		

		if (this.options.type=="lines" || this.options.role=="lines"){
			Form.list.init("#"+this.options.id,{
				value: this.__value,
				placeholder:this.options.placeholder,
				__data: this.options.data
			});
		}
		
		if (this.options.type=="select" && this.options.multiple){
			Form.improveSelect("#"+this.options.id, {
				multi: this.options.multiple,
				value: this.__value||null
			});
		}
	};
	
	
	function cleanText(str){
		if (str && AP.data.isString(str)){
			return str.toTextarea();
		}
		
		return str;
	};
};



var UIInputRender=new function __UIInputRender(){
	
	this.placeholder=function(options){
		return "<div class='ui-placeholder' id='"+(options.id)+"'></div>";
	};
	
	this.text=function(options){
		
		var note="";
		if (options.note){
			note="<div class='note'>"+options.note+"</div>";
		}
		
		var icon_picker='';
		if (options.icon_picker){
			var icx="";
			if (AP.data.isInt(options.icon_picker)){
				icx="<img src='"+(Client.share_url)+"/fav_icons/"+(options.icon_picker)+".png'/>";
			}
			
			icon_picker="<span class='inline-icon-picker'> <input type='hidden' name='icon'/> <span class='icon-display url' data-url=':active:parent'>"+(icx)+"</span> "+(Form.icon.inlinePicker())+" </span>";
		}
		
		
		if (options.color_picker){
			var color_display='';
			if (!options.color){
				options.color=0;
			}else{
				options.color=parseInt(options.color);
				color_display="<div class='icx -bg-alt"+(options.color)+"'></div>";
			}
			
			icon_picker="<span class='inline-icon-picker url' data-url=':fn:UIInputRender.pickColor'> <input type='hidden' name='color' value='"+(options.color)+"'/><span class='icon-display url' data-url=':active:parent'>"+(color_display)+"</span> </span>";
		}
		
		
		var icon="";
		if (options.role=="date"){
			icon="<span class='-ap icon-uniF1072' style='position: absolute; right:10px; top:10px; color:#aaa; font-size:16px;'></span>";
		}
		
		var unit="";
		if (options.unit && options.unit.length){
			icon="<span class='unit-text' style='position: absolute; right:10px; top:9px; color:#aaa; font-size:12px; text-transform:uppercase'>"+options.unit+"</span>";
		}
		
		return "<div class='input data'>"+icon+unit+"<input autocomplete='off' data-role='"+options.role+"' "+(options.readOnly?" readonly ":"")+"id='"+options.id+"' type='text' name='"+options.name+"' placeholder='"+options.placeholder+"' class='std "+(options.readOnly?" -readonly ":"")+""+options['class']+"'/></div>"+note + icon_picker+getExtra(options);
	};
	
	this.textarea=function(options){
		var input="<textarea data-role='"+options.role+"' "+(options.readOnly?" readonly ":"")+" id='"+options.id+"' name='"+options.name+"' placeholder='"+options.placeholder+"'></textarea>";
		if (options.role=="editor"){
			return "<div class='input data'><div class='input-editor'>"+input+"</div></div>";	
		}
		
		return "<div class='input data'>"+input+"</div>"+getExtra(options);
	};
	
	this.lines=function(options){
		var input="<textarea data-role='"+options.role+"' "+(options.readOnly?" readonly ":"")+" id='"+options.id+"' name='"+options.name+"' placeholder='"+options.placeholder+"'></textarea>";
		return "<div class='input data'>"+input+"</div>";
	};
	
	
	this.password=function(options){
		return "<div class='input data'><input "+(options.readOnly?" readonly ":"")+" id='"+options.id+"' class='std' type='password' name='"+options.name+"' placeholder='"+options.placeholder+"'/></div>";
	};
	
	this.select=function(options){
		if (options.role=="team"){
			return "<div class='select data' data-role='team'><select "+(options.readOnly?" disabled ":"")+" id='"+options.id+"' name='"+options.name+"'>"+Tag.teamOptions()+"</select></div>";
		}
		
		var data="";
		
		if (options.optgroups && options.optgroups.length){
			for (var i=0; i<options.optgroups.length; i++){
				var g=options.optgroups[i];
				
				data+="<optgroup label='"+g.name+"'>"+AP.render(g.items, function(e){
					return "<option value='"+e.id+"'>"+e.name+"</option>";
				})+"</optgroup>";
			}
			
			if (options.empty){
				data="<option value='"+options.empty.value+"'>"+options.empty.label+"</option>"+data;
			}
		}else{
			if (AP.data.isString(options.options)){
				data=options.options;
			}else{
				for (var i=0; i<options.options.length; i++){
					var opt=options.options[i];
					if (AP.data.isObject(opt)){
						if (!opt.label && (!opt.value || opt.name) && opt.id){
							data+="<option value='"+opt.id+"'>"+opt.name+"</option>";
						}else{
							data+="<option value='"+opt.value+"'>"+opt.label+"</option>";	
						}	
					}else{
						data+="<option value='"+opt+"'>"+opt+"</option>";
					}
				}
			}
			
			
			if (options.empty){
				data="<option value='"+options.empty.value+"'>"+options.empty.label+"</option>"+data;
			}
		}
		
		
		return "<div class='select data'> <select "+((options.readOnly?' disabled ':''))+" "+((options.multiple?' multiple':''))+" id='"+(options.id)+"' name='"+(options.name)+"'> "+(data)+" </select> </div>"+(getExtra(options))+"";
	};
	
	this.fake=function(options, value){
		return "<div class='input data'><div class='input-fake ap-xdot' id='"+options.id+"'>"+value+"</div></div>";
	};
	
	this.file=function(options, value){
		var extra="";
		if (value && value.length){
			extra="<div class='filelink'><a href='"+value+"' target='_blank'>"+options.placeholder+"</a></div>";
		}
		
		return "<div class='input data'><input id='"+options.id+"' type='file' name='"+options.name+"'/>"+extra+"</div>"+getExtra(options);
	};
	
	
	this.files=function(options, value){
		var extra="";
		var files="";
		var max=options.max;
		if (!max){
			max=options.max_files;
		}
		
		if (!max){
			max=3;
		}
		
		for (var i=0; i<max; i++){
			files+="<div class='fi "+(i==0?"":"hidden")+"'><input id='"+options.id+"-"+i+"' onchange='UIInputRender.__fileUpdate(this);' type='file' name='"+options.name+"-"+i+"'/></div>";
		}
		
		return "<div class='input data xflat'>"+files+"</div>"+getExtra(options);
	};
	
	/**
	 * @desc Update file on filelist
	 */
	this.__fileUpdate=function(ref){
		var val=$(ref).val();
		if (!val){
			return;
		}
		var $next=$(ref).closest(".fi").next();
		if ($next.length){
			$next.show();
		}
	};
	
	
	this.checkbox=function(options){
		var checked="";
		if (options.checked){
			checked="checked";
		}
		return "<div class='data ap-f15 -ischeckbox'><label class='block'><input id='"+options.id+"' style='vertical-align:-2px' type='checkbox' "+checked+" name='"+options.name+"'/><span class='checkmark'></span> "+options.placeholder+"</div></label>";
	};
	
	
	this.checkboxes=function(options){
		var html="";
//		if (options.checked){
//			checked="checked";
//		}
//		return "<div class='data ap-f15'><input id='"+options.id+"' style='vertical-align:-2px' type='checkbox' "+checked+" name='"+options.name+"'/> &nbsp; "+options.placeholder+"</div>";
		
		for (var i=0; i<options.options.length; i++){
			var name=options.name;
			
			var opt=options.options[i];
			var label=opt.label;
			var value=opt.value;
			
			if (typeof(opt.id) != "undefined" && typeof(opt.name) != "undefined"){
				value=opt.id;
				label=opt.name;
			}
			
			html+="<label class='li block' data-value='"+value+"'><input type='checkbox' name='"+name+"[]' value='"+value+"' data-dvalue='"+value+"'/><span class='checkmark'></span>"+label+"</label>";
		}
		
		return "<div class='data'><div class='list checkboxes' id='"+options.id+"'>"+html+"</div></div>";
	};
	
	
	this.pickColors=function(options){
		var html="";
		for (var i=0; i<options.options.length; i++){
			var opt=options.options[i];
			html+="<div class='opt' data-value='"+opt.value+"' onclick=\"uiinput_pick(this);\">"+opt.label+"</div>";
		}
		return "<div class='colors data'>" +
				"<div style='display:none'><input id='"+options.id+"' style='display:none' name='"+options.name+"'/></div>" +
				"<div class='options'>"+html+"</div>" +
			"</div>";
	};

	
	this.pickOrgchart=function(options){
		var users=getUserCheckboxes(options.options);
		return "<div class='form-org-picker'> <div class='hidden'><textarea name='"+(options.name)+"'></textarea></div> <div class='form-org-users scroll-y unselectable'>"+(users)+"</div> </div>";
	};
	
	
	this.datetime=function(options){
		if (Client.native){
			return "<div class='input data'>" +
				"<input style='' data-role='date' "+(options.readOnly?" readonly ":"")+"id='"+options.id+"-date' type='text' name='"+options.name+"-date' placeholder='Type to select a date' class='std "+(options.readOnly?" -readonly ":"")+""+options['class']+"'/>" +
				"<input style='margin-top:10px' data-role='time' "+(options.readOnly?" readonly ":"")+"id='"+options.id+"-time' type='text' name='"+options.name+"-time' placeholder='Type to select a time' class='std "+(options.readOnly?" -readonly ":"")+""+options['class']+"'/>" +
			"</div>";
		}
		
		var dicon="<span class='-ap icon-uniF1072' style='position: absolute; right:8px; top:7px; color:#aaa; font-size:16px;'></span>";
		var ticon="<span class='-ap icon-uniF10B' style='position: absolute; right:8px; top:7px; color:#aaa; font-size:16px;'></span>";
		
		return "<div class='input data'>" +
			"<div class='relative' style='float:left; width:200px'>"+dicon+"<input data-role='date' "+(options.readOnly?" readonly ":"")+"id='"+options.id+"-date' type='text' name='"+options.name+"-date' placeholder='Click to select a date' class='std "+(options.readOnly?" -readonly ":"")+""+options['class']+"'/></div>" +
			"<div class='relative' style='float:left; margin-left:6px; width:200px'>"+ticon+" <input data-role='time' "+(options.readOnly?" readonly ":"")+"id='"+options.id+"-time' type='text' name='"+options.name+"-time' placeholder='Click to select a time' class='std "+(options.readOnly?" -readonly ":"")+""+options['class']+"'/></div>" +
		"</div>";
	};
	
	
	this.tags=function(options){
		return "<div class='input data'> <div class='selected-tags-wrapper'> <input type='hidden' name='"+(options.name)+"'/> <div class='selected-tags'> <div class='none'>Please select tags</div> </div> </div> </div>";
	};
	
	
	this.dob=function(options){
		if (Client.native){
			
		}
		
		return "<div class='input data'>" +
			"<select style='float:left; width:32%' "+(options.readOnly?" readonly ":"")+"id='"+options.id+"-day' type='text' name='"+options.name+"-day' class='std "+(options.readOnly?" -readonly ":"")+""+options['class']+"'>"+dobDays()+"</select>" +
			"<select style='float:left; width:32%; margin-left:2%'"+(options.readOnly?" readonly ":"")+"id='"+options.id+"-month' type='text' name='"+options.name+"-month' class='std "+(options.readOnly?" -readonly ":"")+""+options['class']+"'>"+dobMonths()+"</select>" +
			"<select style='float:left; width:32%; margin-left:2%' "+(options.readOnly?" readonly ":"")+"id='"+options.id+"-year' type='text' name='"+options.name+"-year' class='std "+(options.readOnly?" -readonly ":"")+""+options['class']+"'>"+dobYears()+"</select>" +
		"</div>";
	};
	
	

	this.list=function(options){
		var html="";
		for (var i=0; i<options.options.length; i++){
			var opt=options.options[i];
			var sublabel=(opt.sublabel)?"<div class='sublabel'>"+opt.sublabel+"</div>":"";
			html+="<div class='opt' data-value='"+opt.value+"' onclick=\"uiinput_pick(this);\"><div class='circle'><div class='cin'></div></div>"+opt.label+sublabel+"</div>";
		}
		
		if (options.wrap){
			html="<div class='list-wrap'>"+html+"</div>";
		}
		
		return "<div class='list-radio data' data-empty='"+(options.empty?1:0)+"'>" +
				"<div style='display:none'><input id='"+options.id+"' style='display:none' name='"+options.name+"'/></div>" +
				"<div class='options'>"+html+"</div>" +
			"</div>";
	};
	
	
	this.checkboxList=function(option){
		return "<div class='list-checkbox unselectable' onclick=\"uiinput_check(this);\">" +
				"<div style='display:none'><input id='"+option.id+"' type='text' style='display:none' name='"+option.name+"' value='0'/></div>" +
				"<div class='checkbox-ui'><div class='square'><span></span></div></div>" +
				"<div class='checkbox-label'><div class='checkbox-main'>"+option.label+"</div><div class='checkbox-sub'>"+option.sublabel+"</div></div>" +
			"</div>";
	};

	
	
	this.pickColor=function(ref){
		Form.inlineColorTagger(ref, function(color){
			$(this).closest(".ap-inline-colors-wrap").find(".icon-display").html("<div class='icx -bg-alt"+(color)+"'></div>")
			$(this).closest(".ap-inline-colors-wrap").find("input[name=color]").val(color);
		}, {
			auto: true,
			click: true,
			left:-100
		});
	};

	
	function dobDays(){
		return quickOptions(1, 31, "Chọn ngày");
	};
	
	function dobMonths(){
		return quickOptions(1, 12, "Chọn tháng");
	};
	
	function dobYears(){
		return quickOptions(1900, 2016, "Chọn năm");
	};
	
	function quickOptions(start, end, empty){
		var html="<option value='0'>"+empty+"</option>";
		for (var i=start; i<=end; i++){
			html+="<option value='"+i+"'>"+AP.data.zeroPrefix(i)+"</option>";
		}
		
		return html;
	};
	
	
	
	/**
	 * @desc Getting extra options
	 */
	function getExtra(options){
		if (!options.__extra){
			return "";
		}
		
		return "<div class='fi-extra'>"+(options.__extra)+"</div>";
		
	};
	
	
	
	function getUserCheckboxes(tree){
		var users=AP.render(tree.nodes, function(e){
			if (e.metatype=="user"){
				return "<div class='fo-user' data-username='"+(e.username)+"' onclick='fo_toggleUser(this)'> <div class='level level-"+(e.level)+"'> <div class='fo-cb'></div> <div class='fo-display-name'>"+(e.name)+" <span class='fo-username'>@"+(e.username)+"</span></div> </div> </div>";
			}else{
				return getUserCheckboxes(e);
			}
		});
		
		var manager="";
		if (tree.user_id && parseInt(tree.user_id) && tree.username){
			var u=People.get(tree.user_id);
			if (u && parseInt(u.id)){
				manager="<div class='fo-user' data-username='"+(u.username)+"' onclick='fo_toggleUser(this)'> <div class='level level-"+(tree.level+1)+"'> <div class='fo-cb'></div> <div class='fo-display-name'>"+(u.name)+" <span class='fo-username'>Manager &middot; @"+(u.username)+"</span></div> </div> </div>";	
			}
		}
		
		var html="<div class='fo-node level-"+(tree.level)+"' data-id='"+(tree.id)+"'> <div class='fo-group' data-group='"+(tree.id)+"' onclick='fo_toggleGroup(this)'> <div class='level level-"+(tree.level)+"'> <div class='fo-cb'></div> <span class='fo-triangle'><span class='-ap icon-triangle-down'></span></span> &nbsp; "+(tree.name)+" </div> </div> <div class='fo-subnodes'> "+(manager)+" "+(users)+" </div> </div>";
		
		return html;
	};
	
	
};


function fo_toggleUser(ref){
	var $node=$(ref);
	
	var username=$node.data("username");
	$node.toggleClass("selected");
	
	if ($node.hasClass("selected")){
		fo_upperSelected($node);
	}else{
		$node.parents(".fo-node").each(function(){
			$(this).children(".fo-group").removeClass("selected");
		});
	}
	
	fo_syncData($node);
};

function fo_toggleGroup(ref){
	var $node=$(ref);
	
	var username=$node.data("username");
	$node.toggleClass("selected");
	
	if ($node.hasClass("selected")){
		$node.parent().find(".fo-user").addClass("selected");
		$node.parent().find(".fo-group").addClass("selected");
		
		fo_upperSelected($node);
	}else{
		$node.parent().find(".fo-user").removeClass("selected");
		$node.parent().find(".fo-group").removeClass("selected");
		
		$node.parents(".fo-node").each(function(){
			$(this).children(".fo-group").removeClass("selected");
		});
	}
	
	fo_syncData($node);
};


function fo_syncData($node){
	var $box=$node.closest(".form-org-picker");
	var $input=$box.find("textarea");
	var usernames=[];
	
	$box.find(".fo-user.selected").each(function(){
		usernames.push("@"+$(this).data("username"));
	});
	
	$input.val(usernames.join(" "));
};


function fo_upperSelected($node){
	var skip=false;
	$node.parents(".fo-node").each(function(){
		if (skip){
			return;
		}
		
		var total=$(this).children(".fo-subnodes").children().length;
		var user_selected=$(this).children(".fo-subnodes").children(".fo-user.selected").length;
		var group_selected=0;
		$(this).children(".fo-subnodes").children(".fo-node").each(function(){
			if ($(this).children(".fo-group.selected").length){
				group_selected++;
			}
		});
		
		
		if (total==user_selected+group_selected){
			$(this).children(".fo-group").addClass("selected");
		}else{
			skip=true;
		}
	});
};

function uiinput_pick(ref){
	var value=$(ref).data('value');
	var $options=$(ref).closest('.options');
	var $input=$options.prev().find('input');
	var empty=$(ref).closest(".data").data("empty");
	if (empty && (empty=="1" || empty==1)){
		empty=1;
	}else{
		empty=0;
	}
	
	$options.find('.opt').each(function(){
		if (AP.data.equal($(this).data('value'), value)){
			if (empty){
				if ($(this).hasClass("selected")){
					value=0;
					$(this).removeClass('selected');
				}else{
					$(this).addClass('selected');	
				}
			}else{
				$(this).addClass('selected');	
			}
		}else{
			$(this).removeClass('selected');
		}
	});
	
	$input.val(value).change();
};





function uiinput_pick_by_id(id, value){
	var $input=$("#"+id);
	var $options=$input.parent().next();
	
	$options.find('.opt').each(function(){
		if (AP.data.equal($(this).data('value'), value)){
			$(this).addClass('selected');
		}else{
			$(this).removeClass('selected');
		}
	});
	
	$input.val(value).change();
};




function uiinput_check(ref){
	var $ref=$(ref);
	var $input=$ref.find('input');
	var val=parseInt($input.val());
	
	if (val==0){
		uiinput_check_setval($ref, $input, 1);
	}else if (val==1){
		uiinput_check_setval($ref, $input, 0);
	}
};


function uiinput_check_setval($ref, $input, val){
	if ($input===null){
		$input=$ref.find('input');
	}
	
	if (val==1){
		$input.val(1);
		$ref.find('.square').replaceWith("<div class='square active'><span class='-ap icon-check2'></span></div>");
	}else{
		$input.val(0);
		$ref.find('.square').replaceWith("<div class='square'><span></span></div>");
	}

};function UIRow(label, input, type){
	this.label="";
	this.good=false;
	this.type="";
	this.input="";
	this.opts={};
	this.__css={};
	this.__classes=[];
	this.__inlinehmtl="";
	
	if (type){
		this.type=type;
		this.label=label;
		this.input=input;
	}else{
		if (input===null){
			this.label=label;
			this.good=false;
		}else{
			this.label=label;
			this.input=input;
			this.good=true;	
		}
	}
	
	this.id=AP.uuid();
	
	this.setType=function(type){
		this.type=type;
		return this;
	};
	
	
	this.setOptions=function(opts){
		this.opts=opts;
	};
	
	
	this.css=function(css){
		this.__css=css;
	};
	
	
	this.inline=function(html){
		this.__inlinehtml=html;
	};
	
	this.addClass=function(classname){
		this.__classes.push(classname);
	};
	
	this.html=function(){
		if (this.type && this.type=="custom-html"){
			return "<div class='row -custom' style='display:"+this.input.display+"' id='"+this.input.id+"'>"+this.label+"</div>";
		}
		
		if (this.type && this.type=="placeholder"){
			var raw_html='';
			if (this.input && this.input.raw_html){
				raw_html=this.input.raw_html;
			}
			
			return "<div class='row-placeholder' id='"+(this.label)+"'>"+(raw_html)+"</div>";
		}
		
		if (this.type && this.type=="wrapper"){
			if (!this.label){
				return "</div>";
			}else{
				var id=this.input;
				if (id){
					if (id.charAt(0)=="#"){
						id=id.substr(1);
					}
				}
				
				return "<div class='wrapper hidden'"+((id && id.length)?" id='"+id+"'":"")+"><div class='wtitle'>"+this.label+"</div> <div class='__ph'></div>"; // One DIV missing by intention
			}
		}
		
		
		if (this.type && this.type=="note"){
			return "<div class='row -"+this.input+"'>"+this.label+"</div>";
		}
		
		if (!this.good){
			return "<div class='row-sep'><div class='render'></div><em>"+this.label+"</em></div>";
		}
		
		var eclass="";
		if (this.opts.classes){
			eclass+=" "+this.opts.classes;
		}
		
		var extra_inline="";
		if (this.__inlinehtml && this.__inlinehtml.length){
			extra_inline="<div class='extra'>"+this.__inlinehtml+"</div>";
		}
		var etype="base";
		if (this.input && this.input.options && this.input.options.type){
			etype=this.input.options.type;
		}
		
		return "<div class='row -is"+etype+" "+eclass+((this.input && this.input.hidden)?" hidden":"")+"' id='"+this.id+"'>"+this.label.html()+this.input.html()+extra_inline+"<div class='clear'></div></div>";
	};
	
	
	this.update=function(row){
		$("#"+this.id).css(this.__css);
		for (var i=0; i<this.__classes.length; i++){
			$("#"+this.id).addClass(this.__classes[i]);
		}
	};
};var cForm=new function __cForm(){
	this.inputs=[];
	this.complete=null;
	this.saved=[];
	
	this.clean=function(){
		this.saved=[];
		this.inputs=[];
	};
	
	
	this.get=function(){
		return this.saved;
	};
	
	
	this.quickEdit=function(obj, url, callback){
		return this.edit.quick(obj, url, callback);
	};
	
	
	
	this.design=function(complete){
		this.inputs=[];
		this.ui.newForm();
		this.complete=complete;
		
		if (this.saved && this.saved.length){
			this.set(this.saved);
		}
	};
	
	
	this.set=function(inputs){
		this.inputs=inputs;
		for (var i=0; i<inputs.length; i++){
			this.ui.previewAdd(inputs[i]);
		}
		Form.balance("#custom-form-fx");
	};
	
	
	this.finishDesign=function(ref){
		// AP.closeDialog(ref);
		var fn=this.complete;
		var preview=this.ui.getPreview(this.inputs);
		fn(this.inputs, preview, this.ui.makeForm(this.inputs));
		this.saved=this.inputs;
	};
	
	
	this.attach=function(form, cform, values){
		var has_title=false;
		
		for (var i=0; i<cform.length; i++){
			var input=cform[i];
			if (input.disabled && parseInt(input.disabled)){
				continue;
			}
			
			var val = "";
			if (values != null && values.length) {
				for (var j = 0; j < values.length; j++) {
					if (values[j].id == cform[i].id) {
						val = values[j].value;
						break;
					}
				}
			}
			
			var name=input.name;
			if (parseInt(input.required)){
				name=name+" *";
			}
			
			if (input.placeholder) {
				input.placeholder=input.placeholder.replace(/⑊/g,'&#92;').replace(/&#9290;/g, '&#92;');
			}
			var placeholder=input.placeholder;
			if (!placeholder || !placeholder.length){
				placeholder=getDefaultPlaceHolder(input.type);
			}
			
			if (input.type=="select"){
				var opts=[];
			
				if(typeof input.options == 'undefined' || input.options == null) {
					input.options = input.values;
				}
				
				for (var j=0; j<input.options.length; j++){
					opts.push({label: input.options[j], value: input.options[j]});
				}
				
				form.row(
					Form.label({label: name, "sublabel":input.placeholder}),
					Form.input({'type':'select', "placeholder": placeholder, name:"custom_"+input.id, options: opts}).value(val)
				);
			}else if (input.type=="int"){
				form.row(
					Form.label({label: name, "sublabel":input.placeholder}),
					Form.input({'type':'text', role:"int", "placeholder": placeholder, name:"custom_"+input.id, unit:"<em>int</em>"}).value(val)
				);
			}else if (input.type=="float"){
				form.row(
					Form.label({label: name, "sublabel":input.placeholder}),
					Form.input({'type':'text', role:"float", "placeholder": placeholder, name:"custom_"+input.id, unit:"<em>decimal</em>"}).value(val)
				);
			}else if (input.type=="date"){
				form.row(
					Form.label({label: name, "sublabel":input.placeholder}),
					Form.input({'type':'text', role:"date", placeholder: placeholder, name:"custom_"+input.id, unit:"<em>date</em>"}).value(val)
				);
			}else if (input.type=="datetime"){
				var val_datetime = "";
				
				//check datetime val
				if (val) {
					var val_arr = val.split(" ");
					if (val_arr.length == 2){
						var val_date = val_arr[0];
						var val_time = val_arr[1];

						var val_date_arr = val_date.split("/");
						var val_time_arr = val_time.split(":");
						if (val_date_arr.length == 3 && val_time_arr.length == 2) {
							var date_obj = new Date(val_date_arr[1] + "/" + val_date_arr[0] + "/" + val_date_arr[2]);
							val_datetime = Math.floor(date_obj.getTime() / 1000);
							val_datetime += val_time_arr[0] * 3600 + val_time_arr[1] * 60;
						}
					}
				}

				form.row(
					Form.label({label: name, "sublabel":input.placeholder}),
					Form.input({'type':'datetime', role:"datetime", placeholder: placeholder, name:"custom_"+input.id}).value(val_datetime)
				);
			}else if (input.type=="textarea"){
				form.row(
					Form.label({label: name, "sublabel":input.placeholder}),
					Form.input({'type':'textarea', "placeholder": placeholder, name:"custom_"+input.id}).css({height: 120}).value(Textarea.simple(val))
				);
			}else if (input.type=="title"){
				has_title=true;
				form.rowHTML("<div class='row-subtitle'>"+input.name+"</div>");	
			}else if (input.type=="file"){
				form.row(
					Form.label({label: name, "sublabel":input.placeholder}),
					Form.input({'type':'file', role:"file", "placeholder": placeholder, name:"custom_"+input.id, unit:"<em>file</em>"}).value(val)
				);
			} else if (input.type=="select-m") {
				var opts = [];

				for (var j = 0; j < input.options.length; j++) {
					opts.push({label: input.options[j], value: input.options[j]});
				}

				form.row(
					Form.label({label: name, "sublabel":input.placeholder}),
					Form.input({'type': 'checkboxes', "placeholder": placeholder, name:"custom_" + input.id, options: opts}).value(val.split(","))
				);
			} else {
				form.row(
					Form.label({label: name, "sublabel":input.placeholder}),
					Form.input({'type':'text', "placeholder": placeholder, name:"custom_"+input.id, unit:"<em>text</em>"}).value(val)
				);	
			}
		}
		
		if (has_title){
			form.rowHTML("<div class='row-subtitle -none'></div>");
		}
	};	
	
	
	this.attachInline=function(fields, canvas, values){
		for (var i=0; i<fields.length; i++){
			var val = "";
			if (values != null && values.length) {
				for (var j = 0; j < values.length; j++) {
					if (values[j].id == fields[i].id) {
						val = values[j].value;
						break;
					}
				}
			}
			
			attachSingleField(fields[i], canvas, val);
		};
		
		Form.render(canvas);
	};
	
	
	
	this.submit=function(url, exported, callback, extra_data){
		if ($("#instant-file-upload").length){
			$("#instant-file-upload").html("").empty().remove();
		}
		
		var $form=$("<form id='instant-file-upload' action='"+url+"' class='__temp'></form>");
		$form.appendTo("#ap-temp");
		$form.html(exported);
		
		UI.ajaxShow();
		AP.submit($form, function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			callback();
		}, extra_data);
	};
	
	
	function getDefaultPlaceHolder(type){
		if (type=="int"){
			return "Please enter a number";
		}
		
		if (type=="double" || type=="float"){
			return "Please enter a number with possible decimal points";
		}
		
		if (type=="text"){
			return "Please enter an inline text";
		}
		
		if (type=="date"){
			return "Click to select a date";
		}
		
		return "";
	};
	
	
	/**
	 * @desc Insert a single filed 
	 */
	function attachSingleField(field, canvas, value){
		var df="";
		var name=field.name;
		if (parseInt(field.required)){
			name=name+" *";
		}
		
		var placeholder=field.placeholder;
		if (!placeholder || !placeholder.length){
			placeholder=getDefaultPlaceHolder(field.type);
		}
		if (placeholder && placeholder.length) {
			df="active";
		}
		
		var input="<input name='custom_"+(field.id)+"' value='"+(value)+"' placeholder='"+(placeholder)+"'/>";
		
		if (field.type=="date"){
			input= "<input name='custom_"+(field.id)+"' data-value='"+(value)+"' data-role='date' placeholder='"+(placeholder)+"'/>";
		}
		
		if (field.type=="datetime"){
			df="active";
			input= "<div class='wrap inline relative' style='width:60%'><input name='custom_"+(field.id)+"-date' data-value='"+(value)+"' placeholder='Click to select a date' data-role='date'/></div> <div class='wrap inline relative' style='width:30%'><input name='custom_"+(field.id)+"-time' data-value='"+(value)+"' data-role='time'/></div>";
		}
		
		if (field.type=="textarea"){
			input= "<textarea name='custom_"+(field.id)+"' data-role='date' data-autoexpand='1' data-maxheight='50'>"+(value)+"</textarea>";
		}
		
		if (field.type=="select"){
			df="active";
			var opts=AP.render(field.options, function(e){
				return "<option value='"+(AP.purify(e))+"'>"+(e)+"</option>";
			});
			
			input= "<select name='custom_"+(field.id)+"' data-value='"+(value)+"'>"+(opts)+"</select>";
		}
		
		if (field.type=="checkbox"){
			df="active";
			var opts="<option value='no'>Unchecked</option><option value='yes'>Checked</option>";
			
			input= "<select name='custom_"+(field.id)+"'>"+(opts)+"</select>";
		}
		
		
		var html= "<div class='row "+(df)+"' data-type='"+(field.type)+"'> <div class='label'>"+(name)+" <span class='normal'> &nbsp; &mdash; &nbsp; "+(placeholder)+"</span></div> <div class='input'>"+(input)+"</div> </div>";
		
		
		$(canvas).append(html);
	};
};


cForm.edit=new function __CFormEdit(){
	this.quick=function(obj, url, callback){
		cForm.clean();
		
		if (!obj.form || !obj.form.length){
			return cForm.edit.quickDesign(obj, url);
		}
		
		var options=[];
		for (var i=0; i<obj.form.length; i++){
			var xobj=obj.form[i];
			xobj.origin={hid: obj.hid, token: obj.token};
			options.push({label: "["+obj.form[i].type+"] "+ obj.form[i].name, sublabel: obj.form[i].placeholder, icon:"arrow-right2", 'xobj': xobj, action: function(elem){
				cForm.edit.row(elem.xobj, url, callback);
			}});
		}
		
		options.push({"label": "Insert more inputs to the custom form", sublabel:"Click to add more inputs to the custom form", icon:"plus", action: function(){
			cForm.edit.quickDesign(obj, url);
		}});
		
		AP.actionMenu(options,{title:"Please select an input to start editing"});
	};

	
	this.quickDesign=function(obj, url, callback){
		cForm.design(function(inputs, preview, tf){
			cForm.submit(url, tf, function(code){
				UI.flash("Save successfully ...");
				AP.xRefresh();
			},{hid: obj.hid, token: obj.token});
		});
	};
	

	this.row=function(row, url, callback){
		var data={hid: row.origin.hid, token: row.origin.token, id: row.id};
		
		var opts=[{label: "Short text", value:"text"}, {label: "Long text", value:"textarea"}, {label: "Date", value:"date"}, {label: "Integer", value:"int"}, {label: "Selection", value:"select"}];
		
		var form=Form.create('fly-custom-fx',{'action': url})
		.row(
			Form.label({label: "Input name *",sublabel: "The name of the custom input"}),
			Form.input({name: 'name', "placeholder":"The name of the custom input"}).value(row.name)
		)
		.row(
			Form.label({label: "Input type *",sublabel: "The input type"}),
			Form.input({name: 'type', type:"select", options: opts}).value(row.type)
		)
		.rowHidden(
			Form.label({label: "Possible options *",sublabel: "Please list all possible options, separated by (,)"}),
			Form.input({name: 'values', type:"textarea"}).value(row.values.join(", "))
		)
		.row(
			Form.label({label: "Guideline text",sublabel: "The text to hint users"}),
			Form.input({name: 'placeholder', "placeholder":"The text to hint users"}).value(row.placeholder)
		)
		.row(
			Form.label({label: "Require answer?",sublabel: ""}),
			Form.input({name: 'required', type:"select", options: [{label: "No", value:0}, {label: "Yes", value:1}]}).value(row.required)
		)
		.row(
			Form.label({label: "Disabled?",sublabel: "Disable this custom input?"}),
			Form.input({name: 'disabled', type:"select", options: [{label: "No", value:0}, {label: "Yes", value:1}]}).value(row.disabled)
		)
		.buttons([
			 {label: "Edit custom input", action: function(){
				 Form.submit("#fly-custom-fx", function(code){
					 if (!code.good()){
						 return AP.alertError(code.message);
					 }
					 
					callback(code);
				 })
			 }, style: 'ok -success -rounded bold'},
			 {label: "Cancel", action: function(){
				 Form.hide("fly-custom-fx");
			 }, style:'cancel -passive-2 -rounded'}
		])
		.hiddens(data)
		.render(function(form){
			form.find("type").change(function(){
				var val=$(this).val();
				if (val=="select"){
					form.findRow("values").show();
				}else{
					form.findRow("values").hide();
				}
			}).change();
		});	
		
		
		Form.pop({width: 720, label: 'Edit custom input'
		}).setForm(form).show().focus('name');
	};
};



cForm.ui=new function __cFormUI(){
	this.addInput=function(){
		var name=safe($("#custom-form-fx input[name=name]").val());
		var type=$("#custom-form-fx select[name=type]").val();
		var placeholder=safe($("#custom-form-fx input[name=placeholder]").val());
		var required=parseInt($("#custom-form-fx select[name=required]").val());
		var values=[];
		var id=AP.uuid();
			
		if (type=="select"){
			values=$("#custom-form-fx input[name=values]").val().split(",");
			if (!values.length){
				return AP.alertError("Please enter possible options for the input.")
			}
		}
		
		var disabled=0;
		
		if (!name || !name.length){
			return AP.alertError("Please enter the input name");
		}
		
		var input={id: id, name: name, type: type, values: values, required: required, disabled: disabled, placeholder:placeholder};
		cForm.inputs.push(input);
		
		this.previewAdd(input);
		this.clearInput();
	};
	
	
	this.clearInput=function(){
		$("#custom-form-fx input").val("");
		$("#custom-form-fx select[name=required]").val(0);
		$("#custom-form-fx select[name=type]").val("text");
		$("#custom-form-fx input[name=values]").closest(".row").hide();
		Form.balance("#custom-form-fx");
	};
	
	
	
	this.makeForm=function(inputs){
		var form="";
		for (var i=0; i<inputs.length; i++){
			var ip=inputs[i];
			form+="<input type='hidden' name='custom-name-"+i+"' value='"+ip.name+"'>" +
				"<input type='hidden' name='custom-type-"+i+"' value='"+ip.type+"'>" +
				"<input type='hidden' name='custom-required-"+i+"' value='"+ip.required+"'>" +
				"<input type='hidden' name='custom-placeholder-"+i+"' value='"+ip.placeholder+"'>" +
				"<input type='hidden' name='custom-values-"+i+"' value='"+ip.values.join(",")+"'>";	
		}
		
		return "<div style='display:none'><input type='hidden' name='__cform' value='1'/> "+form+"</div>";
	};
	
	
	this.getPreview=function(inputs){
		var html="";
		for (var i=0; i<inputs.length; i++){
			html+=getInputPreview(inputs[i]);
		}
		
		return "<div class='embed -cform'>"+html+"</div>";
	};
	
	
	
	this.previewAdd=function(input){
		var html=getInputPreview(input);
		$(html).appendTo("#custom-form-fx .embed.-cform").addClass("pointer").attr("title","Click to clear this input").click(function(){
			var $this=$(this);
			AP.confirm("Remove this input?", function(){
				$this.slideUp(400, function(){
					$this.remove();
					cForm.ui.removeInput(input);
				});
			});
		});
	};
	
	
	this.removeInput=function(input){
		var r=[];
		for (var i=0; i<cForm.inputs.length; i++){
			if (cForm.inputs[i].id==input.id){
			}else{
				r.push(cForm.inputs[i]);
			}
		}
		
		cForm.inputs=r;
		return;
	};
	
	
	this.newForm=function(){
		
		var html="<div class='design form form-inline'>" +
		"	<h1>Tạo custom form</h1>" +
		"	<div class='row flat'>" +
		"		<div class='label'>Tên trường *</div>" +
		"		<div class='input data'><input type='text' name='name' placeholder='The question you want to ask'/></div>" +
		"	</div>" +
		"	<div class='row'>" +
		"		<div class='label'>Loại dữ liệu type *</div>" +
		"		<div class='select data'><select name='type'>" +
		"			<option value='text'>Text ngắn (một dòng)</option>" +
		"			<option value='textarea'>Text dài (nhiều dòng)</option>" +
		"			<option value='int'>Integer (số nguyên)</option>" +
		"			<option value='float'>Float (số thực)</option>" +
		"			<option value='date'>Date (ngày)</option>" +
		"			<option value='datetime'>Datetime (ngày và giờ)</option>" +
		"			<option value='select'>Dropdown list (danh sách chọn)</option>" +
		"		</select></div>" +
		"	</div>" +
		"	<div class='row row-options hidden'>" +
		"		<div class='label'>Tất cả các lựa chọn cho danh sách *</div>" +
		"		<div class='input data'><input type='text' placeholder='Enter all possible options; separated by commans (,)' name='values'/></div>" +
		"	</div>" +
		"	<div class='row'>" +
		"		<div class='label'>Yêu cầu trả lời? *</div>" +
		"		<div class='select data'><select name='required'>" +
		"			<option value='0'>Không bắt buộc</option>" +
		"			<option value='1'>Bắt buộc trả lời</option>" +
		"		</select></div>" +
		"	</div>" +
		"	<div class='row'>" +
		"		<div class='label'>Gợi ý trả lời</div>" +
		"		<div class='input data'><input type='text' name='placeholder' placeholder='The guideline text (not required)'/></div>" +
		"	</div>" +
		"	<div class='buttons -two' style='padding-top:15px;'>" +
		"		<div class='button -first -gradient -big -rounded -stroked' onclick='cForm.ui.clearInput();'>Clear input</div>" +
		"		<div class='button -second -cta -big -rounded -stroked' onclick='cForm.ui.addInput();'>Add input</div>" +
		"	</div>" +
		"</div>";
		
		html+="<div class='results'>" +
				"<div class='title'>Form được khởi tạo</div>" +
				"<div class='embed -cform'></div>" +
			"</div>";

		
		html="<div class='custom-form-design' id='custom-form-design'>"+html+"" +
			"<div class='buttons'>" +
			"	<div class='button -success -big -rounded' onclick='cForm.finishDesign(this);'>Finish designing custom form</div>" +
			"	<div class='cancel pointer' onclick='AP.closeDialog(this);'>Cancel</div>" +
			"</div>"
		"</div>";
		
		
		AP.customDialog(html, "custom-form-fx").width(700).show();
		
		$("#custom-form-fx select[name=type]").change(function(){
			var val=$(this).val();
			if (val=="select"){
				$("#custom-form-fx .row-options").show();
			}else{
				$("#custom-form-fx .row-options").hide();
			}
		});
		
		$("#custom-form-fx input[name=name]").autofocus();
	};
	
	
	
	function getInputPreview(input){
		var star="";
		if (parseInt(input.required)){
			star="<span class='red bold'>*</span>";
		}
		
		var values="";
		if (input.type=="select"){
			if(typeof input.options == 'undefined' || input.options == null) {
			   input.options = input.values;
			}
			values="<div class='values'>{"+AP.word.join(input.values,",")+"}</div>";
		}
		
		var placeholder="";
		if (input.placeholder && input.placeholder.length){
			placeholder="<div class='ph'>"+input.placeholder+"</div>";
		}
		
		return "<div class='item' data-id='"+input.id+"'>" +
			"<div class='name'>"+input.name+star+"</div>" +
			placeholder+
			"<div class='type'>"+input.type+"</div>" +
			values+
		"</div>";
	};
};







// Custom Form v2

var CustomForm = new function __CustomForm(){
	this.dialog=function(canvas, object, url, formKey, options){
		return new CustomFormAPI({canvas: canvas, object: object, url: url, formKey: formKey, extra: options}, 'dialog');
	};
	
	this.inline=function(canvas, object, url, formKey, options){
		return Line.initCustom({canvas: canvas, object: object, url: url, formKey: formKey, extra: options}, 'inline');
	};
	
	this.line=function(canvas, object, url, reorder){
		return Line.init({canvas: canvas, object: object, url: url, reorder: reorder});
	};
	
	this.complex=function(canvas, object, url, reorder){
		return Line.complex({canvas: canvas, object: object, url: url, reorder: reorder});
	};
};




function CustomFormAPI(options, type){
	this.options=options;
	this.type=type;
	
	
	this.data=function(rows){
		cForm.edit.quickDesign(this.options.object, this.option.url, function(code){
			$.log(code);
		});
	};
	
	
	this.show=function(){
		var html=getRowsHTML(this.rows);
	};
	
	this.flat=function(){
		
	};
};var CheckList=new function __CheckList(){
	this.check=function(url, data, callback){
		UI.ajaxShow();
		AP.post(url, data, function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			callback(code.origin, code.item);
		});
	};
	
	
	this.edit=function(checklist, url, data){
		var html="<h1 class='center'>Edit stage checklist</h1><div class='sep-10'></div>";
		
		for (var i=0; i<checklist.length; i++){
			var item=checklist[i];
			
			html+="<div class='item -checklist'>" +
				"<div class='row row-hidden'><div class='input'><input data-name='"+item.name+"' data-id='"+item.id+"' type='text' name='item-"+item.id+"' placeholder='Checklist item' value='"+item.name+"'></div> " +
					"<div class='buttons -two unselectable'>"+
					"	<div class='button -first -success -rounded' onclick='CheckList.editItem(this);'>Edit</div>" +
					"	<div class='button -second -gradient -stroked -rounded' onclick='CheckList.cancelEditItem(this);'>Cancel</div>" +
					"</div>" +
				"</div>" +
				"<div class='real'>" +
				"	<div class='icon'><span class='-ap icon-checkbox-unchecked'></span></div>" +
				"	<div class='name' onclick=\"CheckList.showEdit(this);\">"+item.name+"</div>" +
				"	<div class='actions'>" +
				"		<span class='action a' onclick=\"CheckList.showEdit(this);\">Edit now</span> &middot; " +
				"		<span class='action a' onclick=\"CheckList.moveUp('"+item.id+"');\">Move up</span> &middot; " +
				"		<span class='action a' onclick=\"CheckList.moveDown('"+item.id+"');\">Move down</span> &middot; " +
				"		<span class='action a' onclick=\"CheckList.removeItem(this);\">Remove</span>" +
				"	</div>" +
				"</div>" +
			"</div>";
		}
		
		html+="<div class='sep-20'></div>" +
		"<div class='item more'><div class='row'>" +
			"<h3 style='padding-bottom:8px;'>Add more checklist item</h3>" +
			"<div class='input'><input type='text' name='name' placeholder='Checklist item name'></div> " +
			"<div class='buttons -two unselectable'>"+
			"	<div class='button -first -success -rounded' onclick='CheckList.addMore(this);'>Add</div>" +
			"	<div class='button -second -gradient -stroked -rounded' onclick='CheckList.resetEdit(this);'>Reset</div>" +
			"</div>" +
		"</div></div>";
		
		html+="<div class='cancel'><span onclick='CheckList.closeEdit(this);'>Close dialog</span></div>";
		
		AP.customDialog(html, "checklist-edit").closable(true).width(600).show();
		$("#checklist-edit").data("data", data).data("url", url);
	};
	
	
	this.closeEdit=function(ref){
		AP.closeDialog(ref);
	};
	
	this.showEdit=function(ref){
		$("#checklist-edit .item.-checklist").removeClass("editing");
		$(ref).closest(".item").addClass("editing");
	};
	
	this.resetEdit=function(ref){
		$(ref).closest(".row").find("input[type=text]").val("");
	};
	
	this.addMore=function(ref){
		var val=$(ref).closest(".item").find("input[type=text]").val();
		if (val && val.length){
			var data=$("#checklist-edit").data("data");
			var url=$("#checklist-edit").data("url");
			
			data.name=val;
			data.action="add";
			
			update(data, url);
		}
	};
	
	
	this.editItem=function(ref){
		var $input=$(ref).closest(".item").find("input[type=text]");
		var val=$input.val();
		var item_id=$input.data("id");
		
		if (val && val.length){
			var data=$("#checklist-edit").data("data");
			var url=$("#checklist-edit").data("url");
			
			data.name=val;
			data.item_id=item_id;
			data.action="edit";
			
			update(data, url);
		}
	};
	
	this.cancelEditItem=function(ref){
		$(ref).closest(".item").removeClass("editing");
	};
	
	
	this.removeItem=function(ref){
		var $input=$(ref).closest(".item").find("input[type=text]");
		var item_id=$input.data("id");
		var name=$input.data("name");
		
		AP.confirm("Are you sure that you want to remove this checklist item? This action cannot be undone and will affect every job of the current workflow.", function(){
			var data=$("#checklist-edit").data("data");
			var url=$("#checklist-edit").data("url");
			
			data.action="remove";
			data.item_id=item_id;
			
			update(data, url);
		});
	};
	
	
	
	this.moveUp=function(item_id){
		var data=$("#checklist-edit").data("data");
		var url=$("#checklist-edit").data("url");
		
		data.action="up";
		data.item_id=item_id;
		
		update(data, url);
	};
	
	
	this.moveDown=function(item_id){
		var data=$("#checklist-edit").data("data");
		var url=$("#checklist-edit").data("url");
		
		data.action="down";
		data.item_id=item_id;
		
		update(data, url);
	};
	
	
	
	

	this.updateAdd=function(item){
		
	};
	
	
	function update(data, url){
		AP.ajaxShow();
		AP.post(url, data, function(code){
			AP.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			// Update checklist
			var data=$("#checklist-edit").data("data");
			var url=$("#checklist-edit").data("url");
			
			CheckList.edit(code.checklist, url, data);
		});
	}
};Form.inline = new function __FormInline(){
	/**
	 * @desc Bind a color picker on a selector click
	 */
	this.color=function(selector, callback, opts){
		if (!opts){
			opts={};
		}
		
		opts=$.extend({}, {auto: 1, left: -10}, opts);
		
		$(selector).click(function(){
			Form.inlineColorTagger(this, callback, opts);
		});
	};
	
	
	this.text=function(selector, options){
		options=$.extend({}, {data: {}, position: {top:0, left:0}, placeholder: "Edit", loading: false}, options);
		
		var $handler=$(selector);
		
		if (options.handler){
			$handler=options.handler;
		}
			
		$handler.click(function(){
			var $this=$(selector);
			
			var val=$(selector).data('value');
			if (typeof val=="undefined" || val===null){
				if ('value' in options){
					val=options.value;
				}else if ('val' in options){
					val=options.val;
				}else{
					val=$(selector).text();
				}
				
				val=$.trim(safe(val));
			}
			
			var html="<div class='xform-inline' title='Press enter to save'>" +
					"<div class='input'><input type='text' value='"+val+"' placeholder='"+options.placeholder+"'/></div>" +
					"<div class='close' onclick='Form.inline.cancel_text_input(this);'><span class='-ap icon-undo' title='Cancel'></span></div>" +
				"</div>";
			
			var $canvas=null;
			var binding=false;
			if ($this.parent().hasClass("js_xform_wrap")){
				$canvas=$this.parent();
				binding=true;
			}else{
				var id=AP.uuid();
				$this.addClass("js_xform_initial").wrap("<div id='"+id+"' class='js_xform_wrap'></div>");	
				$canvas=$("#"+id);
				$canvas.append(html);
			}
			
			$this.hide();
			
			$canvas.find(".xform-inline").show().cloneCSS($this, "padding, margin, fontSize, color");
			
			if (!binding){
				$canvas.find("input").enter(function(){
					save_text_input(this, options, $(this).val());
				});
			}
			
			$canvas.find("input").autofocus().val(val);
			
		});
	};
	
	
	
	
	function save_text_input(ref, options, val){
		var url=options.url;
		var data=options.data;
		if (!data){
			data={};
		}
		
		data.value=val;
		
		var $canvas=$(ref).closest(".js_xform_wrap");
		$canvas.ajaxShow();
		
		if (options.loading){
			UI.ajaxShow();
		}
		AP.post(url, data, function(code){
			if (options.loading){
				UI.ajaxHide();
			}
			
			$canvas.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			if (options.done){
				Form.inline.cancel_text_input(ref);
				options.done.call($canvas.find(".js_xform_initial")[0], code);
			}
		});
	};
	
	
	this.cancel_text_input=function(ref){
		var $canvas=$(ref).closest(".js_xform_wrap");
		$canvas.find(".xform-inline").hide();
		$canvas.find(".js_xform_initial").show();
	};
};var Comment=new function __Comment(){
	this.on={};
	
	this.canvas=null;
	
	this.quickPost=function(input, callback, error_callback){
		var $form=$(input).closest("form");
		
		if ($form.parent().ajaxOn()){
			return;
		}
		
		var hid=$(input).data('hid');
		var token=$(input).data('token');
		var content=$(input).val();
		var file=$form.find("input[name=file]").val();
		
		if (!file || !file.length){
			if (!content || !content.length){
				return; // NO CONTENT
			}
		}
		
		$form.find('.textarea').ajaxShow();
		
		
		AP.submit($form, function(code){
			$form.find('.textarea').ajaxHide();
			
			if (!code.good()){
				if (error_callback){
					error_callback(code);
				}
				return AP.alertError(code.mesage);
			}
			
			$(input).val("").restore();
			$form.find("input[type=file]").val("");
			$form.find(".comment-file").hide();
			
			if (callback){
				callback.apply(input, [code.origin, code.comment]);	
			}
			
			AP.fire("comment.posted",[code.origin, code.comment]);
		}, {hid: hid, token: token, content: content});
	};
	
	
	this.quickRefPost=function(ref, callback, error_callback){
		var $input=$(ref).closest(".post").find("textarea");
		$input.triggerEnter();
	};
	
	
	
	this.taggable=function(input, network_id){
		Tag.user(input, network_id);
	};
	
	
	this.get=function(hid, token, callback, error_callback){
		AP.post("api/comment/get",{'hid': hid, 'token': token}, function(code){
			if (!code.good()){
				if (error_callback) error_callback(code);
				return;
			}
			callback(code.comment);
		});
	};
	
	
	
	/**
	 * @desc Load comment on a hash id
	 */
	this.load=function(hid, token, options, callback, error_handler){
		if (!hid){
			return;
		}	
		
		AP.post("api/comment/load",{'hid': hid, 'token': token, 'method': options.method, 'position': options.position}, function(code){
			if (!code.good()){
				if (error_handler){
					error_handler(code);
				}
				return;
			}
			
			callback(code.origin, code.comments);
		});
	};
	
	
	
	this.uploadForm=function(ref){
		var $area=$(ref).prev();
		var hid=$area.data("hid");
		var token=$area.data("token");
		
		var object={hid: hid, token: token};
		
		var $canvas=$(ref).closest(".box.comments");
		
		FileX.create(object, function(_origin, comment, log){
			Comment.ui.insert($canvas, _origin, comment);
			$canvas.find(".__updateinfo").replaceWith(Comment.ui.header(_origin));
			$canvas.trigger("commentposted", _origin);
			$canvas.find(".comment-count").html(_origin.stats.comments);
			
			AP.fire("comment-"+_origin.hid, [_origin, comment]);
		});
	};
	
	
	this.pickFile=function(input){
		var $input=$(input);
		var $box=$input.closest(".textarea");
		var name=getUploadFN($input.val());
		if (!name || !name.length){
			return;
		}
		
		$box.find(".comment-file").show();
		$box.find(".comment-file em").html(name);
	};
	
	
	this.removePickedFile=function(ref){
		var $box=$(ref).closest(".textarea");
		$box.find("input[name=file]").val("");
		$box.find(".comment-file").hide();
	};
	
	
	this.emoji=function(ref){
		var $box=$(ref).closest(".textarea");
		Emoji.pick(function(emoji){
			var $input=$box.find("textarea");
			var content=$input.val();
			if (content && content.length){
				$input.val(content+" "+emoji+" ").focus();
			}else{
				$input.val(emoji).triggerEnter();
			}
			
			
		});
	};
	
	
	this.auto=function(canvas, obj, opts){
		opts=$.extend({},{placeholder: "Comment and press Enter to post", order: "bottom", header: true, subheader: 0, autofocus: false, tagdir:"top", api: "api/comment", counter: ".comment-counter-"+obj.hid, theme: ''}, opts);
		
		this.canvas=canvas;
		
		var $canvas=$(canvas);
		$canvas.addClass("__comment_canvas");
		var hid=obj.hid;
		var token=obj.token;
		
		$canvas.data('hid', hid);
		$canvas.data('hid', hid);
		$canvas.data('object', obj);
		
		var prefix=$canvas.data('prefix');
		if (!prefix){
			prefix=AP.uuid();
			$canvas.data('prefix', prefix);
		}
		
		
		var theme="-white";
		if (opts && opts.theme){
			theme=opts.theme;
			if (theme[0]!='-'){
				theme="-"+theme;
			}
		}
		
		var header="<h1>Comments <small class='comment-count-"+obj.hid+"'>("+obj.stats.comments+")</small></h1>";
		if (opts.header==false){
			header="";
		}
		
		var upload="<span class='upload'><input type='file' name='file' onchange='Comment.pickFile(this);'/><span class='-ap icon-upload3'></span></span> " +
		"<div class='comment-file hidden'>To be uploaded: <em>...</em> &middot; <span class='a normal std' onclick='Comment.removePickedFile(this);'>remove</span> &middot; <span class='a normal std' onclick='Comment.quickRefPost(this);'>post comment</span></div>";
		
		var emoji="<span class='emoji' onclick='Comment.emoji(this);'><span class='-ap icon-happy'></span></span>";
		
		var form="	<div class='post'><form method='post' action='api/comment/post'>" +
		"		<div class='textarea'><textarea data-hid='"+hid+"' data-token='"+token+"' name='comment' placeholder='"+opts.placeholder+"'></textarea> "+upload+emoji+"</div>" +
		"	</form></div>";
		
		var form_top="";
		var form_bottom="";
		
		if (opts.order=="bottom"){
			form_bottom=form;
		}else{
			form_top=form;
		}
		
		var html="";
		if (opts.order=="bottom"){
			html="<div class='box comments "+theme+"' id='auto-comments-"+obj.hid+"'>" +
				((opts && opts.layout && opts.layout=="-wide" && opts.header)?"<h1>Comments <small>("+obj.stats.comments+")</small></h1>":"")+
				(obj.subheader?getHeader(obj, opts):"")+
				"	<div class='arrow'></div>" +
				"	<div class='more'></div>" +
				"	<div class='__comments'></div>" +
				form+
			"</div>";
		}else{
			html="<div class='box comments "+theme+"' id='auto-comments-"+obj.hid+"'>" +
				((opts && opts.layout && opts.layout=="-wide" && opts.header)?"<h1>Comments <small>("+obj.stats.comments+")</small></h1>":"")+
				(obj.subheader?getHeader(obj, opts):"")+
				form+
				"	<div class='arrow'></div>" +
				"	<div class='__comments'></div>" +
				"	<div class='more'></div>" +
			"</div>";
		}
		
		$canvas.html(html).data("options", opts).data("order", opts.order);
		
		if (opts.tagdir=="bottom"){
			$canvas.find(".post textarea").data("tagdir", "bottom");	
		}
		
		
		if (opts.theme && opts.theme.length){
			$canvas.addClass("theme-"+opts.theme);
		}
		
		if (opts && !opts.autofocus){
		}else if (!Client.native){
			$(".post textarea", $canvas).focus();
		}
		
		if (opts.order=="bottom"){
			$(canvas).find("> .comments").addClass("bottom_top");
		}
		
		$(opts.counter).html(obj.stats.comments);
		
		$(".post textarea", $canvas).autoExpand().enter(function(){
			var $this=$(this);
			Comment.quickPost(this, function(origin, comment){
				Comment.liveInsert(origin, comment, $this);
			});
		}).screencopy("api/comment/post", function(code, $_this){
			var origin=code.origin;
			var comment=code.comment;
			
			Comment.ui.insert($canvas, origin, comment);
			$canvas.find(".__updateinfo").replaceWith(Comment.ui.header(origin));
			$canvas.trigger("commentposted", origin);
			$canvas.find(".comment-count").html(origin.stats.comments);
			
			AP.fire("comment-"+origin.hid, [origin, comment]);
		},{hid: hid, token: token});
		
	
		this.taggable($canvas.find(".post textarea"), Client.people);
		
		
		var last_id=$canvas.data("last-id");
		if (!last_id){
			last_id=0;
		}
		
		last_id=parseInt(last_id);
		
		var options={method: 'prev', position: last_id};
		Comment.load(hid, token, options, function(origin, comments){
			Comment.ui.show($canvas, origin, comments);
			AP.fire("comments.loaded."+origin.hid,null);
		});
		
	};
	
	
	this.response=function(comment, origin){
		var $canvas=$("#auto-comments-"+origin.hid);
		
		if ($canvas.length){
			Comment.ui.insertTop($canvas, origin, comment);	
		}
		
		$canvas=$("#comments-"+origin.hid);
		
		if ($canvas.length){
			Comment.ui.insert($canvas, origin, comment);	
		}
		
//		if ($("#live").length){
//			Update.comment.response(comment, origin);
//		}
	};
	

	
	this.autoFocus=function(){
		$(this.canvas).find("textarea").focus();
	};
	
	
	this.liveInsert=function(origin, comment, $iref){
		var $c=$iref.closest(".__comment_canvas");
		var options=$c.data("options");
		
		Comment.ui.insert($c, origin, comment);
		$c.find(".__updateinfo").replaceWith(Comment.ui.header(origin));
		$c.trigger("commentposted", origin);
		$(options.counter).html(origin.stats.comments);
		
		AP.fire("comment-"+origin.hid, [origin, comment]);
	};
	
	
	/**
	 * @desc Attach the form at bottom when the comments are over full-height
	 */
	this.attachBottom=function(box, obj){
		$(box).find(".comments").data("attach-bottom",1).data("attach-to", box);
		
		var nobox=(!$(box).find('.__postbottom').length || !$(box).find('.__postbottom').text().length);
		
		if (nobox){
			var id=AP.uuid();
			
			var upload="<span class='upload'><input type='file' name='file' onchange='Comment.pickFile(this);'/><span class='-ap icon-upload3'></span></span> " +
			"<div class='comment-file hidden'>To be uploaded: <em>...</em> &middot; <span class='a normal std' onclick='Comment.removePickedFile(this);'>remove</span> &middot; <span class='a normal std' onclick='Comment.quickRefPost(this);'>post comment</span></div>";
			var emoji="<span class='emoji' onclick='Comment.emoji(this);'><span class='-ap icon-mood'></span></span>";
			
			var html="<div class='__postbottom'><div class='post'><form method='post' action='api/comment/post'>" +
			"	<div class='textarea'><textarea id='"+id+"' data-hid='"+obj.hid+"' data-token='"+obj.token+"' name='comment' placeholder='Comment and press Enter to post'></textarea>"+upload+emoji+"</div>" +
			"</form></div></div>";
			
			$(html).appendTo(box);
			$("#"+id).enter(function(){
				var $this=$(this);
				var $canvas=$(box).find(".box.comments");
				
				Comment.quickPost(this, function(origin, comment){
					Comment.ui.insert($canvas, origin, comment);
					$canvas.find(".__updateinfo").replaceWith(Comment.ui.header(origin));
					$this.focus();
				});
			}).screencopy("api/comment/post", function(code, $_this){
				var origin=code.origin;
				var comment=code.comment;
				var $canvas=$(box).find(".box.comments");
				
				Comment.ui.insert($canvas, origin, comment);
				$canvas.find(".__updateinfo").replaceWith(Comment.ui.header(origin));
				$canvas.trigger("commentposted", origin);
				$canvas.find(".comment-count").html(origin.stats.comments);
				
				AP.fire("comment-"+origin.hid, [origin, comment]);
			},{hid: obj.hid, token: obj.token});
		}
		
	};
	
	

	this.like=function(ref){
		var $this=$(ref);
		var $canvas=$this.closest('.__comment_canvas');
		var hid=$canvas.data('hid');
		var token=$canvas.data('token');
		
		if ($this.hasClass('unlike')){
			Like.unlike(hid, token, function(origin, like){
				Comment.ui.updateOrigin($canvas, origin);
			});
		}else{
			Like.like(hid, token, function(origin, like){
				Comment.ui.updateOrigin($canvas, origin);
			});
		}
	};
	
	
	this.editOptions = function(ref) {
		var options = [];
		
		options.push({label: "Sửa nội dung bình luận", icon: "uniF11A", action: function(){
			Comment.edit(ref);
		}});
		
		options.push({label: "Xoá bình luận", icon: "uniF11F", action:function(){
			Comment.remove(ref);
		}});
		
		AP.actionMenu(options);
	};
	
	
	this.edit = function(ref){
		var $this=$(ref);
		var $box=$this.closest(".comment");
		var hid=$box.data('hid');
		var token=$box.data('token');
		
		
		$(ref).ajaxShow();
		this.get(hid, token, function(comment){
			$(ref).ajaxHide();
			Form.edit({type: "textarea","height":200, "title":"Edit comment", "action":"api/comment/edit", "content":comment.content.br2nl(),"button":"Edit comment", data: {hid: comment.hid, token:comment.token}, "name":"content"}, function(code){
				var html=Comment.ui.html(code.comment, $box.data("ns"));
				$box.replaceWith(html);
			});
		}, function(){
			$(ref).ajaxHide();
		});
	};
	
	this.remove = function(ref){
		AP.confirm("Bạn có chắc muốn xoá bình luận này? Nội dung bị xoá sẽ không thể khôi phục.", function() {
			var $this = $(ref);
			var $box = $this.closest(".comment");
			var hid = $box.data('hid');
			var token = $box.data('token');
			var $parent = $box.parent().parent();
			var origin_hid = $parent.data('hid');
			
			$(ref).ajaxShow();
			AP.post("api/comment/remove", {hid: hid, token: token, origin_hid: origin_hid}, function(code) {
				$(ref).ajaxHide();
				if (!code.good()){	
					return AP.alertError(code.message, function() {
						AP.xRefresh();
					});
				}
				// var html = Comment.ui.html(code.comment, $box.data("ns"));
				$box.remove();
				// $(".post", $parent).hide(); 
				
				if (Comment.on.removed){
					Comment.on.removed(code, $parent);
				}
				
				var options=$parent.data("options");
				if (!options){
					return;
				}
				
				$(options.counter).each(function(){
					var v=parseInt($(this).text()) || 0;
					v=v-1;
					if (v<=0){
						v=0;
					}
					
					$(this).html(v);
				});
			});
		});
	};
	
	
	
	this.more=function(ref){
		var $canvas=$(ref).closest(".__comment_canvas");
		var obj=$canvas.data("object");
		var last_id=$canvas.data("last-id");
		if (!last_id){
			last_id=0;
		}
		
		last_id=parseInt(last_id);
		
		var options={method: 'prev', position: last_id};
		Comment.load(obj.hid, obj.token, options, function(origin, comments){
			Comment.ui.show($canvas, origin, comments);
			AP.fire("comments.loaded."+origin.hid,null);
		});
	};
	
	
	
	
	this.likeComment=function(ref){
		var $this=$(ref);
		var $box=$this.closest(".comment");
		
		var hid=$box.data('hid');
		var token=$box.data('token');
		var $canvas=$this.closest('.__comment_canvas');
		
		
		if ($this.hasClass('unlike')){
			Like.unlike(hid, token, function(origin, like){
				Comment.ui.update($box, origin);
			});
		}else{
			Like.like(hid, token, function(origin, like){
				Comment.ui.update($box, origin);
			});
		}
	};
	
	this.onLike=function(comment){
		$(".comment-"+comment.hid).each(function(){
			var $box=$(this);
			var hid=$box.data("hid");
			var token=$box.data("token");
			
			var html="&middot; <span class='-ap icon-like2'></span> <span class='link' onclick=\"Like.who('"+hid+"','"+token+"');\">"+comment.likes+" "+AP.word.plural("like", comment.likes)+"</span>";
			$box.find(".comment-counter-ph").html(html).show();
		});
	};
	
	
	
	
	
	this.getContentHTML=function(comment){
		return this.getDefaultContentHTML(comment);
	};
	
	
	this.getDefaultContentHTML=function(comment){
		var content=comment.content;
		if (content && content.length){
			content=content.replace(/⑊/g,'&#92;').replace(/&#9290;/g, '&#92;');
		}
		
		return "<span class='message'>"+UI.emotion(UI.parse(content))+"</span>";
	};
	
	
	
	this.focusComment=function(ref){
		$(ref).closest(".comments").find("textarea").focus();
	};
	
	
	/**
	 * @desc For case comments and logs to be separated, show logs in a canvas 
	 */
	this.showLogs=function(canvas, logs){
		logs.sort(function(e, f){
			return parseInt(f.since)-parseInt(e.since);
		});
		
		$(canvas).html("<div class='comment-logs'></div>");
		for (var i=0; i<logs.length; i++){
			appendLog($(canvas).find(".comment-logs"), logs[i]);
		}
	};
	
	
	/**
	 * @desc Insert a new log, public function
	 */
	this.insertLog=function(canvas, log){
		var $canvas=$(canvas).find(".comment-logs");
		
		var date=AP.time.time('%d%m%Y',log.since);
		var $ms=$canvas.find(".c-date.js-"+date).first();
		if ($ms.length){
			$ms.after(getLog(log));
			return;
		}
		
		$canvas.append("<div class='c-date js-"+(date)+"'>"+(AP.time.time('%V, %d/%m',log.since))+"</div>");
		$canvas.find(".js-"+date).after(getLog(log));
	};
	
	
	
	function appendLog($canvas, log){
		var date=AP.time.time('%d%m%Y',log.since);
		var $ms=$canvas.find(".js-"+date).last();
		if ($ms.length){
			$ms.after(getLog(log));
			return;
		}
		
		$canvas.append("<div class='c-date js-"+(date)+"'>"+(AP.time.time('%V, %d/%m',log.since))+"</div>");
		$canvas.find(".js-"+date).after(getLog(log));
	};
	
	
	
	function getLog(e){
		var u=People.get(e.user_id);
		return "<div class='comment-log js-comment-log-"+(e.id)+" js-"+(AP.time.time('%d%m%Y',e.since))+"'> <div class='c-avatar'> <div class='image'><img src='"+(AP.xthumb(u.gavatar))+"'/></div> </div> <div class='c-display'> <em>"+(u.name)+"</em> <span class='content'>"+(e.content)+"</span> &middot; <span class='time'>"+(AP.i18n.time(e.since))+"</span> </div> </div>";
	};
	
	
	function getHeader(obj, opts){
		if (!opts.header){
			return "";
		}
		return Comment.ui.header(obj);
	}
};



Comment.ui=new function __CommentUI(){
	this.show=function($canvas, obj, comments){
		var last_id=0;
		var options=$canvas.data("options");
		if (!options){
			options={};
		}

		if (comments.length == 0) {
            $canvas.find(".more").hide();
            fixBottom($canvas.find(".comments"), true);
            return;
		}
		
		if (options.order=="top"){
		}else{
			comments=comments.reverse();
		}
		
		var html=AP.render(comments, function(comment){
			if (parseInt(comment.id) < last_id || last_id==0){
				last_id=parseInt(comment.id);
			}
			return Comment.ui.html(comment, $canvas.data("ns"));
		});
		
		
		$canvas.data("last-id", last_id).find(".__comments").after(html);
		
		var total=$canvas.find(".comment").length;
		
		if (total < parseInt(obj.stats.comments)){
			$canvas.find(".more").replaceWith(getMoreLink(total, obj));
			$canvas.find(".more").show();
			$.log($canvas.find(".more").html());
		}else{
			$canvas.find(".more").hide();
		}
		
		
		fixBottom($canvas.find(".comments"), true);
	};
	
	
	this.insert=function($canvas, obj, comment){
		if ($canvas.data("order")=="bottom"){
			$canvas.data('object', obj).find(".post").before(this.html(comment, $canvas));
		}else{
			$canvas.data('object', obj).find(".__comments").after(this.html(comment, $canvas));
		}
		
		fixBottom($canvas, true);
	};
	
	this.insertTop=function($canvas, obj, comment){
		if ($canvas.hasClass("bottom_top")){
			Comment.ui.insert($canvas, obj, comment);	
		}else{
			$canvas.prepend(this.html(comment, $canvas));
		}
		
	};
	
	this.update=function($box, comment){
		$box.replaceWith(this.html(comment, $box));
	};
	
	
	this.updateOrigin=function($canvas, obj){
		$canvas.find(".__updateinfo").replaceWith(this.header(obj));
	};
	
	
	
	this.html=function(comment, ns){
		var prefix="comment";
		
		if (ns && AP.data.isString(ns)){
			ns=ns+"-";
		}else{
			ns="";
		}
		
		var like_action="<span class='action a std' onclick='Comment.likeComment(this);'>Like</span>";
		if (parseInt(comment.liked)){
			like_action="<span class='action a std unlike' onclick='Comment.likeComment(this);'>Unlike</span>";
		}
		
		like_action="<div class='js-action inline'>"+(Like.reaction.getReactionButton(comment))+"</div>";
		
		var eclass="";
		if (comment.metatype){
			eclass=" -alt";
		}
		
		
		return "<div class='comment-"+comment.id+" comment __origin' data-id='"+comment.id+"' data-hid='"+comment.hid+"' data-token='"+comment.token+"' id='"+ns+prefix+"-"+comment.id+"'>" +
			"<div class='image avatar avatar-32 -rounded'><img src='"+AP.xthumb(comment.gavatar)+"'></div>" +
			"<div class='text'><b href='#' class='a url username std' data-username='"+comment.username+"'>"+name(comment.username)+"</b>&nbsp; "+Comment.getContentHTML(comment)+"</div>" +
			getAttachment(comment)+
			"<div class='info'>"+like_action+" &middot; "+UI.simpleTime(comment.since)+ 
			"	<div class='comment-reactions'>"+Like.reaction.getReactions(comment)+"</div>"+
			"</div>" +
			getActions(comment)+
		"</div>";
		
	};
	
	
	this.header=function(obj){
		var action_like="<span class='action action-like' onclick='Comment.like(this);'>Like</span>  &nbsp; &middot; &nbsp; ";
		if (obj.liked && parseInt(obj.liked)){
			action_like="<span class='action action-like unlike' onclick='Comment.like(this);'>Unlike</span>  &nbsp; &middot; &nbsp; ";
		}
		
		return "<div class='info __updateinfo'>" +
			action_like+
			"<span class='action' onclick='Comment.focusComment(this);'>Comment</span> &nbsp; &middot; &nbsp; <em>"+obj.stats.comments+"</em> "+AP.word.plural("comment", obj.stats.comments)+" &nbsp; &middot; &nbsp; " +
			"<span class='-ap icon-like2'></span>&nbsp; <span class='link pointer' onclick=\"Like.who('"+obj.hid+"','"+obj.token+"');\"><em>"+obj.stats.likes+"</em> "+AP.word.plural("like", obj.stats.likes)+"</span>" +
		"</div>";
	};
	
	
	
	this.fixFocus=function($canvas){
		fixBottom($canvas, true);
	};
	
	function getAttachment(comment){		
		var att=comment.attachment;
		if (!att || !att.type){
			return "";
		}
		
		if (att.type=="file"){
			return FileX.inlinePreview(att);
		}
		
		if (att.image && att.title){
			return "<div class='attachment with-cover small' title='"+att.title+"'>" +
				"<div class='cover'><img src='"+AP.thumb(att.image)+"'/></div>" +
				"<div class='-text'><div><a class='title std' href='"+att.url+"' target='_blank''>"+att.title+"</a></div><div class='desc ap-xdot'>"+att.description+"</div></div>"+
			"</div>";	
		}else if (att.title){
			return "<div class='attachment simple' title='"+att.title+"'>" +
				"<div class='-text'><div><a class='title std' href='"+att.url+"' target='_blank''>"+att.title+"</a></div><div class='desc ap-xdot'>"+att.description+"</div></div>"+
			"</div>";
		}
	}
	
	
	function fixBottom($canvas, scroll_down_now){
		if ($canvas.data("attach-bottom") && parseInt($canvas.data("attach-bottom")) && $canvas.data("attach-to")){
			var box=$canvas.data("attach-to");
			
			if ($canvas.parent().parent().height() >= $(box).height()-30){
				if (!$(box).hasClass("__bottomshowup")){
					$(box).addClass("__bottomshowup");
					if (Client.native){
						$(box).find(".__postbottom textarea").val($canvas.find(".post textarea").val());	
					}else{
						$(box).find(".__postbottom textarea").val($canvas.find(".post textarea").val()).focus();	
					}
				}
				
				
				
				if (scroll_down_now){
					Layout.scrollDown(box);
				}
			}else{
				$(box).removeClass("__bottomshowup");
			}
		}
	};
	
	
	
	function getMoreLink(total, obj){
		return "<div class='more'>" +
				"<span class='pointer' onclick='Comment.more(this);'><span class='-ap icon-feed'></span>&nbsp; Load previous comments</span>" +
				"<div class='info'>Display "+total+" of "+obj.stats.comments+" comments</div>" +
			"</div>";
	};
	
	
	function getActions(comment){
		var actions="";
		if (parseInt(comment.user_id)==parseInt(Client.viewer.id)){
			if (comment.metatype=="system"){
				actions+="<div class='action' title='This comment cannot be editted'><span class='-ap icon-lock'></span></div>";
			}else{
				actions+="<div class='action' onclick='Comment.editOptions(this);'><span class='-ap icon-mode_edit'></span></div>";	
			}
			
		}
		
		return  "<div class='actions'>"+actions+"</div>";
	};
};


Comment.v2 = function (opts){
	
	if (!parseInt(Client.env)){
		var params={
			"origin": "[REQUIRED] The origin object, DB release",
			"canvas": "[REQUIRED] The canvas selector, string or jQuery",
			"header": "boolean (TRUE|FALSE) - should we show header?",
			"form": "string {top|bottom} - should the input form at top or bottom (this will impact the comment loading order)",
			"placeholder": "string - input placeholder, default as #Comment and press Enter to post#",
			"tag": "string {up|down} - should the tagging user function appear above the form or under the form"
		};
		
		var str = JSON.stringify(params, null, 2);
		$.log("Comment.v2(opts) opts param:")
		$.log(str);
	}
	
	if (!opts.obj){
		opts.obj=opts.origin;
	}
	
	var obj=opts.obj;
	var canvas=opts.canvas;
	
	opts=$.extend({}, {placeholder: "Comment and press Enter to post", align: "bottom", tagdir:"bottom", header: true, counter: ".comment-counter-"+obj.hid, layout: "standard"}, opts);
	
	Comment.auto(canvas, obj, opts);
};
var Post=new function __Post(){
	this.obj=null;
	this.init=function(obj, canvas, post_form){
		obj.canvas=canvas;
		this.obj=obj;
		this.highlight();
		Post.form.init(post_form);

		var $canvas=$(Post.obj.canvas);

		Post.load(this.obj.hid, this.obj.token, 0, function(origin, posts){
			for (var i=0; i< posts.length; i++){
				Post.insert(posts[i], $canvas);
			}
		});
	};


	this.standardize=function(post){
		post.original={hid: post.hid, token: post.token};

		if (post.attachment && post.attachment.id && post.attachment.type){
			post.hid=post.attachment.hid;
			post.token=post.attachment.token;
			post.stats=post.attachment.stats;
			post.liked=post.attachment.liked;
		}
	};


	this.response=function(post, origin){
		if (!this.obj || this.obj.hid!=origin.hid){
			return;
		};

		this.insert(post, this.obj.canvas, true);
	};


	this.quickPost=function(input, callback){
		if ($(input).parent().ajaxOn()){
			return;
		}

		$(input).parent().ajaxShow();
		var hid=$(input).data('hid');
		var token=$(input).data('token');
		var content=$(input).val();

		if (!content || !content.length){
			return; // NO CONTENT
		}

		var data={hid: hid, token: token, content: content};
		if (AP.isset("Channel")){
			data.channel_id= Channel.channel.id;
		}

		AP.post("api/post/post",data, function(code){
			$(input).parent().ajaxHide();

			if (!code.good()){
				return AP.alertError(code.mesage);
			}

			$(input).val("").restore();
			callback(code.origin, code.comment);
		});

	};



	/**
	 * @desc Load comment on a hash id
	 */
	this.load=function(hid, token, last_id, callback, error_handler){
		this.cid=hid;

		if (!hid){
			return;
		}

		AP.post("api/post/load",{'hid': hid, 'token': token, 'last_id': last_id}, function(code){
			if (!code.good()){
				if (error_handler){
					error_handler(code);
				}
				return;
			}

			callback(code.origin, code.posts);
			AP.fire("POST.LOADED", code.posts.length);
		});
	};


	this.loadMore=function(ref){
		var $master_canvas=$(ref).closest(".__auto_post");
		var origin=$master_canvas.data("object");

		var last_id=0;
		var $canvas=$master_canvas.find(".list.-posts");

		$canvas.find(".li.post").each(function(){
			var id=parseInt($(this).data("id"));
			if (id<last_id || last_id==0){
				last_id=id;
			}
		});

		AP.ajaxShow();
		AP.post("api/post/load",{'hid': origin.hid, 'token': origin.token, 'last_id': last_id}, function(code){
			AP.ajaxHide();

			if (!code.good()){
				return AP.alertError(code.message);
			}

			for (var i=0; i< code.posts.length; i++){
				Post.insert(code.posts[i], $canvas);
			}

			AP.fire("posts.loaded", code.posts.length);
		});
	};


	this.highlight=function(){
		AP.on("post.loaded", function(num_posts){
			if (num_posts && num_posts==10){
				$("#topic-loadmore").show();
			}else{
				$("#topic-loadmore").hide();
			}

			var hl=Query.get("hl");

			if (!hl || !hl.length || !hl.isAlphaNumeric()){
				return;
			}


			if ($("#post-embed-"+hl).length){
				var $box=$("#post-embed-"+hl).closest(".post");
				AP.ajaxShow();
				setTimeout(function(){
					AP.ajaxHide();
					Layout.scrollTo($box, 100, 200);
					Post.comment.show($box.find("> .footer .comment"));
				}, 300);
			}else{
				if (!$("#post-"+hl).length){
					return;
				}

				AP.ajaxShow();
				setTimeout(function(){
					AP.ajaxHide();

					Layout.scrollTo("#post-"+hl, 100, 200);
					Post.comment.show($("#post-"+hl).find("> .footer .comment"));
				}, 500);
			}
		});
	};


	this.insert=function(post, $canvas, prepend){
		this.standardize(post);

		var context_menu="<div class='-dd' onclick='Post.contextMenu(this);'></div>";
		if (!AP.data.equal(post.user_id,Client.viewer.id)){
			context_menu="";
		}

		if (post.metatype=="system"){
			context_menu="<div class='-di' title='This post is locked'><span class='-ap icon-lock5'></span></div>";
		}

		var html= "<div class='li post' id='post-"+post.hid+"' data-id='"+post.id+"' data-hid='"+post.hid+"' data-token='"+post.token+"' data-xhid='"+post.original.hid+"' data-xtoken='"+post.original.token+"'>" +
			context_menu+
			"<div class='title'>" +
			"	<div class='avatar avatar-48 -circled pull-left'><div class='image'><img src='"+AP.xthumb(post.gavatar)+"'/></div></div>" +
			getTitle(post)+
			"	<div class='info'>"+AP.time.time("%H:%i",post.since)+" <em>"+AP.time.time("%M %d", post.since)+"</em></div>" +
			"</div>" +
			getContent(post)+
			getInfo(post)+
			"<div class='post-comments inline-comments' id='post-comments-"+post.id+"'></div>"+
			"</div>";

		if (prepend){
			$(html).prependTo($canvas);
		}else{
			$(html).appendTo($canvas);
		}

		$("#post-"+post.hid).data("object", post);

		$("#post-comments-"+post.id).bind("commentposted", function(event, obj){
			var $box=$(this).closest(".post");
			Post.updateInfo($box, obj);
		});

		$("#post-embed-"+post.id).bind("voted", function(event, obj){
			var $box=$(this).closest(".post");
			Post.updateInfo($box, obj);
		});

		MarkDown.render("#post-"+post.hid);
		$("#post-"+post.hid).linkify();
	};



	this.insertTop=function(post, $canvas){
		this.insert(post, $canvas, true)
	};



	this.contextMenu=function(ref){
		var actions=[];
		actions.push({label:"Edit this post", icon: "pencil", action:function(){
				Post.editMe(ref);
			}});

		actions.push({label:"Delete this post", icon: "block", action:function(){
				Post.deleteMe(ref);
			}});

		AP.actionMenu(actions);
	};



	this.like=function(ref){
		var $this=$(ref);
		var $canvas=$(ref).closest(".post");
		var hid=$canvas.data("hid");
		var token=$canvas.data("token");

		$canvas.ajaxShow();
		if ($this.hasClass('unlike')){
			Like.unlike(hid, token, function(origin, like){
				$canvas.ajaxHide();
				Post.updateInfo($canvas, origin);
			}, function(){
				$canvas.ajaxHide();
			});
		}else{
			Like.like(hid, token, function(origin, like){
				$canvas.ajaxHide();
				Post.updateInfo($canvas, origin);
			}, function(){
				$canvas.ajaxHide();
			});
		}
	};


	this.updateInfo=function($canvas, post){
		$canvas.find(".footer").replaceWith(getInfo(post));
	};


	this.__latest=null;

	/**
	 * @desc Auto post
	 */
	this.auto=function(canvas, obj, opts){
		opts = $.extend({}, {
			poll: 1,
			file: 1,
			placeholder: "Viết thảo luận của bạn"
		}, opts);

		this.__latest=canvas;
		$(canvas).html(getAutoPostForm(obj, opts)).data("object", obj).addClass("__auto_post");
		Post.form.init(canvas);


		Post.init(obj, "#obj-posts", "#obj-post");

		if (Query.getInt("auto_post")){
			$("textarea", canvas).autofocus();
		}


		AP.rebind("new-file-"+obj.hid, function(file, log){
			if ($("#obj-files").length){
				$("#obj-files .none").hide();
				$("#obj-files").prepend(getFileHTML(file));
			}

			Post.insert(log, "#obj-posts", true);
		});


		AP.rebind("new-post-"+obj.hid, function(post, origin){
			Post.insert(post, "#obj-posts", true);
			var counter = origin.stats.posts + origin.stats.files;

			if (typeof origin.stats.comments !== "undefined") {
				counter += origin.stats.comments;
			}

			if (isNaN(counter)) {
				counter = 0;
			}

			$(".post-counter-"+origin.hid).html(counter);
		});
	};


	this.triggerAction=function(action){
		if (action=='reply'){
			setTimeout(function(){
				$(Post.__latest).find(".box.-postform textarea").focus();
			},300);
		}else if (action=='file'){
			$(this.__latest).find(".box.-postform .tab.tab-file").click();
		}else if (action=='poll'){
			$(this.__latest).find(".box.-postform .tab.tab-poll").click();
		}
	};


	this.addFile=function(ref){
		var obj=$(ref).closest(".__auto_post").data("object");
		
		var form=Form.create('invite-fx',{'action':'api/post/post'})
		.row(
			Form.label({label: "Select one or multiple files *",sublabel: ""}),
			Form.input({name: 'file', type:"files", "placeholder":""})
		)
		.row(
			Form.label({label: "Your comment",sublabel: ""}),
			Form.input({name: 'content', type:"textarea", "placeholder":"Some comments, not required"})
		)
		.hiddens({
			"type":"file",
			"hid": obj.hid,
			"token": obj.token,
		})
		.buttons([
		     {label: "Upload file", action: function(){
		    	 Form.submit("#invite-fx", function(code){
		    		 if (!code.good()){
		    			 return AP.alertError(code.message);
		    		 }
		    		 Form.hide("invite-fx");
		    		 AP.fire("new-post-"+code.origin.hid, [code.post, code.origin]);
		 			 AP.fire("new-post", [code.post, code.origin]);
		    	 });
		     }, style: 'ok -success -rounded bold'},
		     {label: "Cancel", action: function(){
		    	 Form.hide("invite-fx");
		     }, style:'cancel -passive-2 -rounded'}
		]).settings({block: true});
	
		Form.pop({id:'invite-fx-dx', width: 480, label: 'Upload files'}).setForm(form).show();
	
		
		// FileX.create(obj);
	};


	this.addPoll=function(ref){
		var obj=$(ref).closest(".__auto_post").data("object");
		Poll.create(obj);
	};


	this.editMe=function(ref){
		var $canvas=$(ref).closest('.li.post');
		var hid=$canvas.data("xhid");
		var token=$canvas.data("xtoken");

		var post=$canvas.data("object");
		
		Form.edit({
			type: "textarea",
			content: post.content,
			name: "content",
			action: "api/post/edit",
			data:{hid: hid, token: token},
			height:130
		}, function(code){
			if (!code.good()){
				return AP.alertError(code.message);
			}

			UI.flash("The post was edited...");
			$canvas.find(".text.-content").html(UI.emotion(UI.parse(code.post.content))).removeClass("-no-data");
			$canvas.find(".text.-content").linkify();
		});
	};



	this.deleteMe=function(ref){
		var $canvas=$(ref).closest('.li.post');
		var hid=$canvas.data("xhid");
		var token=$canvas.data("xtoken");

		AP.confirm("Are you sure that you want to delete this post?", function(){
			AP.ajaxShow();
			AP.post("api/post/delete",{hid: hid, token: token}, function(code){
				AP.ajaxHide();
				if (!code.good()){
					return AP.alertError(code.message);
				}

				UI.flash("The post was removed");
				$canvas.slideUp(500, function(code){
					$canvas.remove();
				});
			});
		});
	};



	function getTitle(obj){
		var txt="";
		if (obj.attachment && obj.attachment.id && obj.attachment.type){
			if (obj.attachment.type=="poll"){
				txt=" shared a poll";
			}

			if (obj.attachment.type=="file"){
				if (parseInt(obj.attachment.image)){
					txt=" shared an image <span class='a normal std' onclick=\"FileX.preview('"+obj.attachment.hid+"','"+obj.attachment.token+"');\">"+obj.attachment.name+"</span>";
				}else{
					txt=" shared a file";
				}
			}
			
			if (obj.attachment.type=="task"){
				txt=" created a task";
			}

			if (obj.attachment.type=="request"){
				txt=" created a request";
			}
		}
		
		if (obj.metatype=="files"){
			if (obj.attachments.length==1){
				txt=" shared a file";
			}else{
				txt=" shared "+obj.attachments.length+" files"; 
			}
		}

		if (obj.metatype=="system"){
			return "<div class='name'><b class='url username' data-username='"+obj.username+"'>"+name(obj.username)+"</b> "+obj.title+"</div>";
		}else if (obj.title=="note"){
			return "<div class='name ap-xdot'><b class='url username' data-username='"+obj.username+"'>"+name(obj.username)+"</b> shared a note</div>";
		}else if (obj.title=="system"){
			return "<div class='name'><b class='url username' data-username='"+obj.username+"'>"+name(obj.username)+"</b> "+obj.content+"</div>";
		}
		return "<div class='name ap-xdot'><b class='url username' data-username='"+obj.username+"'>"+name(obj.username)+"</b>"+txt+"</div>";
	}


	function getContent(obj){
		if (obj.title=="system"){
			return "";
		}

		if (obj.attachment && obj.attachment.id && obj.attachment.type){
			if (obj.attachment.type=="poll"){
				return "<div class='text'><div class='embed' id='post-embed-"+obj.attachment.gid+"'>"+Poll.embed.html(obj.attachment)+"</div></div>";
			}
			if (obj.attachment.type=="file"){
				return getRealContent(obj)+"<div class='text'><div class='embed' id='post-embed-"+obj.attachment.gid+"'>"+FileX.ui.embed(obj.attachment)+"</div></div>";
			}
			if (obj.attachment.type=="task"){
				return getRealContent(obj)+"<div class='text'><div class='embed' id='post-embed-"+obj.attachment.gid+"'>"+Task.ui.embed(obj.attachment)+"</div></div>";
			}
			if (obj.attachment.type=="request"){
				return getRealContent(obj)+"<div class='text'><div class='embed' id='post-embed-"+obj.attachment.gid+"'>"+Request.ui.embed(obj.attachment)+"</div></div>";
			}
		}
		
		if (obj.attachments && obj.attachments.length){
			return getRealContent(obj)+"<div class='text js-files item-post-files'>"+AP.render(obj.attachments, function(e){
				return getFileItemHTML(e);
			})+"</div>";
		}

		if (obj.attachment && !obj.attachment.id && obj.attachment.type=="file"){
			var att=obj.attachment;
			var icon=UI.file.icon(att.name);

			return getRealContent(obj)+"<div class='text'>" +
				"<div class='ifile'>" +
				"	<div class='ifileicon'><img src='"+Client.share_url+"/mimex/"+icon+".png'/></div>" +
				"	<div class='name ap-xdot' onclick=\"Base.file.preview('"+att.src+"');\">"+att.name+"</div>" +
				"	<div class='actions'>" +
				"		<div class='action' onclick=\"Base.file.preview('"+att.src+"');\">Preview</div> &middot; " +
				"		<a class='action' target='_blank' href=\""+att.download+"\">Download</div></a>" +
				"</div>" +
				"</div>";
		}

		return getRealContent(obj);
	}


	function getRealContent(obj){
		if (!obj.content){
			return "<div class='text -content -no-data'></div>";
		}
		return "<div class='text -content'>"+UI.emotion(UI.parse(obj.content))+"</div>";
	}


	function getInfo(obj){
		if (obj.attachment && obj.attachment.id && obj.attachment.type && obj.attachment.type=="request"){
			return "<div class='footer'>" +
				"	<span class='comment url' data-url='requests/show/"+obj.attachment.id+"'><span class='-ap icon-forward'></span> &nbsp; <span class='normal'>View request details</span></span>" +
				"</div>";
		}

		var preview_action="";
		if (obj.attachment && obj.attachment.id && obj.attachment.type){
			if (obj.attachment.type=="poll"){
//				return "<div class='footer'>" +
//					"<span class='comment' onclick=\"Poll.preview('"+obj.attachment.hid+"','"+obj.attachment.token+"');\">Comments <span class='count'>"+obj.attachment.stats.comments+"</span></span> " +
//					" &nbsp; &middot; &nbsp; "+obj.attachment.stats.votes+" " +AP.word.plural("vote", obj.attachment.stats.votes)+
//					" &nbsp; &middot; &nbsp; "+obj.attachment.stats.likes+" " +AP.word.plural("like", obj.attachment.stats.likes)+
//				"</div>";
				preview_action="<span class='a action std' onclick=\"Poll.preview('"+obj.attachment.hid+"','"+obj.attachment.token+"');\">Preview</span> &nbsp; &middot; &nbsp; ";

			}else if (obj.attachment.type=="file"){
				// return "<div class='sep-15'></div>";
				preview_action="<span class='a action std' onclick=\"FileX.preview('"+obj.attachment.hid+"','"+obj.attachment.token+"');\">Preview</span> &nbsp; &middot; &nbsp; ";
			}
		}



		var like_action="<span class='a action std' onclick='Post.like(this);'>Like</span>";
		var me="";
		var who="<span class='subaction pointer' onclick=\"Like.who('"+obj.hid+"','"+obj.token+"');\">"+obj.stats.likes+" "+AP.word.plural("like",obj.stats.likes)+"</span>";

		if (parseInt(obj.liked)){
			like_action="<span class='a action std unlike' onclick='Post.like(this);'>Unlike</span>";
			me=" &nbsp;&middot;&nbsp; You liked it";
		}

		return "<div class='footer'> <span class='comment' onclick='Post.comment.show(this);'> Comments <span class='count'>"+(obj.stats.comments)+"</span> </span> &nbsp; &middot; &nbsp; "+(preview_action)+" <div class='like inline'> "+(Like.reaction.getReactionButton(obj))+" </div> <div class='post-reactions'> "+(Like.reaction.getReactions(obj))+" </div> </div>";
	}


	/**
	 * Create a auto post form
	 * ---
	 * @param obj
	 * @param opts
	 * @returns {string}
	 */
	function getAutoPostForm(obj, opts) {

		// Poll and File buttons
		var poll_button = "";
		var file_button = "";
		var num_conversions = obj.stats.posts + obj.stats.files;

		if (typeof obj.stats.comments !== "undefined") {
			num_conversions += obj.stats.comments;
		}

		if (isNaN(num_conversions)) {
			num_conversions = 0;
		}

		if (opts.poll && opts.poll === 1){
			poll_button= "<div class='action' onclick='Post.addPoll(this);'>" +
				"	<span class='-ap icon-equalizer'></span>" +
				"	<span class='info'><span>Thêm bình chọn</span></span>" +
				"</div>";
		}

		if (opts.file || opts.file == 0){
			file_button= "<div class='action' onclick='Post.addFile(this);'>" +
				"		<span class='-ap icon-attach_file'></span> Add file" +
				"		<span class='info'><span>Thêm file</span></span>" +
				"	</div>";
		}

		// Skeleton of Post Form
		var html = "<div id='obj-post' class='box -postform' data-hid='" + obj.hid + "' data-token='" + obj.token + "'>" +
			"<div class='user'>" +
			"	<div class='avatar avatar-40 -circled'><div class='image'><img src='" + AP.xthumb(Client.viewer.gavatar) + "'></div></div>" +
			"	<div class='name'>" +
			"		<em>" + Client.viewer.name + "</em>" +
			"		<div class='info'>" + Client.viewer.title + " &middot; @" + Client.viewer.username + "</div>" +
			"	</div>" +
			"</div>" +
			"<div class='form'>" +
			"	<form method='post' action='api/post/post'>" +
			"	<input type='hidden' name='hid' value='" + obj.hid + "'/>" +
			"	<input type='hidden' name='token' value='" + obj.token + "'/>" +
			"	<input type='hidden' name='title' value='note'/>" +
			"	<div class='textarea'>" +
			"		<div class='rg'></div><div class='r'></div>" +
			"		<div class='real real-editor'>" +
			"			<textarea name='content' placeholder='" + opts.placeholder + "'></textarea>" +
			"		</div>" +
			"	</div>" +
			"	<div class='real'>" +
			"		<div class='buttons xo'>" +
			"			<div class='button -rounded -cta left' onclick='Post.form.submit(this);'>Post now</div>" +
			"			<div class='cancel right' onclick='Post.form.hide(this);'><span class='-ap icon-cross2'></span> &nbsp; Cancel</div>" +
			"		</div>" +
			"	</div>" +
			"	</form>" +
			"</div>" +
			"<div class='actions'>" + poll_button + file_button +"</div>" +
			"</div>" +
			"<div class='postnform'>" +
			"	<div class='postbox-header'><span class='post-counter-" + obj.hid + "'>" + num_conversions + "</span> thảo luận</div>" +
			"	<div class='list -posts' id='obj-posts' data-origin_hid='"+obj.hid+"'></div>" +
			"	<div class='postbox-loadmore' onclick='Post.loadMore(this);'>Load previous posts</div>" +
			"</div>";

		return html;
	};
	
	
	function getFileItemHTML(e){
		var att=e;
		var icon=UI.file.icon(att.name);

		return "<div class='js-file-item'> <div class='ifile'> <div class='ifileicon'><img src='"+(Client.share_url)+"/mimex/"+(icon)+".png'/></div> <div class='name ap-xdot' onclick='Base.file.preview(\""+(att.src)+"\")'>"+(att.name)+"</div> <div class='actions'> <div class='action' onclick='Base.file.preview(\""+(att.src)+"\")'>Preview</div> &nbsp;&middot;&nbsp; <a class='action' target='_blank' href='"+(att.download)+"'>Download</a> </div> </div> </div>";
	}

};




Post.socket=new function __PostSocket(){
	this.prepend=function(post, origin){
		if ($("#obj-posts").length && $("#obj-posts").data("origin_hid")==origin.hid){
			Post.insert(post, "#obj-posts", true);	
		}
	};
	
	this.append=function(post, origin){
		if ($("#obj-posts").length && $("#obj-posts").data("origin_hid")==origin.hid){
			Post.insert(post, "#obj-posts", false);
		}
	};
};







Post.form=new function __PostForm(){
	this.init=function(canvas){
		$('textarea[name="content"]', canvas).autoExpand();
		Tag.user($('textarea[name="content"]', canvas), Client.people);

		$(canvas+" textarea").on("input change blur", function(){
			var val=$(this).val();
			if (val && val.length){
				$(this).closest(".-postform").addClass("writing");
			}else{
				$(this).closest(".-postform").removeClass("writing");
			}
		});

	};

	this.submit=function(ref){
		Form.submitFrom(ref, function(code){
			if (!code.good()){
				return AP.alertError(code.message)
			}
			UI.flash("The post was saved ...");
			var $p=$(ref).closest(".form");
			$p.find("textarea").val("").change();

			AP.fire("new-post-"+code.origin.hid, [code.post, code.origin]);
			AP.fire("new-post", [code.post, code.origin]);
		});
	};


	this.hide=function(ref){
		var $p=$(ref).closest(".form");
		var val=$.trim($p.find("textarea").val());
		if (val && val.length){
			return AP.confirm("Are you sure that you want to discard this post?", function(){
				$p.find("textarea").val("");
				$p.removeClass("writing");
				AP.hideAlert();
			});
		}
		$p.removeClass("writing");
	};

};Post.comment=new function __PostComment(){
	this.show=function(ref){
		var $canvas=$(ref).closest(".post");
		if (!$canvas.hasClass("__inited")){
			$canvas.addClass("__inited");
			var obj=$canvas.data("object");
			Comment.auto("#post-comments-"+obj.id, obj,{focus: true});
		}
		
		var $box=$canvas.find(".post-comments");
		if ($box.is(":visible")){
			$box.hide();
			return;
		}
		
		
		$box.show();
		if (!Client.native){
			$box.find("textarea").focus();
		}
		
		setTimeout(function(){
			$box.slideDown(200);
		});
	};
};var Like=new function __Like(){
	this.like=function(hid, token, callback, error_callback){
		AP.post("api/like/like",{hid: hid, token: token}, function(code){
			if (!code.good()){
				if (error_callback){
					error_callback(code);
				}
				return AP.alertError(code.message);
			}
			
			callback(code.origin, code.like);
		});
		
	};
	
	
	this.unlike=function(hid, token, callback, error_callback){
		AP.post("api/like/unlike",{hid: hid, token: token}, function(code){
			if (!code.good()){
				if (error_callback){
					error_callback(code);
				}
				return AP.alertError(code.message);
			}
			
			callback(code.origin, code.like);
		});
		
	};
	
	
	this.react=function(ref, reaction, callback){
		var $box=$(ref).closest(".reaction-box");
		var hid=$box.data("hid");
		var token=$box.data("token");
		
		var endpoint="";
		if ($box.data("objtype") && $box.data("objtype")=="messages"){
			endpoint=Base.domain("message")+"/ajax/";
		}
		
		UI.ajaxShow();
		AP.post(endpoint+"api/like/reaction",{hid: hid, token: token, reaction: reaction}, function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			if (callback){
				callback(code.origin, code.like);	
			}else{
				safeReactionUpdate(ref, code.origin);
			}
		});
	};
	
	
	this.who=function(hid, token){
		AP.post("api/like/who", {hid: hid, token: token}, function(code){
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			UI.user.list("People who like this", code.users);
		});
	};
	
	
	this.response=function(origin){
		if (!origin){
			return;
		}
		
		if (origin.type=="comment"){
			return Comment.onLike(origin);
		}
		
		
		$(".likecount-"+origin.gid).each(function(){
			var val=parseInt($(this).text());
			val++;
			$(this).html(val);
		});
	};
	
	
	this.explain=function(obj){
		if (!obj){
			$.log("Error explaining like.explain");
			return;
		}
		
		if (obj.type=="file"){
			$.log(obj);
		}
		
		obj.stats.likes=parseInt(obj.stats.likes);
		if (obj.stats.likes && (!obj.likes || !obj.likes.length)){
			return simpleCase(obj);
		}
		
		var text="";
		
		if (obj.stats.likes){
			var last=getThree(obj.likes);
			if (obj.liked){
				last.unshift(Client.viewer);
			}
			
			
			if (obj.stats.likes > last.length){
				text= "<span class='lb2'><span class='-ap icon-thumb_up'></span></span> &nbsp; "+getExplain(last, true)+" and <span class='sharper pointer' onclick=\"Like.who('"+obj.hid+"','"+obj.token+"');\">"+(obj.stats.likes-3)+" other</span> liked it";
			}else{
				text= "<span class='lb2'><span class='-ap icon-thumb_up'></span></span> &nbsp; "+getExplain(last, false)+" liked it";
			}
				
		}
		
		if (text && text.length){
			 text=" &nbsp; &middot;  &nbsp; "+text;
		}
		
		return text;
	};
	
	
	function simpleCase(obj){
		var like_promotion="<em class='likecount-"+obj.gid+"'>"+obj.stats.likes+"</em> " +AP.word.plural("like", obj.stats.likes)+"";
		
		return " &nbsp; &middot;  &nbsp; <span class='lb2'><span class='-ap icon-thumb_up'></span></span>&nbsp; <span class='link pointer' onclick=\"Like.who('"+obj.hid+"','"+obj.token+"');\">"+like_promotion+"</span>"+
		(obj.liked?" <span class='ilikeit'>&nbsp;&middot&nbsp; You liked it</span>":"");
	}
	
	
	function getExplain(last, has_more){
		var text="";
		for (var i=0; i<last.length; i++){
			var p=last[i];
			if (p && p.id==Client.viewer.id){
				text+="<span class='sharper url username' data-username='"+p.username+"'>You</span>";
			}else{
				text+="<span class='sharper url username' data-username='"+p.username+"'>"+name(p)+"</span>";
			}
			
			
			if (i<last.length-1){
				if (i==last.length-2 && !has_more){
					text+=" and ";
				}else{
					text+=", ";
				}
				
				
			}
		}
		
		return text;
		
	};
	
	
	function getThree(likes){
		if (!likes){
			return [];
		}
		
		var r=[];
		for (var i=0; i<likes.length; i++){
			var id=likes[i];
			if (id!=Client.viewer.id){
				r.push(id);
			}
			
			if (r.length>=3){
				break;
			}
		}
		
		var ps=[];
		for (var i=0; i<r.length; i++){
			var p=People.getID(r[i]);
			if (p){
				ps.push(p);
			}
		}
		
		return ps;
	};
	
	
	function safeReactionUpdate(ref, origin){
		return Like.reaction.onUpdate(ref, origin);
	};
	
};







Like.reaction=new function __LikeReaction(){
	this.getReactionButton=function(obj){
		var reactions=obj.reactions;
		if (!reactions){
			reactions=[];
		}
		
		var icon="<span class='reaction-default pointer'><span class='-ap icon-thumb_up'></span>&nbsp; Like</span>";
		var reacted=false;
		
		for (var i=0; i<reactions.length; i++){
			if (parseInt(reactions[i].user_id)==parseInt(Client.viewer.id)){
				reacted=true;
				icon="<span class='reacted re-"+(reactions[i].reaction)+"'> <span class='reaction-me'><img src='"+(Client.share_url)+"/reactions/"+(reactions[i].reaction)+".svg'/></span> &nbsp; <b>"+(AP.word.capitalize(reactions[i].reaction))+"</b> </span>";
				
				break;
			}
		}

		return "<div class='reaction-wrapper'> "+(icon)+" <div class='reaction-area'> "+(this.getPopup(obj))+" </div> </div>";
	};
	
	
	this.getReactionIcon=function(obj){
		var icon="<span class='-ap icon-insert_emoticon'></span>";
		var reacted=false;
		
		for (var i=0; i<obj.reactions.length; i++){
			if (parseInt(obj.reactions[i].user_id)==parseInt(Client.viewer.id)){
				reacted=true;
				icon="<span class='reaction-me'><img src='"+(Client.share_url)+"/reactions/"+(obj.reactions[i].reaction)+".svg'/></span>";
				break;
			}
		}
		
		return "<div class='reaction-wrapper'> "+(icon)+" <div class='reaction-area'> "+(this.getPopup(obj))+" </div> </div>";
	};
	
	
	
	this.getReactions=function(obj){
		var reactions=obj.reactions;
		if (!reactions){
			reactions=[];
		}
		
		var list=getReactionOverview(reactions);
		var reactions_html=AP.render(list, function(e){
			var users=AP.render(e.users, function(u){
				return "<div class='reaction-user ap-xdot'>"+(u.name)+"</div>"; 
			});
			
			return "<div class='reaction-item'> <div class='reaction-img'> <img src='"+(Client.share_url)+"/reactions/"+(e.reaction)+".svg'/> <span class='reaction-count'>"+(e.count)+"</span> <div class='reaction-users'>"+(users)+"</div> </div> </div>";
		});
		
		var html= "<div class='reaction-list rc-"+(reactions.length)+"' title='Reactions'>"+(reactions_html)+"</div>";
		return html;
	};
	
	
	this.getPopup=function(obj){
		return "<div class='reaction-box' data-hid='"+(obj.hid)+"' data-token='"+(obj.token)+"' data-objtype='"+(obj.type)+"'> <div class='reaction-icon' onclick='Like.react(this, \"like\");'> <label>Like</label> <div class='reaction-img'><img src='"+(Client.share_url)+"/reactions/like.svg'></div> </div> <div class='reaction-icon' onclick='Like.react(this, \"love\");'> <label>Love</label> <div class='reaction-img'><img src='"+(Client.share_url)+"/reactions/love.svg'></div> </div> <div class='reaction-icon' onclick='Like.react(this, \"haha\");'> <label>Haha</label> <div class='reaction-img'><img src='"+(Client.share_url)+"/reactions/haha.svg'></div> </div> <div class='reaction-icon' onclick='Like.react(this, \"wow\");'> <label>Wow</label> <div class='reaction-img'><img src='"+(Client.share_url)+"/reactions/wow.svg'></div> </div> <div class='reaction-icon' onclick='Like.react(this, \"sad\");'> <label>Sad</label> <div class='reaction-img'><img src='"+(Client.share_url)+"/reactions/sad.svg'></div> </div> <div class='reaction-icon' onclick='Like.react(this, \"angry\");'> <label>Angry</label> <div class='reaction-img'><img src='"+(Client.share_url)+"/reactions/angry.svg'></div> </div> </div>";
	};
	
	
	/**
	 * @desc Action call after successfully update reaction
	 */
	this.onUpdate=function(ref, origin){
		var $box=$(ref).closest(".reaction-box");
		
		// Reaction on comment
		if (origin.type && origin.type=="comment"){
			$box.closest(".comment").find(".comment-reactions").html(this.getReactions(origin));
			$box.closest(".comment").find(".reaction-wrapper").replaceWith(this.getReactionButton(origin));
		}else if (origin.type && origin.type=="post"){
			$box.closest(".footer").find(".post-reactions").html(this.getReactions(origin));
			$box.closest(".footer").find(".reaction-wrapper").replaceWith(this.getReactionButton(origin));
		}else if (origin.type && origin.type=="update"){
			$box.closest(".update").find(".update-reactions").html(this.getReactions(origin));
			$box.closest(".js-update-actions").find(".reaction-wrapper").replaceWith(this.getReactionButton(origin));
		}else{
			AP.sys.trigger("reaction", [ref, origin]);
		}
	};
	
	
	/**
	 * @desc Embed the object reaction quickly
	 */
	this.embed=function(obj, canvas, opts){
		$(canvas).html("<div class='reaction-embed-button'></div><div class='reaction-embed-list'></div>").addClass("reaction-embed");
		$(canvas+" .reaction-embed-button").html(Like.reaction.getReactionButton(obj));
		$(canvas+" .reaction-embed-list").html(Like.reaction.getReactions(obj));
	};
	
	
	
	
	function getReactionOverview(reactions){
		var u={};
		for (var i=0; i<reactions.length; i++){
			var r=reactions[i];
			
			if (u[r.reaction]){
				u[r.reaction].users.push(r.user_id);
			}else{
				u[r.reaction]={reaction: r.reaction, users: [r.user_id]}
			}
		}
		
		var list=[];
		for (var key in u){
			u[key].count=u[key].users.length;
			list.push(u[key]);
		}
		
		for (var i=0; i<list.length; i++){
			list[i].users=People.getList(list[i].users);
		}
		return list;
	};
	
};
var Pin=new function __Pin(){
	this.pin=function(object, callback){
		AP.post("api/pin/pin",{hid: object.hid, token: object.token}, function(code){
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			object.pin=1;
			UI.flash("Content pinned ...");
			
			updateDisplay(object, code.pin);
			
			
			
			if (callback){
				callback(object, code.pin);	
			}
		});
	};
	
	
	this.unpin=function(object, callback){
		AP.post("api/pin/unpin",{hid: object.hid, token: object.token}, function(code){
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			object.pin=0;
			UI.flash("Content unpinned ...");
			
			updateDisplay(object, code.pin);
			
			if (callback){
				callback(object, code.pin);	
			}
		});
	};
	
	
	
	this.pinUpdate=function(ref){
		var $this=$(ref);
		var $canvas=$this.closest('.update');
		var object=$canvas.data('object');
		
		this.pin(object);
	};
	
	
	this.unpinUpdate=function(ref){
		var $this=$(ref);
		var $canvas=$this.closest('.update');
		var object=$canvas.data('object');
		
		this.unpin(object);
		
	};
	
	
	this.removePin=function(ref){
		$("#home-pins .li").each(function(){
			if ($(this).data("ref")==ref.gid){
				$(this).remove();
			}
		});
	};
	
	
	
	function updateDisplay(object, pin){
		var $canvas=$("#update-"+object.id);
		
		if ($canvas && $canvas.length){
			$canvas.each(function(){
				Update.update(object, $(this));		
			});
		}
		
		if (pin){
			if (parseInt(object.pin)){
				Update.home.updatePin(pin, false);
			}else{
				Update.home.updatePin(pin, true);
			}
		}
	};
};var Poll=new function __Poll(){
	this.getForm=function(url, callback){
		this.form.create(url, {type: 'poll'}, callback);
	};
	
	
	this.hideForm=function(){
		Form.hide("#fly-poll-fx");
	};
	
	
	this.create=function(params, callback){
		
		
		params.type="poll";
		this.form.create("api/survey/create", params, function(form){
			UI.ajaxShow();
			AP.submit(form, function(code){
				UI.ajaxHide();
				Poll.form.hide();
				callback(code);
				
				if (params && params.gid){
					AP.fire("new-poll-"+params.gid, [code.poll, code.log, _origin]);
	                AP.fire("new-poll", [code.poll, code.log, _origin]);
				}
			});
		});
	};
	
	
	this.edit=function(){
		Poll.form.edit(Poll.ui.current, function(poll){
			Poll.ui.display(poll);
		});
	};
	
	
	this.vote=function(hid, token, answers, callback, error_callback){
		answers.hid=hid;
		answers.token=token;
		
		AP.post("api/survey/vote", answers, function(code){
			if (!code.good()){
				AP.alertError(code.message);
				if (error_callback) error_callback();
				return;
			};
			
			callback(code.survey);
		});
	};
	
	
	this.preview=function(hid, token){
		AP.ajaxShow();
		AP.post("api/survey/get",{hid: hid, token: token}, function(code){
			AP.ajaxHide();
			
			if (!code.good()){
				AP.alertError(code.message);
				return;
			}
			
			Poll.ui.display(code.survey);
		});
	};
};



Poll.ui=new function __PollUI(){
	this.current=null;
	
	this.display=function(poll){
		this.current=poll;
		BC.title(getTitle(poll));
		BC.side(getSide(poll));
		BC.main(getMain(poll));
		BC.show();
		
		Comment.auto("#side-comment-"+poll.id, poll);
		Comment.attachBottom("#bside", poll);
		$("#side-followers").html(BC.ui.followers(poll));
	};
	
	
	
	function getTitle(poll){
		var edit="";
		var export_link = "";
		if (poll.user_id===Client.viewer.id){
			edit=" <span class='a std' onclick='Poll.edit();'>Chỉnh sửa</span> &middot; ";
			export_link = " <a class='std' style='font-size: 11px;' href='" + Client.url + "/survey/export/" + poll.id + "'>Xuất ra excel</a> &middot; ";
		}
		
		var extra="Hoạt động cuối lúc "+UI.simpleTime(poll.last_update);
		if (poll.expired && parseInt(poll.expired)){
			extra="Hết hạn vào "+UI.simpleDate(poll.expired);
		}
		
		return "" +
		"<div class='image'><img src='"+Client.share_url+"/32/chart.png'></div>"+
		"<h1><span class='sub'>Poll:</span> "+poll.name+"</h1>" +
		"<h3>Created by <span class='a std url' data-username='"+poll.username+"'>"+name(poll.username)+"</span> &middot; "+ edit + export_link + "" + UI.simpleTime(poll.since)+" &middot; "+extra+"</h3>" +
		"<div class='actions align-right'>" +
		"	<div class='stat'><b>"+poll.stats.votes+"</b> votes</div>" +
	"</div>";
	};
	
	
	function getSide(poll){
		return "<div id='side-followers' class='section'></div> <div id='side-comment-"+poll.id+"'></div>";
	};
	
	
	function getMain(poll){
		return "<div class='embed-20 fill scroll-y'><div class='in'>"+Poll.embed.html(poll, true)+"</div></div>";			
	};
};Poll.form=new function __PollForm(){
    this.maxOpts = 20;
    
	this.create=function(url, data, callback){
	    // get end of day
	    var t = new Date();
	    t.setSeconds(59);
        t.setMinutes(59);
        t.setHours(23);
        var timeEndOfDay = Math.floor(t.getTime()/1000);
	    
		var form=Form.create('fly-poll-fx',{'action': url})
			.row(
				Form.label({label: "Poll name *",sublabel: "the name of the poll"}),
				Form.input({name: 'name', "placeholder":"Choose a short name for the poll"})
			)
//			.row(
//				Form.label({label: "Multiple selection?",sublabel: "do you allow multiple selections?"}),
//				Form.input({name: 'ptype', type:'select', "placeholder":"The content of the email", options:[
//                     {value: 0, 'label':'Each person could only select a single option'},
//                     {value: 1, 'label':'Allow multiple selections'},
//                ]})
//			)
			.noRow("Poll options (max of " + Poll.form.maxOpts + " options)")
			.row(
				Form.label({label: "Option 1"}),
				Form.input({name: 'option-1', type:'text', "placeholder":"Option 1", "class":"__choice"})
			)
			.addClass("pollopt")
			.row(
				Form.label({label: "Option 2"}),
				Form.input({name: 'option-2', type:'text', "placeholder":"Option 2", "class":"__choice"})
			)
			.addClass("pollopt")
			.row(
				Form.label({label: "Option 3"}),
				Form.input({name: 'option-3', type:'text', "placeholder":"Option 3", "class":"__choice"})
			)
			.addClass("pollopt")
			.row(
				Form.label({label: "Option 4"}),
				Form.input({name: 'option-4', type:'text', "placeholder":"Option 4", "class":"__choice"})
			)
			.addClass("pollopt")
			.rowHTML("<div class='link'>-- More advanced options --</div>")
			.wrap("Advanced poll options","#advopts")
			.row(
				Form.label({label: "Người theo dõi",sublabel: "Thành viên theo dõi bình chọn này. Bạn có thể để trống."}),
				Form.input({name: 'usernames', "placeholder":"Sử dụng @ tag thành viên theo dõi", role:"tag"})
			)
			.row(
				Form.label({label: "Hình ảnh",sublabel: "Đăng hình ảnh cho bình chọn"}),
				Form.input({name: 'image', type:"file"})
			)
			.row(
                Form.label({label: "Thời hạn *",sublabel: "Để trống nếu không có thời hạn bình chọn"}),
                Form.input({name: 'expcheckbox', "placeholder":"", type:"checkboxes", 
                    options:[{label:"Bình chọn có thời hạn", value:0, name: "expcheck"}]})
            )
			.rowHidden(
                Form.label({label: "Thời điểm hết hạn *"}),
                Form.input({name: 'expired', type: 'datetime', "role":"date", "placeholder":"Chọn thời điểm bình chọn hết hạn"}).value(timeEndOfDay)
            )
			.wrap()
			.buttons([
			     {label: "Create a new poll", action: function(){
			    	 var callback=$("#fly-poll-fx").data("callback");
			    	 callback("#fly-poll-fx");
			     }, style: 'ok -success -rounded bold'},
			     {label: "Cancel", action: function(){
			    	 Form.hide("fly-poll-fx");
			     }, style:'cancel -passive-2 -rounded'}
			])
			.hiddens(data)
			.render(function(form){
				form.elem(".link").click(function(){
					$(this).hide();
					$("#advopts").show();
				});
				
				$("#fly-poll-fx").data("callback", callback);
				$("#fly-poll-fx").on("focus", ".input input.__choice", function(){
					var $next=$(this).closest(".row").next(".pollopt");
					if (!$next  || !$next.length){
						var index= $("#fly-poll-fx .row .input input.__choice").length+1;
						if (index > Poll.form.maxOpts){
							return;
						}
						
						$("#fly-poll-fx .row input.__choice").last().closest(".row").after("<div class='row pollopt'><div class='label'>Option "+index+"</div><div class='input data'><input class='std __choice' type='text' name='option-"+index+"' placeholder='Option "+index+"'></div><div class='clear'></div></div>"); 
					}
				});
				
				$('input[name="expcheckbox[]"]').change(function(){
	                var $row = $(this).closest(".row");
	                var $next = $row.next(".row");
	                
	                if($('input[name="expcheckbox[]"]').is(':checked')) {
	                    $next.show();
	                } else {
	                    $next.hide();
	                }
	            });
			});
		
		Form.pop({width: 720, label: 'Create a poll'
		}).setForm(form).show().focus('name');
	};
	
	
	this.edit=function(poll, callback){
		if (!poll){
			return;
		}
		var data={hid: poll.hid, token:poll.token};
		
		var form=Form.create('fly-poll-fx',{'action': "api/survey/edit"})
		.row(
			Form.label({label: "Poll name *",sublabel: "the name of the poll"}),
			Form.input({name: 'name', "placeholder":"Choose a short name for the poll"}).value(poll.name)
		)
		.row(
			Form.label({label: "Cover image",sublabel: "Upload poll's cover image (not required)"}),
			Form.input({name: 'image', type:"file"})
		)
		.row(
            Form.label({label: "Thời hạn *",sublabel: "Để trống nếu không có thời hạn bình chọn"}),
            Form.input({name: 'expcheckbox', "placeholder":"", type:"checkboxes", 
                options:[{label:"Bình chọn có thời hạn", value:0, name: "expcheck"}]})
        )
        .rowHidden(
            Form.label({label: "Thời điểm hết hạn *"}),
            Form.input({name: 'expired', type: 'datetime', "role":"date", "placeholder":"Chọn thời điểm bình chọn hết hạn"}).value(poll.expired)
        )
		.buttons([
		     {label: "Edit poll", action: function(){
		    	 Form.submit("#fly-poll-fx", function(code){
		    		 if (!code.good()){
		    			 return AP.alertError(code.message);
		    		 }
		    		 
		    		 Form.hide("#fly-poll-fx");
		    		 callback(code.poll);
		    	 })
		     }, style: 'ok -success -rounded bold'},
		     {label: "Cancel", action: function(){
		    	 Form.hide("fly-poll-fx");
		     }, style:'cancel -passive-2 -rounded'}
		])
		.hiddens(data)
		.render(function(form){
		    if(typeof poll.expired !== 'undefined' && poll.expired != 0) {
		        $('input[name="expcheck"]').prop('checked', true);
		        var $expcheckRow = $('input[name="expired-date"]').closest(".row");
		        $expcheckRow.show();
		    }
		    $('input[name="expcheck"]').change(function(){
                var $row = $(this).closest(".row");
                var $next = $row.next(".row");
                
                if($('input[name="expcheck"]').is(':checked')) {
                    $next.show();
                } else {
                    $next.hide();
                }
            });
		});
		
		Form.pop({width: 720, label: 'Edit poll'
		}).setForm(form).show().focus('name');
	};
	
	
	
	this.hide=function(){
		Form.hide("fly-poll-fx");
	};
	
	this.submit=function(success_callback){
		Form.submit("#fly-poll-fx", function(code){
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			Poll.form.hide();
			success_callback(code);
		});
	};
	
	
	this.insertData=function(form, data){
		var html="";
		for (var key in data){
			html+="<input type='hidden' name='"+key+"' value='"+data[key]+"'/>";
		}
		
		if (!$(".__insert", form).length){
			$("<div class='hidden __insert'></div>").appendTo(form);
		}
		
		$(".__insert", form).html(html);
	};
};/**
 * Poll Embed
 * Used to embed form in another applications
 * ---
 */
Poll.embed = new function __PollEmbed() {

	/**
	 * Poll Embed HTML
	 * Everything about HTML on here.
	 * ---
	 * @param {object} poll
	 * @param {boolean} on_popup
	 * @returns {string}
	 */
	this.html = function (poll, on_popup) {
		var answer = null;
		if (parseInt(poll.voted)) {
			answer = poll.vote.answers[0];
		}

		var question = poll.questions[0];
		var poll_voted_class = answer ? " -voted" : "";
		var poll_voted_title = answer ? " title='You voted on this poll'" : "";
		var poll_cover = (poll.cover && poll.cover.length) ? "<div class='cover'><img src='"+(poll.cover)+"'/></div>" : "";
		var poll_options = (question.choices.length > 0) ? AP.render(question.choices, function (option, index) {
			return getChoice(option, index, question, answer);
		}) : "";
		var poll_submit = "";

		if (parseInt(poll.expired) && parseInt(poll.expired) < AP.time.now()) {
			poll_submit = "<div class='submit'> <div class='txt red' style='font-style:normal'>The poll is expired and cannot accept votes anymore.</div> </div>";
		} else {
			if (!parseInt(poll.voted)) {
				poll_submit = "<div class='submit'> <div class='button -success -rounded' onclick='survey_vote_now(this);'>Vote now</div> </div>";
			} else {
				poll_submit = "<div class='submit'><div class='txt'>You already voted at <span>" + UI.simpleTime(poll.vote.since) + "</span> " +
					(on_popup ? "" : "&middot; <span class='a std action' onclick=\"Poll.preview('" + poll.hid + "','" + poll.token + "');\">Voting details</span>") +
					"</div></div>";
			}
		}

		return "<div class='poll -embed box box-survey -survey-question "+(poll_voted_class)+"' data-hid='"+(poll.hid)+"' data-token='"+(poll.token)+"' "+(poll_voted_title)+"> <div class='title'>"+(question.name)+"</div> "+(poll_cover)+" <div class='choices'> "+(poll_options)+" <input type='hidden' name='answer-0' value='-1'/> </div> "+(poll_submit)+" </div>";
	};


	this.update = function (poll, $canvas) {
		$canvas.replaceWith(this.html(poll));
	};


	function getChoice(choice, choice_index, question, answer) {
		if (answer === null) {
			return "<div class='choice relative' onclick='survey_select_choice(this)' data-token='" + choice.key + "'><div class='-radio -unchecked -big pull-left'></div> <div class='-text'>" + choice.text + "</div></div>";
		} else {
			var count = parseInt(choice.count);
			var total = 0;
			for (var i = 0; i < question.choices.length; i++) {
				total += parseInt(question.choices[i].count);
			}
			var percent = 0;
			if (total > 0) {
				percent = Math.floor(count * 100 / total);
			}

			var bar = "<div class='process-bar'>" +
				"<div class='-process'><div class='-bar -bg-success' style='width:" + percent + "%'></div></div> " +
				"<div class='-text'><b>" + percent + "%</b> (" + count + " " + AP.word.plural("vote", count) + ")</div>" +
				"</div>";

			if (parseInt(answer) === choice_index) {
				return "<div class='choice relative voted -checked' data-token='" + choice.key + "'><div class='-radio -checked -big pull-left'></div> <div class='-text'>" + choice.text + "</div>" + bar + "</div>";
			} else {
				return "<div class='choice relative voted' data-token='" + choice.key + "'><div class='-radio -unchecked -big pull-left'></div> <div class='-text'>" + choice.text + "</div>" + bar + "</div>";
			}
		}

	};
};


function survey_select_choice(ref) {
	var $ref = $(ref);
	$ref.closest(".choices").find(".choice").removeClass("-checked").find(".-radio").removeClass("-checked").addClass("-unchecked");
	$ref.closest(".choices").find("input").val($($ref.parent().find('.choice')).index($ref));
	$ref.find(".-radio").removeClass("-unchecked").addClass("-checked");
	$ref.addClass("-checked");
};


function survey_vote_now(ref) {
	var $canvas = $(ref).closest(".box-survey");
	var hid = $canvas.data("hid");
	var token = $canvas.data("token");

	var answers = {};


	$canvas.find("input").each(function () {
		answers[$(this).attr("name")] = $(this).val();
	});

	if ($canvas.ajaxOn()) {
		return;
	}


	$canvas.ajaxShow();

	Poll.vote(hid, token, answers, function (poll) {
		$canvas.ajaxHide();
		Poll.embed.update(poll, $(ref).closest(".box-survey"));
	}, function () {
		$canvas.ajaxHide();
	});
};var FileX = new function __File(){
	this.inited=false;
	this.pickerCallback=null;	
	this.fileTypes = {
			'GDOC': '0',
			'GXLS': '1',
			'GPPT': '2',
			'GDRAW': '3',
			'GFILE': '4'
		};
	
	
	this.create=function(origin, callback){
		FileX.pick(function(file){
			if (file.type=="dropbox" || file.type=="onedrive" || file.type=="google"){
				FileX.save(file, {hid: origin.hid, token: origin.token}, function(_origin, file, log){
					// Handle file add
					FileX.hideForm();
					UI.flash("The file was saved ...");
					AP.fire("new-file-"+_origin.gid, [file, log, _origin]);
					AP.fire("new-file", [file, log, _origin]);
					
					if (callback){
						callback(file, log, _origin);
					}
				});
			}else if (file.type=="upload"){
				var data={hid: origin.hid, token: origin.token};
				if (AP.isset("Channel")){
					// data.channel_id=Channel.channel.id;
				}
				FileX.upload.now(file, data, function(_origin, file, log){
					//$.log([origin, file, log]);
					FileX.hideForm();
					UI.flash("The file was uploaded ...");
					AP.fire("new-file-"+_origin.gid, [file, log, _origin]);
					AP.fire("new-file", [file, log, _origin]);
					
					if (callback){
						callback(file, log, _origin);
					}
				});
			} else if(file.type == "txt") {
				FileX.upload.txt({hid: origin.hid, token: origin.token, filename: file.name, filecontent: file.content}, function(_origin, file, log) {
					FileX.hideForm();
					UI.flash("The file was created!");
					AP.fire("new-file-" + _origin.gid, [file, log, _origin]);
					AP.fire("new-file", [file, log, _origin]);
					
					if (callback){
						callback(file, log, _origin);
					}
				});
			}
		});
	};
	
	
	this.pick=function(callback){
		if (!this.inited){
			this.inited=true;
			this.initPicker();
		}
		
		this.pickerCallback=callback;
		
		var domain = "//" + CONFIG.home_src;
		var html="" +
			"<div class='title'>Select a file <div class='-close' onclick='AP.closeDialog(this);'></div></div>"+
			"<div class='list list-actions -border'>" +
				"<div class='li item unselectable'>" +
				"   <div class='-icon -big'><span class='-ap icon-cloud_upload'></span></div>" +
				"   Browse file from computer <div class='sub'>Click to browse and upload the file</div>" +
				"   <div class='full-mask fileapi' id='file-upload-input-inv'><input type='file' name='file' onchange='file_local_change(this, FileX.localSelect);'/></div>" +
				"</div>" +
				"<div class='li item unselectable' style='display: none;'>" +
				"   <div class='-icon -big'><span class='-ap icon-dropbox2'></span></div>" +
				"   Pick from Dropbox <div class='sub'>You can select a file from your Dropbox account</div>" +
				"   <div class='full-mask fileapi'><iframe src='"+domain+"/filepick/dropbox' frameBorder='0' width='100%' height='100%' allowTransparency='true'></iframe></div>" +
				"</div>" +
				"<div class='li item unselectable' style='display: none;'>" +
				"   <div class='-icon -big'><span class='-ap icon-google-drive'></span></div>" +
				"   Pick from Google Drive <div class='sub'>You can select a file from your Google Drive account</div>" +
				"   <div class='full-mask fileapi'><div style='width:100%; height:100%' onclick='FileX.replaceGdriveFrame();'></div></div>" +
				"</div>" +
				"<div class='li item unselectable' style='display: none;'>" +
				"   <div class='-icon -big'><span class='-ap icon-onedrive'></span></div>" +
				"   Pick from Microsoft OneDrive <div class='sub'>You can select a file from your OneDrive account</div>" +
				"   <div class='full-mask fileapi'><iframe src='"+domain+"/filepick/onedrive' frameBorder='0' width='100%' height='100%' allowTransparency='true'></iframe></div>" +
				"</div>" +
				"<div class='li -sep' style='display: none;'></div>" +
				"<div class='li item unselectable' onclick='FileX.createTextFile();' style='display: none;'>" +
				"   <div class='-icon -big'><span class='-ap icon-add_circle_outline'></span></div>" +
				"   Create a text document <div class='sub'>Create a new document file directly in WorkTime</div>" +
				"</div>" +
				"<div class='li item unselectable' onclick='FileX.createGDoc();' style='display: none;'>" +
				"   <div class='-icon -big'><span class='-ap icon-add_circle_outline'></span></div>" +
				"   Create a new file via Google Docs <div class='sub'>Create a collaborative file (document, presentation, spreadsheet) via Googe Docs</div>" +
				"   <div class='full-mask fileapi'><iframe id='gjs-iframe' src='"+domain+"/filepick/gdoc' frameBorder='0' width='0' height='0' allowTransparency='true'></iframe></div>" +
				"</div>" +
			"</div>";
		
		AP.customDialog(html, "custom-selection").width(600).style("-full").show();
	};
	
	
	this.unpick=function(){
		AP.closeDialog("#custom-selection");
	};
	
	
	
	this.pick2Save=function(base, callback){
		FileX.pick(function(file){
			if (file.type=="dropbox" || file.type=="onedrive" || file.type=="google"){
				FileX.save(file, {hid: base.hid, token: base.token}, function(origin, file, log){
					UI.flash("Upload successfully!");
					AP.fire("upload-"+base.gid, [origin, file, log]);
					FileX.unpick();
					if (callback){
						callback(origin, file, log);
					}
				});
			}else if (file.type=="upload"){
				var data={hid: base.hid, token: base.token};
				
				FileX.upload.now(file, data, function(origin, file, log){
					//$.log(base);
					UI.flash("Upload successfully!");
					// AP.xRefresh();
					// AP.fire("upload-"+base.gid, [origin, file, log]);
					FileX.unpick();
					if (callback){
						callback(origin, file, log);
					}
				});
			} else if(file.type == "txt") {
				FileX.upload.txt({hid: base.hid, token: base.token, filename: file.name, filecontent: file.content}, function(origin, file, log) {
					
					UI.flash("The file was created!");
					AP.fire("upload-" + base.gid, [origin, file, log]);
					FileX.unpick();
					if (callback){
						callback(origin, file, log);
					}
				});
			}
		});
	};
	
	
	
	this.hideForm=function(){
		return this.unpick();
	};
	
	
	
	this.save=function(file, data, callback, error_callback){
		for (var key in data){
			file[key]=data[key];
		}
		
		AP.ajaxShow();
		AP.post("api/file/create",file, function(code){
			AP.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			callback(code.origin, code.file, code.log);
		});
	};
	
	
	
	
	this.preview=function(hid, token){
		AP.ajaxShow();
		AP.post("api/file/get",{hid: hid, token: token}, function(code){
			AP.ajaxHide();
			
			if (!code.good()){
				AP.alertError(code.message);
				return;
			}
			
			FileX.display(code.file);
		});
	};

	
	this.inlinePreview=function(file){
		if (!file || !file.src){
			return "";
		}
		
		var src=file.src;
		var download=file.download;
		if (!download){
			download=src;
		}
		
		if (file.image && parseInt(file.image)){
			return "<div class='inline-file-preview' style='padding-left:0px' onclick=\"FileX.quickPreview('"+src+"');\">" +
				"<div class='preview-image'><img src='"+AP.zthumb(src)+"'/></div>" +
			"</div>";
		}
		
		return "<div class='inline-file-preview -line' onclick=\"FileX.quickPreview('"+src+"');\">" +
			"<span class='icon'><span class='-ap icon-uniF10A'></span></span>" +
			"<div class='name ap-xdot'>"+file.name+"</div>" +
			"<a class='download' target='_blank' href='"+download+"'>Download</a>" +
		"</div>";
	};
	
	
	
	this.__cache=null;
	
	this.quickPreview=function(file_src, multiple){
		if (!multiple){
			multiple={};
			this.cache=null;
		}else if (multiple==1 && this.__cache){
			multiple=this.__cache;
		}else{
			this.__cache=multiple;
		}
		
		if (mobile()){
			window.open(getMobileFileURL(file_src));
			return;
		}
		
		if (AP.data.isObject(file_src)){
			BC.show();
			BC.noSide();
			BC.main(FileX.ui.getMain(file_src));
			return;
		}
		
		var is_image=0;
		var ext=UI.file.ext(file_src);
		if (ext=="jpg" || ext=="png" || ext=="bmp" || ext=="jpeg" || ext=="gif"){
			is_image=1;
		}
		
		var file={name: file_src, src: file_src, image: is_image};
		BC.show();
		BC.noSide();
		BC.main(FileX.ui.getMain(file));
		
		// Handle multiple
		$("#bcanvas .-in .mnav").remove();
		
		if (multiple.container && $(multiple.container).find(multiple.filter).length>1){
			var prev=file_src;
			var next=file_src;
			
			$(multiple.container).find(multiple.filter).each(function(index){
				var fid=$(this).data("file");
				
				if (fid==file_src){
					var $prev=$(multiple.container).find(multiple.filter).eq(index-1);
					var $next=$(multiple.container).find(multiple.filter).eq(index+1);
					
					if ($prev.length){
						prev=$prev.data("file");
					}
					
					if ($next.length){
						next=$next.data("file");
					}
					
					return;
				}
			});
			
			$("#bcanvas .-in").append("<span class='mnav -left pointer' onclick=\"FileX.quickPreview('"+(prev)+"', 1);\"><span class='-ap icon-arrow-left2'></span></span> <span class='mnav -right pointer' onclick=\"FileX.quickPreview('"+(next)+"', 1);\"><span class='-ap icon-arrow-right2'></span></span>");
		}
	};
	
	
	this.display=function(file){
		FileX.ui.file=file;
		BC.title(FileX.ui.getTitle(file));
		BC.side(FileX.ui.getSide(file));
		BC.main(FileX.ui.getMain(file));
		BC.show();
		
		Comment.auto("#side-comment-"+file.id, file);
		Comment.attachBottom("#bside", file);
		$("#side-followers").html(BC.ui.followers(file));
	};
	
	
	this.edit=function(hid, token, name){
		Form.edit({type: 'input', action:"api/file/edit", content: name, button:"Edit filename", data:{hid: hid, token:token},"name":"name"}, function(code){
			UI.flash("Filename edited successfully")
			var file=code.file;
			$("#bcanvas .__title h1").html(file.name);
		});
	};
	
	
	this.options=function(){
		var file=FileX.ui.file;
		var actions=[];
		
		var download=file.src;
		if (file.metatype=="" || file.metatype=="upload"){
			download=Client.url+'/files/download?id='+file.id+"&token="+file.token+"&key="+file.src;
		}
		
		actions.push({label: "Download this file", icon: "download", url: download});
		
		if (file.user_id==Client.viewer.id){
			actions.push({label: "Add a new revision", icon: "upload3", action: function(){
				FileX.newRev(file.hid,file.token,file.gid);
			}});
		}
		
		actions.push({label: "Extend preview windows", icon: "open_in_new", action: function(){
			BC.extend();
		}});
		
		actions.push({label: "Share to company's knowledge-base", icon: "documents", action: function(){
			KBase.shareFrom(file);
		}});
		
		
		AP.actionMenu(actions);
	};
	
	
	this.setPrivate=function(hid, token){
		AP.confirm("Are you sure that you want to set this file as <i>private</i>? If this file is set <i>private</i>, you can browse it in <b>Files</b> &rsaquo; <b>My Files</b>", function(){
			UI.ajaxShow();
			AP.post("api/file/setprivate",{hid: hid, token: token, privacy: 1}, function(code){
				UI.ajaxHide();
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				AP.alertSuccess("This file is private now. Only you can view it.");
				$("#bcanvas .__title .set_privacy").replaceWith("<span class='a action std set_privacy' onclick=\"FileX.setPublic('"+hid+"','"+token+"');\">Set public</span>");
			});
		});
	};
	
	
	this.setPublic=function(hid, token){
		AP.confirm("Are you sure that you want to set this file as <i>public</i>? This will allow other people to read this file.", function(){
			UI.ajaxShow();
			AP.post("api/file/setprivate",{hid: hid, token: token, privacy: 0}, function(code){
				UI.ajaxHide();
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				AP.alertSuccess("This file is set public now.");
				$("#bcanvas .__title .set_privacy").replaceWith("<span class='a action std set_privacy' onclick=\"FileX.setPublic('"+hid+"','"+token+"');\">Set private</span>");
			});
		});
	};
	
	
	
	this.newRev=function(hid, token, gid){
		this.pick2Save({hid: hid, token:token, gid: gid}, function(origin, file, log){
			FileX.ui.showRev(origin, file);
		});
	};
	
	
	this.initPicker=function(){
		var eventMethod = window.addEventListener ? "addEventListener" : "attachEvent";
		var eventer = window[eventMethod];
		var messageEvent = eventMethod == "attachEvent" ? "onmessage" : "message";

		// Listen to message from child window
		eventer(messageEvent,function(e) {
			switch(e.data) {
				case "validToken":
					FileX._showCreateForm();
					break;
				case "GoogleAPI failed":
					AP.ajaxHide();
					AP.alert("Something went wrong with Google Drive API. Please try again.")
					break;
				case "!_{h:''}":
					break;
				default:
					try{
						var data = JSON.parse(e.data);
						if(data.result == "gsuccess") {
							FileX.successGDoc(data);
						} else {
							FileX.pickerCallback(data);
						}
					} catch(e) {
						// !_h{}
						console.log(e);
					}
					break;
			}
		},false);
	};
	
	
	this.localSelect=function(file){
		FileX.pickerCallback(file);
	};
	
	this.replaceGdriveFrame = function(callback) {
		AP.closeDialog("#custom-selection");
		if (Client.https) {
			var extGTab = window.open("https://" + CONFIG.home_src + "/filepick/google", "_blank");
		} else {
			var extGTab = window.open("http://" + CONFIG.home_src + "/filepick/google", "_blank");
		}
	};
	
	this.sendMessage = function(child_id, msg) {
		var iframe = document.getElementById(child_id);
		iframe.contentWindow.postMessage(msg, '*');
	};
	
	this.createGDoc = function() {
		this.sendMessage('gjs-iframe', 'doAuth');
	};
	
	this._showCreateForm = function() {
		var text = "<h2>Create new public file in Google Drive</h2>";
		text += "<h6>Document title</h6><input type='text' name='title' id='gdoc-title' placeholder='Insert title of document'/>";
		text += "<h6>Choose type</h6><select name='type' placeholder='Type of document' id='gdoc-type'>";
		
		text += "<option value='" + this.fileTypes.GDOC + "'>Google Docs</option>";
		text += "<option value='" + this.fileTypes.GXLS + "'>Google Sheets</option>";
		text += "<option value='" + this.fileTypes.GPPT + "'>Google Slides</option>";
		text += "<option value='" + this.fileTypes.GDRAW + "'>Google Drawing</option>";
		text += "<option value='" + this.fileTypes.GFILE + "'>Google File</option>";
		
		text += "</select>";
			
		text += "<div class='buttons -two'><div class='button -error -first -rounded' onclick='AP.closeDialog(this);'>Cancel</div><div class='button -success -second -rounded' onclick='FileX.createNew(FileX.successGDoc);'>Create</div></div>";
	
		AP.customDialog(text)
		.width(500)
		.show();
	};
	
	
	this.createNew = function() {
		AP.ajaxShow();
		var title = $('#gdoc-title').val();
		
		if (!title || title.length == 0) {
			AP.alertError("Please enter file name.");
			AP.ajaxHide();
		} else {
			var type = $('#gdoc-type').val();
			var txtMsg = JSON.stringify({action: "create", title: title, type: type});
			this.sendMessage('gjs-iframe', txtMsg);
		}
	};
	

	
	/**
	 * Default callback when successfully creating new (public) file in Google Drive
	 */
	this.successGDoc = function(successObj) {
		AP.ajaxHide();
		var file = ({
			name:successObj.fileTitle,
			src: successObj.altLink,
			type:"google",
			preview:"https://drive.google.com/file/d/" + successObj.fileId + "/preview"
		});
		FileX.pickerCallback(file);
		AP.closeDialog('#custom-dialog');
		AP.closeDialog("#custom-selection");
		AP.alertSuccess("Your file has been created! <a target='_blank' href='"+successObj.altLink+"'>Click here</a> to edit.");
	};
	
	
	this.createTextFile = function() {
		var form = Form.create('textfile-create-fx', {action: 'api/file/prepare.text'})
		.row(
			Form.label({label: "File name *", "sublabel":"The name of the text file"}),
			Form.input({name: 'name', "placeholder":"A short name for the text file"})
		)
		.rowHTML(
			"<div class='input'><textarea placeholder='Fill content of text file here' name='content' style='height: 300px; width: 100%;'></textarea></div>" +
			"<div class='clear'></div>"
		)
		.render()
		.buttons([
			 {label: "Create text file", action: function() {
				 Form.submit("textfile-create-fx", function(code) {
					 if(code.good()) {
						 Form.hide("textfile-create-fx");

						 var file = {name: code.filename, content: code.txt, icon: UI.file.fontIcon("untitled.txt"), type: "txt"};
						 FileX.pickerCallback(file);
					 } else {
						 return AP.alertError(code.message);
					 }
				 });
			 }, style: 'ok -success -rounded bold'},
			 {label: "Cancel", action: function() {
				 Form.hide("textfile-create-fx");
			 }, style:'-cancel -passive-2 rounded'}
		]);
		
		
		Form.pop({id:'textfile-create-fx-dx', width: 720, 
			label: 'Create a new text file'
		}).setForm(form).show().focus('name');
	};
	
	
	function getMobileFileURL(file_url){
		return file_url;
	};
};




FileX.ui=new function __FileUI(){
	this.file=null;
	
	this.embed=function(file){
		if (parseInt(file.image)){
			return "<div class='box -fileemebd -full-image'><div class='-canvas'><img onclick=\"FileX.preview('"+file.hid+"','"+file.token+"');\" src='"+file.url+"'/></div></div>";
		}
		
		var icon=UI.file.icon(file.name);
		var preview="";
		if (file.metatype=="dropbox"){
			preview="<div class='-meta'><span class='ap-f14 ficon-dropbox'></span> &nbsp; <a class='normal std' target='_blank' href='"+file.src+"'>View on Dropbox</a></div>";
		}else if (file.metatype=="onedrive"){
			preview="<div class='-meta'><span class='ap-f14 ficon-windows'></span> &nbsp; <a class='normal std' target='_blank' href='"+file.src+"'>View on OneDrive</a></div>";
		}
		
		var stats=" &middot; "+file.stats.comments+" "+AP.word.plural("comment",file.stats.comments);
		
		
		return "<div class='box -fileembed'>" +
			"<div class='-image pull-left'><img src='"+Client.share_url+"/64/file-"+icon+".png'/></div>" +
			"<div class='-name'><b class='pointer' onclick=\"FileX.preview('"+file.hid+"','"+file.token+"');\">"+file.name+"</b></div>" +
			"<div class='-meta'>Created by @<b class='url username'>"+file.username+"</b> at "+UI.simpleTime(file.since)+"</div>" +
			preview+
		"</div>";
	};
	
	
	this.showRevs=function(){
		var file=this.file;
		if (!file){
			return;
		}
		
		var options=AP.select(file.revs, function(e, index){
			return {data: e, type: 'rev', label: "<b>Rev "+(index+1)+"</b>: "+e.name, sublabel: "Created at "+UI.simpleTime(e.since),"icon":"label_outline"};
		});
		
		options.push({type:'rev','label':"<b>Current version</b>: "+file.name, sublabel: "Created at "+UI.simpleTime(file.since), data: file});
		
		if (parseInt(file.user_id)==parseInt(Client.viewer.id)){
			options.push({type:'action','label':'<b>Create/upload a new revison</b>', sublabel:'Click to start creating a new version of this file', data: file});
		}
		

		AP.selectAction(options, function(opt){
			if (opt.type && opt.type=='action'){
				return FileX.newRev(opt.data.hid, opt.data.token, opt.data.gid);
			}
			
			FileX.ui.showRev(FileX.ui.file,opt.data);
			
		});
	};
	
	
	this.showRev=function(file, rev){
		BC.main(FileX.ui.getMain(rev));
		BC.title(FileX.ui.getTitle(file, rev));
	};
	
	
	
	this.getTitle=function(file, rev){
		var name=file.name;
		
		var meta=file.metatype;
		var since=file.since;
		if (rev){
			name=rev.name;
			download=rev.src;
			meta=rev.metatype;
			since=rev.since;
		}
		
		
		var icon=UI.file.icon(name);
		
		var download=file.src;
		if (meta=="" || meta=="upload"){
			download=Client.url+'/files/download?id='+file.id+"&token="+file.token+"&key="+file.src;
		}
		
		var rev_action='';
		if (parseInt(file.user_id)==parseInt(Client.viewer.id)){
		}
		
		
		var edit_action=" &middot; <span class='a action std' onclick=\"FileX.edit('"+file.hid+"','"+file.token+"','"+file.name+"');\">Edit</span>";
		var set_private=" &middot; <span class='a action std set_privacy' onclick=\"FileX.setPrivate('"+file.hid+"','"+file.token+"','"+file.name+"');\">Set private</span>";
		if (parseInt(file.privacy)==1){
			set_private=" &middot; <span class='a action std set_privacy' onclick=\"FileX.setPublic('"+file.hid+"','"+file.token+"','"+file.name+"');\">Set public</span>";
		}
		
		if (parseInt(file.user_id)!= parseInt(Client.viewer.id)){
			edit_action="";
			set_private="";
		}
		
		var revs_action="";
		if (file.revs && file.revs.length){
			revs_action="<span class='action icon' title='Revisions' onclick='FileX.ui.showRevs();'><span class='count'>"+file.revs.length+"</span><span class='-ap icon-layers2'></span></span>";
		}
		
		var other=" &middot; <span class='a action std advanced' onclick=\"FileX.options('"+file.hid+"','"+file.token+"','"+file.name+"');\">More options</span>";
		
		
		return "" +
			"<div class='image'><img src='"+Client.share_url+"/32/file-"+icon+".png'></div>"+
			"<h1 class='ap-xdot' title='"+name+"'>"+name+"</h1>" +
			"<h3>Created by <span class='a std url username'>@"+file.username+"</span> &middot; "+UI.simpleTime(since)+" &middot; Last activity "+UI.simpleTime(file.last_update)+" " +
			edit_action+set_private+
			rev_action+
			other+
			"</h3>" +
			"<div class='actions align-right'>" +
			revs_action+
			"   <span class='action icon' title='Extend preview' onclick='BC.extend();'><span class='-ap icon-open_in_new'></span></span>" +
			"   <a class='action icon' target='_blank' href='"+download+"' title='Download the file'><span class='-ap icon-get_app'></span></a>" +
		"</div>";
	};
	
	
	this.getSide=function(file){
		return "<div id='side-followers' class='section'></div> <div id='side-comment-"+file.id+"'></div>";
	};
	
	
	this.getMain=function(file){
		var regEx = /(?:\.([^.]+))?$/;
		var fileExtension = regEx.exec(file.name)[1];
		if (isImage(file)){
			return "<div class='embed-20 embed-image'><div class='image'><img src='"+file.src+"'/></div></div>";
		}else if (isEmbeddable(file) || (fileExtension == "txt")){
			
			if (file.metatype=="onedrive"){
				var url=file.src+"&em=2";
				
				// get cid
				var pos = url.indexOf('resid=');
				var suburl = url.substring(pos);
				var pivot = suburl.indexOf('!');
				var cid = suburl.substring(6, pivot);
				
				url = url.replace("redir?","embed?cid="+cid+"&");
				
				return "<div class='embed-20 embed-file -iframe'>" +
					"<iframe src=\""+url+"\" style='width:100%; height:100%;' frameborder='0' scrolling='no'></iframe>"+
				"</div>";
			}else if (file.metatype=="dropbox"){
				var url=file.preview;
				if (!url){
					return "<div style='margin-top: 60px; font-size: 15px; text-align:center;'>" +
							"<div class='featured' style='margin-bottom: 15px;'>This file has been picked from Dropbox and can't be previewed.</div>" +
							"<a href='" + file.src + "'>Click here to download file</a>" +
							"</div>";
				}
				
				url=url.replace("bounding_box=75","bounding_box=800");
				return "<div class='embed-20 embed-image'><div class='image'><img src='"+url+"'/></div></div>"
			}else if (file.metatype == "google" || file.metatype == "googledrive"){
				if ($.inArray(fileExtension, ['gdoc', 'gsheet', 'gdraw', 'gslides']) < 0) {
					return "<div class='embed-20 embed-file'>" +
						"<iframe src=\""+file.preview+"\" style='width:100%; height:100%;' frameborder='0'></iframe>"+
					"</div>";
				} else {
					return "<div class='embed-20 embed-file'>" +
						"<iframe src=\""+file.src.substr(0, file.src.lastIndexOf('?'))+"\" style='width:100%; height:100%;' frameborder='0'></iframe>"+
					"</div>";
				}
			}
			
			// M$ Office file types
			if ($.inArray(fileExtension, ['doc', 'docx', 'xls', 'xlsx', 'xlsm', 'ppt', 'pptx']) >= 0) {
				return "<div class='embed-20 -iframe embed-file'>" +
					"<iframe src=\"https://view.officeapps.live.com/op/view.aspx?src="+file.src+"\" style='width:100%; height:100%;' frameborder='0'></iframe>"+
				"</div>";
			}

			if (fileExtension == "pdf") {
				return "<div class='embed-20 embed-file -iframe'>"+
					"<iframe src='" + file.src + "' style='width:100%; height:100%;' frameborder='0'></iframe>" +
				"</div>";
			}

			if (Client.https) {
				return "<div class='embed-20 -iframe embed-file'>" +
					"<iframe src=\"https://docs.google.com/gview?url="+file.src+"&embedded=true\" style='width:100%; height:100%;' frameborder='0'></iframe>"+
				"</div>";
			}
			return "<div class='embed-20 -iframe embed-file'>" +
				"<iframe src=\"http://docs.google.com/gview?url="+file.src+"&embedded=true\" style='width:100%; height:100%;' frameborder='0'></iframe>"+
			"</div>";
		}else{
			var download=file.src;
			return "<div class='center' style='padding:20px;'>No preview avaiable. Please <a href='"+download+"' target='_blank'>download the file</a>.</div>";
		}
	};
	
	
	
	function isImage(file){
		if (file.image && parseInt(file.image)){
			return true;
		}

		return false;
	};
	
	
	function isEmbeddable(file){
		var ext=UI.file.icon(file.name);
		
		if (file.metatype=="onedrive"){
			return true;
		}
		
		if (file.metatype=="dropbox" && file.preview && file.preview.length && (ext=="png" || ext=="jpg" || ext=="jpeg" || ext=="gif")){
			return true;
		}
		
		if (file.metatype == "google" || file.metatype == "googledrive"){
			return true;
		}
		
		if (ext=="word" || ext=="excel" || ext=="pdf" || ext=="ppt" || ext=="txt"){
			return true;
		}
		
		return false;
	};
};



function file_local_change(ref, callback){
	var $ref=$(ref);
	var val=$ref.val();
	var $p=$ref.parent();
	
	var filename=getUploadFN(val);
	
	if (!AP.word.fileX(filename,'png jpg jpeg gif bmp psd pdf ai doc docx ppt pptx xls xlsx xlsm txt zip rar log csv txt pps tar')){
		return AP.alertError("Please choose an regular file");
	}
	
	var id=AP.uuid();
	var icon=UI.file.fontIcon(filename);
	
	var file={name: filename, icon: icon, input: $ref, type: "upload"};
	
	callback(file);
};FileX.upload=new function __FileUpload(){
	this.now=function(file, data, callback, error_callback){
		if ($("#instant-file-upload").length){
			$("#instant-file-upload").html("").empty().remove();
		}
		
		var $form=$("<form id='instant-file-upload' action='api/file/upload' class='__temp'></form>");
		$form.appendTo("#ap-temp");
		this.copy(file, $form);
		
		AP.ajaxShow("Uploading ...");
		
		AP.submit($form, function(code){
			AP.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			callback(code.origin, code.file, code.log);
		}, data);
	};
	
	
	this.copy=function(file, $form){
		file.input.appendTo($form);
		$("#file-upload-input-inv").html("<input type='file' name='file' onchange='file_local_change(this, FileX.localSelect);'/>");
	};
	
	this.txt = function(data, callback, error_callback){
        AP.ajaxShow("Uploading ...");
        
        AP.post("api/file/create.text", data, function(code){
            AP.ajaxHide();
            
            if (!code.good()){
                return AP.alertError(code.message);
            }
            
            callback(code.origin, code.file, code.log);
        });
    };
};FileX.auto=function(canvas, obj, opts){
	var counter="";
	if (obj.stats && obj.stats.files){
		counter="("+obj.stats.files+")";
	}
	
	var html="<span class='button -stroked -rounded'><span class='-ap icon-upload3'></span>&nbsp; Upload</span><h1>Files <small class='file-counter-"+obj.gid+"'>"+counter+"</small></h1> <div class='sep-10'></div> <div class='list list-files -no-border'></div>";
	
	$(canvas).html(html);
	$(canvas).find(" > .button").click(function(){
		FileX.create(obj, function(file, log){
		});
	});
	
	
	AP.post("api/file/load",{hid: obj.hid, token: obj.token}, function(code){
		if (!code.good()){
			$.log("ERROR: File cannot be loaded");
			$.log(obj);
			// return AP.alertError(code.message);
			return;
		}
		
		
		for (var i=0; i<code.files.length; i++){
			var html=getFileHTML(code.files[i]);
			$(html).appendTo($(canvas).find(".list-files")).data("object", code.files[i]).click(function(){
				var obj=$(this).data("object");
				FileX.quickPreview(obj);
			});
		}
		
		
		if (!code.files.length){
			html ="<div class='empty -side'>No file was found in here ...</div>";
			$(canvas).find(".list-files").html(html);
		}
		
	});
	
	
	AP.removeListener("new-file-"+obj.gid);
	
	AP.on("new-file-"+obj.gid, function(file, log, origin){
		$(canvas).find(".list-files").prepend(getFileHTML(file)).data("object", file).click(function(){
			var _obj=$(this).data("object");
			FileX.quickPreview(_obj);
		});
		
		$(".file-counter-"+origin.gid).html("("+origin.stats.files+")");
		$(canvas).find(".empty").hide();
	});
	
	
	function getFileHTML(f){
		var icon=Client.share_url+"/32/file-"+UI.file.icon(f.name)+".png";
		return "<div class='li'><span class='icon -fi'><img src='"+icon+"'></span>" +
				"<div class='text ap-xdot'>"+f.name+"" +
					"<div class='sub'>Created by @<span class=''>"+f.username+"</span> &middot; "+UI.simpleTime(f.since)+"</div>" +
				"</div>" +
			"</div>";
	};
};var N=new function __N(){
	this.api=Base.apiURL()+"api/me/";
	
	
	this.tabID=AP.uuid();
	this.appID=((Client.base && Client.base.app)? Client.base.app :"none"); 
	this.__off=false;
	this.__init=false;
	
	this.off=function(){
		this.__off=true;
	};
	
	this.init=function(){
		if (this.__off || this.__init){
			return;
		}
		
		this.__init=true;
		
		this.ui.init();
		DN.init();
		
	};
	
	
	this.hideAll=function(){
		N.ui.hide();
		// N.work.hide();
		// Chat.panel.hide();
		// Todo.notis.hide();
	};
	
	
	this.broadcast=function(){
		if ((typeof Client.base !== 'undefined') && (typeof Client.base.app !== 'undefined')){
			Clog.log("appid", this.appID);
			Clog.log("tabid", this.tabID);
			
			$(window).focus(function() {
				Base.__systemActive=1;
				Clog.log("tabid", N.tabID);
				Clog.log("appid", N.appID);
			}).on("blur", function(){
				Base.__systemActive=0;
			});	
		}
	};
};




N.live=new function __NLive(){
	this.init=function(){
		
	};
};



N.ui=new function __NotisUI(){	
	this.last_load=0;
	this.has_new=true;
	this.canvas="#base-notis";
	this.__inited=false;
	
	
	this.init=function(){
		this.has_new=true;
		
//		Client.num_notis=parseInt(Client.num_notis);
//		if (Client.num_notis){
//			show_badge(Client.num_notis);
//		}
	};
	
	
	this.update=function(user){ 
		this.trigger(user);
	};
	
	this.toggle=function(ref){
		if (!$(this.canvas).is(":visible")){
			N.hideAll('notis');
			this.load(ref);
		}else{
			this.hide();
		}
	};
	
	this.show=function(ref){
		this.load(ref);
	};
	
	
	this.trigger=function(user){
		this.has_new=true;
		show_badge(user.num_notis);
		animate_badge();
	};
	
	
	this.load=function(ref){
		if (AP.time.now()-this.last_load>30*60){
			// 30 min waiting
			this.has_new=true;
		}
		
		if (!this.has_new){
			$(this.canvas).show();
			return;
		}
		
		if ($(ref).ajaxOn()){
			return;
		}
		
		
		if (Live.mode=="socket"){
			// Use socket instead of get
			Live.post("notifications.get", {last_update: 0}, function(data){
				// $(ref).ajaxOn();
				if (!data.params){
					return;
				}
				
				N.ui.last_load=AP.time.now();
				N.ui.has_new=false;
				clear_badge();
				
				if (data.params.load_more){
					N.ui.displayAppend(data.rows);
					if (!data.rows.length){
						N.ui.showNoMore();
					}
				}else{
					if (data.rows && data.rows.length){
						N.ui.display(data.rows);
					}else{
						N.ui.showNoMore();
					}
				}
			});
		}else{
			UI.ajaxShow();
			AP.post(N.api+"notification/load",{stoken: Client.base.secureData.token}, function(code){
				UI.ajaxHide();
				
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				N.ui.last_load=AP.time.now();
				N.ui.has_new=false;
				N.ui.display(code.notifications);
				clear_badge();
			});
		}
	};
	
	
	this.hide=function(){
		$(this.canvas).hide();
	};

	
	this.insert=function(notis){
		var html=get_html(notis);
		var last_update=real_ts(notis.last_update);
		var lsince=0;
		
		if (!AP.time.sameDay(last_update, AP.time.now())){
			var date=AP.time.time('%d%m%Y',last_update);
			
			if (!$("#base-notis-items .js-sep-"+(date)+"").length){
				var dago=Math.floor((AP.time.now()-AP.time.beginOfDay(last_update))/(24*3600));
				ago="<span class='diff'>"+dago+" days ago</span>";
				
				$(this.canvas+"-items").append("<div class='datesep js-sep-"+(date)+"'><span class='d'>"+(AP.i18n.date(last_update))+"</span> "+(ago)+"</div>");	
			}
		}	
		
		
		$(this.canvas+"-items").append(html);
	};
	
	
	this.display=function(notifications){
		$(this.canvas+"-items").html('');
		
		for (var i=0; i<notifications.length; i++){
		   this.insert(notifications[i]);
		}
		
		$(this.canvas).show();
		update_last(notifications);
		this.scrollable();
	};
	
	
	this.displayAppend = function(notifications){
		for (var i=0; i<notifications.length; i++){
			this.insert(notifications[i]);
		}
		
		
		// var html=AP.render(notifications, function(notis,index, total){
		//  return get_html(notis);
		// });
		// $(this.canvas+"-items").html(html);
		$(this.canvas).show();
		update_last(notifications);
		this.scrollable();
	};
	
	
	this.scrollable=function(){
		if (!this.__inited){
			Layout.scrollable(this.canvas+"-scroll");
			this.__inited=true;
		}
	}
		
	
	this.html=function(notis){
		return get_html(notis);
	}
	
	this.loadMore = function() {
		var last_update = $(this.canvas+"-items div.notis:last-child").data('ts');
		
		if (last_update == -1) return;
		
		if (Live.mode=="socket"){
			Live.emit("notifications.get", {stoken: Client.base.secureData.token, last_update: last_update, load_more: 1});
		}else{
			$("#item-notis").ajaxShow();
			AP.post(N.api+"notification/load", {stoken: Client.viewer.stoken, last: last_notis}, function(code){
				$("#item-notis").ajaxHide();
				
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				if (code.notifications.length > 0) {
					N.ui.last_load = AP.time.now();
					N.ui.has_new = false;
					N.ui.displayAppend(code.notifications);
					clear_badge();
				} else {
					N.ui.showNoMore();
				}
				
			});
		}
	};
	
	
	this.showNoMore=function(){
		$(N.ui.canvas + "-items").append("<div class='notis' data-nid='-1' data-ts='-1' style='padding-top: 17px; display: inherit; text-align: center; font-size: 15px;'><em>No more notification</em></div>");
	};
	
	this.markRead=function(id, ref){
		if (!$(ref).hasClass("unread")){
			return;
		}
		
		if (Live.mode=="socket"){
			Live.post("notifications/mark.read", {notis_id: id}, function(data){
				if (data.code && parseInt(data.code)){
					$(ref).removeClass("unread");
				}
			});
		}else{
			AP.post(N.api+"notification/mark.read", {stoken: Client.viewer.stoken, notis_id: id}, function (code) {
				if (!code.good()) {
					AP.alertError(code.message);
				}else {
					$(ref).removeClass("unread");
				}
			});
		}
	};
	
	
	function clear_badge(){
		show_badge(0);
	};
	
	function show_badge(count){
		if (count && count>0){
			$(N.ui.canvas+"-badge").html(count).show();
		}else{
			count=0;
			$(N.ui.canvas+"-badge").hide();
		}
	};
	
	function animate_badge(){
		$(N.ui.canvas+"-badge").animate({fontSize: '15px'}, 400).animate({opacity:1.0}, 1000).animate({fontSize: '11px'}, 400, function(){});
	};
	
	
	function get_html(notis){
		if ($("#base-notis-items .js-notis-"+notis.id).length){
			return "";
		}
		
		var unread=false;
		
		if (parseInt(notis.last_update) > Client.last_seen_notis){
			// unread=true;
		}
		
		if (!parseInt(notis.last_clicked) && AP.time.now()-parseInt(notis.last_update)<60*24*3600){
			unread=true;
		}
		
		if (notis.link){
			var inspect=Base.inspect(notis.link);
			if (inspect.base){
				notis.link=inspect.url;
			}	
		}else{
			notis.link="";
		}
		
		
		if (unread){
			unread=' unread';
		}
		
		
		var app_icon="";
		if (!notis.app){
			var data=notis.data;
			
			if (AP.data.isString(data)){
				data = "";
				try{
					data = JSON.parse(notis.data);
				} catch (e) {
					console.log(e);
				}

			}
			
			if (data && data.__app){
				notis.app=data.__app;
			}
		}
		
		if (notis.app){
			app_icon="<div class='appicon'><img src='"+Client.share_url+"/apps/"+notis.app+".png'/></div>";
		}
		
		var ts=real_ts(notis.last_update);
		
		var items="";
		if (notis.lasts && notis.lasts.length){
			try{
				var lasts=JSON.parse(notis.lasts);
				if (lasts && lasts.length){
					items=AP.render(lasts, function(e, index){
						return "<div class='subitem'> <div class='sname ap-xdot'>"+(e.title)+"</div> <div class='stime' title='"+(AP.i18n.datetime(real_ts(e.since)))+"'>"+(AP.i18n.time(real_ts(e.since)))+"</div> </div>";
					});
					
					if (index>3){
						return "";
					}
				}
			}catch(e){
				
			}
			
		}
		
		var body=((notis.body && notis.body.length)?("<div class='body'>"+UI.clean(notis.body)+"</div>"):"");
		
		return "<div class='li url notis "+(unread)+" js-notis-"+(notis.id)+"' data-url='"+(notis.link)+"' data-nid='"+(notis.id)+"' data-ts='"+(ts*1000)+"' onclick='N.ui.hide(); N.ui.markRead("+(notis.id)+", this);' data-since='"+(ts*1000)+"'> <div class='avatar avatar-40 -circled'><div class='image'><img src='"+(AP.xthumb(notis.image))+"'/></div></div> <div class='text'> <div class='-title'>"+(notis.title)+"</div> "+(body)+" "+(items)+" <div class='info'>"+(AP.i18n.datetime(ts))+"</div> "+(app_icon)+" </div> </div>";
			
	};
	
	
	function real_ts(ts){
		ts=parseInt(ts);
		if (ts<1600000000){
			return ts;
		}
		
		return Math.floor(ts/1000);
	};
	
	function update_last(objs){
		for (var i=0; i<objs.length; i++){
			var since=parseInt(objs[i].since);
			if (since>Client.last_seen_notis){
				Client.last_seen_notis=since;
			}
		}
	};
};


/**
 * @desc Desktop notification
 */

// Log latest channels




var DN=new function __DN(){
	this.state="unset";
	this.direct=true;
	
	
	if (Client.url && Client.url.indexOf("account.base")!=-1){
		// this.direct=true;	
	}
	
	this.init=function(){
		if (mobile()){
			return;	
		}
		
		$("#fallback-notis").click(function(){
			var options=$(this).data("options");
			
			if (options.url && options.url.length){
				AP.toURL(options.url);	
			}else if (options.action){
				options.action();
			}else{
				$.log(options);
			}
			
			$("#fallback-notis").hide();
		});
		
		
		
		 if (!("Notification" in window)){
			 return;
		 }
		 
		 
		 if (!mobile()){
			 if (Notification.permission == "granted"){
			 }else if (Notification.permission == "denied"){
			 }else{
				 if (this.direct){
					 this.showRequestNotification(); 
				 }
			 }
			 
			 if (!this.direct){
				 DN.indirect.init(); 
			 } 
		 }
	};
	
	
	this.show=function(opts){
		if (!opts){
			return;
		}
		
		if (!opts.time){
			opts.time=5000;
		}
		
		if (!opts.tag){
			if (!opts.id){
				opts.tag=AP.time.now();
			}else{
				opts.tag=opts.id;
			}
		}
		
		if (!opts.__state){
			opts.__state=opts.tag;
		}
		
		if (!opts.url){
			opts.url='';
		}
		
		if (!opts.dir){
			opts.dir=null;
		}
		
		var options = {
			body: UI.clean(opts.body),
			icon: opts.icon,
			url: opts.url,
			tag: opts.tag,
			time: opts.time,
			title: opts.title,
			__state: opts.__state,
			__data: opts
	    };
		
		
		if (opts.action){
			options.action=opts.action;
		}
	
		var timer=500;
		var inspect=Base.inspect(opts.url);
		var test_url=opts.url;
		if (inspect.base){
			test_url=inspect.url;
		}
		
		if (AP.word.prefix(test_url, Client.url)){
			timer=0;
		}
		
		setTimeout(function(){
			notificationNow(opts, options);
		}, timer);
	};
	
	
	this.notify = this.show;
	
	this.bip=function(index, key){
		if (key && localStorage){
			var item=localStorage.getItem("sound");
			if (item==key){
				return;
			}
			localStorage.setItem("sound", key);
		}
		
		
		return document.getElementById('audio'+index).play();
		
	};
	
	
	this.bipInf=function(index, play){
		if (play){
			document.getElementById('audio'+index).play();
			$("#audio"+index).on("ended", function(){
				this.play();
			});	
		}else{
			var s=document.getElementById('audio'+index);
			s.pause();
			s.currentTime = 0;
		}
	};
	
	
	
	this.requestDesktopNotification=function(){
		if (!this.direct){
			return DN.indirect.openRequest();
		}
		
		Notification.requestPermission(function (permission) {
			if (!('permission' in Notification)) {
				Notification.permission = permission;
			}
		  
			if (permission === "granted") {
				// Okay, we are good
				// Get back to direct method
				DN.direct=true;
			}
		});
	};
	
	
	this.showRequestNotification=function(){
		$("#notification-request").show().find(".main").click(function(){
			 if (DN.indirect.request_popup){
				 $("#notification-request").hide();
			 }
			 DN.requestDesktopNotification();
		 });
	};
	
	
	
	function notificationNow(opts, options){
		if (!("Notification" in window) || DN.state=="denied") {
			logNotified(options.__state);
			return fallback(opts, options);
		}
		
		
		if (Base.systemActive()){
			logNotified(options.__state);
			return fallback(opts, options);
		}
		
		if (!options.flatten){
			var inspect=Base.inspect(options.url);
			
			if (inspect.base){
				options.url=inspect.url;
			}
		}
		
		realDesktopNotification(UI.clean(opts.title), options);
	};
	
	
	function realDesktopNotification(title, options){
		if (notified(options.__state)){
			Base.console("SKIP BECAUSE STATE FOUND",options.__state);
			return;
		}
		
		logNotified(options.__state);
		
		if (!DN.direct){
			DN.indirect.notify(title, options);
			return;
		}
		
		    
		// delete options.__data;
		// delete options.__state;
		// delete options.data;
		// options.image=options.icon;
		
		// options.silent=true;
		var notification = new Notification(title, options);

		notification.onclick=function(){
			window.focus();
			if (options.url && options.url.length){
				AP.toURL(options.url);	
			}else if (options.action){
				options.action();
			}else{
				
			}
			
	    	this.close();
		};
		
		notification.onerror=function(e){
		};
		
		notification.onshow=function(e){
		};
		
		notification.onclose=function(){
		};
		
		setTimeout(function(){
		    if (notification){
		    	notification.close();
		    }
		}, 5000);
	};
	
	
	
	function fallback(opts, options){
		var inspect=Base.inspect(options.url);
		if (inspect.base){
			options.url=inspect.url;
		}
		
		$("#fallback-notis .image").html("<img src='"+options.icon+"'/>");
		$("#fallback-notis .footer").html(UI.simpleTime(options.time));
		$("#fallback-notis .content").html(options.body);
		$("#fallback-notis .title").html(opts.title);
		
		$("#fallback-notis").data("options", options).data("timer", AP.time.now()).show();
		
		fallback_hide();
	};
	
	
	function fallback_hide(){
		setTimeout(function(){
			var timer=parseInt($("#fallback-notis").data("timer"));
			if (AP.time.now() - timer >= 5){
				$("#fallback-notis").hide();
			}else{
				fallback_hide();
			}
		},5500);
	};
	
	
	
	
	function notified(token){
		var ln=Clog.getCookie("__ln");
		if (!ln){
			ln="";
		}
		
		if (ln==token){
			return true;
		}
		
		return false;
	};
	
	
	function logNotified(token){
		Clog.setCookie("__ln", token);
	};
	
};



DN.indirect = new function __DNIndirect(){
	// Request on iframe or on a new windows
	this.request_popup=true;
	
	this.url="http://"+Client.domain;
	
	if (Client.https && parseInt(Client.https)){
		this.url="https://"+Client.domain;	
	}
	
	this.api=this.url+"/notify/";
	this.receiver = null;
	this.events={};
	this.last_clear=0;
	
	this.notify=function(title, options){
		var id=AP.uuid();
		var xopts={
			icon: options.icon,
			body: options.body,
			title: options.title,
			tag: options.tag
		};
		var obj={'title': title, 'options': xopts, __refid: id, __domain: Client.url}
		
		this.logEvent(id, options);
		this.receiver.postMessage(obj, this.url);
	};
	

	this.init=function(){
		if (!$("#idn_iframe").length){
			$("<iframe id='idn_iframe' style='display:none' src='"+this.api+"'/>").appendTo($(document.body));
			this.receiver = document.getElementById('idn_iframe').contentWindow;
		}
		
		window.addEventListener('message', function(e){
			var org=e.origin;
			if (org!=DN.indirect.url){
				return;
			}
			
			var data = e.data;
			
			if (data.event=="notis.perm"){
				return DN.indirect.request(data.p);
			}
			
			if (data.event=="int.perm.result"){
				return DN.indirect.response(data.event.p);
			}
			
			if (!data || data.event!="notis.indirect.click"){
				return;
			}
			
			var event=DN.indirect.getEvent(data.refid);
			if (!event){
				return;
			}
			
			var options=event.options;
			
			if (options.url && options.url.length){
				AP.toURL(options.url);	
			}else if (options.action){
				options.action();
			}else{
			}
		});
	};
	
	
	this.internalEvent=function(event, data){
		this.receiver.postMessage({
			'event': event,
			'data': data
		}, this.url);
	};
	
	
	this.getEvent=function(id){
		if (this.events[id]){
			return this.events[id];
		}
		
		return null;
	};
	
	
	this.logEvent=function(id, options){
		var limit=4;
		var now=AP.time.now();
		this.events[id]={time: now, options: options};
		
		if (now - this.last_clear>limit){
			this.last_clear=now;
			for (var key in this.events){
				if (now - this.events[key].time > limit){
					delete this.events[key];
				}
			}
		};
	};
	
	
	
	this.request = function(current){
		if (current=="denied"){
			DN.state="denied";
			
			checkIncognito(function(){
				$.log("INCOGNITO MODE!!!");
			}, function(){
				DN.showRequestNotification();
			});
		}
		
		if (current=="pending"){
			DN.showRequestNotification();
		};
		
		if (current=="granted"){
			// 
			$.log("Desktop notification is granted ...");
			DN.direct=true;
		};
	};
	
	
	this.openRequest=function(){
		if (this.request_popup){
			this.openRequestPopup();		
		}else{
			this.internalEvent("int.perm.request");
		}
	};
	
	
	this.openRequestPopup=function(){
		Clog.log("npe", 0);
		window.open(this.api+"?request=1");
		
//		var intv=setInterval(function(){
//			var n=Clog.getLog("npe");
//			if (n==1 || n=="1"){
//				return AP.refresh();
//			}
//		},500);
	};
	
	
	this.response=function(p){
		AP.refresh();
	};
	
	
	function checkIncognito(incog, notincog){
		var fs = window.RequestFileSystem || window.webkitRequestFileSystem;
		if (!fs){
			return false;
		}else{
			fs(window.TEMPORARY,100, function(){
				notincog();
			},function(){
				incog();
			});
		}
	};
};


N.reminder=new function __NReminder(){
	this.get=function(){
		
	};
	
	this.render=function(list){
		
	};
};


N.live=new function __NLive(){
	this.init=function(){
		
	};
};



N.broadcast();

var Reminder=new function __Reminder(){
	this.__inited=false;
	this.__state=AP.uuid();
	
	this.init=function(){
		if (mobile()){
			return;
		}
		
		prepare();
		scheduleAlert();
		
		this.api("meaningful", {}, function(rows, code){
			Reminder.ui.list(rows);
		});
	};
	
	
	/**
	 * @desc API endpoint
	 */
	this.api=function(endpoint, data, callback){
		data._rstate=Reminder.__state;
		data._endpoint=endpoint;
		
		Live.post("reminders."+endpoint, data, function(code){
			code.rows=AP.array.sortObj(code.rows, "time");
			for (var i=0; i<code.rows.length; i++){
				try {
					code.rows[i].data=JSON.parse(code.rows[i].data);
			    } catch(e) {
			        code.rows[i].data={};
			    }
			}
			
			return callback(code.rows, code);
		}, true);
	};
	
	
	/**
	 * @desc Loading tab
	 */
	this.loadTab=function(tab){
		if (tab=="today"){
			this.api("today", {}, function(rows, code){
				$("#reminder-items .tab-today .ritems").html(AP.render(rows, function(e){
					return Reminder.ui.getHTML(e);
				}));
			});
		}else if (tab=="late"){
			this.api("late", {}, function(rows, code){
				$("#reminder-items .tab-late .ritems").html(AP.render(rows, function(e){
					return Reminder.ui.getHTML(e);
				}));
			});
		}
	};
	
	
	this.insert=function(reminder){
		return Reminder.ui.insert(reminder);
	};
	
	
	this.remove=function(reminder){
		return Reminder.ui.remove(reminder);
	};
	
	
	/**
	 * @desc Check if a calendar is ever meaningful
	 */
	this.meaningful=function(e){
		var state=parseInt(e.state);
		var alert=parseInt(e.alert);
		var now=AP.time.now();
		var deadline=parseInt(e.time);
		var offset=7;
		
		if (deadline>now+offset*24*3600 || deadline<now-offset*24*3600){
			return 0;
		}
			
		
		if (state==1){ // ALREADY HANDLE
			return 0;
		}
		
		if (state==0){ // NO STATE
			if (deadline>=now){
				return 1;
			}else{
				return 0;
			}
		}
		
		if (state==-1){ // PENDING
			if (deadline>=now -offset *24*3600){
				return 1;
			}
			
			return 0;
		}
		
		return 0;
	};
	
	
	
	function prepare(opts){
		if (mobile()){
			return;
		}
		
		if (Reminder.__inited){
			return true;
		}
		
		Reminder.__inited=true;
		
		opts=$.extend({}, opts, {display: "notification"});
		Reminder.ui.initCanvas(opts);
		bindEvents();
	};
	
	
	
	function scheduleAlert(){
		setInterval(function(){
			Reminder.alarm.check();
		}, 2000);
	};
	
	
	
	function bindEvents(){
		Live.on("reminder", function(e){
			Reminder.insert(e);
		});
		
		Live.on("server.reminder.remove", function(e){
			Reminder.remove(e);
		});
	};
	
};



Reminder.ui=new function __ReminderUI(){
	this.rows=[];
	this.counter=0;
	
	/**
	 * @desc Show a list of reminders
	 */
	this.list=function(rows){
		rows=AP.array.uniqueObjects(rows);
		
		rows=AP.array.filter(rows, function(e){
			return Reminder.meaningful(e);
		});
		
		rows=AP.array.sortObj(rows, "time");
		rows=AP.array.cut(rows, 200);
		
		for (var i=0; i<rows.length; i++){
			rows[i].r0=0;
			rows[i].r30=0;
			rows[i].r60=0;
		}
		
		this.rows=rows;
		
		var total=0;
		sections={
			"today": "",
			"late": "",
			"upcoming": "",
			"other": ""
		};
		
		var counters={
			"today": 0,
			"late": 0,
			"upcoming": 0,
			"other": 0
		};
		
		for (var i=0; i<rows.length; i++){
			var meaningful=Reminder.meaningful(rows[i]);
			
			total+=meaningful;
			var section=getSection(rows[i]);
			counters[section]++;
			
			if (section=="upcoming"){
				sections[section]=Reminder.ui.getHTML(rows[i])+sections[section];	
			}else{
				sections[section]+=Reminder.ui.getHTML(rows[i]);
			}
		}
		
		var html="";
		if (sections.today.length){
			html+="<div class='section-title'>Today <span class='count'>"+(counters.today)+"</span></div><div class='section-body'>"+(sections.today)+"</div>";
		}
		
		if (sections.late.length){
			html+="<div class='section-title'>Late <span class='count'>"+(counters.late)+"</span></div><div class='section-body'>"+(sections.late)+"</div>";
		}
		
		if (sections.upcoming.length){
			html+="<div class='section-title'>Upcoming <span class='count'>"+(counters.upcoming)+"</span></div><div class='section-body'>"+(sections.upcoming)+"</div>";
		}
		
		if (sections.other.length){
			html+="<div class='section-title'>Other <span class='count'>"+(counters.other)+"</span></div><div class='section-body'>"+(sections.other)+"</div>";
		}
		
		$("#reminder-items .tab-meaningful .ritems").html(html);
		
		setCounter(total);
	};

	
	
	
	this.remove=function(reminder){
		$("#reminder-items .js-reminder-"+reminder.id).remove();
		$("#reminder-calendar .js-reminder-"+reminder.id).remove();
		
		this.rows=AP.array.removeByID(this.rows, reminder.id);
		this.list(this.rows);
	};
	
	this.insert=function(reminder){
		this.rows.unshift(reminder);		
		this.list(this.rows);
	};
	
	
	this.getHTML=function(e){
		var appicon="";
		if (e.data.app && e.data.app){
			appicon="<div class='appicon'><img src='"+(Client.share_url)+"/apps/"+(e.data.app)+".png'/></div>";
		}
		
		var overdue=0;
		if (parseInt(e.state)==-1 && parseInt(e.time)<AP.time.now()){
			overdue=1;
		}
		
		return "<div class='item meaningful-"+(Reminder.meaningful(e))+" overdue-"+(overdue)+" state-"+(e.state)+" alert-"+(e.alert)+" js-reminder-"+(e.id)+"' data-deadline='"+(AP.i18n.datetime(e.time))+"'> <div class='dot'></div> <div class='name'>"+(e.name)+"</div> <div class='info'><span class='time'>"+(AP.i18n.datetime(e.time))+"</span> <span class='hidden'>&middot; Overdue</span></div> <div class='trigger'>"+(appicon)+"<span class='-ap icon-keyboard_arrow_right'></span></div> <div class='alert'></div> <div class='actions'> <span class='action -ignored' title='Ignore this reminder' onclick='Reminder.action.ignore("+(e.id)+")'>Ignored</span> </div> <div class='mask url' data-url='"+(e.link)+"' ></div> </div>";
	};
	
	
	
	this.initCanvas=function(opts){
		var html="<div id='reminder-canvas-wrapper'> <div id='reminder-button' title='Reminders for you today'> <div id='reminder-round'></div> <div class='icon'><img src='"+(Client.share_url)+"/task.png'/></div> <div class='count'></div> </div> <div id='reminder-canvas'> <div class='reminder-header'> <div class='reminder-close' title='Close the reminder dialog'><span class='-ap icon-close'></span></div> <div class='title'>Reminders</div> <div class='tabs clear-fix'> <div class='tab active' data-tab='meaningful'><span class='icon ficon-bell'></span> Important</div> <div class='tab' data-tab='today'><span class='icon ficon-circle-o'></span> Today</div> <div class='tab' data-tab='late'><span class='icon ficon-exclamation-circle'></span> Lates</div> </div> </div> <div class='reminder-body scroll-y'> <div id='reminder-items'> <div class='tab tab-meaningful' data-tab='meaningful'> <div class='notice'>Several things needed your attention <div class='count'></div> </div> <div class='ritems only-meaningful'></div> </div> <div class='tab tab-today' data-tab='today'> <div class='ritems'></div> </div> <div class='tab tab-late' data-tab='late'> <div class='ritems'></div> </div> </div> </div> <div class='reminder-footer' onclick='Reminder.calendar.display();'> <span class='icon ficon-external-link-square'></span> &nbsp; Open calendar </div> </div> </div> "+(Reminder.calendar.getCanvas())+"";
		
		$("#base-notis").after(html);
		
		
		$("#reminder-button").click(function(){
			$("#reminder-canvas-wrapper").toggleClass("active");
		});
		
		$("#reminder-canvas .reminder-header .reminder-close").click(function(){
			$("#reminder-canvas-wrapper").removeClass("active");
		});
		
		UI.tabView("#reminder-canvas .reminder-header .tabs .tab", "#reminder-canvas .reminder-body .tab", function(tab){
			Reminder.loadTab(tab);
		});
		
		
		AP.html.resize(function(){
			$("#reminder-canvas").height($(window).height()-130);
		}, true);
		
		
		$("#reminder-calendar .header .tab").click(function(){
			var tab=$(this).data("tab");
			
			$(this).siblings().removeClass("active");
			$(this).addClass("active");
			
			if (tab=="meaningful"){
				$("#reminder-calendar").addClass("meaningful");
			}else{
				$("#reminder-calendar").removeClass("meaningful");
			}
		});
		
		if (Client.base && Client.base.app){
			var app=Client.base.app;
			if (app=="sysadmin"){
				$("#reminder-button").css({left: 20});
				$("#reminder-canvas").css({left: 2});
			}
		}
	};
	
	
	function setCounter(total){
		if (total){
			$("#reminder-button .count").html(total).show().addClass("hl");
			$("#reminder-items .notice .count").html("<em>"+total+"</em>")
			$("#reminder-items .notice").show();
			
			setTimeout(function(){
				$("#reminder-button .count").removeClass("hl");	
			},2000)
		}else{
			$("#reminder-button .count").hide();
			$("#reminder-items .notice").hide();
		}
	};
	
	
	function getHTML(r){
		
	};
	
	
	function getSection(e){
		var now=AP.time.now();
		var time=parseInt(e.time);
		if (AP.time.sameDay(time, now)){
			return "today";
		}
		
		if (time < now){
			if (e.state==-1){
				return "late";
			}
		}
		
		if (time > now){
			return "upcoming";
		}
		
		return "other";
	};
	
	
	function showSections(sections){
		
	};
};


Reminder.calendar=new function __ReminderCalendar(){
	this.ts=AP.time.now();
	this.__inited=false;
	
	this.show=function(ts){
		this.ts=parseInt(ts);
		
		initLayout(this.ts);
		loadReminders(this.ts);
	};

	this.today=function(){
		this.show(AP.time.now());
	};
	
	this.prev=function(){
		this.ts=this.ts-7*24*3600;
		this.show(this.ts);
	};
	
	this.next=function(){
		this.ts=this.ts+7*24*3600;
		this.show(this.ts);
	};
	
	this.display=function(){
		if (!this.__inited){
			this.__inited=true;
			this.show(AP.time.now());
		}
		
		$("#reminder-calendar-wrappers").show();
	};
	
	this.hide=function(){
		$("#reminder-calendar-wrappers").hide();
	};
	
	this.getCanvas=function(){
		var days="";
		for (var i=0; i<7; i++){
			days+="<div class='day js-day day-"+(i)+"'> <div class='dheader'></div> <div class='dbody'> <div class='dgrid'></div> <div class='ditems ditems-am'></div> <div class='ditems ditems-pm'></div> </div> </div>";
		};
		
		return "<div id='reminder-calendar-wrappers'> <div id='reminder-calendar'> <div class='header'> <div class='icon'><span class='-ap icon-calendar5'></span></div> <div class='title'><span title='Back to today' onclick='Reminder.calendar.today();'>"+(Client.viewer.name)+"</span></div> <div class='tabs'> <div class='tab active' data-tab=''>Everything</div> <div class='tab' data-tab='meaningful'>Only important</div> </div> <div class='side'> <div class='item nav' onclick='Reminder.calendar.prev();'><span class='-ap icon-keyboard_arrow_left'></span></div> <div class='item nav' onclick='Reminder.calendar.next();'><span class='-ap icon-keyboard_arrow_right'></span></div> <div class='item'>Week of <em></em></div> </div> <div class='close js-close' onclick='Reminder.calendar.hide();'><span class='-ap icon-close'></span></div> </div> <div class='body'>"+(days)+"</div> </div> </div>";
	};
	
	
	function initLayout(ts){
		$("#reminder-calendar .header em").html(AP.i18n.date(ts));
		
		
		$("#reminder-calendar .ditems").empty();
		$("#reminder-calendar .dheader").empty();
		$("#reminder-calendar .day").removeClass("today");
		
		
		var ft=AP.time.beginOfWeek(ts);
		var today=AP.time.beginOfDay();
		
		for (var i=0; i<7; i++){
			var d=ft+i*24*3600;
			
			var html="<div class='w'>"+(AP.time.tvDays[i])+"</div> <div class='d'>"+(AP.time.time('%d',d))+"</div>";
			$("#reminder-calendar .day-"+(i)+" .dheader").html(html);
			
			if (today==d){
				$("#reminder-calendar .day-"+(i)+"").addClass("today");
			}
		}
		
	};
	
	
	function showReminder(e){
		var html=getHTML(e);
		var dow=AP.time.time("%w",e.time);
		var apm=AP.time.time("%a",e.time);
		
		$("#reminder-calendar .day-"+dow+" .ditems-"+apm+"").append(html);
	};
	
	
	function getHTML(e){
		return "<div class='item meaningful-"+(Reminder.meaningful(e))+" state-"+(e.state)+" alert-"+(e.alert)+" url js-reminder-"+(e.id)+"' data-url='"+(e.link)+"' title='"+(stringSafe(e.name))+" - "+(AP.i18n.datetime(e.time))+"'> <div class='c'></div> <div class='name'>"+(e.name)+"</div> <div class='time'>"+(AP.time.time('%H:%i',e.time))+"</div> </div>";
	};
	
	function stringSafe(str){
		return str.replace(/'/g,'');
	};
	
	function loadReminders(ts){
		Reminder.api("week", {ts: ts}, function(reminders){
			reminders=AP.array.usort(reminders, function(e, f){
				return parseInt(e.time)-parseInt(f.time);
			});
			
			for (var i=0; i<reminders.length; i++){
				showReminder(reminders[i]);	
			}
			
			$.log("Finish rendering ... "+reminders.length);
		});
	};
	
};


Reminder.action=new function __ReminderAction(){
	
	/**
	 * @desc Remove a reminder by ID
	 */
	this.remove=function(id){
		AP.confirm("Remove this reminder?", function(){
			Live.post("reminders.remove", {id: id}, function(code){
				Reminder.ui.remove({id: id});
			});
		});
	};
	
	
	/**
	 * @des Alias of remove
	 */
	this.ignore=function(id){
		return this.remove(id);
	};
};


Reminder.alarm=new function __ReminderAlarm(){
	this.check=function(){
		for (var i=0; i<Reminder.ui.rows.length; i++){
			var e=Reminder.ui.rows[i];
			var al=getAlarm(e);
			if (al && al.length){
				if (al =="soon"){
					notify(e, "DUE: ");
				}
				
				if (al=="r60"){
					notify(e, "DUE IN 01 HOUR: ");
				}
			}
		}
	};
	
	
	function notify(e, prefix){
		var icon=Client.share_url+"/apps/base.png";
		if (e.data && e.data.app){
			icon=Client.share_url+"/apps/"+e.data.app+".png";	
		}
		
		var obj={
			url: e.link,
			tag: e.hid+"."+e.time,
			title: prefix+e.name,
			body: AP.i18n.date(e.time),
			time: 10000,
			icon: icon
		};
		
		DN.show(obj);
	};
	
	
	function getAlarm(e){
		var now=AP.time.now();
		var diff=parseInt(e.time)-now;
		
		if (!AP.time.sameDay(e.time, now)){
			return "";
		}
		
		if (diff<0){
			return "";
		}
		
		if (diff<10 && !e.r0){
			e.r0=1;
			return "now";
		}
		
		
		if (diff<30*60 && diff > 30*60-30){
			if (!e.r30){
				e.r30=1;
				return "r30";	
			}
			
			return "";
		}
		
		
		if (diff<60*60 && diff > 60*60-30){
			if (!e.r60){
				e.r60=1;
				return "r60";	
			}
		}
		
		return "";
	};
};
Base.task=new function __BaseTask(){
	this.endpoint=function(ep){
		return Base.domain("wework")+"/ajax/api/v2/"+ep;
	};
	
	this.enabled=function(){
		if (!hasApp("wework")){
			return false;
		}
		
		return true;
	};
	
	this.embed=function(obj, opts){
		if (!hasApp("wework")){
			return;
		}
		
		if (!$(opts.canvas).length){
			return;
		}
		
		$(opts.canvas).data("origin", obj);
		
		var header=getHeader(obj, opts);
		var form=getForm(obj, opts);
		
		
		$(opts.canvas).addClass("js-etask-wrapper etask-wrapper").html(header+form+"<div class='js-subtasks-list etasklist'></div>");
		showTasks(obj, opts);
		
		Form.render($(opts.canvas).find(".etaskform"));
		
		$(opts.canvas).find("input.js-subtask-ip").enter(function(){
			createTaskInline(this);
		}).on("focus", function(){
			$(this).closest(".etaskform").addClass("active");
		}).on("blur", function(){
			$(this).closest(".etaskform").removeClass("active");
		});
		
		$(opts.canvas).find(".esubmit").click(function(){
			createTaskInline($(this).parent().find(".minput"));
		});
		
		
		if (Client.base && Client.base.app=="wework"){
			$(opts.canvas).find(".js-subtasks-list").sortable({
				items: ".etask-detail",
				handle: ".icon-base-sorter",
				axis: "y",
				stop: function(event, ui){
					var id=$(ui.item).data("id");
					var pid=$(ui.item).data("pid");
					var pos=$(ui.item).index();
					
					reorder(id, pos, pid);
				}
			});
		}
	};
	
	
	this._check=function(ref){
		var $box=$(ref).closest(".etask-detail");
		if (!$box.hasClass("is-checkable")){
			return;
		}
		
		var set_status="check";
		if ($box.hasClass("status-1")){
			set_status="uncheck";
		}
		
		var data={id: $(ref).data("id"), "action": set_status};
		
		UI.ajaxShow();
		AP.post(Base.domain("wework")+"/ajax/api/task/check", data, function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			insertTaskAtTop(code.task, $(ref).closest(".js-etask-wrapper"));
			
			AP.sys.fire("subtask.updated", code.task);
		});
	};
	
	
	this._showID=function(id, token, view_token){
		if (Client.base && Client.base.app=="wework"){
			TaskDisplay.display(id);
			return;
		}
		
		window.open(Base.domain("wework")+"/tasks?task="+id+"&task_token="+token+"&view_token="+view_token);
	};
	
	
	this.exportHTML=function(task){
		return getHTML(task);
	};
	
	
	function hasApp(key){
		for (var i=0; i<Client.applist.length; i++){
			if (Client.applist[i].key==key){
				return true;
			}
		}
		
		return false;
	};
	
	
	function getHeader(obj, opts){
		if (!opts.header){
			return "";
		}
		
		return "<div class='etask-header'>"+opts.header+"</div>";
	};
	
	
	function getForm(obj, opts){
		if (!obj.signed_token){
			obj.signed_token="";
		}
		
		if (!obj.abs_link){
			obj.abs_link="";
		}
		
		if (!opts.project_id){
			opts.project_id=0;
		}
		
		var html="<div class='etaskform'> <div class='r'> <div class='einput js-container'> <div class='hidden'> <input type='hidden' name='project_id' value='"+(opts.project_id)+"'/> <input type='hidden' name='origin_hid' value='"+(obj.hid)+"'/> <input type='hidden' name='origin_token' value='"+(obj.token)+"'/> <input type='hidden' name='origin_signed_token' value='"+(obj.signed_token)+"'/> <input type='hidden' name='origin_abs_link' value='"+(obj.abs_link)+"'/> <input type='hidden' name='origin_name' value='"+(obj.name)+"'/> </div> <div class='minput'> <input class='js-subtask-ip' data-role='tag' data-context='global' type='text' name='name' autocomplete='off' placeholder='Create sub task, type @ to tag & assign, press enter to save'/> </div> <div class='extra-data' style='height:36px'> <div class='elem'><span class='icon ficon-calendar-o'></span><input type='text' data-role='date' name='deadline' placeholder='Deadline date (optional)'/></div> <div class='elem'><span class='icon ficon-clock-o'></span><input type='text' name='deadline-time' date-time='none' placeholder='Time (hh:mm, optional)'/></div> <div class='elem last'><span class='icon ficon-user-circle'></span><input type='text' name='assign' data-role='tag' data-context='global' placeholder='Tag @ to assign'/></div> </div> </div> <div class='esubmit'><img src='"+(Client.share_url)+"/send.svg'/></div> </div>";
		
		return html;
	};
	
	
	function showTasks(obj, opts){
		if (Client.tempData && Client.tempData.subtasks){
			for (var i=Client.tempData.subtasks.length-1; i>=0; i--){
				insertTaskAtTop(Client.tempData.subtasks[i], opts.canvas);
			}
			return;
		}
		
		
		AP.post(Base.task.endpoint("load"),{origin_id: obj.id, origin_type: obj.type, origin_hid: obj.hid, origin_token: obj.token, origin_signed_token: obj.signed_token}, function(code){
			if (!code.good()){
				console.log(code);
				return;
			}
			
			for (var i=code.tasks.length-1; i>=0; i--){
				insertTaskAtTop(code.tasks[i], opts.canvas);
			}
		});
		
		return "";
	};
	
	
	function createTaskInline(ref){
		var $c=$(ref).closest(".js-container");
		var data=assoc($c.find(":input").serializeArray());
		if (!data.name){
			return;
		}
		
		UI.ajaxShow();
		AP.post(Base.task.endpoint("create"), data, function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			insertTaskAtTop(code.task, $(ref).closest(".js-etask-wrapper"));
			$c.find(".js-subtask-ip").val("").focus();
			
			AP.sys.fire("subtask.created", code.task);
		});
	};
	
	
	function insertTaskAtTop(task, canvas){
		var origin=$(canvas).closest(".js-etask-wrapper").data("origin");
		
		var html=getHTML(task, origin);
		if ($(canvas).find(".js-subtasks-list .etask-"+task.id).length){
			$(canvas).find(".js-subtasks-list .etask-"+task.id).replaceWith(html);
		}else{
			$(canvas).find(".js-subtasks-list").prepend(html);	
		}
	};
	
	
	
	
	function getHTML(task, origin){
		if (!origin){
			origin={};
		}
		
		var assign="<div class='no-assign'>Not assigned</div>";
		var u=People.get(task.user_id);
		if (u && parseInt(u.id)){
			assign="<div class='etask-user'><img src='"+(AP.xthumb(u.gavatar))+"'/> <span>"+(u.first_name)+"</span></div>";
		}
		
		var status_checkable="is-checkable";
		if (!parseInt(task.acl.status)){
			status_checkable="is-uncheckable";
		}
		
		var deadline=getDeadline(task);
		
		var html="<div class='etask-detail etask-"+(task.id)+" js-inline-subtask-"+(task.id)+" "+(status_checkable)+" status-"+(task.status)+"' data-status='"+(task.status)+"' data-id='"+(task.id)+"' data-pid='"+(task.parent_id)+"'> <div class='icon-base-sorter' style='left:-16px; top:14px;'></div> <div class='echeckbox' data-id='"+(task.id)+"' onclick='Base.task._check(this);'></div> <div class='etask-name' onclick='Base.task._showID("+(task.id)+",\""+(task.token)+"\",\""+(origin.viewed_token)+"\")'>"+(task.name)+"</div> <div class='etask-deadline'>"+(deadline)+"</div> "+(assign)+" </div>";
		
		return html;
	};
	
	
	
	function getDeadline(task){
		if (!task.deadline || !parseInt(task.deadline)){
			return "";
		}
		
		if (task.deadline_has_time){
			return "<span title='Deadline'>"+AP.i18n.datetime(task.deadline)+"</span>";
		}else{
			return "<span title='Deadline'>"+AP.i18n.date(task.deadline)+"</span>";
		}
	};
	
	
	
	function reorder(id, pos, pid){
		if (!pid || !parseInt(pid)){
			return;
		}
		
		UI.ajaxShow();
		AP.post("api/task/subtask.reorder", {id: id, position: pos, parent_id: pid}, function(code){
			UI.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			UI.flash("Update successfully");
		});
	};
	
};







Base.drive=new function __Drive(){
	this.__inited=false;
	this.token="";
	this.callback=null;
	
	
	this.init=function(){
		if (this.__inited){
			return;
		}
		
		this.__inited=true;
		AP.postmessage.listen(function(data, origin){
			if (data.token!=Base.drive.token){
				return;
			}
			
			if (origin!=Base.domain("drive")){
				return;
			}
			
			$("#js-drive-picker").remove();
			AP.hideCustomDialog();
			
			if (Base.drive.callback){
				if (data.files && data.files.length){
					Base.drive.callback(AP.select(data.files, function(e, index){
						e._html=Base.drive.renderInputs(e, "file_"+index);
						return e;
					}));	
				}
			}
				
		});
	};
	
	this.pick=function(options){
		options=$.extend({multi: 0, ext: 0}, options);
		
		this.init();
		if (options.callback){
			this.callback=options.callback;	
		}
		
		this.token=AP.uuid();
		var picker_iframe=Base.domain("drive")+"/picker?multi="+options.multi+"&ext="+options.ext+"&base_token="+this.token+"&base_domain="+encodeURIComponent(Client.url);
		if (mobile()){
			var w=$(window).width();
			var h=$(window).height();
			var html="<div id='js-drive-picker' style='width:"+w+"px; height: "+h+"px; background-color:#fff; overflow:hidden;'><iframe style='width: 100%; height:100%' src='"+picker_iframe+"'/></div>";
		}else{
			var html="<div id='js-drive-picker' style='width:800px; height: 480px; background-color:#fff; overflow:hidden; border-radius:3px; -webkit-border-radius:3px;'><iframe style='width: 100%; height:100%' src='"+picker_iframe+"'/></div>";	
		}
		
		AP.customCanvas(html, true).data("full", (mobile()?1:0)).show().on({
			"close": function(){
				$("#js-drive-picker").remove();
			}
		});
		
		$("#__apdialog_custom-dialog .full-mask").off();
	};
	
	
	
	this.append=function(data, files, name){
		if (!name){
			name="file";
		}
		
		data.__drive_upload=1;
		
		for (var i=0; i<files.length; i++){
			data[name+""+i+"_name"]=files[i].name;
			data[name+""+i+"_refid"]=files[i].refid;
			data[name+""+i+"_metatype"]=files[i].metatype;
			data[name+""+i+"_size"]=files[i].size;
			data[name+""+i+"_fid"]=files[i].fid;
			data[name+""+i+"_is_image"]=files[i]["is_image"];
			data[name+""+i+"_download"]=files[i]["download"];
			data[name+""+i+"_preview"]=files[i]["preview"];
		}
		
		return data;
	};
	
	
	
	this.renderInputs=function(file, name){
		return "<div class='hidden js-basepicker js-base-picker-"+name+"' data-name='"+name+"'>" +
			"<input type='hidden' name='"+name+"_name' data-name='name' value='"+file.name+"'/>" +
			"<input type='hidden' name='"+name+"_refid' data-name='refid' value='"+file.refid+"'/>" +
			"<input type='hidden' name='"+name+"_metatype' data-name='metatype' value='"+file.metatype+"'/>" +
			"<input type='hidden' name='"+name+"_weblink' data-name='weblink' value='"+file.weblink+"'/>" +
			"<input type='hidden' name='"+name+"_size' data-name='size' value='"+file.size+"'/>" +
			"<input type='hidden' name='"+name+"_fid' data-name='fid' value='"+file.fid+"'/>" +
			"<input type='hidden' name='"+name+"_is_image' data-name='is_image' value='"+file.is_image+"'/>" +
			"<input type='hidden' name='"+name+"_preview' data-name='preview' value='"+file.preview+"'/>" +
			"<input type='hidden' name='"+name+"_download' data-name='download' value='"+file.download+"'/>" +
		"</div>";
	};
};Base.board=new function __BaseBoard(){
	
};var analytics = window.analytics = window.analytics || [];
if (!analytics.initialize) if (analytics.invoked) window.console && console.error && console.error("Segment snippet included twice.");
else {
	analytics.invoked = !0; analytics.methods = ["trackSubmit", "trackClick", "trackLink", "trackForm", "pageview", "identify", "reset", "group", "track", "ready", "alias", "debug", "page", "once", "off", "on"]; analytics.factory = function (t) { return function () { var e = Array.prototype.slice.call(arguments); e.unshift(t); analytics.push(e); return analytics } }; for (var t = 0; t < analytics.methods.length; t++) { var e = analytics.methods[t]; analytics[e] = analytics.factory(e) } analytics.load = function (t, e) { var n = document.createElement("script"); n.type = "text/javascript"; n.async = !0; n.src = "https://cdn.segment.com/analytics.js/v1/" + t + "/analytics.min.js"; var a = document.getElementsByTagName("script")[0]; a.parentNode.insertBefore(n, a); analytics._loadOptions = e }; analytics.SNIPPET_VERSION = "4.1.0";
	analytics.load("MGF8H9rbs8aPiKP5nXXbmu0RkWRjLo1M");//SegmentId
	analytics.page();
};


if ((Client.env == 1) && Client.viewer && Client.viewer.id && Client.base && Client.base.app){
	analytics.identify(Client.viewer.email,{
		name: Client.viewer.name, 
		email: Client.viewer.email, 
		account_id: "sys__"+Client.viewer.system_id,
		product_id: Client.base.app,
		user_base_uid: Client.viewer.id
	});
};


function url_track($ref){
	var feature=$ref.data("feature");
	if (!feature || !AP.data.isString(feature) || !feature.length){
		return;
	}
	
	var parts=feature.split(":");
	if (parts.length==3){
		return raw_track(parts[0], parts[1], parts[2]);
	}else if (parts.length==2){
		return raw_track(parts[0], parts[1]);
	}
	
};


function raw_track(module_id, feature_id, ref){
	if (!ref){
		ref="none";
	}
	
	if ((Client.env == 1) && Client.viewer && Client.viewer.id && Client.base && Client.base.app){
		analytics.track(feature_id, {
			account_id: Client.viewer.system_id,
			user_id: Client.viewer.email,
			user_base_uid: Client.viewer.id,
			product_id: Client.base.app,
			module_id: module_id,
			
			feature_id: feature_id,
			location: ref,
			type: ref,
		});
	}
};


function page_identify(){
	analytics.page({
		account_id: Client.viewer.system_id,
		user_id: Client.viewer.email,
		user_base_uid: Client.viewer.id
	});
};var M=new function __M(){
	this.init=function(){
		this.canvas.init();
	};
	
};
 
  

$(document).ready(function(){
	M.drawer.initSwipe();
	setTimeout(function() {window.scrollTo(0, 1)}, 100)
});

AP.sys.on("page.pre.transition", function(data){
	M.drawer.hide();
	M.sidebar.hide();
});


AP.sys.on("page.post.transition", function(data){
	M.drawer.initSwipe();
	$("#body").css("min-height", $(document).height()-$("#header").height()-$("#footer").height());
	M.canvas.fix();
});




M.canvas = new function __MCanvas(){
	this.init=function(){
		if (M.vendor.ms()){
			$(document.body).addClass("-vd-ms");
			$("html").addClass("-vd-ms");
		}
		
		if (M.vendor.bb()){
			$(document.body).addClass("-vd-bb");
		}
		
		this.fix();
	};
	
	this.fix=function(){
		var pt=gh("#header")+gh("#search");
		$("#body").css("padding-top", pt);
		
		setTimeout(function(){
			$("#body").css("min-height", $(document).height()-pt-$("#footer").height()).css("padding-bottom",$("#footer").height());
		}, 500);
	};
	
	
	function gh(selector){
		if (!$(selector).length){
			return 0;
		}
		
		return $(selector).height();
	};
};


M.drawer = new function __Drawer(){
	this.__flag=false;
	
	this.show=function(){
		if (M.drawer.__flag){
			return;
		}
		
		M.drawer.__flag=true;
		
		$("#drawer .mask").hide();
		$("#drawer").show();
		$(document.body).addClass("xo");
		$("#drawer .mask").fadeIn(100);
		$("#drawer .drawer").velocity({left: 0}, {duration: 250, easing: 'easeOutSine', complete: function(){
			M.drawer.__flag=false;
		}}); 
	};
	
	this.hide=function(){
		if (M.drawer.__flag){
			return;
		}
		
		M.drawer.__flag=true;
		$(document.body).removeClass("xo");
		
		$("#drawer .mask").fadeOut(150);
		$("#drawer .drawer").velocity({left: "-100%"}, {duration: 250, easing: 'easeInSine', complete: function(){
			M.drawer.__flag=false;
			$("#drawer").hide();
		}}); 
	};
	
	this.toggle=function(){
		
	};

	this.visible=function(){
		return $("#drawer").is(":visible");
	};
	
	
	this.initSwipe=function(){
		return;
		
		this.__flag=false;
		var mx=$("#body")[0];
		var mc = new Hammer(mx);
		mc.on("swiperight", function(e){
			if (!e.changedPointers.length){
				return;
			}
			var endPoint = e.changedPointers[0].pageX;
		    var distance = e.distance;
		    var origin = endPoint - distance;
		    
		    if (origin>0 && origin<50 && !M.drawer.visible()){
		    	M.drawer.show();
                return false;
		    }
		});
		
	};
	
	function isShow(){
		
	};
};









M.sidebar = new function __MSidebar(){
	this.__flag=false;
	
	this.show=function(){
		if (M.sidebar.__flag){
			return;
		}
		
		M.sidebar.__flag=true;
		
		$("#sidebar .mask").hide();
		$("#sidebar").show();
		$(document.body).addClass("xo");
		$("#sidebar .mask").fadeIn(100);
		
		$("#sidebar .sidebar").velocity({right: 0}, {duration: 250, easing: 'easeOutSine', complete: function(){
			M.sidebar.__flag=false;
		}}); 
	};
	
	this.hide=function(){
		if (M.sidebar.__flag){
			return;
		}
		
		M.sidebar.__flag=true;
		$(document.body).removeClass("xo");
		
		$("#sidebar .mask").fadeOut(150);
		$("#sidebar .sidebar").velocity({right: "-100%"}, {duration: 250, easing: 'easeInSine', complete: function(){
			M.sidebar.__flag=false;
			$("#sidebar").hide();
		}}); 
	};
	
	this.toggle=function(){
		
	};

	this.visible=function(){
		return $("#sidebar").is(":visible");
	};
	
};


M.header=new function __MHeader(){
	this.bindSearch=function(){
		$("#header .js-search").click(function(){
			$("#header").addClass("searching");
			$("#header .hsearch input").focus();
		});
		
		$("#header .hsearch input").val(Query.get("q"));
		if (Query.get("q")){
			$("#header").addClass("searching");
			$("#header .hsearch input").autofocus();
		}
		
		$("#header .hsearch input").enter(function(){
			applySearch();
		});
		
		$("#header .hsearch .submit").click(function(){
			applySearch();
		});
		
		$("#header .hsearch .cancel").click(function(){
			AP.setURLParams({q: null}, true)	
		});
	};
	
	
	function applySearch(){
		var val=purify($("#header .hsearch input").val());
		if (!val || !val.length){
			val=null;
		}
		
		AP.setURLParams({q: val}, true);
		
		if (val==null || !val){
			$("#header").removeClass("searching");
		}
	};
};











M.vendor=new function __MVendor(){
	this.ms=function(){
		if(navigator.userAgent.match(/Windows Phone/i)){
		    return true;
		}

		return false;
	};
	
	this.bb=function(){
		return false;
	};
};


M.render=new function __MRender(){
	this.avatar=function(obj){
	};
	
	this.date=function(ts){
		
	};
	
	this.datetime=function(ts){
		return "<div class='dt-box'>" +
			"<div class='dt-t'>"+AP.time.time("%H:%i", ts)+"</div>" +
			"<div class='dt-w'>"+AP.time.time("%V", ts)+"</div>" +
			"<div class='dt-d'>"+AP.time.time("%d/%m", ts)+"</div>" +
		"</div>";
	};
	
	this.avatar=function(url, size){
		if (!size){
			size=48;
		}
		
		return "<div class='user avatar avatar-"+size+" -circled'><div class='image'><img src='"+AP.thumb(url)+"'/></div></div>";
	}
	
	this.users=function(users, size){
		if (!size){
			size=24;
		}
		
		return AP.render(users, function(e){
			var username=e;
			if (e.username){
				username=e.username;
			}
			
			var u=People.get(username);
			return "<div class='user avatar avatar-"+size+" -circled'><div class='image'><img src='"+AP.xthumb(u.gavatar)+"'/></div></div>";
		});
	};
};



M.screen=new function __MobileScreen(){
	this.pop=function(id, html){
		if ($("#"+id).length){
			$("#"+id).empty().html(html);
		}else{
			$("<div id='"+id+"' class='__temp mobile-full-screen'>"+html+"</div>").appendTo(document.body);
		}
		
		$(document.body).addClass("xo");
		
		if ($("#"+id+" .screen-tabs").length){
			$("#"+id+" .screen-tabs .tab").click(function(){
				var tab=$(this).data("tab");
				$(this).addClass("active");
				$(this).siblings().removeClass("active");
				
				$("#"+id+" .screen-page").each(function(){
					var ctab=$(this).data("tab");
					if (ctab==tab){
						$(this).addClass("active");
					}else{
						$(this).removeClass("active");
					}
				})
			});
			
			$("#"+id+" .screen-tabs .tab").each(function(){
				if ($(this).data("default")){
					$(this).click();
				}
			})
		}
	};
	
	this.close=function(id){
		$("#"+id).remove();
		$(document.body).removeClass("xo");
	};
};


/*!
 * jQuery UI Touch Punch 0.2.3
 *
 * Copyright 2011–2014, Dave Furfero
 * Dual licensed under the MIT or GPL Version 2 licenses.
 *
 * Depends:
 *  jquery.ui.widget.js
 *  jquery.ui.mouse.js
 */
!function(a){function f(a,b){if(!(a.originalEvent.touches.length>1)){/**a.preventDefault();*/var c=a.originalEvent.changedTouches[0],d=document.createEvent("MouseEvents");d.initMouseEvent(b,!0,!0,window,1,c.screenX,c.screenY,c.clientX,c.clientY,!1,!1,!1,!1,0,null),a.target.dispatchEvent(d)}}if(a.support.touch="ontouchend"in document,a.support.touch){var e,b=a.ui.mouse.prototype,c=b._mouseInit,d=b._mouseDestroy;b._touchStart=function(a){var b=this;!e&&b._mouseCapture(a.originalEvent.changedTouches[0])&&(e=!0,b._touchMoved=!1,f(a,"mouseover"),f(a,"mousemove"),f(a,"mousedown"))},b._touchMove=function(a){e&&(this._touchMoved=!0,f(a,"mousemove"))},b._touchEnd=function(a){e&&(f(a,"mouseup"),f(a,"mouseout"),this._touchMoved||f(a,"click"),e=!1)},b._mouseInit=function(){var b=this;b.element.bind({touchstart:a.proxy(b,"_touchStart"),touchmove:a.proxy(b,"_touchMove"),touchend:a.proxy(b,"_touchEnd")}),c.call(b)},b._mouseDestroy=function(){var b=this;b.element.unbind({touchstart:a.proxy(b,"_touchStart"),touchmove:a.proxy(b,"_touchMove"),touchend:a.proxy(b,"_touchEnd")}),d.call(b)}}}(jQuery);
AP.rewrite('task/([0-9]+)', 'taskview?id=$1', function(qs){
	return Task.display(qs.id);
});

AP.rewrite('^milestone/([0-9]+)', 'milestoneview?id=$1', function(qs){
	return Milestone.display(qs.id);
});


AP.rewrite('showtopic/([0-9]+)', 'topicview?id=$1', function(qs){
	return Topic.display.show(qs.id);
});


AP.rewrite('project/create', 'project/create', function(qs){
	return Project.create();
});


AP.rewrite('team/create', 'team/create', function(qs){
	return Team.form.create();
});

AP.rewrite('project/tasklist/create', 'project/action/tasklist', function(qs){
	return TaskList.create();
});

AP.rewrite('project/task/create', 'project/action/task', function(qs){
	return Project.tform.dialog();
});

AP.rewrite('projects/tasklist/([a-zA-Z0-9]+)', 'project/tasklist?id=$1', function(qs){
	if (!qs.id){
		return;
	}
	
	return Project.tasklist.display(qs.id);
});






AP.rewrite('myteam/user/([a-zA-Z0-9]+)', 'user?username=$1', function(qs) {
	var url = 'user/' + qs.username;
	var list_params = ["stime", "etime", "project", "group"];
	var f_flag = false;
	var constr = '&';
	for (x in list_params) {
		if (Query.get(list_params[x])) {
			if (!f_flag) {
				f_flag = true;
				constr = '?';
			} else {
				constr = '&';
			}
			url += constr + list_params[x] + '=' + encodeURIComponent(Query.get(list_params[x]));
		}
	}

	return AP.toURL(url);
});AP.sys.on("page.pre.transition", function(data){
	$("#ptransit").show();
	loadBar("#ptransit", true);
});

AP.sys.on("page.post.transition", function(data){
	setTimeout(function(){
		loadBar("#ptransit", false);
	},500);
	
	Context.hide();
	Context.gen.hide();
});


AP.sys.on("form.pre.submit", function(selector){
	if (Client.pageData.event && Client.pageData.event.id){
		$(selector).append("<input type='hidden' name='__event' value='"+Client.pageData.event.id+"'/>");
	}
});


AP.adaptive=function(u1, u2){
	return true;
};



/**
 * @desc Reinit document
 */
function documentInit(){
	AP.initPageData();
	Client.title=document.title;
	
	if (!Client.viewer || !Client.viewer.id){
	}else{
		Layout.start();
	}
};


function nsUpdate(){
};



/**
 * @desc Update HTML data to a specific div (selector)
 * @param selector
 * @param data
 */
function ap_update(selector, data){
	$(selector).html(data);
	AP.setContinuousRequest(selector);
	AP.html.init(selector);
};



/**
 * @desc Main RESET and UPDATE
 * @param callback
 */
function reset_page(callback){
	$("#page").children().remove();
	$("#page").empty().html("&nbsp;");
	$(".note-popover").remove();
	$(".date-picker-wrapper").remove();
	
	// SPECIAL FIX
	$("#document").removeClass("dark wbg");
	$("#background").remove();
	TaskDisplay.last_scroll=-1;
	
	// Clear lock
	
	AP.__lock=false;
	Board.data.model=null;
	Board.data.period_by=null;
	
	AP.resetPageData();
	// AP.sys.fire("page.pre.transition");
	
	if (callback){
		callback();
	}
};

function update_page(data){
	$('#master').removeClass();
	$("#document").removeClass("wbg");
	$("#background").remove();
	
	ap_update("#page", data);
	
	window.scrollTo(0,0);
	$("#ap-data").empty();
	
	documentInit();
	
	AP.sys.fire("page.post.transition");
	AP.sys.fire(AP.EVENTS.PAGE_UNLOAD);
	
	
	if (AP.isset('FB')){
		try{
	        FB.XFBML.parse(); 
	    }catch(ex){};	
	}
};










function loadBar(canvas, status){
	if (!status){
		$(canvas).hide();
		$(canvas).data("lock", false);
		stopBar(canvas, 4)
	}else{
		$(canvas).data("lock", true);
		loadBarAnimation(canvas);
	}
};

function stopBar(canvas, len){
	for (var i=0; i<len; i++){
		$(canvas).find('.bar:eq('+i+') .anim').css({width: 0});			
	}
	
	for (var i=0; i<len; i++){
		$(canvas).find('.bar-'+i).appendTo(canvas);
	}
	
	$(canvas).data("ab",0);
}

function loadBarAnimation(canvas){
	var c=['#F03C32','#09A5E3','FFD726','#08D119'];
	var len=c.length;
	
	if (!$(canvas).data('__bars')){
		for (var i=0; i<len; i++){
			$(canvas).append("<div class='bar bar-"+i+"'><div  style='background-color:"+c[i]+"' class='anim'></div></div>");
		}
	}

	$(canvas).data('__bars',1);
	
	$(canvas).find('.bar:eq(0) .anim').show().css("width","100%");
	$(canvas).data('lock', true);
	$(canvas).show();
	
	animateBar(canvas, len);
};

function animateBar(canvas, len){
	var lock=$(canvas).data("lock");
	if (!lock){
		return;
	}
	
	var index=$(canvas).data("ab");
	if (!index){
		index=0;
	}
	index++;
	
	if (index>=len){
		index=0;
		
		for (var i=0; i<len-1; i++){
			$(canvas).find('.bar:eq('+i+') .anim').css({width: 0});			
		}
		$(canvas).find('.bar:last').prependTo(canvas);
		index++;
	}
	

	$(canvas).data("ab",index)
	$(canvas).find('.bar:eq('+index+') .anim').animate({'width':'100%'},800, function(){
		if (!$(canvas).data("lock")){
			stopBar(canvas, 4);
			return;
		}else{
			animateBar(canvas, len);
		}
	});
};// Require Configuration [Required]
AP.config.dialog={};
AP.config.dialog.engine=WTDialogEngine;
AP.config.alertDialogEngine=WTDialogEngine;
AP.config.uploadDialogEngine=UploadDialogEngine;
AP.config.ajaxAlertDialogEngine=WTAjaxDialogEngine;
AP.config.theme=0;
AP.config.editor = "quill";


// Translate error messages [Required]
AP.error.messages=AP.data.assoc()
	.add(AP.error.code.CONFLICT_DATA, "Bad input. Please try again")
	.add(AP.error.code.INVALID_DATA, "Invalid data. Please try again.")
	.add(AP.error.code.INCOMPLETE_DATA, "Your submitted data is incomplete. Please try to complete all required fields.")
	.add(AP.error.code.INVALID_USER, "Authentication error. You may not be able to perform this action.")
	.add(AP.error.code.INVALID_AUTHENTICATION, "Invalid authentication. Please try again.")
	.add(AP.error.code.LOGIN_REQUIRED, "Please login to perform this action.")
	.add(AP.error.code.DB_ERROR, "Unexpected error (1). Please contact us for further information.")
	.add(AP.error.code.SV_ERROR, "Unexpected error (2). Please contact us for further information.")
	.add(AP.error.code.INVALID_PASSWORD, "Invalid password. Please try again.")
	.add(AP.error.code.INVALID_EMAIL, "Invalid or empty email. Please try again.")
	.add(AP.error.code.INVALID_USERNAME, "Invalid username. Please try again.")
	.add(AP.error.code.INVALID_CHARACTER, "Some characters you enter are not allowed. Please try again.")
	.add(AP.error.code.INVALID_CAPTCHA, "Invalid captcha security code. Please try again.")
	.add("BAD_XCODE","Your session was expired. Please refresh the page (press F5) to continue.")
	.add("FORCE_REDIRECT","Your session was expired. Please refresh the page (press F5) to continue.")
	.add("DUPLICATED EMAIL","Email bị trùng lặp vì đã đăng ký trong hệ thống trước đó.")
	.assoc();



AP.pageConfig.init({
	hide_all_subtasks: 0,
	project_subtasks: 'one_level' // ONE LEVEL NESTED, could be {fully_nested, main_task_only}
});


Color.register("review", "#5d3bf5");
Color.register("late", "#f7e015");
Color.register("overdue", "#f54e3b");
Color.register("doing", "#389dd9");
Color.register("todo", "#82c3f5");
Color.register("review", "#751de0");


Color.register("ontrack", "#1fb53a");
Color.register("offtrack", "#edcb21");
Color.register("atrisk", "#c92e2e");

Color.register("canceled", "#a1a1a1");
Color.register("failed", "#4f2d2d");
Color.register("success", "#3b7847");





/**
 * @desc Startup document
 */

$(document).ready(function(){
	AP.add('ap-root','ap-temp', 'ap-apps','overlay','alert','ap-data');
	$("<div id='ap-invs'></div>").appendTo(document.body);
	AP.initContinuousRequest();
	AP.setContinuousRequest();
	AP.html.init();
	documentInit();
	
	if (Client.people){
		for (var i=0; i<Client.people.length; i++){
			Client.people[i].value="@"+Client.people[i].username;
			Client.people[i].sub=Client.people[i].first_name+" "+Client.people[i].last_name;
		}
	}
	
});


function mapready(){
	AP.sys.release('mapready');
};Base.config={
	file_preview:1
};var Layout= new function __Layout(){
	this.init=function(){
		Layout.scrollable('.scrollable');
		
		$(window).blur(function(){
			AP.fire("PAGE.UNFOCUS");
		});
		
		$(window).focus(function(){
			AP.fire("PAGE.FOCUS");
		});
		
		$("#pagescroll > .scrollin").on("scroll", function(){
			var h=$(this)[0].scrollHeight-$(this).scrollTop()-$(this).outerHeight();
			if (h<=50){
				AP.fire("PAGE.OVERSCROLL");
			}
			
			AP.fire("PAGE.SCROLL", [$(this).scrollTop(), $(this)[0].scrollHeight]);
		});
		
		AP.html.resize(function(){
			Layout.checkWidth();
		}, true);
		
		
		AP.sys.fire("system.init");
		
		
		$("#header .nav").on("click", function(){
			$(document.body).toggleClass("screen-full");
			
			if ($(document.body).hasClass("screen-full")){
				Base.pref().set("collapse", 1);
			}else{
				Base.pref().set("collapse", 0);
			}
		});
		
		var opt=Base.pref().get("collapse");
		if (opt){
			$(document.body).addClass("screen-full");
		}
	};
	
	
	this.checkWidth=function(){
		$("#document").removeClass("screen-hd screen-sd screen-md screen-ld");
		
		if ($(window).width()<1100){
			$("#document").addClass("screen-ld");
		}else if ($(window).width()<1280){
			$("#document").addClass("screen-md");
		}else if ($(window).width()<1500){
			$("#document").addClass("screen-sd");
		}else{
			$("#document").addClass("screen-hd");
		}
		
	};
	
	
	this.start=function(){
		if (mobile()){
			$("#document").height($(window).height());
			$(document.body).removeClass();
		}
		
		Layout.scrollable('.scrollable');
		$("#page").removeClass();
		
		this.checkWidth();
		$("#document").removeClass('extented');
		$("#floatview").empty().hide();
		
		
		// this.startCountdown("#document");
//		AP.html.resize(function(){
//			if ($("#page .display.-double").length){
//				$("#page .display.-double").css("min-height", $(window).height()-48);
//				var w=$("#page").width();
//				if (w>1370){
//					$("#page .display.-double").addClass("-equal");
//				}else{
//					$("#page .display.-double").removeClass("-equal");
//				}	
//			}
//		});
		
		AP.sys.fire("system.start");
		if (mobile()){
			$("#project-sidebar-canvas").remove();
			TaskDisplay.close();
		}else{
			TaskDisplay.close();
			Topic.display.close();
		}
		
	};
	
	
	
	this.setColor=function(color){
		$("#document").removeClass().addClass("document-"+color);
	};
	
	
	this.scrollable=function(box){
		if (Client.native){
			return;
		}
		
		$(box).each(function(){
			if ($(this).hasClass('__set')){
				return;
			}
			
			if (mobile()){
				$(this).addClass("scroll-y");
				return;
			}
			
			
			$(this).addClass('__set');
			$(this).wrapInner("<div class='scrollin absolute'></div>");
			$(this).find(".scrollin").css({"right":-$.sbWidth(), top:0, left:0, bottom:0});
			AP.scrollBar($(this).find('.scrollin')).init();
		});
	};
	
	
	this.updateScroll=function(canvas){
		if (Client.native){
			return;
		}
		
		$(canvas).find(".scrollin").each(function(){
			$(this).css({"right":-$.sbWidth(), top:0, left:0, bottom:0});
			$(this).scroll();
		});
	};
	
	
	this.scrollDown=function(box){
		var h=$(".__apscrollbar_wrap", box).height();
		$(".scrollin", box).animate({scrollTop: h}, 1000);
	};
	
	this.scrollTo=function(box, offset, anim_time){
		if (!offset){
			offset=0;
		}
		if (typeof anim_time=="undefined"){
			anim_time=500;
		}
		
		var $box=$(box);
		if (!$box.length){
			return;
		}
		
		var $p=$box.closest('.scrollin');
		var h=$box.position().top;
		$p.animate({scrollTop: h-offset}, anim_time);
	};

	
	
	this.scrollTop=function(box){
		if (!box){
			$("#pagescroll > .scrollin").animate({scrollTop: 0}, 500);
			return;
		}
		var $p=$(box).closest('.scrollin');
		$p.animate({scrollTop: 0}, 500);
	};
	
	
	this.hideSide=function(){
		$('#appdialog').hide();
	};
	
	
	this.bcanvas=function(){
		$('#appdialog').hide();
		$("#bcanvas").show();
		$("#bcanvas .full").hide();
		// $("#bside").css("height", $("#bside").parent().height());
		Layout.updateScroll("#bcanvas");
	};
};var BC=new function __BC(){
	this.title=function(title){
		$("#bcanvas .__title").html(title);
	};
	
	this.side=function(side){
		$("#bcanvas .__side").html(side);
	};
	
	
	this.main=function(content){
		$("#bcanvas .__canvas").html(content);
	};
	
	this.show=function(){
		$("#bcanvas").show().removeClass("__simple").addClass("__ontop");
		this.normal();
		
		if (!$("#bcanvas").hasClass('__init')){
			$("#bcanvas").addClass('__init');
			Layout.scrollable("#bside");
		}else{
			$("#bside").find(".scrollin").height("100%").css("width", $("#bside").width()+$.sbWidth());
		}
	};
	
	
	this.noSide=function(){
		$("#bcanvas").show().addClass("__simple");
	};
	
	this.hide=function(){
		$("#bcanvas").find(".__canvas").html("");
		$("#bcanvas").find(".__side").html("");
		$("#bcanvas").find(".__postbottom").html("");
		$("#bcanvas").fadeOut(200);
	};
	
	
	
	this.extend=function(){
		$("#bcanvas").addClass("extended");
	};
	
	this.unextend=function(){
		$("#bcanvas").removeClass("extended");
	};
	
	this.normal=function(){
		$("#bcanvas").removeClass("extended");
	};
};




BC.ui=new function __BCUIx(){
	this.followers=function(obj){
		if (obj.followers.length<=6){
			return "<div class='list users'> <div class='li-title'>Followers</div> <div class='items'>"+AP.render(obj.followers, followerHTML)+"</div></div>";
		}else{
			return "<div class='list users'> <div class='li-title'>Followers</div> <div class='items'>"+AP.render(obj.followers, followerHTML)+"</div></div>";
		}
	};
	
	
	
	
	function followerHTML(user){
		return "<div class='li url' data-username='"+user.username+"'><div class='avatar avatar-40 rounded xo'>" +
				"<div class='image'><img src='"+AP.xthumb(user.gavatar)+"'></div>" +
			"</div></div>";
	}
};var Menu=new function __Menu(){
	this.init=function(){
		// var pref=Me.pref();
			
		this.build();
		
		$("#navigator .js-menu").each(function(){
			var type = $(this).data("name");
			
			var collapse = AP.log.getValue("collapse-menu-" + type);
			var style = '';
			if (collapse == 'open') {
				collapse = '';
				$(this).find(".boards").css({"display": "block"});
			}

			if (collapse == 'close'){
				collapse = 'collapsed';
				$(this).find(".boards").css({"display": "none"});
			}

			$(this).addClass(collapse);
		});

		AP.sys.on("system.start", function(){
			focus();
		});

		
		$("#navigator .box .title .label").click(function(){
			var $box=$(this).closest(".box");
			var key = purifyStrict($box.data("name"));
			
			var f='';
			if ($box.hasClass("collapsed")){
				$box.removeClass("collapsed");
				$box.find(".boards").slideDown(200);
				var f = 'open';
			}else{
				$box.addClass("collapsed");
				$box.find(".boards").slideUp(200);
				var f = 'close';
			}

			AP.log.setValue("collapse-menu-" + key, f);
		});
		
		
	};


	this.bindSearch=function(){
		var ps=Client.projects.slice(0);
		for (var i=0; i<ps.length; i++){
			ps[i].value=ps[i].keywords;
		}

		$("#js-proj-menusearch").livesearch(ps, {
			render: function(e){
				return "<a>"+e.name+"</a>";
			},
			select: function(e){
				AP.toURL(e.path);
				setTimeout(function(){
					$("#js-proj-menusearch").val("");
				}, 200);
			},
			filter: function(q, e){
			}
		});
	};
	
	
	this.build=function(){
		$("#js-fav-projects").html(AP.render(Client.projects, function(e){
			if (UI.fav.isFav(e.id, Client.favs)){
				return getHTML(e);
			}

			return "";
		}));

		var depts=getDepts(Client.projects, true);
		$("#js-x-projects").html(renderDepts(depts));
		
		focus();
		
		$("#js-x-projects").sortable({
			axis: 'y',
			items: '.box',
			handle: '.title .label',
			stop: function(event, ui){
				saveDeptOrders();
			}
		});
		
		
		$("#js-x-projects .boards").each(function(){
			$(this).sortable({
				axis: 'y',
				items: '.li',
				stop: function(event, ui){
					var prev_id=0;
					var $prev=$(ui.item).prev();
					if ($prev.length){
						prev_id=$prev.data("id");
					}
					
					saveProjectOrder($(ui.item).data("id"), prev_id);
				}
			});
		});
		
		Base.url2a("#navigator");
	};


	
	function getDepts(projects){
		projects=AP.array.uniqueObjects(projects);
		var depts={"none": {"label":"Chưa phân loại", "id": 0, items: []}, "starred": {"label":"Đánh dấu", "id": 1000000, items: []}};
		
		for (var i=0; i<projects.length; i++){
			if (UI.fav.isFav(projects[i].id, Client.favs)){
				depts["starred"].items.push(projects[i]);
				continue;
			}

			var dept_id=projects[i].dept_id;
			var dept=null;
			
			if (parseInt(dept_id)){
				dept=Dept.fromContext(dept_id);	
			}
			
			if (!dept){
				depts["none"].items.push(projects[i]);
			}else{
				if (depts["d-"+dept.id]){
					depts["d-"+dept.id].items.push(projects[i]);
				}else{
					depts["d-"+dept.id]={label: dept.name, id: dept.id, items: [projects[i]], dept: dept};
				}
			}
		}

		var r=[];
		for (var key in depts){
			depts[key].key=key;
			depts[key].__order=1+AP.array.indexOf(Client.dept_orders, depts[key], function(e, f){
				return parseInt(e)==parseInt(f.id);
			});
			
			r.push(depts[key]);
		}

		r.sort(function(e, f){
			if (e.__order && f.__order){
				return e.__order - f.__order;
			}
			
			if (!e.__order && !f.__order){
				return f.id-e.id;
			}
			
			if (!f.__order){
				return -1;
			}
			
			if (!e.__order){
				return 1;
			}
			
		});
		
		return r;
	};
	
	
	
	
	function renderDepts(groups){
		return AP.render(groups, function(e){
			if (e.key=="starred"){
				return "";
			}
			
			var key = purifyStrict(e.key);

			var items=AP.render(e.items, function(e){
				return getHTML(e);
			});
			
			return "<div class='box js-menu' data-name='"+(key)+"' data-id='"+(e.id)+"'> <div class='title'> <div class='label ap-xdot'>"+(e.label)+"</div> <div class='icons'> <div class='icon' onclick='Project.create({category: \""+(e.id)+"\"});' id='js-project-create-button'> <span class='-ap icon-uniF100'></span> </div> </div> </div> <div class='boards'>"+(items)+"</div> </div>";
		});
	};


	

	function getHTML(e){
		if (parseInt(e.status)==-1){
			// if (!Client.pageData.context || Client.pageData.context.id!=e.id){
			return  "";
			// }
		}

		var icon="<span class='image'><img src='"+(Client.image_url)+"/icons/project.png'/></span>";
		icon="<span class='icon-project -bg-alt"+(e.color)+"'><em>"+(purifyStrict(e.path).charAt(0))+"</em></span>";
		
		if (isFav(e.id)){
			// icon="<span class='image'><img src='"+(Client.image_url)+"/icons/star.png'/></span>"; 
		}
		
		if (e.metatype=="team"){
			// icon="<span class='image'><img src='"+(Client.image_url)+"/icons/team.png'/></span>";
			icon="<span class='icon-team -bg-alt"+(e.color)+"'><em>"+(purifyStrict(e.path).charAt(0))+"</em></span>";
		}

		if (parseInt(e.icon)){
			icon="<span class='image'><img src='"+(Client.share_url)+"/fav_icons/"+(e.icon)+".png'/></span>";
		}
		
		return "<div class='li url proj proj-"+(e.id)+"' data-id='"+(e.id)+"' title='"+(e.name)+"' data-url='"+(e.path)+"' data-href='"+(e.path)+"' data-kw='"+(e.keywords)+"'> <span class='sorder' title='Sort project/team'></span> <span class='icon'>"+(icon)+"</span> <span class='name ap-xdot'>"+(e.name)+"</span> </div>";
	};



	function focus(){
		if (Client.pageData.context){
			$("#navigator .li").setActive(".proj-"+Client.pageData.context.id);
			return;
		}

		$("#navigator .proj").removeClass("active");
		$("#navigator .li").setActiveURL({fallback: "tasks"});
	};

	
	
	function isFav(id){
		if (UI.fav.isFav(id, Client.favs)){
			return true;
		}
		
		return false;
	};
	
	
	function saveDeptOrders(){
		var r=[];
		$("#js-x-projects .box").each(function(){
			var id=$(this).data("id");
			if (id && parseInt(id)){
				r.push(id);
			}
		});
		
		UI.ajaxShow();
		AP.post("api/pref/dept.orders", {orders: r.join(",")}, function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			UI.flash("Update successfully");
		});
	};
	
	
	
	/**
	 * @desc Setting position of a project
	 */
	function saveProjectOrder(project_id, prev_id){
		UI.ajaxShow();
		AP.post("api/project/reorder", {project_id: project_id, prev_id:prev_id, sorter: "prev"}, function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			UI.flash("Update successfully");
		});
	};
	
};














var Topic = new function __Base_Topic(){
	this.get=function(topic_id, callback){
		UI.ajaxShow();
		AP.post("api/base/topic/get", {topic_id: topic_id}, function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			callback(code.topic);
		});
	};
	
	
	/**
	 * @desc Get all topics of a particular user
	 */
	this.getPage=function(page_id, callback){
		if (!Channel.channel){
			return;
		}
		
		UI.ajaxShow();
		AP.post(Message.api+"api/message/topic/page", {channel_id: Channel.channel.id, page: page_id}, function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			callback(code.topics);
		});
	};
	
	
	
	this.create=function(origin){
		if (!origin){
			origin=Client.pageData.context;
		}
		
		if (!origin){
			Project.pick(function(project){
				createTopicForm(project);	
			}, "Select a team/project");
		}else{
			createTopicForm(origin);
		}
	};
	
	
	
	this.submit=function(ref){
		AP.ajaxShow();
		Form.submitFrom(ref, function(code){
			AP.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			// AP.toURL(code.topic.link);
			AP.xRefresh();
		});
	};
	

	
	this.url=function(topic){
		return "r/topic/"+topic.channel_id+"/"+topic.id;
	};
	
	
	this.burl=function(box){
		return "r/topicbox/"+box.channel_id+"/"+box.id;
	};
	
	this.extendEditor = function(ref){
        $(ref).hide();
        $('#topic-editor-wrapper').find('.trumbowyg-box').attr('style', 'min-height: 500px');
        $('#topic-editor-wrapper').find('.trumbowyg-editor').attr('style', 'min-height: 500px');
    };
    
    
    
    
    function createTopicForm(origin){
        for (var i=0; i<origin.owners.length; i++){
            if (origin.owners[i].username == Client.viewer.username) {
                var isOwners = true;
            }
        }

        content_html = '';
        if (isOwners) {
            var content_html = "<h6>Gửi nội dung thảo luận qua email</h6>" +
                "<select name='sendemail' id='report-via-email'>" +
                "<option value='1'>Có</option>" +
                "<option value='0' selected>Không</option></select>";
        } 

    	var html="<div class='-close -wrap' onclick='AP.closeDialog(this);'></div> <h2>Thêm thảo luận mới</h2>" +
		"<p>Thảo luận (topic) giúp bạn và đồng nghiệp cùng bàn về một vấn đề chuyên sâu. Bạn có thể trao đổi, bình luận, thêm files trong mỗi thảo luận này. &mdash; <em>"+origin.name+"</em></p>" +
		"<form action='api/base/topic/create' id='topic-create-fly'>" +
		"	<input type='hidden' name='id' value='"+origin.id+"'/>" +
		"	<input type='hidden' name='token' value='"+origin.token+"'/>" +
			"<h6>Tiêu đề thảo luận</h6>" +
			"<input type='text' name='name' placeholder='Topic name' />" +
            "<h6>Người theo dõi</h6>" +
            "<input type='text' name='followers' data-role='tag' placeholder='Gõ @ để bắt đầu tag người theo dõi' id='topic-create-tagging'/>" +
			// "<h6>Chủ đề</h6>" +
			// "<select name='cat_id' id='topic-cat_id'></select>" +
            content_html +
			"<h6>Nội dung thảo luận <!--<span class='right normal a std ap-f13' onclick='Base.topic.extendEditor(this);'>Extend editor</span>--></h6>" +
			"<div class='textarea relative stroked' id='topic-editor-wrapper'><textarea name='content' placeholder='Topic short description' id='topic-create-content' style='height:100px'></textarea></div>" +
			"<div class='buttons -two'>" +
			"	<div class='button -first -passive-2 -rounded' onclick='AP.closeDialog(this);'>Cancel</div>" +
			"	<div class='button -second -success -rounded' onclick='Topic.submit(this);'>Tạo thảo luận mới</div>" +
			"</div>" +
		"</form>" +
		"";


		AP.customDialog(html).closable(false)
			.width(700)
			.show();
		
		Tag.user("#topic-create-tagging", Client.people);
		$("#topic-create-fly input[name=name]").focus();
		UI.editor("#topic-editor-wrapper textarea",{
			fit: true,
			border: true,
			pannel: 'bottom'
		});
		
		$("#topic-cat_id").html("<option value='0'>Chưa phân loại</option>"+AP.render(Client.pageData.boxes, function(e){
			return "<option value='"+e.id+"'>"+e.name+"</option>";
		}));
    };
};


Topic.fav=new function __TopicFav(){
    this.toggle = function(ref) {
        var id=$(ref).data("topic");
        UI.fav.update("api/base/topic/fav", {
            target: {id: id},
            list: [],
        }, function(fav, list, code){
            Client.pageData.favs=list;
            AP.xRefresh();
        });

        return;
    };

    this.isFav=function(id){
        return UI.fav.isFav(id, Client.pageData.favs);
    };

};



Base.topicBox = new function __BaseTopicBox(){
	this.load=function(channel, callback){
		if (channel.boxes){
			return callback(channel.boxes);
		}
		
		UI.ajaxShow();
		AP.post("api/message/topic/box/load", {orgid: channel.id}, function(code){
			UI.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			code.boxes.reverse();
			callback(code.boxes);
		});
	};
	
	
	 this.create = function() {
        var data = {sysid: Client.pageData.project.id};
        
        var form = Form.create('fly-proj-addfolder-fx',{'action': "api/base/topic/box/create"})
        .row(
            Form.label({label: "Tên chủ đề"}),
            Form.input({name: 'name', "placeholder":"Tên chủ đề"}).autoSubmit()
        )
        .buttons([
             {label: "Thêm chủ đề", action: function(){
                 Form.submit("#fly-proj-addfolder-fx", function(code){
                     if (!code.good()){
                         return AP.alertError(code.message);
                     }
                     
                     Form.hide("fly-proj-addfolder-fx");
                     UI.flash("Đã thêm thư mục...");
                     AP.xRefresh();
                 })
             }, style: 'ok -success -rounded bold'},
             {label: "Hủy", action: function(){
                 Form.hide("fly-proj-addfolder-fx");
             }, style:'cancel -passive-2 -rounded'}
        ]).hiddens(data);
        
        Form.pop({width: 480, label: 'Thêm chủ đề thảo luận', layout: "flat"}).setForm(form).show().focus('name');
    };
	    
	
	this.addFromInline=function(ref, callback){
		var $box=$(ref).closest(".js-form");
		var val=$box.find("input[name=name]").val();
		var color=$box.find("input[name=color]").val();
		
		if (!val.length){
			return;
		}
		
		UI.ajaxShow();
		AP.post(Message.api+"api/message/topic/box/create",{channel_id: Channel.channel.id, name: val, color: color}, function(code){
			UI.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			$box.find("input[name=name]").val("");
			
			var html="<div class='item url'><span class='square -bg-alt"+code.box.color+"'></span>"+code.box.name+"</div>";
			$("#page-topics .page-side .items").append(html);
			
			if (callback) callback(code.box);
		});
	};
};


Topic.display=new function __BaseTopicDisplay(){
	this.visible=function(){
		return $("#topic-display").length && $("#topic-display").is(":visible");
	};
	
	this.show=function(topic_id){
		// project-sidebar
		
		initCanvas();
		if (TaskDisplay.visible()){
			TaskDisplay.close();
		}
		$("#project-master").addClass("showing-task");
		$("#base-canvas").addClass("showing-task");
		
		AP.loadInlineURL("discussions/topic/"+topic_id,{}, "#project-sidebar", {
			start: function(){
				$("#project-sidebar-canvas").show();
			},
			end: function(code){
				AP.setURLParams({"topic": topic_id});
				$("#topics .item").setActive(".topic-"+topic_id);
				if (mobile()){
					$(document.body).removeClass("xo");	
				}
			}
		});
		
//		Topic.get(topic_id, function(topic){
		
//		});
	};
	
	this.close=function(){
		$(document.body).removeClass("xo");
		$("#project-sidebar-canvas").remove();
		$("#project-master").removeClass("showing-task");
		$("#base-canvas").removeClass("showing-task");
		
		AP.setURLParams({topic: null});
		$("#topics .item").removeClass("active");
	};
	
	
	this.update=function(topic){
		Client.tempData.topic=topic;
		$("#topic-main").html(getMain(topic));
	};
	
	/**
	 * @desc Render a topic display
	 */
	this.render=function(topic){	
		$("#topic-display").html("<div id='topic-main'>"+(getMain(topic))+"</div> <div id='topic-followers'></div> <div id='topic-posts'></div>").addClass("scroll-y forced-scroll");
		
		Follow.auto("#topic-followers",{
			followers: topic.followers, 
			owners: [topic.username],
			users: Project.getPeople(Project.inspect()),
			endpoint: "api/base/topic/follow",
			data: {
				topic_id: Client.tempData.topic.id,
				topic_token: Client.tempData.topic.token
			}
		});
		
		
		var ns=Project.getLocal(topic.ns_id);
		if (ns){
			$("#js-topic-nav").html("" +
				"	<span class='-ap icon-home'></span>&nbsp; " +
				"	<span class='item url' data-url='"+ns.path+"'>"+ns.name+"</span>" +
				"	&nbsp; <span class='r'><span class='-ap icon-triangle-right'></span></span> &nbsp;" +
				"	<span class='item url' data-url='"+ns.path+"/discussions'>Thảo luận</span>" +
			"");
		}
	};
	
	
	
	function initCanvas(){
		if (mobile()){
			$(document.body).addClass("xo");
			
			if (!$("#project-sidebar").length){
				$("#page").before("<div id='project-sidebar-canvas' class='hidden'>" +
					"<div class='scrollable' data-autoscroll='1' data-autohide='1'>" +
						"<div class='project-sidebar-close' onclick='Topic.display.close();'><span class='-ap icon-close'></span></div>" +
						"<div id='project-sidebar'></div>" +
					"</div" +
				"</div>");
				Layout.scrollable("#project-sidebar-canvas .scrollable");
			}
			
			return;
		}
		
		if ($("#project-master").length){
			if (!$("#project-sidebar").length){
				$("#project-master").before("<div id='project-sidebar-canvas' class='hidden'>" +
						"<div id='project-sidebar'></div>" +
				"</div>");
				// Layout.scrollable("#project-sidebar-canvas .scrollable");
			}
		}
		
		if ($("#base-canvas").length){
			if (!$("#project-sidebar").length){
				$("#base-canvas").before("<div id='project-sidebar-canvas' class='hidden'>" +
					"<div id='project-sidebar'></div>" +
				"</div>");
				// Layout.scrollable("#project-sidebar-canvas .scrollable");
			}
		}
	};
	
	
	function getMain(topic){
		var u=People.get(topic.username);
		
		return "<div class='canvas'>" +
		"	<div class='title'><span class='url' data-xurl='showtopic/"+topic.id+"'>"+topic.name+"</span></div>" +
		"	<div class='info'>Tạo bởi <span class='url' data-username='"+u.username+"'>"+u.name+"</span> lúc "+AP.time.ago(topic.since)+"</div>" +
		"	<div class='content'>"+topic.content+"</div>" +
		"	<div class='files'>"+getFiles(topic.files)+"</div>" +
		"</div>";
	};
	
	
	
	function getFiles(files){
		if (!files || !files.length){
			return "";
		}
		
		return AP.render(files, function(e){
			return getFile(e);
		});
	};
	
	
	function getFile(e){
		var icon=UI.file.icon(e.name);
		var url=e.url;
		return "<div class='file' id='"+e.id+"'>" +
				"	<div class='ficon'><img src='"+Client.share_url+"/mimex/"+icon+".png'/></div>" +
				"	<div class='fname'><span onclick=\"Base.file.preview('"+url+"');\">"+e.name+"</span></div>" +
				"	<div class='finfo'>@"+e.username+" &middot; "+AP.time.ago(e.since)+" &middot; "+UI.file.kb(e.size)+"</div>" +
				"	<div class='actions'>" +
				"		<span class='action' onclick=\"Topic.manage.removeFile('"+e.id+"');\">" +
				"			<span class='-ap icon-uniF11F' title='Xóa file'></span>" +
				"		</span>" +
				"   </div>" +
			"</div>";
	};
	
	
};


Topic.board=new function __BaseTopicBoard(){
	this.display=function(){
		var favorite = '';	
		var normal = '';
		for (var i=0; i<Client.pageData.topics.length; i++){
			var t=Client.pageData.topics[i];
			if (Topic.fav.isFav(t.id, Client.pageData.favs)){
				favorite += render(t);
			} else {
				normal += render(t);
			}
		}

		var html = favorite + normal;
		$("#topics").append(html);
		
		if (Query.get("topic")){
			Topic.display.show(Query.get("topic"));
		}
	};
	
	
	this.initSorter=function(){
		$("#js-topic-sort .li").click(function(){
			AP.setURLParams({sort: $(this).data("sort")}, true);
		}).each(function(){
			var q=Query.get("sort");
			var cq=$(this).data("sort");
			
			if ((q && cq && q==cq) || (!q && cq=="std")){
				$(this).addClass("selected");
				$(this).siblings().removeClass("selected");
			}else{
				
			}
		});
	};
	
	
	
	function render(topic){
		var tags=[];
		
		var project=Project.getLocal(topic.ns_id);
		if (!project){
			return "";
		}
		
		if (!Client.pageData.context){
			tags.push({name: project.name, url: project.path+"/discussions", style: "tag-alt"+project.color+"-more"})
		}
		
		var u=People.get(topic.username);
		var preview=safe(topic.overview);
		if (!preview || !preview.length){
			preview="No preview available";
		}
		
		var tags_html=AP.render(tags, function(e){
			return "<span class='tag "+e.style+" url' data-url='"+e.url+"'>"+e.name+"</span>";
		});
		
		if (tags_html && tags_html.length){
			tags_html+="<span class='sep'></span>";
		}

		var star_icon = "<div class='star url' data-topic='"+topic.id+"' data-xurl='action/"+topic.id+"/topicstar' title='Đánh dấu ưu tiên'><span class='-ap icon-uniF186'></span></div>";
		if (Topic.fav.isFav(topic.id, Client.pageData.favs)){
			star_icon = "<div class='star -star url' data-topic='"+topic.id+"' data-xurl='action/"+topic.id+"/topicstar' title='Đánh dấu ưu tiên'><span class='-ap icon-star-full'></span></div>";
		}
		
		return "<div class='item -topic topic-"+topic.id+"'>" +
			"<div class='key'>" +
			"	<div class='avatar'><img src='"+AP.thumb(u.gavatar)+"'></div>" +
			"</div>" +
			"<div class='name'>" +
			"	<span class='url' data-url='showtopic/"+topic.id+"'>"+topic.name+"</span>" +
			"</div>" +
			"<div class='content'>"+preview+"</div>" +
			"<div class='info ap-xdot'>" +
				tags_html +
			"	<span class='url username' data-username='"+u.username+"'>"+u.name+"</span> " +
			"	<span class='sep'></span>" +
			"	<span class=''><span class='-ap icon-bubble3'></span>&nbsp; "+topic.stats.total+" thảo luận</span>" +
			"	<span class='sep'></span>" +
			"	Created "+AP.time.ago(topic.since)+" &middot; " +
			"	Last updated "+AP.time.ago(topic.last_update)+
			"</div>" +
			"<div class='side'>" +
			"	<div class='box' data-box_id='{$topic->box_id}'></div>" +
			"</div>" +
			"<div class='followers'>" +
			"	<div class='label'></div>" +
			"	<div class='users clear-fix'>"+getFollowers(topic)+"</div>" + star_icon +
			"</div></div>";
	};

	function getFollowers(topic){
		var total = topic.followers.length;
		var html = "";
		
		for (i = 0; i < topic.followers.length; i++){
			var u=People.get(topic.followers[i].username);
			if (i < 3) {
				html += "<div class='avatar avatar-24 -circled url' data-username='"+topic.followers[i].username+"'>" +
					"<div class='image'><img src='"+AP.xthumb(u.gavatar)+"'/></div>"+
					"</div>";
			}
		}

		if (i < 3){
			return html;
		}

		return html + "<div class='avatar avatar-24 -circled -infow'>" +
			"<span class='-infobox -up -w200'><span class='-box block normal'>"+(total - 2)+" người khác</span></span>" +
			"<div class='more'><span>"+(total - 2)+"</span></div>" +
			"</div>";

	};
};


Topic.manage=new function __TopicManager(){
	this.remove=function(){
		var topic=Client.tempData.topic;
		if (!topic){
			return;
		}
		
		AP.confirm("Are you sure that you want to remove this topic?", function(){
			UI.ajaxShow();
			AP.post("api/base/topic/remove",{topic_id: topic.id}, function(code){
				UI.ajaxHide();
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				if (Client.pageData.context){
					AP.toURL(Client.pageData.context.path+"/discussions");
				}else{
					AP.toURL("wework/discussions");
				}
			});
		});
	};

    this.removeFile=function(id){
        var topic=Client.tempData.topic;
        AP.confirm("Bạn có muốn xóa tài liệu này không ?", function(){
            UI.ajaxShow();
            AP.post("api/base/topic/remove-file",{topic_id: topic.id, id : id}, function(code){
                UI.ajaxHide();
                if (!code.good()){
                    return AP.alertError(code.message);
                }

                $("#"+id).remove();
            });
        });
    };
	
	this.edit=function(){
		var topic=Client.tempData.topic;
		if (!topic){
			return;
		}
		
		
		var data = {topic_id: topic.id};
	        
		var form = Form.create('fly-topic-fx',{'action': "api/base/topic/edit"})
		.row(
		    Form.label({label: "Tên topic"}),
		    Form.input({name: 'name', "placeholder":"Tên topic"}).value(topic.name).autoSubmit()
		)
		.row(
		    Form.label({label: "Nội dung topic"}),
		    Form.input({name: 'content', "placeholder":"Nội dung topic", role:"editor", type:"textarea"}).value(topic.content)
		)
		.row(
		    Form.label({label: "Tài liệu đính kèm"}),
		    Form.input({name: 'file-1', "placeholder":"", type:"file"})
		)
		.rowHidden(
		    Form.label({label: "&nbsp;"}),
		    Form.input({name: 'file-2', "placeholder":"", type:"file"})
		)
		.rowHidden(
		    Form.label({label: "&nbsp;"}),
		    Form.input({name: 'file-3', "placeholder":"", type:"file"})
		)
		.rowHidden(
		    Form.label({label: "&nbsp;"}),
		    Form.input({name: 'file-4', "placeholder":"", type:"file"})
		)
		.rowHidden(
		    Form.label({label: "&nbsp;"}),
		    Form.input({name: 'file-5', "placeholder":"", type:"file"})
		)
		.render(function(){
			$("#fly-topic-fx input[type=file]").on("change", function(){
				var next=$(this).closest(".row").next(".row");
				if (next && next.length){
					next.show();
				}
			});
		})
		.buttons([
		     {label: "Chỉnh sửa", action: function(){
		         Form.submit("#fly-topic-fx", function(code){
		             if (!code.good()){
		                 return AP.alertError(code.message);
		             }
		             
		             Form.hide("fly-topic-fx");
		             UI.flash("Đã lưu thành công ...");
		             AP.xRefresh();
		         })
		     }, style: 'ok -success -rounded bold'},
		     {label: "Hủy", action: function(){
		         Form.hide("fly-topic-fx");
		     }, style:'cancel -passive-2 -rounded'}
		]).hiddens(data);
		
		Form.pop({width: 600, label: 'Chỉnh sửa topic', layout: "flat"}).setForm(form).show().focus('name');
		
	};
	
	
};




var Act=new function __ACT(){
	
};


Act.board=new function __ACTBoard(){
	this.display=function(){
		var html=AP.render(Client.pageData.activities, function(e){
			return getActHTML(e);
		});
		
		if (!Client.pageData.activities || !Client.pageData.activities.length){
			html="<div class='no-act'>No activity logged recently</div>";
		}
		
		$("#acts").html(html);
	};
	
	
	this.onclick=function(ref){
		$(ref).addClass("active");
		$(ref).siblings().removeClass("active");
	};
	
	
	this.getHTML=function(act){
		return getActHTML(act);
	};
	
	
	
	function getActHTML(act){
		var content=act.content;
		if (!content || !content.length){
			content=act.sub;
		}
		
		return "<div class='act -unread url' data-url='"+act.link+"' onclick='Act.board.onclick(this);'>" +
			"<div class='subtitle ap-xdot'>" + Act.origin.display(act.origin_export, act) + "</div>" +
			"<div class='title'>"+act.name+"</div>" +
			"<div class='content'>"+content+"</div>" +
			"<div class='events'>" +
				getEvents(act)+
			"</div>" +
		"</div>";
	};
	
	
	
	function getEvents(act, engine){
		return AP.render(act.events, function(e){
			var u=People.get(e.username);
			var icon="<img src='"+AP.xthumb(u.gavatar)+"'/>";
			if (e.icon && e.icon.color && e.icon.icon){
				icon="<div class='c -bg-alt"+e.icon.color+"'><span class='-ap icon-"+e.icon.icon+"'></span></div>";
			}
			
			var content="<div class='note'>"+e.content+"</div>";
			
			return "<div class='event'>" +
				"<div class='icon'>"+icon+"</div>" +
				"<div class='label'>"+e.name+" <span class='time'>"+AP.time.ago(e.since)+"</span></div>" +
				content +
			"</div>";
		})
	};
	
};


Act.origin=new function __ACTOrigin(){
	this.display=function(origin, act){
		
		if (!origin || !origin.type){
			return "Unknown activity";
		}
		
		var type=origin.type.toLowerCase();
		if (type=="projecttopics" || type=="message.topic"){
			return "<span class='icon'><span class='-ap icon-uniF1D7'></span></span> Thảo luận trong <span class='tag'>"+origin.name+"</span>";
		}
		
		
		if (origin.type=="projecttasks"){
			var p=Project.getLocal(act.ns_id);
			if (p){
				return "<span class='icon'><span class='-ap icon-uniF10E'></span></span> Công việc trong <span class='tag'>"+p.name+"</span>";
			}	
		}
		
		return "<span class='icon'><span class='-ap icon-uniF10E'></span></span> Hoạt động trong <span class='tag'>"+origin.name+"</span>";
	}
};
var Project = new function __Project() {
	this.inspect = function(){
		if (Client.tempData && Client.tempData.context) {
			return Client.tempData.context;
		}

		if (Client.pageData.context) {
			return Client.pageData.context;
		}

		return null;
	};

	/**
	 * @desc Context-aware getting project from its ID
	 */
	this.fromContext=function(id){
		return this.getLocal(id);
	};
	

	/**
	 * @desc Alias of fromContext()
	 */
	this.getLocal = function(id){
		if (Client.pageData.context) {
			if (parseInt(id) == Client.pageData.context.id) {
				return Client.pageData.context;
			}
		}
		
		if (Client.tempData && Client.tempData.context) {
			if (parseInt(id) == Client.tempData.context.id) {
				return Client.tempData.context;
			}
		}
		
		if (Client.pageData.projects){
			var tobj = AP.array.findObj(Client.pageData.projects, id);
			if (tobj) {
				return tobj;
			}	
		}
		
		
		var obj = AP.array.findObj(Client.projects, id);
		if (obj) {
			return obj;
		}

		return null;
	};


	/**
	 * @desc Check context-aware that the user is the manager of the current project
	 * @return boolean
	 */
	this.isManager = function(user) {
		if (!user) {
			user = Client.viewer;
		}
		
		var project=Project.inspect();
		if (!project){
			return false;
		}
		
		return AP.array.indexOf(project.owners, user, function (a, b) {
			return a.username == b.username;
		}) != -1;
	};

	
	/**
	 * @desc Check context-aware that the user is the member of the current project
	 * @return boolean
	 */
	this.isMember = function (user){
		if (!user) {
			user = Client.viewer;
		}
		
		var project=Project.inspect();
		if (!project){
			return false;
		}
		
		return AP.array.indexOf(project.followers, user, function (a, b) {
			return a.username == b.username;
		}) != -1;
	};


	
	this.tasklists = function(){
		return Board.data.init();
		// alert("DEPRECATED");
	};



	this.getPeople = function (project) {
		if (!project) {
			return Client.people;
		} else {
			return AP.array.filter(Client.people, function (e) {
				if (AP.array.contain(project.owners, e, function (a, b) {
					return a.username == b.username;
				})) {
					return true;
				}

				if (AP.array.contain(project.followers, e, function (a, b) {
					return a.username == b.username;
				})) {
					return true;
				}

				return false;
			});
		}
	};


	/**
	 * @desc Pick a project
	 */
	this.pick = function (callback, title) {
		if (!Client.projects || !Client.projects.length) {
			return;
		}

		var options = [];
		for (var i = 0; i < Client.projects.length; i++) {
			var p = Client.projects[i];
			if (p.status == 0) {
				options.push({label: p.name, icon: "uniF106", data: p});
			}
		}

		AP.selectAction(options, function (e) {
			callback(e.data);
		}, {
			title: title,
			filter: true
		});
	};


	/**
	 * @desc Get item by a given id, handler with callback
	 */
	this.get = function (id, callback) {
		UI.ajaxShow();
		AP.post("api/project/get", {'id': id}, function (code) {
			UI.ajaxHide();

			if (!code.good()) {
				return AP.alertError(code.message);
			}

			callback(code.project);
		});
	};

	this.create = function () {
		return Project.form.create();
	};

	
	

	this.addItem = function () {
		return this.form.addItem();
	};


	this.addTask = function (tasklist_id) {
		var tasklist = AP.array.findObj(Client.pageData.tasklists, tasklist_id);
		if (!tasklist) {
			return;
		}

		Task.dialog.add(Client.pageData.project, tasklist);
	};


	this.addTaskSelect = function () {
		Task.dialog.add(Client.pageData.project);
		return;

		var options = AP.select(Client.pageData.tasklists, function (e) {
			return {"id": e.id, "label": e.name, "object": e, sublabel: e.content, icon: "list-unordered"};
		});

		options.push({label: "<b>Thêm nhóm công việc mới</b>", type: "create"});

		AP.selectAction(options, function (obj) {
			if (obj.type == "create") {
				return TaskList.create(Client.pageData.project);
			}

			Task.dialog.add(Client.pageData.project, obj.object);
		}, {title: "Lựa chọn Nhóm công việc", filter: true, icon: true});
	};

	
};



Project.header=new function __ProjectHeader(){
	this.init=function(){
		Project.fav.init();
		if (!Client.pageData.project){
			return;
		}
		
		if (Client.pageData.task_view){
			$("#header .tab .-cmenu .-item").setActiveURLParam("view", Client.pageData.task_view);	
		}else if (Client.pageData.project.options){
			$("#header .tab .-cmenu .-item").setActiveURLParam("view", Client.pageData.project.options.style);
		}
		
		$("#header .tab.is-home .sub").html($("#header .tab .-cmenu .-item.active").text());
		
		
		if (Client.pageData.task_view=="table" || Client.pageData.task_view=="board"){
			if (Client.pageData.project.metatype=="team" && Client.pageData.task_view=="board"){
				Team.filter.init();
			}

			if (Client.pageData.project.metatype=="private" && Client.pageData.task_view=="board"){
				Team.filter.init();
			}
			
			$("#project-filters").addClass("onboard").prependTo("#header .side").css({'float': 'left'});
		}
		
		if (Client.pageData.project.metatype!="project"){
			AP.bindSearch("#js-side-search .input input")
		}else{
			initLiveQueryFilter();
		}
	};
	
	
	/**
	 * @desc Applying a filter
	 */
	this.applyFilter=function(filter){
		$("#js-side-search input").val(filter+" ").select().trigger("input");
	};
	
	
	/**
	 * @desc Cleaning up filter
	 */
	this.clearSearch=function(){
		
	};
	
	
	function initLiveQueryFilter(){
		Tag.user("#js-side-search .input input", Project.getPeople());
		
		var delay_timer=0;
		$("#js-side-search .input input").on("input",function(){
			var $this = $(this);
			clearTimeout(delay_timer);
			
			delay_timer = setTimeout(function(){
				var q=$this.val();
				executeFilter(q);
			}, 300);
		});
	};
	
	
	function executeFilter(q){
			if (!q){
				q="";
			}
			
			q=$.trim(q).toLowerCase();
			q=purifyStrict(q);
			$.log(q);
			
			var view=Client.pageData.task_view;
			if (view=="list"){
				$("#tasklists .task-wrapper.js-task").each(function(){
					if (!q){
						if ($(this).hasClass("search_hidden")){
							$(this).removeClass('search_hidden');
						}

					}else{
						if (matched(this, q)){
							$(this).removeClass("search_hidden");
						}else{
							$(this).addClass("search_hidden");
						}
					}
				});
			}
			
			if (view=="board" || view=="people"){
				if (!q){
					$("#main-board .js-task").removeClass("search_hidden");
					return;
				}
				
				$("#main-board .js-task").each(function(){
					if (matched(this, q)){
						$(this).removeClass("search_hidden");
					}else{
						$(this).addClass("search_hidden");
					}
				});
			}

			if (view == "table"){
				$("#js-main-table .js-task").each(function() {
					var task_id = $(this).data("id");
					if (!q) {
						if ($(this).hasClass("search_hidden")){
							$(this).removeClass("search_hidden");
							$('#js-gantt-table .gbarwrapper-' + task_id).removeClass("search_hidden");
							$('#js-custom-table .tr.js-task-' + task_id).removeClass("search_hidden");
						}

					}else{
						if (matched(this, q)){
							$(this).removeClass("search_hidden");
							$('#js-gantt-table .gbarwrapper-' + task_id).removeClass("search_hidden");
							$('#js-custom-table .tr.js-task-' + task_id).removeClass("search_hidden");
						}else{
							$(this).addClass("search_hidden");
							$('#js-gantt-table .gbarwrapper-' + task_id).addClass("search_hidden");
							$('#js-custom-table .tr.js-task-' + task_id).addClass("search_hidden");
						}
					}
				});
			}

			if (view=="calendar"){
				$("#js-calendar .item.js-task-calendar").each(function(){
					if (!q){
						if ($(this).hasClass("search_hidden")){
							$(this).removeClass('search_hidden');
						}

					}else{
						if (matched(this, q)){
							$(this).removeClass("search_hidden");
						}else{
							$(this).addClass("search_hidden");
						}
					}
				});
			}

			
	};
	

	

	function matched(elem, q) {
		var keywords = purifyStrict($(elem).data("keywords"));
		return keywords.indexOf(q)!=-1;
	};
};


AP.sys.on("subtask.created", function(task){
	Project.on.taskCreated(task);
});


AP.sys.on("subtask.updated", function(task){
	Project.on.taskUpdated(task);
});




AP.rewrite('paction/([0-9]+)/([a-z\.]+)', 'projectact?id=$1&action=$2', function(qs){
	if (qs.action=="removeicon"){
		AP.confirm("Confirm to remove fav icon", function(){
			UI.ajaxShow();
			AP.post("api/project/remove.icon", {id: qs.id}, function(code){
				UI.ajaxHide();
				
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				AP.refresh();
			});
		});
	}
	
	
	if (qs.action=="stage"){
		var current=[$(this).data("stage")];
		Form.inlineLabelTagger(this, function(item){
			Project.manage.fix("stage", $(item).data("id"), function(code){
				Side.overview.display();
				AP.refresh();
			});
		}, {
			labels: Project.option.statuses(),
			position:{
				right: 1,
			},
			click: true,
			selected: current
		});
	};
	
	if (qs.action=="time"){
		Project.manage.fixTime(function(project){
			Client.pageData.project=project;
			Client.pageData.context=project;
			Side.overview.display();
		});
	}
	
	if (qs.action=="status"){
		var id=qs.id;
		
		var project=AP.array.findObj(Client.pageData.projects, id);
		if (!project){
			project=Client.pageData.context;
		}
		
		if (!project){
			return;
		}
		
		if (Me.isOwner(project) || Me.isSystemOwner()){
			Project.status.update(project);
		}
	}
	
	if (qs.action=="edit"){
		var id=qs.id;
		var project=Project.fromContext(id);
		if (!project){
			return;
		}
		
		return Project.form.edit(project);
	}
	
	if (qs.action=="tags"){
		Base.tagManager.init(Client.pageData.context);
		Base.tagManager.dialog();
	}
	
	if (qs.action=="tasklist.toggle"){
		return Board.list.toggleTasklist($(this).data("id"), this);
	}
});



AP.rewrite('action/filter/([a-z0-9]+)', 'taskfilter?action=$1', function(qs){
	if (Client.pageData.context){
		Board.filter.live("filter", qs.action);
	} else {
		Board.filter.live("filter", qs.action);
		// MT.filter.set(qs.action);
	}
});




/**
 * @desc Specific action for group
 * @param qs
 * @returns
 */
AP.rewrite('groupaction/([a-zA-Z0-9]+)/([a-zA-Z\.0-9]+)/([a-zA-Z0-9]+)', 'groupaction?metatype=$1&id=$2&action=$3', function(qs){
	var action=qs.action;
	
	if (action=="taskinlinecreate"){
		$(this).toggleClass("active");
		$(this).closest(".js-group").find(".bform-wrapper").toggleClass("active");
		
		if ($(this).hasClass("active")){
			$(this).closest(".js-group").find(".bform-wrapper *[name=name]").focus();
		}
		
		return;
	}
	
	
	return Project.tform.dialog(assoc(qs.metatype, qs.id));	
	
});





/**
 * @desc Specific action for tasklist
 * @param qs
 * @returns
 */
AP.rewrite('tlaction/([0-9]+)/([a-z]+)', 'tlaction?id=$1&action=$2', function(qs){
	var action=qs.action;
	if (action=="edit"){
		return TaskList.edit(qs.id);
	}
	
	if (action=="reviewer"){
		return TaskList.manage.setReview(qs.id);
	}
	
	if (action=="remove"){
		return TaskList.manage.remove(qs.id);
	}
	
	if (action=="close"){
		return TaskList.manage.close(qs.id);
	}
});




/**
 * @desc Specific action on a single task
 * @param qs
 * @returns
 */
AP.rewrite('action/([0-9]+)/([a-z]+)', 'taskinline?id=$1&action=$2', function(qs){	
	var acl=$(this).data("acl");
	if (!acl){
		acl=0;
	}else{
		acl=parseInt(acl);
	}
	
	var $box=$(this).closest(".js-task");
	if ($box.hasClass("focus")){
		// $box.removeClass("focus").siblings().removeClass("focus");
		// return;
	}else{
		// $box.addClass("focus").siblings().removeClass("focus");
	}
	
	var action=qs.action;
	var value=$(this).data("value");

	if (action=="mask"){
		$(this).closest(".li").removeClass("editing focus").find(".activated").removeClass("activated"); 
	}
	
	if (action=="edit"){
		Board.list.editing(this);
	}
	
	if (action=="star"){
		Task.fav.toggle(this);
	}

	if (action=="topicstar"){
		Topic.fav.toggle(this);
	}

	if (action=="check"){
		if (!acl){
			return;
		}
		
		var done=$(this).data("status");
		if (parseInt(done)){
			Task.setStatus(qs.id, 0, this);	
		}else{
			Task.setStatus(qs.id, 1, this);
		}
	}
	
	if (action=='tasklist'){
		var tid=$(this).data("tid");
		Task.inline.edit(qs.id, {key: "tasklist", value: tid}, this);

		Task.inline.updateTaskList(tid);

		var status=$("#task-"+qs.id).data("status");
		
		if (parseInt(status)){
			$("#task-"+qs.id).appendTo("#tasklist-"+tid+" .-done .list.tasks");
		}else{
			$("#task-"+qs.id).appendTo("#tasklist-"+tid+" .-normal .list.tasks");
		}

	}
	
	
	if (action=="remove"){
		Task.inline.remove(qs.id, this);
	}
	
	
	if (action=="gedit"){
		return Task.dialog.edit(Project.inspect(), Task.fromContext(qs.id));
	}
	
	if (action=="fedit"){
		return Task.inline.editCustomField(Task.fromContext(qs.id), $(this).data("fid"), this);
	}
	
	if (action=="duration"){
		return Task.ie.init(this, qs.id, "duration");
	};
	
	
	if (action=="startdate" || action=="starttime"){
		if (!acl || !parseInt(acl)){
			return;
		}
		
		return Task.ie.init(this, qs.id, "starttime");
	};
	
	if (action=="startnow"){
		if (!acl || !parseInt(acl)){
			return;
		}
		
		Task.inline.fix(qs.id, "starttime", AP.time.now());
	};

	
	if (action == 'startdate-remove' || action == 'starttime-remove'){
		Task.ie.close();
		
		AP.confirm("Confirm to remove task start time?", function(){
			UI.ajaxShow();
			AP.post("api/task/fix",{id: qs.id, key:'starttime.remove'}, function(code){
				UI.ajaxHide();
				AP.hideAlert();

				if (!code.good()){
					return AP.alertError(code.message);
				}

				UI.flash("Update successfully");
				Task.update(code.task);
			});
		});
	};
	
	
	if (action == 'deadline-remove'){
		Task.ie.close();
		
		AP.confirm("Confirm to remove task deadline?", function(){
			Task.inline.fix(qs.id, 'deadline.remove', 1);
		});
	}
	
	
	if (action=="deadline"){
		if (!acl){
			return;
		}
		
		return Task.ie.init(this, qs.id, "deadline");
	}
	
	
	if (action=="urgent"){
		if (!acl){
			return;
		}
		
		var value=parseInt($(this).data("value"));
		if (value==1){
			value=0;
		}else{
			value=1;
		}
		
		Task.inline.edit(qs.id, {key: "urgent", value: value}, this);
		return;
	}
	
	
	if (action=="important"){
		if (!acl){
			return;
		}
		
		var value=parseInt($(this).data("value"));
		if (value==1){
			value=0;
		}else{
			value=1;
		}
		
		Task.inline.edit(qs.id, {key: "important", value: value}, this);
		return;
	}
	
	
	if (action=="addtocalendar"){
		return Task.calendar.add(qs.id);
	}

	if (action=="review"){
		var detail=$(this).data("detail");
		var assignee=$(this).data("assignee");
		if (detail) {
			var top = 48;// Select in task detail
		} else {
			var top = 20;// Select in tasks list
		}
		
		var labels = Task.option.reviews(assignee);
		var task = Task.fromContext(qs.id);
		if (task.metatype != "undefined") {
			if (task.metatype == "subtask") {
				labels = AP.array.filter(labels, function(e){
					return parseInt(e.id)!=0;
				});
			}
		}

		Form.inlineLabelTagger(this, function(item){
			var id=$(this).closest(".js-task").data("id");
			var v=$(item).data("id");
			Task.inline.edit(id, {key: "review", value: v}, this);
		}, {
			labels: labels,
			position:{
				left: -1,
				top:top
			},
			click: true,
			selected: [parseInt(value)]
		});
	}
	
	
	if (action=="tags"){
		Task.ie.init(this, qs.id, "tags");
		return;
	}
	
	if (action=="milestone"){
		Task.ie.init(this, qs.id, "milestone");
		return;
	}
	
	
	if (action=="assign"){
		Task.ie.init(this, qs.id, "assign");
		return;
	}
	
	
	if (action=="custom"){
		if (parseInt($(this).data("acl"))){
			Board.table.showInlineForm(this);	
		}
	}
	
	if (action=="submitinline"){
		Form.submitFrom(this, function(code){
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			UI.flash("Công việc đã được cập nhật ...");
			$("#js-project-task .js-task-content").removeClass("editing");
			Project.on.taskUpdated(code.task);
		});
	}
	
	
	if (action=="submitcancel"){
		$(this).closest(".edit-box").removeClass("editing");
		$("#js-task-display .item-top .actions").css("display", "block");
	};
	
	if (action=="submitnow"){
		$("#js-project-task .edit-task-name .edit-form textarea").triggerEnter();
		return;
	}
	
	
	if (action=="follow"){
		Task.action.follow(1);
	}
	
	if (action=="unfollow"){
		Task.action.follow(0);
	}
	
	if (action=="addfollower"){
		Form.inlineTagger(this, {
			title: "Add followers",
			search: true,
			users: Project.getPeople(Project.inspect()),
			select: function(user){
				Task.action.setFollow(user);
			},
			position:{
				left:-60,
			},
			width: 250,
			click: true
		});
	}
	
	
	if (action=="extfollower"){
		Form.inlineTagger(this, {
			title: "Add external followers",
			search: true,
			users: Client.people,
			select: function(user){
				Task.action.setFollow(user);
			},
			position:{
				right:1,
			},
			width: 250,
			click: true
		});

		// if(window.location.href.indexOf("calendar") >= 0) {
		//	 $("#js-project-item .js-followers .-close").hide();
		// }
	}
	
	if (action=="checklist"){
		var subaction=$(this).data("action");
		if (subaction=="assign"){
			Form.inlineTagger(this, {
				title: "Assign todo in checklist",
				search: true,
				users: Project.getPeople(Project.inspect()),
				select: function(user){
					Checklist.assignItem(qs.id, $(this).data("id"), user, this);
				},
				position:{
					right:1,
				},
				width: 250,
				click: true
			});
		}
	}
	
});











AP.sys.on("tasklist.create", function(item){
	// Simply rebuild the whole board
	Client.pageData.tasklists.push(item);
	Board.build();
});


AP.sys.on("tasklist.move", function(dir, item){
	var $box=$("#tasklist-"+item.gid);
	if (!$box.length){
		return;
	}
	
	if (dir=="down"){
		var $elem=$box.prev();
		if ($elem && $elem.length){
			$box.hide().insertBefore($elem).slideDown(300);
		}
	}else{
		if (dir=="up"){
			var $elem=$box.next();
			if ($elem && $elem.length){
				$box.hide().insertAfter($elem).slideDown(300);
			}
		}
	}
});


AP.sys.on("tasklist.remove", function(item){
	var $box=$("#tasklist-"+item.gid);
	if (!$box.length){
		return;
	}
	
	$box.slideUp(300);
	
	Client.pageData.tasklists = AP.array.remove(Client.pageData.tasklists, item, function(e1, e2){
		return e1.id==e2.id;
	});
	
	Client.pageData.tasks = AP.array.remove(Client.pageData.tasks, item, function(e1, e2){
		return e1.tasklist_id==e2.id;
	});
});



AP.sys.on("tasklist.edit", function(tasklist){
	// Simply rebuild the whole board
	// AP.array.updateByID(Client.pageData.tasklists, tasklist);
	// Board.list.build();
	
	$.log(Client.pageData.tasklists);
});







AP.sys.on("item.update", function(item){
	Board.updateItem(item);
});

AP.sys.on("project.reopen", function(project) {
	return AP.xRefresh();
});

AP.sys.on("project.finish", function(project) {
	return AP.xRefresh();
});





Project.taglist=new function __ProjectTagList(){
	this.__tags=null;
	
	this.reload=function(context_id, tags){
		var __tags={};
		for (var i=0; i<tags.length; i++){
			__tags["t"+tags[i].key]=tags[i];
		}
		
		this.__tags={
			id: context_id,
			tags:__tags
		};
	};
	
	
	this.parse=function(tags, context){
		if (!context){
			context=Client.pageData.context;
		}
		
		if (!context){
			return AP.select(tags, function(e){
				return {name: e, color:0, key: e};
			});
		}
		
		if (this.__tags && this.__tags.id == context.id){
		}else{
			var __tags={};
			for (var i=0; i<context.tags.length; i++){
				__tags["t"+context.tags[i].key]=context.tags[i];
			}
			
			this.__tags={
				id: context.id,
				tags: __tags
			};
		}
		
		
		var r=[];
		for (var i=0; i<tags.length; i++){
			var tag=this.__tags.tags["t"+tags[i]];
			if (tag){
				r.push(tag);
			}
		}
		
		return r;
		
	};
	
	
	
	this.quickCreate=function(project, callback){
		var data={id: project.id};
		
		var form=Form.create('fly-workflow-fx',{'action': project.path+"/api/settings/tags/edit"})
		.row(
			Form.label({label: "Tag"}),
			Form.input({name: 'name', "placeholder":"Tag"}).autoSubmit()
		)
		.row(
			Form.label({label: "&nbsp;",sublabel: ""}),
			Form.input({name: 'color', type:"colors"}).value(AP.data.randomInteger(1,9))
		)
		.buttons([
		     {label: "Thêm tag", action: function(){
		    	 Form.submit("#fly-workflow-fx", function(code){
		    		 if (!code.good()){
		    			 return AP.alertError(code.message);
		    		 }
		    	
		    		 Form.hide("fly-workflow-fx");
		    		 
		    		 project.tags=code.updated_tags;
		    		 Project.taglist.reload(project.id, code.updated_tags);
		    		 callback(code.tag);
		    	 })
		     }, style: 'ok -success -rounded bold'},
		     {label: "Huỷ", action: function(){
		    	 Form.hide("fly-workflow-fx");
		     }, style:'cancel -passive-2 -rounded'}
		])
		.hiddens(data)
		.render(function(form){
			
		});
	
		Form.pop({width: 400, label: 'Thêm tag vào '+project.name, layout: 'flat'}).setForm(form).show().focus('name');
	
	};
	
	
};


Project.fav=new function __ProjectFav(){
	this.init=function(){
		if (UI.fav.isFav(Client.pageData.context.id, Client.favs)){
			$("#header .star").addClass("-star");
		}
		
		$("#header .star").click(function(){
			$(this).toggleClass("-star");
			Project.fav.toggle();
		});
	};
    
    
    this.isFav=function(){
    	
    };
    
    
    this.toggle = function() {
    	UI.fav.update("api/project/fav", {
    		target: Client.pageData.context, 
    		list: Client.favs,
    	}, function(fav, list){
    		Client.favs=list;
    		Menu.build();
    	});
    	
    	return;
    };
      
};


Project.header=new function __ProjectHeader(){
	this.init=function(){
		Project.fav.init();
		if (!Client.pageData.project){
			return;
		}
		
		if (Client.pageData.task_view){
			$("#header .tab .-cmenu .-item").setActiveURLParam("view", Client.pageData.task_view);	
		}else if (Client.pageData.project.options){
			$("#header .tab .-cmenu .-item").setActiveURLParam("view", Client.pageData.project.options.style);
		}
		
		$("#header .tab.is-home .sub").html($("#header .tab .-cmenu .-item.active").text());
		
		
		if (Client.pageData.task_view=="table" || Client.pageData.task_view=="board"){
			if (Client.pageData.project.metatype=="team" && Client.pageData.task_view=="board"){
				Team.filter.init();
			}

			if (Client.pageData.project.metatype=="private" && Client.pageData.task_view=="board"){
				Team.filter.init();
			}
			
			$("#project-filters").addClass("onboard").prependTo("#header .side").css({'float': 'left'});
		}
		
		if (Client.pageData.project.metatype!="project"){
			AP.bindSearch("#js-side-search .input input")
		}else{
			initLiveQueryFilter();
		}
	};
	
	
	/**
	 * @desc Applying a filter
	 */
	this.applyFilter=function(filter){
		$("#js-side-search input").val(filter+" ").select().trigger("input");
	};
	
	
	/**
	 * @desc Cleaning up filter
	 */
	this.clearSearch=function(){
		
	};
	
	
	function initLiveQueryFilter(){
		Tag.user("#js-side-search .input input", Project.getPeople());
		
		var delay_timer=0;
		$("#js-side-search .input input").on("input",function(){
			var $this = $(this);
			clearTimeout(delay_timer);
			
			delay_timer = setTimeout(function(){
				var q=$this.val();
				executeFilter(q);
			}, 300);
		});
	};
	
	
	function executeFilter(q){
			if (!q){
				q="";
			}
			
			q=$.trim(q).toLowerCase();
			q=purifyStrict(q);
			$.log(q);
			
			var view=Client.pageData.task_view;
			if (view=="list"){
				$("#tasklists .task-wrapper.js-task").each(function(){
					if (!q){
						if ($(this).hasClass("search_hidden")){
							$(this).removeClass('search_hidden');
						}

					}else{
						if (matched(this, q)){
							$(this).removeClass("search_hidden");
						}else{
							$(this).addClass("search_hidden");
						}
					}
				});
			}
			
			if (view=="board" || view=="people"){
				if (!q){
					$("#main-board .js-task").removeClass("search_hidden");
					return;
				}
				
				$("#main-board .js-task").each(function(){
					if (matched(this, q)){
						$(this).removeClass("search_hidden");
					}else{
						$(this).addClass("search_hidden");
					}
				});
			}

			if (view == "table"){
				$("#js-main-table .js-task").each(function() {
					var task_id = $(this).data("id");
					if (!q) {
						if ($(this).hasClass("search_hidden")){
							$(this).removeClass("search_hidden");
							$('#js-gantt-table .gbarwrapper-' + task_id).removeClass("search_hidden");
							$('#js-custom-table .tr.js-task-' + task_id).removeClass("search_hidden");
						}

					}else{
						if (matched(this, q)){
							$(this).removeClass("search_hidden");
							$('#js-gantt-table .gbarwrapper-' + task_id).removeClass("search_hidden");
							$('#js-custom-table .tr.js-task-' + task_id).removeClass("search_hidden");
						}else{
							$(this).addClass("search_hidden");
							$('#js-gantt-table .gbarwrapper-' + task_id).addClass("search_hidden");
							$('#js-custom-table .tr.js-task-' + task_id).addClass("search_hidden");
						}
					}
				});
			}

			if (view=="calendar"){
				$("#js-calendar .item.js-task-calendar").each(function(){
					if (!q){
						if ($(this).hasClass("search_hidden")){
							$(this).removeClass('search_hidden');
						}

					}else{
						if (matched(this, q)){
							$(this).removeClass("search_hidden");
						}else{
							$(this).addClass("search_hidden");
						}
					}
				});
			}

			
	};
	

	

	function matched(elem, q) {
		var keywords = purifyStrict($(elem).data("keywords"));
		return keywords.indexOf(q)!=-1;
	};
};


Project.subheader=new function __ProjectSubheader(){
	/**
	 * @desc Init header form
	 */
	this.init=function(){
		initHeader();
	};
	
	
	function initHeader(){
		if (!Client.pageData.project){
			return;
		}
		
		var html="<div class='title'> Danh sách công việc </div>";

		var task_create_html = '';
		var tasklist_create_html = '';
		var separate = '';
		
		if (!Client.pageData.project.acl.task_create && !Client.pageData.project.acl.tasklist_create){
			
		}else{
			if (Client.pageData.project.acl.task_create) {
				task_create_html = "<span class='action' onclick='Project.tform.dialog();'>Tạo công việc</span>";
			}

			if (Client.pageData.project.acl.tasklist_create) {
				tasklist_create_html = "<span class='action' onclick='TaskList.create()'>Tạo nhóm công việc mới</span>";
			}

			if (Client.pageData.project.acl.task_create && Client.pageData.project.acl.tasklist_create) {
				separate = "hoặc";
			}

			html="<div class='task-user-add'> <div class='avatar'><img src='"+(AP.xthumb(Client.viewer.gavatar))+"'></div> <div class='icon'><span class='-ap icon-plus2'></span></div> <div class='mask url' onclick='Project.tform.dialog();'></div> <div class='txt'> "+(task_create_html)+" "+(separate)+" "+(tasklist_create_html)+" </div> </div>";
		}
		
		$("#js-project-header").html(html); 
	};
	
};


Project.option=new function __ProjectOption(){	
	this.statuses=function(){
		if (!Client.pageData.project || Client.pageData.project.metatype == 'project') {
			return [
				{value: "ontrack", label:"Trong kiểm soát", name: "Trong kiểm soát", color: "0", "id": "ontrack"},
				{value: "accelerated", label:"Tăng tốc", "name":"Tăng tốc", color: "0", id: "accelerated"},
				{value: "postponed", label:"Tạm dừng", name:"Tạm dừng", color: 4, "id":"postponed"},
				{value: "late", label:"Dự án trễ", name:"Dự án trễ", color: 8, id: "late"}
			];
		} else if (Client.pageData.project.metatype == 'team') {
			return [
				{value: "running", label:"Đang chạy", "name":"Đang chạy", color: "0", id: "running"},
				{value: "closed", label:"Đã đóng", name:"Đã đóng", color: 8, id: "closed"}
			];
		}
	};
	
	this.showPrinter=function(){
		AP.alertSuccess("Press <code>CTLR + P</code> to print the task list (LIST VIEW only)");
	};
	
	
	
	this.tasklist=function(tasklist){
		var ab=new ActionManager({icon: false});
		
		if (!tasklist.id){
			return ab;
		}
		
		
		ab.add({label: "Chỉnh sửa nhóm công việc", "url": "tlaction/"+(tasklist.id)+"/edit"});
		ab.add({label: "Sửa người reviewer", "url": "tlaction/"+(tasklist.id)+"/reviewer"});
		
		if (Client.pageData.project.metatype!="project"){
			if (TaskList.isClosed(tasklist)){
				ab.add({label: "Mở lại nhóm công việc", "url": "tlaction/"+(tasklist.id)+"/open"});	
			}else{
				ab.add({label: "Tạm đóng nhóm công việc", "url": "tlaction/"+(tasklist.id)+"/close"});
			}
			
		}
		
		ab.add("---");
		ab.add({label: "Xóa nhóm công việc", "url": "tlaction/"+(tasklist.id)+"/remove", style:"red"});
		
		return ab;
	};
	
	
	this.milestone=function(m){
		var ab=new ActionManager({icon: false});
		ab.add({label: "Edit milestone", "url": "tlaction/"+(m.id)+"/edit"});
		ab.add("---");
		ab.add({label: "Delete milestone", "url": "tlaction/"+(m.id)+"/remove", style:"red"});
		
		return ab;
	};
	
	
};


Project.status=new function __ProjectStatus(){
	this.closed_statuses=[
		{value:"success", label: "Closed & Successful"},
		{value:"failed", label: "Closed & Failed"},
		{value:"canceled", label: "Closed & Canceled"}
	];
	
	
	this.statuses=[
		{value:"ontrack", label: "On track"},
		{value:"offtrack", label: "Off track"},
		{value:"atrisk", label: "At risk"}
	];
	
	this.exportLabels=function(){
		var lbs=[];
		
		for (var i=0; i<this.statuses.length; i++){
			lbs.push(this.statuses[i].label);
		}
		
		return lbs;
	};
	
	this.getLabel=function(key){
		for (var i=0; i<this.statuses.length; i++){
			var s=this.statuses[i];
			if (purifyStrict(s.value)==purifyStrict(key) || purifyStrict(s.label)==purifyStrict(key)){
				return s.label;
			}
		}
		
		for (var i=0; i<this.closed_statuses.length; i++){
			var s=this.closed_statuses[i];
			if (purifyStrict(s.value)==purifyStrict(key) || purifyStrict(s.label)==purifyStrict(key)){
				return s.label;
			}
		}
		
		return "On track";
	};
	
	
	this.getKey=function(key){
		for (var i=0; i<this.statuses.length; i++){
			var s=this.statuses[i];
			if (purifyStrict(s.value)==key || purifyStrict(s.label)==key){
				return s.value;
			}
		}
		
		for (var i=0; i<this.closed_statuses.length; i++){
			var s=this.closed_statuses[i];
			if (purifyStrict(s.value)==key || purifyStrict(s.label)==key){
				return s.value;
			}
		}
		
		return "ontrack";
	};
	
	
	this.getShortLabel=function(key){
		var label=this.getLabel(key);
		var paths=label.split("|");
		if (paths && paths.length){
			return paths[0];	
		}
		
		return label;
	};
	
	
	this.update=function(project){
		if (AP.data.isInt(project)){
			project=Project.fromContext(project);
		}
		
		if (!project){
			project=Client.pageData.project;
		}
		
		if (!project){
			return;
		}	
		
		var data={id: project.id, hid: project.hid, token: project.token};
		var opts=this.statuses;
		if (parseInt(project.status)){
			opts=this.closed_statuses;
		}
		
		var form=Form.create('fly-tasklist-fx',{'action': "api/project/status"})
		.row(
			Form.label({label: "Dự án/team *"}),
			Form.inputGroup([
				Form.input({name: 'name', placeholder: "Dự án/team", type: "fake"}).value(project.name)
			])
		)
		.row(
			Form.label({label: "Stage"}),
			Form.input({name: 'stage', type:"select", options: opts}).value(Project.status.getLabel(project.status_obj.stage))
		)
		.row(
			Form.label({label: "Miêu tả"}),
			Form.input({name: 'note', type:"textarea", placeholder: "Mô tả thêm về tình trạng dự án/team hiện tại"}).value(project.status_obj.note)
		)
		.buttons([
			 {label: "Cập nhật", action: function(){
				 Form.submit("#fly-tasklist-fx", function(code){
					 if (!code.good()){
						 return AP.alertError(code.message);
					 }
					 
					 UI.flash("Update successfully ...");
					 Form.hide("fly-tasklist-fx");
					 AP.refresh();
				 })
			 }, style: 'ok -success -rounded bold'},
			 {label: "Huỷ bỏ", action: function(){
				 Form.hide("fly-tasklist-fx");
			 }, style:'cancel -passive-2 -rounded'}
		])
		.hiddens(data)
		.render(function(fref){
			
		});


		Form.pop({id:'fly-tasklist-dx', width: 480, label: 'Status update', layout: 'flat', closable: false}).setForm(form).show();
	};
	
	
	this.history=function(context){
		if (context.data.stage_history) {
			var html= AP.render(context.data.stage_history, function(e){
				var user=People.get(e.username);
				return "<div class='item'> <div class='dot' style='background-color:"+(getColor(e.stage))+"'></div> <div class='line' style='background-color:"+(getColor(e.stage))+"'></div> <div class='header'> <div class='stage' style='color: "+(Color.adjust(getColor(e.stage),20,20))+";'>"+(e.stage)+"</div> <div class='date'>"+(AP.i18n.date(e.time))+"</div> <div class='info'><span class='image'><img src='"+(AP.xthumb(user.gavatar))+"'/></span> <span class='url username'>"+(user.name)+"</span></div> </div> <div class='content'>"+(e.note)+"</div> </div>";
			});
			
			return "<div class='items'>"+(html)+"</div>";
		}
		
		return "";
	};
	
	
	this.color=function(stage){
		return getColor(stage);
	};
	
	
	function getColor(stage){
		var key=Project.status.getKey(stage);
		
		if (key=="ontrack"){
			return Color.get("ontrack");
		}
		
		if (key=="offtrack"){
			return Color.get("offtrack");
		}
		
		if (key=="atrisk"){
			return Color.get("atrisk");
		}
		
		if (key=="success"){
			return Color.get("success");
		}
		
		if (key=="failed"){
			return Color.get("error");
		}
		
		if (key=="canceled"){
			return "#a1a1a1";
		}
		
		return "#999999";
	};
	

	
};


Project.webhook=new function __ProjectWebhook(){
	this.init=function(){
		if (!Project.isManager(Client.viewer)){
			return AP.alertError("Only project manager can manage webhooks");
		}
		
		Base.webhook.manage({
			origin: Client.pageData.context,
			events: ["taskCreated", "taskStatusUpdated"],
			multi: 0,
			create: "create/"+Client.pageData.context.incoming_webhook
		});

	};
};


Project.tform=new function __ProjectTForm(){
	this.build=function(options){
		var project=options.project;
		if (!project){
			project=Client.pageData.project;
		}
		
		if (!project){
			return;
		}
		
		if (!project.acl.task_create){
			return "";
		}
		
		var canvas=options.canvas;
		if (!canvas){
			canvas="#js-create-form-"+options.group.id; 
		}
		
		options.cform_id=AP.uuid();
		
		var html=getInlineForm(project, options);
		$(canvas).html(html).addClass("js-tform");
		
		// Bind events
		Form.render(canvas+" form");
		$(canvas).find("textarea[name=name]").autofocus();
		
		
		$(canvas+" .js-add-tags").click(function(){
			$(this).closest(".formbox").find(".frow.js-tags").toggle();
			
			if ($(this).closest(".formbox").find(".frow.js-tags").is(":visible")){
				$(this).closest(".formbox").find(".frow.js-tags").find("input").focus();
			}
		});
		
		$(canvas).find(".frow.js-tags").find("input").scomplete(AP.select(project.tags, function(e){
			return e.name;
		}));
		
		$(canvas+" .js-add-followers").click(function(){
			$(this).closest(".formbox").find(".frow.js-followers").toggle();
			if ($(this).closest(".formbox").find(".frow.js-followers").is(":visible")){
				$(this).closest(".formbox").find(".frow.js-followers").find("input").focus();
			}
		});
		
		if (project.form && project.form.length){
			cForm.attachInline(project.form, "#"+options.cform_id);
			$("#"+options.cform_id).show().prepend("<div class='cform-title url' data-url=':collapse:parent'>Trường dữ liệu tùy chỉnh</div>");
		}
		
		recountFiles(canvas+" .atts");
		
		AP.pickable(canvas+" .js-add-file", {
			name: "file[]",
			callback: function(name, input){
				var $canvas=$(this).closest(".js-tform");
				var fid=AP.uuid();
				var html="<div class='att' id='"+(fid)+"' title='"+(name)+"'> <div class='attname'><div class='ap-xdot'>"+(name)+"</div></div> <span class='remove' onclick='Project.tform.removeInputFile(this)'><span class='-ap icon-close'></span></span> <div class='hidden'></div> </div>";
				
				$(canvas+" .atts").append(html);
				$(input).appendTo("#"+fid+" .hidden");
				recountFiles($canvas.find(".atts"));
			}
		});
		
		
		AP.pickable(canvas+" .js-add-drive", {
			name: "file[]",
			drive: 1,
			multi: 1,
			callback: function(files){
				for (var i=0; i<files.length; i++){
					var fid=AP.uuid();
					var html="<div class='att' id='"+(fid)+"' title='"+(files[i].name)+"'> <div class='attname'><div class='ap-xdot'>"+(files[i].name)+"</div></div> <span class='remove' onclick='Project.tform.removeInputFile(this)'><span class='-ap icon-close'></span></span> <div class='hidden'></div> </div>";
					
					$(canvas+" .atts").append(html);
					$(files[i]._html).appendTo("#"+fid+" .hidden");
					recountFiles($(canvas).find(".atts"));	
				}
			}
		});
		
		
		
		// OTHER EVENTS
		
		$(canvas).each(function(){
			$(this).find(".board-add").click(function(){
				$(this).closest(".board-add-wrap").addClass("active");
				$(this).closest(".board-add-wrap").find("*[name=name]").focus();
			});
			
			var $this=$(this);
			$this.find(".submit").click(function(){
				addInline(this);
			});
			
			$this.find("textarea").enter(function(){
				addInline(this);
			});
			
			$this.find(".cancel").click(function(){
				Project.tform.hide(this);
			});
		});
		
		// Set default
		
		if (options.group){
			if (Board.data.model.metatype=="tasklist"){
				$(canvas).find("*[name=tasklist_id]").val(options.group.id);
			}
			
			if (Board.data.model.metatype=="milestone"){
				$(canvas).find("*[name=milestone_id]").val(options.group.id);
			}
			
			if (Board.data.model.metatype=="user" && options.group.id && parseInt(options.group.id)>0){
				$(canvas).find("*[name=assign]").val("@"+options.group.username);
			}
		}
	};
	
	
	this.reset=function(){
		
	};
	
	
	this.hide=function(ref){
		if ($(ref).closest("#js-tform-dialog").length){
			AP.dialog("#js-tform-dialog").hide();
			return;
		}
		
		$(ref).closest(".board-add-wrap").removeClass("active");
	};
	
	
	this.dialog=function(opts){
		if (Client.pageData.project){
			return this.trueDialog(Client.pageData.project, opts);
		}
		
		Project.pick(function(p){
			Project.tform.trueDialog(p, opts);
		}, "Select a project/team to create task");
	};
	
	
	
	this.trueDialog=function(project, opts){
		var html="<div id='tform-dialog'> <div class='header'> <div class='title'>Tạo công việc mới</div> <div class='close' onclick='Project.tform.hide(this);'><span class='-ap icon-close'></span></div> </div> <div id='js-tform-body' class='tform-body'></div> </div>";
		
		AP.customDialog(html, "#js-tform-dialog")
		.width(600)
		.css({right: $.sbWidth()})
		.closable(false)
		.addClass("-full tform-dialog")
		.show();
		
		this.build({
			project: project,
			canvas: "#js-tform-body",
			dialog: 1
		});
		
		if (opts){
			if (opts.tasklist){
				$("#js-tform-body *[name=tasklist_id]").val(opts.tasklist);
			}
			
			if (opts.user && opts.user!="0"){
				$("#js-tform-body *[name=assign]").val("@"+opts.user);
			}
			
			if (opts.milestone){
				$("#js-tform-body *[name=milestone_id]").val(opts.milestone);
			}
			
			if (opts.group){
				if (Board.data.model.metatype=="tasklist"){
					$("#js-tform-body *[name=tasklist_id]").val(opts.group.id);
				}
				
				if (Board.data.model.metatype=="milestone"){
					$("#js-tform-body *[name=milestone_id]").val(opts.group.id);
				}
				
				if (Board.data.model.metatype=="user"){
					$("#js-tform-body *[name=assign]").val("@"+opts.group.username);
				}
			}
		}
		
		AP.dialog("#js-tform-dialog").balance();
	};
	
	
	this.removeInputFile=function(ref){
		var $box=$(ref).closest(".atts");
		$(ref).closest(".att").remove();
		recountFiles($box);
	};
	
	
	function addInline(ref){		
		UI.ajaxShow();
		Form.submitFrom(ref, function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			// $b.val("").focus();
			
			code.task.visible=1;
			// Board.kb.taskInsert(code.task, {header: header});
			// Project.sync(code.task, "new");
			
			// HOT FIX
			Side.milestone.update(code);
			Project.on.taskCreated(code.task);
			Project.tform.hide(ref);
			
			// AP.xRefresh();
		});
	};
	
	
	
	function getInlineForm(project, options){
		var txt="Tên công việc *";	
		var symbol='';
		var mh=80;
		var compact_level=2;
		
		if (options.dialog){
			symbol='+ ';
			mh=100;
			compact_level=1;
		}
		
		var tasklist='';
		var tasklist_input='';
		
		if (!options.tasklist){
			var list_html=AP.render(options.project.cached_tasklists, function(e){
				if (parseInt(e.id)==0) {
					return "<option value='"+(e.id)+"'>Chưa phân loại</option>";
				} else {
					return "<option value='"+(e.id)+"'>"+(e.name)+"</option>";
				}
			});
			
			tasklist="<div class='frow'> <span class='icon'><span class='-ap icon-uniF11B'></span></span> <div class='relative'> <select name='tasklist_id'>"+(list_html)+"</select> </div> </div>";
		}else{
			tasklist_input="<input type='hidden' name='tasklist_id' value='"+(options.tasklist.id)+"'/>";
		}
		
		var deadline="<div class='input clear-fix'> <div class='w left'> <input type='text' name='deadline-date' placeholder='Deadline' data-role='date'/> </div> <div class='w right'> <input type='text' name='deadline-time' placeholder='Time' data-role='time'/> </div> </div>";
		
		if (!parseInt(project.deadline_has_time)){
			deadline="<div class='input'> <input type='text' name='deadline' placeholder='Deadline' data-role='date'/> </div>";
		}
		
		var milestone_ip="<input type='hidden' name=milestone_id' value='0'/>";
		if (Client.pageData.milestones && Client.pageData.milestones.length && Client.pageData.project){
			var milestone_opts=AP.render(Client.pageData.milestones, function(e){
				if (!e.id || !parseInt(e.id)){
					return;
				}
				
				return "<option value='"+(e.id)+"'>Mục tiêu "+(AP.i18n.datetime(e.time))+" - "+(e.name)+"</option>";
			});
			
			milestone_ip="<div class='frow'> <span class='icon'><span class='-ap icon-uniF10E'></span></span> <div class='input'> <select name='milestone_id'> <option value='0'>Chọn mục tiêu</option> "+(milestone_opts)+" </select> </div> </div>";
		}
		
		return "<div class='board-add-wrap'> <div class='board-add'><span class='-ap icon-plus2'></span> Thêm công việc</div> <div class='inline-form'> <form method='POST' action='api/task/add'> <div class='formbox'> <input type='hidden' name='id' value='"+(options.project.id)+"'/> <input type='hidden' name='deadline_fulltime' value='"+(project.deadline_has_time)+"'/> "+(tasklist_input)+" <textarea name='name' placeholder='"+(txt)+"' class='-big'></textarea> <div class='sep'></div> <div class='relative'> <textarea name='content' placeholder='Miêu tả công việc' data-role='editor' data-dir='bottom' data-compact='"+(compact_level)+"' data-minheight='"+(mh)+"'></textarea> </div> <div class='cform hidden' id='"+(options.cform_id)+"'></div> <div class='frows'> <div class='frow'> <span class='icon'><span class='-ap icon-uniF13B'></span></span> <div class='input'> <input type='text' name='assign' placeholder='Tag @ to assign' data-role='tag'/> </div> </div> "+(tasklist)+" <div class='frow'> <span class='icon'><span class='-ap icon-uniF1072'></span></span> "+(deadline)+" </div> "+(milestone_ip)+" <div class='frow hidden js-tags'> <span class='icon'><span class='-ap icon-tag2'></span></span> <div class='input'> <input type='text' name='tags' placeholder='Danh sách nhãn'/> </div> </div> <div class='frow hidden js-followers'> <span class='icon'><span class='-ap icon-uniF106'></span></span> <div class='input'> <input type='text' name='followers' placeholder='Người theo dõi' data-role='tag'/> </div> </div> </div> <div class='atts'></div> <div class='sep'></div> <div class='more'> <div class='more-link'> <span class='inline ap-f13' style='vertical-align:2px'>+</span>&nbsp; <span class='action js-add-file'>"+(symbol)+"attachment</span> <span class='inline'>&middot;</span> <span class='action js-add-drive'>"+(symbol)+"drive</span> <span class='inline'>&middot;</span> <span class='action js-add-tags'>"+(symbol)+"tags</span> <span class='inline'>&middot;</span> <span class='action js-add-followers'>"+(symbol)+"followers</span> </div> <div class='more-contents'></div> </div> </div> <div class='buttons'> <div class='submit'>Thêm công việc</div> <div class='cancel'><span class='-ap icon-close'></span></div> </div> </form> </div> </div>";
	};
	
	
	function recountFiles(selector){
		var total=$(selector).find(".att").length;
		if (total==0){
			$(selector).hide();
		}else{
			$(selector).show();
		}
	};
};



 

Project.form=new function __ProjectForm(){
	this.create=function(){
		var data={metatype: "project"};
		
		var form=Form.create('fly-workflow-fx',{'action': "api/project/create"})
		.row(
			Form.label({label: "Tên dự án"}),
			Form.input({name: 'name', "placeholder":"Tên dự án"})
		).addClass("-big")
		.row(
			Form.label({label: "Thành viên quản trị dự án"}),
			Form.input({name: 'owners', "placeholder":"Sử dụng @ để tag người quản trị"}).value("@"+Client.viewer.username+" ")
		).addClass("-big")
		.row(
			Form.label({label: "Thành viên thực hiện dự án"}),
			Form.input({name: 'followers', "placeholder":"Thành viên làm việc trong dự án, sử dụng @ để tag thành viên"})
		).addClass("-big")
		.rowHidden(
			Form.label({label: "Thêm nhanh thành viên theo teams"}),
			Form.input({name: 'teams', "placeholder":"Type to select all members and teams", role: "teams"})
		).addClass("-big")
		.plain("<span class='a' id='js-form-add-teams'>Or add members by teams ... </span>")
		.row(
			Form.label({label: "Deparment"}),
			Form.input({name: 'dept_id', "placeholder":"Department", type:"select", empty: {label: "Not specified", value:0}, options: Form.convert(Client.depts)})
		)
		.row(
			Form.label({label: "Phân loại dự án"}),
			Form.input({name:"external", type:"list", options:[{"label":"Dự án nội bộ", sublabel:"Dự án nội bộ công ty", value: "0"}, {"label":"Dự án làm việc với khách hàng", sublabel: "Bạn có thể thêm tài khoản khách hàng vào dự án", value: "1"}]}).value(0)
		).addClass("-active")
		.row(
			Form.label({label: "Project template"}),
			Form.input({name:"template_id", type:"select", options: Project.template.options()}).value(0)
		).addClass("-active")
		.wrap("Tùy chọn nâng cao","#advopts")
		.row(
			Form.label({label: "Ngày bắt đầu"}),
			Form.input({name: 'stime', "placeholder":"Chọn ngày bắt đầu", role:"date"})
		)
		.row(
			Form.label({label: "Ngày kết thúc"}),
			Form.input({name: 'etime', "placeholder":"Chọn ngày kết thúc", role:"date"})
		)
		.row(
			Form.label({label: "Trạng thái hiện tại"}),
			Form.input({name: 'stage', type:"select", options:Project.status.statuses})
		)
		.row(
			Form.label({label: "Mô tả dự án",}),
			Form.input({name: 'content', "placeholder":"Mô tả ngắn gọn về dự án", type:"textarea"})
		)
		.row(
			Form.label({label: "Màu đặc trưng"}),
			Form.input({name: 'color', "placeholder":"Lựa chọn màu", type:"colors"})
		).addClass("-active")
		.wrap()
		.rowHTML("<span class='link'>+ Thêm lựa chọn nâng cao</span>")
		.buttons([
			 {label: "Tạo dự án mới", action: function(){
				 Form.submit("#fly-workflow-fx", function(code){
					 if (!code.good()){
						 return AP.alertError(code.message);
					 }
					 
					 AP.redirect(code.project.path);
				 })
			 }, style: 'ok -success -rounded bold'},
			 {label: "Huỷ", action: function(){
				 Form.hide("fly-workflow-fx");
			 }, style:'cancel -passive-2 -rounded'}
		])
		.hiddens(data)
		.render(function(form){
			form.selector(".link").click(function(){
				$("#advopts").toggle();
			})
			
			$("#js-form-add-teams").click(function(){
				form.findRow("teams").show();
				form.find("teams").focus();
				$(this).parent().hide();
			});
		});

		Form.pop({width: 480, label: 'Tạo dự án mới', layout: 'flat', closable : false}).setForm(form).show().focus('name');
		Tag.user(form.find("owners"), Client.people);
		Tag.user(form.find("followers"), Client.people);
	};


	this.duplicate=function(id, name){
		var data={metatype: "project"};
		var hiddens={id: id};
		var form=Form.create('fly-workflow-fx',{'action': "api/project/duplicate"})
			.row(
				Form.label({label: "Tên dự án"}),
				Form.input({name: 'name', "placeholder":"Tên dự án"}).value('Bản sao của ' + name).autoSubmit()
			).addClass("-big")
			.row(
				Form.label({label: "Nhân bản công việc"}),
				Form.input({name: 'keep_tasks', type:"select", options:[{value:2, label:"Nhân bản tất cả công việc và nhóm công việc"}, {value:1, label:"Nhân bản nhóm công việc"}, {value:0, label:"Không nhân bản công việc và nhóm công việc"}]})
			).addClass("-big")
			.row(
				Form.label({label: "Giữ lại thông tin người giao"}),
				Form.input({name: 'keep_assigner', type:"select", options:[{value:1, label:"Có, giữ nguyên thông tin người giao việc"}, {value:0, label:"Không, thiết lập TÔI là người giao việc"}]})
			)
			.row(
				Form.label({label: "Giữ lại thông tin người nhận"}),
				Form.input({name: 'keep_assignee', type:"select", options:[{value:1, label:"Có, giữ nguyên thông tin người nhận việc"}, {value:0, label:"Không, bỏ trống thông tin người nhận việc"}]})
			)
			.row(
				Form.label({label: "Giữ lại thông tin người theo dõi"}),
				Form.input({name: 'keep_followers', type:"select", options:[{value:1, label:"Có, giữ lại tất cả người theo dõi công việc"}, {value:0, label:"Không, bỏ trống thông tin người theo dõi"}]})
			)
			.row(
				Form.label({label: "Giữ lại thông tin hạn hoàn thành"}),
				Form.input({name: 'keep_deadline', type:"select", options:[{value:1, label:"Có, giữ nguyên thông tin hạn hoàn thành"}, {value:2, label:"Có, giữ lại và thay đổi thông tin hạn hoàn thành"}, {value:0, label:"Không, không thiết lập hạn hoàn thành cho công việc"}]}).value(0)
			)
			.rowHidden(
				Form.label({label: "Điều chỉnh hạn hoàn thành (theo giờ)"}),
				Form.input({name: 'adjust_hours', type:"text", "placeholder": "Điền số giờ điều chỉnh - hạn hoàn thành mới bằng hạn hoàn thành cũ cộng thêm giờ điều chỉnh"})
			)
			.row(
				Form.label({label: "Giữ lại trường dữ liệu tùy chỉnh"}),
				Form.input({name: 'keep_form', type:"select", options:[{value:1, label:"Có, giữ lại trường dữ liệu tùy chỉnh"}, {value:0, label:"Không, xóa hết trường dữ liệu tùy chỉnh"}]})
			)
			.row(
				Form.label({label: "Giữ lại checklists"}),
				Form.input({name: 'keep_checklists', type:"select", options:[{value:1, label:"Có, giữ lại checklists"}, {value:0, label:"Không, xóa hết checklist"}]}).value(0)
			)
			.row(
				Form.label({label: "Giữ lại công việc con"}),
				Form.input({name: 'keep_subtasks', type:"select", options:[{value:1, label:"Có, giữ lại các công việc con đi kèm"}, {value:0, label:"Không, xóa các công việc con"}]}).value(0)
			)
			.hiddens(hiddens)
			.row(
				Form.label({label: "Bao gồm"}),
				Form.input({name: 'options', type:"checkboxes",
					options:[
						{label:"Người quản trị", value: 'owners'},
						{label:"Thành viên dự án", value: 'followers'},
						{label:"Phân quyền sử dụng", value: 'acl'},
						{label:"Tags", value: 'tags'}]}
				).value(["owners","followers", "acl","tags"])
			)
			.buttons([
				{label: "Nhân bản dự án", action: function(){
					Form.submit("#fly-workflow-fx", function(code){
						if (!code.good()){
							return AP.alertError(code.message);
						}

						AP.redirect(code.project.path);
					})
				}, style: 'ok -success -rounded bold'},
				{label: "Huỷ", action: function(){
					Form.hide("fly-workflow-fx");
				}, style:'cancel -passive-2 -rounded'}
			])
			.hiddens(data)
			.render(function(form){
				form.find("keep_tasks").on("change", function(){
					var v=$(this).val();
					if (parseInt(v)==2 || parseInt(v)==2){
						form.findRow("keep_assigner").show();
						form.findRow("keep_assignee").show();
						form.findRow("keep_followers").show();
						form.findRow("keep_deadline").show();
						form.findRow("keep_subtasks").show();
						form.findRow("keep_form").show();
						form.findRow("keep_checklists").show();
					}else{
						form.findRow("keep_assigner").hide();
						form.findRow("keep_assignee").hide();
						form.findRow("keep_followers").hide();
						form.findRow("keep_subtasks").hide();
						form.findRow("keep_deadline").hide();
						form.findRow("keep_form").hide();
						form.findRow("keep_checklists").hide();
					}
				}).change();
				
				form.selector(".link").click(function(){
					$("#advopts").toggle();
				})
				
				form.find("keep_deadline").on("change", function(){
					var v=$(this).val();
					if (parseInt(v)==2){
						form.findRow("adjust_hours").show();
					}else{
						form.findRow("adjust_hours").hide();
					}
				}).change();
			});

		Form.pop({width: 480, label: 'Nhân bản dự án', layout: 'flat', closable : false}).setForm(form).show().focus('name');

	};

	this.download=function(project){
		var data={metatype: "project"};
		var fields = project.form;
		var options = [];

		for (var i = 0, len = fields.length; i < len; i++) {
			var item = new Object();
			item.label = fields[i].name;
			item.value = fields[i].id;
			options[i] = item;
		}

		var hiddens={id: project.id};
		var form=Form.create('fly-workflow-fx',{'action': "api/task/export"})
			.hiddens(hiddens)
			.row(
				Form.label({label: "Từ ngày"}),
				Form.input({name: 'start_time', type:"text", role: "date", placeholder: "Ngày bắt đầu mặc định là ngày tạo dự án"}).value(project.since)
			)
			.row(
				Form.label({label: "Tới ngày"}),
				Form.input({name: 'end_time', type:"text", role: "date", placeholder: "Ngày kết thúc mặc định là hôm nay"}).value(AP.time.now())
			)
			.row(
				Form.label({label: 'Trích xuất công việc con?'}),
				Form.input({name: 'subtask', type:"list",
					options: [
						{label:"Yes", value:'1'},
						{label:"No", value:'0'},
				]}).value(1)
			)
			.row(
				Form.label({label: 'Căn cứ theo'}),
				Form.input({name: 'type', type:"list",
					options: [
						{label:"Ngày tạo", value:'created_time'},
						{label:"Deadline", value:'deadline'}]	
				}).value("created_time")
			);

		if (options.length > 0) {
			form.row(
				Form.label({label: 'Thêm custom fields'}),
				Form.input({name: 'duplicate_field', type:"checkboxes",
					options:options
				})
			)
		}

		form.buttons([
				{label: "Export", action: function(){
					var ps=$("#fly-workflow-fx").serializeArray();
					var fields="";
					ps=AP.array.filter(ps, function(e){
						if (e.name=="duplicate_field[]"){
							fields+=e.value+",";
						}
						
						return e.name!="__code" && e.name!="metatype" && e.name!="duplicate_field[]";
					});
					
					ps=$.param(assoc(ps));
					ps+="&fields="+fields+"&export=1";
					
					var url=Client.url+"/"+Client.pageData.context.path+"/tool/export?"+ps;
					window.open(url);
					
					return;
				}, style: 'ok -success -rounded bold'},
				{label: "Huỷ", action: function(){
					Form.hide("fly-workflow-fx");
				}, style:'cancel -passive-2 -rounded'}
			])
			.hiddens(data)
			.render(function(form){
				form.selector(".link").click(function(){
					$("#advopts").toggle();
				})
			});

		Form.pop({width: 480, label: 'Trích xuất công việc', layout: 'flat'}).setForm(form).show().focus('name');

	};
	
	
	this.edit=function(project){
		if (!project){
			return;
		}
		
		var icon=parseInt(project.icon);
		if (!icon){
			icon=true;
		}
		
		var data={id: project.id, hid: project.hid, token: project.token};
		
		var form=Form.create('fly-workflow-fx',{'action': "api/project/edit"})
		.row(
			Form.label({label: "Tên dự án/team",sublabel: ""}),
			Form.input({name: 'name', "placeholder":"Tên dự án/team", icon_picker: icon}).value(project.name)
		)
		.row(
			Form.label({label: "Department"}),
			Form.input({name: 'dept_id', "placeholder":"Phân nhóm dự án (có thể để trống)", type:"select", empty: {label: "Not specified", value:0}, options: Form.convert(Client.depts)}).value(project.dept_id)
		)
		.row(
			Form.label({label: "Người quản trị",sublabel: ""}),
			Form.input({name: 'owners', type:"text", role: "tag"}).value(UI.objectsToUsernames(project.owners))
		)
		.rowHidden(
			Form.label({label: "Thành viên tham gia",sublabel: ""}),
			Form.input({name: 'followers', type:"text", "role": "tag"}).value(UI.objectsToUsernames(project.followers))
		)
		.row(
			Form.label({label: "Ngày bắt đầu và kết thúc",sublabel: ""}),
			Form.inputGroup([
				Form.input({name: 'stime', "placeholder":"Chọn ngày bắt đầu", role:"date"}).valueIf(project.stime, project.stime),
				Form.input({name: 'etime', "placeholder":"Chọn ngày kết thúc", role:"date"}).valueIf(project.etime, project.etime)
			])
		)
		.row(
			Form.label({label: "Mô tả dự án/team",sublabel: ""}),
			Form.input({name: 'content', "placeholder":"Mô tả ngắn gọn về dự án", type:"textarea"}).value(project.content)
		)
		.buttons([
			 {label: "Save", action: function(){
				 Form.submit("#fly-workflow-fx", function(code){
					 if (!code.good()){
						 return AP.alertError(code.message);
					 }
					 
					 UI.flash("Update successfully");
					 AP.refresh();
				 })
			 }, style: 'ok -success -rounded bold'},
			 {label: "Huỷ", action: function(){
				 Form.hide("fly-workflow-fx");
			 }, style:'cancel -passive-2 -rounded'}
		])
		.hiddens(data)
		.render(function(form){
		});
	
		Form.pop({width: 480, label: 'Edit: '+project.name, layout: 'flat'}).setForm(form).show().focus('name');
	
	};
	
	
		
	this.removeItem=function(item){
		AP.confirm("Bạn có chắc muốn xoá công việc <b>"+item.name+"</b>? Công việc đã xoá sẽ không thể khôi phục.", function(){
			AP.post("api/project/item/remove", {hid: Client.pageData.project.hid, token: Client.pageData.project.token, key: item.key}, function(code){
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				$.log("Công việc đã được xóa");
			});
		});
	};
	
	
	this.tick=function(ref){
		var item=$(ref).closest(".node").data("object");
		AP.post("api/project/item/tick", {hid: Client.pageData.project.hid, token: Client.pageData.project.token, key: item.key}, function(code){
			if (!code.good()){
				return AP.alertError(code.message);
			}
		});
	};
};





Project.on=new function __ProjectEventCallback(){
	this.taskCreated=function(task){
		// c.visible=Board.filter.getVisible(c);

		if (Client.pageData.project){
			var c=Board.data.insert(task);
			
			if (Client.pageData.task_view=="stream"){
				Team.stream.rebuild();
			}else if (Client.pageData.task_view=="period"){
				Team.period.rebuild();
			}else{
				Board.display();	
			}
			
			// Calendar.taskCreated(c);
			return;
		}else{
			var c=Board.data.insert(task);
			List.onCreate(c);
		}
	};	
	
	
	this.taskUpdated=function(task, comment){
		if (requireReset(task)){
			Board.data.update(task);
			Board.reset();
			return;
		}
		
		if (!Client.pageData.tasks){
			TaskDisplay.taskUpdated(task);
			Calendar.taskUpdated(task);
			return;
		}
		
		hotfixInlineStatus(task);
		
		var update=Board.data.update(task);
		if (!update){
			return;
		}
		
		Board.list.taskUpdated(update);
		Board.table.taskUpdated(update);
		Board.kb.taskUpdated(update);
		TaskDisplay.taskUpdated(update);
		// Calendar.taskUpdated(update);
		
		if (Client.tempData && Client.tempData.task && Client.tempData.task.id==task.id){
			$("#tasklists .js-task").setActive("#task-"+task.id);
			
			if (comment){
				Task.inline.insertComment(comment, task);
			}
		}

		Task.ie.close();
	};
	
	this.taskDeleted=function(task_id){
		// if (tasklist) {
			// $("#tasklist-"+tasklist.id+" .name .istats").html("  —  " + tasklist.stats.done+"/" + tasklist.stats.total_display + " hoàn thành");
		// }
		
		Client.pageData.tasks=AP.array.removeByID(Client.pageData.tasks, task_id);
		
		if (Client.pageData.subtasks){
			Client.pageData.subtasks=AP.array.removeByID(Client.pageData.subtasks, task_id);
		}
		
		Board.reset();
	};
	
	
	function requireReset(task){
		if (task.metatype=="subtask" || !Client.pageData.project){
			return;
		}
		
		var old=Board.data.getTask(task);
		if (!old){
			return;
		}
		
		if (Board.data.model.metatype=="tasklist"){
			if (parseInt(old.tasklist_id)!=parseInt(task.tasklist_id)){
				return true;
			}
		}
		
		if (Board.data.model.metatype=="miletone"){
			if (parseInt(old.milestone_id)!=parseInt(task.milestone_id)){
				return true;
			}
		}
		
		if (Board.data.model.metatype=="user"){
			if (parseInt(old.user_id)!=parseInt(task.user_id)){
				return true;
			}
		}
	};
	
	
	function hotfixInlineStatus(task){
		if ($(".sublist #task-"+task.id).length){
			Board.sublist.update(task);
		}
		
		if ($(".js-inline-subtask-"+task.id).length){
			var html=Base.task.exportHTML(task);
			$(".js-inline-subtask-"+task.id).replaceWith(html);
		}
	};
};



/**
 * @desc Init infinite rendering list of tasks
 */

var List=new function __BaseInfList(){
	this.init=function(opts){
		opts=$.extend({show_more: true}, opts);
		
		if (Client.pageData.task_view){
			Query.set("view", Client.pageData.task_view);	
		}
		
		Project.subheader.init();	
		List.opts=opts;
		
		
		var label="Recent tasks";
		if (Query.get("order")=="deadline"){
			label="Tasks sorted by deadline";	
		}else if (Query.get("order")=="created"){
			label="Recently created";	
		}
		
		var ord='';
		var real_order='';
		if (Query.get("order")){
			ord='&order='+Query.get('order');
			real_order=Query.get('order');
		}
		
		AP.pageConfig.set("team_order", real_order);
		
		var view_subtasks=1;
		if (Query.get("subtask")=="hide"){
			view_subtasks=-1;
		}
		
		AP.pageConfig.set("team_subtasks", view_subtasks);
		
		
		var more="<div class='load-more' onclick='List.more();'>Load more tasks</div>";
		if (!opts.show_more){
			more='';
		}
		
		var title="<div class='group-header'> <div class='title'> <div class='collapse'> <span class='ficon-caret-right'></span> </div> <div class='name'><span class='url' data-xurl='home?view=list"+(ord)+"'>"+(label)+"</span></div> </div> <div class='right' style='max-width:none' id='js-stream-filters'></div> </div>";
		
		if (!Client.pageData.project){
			title='';
		}
		
		$("#tasklists").after("<div id='js-list-marker'></div>");
		
		$(opts.canvas).html("<div class='tasklist'> "+(title)+"<div class='tasks js-list-tasks'></div>"+(more)+" </div>");
		
		this.page=1;
		for (var i=0; i< Client.pageData.tasks.length; i++){
			appendTask(Client.pageData.tasks[i]);
		}
	};
	
	
	/**
	 * @desc Fully rebuild the list
	 */
	this.rebuild=function(){
		$("#tasklists .tasks").empty();
		Client.pageData.tasks.sort(Board.filter.streamSort);
		
		for (var i=0; i< Client.pageData.tasks.length; i++){
			appendTask(Client.pageData.tasks[i]);
		}
	};
	
	this.onCreate=function(task){
		if (task.metatype=="task"){
			this.rebuild();	
		}else{
			var pid=task.parent_id;
			if ($(".js-subtasks-p"+(pid)+"").length){
				$(".js-subtasks-p"+(pid)+"").prepend(List.ui.getHTML(task));
			}
		}
	};
	
	
	this.more=function(){
		this.page++;
		
		var params=Query.release();
		params.page=this.page;
		params.project_id=Client.pageData.project.id;
		
		UI.ajaxShow();
		AP.post("api/project/more.tasks", params, function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			for (var i=0; i<code.tasks.length; i++){
				Client.pageData.tasks.push(code.tasks[i]);	
			}
			
			Client.pageData.tasks=AP.array.uniqueObjects(Client.pageData.tasks);
			
			appendTasks(code.tasks);
		});
	};
	
	
	/**
	 * @desc Append a single task
	 */
	function appendTask(task){
		if ($("#tasklists #task-"+(task.id)+"").length){
			return;
		}
		
		appendSeperator(task);
		
		var html=List.ui.getHTML(task,{team_view: 1});
		$("#tasklists .tasks").append(html);
	};
	
	
	function appendSeperator(task){
		var opts=List.opts;
		var id='';
		var title='';
		
		var ord=Query.get("order");
		var ts=task.last_update;
		
		if (ord=="created"){
			ts=task.since;
		}
		
		if (ord=="deadline"){
			ts=task.deadline;
		}
		
		if (opts.period=="monthly"){
			id=AP.time.beginOfMonth(ts);
			title='Tháng '+AP.time.time("%m/%Y", ts);
		}else{
			id=AP.time.beginOfWeek(ts);
			title='Tuần '+AP.i18n.dateRange(AP.time.beginOfWeek(ts), AP.time.endOfWeek(ts));
		}
		
		if ($("#tasklists").find(".sep-"+id).length){
			return;
		}
		
		$("#tasklists .tasks").append("<div class='list-sep sep-"+(id)+"'>"+(title)+"</div>");
	};
	
	
	/**
	 * @desc Append a task to the list
	 */
	function appendTasks(tasks){
		for (var i=0; i<tasks.length; i++){
			appendTask(tasks[i]);
		}
	};
	
	

	
	
	// STANDARD SUBTASKS
	this.std_subtask_views="<div class='autohide dd -cmenuw js-auto-filter' data-filter='subtask' data-df='View subtasks'> <div class='label js-current-filter'>View subtasks</div> <div class='-cmenu -padding -no-icon'> <div class='-item url' data-urlparam='subtask' data-value=''>View subtasks</div> <div class='-item url' data-urlparam='subtask' data-value='hide'>Hide subtasks</div> </div> </div>";
	
};






Project.manage = new function __ProjectManage(){
	
	this.fix=function(key, value, callback){
		UI.ajaxShow();
		AP.post("api/project/fix", {id: Client.pageData.context.id, key: key, value: value}, function(code){
			UI.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			Client.pageData.context=code.project;
			Client.pageData.project=code.project;
			
			if (callback){
				callback(code);
			}
		});
	};
	
	
	
	this.fixTime=function(callback){
		var data = {id: Client.pageData.context.id};
		
		var form = Form.create('fly-proj-addmember-fx',{'action': Client.pageData.context.path+"/api/settings/edit.period"})
		.row(
			Form.label({label: "Ngày bắt đầu"}),
			Form.input({name: 'stime', "placeholder":"Ngày bắt đầu", role:"date"}).value(Client.pageData.context.stime)
		)
		.row(
			Form.label({label: "Ngày kết thúc"}),
			Form.input({name: 'etime', "placeholder":"Ngày bắt đầu", role:"date"}).value(Client.pageData.context.etime)
		)
		.buttons([
			 {label: "Cập nhật", action: function(){
				 Form.submit("#fly-proj-addmember-fx", function(code){
					 if (!code.good()){
						 return AP.alertError(code.message);
					 }
					 
					 Form.hide("fly-proj-addmember-fx");
					 UI.flash("Update successfully ...");
					 
					 if (callback){
						 callback(code.project);
					 }else{
						 AP.xRefresh(); 
					 }
				 })
			 }, style: 'ok -success -rounded bold'},
			 {label: "Bỏ qua", action: function(){
				 Form.hide("fly-proj-addmember-fx");
			 }, style:'cancel -passive-2 -rounded'}
		]).hiddens(data);
		
		Form.pop({width: 420, label: 'Sửa thời gian thực hiện dự án', layout: 'flat'}).setForm(form).show();
	};
	
	
	this.addPeople = function() {
		var data = {hid: Client.pageData.project.hid};
		
		var form = Form.create('fly-proj-addmember-fx',{'action': "api/project/add.followers"})
		.row(
			Form.label({label: "&nbsp;"}),
			Form.input({name: 'followers', "placeholder":"Sử dụng @ để tag thành viên", role:"tag"})
		)
		.buttons([
			 {label: "Thêm thành viên", action: function(){
				 Form.submit("#fly-proj-addmember-fx", function(code){
					 if (!code.good()){
						 return AP.alertError(code.message);
					 }
					 
					 Form.hide("fly-proj-addmember-fx");
					 
					 UI.flash("Đã thêm thành viên...");
					 
					 AP.xRefresh();
				 })
			 }, style: 'ok -success -rounded bold'},
			 {label: "Hủy", action: function(){
				 Form.hide("fly-proj-addmember-fx");
			 }, style:'cancel -passive-2 -rounded'}
		]).hiddens(data);
		
		Form.pop({width: 420, label: 'Thêm thành viên vào dự án', layout: 'flat'}).setForm(form).show().focus('followers');
	};
	
	
	this.memberOptions = function(ref) {
		var namediv = $(".name", $(ref).parent());
		var username = $(namediv).find(".username").data("username");
		var is_owner = $(ref).hasClass("owner");

		var actions = [];
		
		if(is_owner) {
			if(username != Client.viewer.username) {
				actions.push({label: "Bỏ quyền quản trị dự án của @<b>" + username +"</b>", sublabel: "", icon: "icon-star-empty", action: function() {
					Project.manage.removeOwner(username);
				}});
			}
		} else {
			actions.push({label: "Thêm quyền quản trị dự án cho @<b>" + username +"</b>", sublabel: "", icon: "icon-star", action: function() {
				Project.manage.addOwner(username);
			}});
		}
		
		return Context.menu(ref, {top: 30, left: -250, menu: [
			
		].concat(actions)});
	};
	
	
	this.addOwner = function(username) {
		AP.confirm("Bạn có chắc muốn trao quyền quản trị dự án này cho thành viên @<b>" + username + "</b>?", function() {
			AP.ajaxShow();
			var data = {username: username, project_hid: Client.pageData.project.hid, role: "admin"};
			
			AP.post("api/project/owner/set", data, function(code) {
				AP.ajaxHide();
				
				if(!code.good()) {
					return AP.alertError(code.message);
				}
				
				UI.flash("Đã lưu thay đổi");
				AP.xRefresh();
			});
		});
	};
	
	
	this.removeOwner = function(username) {
		Context.close();
		AP.confirm("Bạn có chắc muốn bỏ quyền quản trị dự án này của thành viên @<b>" + username + "</b>?", function() {
			AP.ajaxShow();
			var data = {username: username, project_hid: Client.pageData.project.hid, role: "member"};
			
			AP.post("api/project/owner/set", data, function(code) {
				AP.ajaxHide();
				
				if(!code.good()) {
					return AP.alertError(code.message);
				}
				
				UI.flash("Đã lưu thay đổi");
				AP.xRefresh();
			});
		});
	};
	
	this.addGuest = function() {
		if (Client.pageData.context.metatype!="project"){
			return;
		}
		
		Guest.addAccount(Client.pageData.context, "wework");
		
	};
	
	this.markComplete = function(project) {
		AP.confirm("Bạn có chắc muốn đánh dấu hoàn thành dự án này? Dự án ở trạng thái hoàn thành chỉ có thể xem, không thể tạo thêm dữ liệu hay tương tác.", function() {
			AP.ajaxShow();
			var data = {id: project.id, token: project.token};
			
			AP.post("api/project/finish", data, function(code) {
				AP.ajaxHide();
				
				if(!code.good()) {
					return AP.alertError(code.message);
				}
				
				AP.hideAlert();
				UI.flash("Đã đánh dấu hoàn thành dự án");
				AP.sys.fire("project.finish", code.project);
			});	
		});
	};
	
	
	
	/**
	 * @desc Close a project
	 */
	this.closeProject = function(project){
		var data = {id: project.id, token: project.token};
		
		var form = Form.create('fly-proj-addmember-fx',{'action': "api/project/close"})
		.warning("If you close this project/team, no new task could be added")
		.row(
			Form.label({label: "Project/team name",sublabel: ""}),
			Form.input({name: 'name_fake', type:"fake"}).value(project.name)
		)
		.row(
			Form.label({label: "Closed status",sublabel: "Update status"}),
			Form.input({name: 'stage', type:"select", options:Project.status.closed_statuses})
		)
		.row(
			Form.label({label: "Stop task reminders",sublabel: "Note: If stopped, reminders will be stopped forever"}),
			Form.input({name: 'reminder_stop', type:"select", options:["yes", "no"]}).value("no")
		)
		.row(
			Form.label({label: "Update message",sublabel: "Short explain about your action"}),
			Form.input({name: 'note', type:"textarea", placeholder:"Short message about the update"})
		)
		.buttons([
			 {label: "Cập nhật", action: function(){
				 Form.submit("#fly-proj-addmember-fx", function(code){
					 if (!code.good()){
						 return AP.alertError(code.message);
					 }
					 
					 Form.hide("fly-proj-addmember-fx");
					 
					 UI.flash("Update successfully");
					 
					 AP.xRefresh();
				 })
			 }, style: 'ok -success -rounded bold'},
			 {label: "Bỏ qua", action: function(){
				 Form.hide("fly-proj-addmember-fx");
			 }, style:'cancel -passive-2 -rounded'}
		]).hiddens(data);
		
		Form.pop({width: 520, label: 'Close project/team'}).setForm(form).show();
		return;
		
	};
	
	
	
	this.reopenProject = function(project) {
		var data = {id: project.id, token: project.token};
		
		var form = Form.create('fly-proj-addmember-fx',{'action': "api/project/reopen"})
		.row(
			Form.label({label: "Project/team name",sublabel: ""}),
			Form.input({name: 'name_fake', type:"fake"}).value(project.name)
		)
		.row(
			Form.label({label: "Open status",sublabel: "Update status"}),
			Form.input({name: 'stage', type:"select", options:Project.status.statuses}).value("ontrack")
		)
		.row(
			Form.label({label: "Restart task reminders",sublabel: "Decide whether to force restarting task reminders"}),
			Form.input({name: 'reminder_start', type:"select", options:["yes", "no"]}).value("no")
		)
		.row(
			Form.label({label: "Update message",sublabel: "Short explain about your action"}),
			Form.input({name: 'note', type:"textarea", placeholder:"Short message about the update"})
		)
		.buttons([
			 {label: "Cập nhật", action: function(){
				 Form.submit("#fly-proj-addmember-fx", function(code){
					 if (!code.good()){
						 return AP.alertError(code.message);
					 }
					 
					 Form.hide("fly-proj-addmember-fx");
					 UI.flash("Update successfully");
					 
					 AP.xRefresh();
				 })
			 }, style: 'ok -success -rounded bold'},
			 {label: "Bỏ qua", action: function(){
				 Form.hide("fly-proj-addmember-fx");
			 }, style:'cancel -passive-2 -rounded'}
		]).hiddens(data);
		
		Form.pop({width: 520, label: 'Open project/team'}).setForm(form).show();
		return;
	};
	
	
	this.removeProject = function(project) {
		AP.confirmDelete("Bạn có chắc muốn xoá dự án này? Các công việc/nhóm công việc liên quan cũng sẽ bị xoá và KHÔNG THỂ khôi phục.", function() {
			AP.ajaxShow();
			var data = {id: project.id, token: project.token};
			
			AP.post("api/project/remove", data, function(code) {
				AP.ajaxHide();
				
				if(!code.good()) {
					return AP.alertError(code.message);
				}
				
				AP.hideAlert();
				UI.flash("Đã xoá dự án");
				AP.redirect("home");
			});
		});
	};


	this.changeMetatype = function(project) {
		AP.confirm("Bạn có muốn chuyển loại dự án/phòng ban này không?", function(){
            UI.ajaxShow();
            AP.post("api/project/change.metatype",{id : project.id}, function(code){
                UI.ajaxHide();
                if (!code.good()){
                    return AP.alertError(code.message);
                }

                AP.hideAlert();
                UI.flash("Update successfully");
                if (Client.pageData.context){
	                AP.redirect(Client.pageData.context.path);
	            } else {
					AP.redirect("home");
				}
            });
        });
	};


	this.duplicateProject = function(project) {
		return Project.form.duplicate(project.id, project.name);
	};

	this.download = function(project) {
		return Project.form.download(project);
	}

	this.downloadCustomFields = function(project) {
		AP.confirm("Bạn có chắc mình muốn xuất trường dữ liệu tùy chỉnh của dự án này?", function(code){
			window.open(Client.url + "/" + project.path + "/tool/export/custom.fields", '_blank');
		});
	}
};


var Compute = new function __Compute() {
	this.percent = function (project) {
		var stats = project.stats;

		var percent = 0;
		if (parseInt(stats.total)) {
			percent = (parseInt(stats.complete) * 100.0 / stats.total).toFixed(1);
		}

		return percent;
	};

	this.color = function (context) {
		context.percent = this.percent(context);
		var color = UI.color.percent(context.percent);
		if (parseInt(context.stime) && parseInt(context.etime)) {
			color = UI.color.progress(context);
		}
		return color;
	};

	this.doneLate = function (task) {
		if (!parseInt(task.deadline) || !parseInt(task.status) || !parseInt(task.completed_time)) {
			return false;
		}

		return parseInt(task.completed_time) > parseInt(task.deadline);
	};
	
	
	this.doneLateAgainst = function (task, deadline) {
		if (!parseInt(deadline) || !parseInt(task.status) || !parseInt(task.completed_time)) {
			return false;
		}

		return parseInt(task.completed_time) > parseInt(deadline);
	};
	
	
	/**
	 * @desc Check if a task is done on time
	 */
	this.doneOntime=function(task){
		return parseInt(task.status) && !this.doneLate(task);
	};
	
	
	/**
	 * @desc Check if the task is lately completed. Alias of donelate
	 */
	this.lateComplete=function(task){
		return this.doneLate(task);
	};
	
	
	this.overdue=function(task){
		if (parseInt(task.status)){
			return false;
		}
		
		if (!parseInt(task.deadline)){
			return false;
		}
		
		return parseInt(task.deadline) < AP.time.now();
	};
	
	
	this.overdueAgainst=function(task, deadline){
		if (parseInt(task.status)){
			return false;
		}
		
		if (!parseInt(task.deadline)){
			return false;
		}
		
		return parseInt(task.deadline) < parseInt(deadline);
	};
	
	
	this.dueToday=function(task){
		if (parseInt(task.status)){
			return false;
		}
		
		return parseInt(task.deadline) && AP.time.sameDay(task.deadline, AP.time.now());
	};
	
};


Compute.overview=new function __ComputeOverview(){
	this.tasks=[];
	
	this.init=function(tasks){
		if (!tasks){
			tasks=[];
		}
		
		this.tasks=tasks;
		this._overview={
			total: 0,
			percent: 0,
			overdue: 0,
			done_ontime: 0,
			done_late: 0,
			active: 0,
			active_todo: 0,
			active_doing: 0,
		};
		
		this._review={
			active: 0,
			review: 0,
			done: 0
		};
		
		this._users={"__unassigned":{tasks: [], total: 0, active: 0, active_todo: 0, active_doing: 0, done_late: 0, done_ontime: 0, late: 0, assigning:0}};
		this._collection={attentions:[], assigned: [], assigning_overdue:[], overdues: [], todos: []};
		
		this.overview();
		return this;
	};
	
	
	this.overview=function(){
		var now=AP.time.now();
		
		for (var i=0; i<this.tasks.length; i++){
			if (this.tasks[i].metatype!="task"){
				continue;
			}
			
			this._overview.total++;
			this.increaseUserReport(this.tasks[i].username, "total", this.tasks[i]);
			this.increaseUserReport(this.tasks[i].creator_username, "assigning", this.tasks[i]);
			
			var status=parseInt(this.tasks[i].status);
			var gs=Task.ui.grandState(this.tasks[i]);
			
			if (status==1){
				this._review.done++;
			}else{
				if (parseInt(this.tasks[i].review)){
					this._review.review++;
				}else{
					this._review.active++;
					// this.increaseUserReport(this.tasks[i], "review");
				}
			}
			
			if (status==0){
				if (parseInt(this.tasks[i].user_id)==parseInt(Client.viewer.id)){
					if (parseInt(this.tasks[i].urgent) || Compute.overdue(this.tasks[i])){
						this._collection.attentions.push(this.tasks[i]);
					}else{
						this._collection.assigned.push(this.tasks[i]);
					}
					
				}else if (parseInt(this.tasks[i].creator_id)==parseInt(Client.viewer.id)){
					if (parseInt(this.tasks[i].urgent) || Compute.overdue(this.tasks[i])){
						this._collection.assigning_overdue.push(this.tasks[i]);
					}
				}
			}
			
			
			if (gs=="todo"){
				this._collection.todos.push(this.tasks[i]);
			}
			
			if (Compute.overdue(this.tasks[i])){
				this._collection.overdues.push(this.tasks[i]);
			}
			
			if (status==1){
				if (Compute.doneOntime(this.tasks[i])){
					this._overview.done_ontime++;
					this.increaseUserReport(this.tasks[i].username, "done_ontime");
				}else{
					this._overview.done_late++;
					this.increaseUserReport(this.tasks[i].username, "done_late");
				}
			}else{
				if (gs=="todo"){
					this._overview.active_todo++;
					this.increaseUserReport(this.tasks[i].username, "active_todo");
				}else if (gs=="doing"){
					this._overview.active_doing++;
					this.increaseUserReport(this.tasks[i].username, "active_doing");
				}
				
				if (Compute.overdue(this.tasks[i])){
					this._overview.overdue++;
				}else{
					this._overview.active++;
				}
			}
		}
		
		
		
		if (this._overview.total){
			this._overview.percent=((this._overview.done_ontime+this._overview.done_late)*100/(this._overview.total)).toFixed(2);
		}
		
		
		this._me={tasks: [], total: 0, active: 0, active_todo:0, active_doing:0, done_late: 0, done_ontime: 0, overdue: 0, assigning:0};
		if (this._users[Client.viewer.username]){
			this._me=this._users[Client.viewer.username];
		}
		
		if (this._me.total){
			this._me.percent=((this._me.done_ontime+this._me.done_late)*100/(this._me.total)).toFixed(2);
		}else{
			this._me.percent=0;
		}
		
		var us=[];
		for (var k in this._users){
			this._users[k].username=k;
			us.push(this._users[k]);
		}
		
		this._users=us;
		this._users.sort(function(a, b){
			return b.total - a.total;
		});
	};
	
	this.people=function(){
	};
	
	this.daily=function(){
	};
	
	this.increaseUserReport=function(username, field, task){
		if (!username){
			username="__unassigned";
		}
		
		if (!this._users[username]){
			this._users[username]={tasks: [], total: 0, active: 0, active_todo:0, active_doing:0, done_late: 0, done_ontime: 0, overdue: 0, assigning:0};
		}
		
		this._users[username][field]++;
		if (field=="total"){
			this._users[username].tasks.push(task);
		}
	};
};



var TaskList=new function __ProjectTaskList(){
	this.fromContext=function(id){
		return AP.array.findObj(Client.pageData.tasklists, id);
	};
	
	this.getOptions=function(tasklists){	
		var opts=[];
		if(tasklists) {
			for (var i=0; i< tasklists.length; i++){
				opts.push({label: tasklists[i].name, value: tasklists[i].id});
			}
		} else {
			for (var i=0; i<Client.pageData.tasklists.length; i++){
				opts.push({label: Client.pageData.tasklists[i].name, value: Client.pageData.tasklists[i].id});
			}
		}

		return opts;
	};
	
	
	this.get=function(id, callback){
		UI.ajaxShow();
		AP.post("api/project/tasklist/get",{id: id}, function(code){
			UI.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			callback(code.tasklist);
		});
	};

	this.create=function(project){
		if (!project){
			project=Client.pageData.project;
		}
		
		if (project.status != 0) {
			return AP.alertError("Dự án đang tạm đóng hoặc đã hoàn thành.");
		}
		
		var data={id: project.id, hid: project.hid, token: project.token};

		
		var form=Form.create('fly-tasklist-fx',{'action': "api/project/tasklist/add"})
		.row(
			Form.label({label: "Tên nhóm công việc *"}),
			Form.input({name: 'name', placeholder: "Tên nhóm công việc"}).autoSubmit()
		).addClass("-big")
		// .wrap("Tùy chọn nâng cao","#advopts")
		// .row(
		// 	Form.label({label: "Có deadline hay không?"}),
		// 	Form.input({name: 'has_deadline', type:"list", options:[{label: "Không đặt deadline", value:0}, {label: "Đặt deadline cho nhóm công việc", value:1}]}).value(0)
		// )
		// .rowHidden(
		// 	Form.label({label: "Đặt deadline *"}),
		// 	Form.input({name: 'deadline', "role":"date", placeholder: "Click để chọn deadline"})
		// ).addClass("noflat")
		.row(
			Form.label({label: "Mô tả thêm"}),
			Form.input({name: 'content', type:"textarea", placeholder: "Mô tả thêm về nhóm công việc này"}).css({height: 100})
		)
		.buttons([
			 {label: "Tạo nhóm công việc", action: function(){
				 Form.submit("#fly-tasklist-fx", function(code){
					 if (!code.good()){
						 return AP.alertError(code.message);
					 }
					 
					 UI.flash("Đã thêm nhóm công việc...");
					 Form.hide("fly-tasklist-fx");
					 AP.xRefresh();
				 })
			 }, style: 'ok -success -rounded bold'},
			 {label: "Hủy", action: function(){
				 Form.hide("fly-tasklist-fx");
			 }, style:'cancel -passive-2 -rounded'}
		])
		.hiddens(data)
		.render(function(fref){
			setTimeout(function(){
				fref.find("name").focus();
			}, 300);
		});


		Form.pop({id:'fly-tasklist-dx', width: 480, label: 'Tạo nhóm công việc trong dự án: '+project.name, layout: 'flat', closable: false}).setForm(form).show().focus('name');

	};
	
	
	/**
	 * @desc Edit a tasklist
	 */
	this.edit=function(lid){
		var tasklist=AP.array.findObj(Client.pageData.tasklists, lid);
		if (!tasklist){
			return;
		}
		return editForm(tasklist);
	};
	
	
	
	
	/**
	 * @desc Get closed status // 1 means closed; 0 means open
	 */
	this.isClosed=function(tasklist){
		if (!tasklist.id){
			return 0;
		}
		
		if (tasklist.type!="tasklist" && tasklist.type!="project.tasklist"){
			return 0;
		}
		
		var start=AP.time.now();
		var end=AP.time.now();
		
		if (Client.pageData.stack){
			start=Client.pageData.stack.stime;
			end=Client.pageData.stack.etime;
		}else if (Client.pageData.project){
			start=AP.time.now();
			end=AP.time.now();
		}else{
			return 0;
		}
		
		var stime=parseInt(tasklist.cs.stime);
		var etime=parseInt(tasklist.cs.etime);
		
		if (!stime || stime >= end){
			return 0;
		}
		
		// So stime and stime < end
		if (!etime){
			return 1;
		}
		
		if (!etime || etime>start){
			return 1;
		}
		
		return 0;
	};

	
	
	
	
	function editForm(tasklist){
		var project=Client.pageData.project;
		
		if (project.status != 0) {
			return AP.alertError("Dự án đang tạm đóng hoặc đã hoàn thành.");
		}

		var data={id: tasklist.id, token: tasklist.token};
	
		var form=Form.create('fly-tasklist-fx',{'action': "api/project/tasklist/edit"})
		.row(
			Form.label({label: "Tên nhóm công việc *"}),
			Form.input({name: 'name'}).value(tasklist.name).autoSubmit()
		)
		.row(
			Form.label({label: "Mô tả thêm"}),
			Form.input({name: 'content', type:"textarea", placeholder: "Mô tả thêm về nhóm công việc này"}).css({height: 100}).value(tasklist.content)
		)
		.hiddens(data)
		.buttons([
			 {label: "Sửa nhóm công việc", action: function(){
				 Form.submit("#fly-tasklist-fx", function(code){
					 if (!code.good()){
						 return AP.alertError(code.message);
					 }
					 
					 UI.flash("Chỉnh sửa thành công...");
					 Form.hide("fly-tasklist-fx");
					 Board.fire("tasklist.edit", code.tasklist);
					 $("#task-list-name-"+code.tasklist.id).html(code.tasklist.name);
				 })
			 }, style: 'ok -success -rounded bold'},
			 {label: "Hủy", action: function(){
				 Form.hide("fly-tasklist-fx");
			 }, style:'cancel -passive-2 -rounded'}
		])
		.render(function(fref){
			setTimeout(function(){
				fref.find("name").focus();
			}, 300);
		});
	

		Form.pop({id:'fly-tasklist-dx', width: 480, label: 'Sửa nhóm công việc: '+tasklist.name, layout: 'flat'})
		.setForm(form)
		.show()
		.focus('name');
	};
	
};
 

TaskList.manage = new function __TaskListManage(){
	this.options=function(ref){	
		var ab=Project.option.tasklist(tasklist);
		
		AP.actionMenu(ab.context(), {
			title: "Tùy chỉnh nhóm công việc",
			context: ref
		});
	};
	
	
	this.move=function(lid, dir){
		var item=AP.array.findObj(Client.pageData.tasklists, lid);
		if (!item){
			return;
		}
		
		UI.ajaxShow();
		AP.post("api/project/tasklist/move",{action: dir, id: item.id, token: item.token}, function(code){
			UI.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			Board.trigger("tasklist.move",[dir, item]);
			AP.xRefresh();
		});
	};
	
	/**
	 * @desc Temporarily close a tasklist
	 */
	this.close=function(lid){
		var tasklist=AP.array.findObj(Client.pageData.tasklists, lid);
		if (!tasklist){
			return;
		}
		
		return closeForm(tasklist);
	};
	
	
	/**
	 * @desc Reopen every closed tasklists
	 */
	this.reopen = function () {
		var tasklists = AP.array.filter(Client.pageData.context.cached_tasklists, function(e){
			return e.id && parseInt(e.id);
			// return TaskList.isClosed(e);
		});
		
		var form=Form.create('fly-tasklist-fx',{'action': "api/project/tasklist/reopen"})
			.row(
				Form.label({label: "Tasklist *"}),
				Form.input({name: 'tasklist_id', type:'select', options: tasklists}).value()
			)
			.buttons([
				{label: "Open", action: function(){
					Form.submit("#fly-tasklist-fx", function(code){
						if (!code.good()){
							return AP.alertError(code.message);
						}

						UI.flash("Chỉnh sửa thành công...");
						Form.hide("fly-tasklist-fx");
						AP.xRefresh();
					})
				}, style: 'ok -success -rounded bold'},
				{label: "Cancel", action: function(){
					Form.hide("fly-tasklist-fx");
				}, style:'cancel -passive-2 -rounded'}
			])
			.render(function(fref){
				setTimeout(function(){
					fref.find("name").focus();
				}, 300);
			});


		Form.pop({id:'fly-tasklist-dx', width: 480, label: 'Mở lại nhóm công việc', layout: 'flat'})
			.setForm(form)
			.show()
			.focus('name');
	};
	
	
	this.setReview=function(lid){
		var tasklist=TaskList.fromContext(lid);
		if (!tasklist){
			return;
		}
		
		var project=Client.pageData.project;
		var data={id: project.id, tasklist_id: lid};

		var review=[];
		if (parseInt(tasklist.review.enabled) == 1) {
			review = tasklist.review.users;
			// var reviewer = '@'+review.users[0];
		} else {
			// var reviewer = '';
		}
		
		var form=Form.create('fly-tasklist-fx',{'action': "api/project/tasklist/review"})
		.row(
			Form.label({label: "Chọn người review *"}),
			Form.input({name: 'user', placeholder: "Chọn duy nhất một người, bỏ trống để xóa", role: 'user'}).autoSubmit().value("@"+review)
		).addClass("-big")
		.buttons([
			 {label: "Cập nhật", action: function(){
				 Form.submit("#fly-tasklist-fx", function(code){
					 if (!code.good()){
						 return AP.alertError(code.message);
					 }
					 
					 UI.flash("Cập nhật thành công ...");
					 Form.hide("fly-tasklist-fx");
					 AP.xRefresh();
				 })
			 }, style: 'ok -success -rounded bold'},
			 {label: "Hủy", action: function(){
				 Form.hide("fly-tasklist-fx");
			 }, style:'cancel -passive-2 -rounded'}
		])
		.hiddens(data);
		
		
		Form.pop({id:'fly-tasklist-dx', width: 480, label: 'Chọn người review công việc trong nhóm công việc', layout: 'flat'}).setForm(form).show().focus('user');
	
	};
	
	
	this.remove=function(lid){
		var tasklist=AP.array.findObj(Client.pageData.tasklists, lid);
		if (!tasklist){
			return;
		}
		
		if (Client.pageData.project.status != 0) {
			return AP.alertError("Dự án đang tạm đóng hoặc đã hoàn thành.");
		}
		
		AP.confirmDelete("Bạn có chắc muốn xoá nhóm công việc <b>"+tasklist.name+"</b>? Tất cả công việc trong nhóm sẽ bị xóa và nhóm đã xoá sẽ không thể phục hồi.", function(){
			AP.ajaxShow();
			AP.post("api/project/tasklist/remove",{id: tasklist.id, token: tasklist.token}, function(code){
				AP.ajaxHide();
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				AP.hideAlert();
				UI.flash("Nhóm công việc đã xoá");
				AP.refresh();
			});
		});
	};
	
	
	
	function closeForm(tasklist){
		var project=Client.pageData.project;
		var data={id: tasklist.id, token: tasklist.token};
	
		var form=Form.create('fly-tasklist-fx',{'action': "api/project/tasklist/close"})
		.row(
			Form.label({label: "Tên nhóm công việc"}),
			Form.input({name: 'name', type:"fake"}).value(tasklist.name)
		)
		.row(
			Form.label({label: "Thời gian bắt đầu*"}),
			Form.input({name: 'cs_stime', "role":"date", placeholder: "Thời gian bắt đầu"}).valueIf(tasklist.cs.stime, parseInt(tasklist.cs.stime))
		).addClass("noflat")
		.row(
			Form.label({label: "Thời gian kết thúc*"}),
			Form.input({name: 'cs_etime', "role":"date", placeholder: "Thời gian kết thúc"}).valueIf(tasklist.cs.etime, parseInt(tasklist.cs.etime))
		).addClass("noflat")
		.hiddens(data)
		.buttons([
			 {label: "Lưu thay đổi", action: function(){
				 Form.submit("#fly-tasklist-fx", function(code){
					 if (!code.good()){
						 return AP.alertError(code.message);
					 }
					 
					 UI.flash("Chỉnh sửa thành công...");
					 Form.hide("fly-tasklist-fx");
					 AP.xRefresh();
				 })
			 }, style: 'ok -success -rounded bold'},
			 {label: "Hủy", action: function(){
				 Form.hide("fly-tasklist-fx");
			 }, style:'cancel -passive-2 -rounded'}
		])
		Form.pop({id:'fly-tasklist-dx', width: 480, label: 'Tạm đóng nhóm công việc: '+tasklist.name, layout: 'flat'})
		.setForm(form)
		.show()
		.focus('name');
	};

	
	
};




var Board=new function __Board(){
	this.mode="list";
	this.drag_mode='';
	
	this.cached_opts="";
	
	this.getTasks=function(){
		return Client.pageData.tasks;
	};

	
	this.fire = this.trigger = function(event, data){
		AP.sys.fire(event, data);
	};

	
	/**
	 * @desc General display of the board
	 */
	this.display=function(){
		var view=Client.pageData.task_view;
		this.mode=view;
		
		Board.data.init();
		
		if (view=="std" || view=="list"){
			this.mode="list";
			$("#tasklists").empty();
			Board.list.display(Client.pageData.context);	
		}
		
		if (view=="table"){
			$("#board-table").empty();
			Board.table.display();
		}
		
		if (this.mode=="board"){
			$("#main-board").empty();
			Board.kb.build("#main-board");
		}
		
		if (this.mode=="people"){
			$("#main-board").empty();
			var lists=Board.people.build();
			Board.kb.mode="people";
			Board.kb.build("#main-board", lists, {view:'people'});
		}
		
		
		Board.dnd();
	};
	
	
	/**
	 * @desc Binding events for new task / updated task
	 */
	this.updateEvents=function(task){
		if (this.drag_mode='drag'){
			if (Client.pageData.task_view=="board"){
				initTaskDraggable("#js-task-"+task.id);	
			}
		}
	};
	
	
	/**
	 * @desc Clear inline events and handlers / helper HTMLs
	 */
	this.clean=function(canvas, target){
		$(canvas+ " .js-task").removeClass("pending_focus");
		$(canvas+ " .activated").each(function(){
			if ($.contains(this, target) || this==target || $(target).closest(".ui-datepicker-header").length){
				$(this).closest(".js-task").addClass("pending_focus");
			}else{
				$(this).removeClass("activated");
			}
		});
		
		$(canvas+ " .js-task").each(function(){
			$(this).removeClass("focus");
			if ($(this).hasClass("pending_focus")){
				$(this).addClass("focus");	
			}
		});
	};
	
	
	
	/**
	 * @desc Make a full display reset
	 */
	this.reset=function(){
		var view=Client.pageData.task_view;
		if (view == "stream"){
			Team.stream.init({canvas: "#tasklists"});
		} else if (view == "period"){
			Team.period.init({canvas: "#tasklists"});
		} else if (Client.pageData.show_viewer==1){
			MyTask.list("#tasklists");
		} else {
			Board.display();
		}
	};
	
	
	
	/**
	 * @desc Init drag and drop task
	 */
	this.dnd=function(){
		this.drag_mode='';
		
		if (!Project.isManager()){
			// return;
		}else{
			initTasklistSortable();
		}
		
		if (!Board.filter.sortEnabled()){
			if (Board.filter.dragEnabled()){
				this.drag_mode='drag';
				return this.draggable();
			}
			return;
		}
		
		this.drag_mode='sort';
		
		var stages_collector='#main-board .js-tasklist';
		var tasks_sortable="#main-board .items.js-set";
		var handler='';
		var axis='';
		
		if (this.mode=="list"){
			stages_collector='#tasklists .tasklist';
			tasks_sortable="#tasklists .tasklist .list.tasks";
			handler='.idx';
			axis='y';
		}
		
		if (this.mode=="table"){
			stages_collector='#js-main-table .js-group-wrapper';
			tasks_sortable="#js-main-table .js-group-wrapper";
			handler='.sbar';
			axis='y';
		}

		
		$(stages_collector).droppable({"tolerance": "pointer", accept: function($d){
			if ($d.hasClass("js-bucket")){
				return false;
			}
			
			var sid=$d.data("sid");
			if (sid== $(this).data("sid")){
				return false;
			}
			
			return true;
		}, 
		hoverClass:"dnd-hover", 
		drop: function(event, ui){
		}, out: function(event, ui){
			
		}});
		
		this.cached_opts={set: tasks_sortable, handle: handler, axis: axis};
		initTaskSortAndDrag(tasks_sortable, this.cached_opts);
	};
	
	
	/**
	 * @desc Draggable only, without sorting
	 */
	this.draggable = function () {
		var stages_collector = '#main-board .js-tasklist';
		var tasks_sortable = "#main-board .items.js-set .js-task";
		var handler = '';
		var axis = '';

		if (this.mode == "list") {
			stages_collector = '#tasklists .tasklist';
			tasks_sortable = "#tasklists .tasklist .list.tasks";
			handler = '.idx';
			axis = 'y';
		}

		if (this.mode == "table") {
			stages_collector = '#js-main-table .js-group-wrapper';
			tasks_sortable = "#js-main-table .js-group-wrapper";
			handler = '.sbar';
			axis = 'y';
		}


		$(stages_collector).droppable({
			tolerance: "pointer",
			accept: function ($d) {
				if ($d.hasClass("js-bucket")) {
					return false;
				}

				var sid = $d.data("sid");
				if (sid == $(this).data("sid")) {
					return false;
				}

				return true;
			},
			hoverClass: "dnd-hover",
			drop: function (event, ui) {
				moving(ui.draggable, this);
			}
		});

		initTaskDraggable(tasks_sortable);
	};
	
	
	
	
	/**
	 * @desc Init task sorting and moving at the same time
	 */
	function initTaskSortAndDrag(ref, opts){
		// Refresh with sortable("refresh"); <ACCEPT NEW ELEMENT>
		
		if (AP.data.isInt(ref)){
			ref="#js-task-"+ref;
		}
		
		var sortable_opts={
			items: "> .js-task",
			helper: "clone",
			opacity: 0.95,
			tolerance : "pointer",
//				appendTo: '#main-board',
			connectWith: opts.set,
			forcePlaceholderSize: true,
			placeholder: "sortable-placeholder",
			scroll: true,
			start: function(event, ui){
				ui.helper.addClass("sortable-active");
				var last_task_id=0;
				var $last_task=$(ui.placeholder).prev();
				if ($last_task.length){
					last_task_id=$last_task.data("id")
				};
				
				$(ui.item).data("temp_prev_id", last_task_id);
			},
			change: function(event){
				// checkMousePosition(event);
			},
			stop: function(event, ui){
				var task=Query.get("task");
				if (task) {
					return;
				}
				
				var id=$(ui.item).data("id");
				if (!id || !parseInt(id)){
					return;
				}
				
				if ($(ui.item).hasClass(".js-tasklist")){
					// HOT FIX KANBAN
					return;	
				}
				
				var tasklist_id=$(ui.item).closest(".js-tasklist").data("id");
				if (opts.set == "#js-main-table .js-group-wrapper") {
					var tasklist_id=$(ui.item).closest(".js-group-wrapper").data("id");
				}

				if (tasklist_id===false || tasklist_id===null){
					tasklist_id=0;
				}
				
				// moving(ui.draggable, $("#main-board .js-stage-"+sid));
				
				if (Board.kb.mode=="people"){
				}else{
					//Fix bug drag and drop in board view
					
					var prev_id=0;
					var $prev=$(ui.item).prev();
					if ($prev.length && $prev.hasClass("js-task")){
						prev_id=$prev.data("id");
					}
					
					if (prev_id==parseInt($(ui.item).data("temp_prev_id"))){
						return;
					}
					
					Task.action.setOrder(id, prev_id, tasklist_id);
					console.log([id, prev_id, tasklist_id]);
					
					$(ui.item).data("tasklist_id", tasklist_id);
				}
			},
		};
		
		if (opts.handle && opts.handle.length){
			sortable_opts.handle=opts.handle;
		}
		
		if (opts.axis && opts.axis.length){
			sortable_opts.axis=opts.axis;
		}
		
		$(ref).sortable(sortable_opts).disableSelection();
	};
	
	
	
	function initTaskDraggable(selector){
		$(selector).draggable({
			helper: "clone", 
			appendTo: '#main-board',
			placeholder: "sortable-placeholder",
			scroll: true,
			start: function(event, ui){
				$(ui.helper).addClass("sortable-active");
				$(ui.helper.context).addClass("sortable-placeholder");
				// $("#main-board .stages .tab").removeClass("inactive");
				// $("#main-board .stages .tab.tab-"+$(this).data("sid")).addClass("inactive");
			},
			drag: function(event, ui){
				// checkMousePosition(event);
			},
			stop: function(event, ui){
				$("#main-board .js-task").removeClass("sortable-placeholder");
			},
		});
	};
	
	
	function initTasklistSortable(){
		// INIT SORTABLE TASKLIST
		if (!mobile() && Board.mode=="board" && Board.data.model.metatype=="tasklist" && Project.isManager()){
			$("#main-board .stages").sortable({
				axis: "x",
				tolerance: "pointer",
				handle: ".name",
				placeholder: "stage-placeholder",
				forcePlaceholderSize: true,
				scroll: true,
				items: ".js-bucket:not(.js-stage-0)",
				start: function(event, ui){			
					ui.helper.addClass("sortable-stage-active");
				},
				stop: function(event, ui){
					$("#main-board .stages .stage").removeClass("sortable-stage-active");
					
					var orders=[];
					$("#main-board .stages .stage").each(function(){
						if ($(this).data("id")){
							orders.push($(this).data("id"));
						}
					});
					
					
					AP.post("api/project/tasklist/reorder", {id: Client.pageData.project.id, orders: orders.join(",")}, function(code){
						if (!code.good()){
							return AP.alertError(code.message);
						}
					});
				},
				opacity:0.8
			});
			
			
			$("#main-board .stages .stage").each(function(){
				AP.dnd(this, "api/task/add.upload", {
					id: Client.pageData.context.id,
					tasklist_id: $(this).closest(".js-bucket").data("sid")
				}, function(code){
					if (!code.good()){
						return AP.alertError(code.message);
					}

					AP.xRefresh(function(){
						UI.flash("Uploaded successfully");
					});

				});
			});
		}
	};
	
	
	
	function moving(task_selector, group_selector){
		var id=$(task_selector).data("id");
		var task=Task.fromContext(id);
		if (!task){
			return;
		}
		
		var m=Board.data.model.metatype;
		var gid=$(group_selector).data("id");
		
		if (m=="tasklist"){
			if (gid==task.tasklist_id){
				return;
			}
			
			Task.inline.edit(id, {key: "tasklist", value: gid}, task_selector);
		}

		if (m=="milestone"){
			if (gid==task.milestone_id){
				return;
			}
			
			Task.inline.edit(id, {key: "milestone", value: gid}, task_selector);
		}
		
		if (m=="user"){
			if (gid==task.user_id){
				return;
			}
			
			Task.inline.edit(id, {key: "assign", value: gid}, task_selector);
		}
		
		
		// DISPLAY ON UI
		$(task_selector).slideUp(100, function(){
			$(this).prependTo($(group_selector).find(".items")).slideDown(200, function(){				
			});
		});
		
	};
};


/**
 * @desc Class to manage data, including managing tasklist relationship and subtask relationship
 */

Board.data=new function __BoardData(){
	this.model=null;
	this.period_by=null; // TEAM ONLY
	
	
	this.init=function(){		
		if (!Client.pageData.project){
			return [];
		}
		
		// BUILDING THE TASK RELATIONSHIP
		for (var j = 0; j < Client.pageData.tasks.length; j++) {
			Client.pageData.tasks[j].visible=Project.filter.getVisible(Client.pageData.tasks[j]);
			
			Client.pageData.tasks[j].subtasks = AP.array.filter(Client.pageData.tasks, function(s){
				return parseInt(s.parent_id) == parseInt(Client.pageData.tasks[j].id);
			});
			
			Client.pageData.tasks[j].subtasks=AP.array.realOrder(Client.pageData.tasks[j].subtasks);
			
			Client.pageData.tasks[j].parent=AP.array.findObj(Client.pageData.tasks, Client.pageData.tasks[j].parent_id);
		}
		
		
		// SORT TASKS AGAIN IF IN PROJECT METATYPE IS PROJECT
		if (Client.pageData.context && Client.pageData.context.metatype=="project"){
			Client.pageData.tasks.sort(function (e, f) {
				return Board.filter.computeSort(e, f);
			});
		}else if (Client.pageData.context && Client.pageData.task_view=="period"){
			Client.pageData.tasks.sort(function (e, f) {
				return Board.filter.periodSort(e, f);
			});
		}else if (Client.pageData.context && Client.pageData.task_view=="stream"){
			Client.pageData.tasks.sort(function (e, f) {
				return Board.filter.streamSort(e, f);
			});
		}
		
		
		
		// BUILDING TASKLISTS
		AP.array.reorder(Client.pageData.tasklists);
		if (!AP.array.findObj(Client.pageData.tasklists, 0)){
			Client.pageData.tasklists.unshift(getDefaultTasklist());
		}
		
		// LINK (MAIN) TASKS TO TASKLIST
		for (var i = 0; i < Client.pageData.tasklists.length; i++) {
			Client.pageData.tasklists[i].tasks = AP.array.filter(Client.pageData.tasks, function (e) {
				if (parseInt(e.tasklist_id) == parseInt(Client.pageData.tasklists[i].id) && e.metatype=="task"){
					return e;
				}
				return null;
			});
		}
		
		
		// BUILDING MILESTONES
		if (!AP.array.findObj(Client.pageData.milestones, 0)){
			Client.pageData.milestones.push(getDefaultMilestone());
		}
		
		Client.pageData.milestones.sort(function(e, f){
			return parseInt(f.time)-parseInt(e.time);
		});
		
		// LINK (MAIN) MILESTONES TO MILESTONE
		for (var i = 0; i < Client.pageData.milestones.length; i++) {
			Client.pageData.milestones[i].tasks = AP.array.filter(Client.pageData.tasks, function (e) {
				if (parseInt(e.milestone_id) == parseInt(Client.pageData.milestones[i].id) && e.metatype=="task"){
					return e;
				}
				return null;
			});
		}
		
		
		
		// BUILD PEOPLE
		var people={};
		for (var i=0; i<Client.pageData.tasks.length; i++){
			if (Client.pageData.tasks[i].metatype=="task"){
				if (people["p"+Client.pageData.tasks[i].user_id]){
					people["p"+Client.pageData.tasks[i].user_id].push(Client.pageData.tasks[i]);
				}else{
					people["p"+Client.pageData.tasks[i].user_id]=[Client.pageData.tasks[i]];
				}	
			}
		}
		
		
		Client.pageData.people=[];
		for (var key in people){
			var id=parseInt(key.substr(1));
			var u=shallowClone(People.get(id));
			
			if (!parseInt(id)){
				u=getDefaultUser(u);
			}else if (u && parseInt(u.uid)){
			}else{
				u=getDeactivatedUser(u);
			}
			
			u.tasks=people[key];
			Client.pageData.people.push(u);
		}
		
		
		/**
		 * @desc Building model
		 */
		this.buildModel();
	};

	
	/**
	 * @desc Smartly groups tasks into collections, either by {tasklists, people, milestones}. Tasklist is default
	 * @return object {type, groups}  
	 */
	this.buildModel=function(){
		var groupby=Base.pref().get("pref_groupby_"+Client.pageData.project.id)
		var num_tasks=countTasks(AP.array.filter(Client.pageData.tasks, function(e){
			return e.metatype=="task";
		}));
		
		if (groupby=="tasklist" || !groupby){
			this.model={metatype:"tasklist", groups: Client.pageData.tasklists, num_groups: Client.pageData.tasklists.length, num_tasks: num_tasks};	
		}else if (groupby=="milestone"){
			this.model={metatype:"milestone", groups: Client.pageData.milestones, num_groups: Client.pageData.milestones.length, num_tasks: num_tasks};	
		}else if (groupby=="people"){
			this.model={metatype:"user", groups: Client.pageData.people, num_groups: Client.pageData.people.length, num_tasks: num_tasks};	
		}
		
		this.model.grouped=Board.filter.grouped;
	};
	
	
	/**
	 * @desc Quickly discover object by its id and optionally metatype
	 * @param int id the object id
	 * @param string metatype OPTIONAL, default is Board.data.model.metatype
	 */
	this.fromContext=function(id, metatype){
		if (!metatype){
			metatype=this.model.metatype;
		}
		
		if (metatype=="tasklist"){
			return AP.array.findObj(Client.pageData.tasklists, id);
		}else if (metatype=="user"){
			return AP.array.findObj(Client.pageData.people, id);
		}else if (metatype=="milestone"){
			return AP.array.findObj(Client.pageData.milestones, id);
		}
		
		return null;
	};
	
	
	this.update=function(task){
		if (Client.pageData.tasks){
			// AP.array.updateByID(Client.pageData.tasks, task);
			for (var i=0; i<Client.pageData.tasks.length; i++){
				if (parseInt(Client.pageData.tasks[i].id)==parseInt(task.id)){
					for (var prop in task){
						Client.pageData.tasks[i][prop]=task[prop];
					}
				}
			}
		}
		
		this.init();
		return this.getTask(task);
	};
	
	
	this.insert=function(task){
		if (Client.pageData.tasks){
			AP.array.updateByID(Client.pageData.tasks, task);
		}
		
		this.init();
		return this.getTask(task);
	};
	
	
	/**
	 * @desc Update data model when inserting a list of tasks
	 */
	this.insertList=function(tasks){
		if (Client.pageData.tasks){
			for (var i=0; i<tasks.length; i++){
				AP.array.updateByID(Client.pageData.tasks, tasks[i]);	
			}
		}
		
		this.init();
	};
	

	this.taskMoved=function(task){
		
	};
	
	
	this.getTask=function(task){
		return AP.array.findObj(Client.pageData.tasks, task.id);
	};
	
	
	
	function getDefaultTasklist(){
		return {"tasks": [], "name": "Chưa phân loại", type: "tasklist", df: 1, id: 0, stats: {}};
	};
	
	function getDefaultMilestone(){
		return {"tasks": [], "name": "No milestone", type: "milestone", id: 0, stats: {}, time: 0};
	};
	
	function getDefaultUser(){
		return {"tasks": [], "name": "Not assigned", type: "user", id: 0, stats: {}, time: 0};
	};
	
	
	function getDeactivatedUser(){
		return {"tasks": [], "name": "Deactivated", type: "user", id: 0, stats: {}, time: 0};
	};
	
	
	function countTasks(arr){
		var total=AP.array.count(arr, function(e){
			return parseInt(e.visible);
		});
		
		for (var i=0; i<arr.length; i++){
			if (arr[i].visible){
				total+=countTasks(arr[i].subtasks);
			}
		}
		
		return total;
	}
};


Board.tasklist=new function __BoardTaskList(){
	this.build=function(){
		var tasklists=Project.tasklists();
		
		var r=[];
		for (var i=0; i<tasklists.length; i++){
			r.push({
				type: "tasklist",
				header: tasklists[i],
				items: tasklists[i].tasks,
				tasks: tasklists[i].tasks
			});
		}
		
		return r;
	};
	
	
	this.buildWithTemplate=function(){
		var tasklists=Project.tasklists();
		
		var r=[];
		for (var i=0; i<tasklists.length; i++){
			r.push({
				type: "tasklist",
				metatype: "tasklist",
				header: tasklists[i],
				items: filterActive(tasklists[i].tasks),
				tasks: filterActive(tasklists[i].tasks)
			});
		}
		
		
		return r;
	};
	
	
	
	function getCompletedTasks(){
		return AP.array.filter(Client.pageData.tasks, function(e){
			return parseInt(e.status)==0;
		});
	};
	
	
	function getReviewingTasks(){
		return AP.array.filter(Client.pageData.tasks, function(e){
			return parseInt(e.review) && !parseInt(e.status);
		});
	};
	
	function filterActive(tasks){
		return AP.array.filter(tasks, function(e){
			return !parseInt(e.review) && !parseInt(e.status);
		});
	};
};


Board.people=new function __BoardPeople(){
	this.build=function(){
		var logs={};
		logs.not_assigned={
			header:{
				"name":"Chưa được giao",
				"id":"not_assigned"
			},
			tasks:[]
		};
		
		for (var i=0; i<Client.pageData.tasks.length; i++){
			if (!parseInt(Client.pageData.tasks[i].user_id)){
				if (!logs.not_assigned){
					logs.not_assigned={
						header:{
							"name":"Chưa được giao",
							"id":"not_assigned"
						},
						tasks:[Client.pageData.tasks[i]]
					}
				}else{
					logs.not_assigned.tasks.push(Client.pageData.tasks[i]);
				}
				
				continue;
			}
			
			var u=People.get(Client.pageData.tasks[i].username);
			var username=u.username;
			
			if (!logs[username]){
				logs[username]={
					header:u,
					tasks:[Client.pageData.tasks[i]]
				}
			}else{
				logs[username].tasks.push(Client.pageData.tasks[i]);
			}
		}
		
		var r=[];
		for (var key in logs){
			if (logs[key].tasks){
				r.push(logs[key]);
			}
		}
		
		for (var i=0; i<r.length; i++){
			r[i].tasks=r[i].tasks;
			r[i].tasks.sort(function(e, f){
				return Project.filter.computeSort(e, f);
			});
		}
		
		return r;
	};
};


Board.filter=new function __BoardFilter(){
	this.current = "all";
	this.grouped = 1; // GROUP COMPLETED TASK
	this.subtasks = 0;
	this.filter = "all";
	this.sort="default";
	this.groupby="tasklist";
	
	this.init=function(){
		if (AP.pageConfig.get("inited")){
			return;
		}
		
		AP.pageConfig.set("inited", 1);
		
		initProjectSorter();
		initProjectRangeFilter();
		initGCTPref();
		initSubtaskFilter();
		initStatusFilter();
		initProjectGroupBy();
	};
	
	
	this.live=function(key, val){
		if (Client.pageData.project && Client.pageData.project.metatype=="project"){
			Project.header.applyFilter(key+":"+val+" ");	
		}else{
			if (key=="filter"){
				if (val=="important" || val=="urgent" || val=="overdue" || val=="donelate"){
					return AP.setURLParams({status: val}, true);
				}else{
					if (AP.word.prefix(val,"start-") || val=="subtask"){
						return;
					}
					
					return AP.setURLParams({q: val}, true);
				}
			}
		}
		
	};
		
	
	this.sortEnabled=function(){
		return Board.filter.sort=="default" && Client.pageData.project && Client.pageData.project.metatype=="project" && Board.data.model.metatype=="tasklist";
	};
	
	
	this.dragEnabled=function(){
		if (!Client.pageData.project){
			return false;
		} 
		
		if (Client.pageData.task_view!="board"){
			return false;
		}
		
		if (Project.isManager()){
			return true;
		}
		
		return true;
	};
	
	
	
	this.removeStartDate=function(){
		AP.setURLParams({start: null, end: null}, true);
	};
	
	
	/**
	 * @desc Compute the order of two 
	 */
	this.computeSort = function (e, f) {
		var sort = this.sort;

		if (sort == "deadline"){
			return sortByDeadline(e, f);
		}

		if (sort == "deadline_reversed") {
			var e1 = parseInt(e.deadline);
			var f1 = parseInt(f.deadline);
			var now = AP.time.now();

			if (!e1) {
				e1 = AP.time.beginOfDay(now);
			}
			if (!f1) {
				f1 = AP.time.beginOfDay(now);
			}

			return e1 - f1;
		}

		if (sort == "alpha") {
			var e1 = AP.purify(e.name);
			var f1 = AP.purify(f.name);

			return e1.localeCompare(f1);
		}

		if (sort == "urgent") {
			var e1 = parseInt(e.urgent);
			var f1 = parseInt(f.urgent);

			return f1 - e1;
		}


		if (sort == "update_time") {
			var e1 = parseInt(e.last_update);
			var f1 = parseInt(f.last_update);

			return f1 - e1;
		}


		if (sort == "id" || (Client.pageData.context && Client.pageData.context.metatype != "project")) {
			return (parseInt(f.id) - parseInt(e.id));
		}

		if (!f.real_order && !e.real_order) {
			return (parseInt(f.id) - parseInt(e.id));
		}

		return (parseInt(f.real_order) - parseInt(e.real_order));
	};
	
	
	
	/**
	 * @desc Sorting on period view
	 */
	this.periodSort=function(e, f){
		var period=Board.data.period_by;
		if (period=="deadline"){
			return sortByDeadline(e, f);
		}
		
		return parseInt(f.id)-parseInt(e.id);
	};
	
	
	/**
	 * @desc Sorting on stream view
	 */
	this.streamSort=function(e, f){
		var order=Query.get("order");
		if (order=="deadline"){
			return sortByDeadline(e, f);
		}else if (order=="created"){
			return parseInt(f.id)-parseInt(e.id);
		}else{
			return parseInt(f.last_update)-parseInt(e.last_update);
		}
	};
	
	

	
	/**
	 * @desc Checking to make sure that a task after released is visible. Project only
	 */
	this.getVisible=function(task){
		if (!Client.pageData.project || Client.pageData.project.metatype!="project"){
			return 1;
		}
		
		
		var view=Project.filter.filter;
		
		if (view=="all"){
			return 1;
		} else if (view=="active"){
			if (parseInt(task.status)){
				return 0;
			}
		} else if (view=="review"){
			if (parseInt(task.status) == 0 && parseInt(task.review) == 1){
				return 1;
			}
			
			return 0;
		} else if (view=="done"){
			if (!parseInt(task.status)){
				return 0;
			}
		} else if (view=="starred"){
			if (!Task.fav.isFav(task.id)){
				return 0;
			}
		} else if (view=="mine"){
			if (parseInt(task.user_id) != parseInt(Client.viewer.id)){
				return 0;
			}
		} else if (view=="urgent"){
			if (!parseInt(task.urgent)){
				return 0;
			}
		} else if (view=="important"){
			if (!parseInt(task.important)){
				return 0;
			}
		}else if (view=="overdue"){
			if (!Compute.overdue(task)){
				return 0;
			}
		}else if (view=="donelate"){
			if (!Compute.doneLate(task)){
				return 0;
			}
		}else if (view=="todo"){
			if (Task.ui.grandState(task)=="todo"){
				return 1;
			}
			
			return 0;
		}else if (view=="doing"){
			if (Task.ui.grandState(task)=="doing"){
				return 1;
			}
			
			return 0;
		}
		
		return 1;
	};
	
	
	
	/**
	 * @desc Check matching
	 */
	function match($elem, key){
		if (key == "all"){
			return true;
		}
		
		if (key == "mine"){
			if ($elem.data("username") == Client.viewer.username){
				return true;
			}
			
			return false;
		}
		
		if (key == "starred"){	
			if (parseInt($elem.data("starred"))){
				return true;
			}
			
			return false;
		}
		
		if (key == "alert"){
			if ($elem.hasClass("-alert")){
				return true;
			}
			
			return false;
		}
		
		if (key == "week"){
			var dl=$elem.data("deadline");
			if (AP.time.sameWeek(dl, AP.time.now())){
				return true;
			}
			
			return false;
		}
		
		if (key == "done"){
			return $elem.hasClass("-done");
		}
		
		if (key == "overdue"){
			return $elem.hasClass("-overdue");
		}
	};
	
	
	
	/**
	 * @desc Init subtask filter 
	 */
	function initSubtaskFilter(){
		if (!Client.pageData.project){
			return;
		}
		
		$("#js-project-view-subtasks").html("<option value='natural'>Nhiều cấp subtasks</option> <option value='flatten'>Tất cả cùng cấp</option> <option value='none'>Không hiển thị</option>");
		
		if (Client.pageData.project.metatype=="project"){
			$("#js-project-view-subtasks").html("<option value='natural'>Một cấp subtasks</option> <option value='nested'>Nhiều cấp subtasks</option> <option value='none'>Không hiển thị</option>");
		}
		
		// Subtasks
		var subtasks_pref=AP.log.getAppCookie("subtasks_pref_"+Client.pageData.project.id);
		if (!subtasks_pref){
			subtasks_pref="natural";
		}
		
		AP.pageConfig.set("subtasks", subtasks_pref);
		
		$("#js-project-view-subtasks").val(subtasks_pref);
		
		$("#js-project-view-subtasks").on("change", function(){
			var val=$(this).val();
			AP.log.setAppCookie("subtasks_pref_"+Client.pageData.project.id, val);
			AP.xRefresh();
		});
	};
	
	
	
	
	/**
	 * @desc Init project internal sorter, project only
	 */
	function initProjectSorter(){
		if (!Client.pageData.project){
			return;
		}
		
		var sort=Base.pref().get("pref_sort_"+Client.pageData.project.id);
		if (!sort || sort=="tasklist" || sort=="milestone" || sort=="user"){
			sort="default";
		}
		
		
		Board.filter.sort=sort;
		Base.pref().set("pref_sort_"+Client.pageData.project.id, sort);
		
		$("#df_sort").val(sort).on("change", function(){
			var val=$(this).val();
			Base.pref().set("pref_sort_"+Client.pageData.project.id, val);
			AP.xRefresh();
		});
	};
	
	
	
	/**
	 * @desc Init project groupby, project only
	 */
	function initProjectGroupBy(){
		if (!Client.pageData.project || Client.pageData.project.metatype!="project"){
			$("#js-mastergroup_pref").parent().hide();
			return;
		}
		
		$("#js-mastergroup_pref").html("<option value='tasklist'>Nhóm công việc</option> <option value='milestone'>Mục tiêu</option> <option value='people'>Thành viên</option>");
		
		var g=Base.pref().get("pref_groupby_"+Client.pageData.project.id);
		if (!g){
			g="tasklist";
		}
		
		Board.filter.groupby=g;
		Base.pref().set("pref_groupby_"+Client.pageData.project.id, g);
		
		$("#js-mastergroup_pref").val(g).on("change", function(){
			var val=$(this).val();
			Base.pref().set("pref_groupby_"+Client.pageData.project.id, val);
			AP.xRefresh();
		});
	};
	
	
	

	/**
	 * @desc Init filters to choose start and end date, project only
	 */
	function initProjectRangeFilter(){
		if (Client.pageData.project.metatype == 'project' && !mobile()){
			var label="<span class='js-clickable'>Ngày tạo <span class='-ap icon-chevron-down2'></span></span>";
			var start_str=AP.time.time("%Y-%m-%d", Client.pageData.context.since);
			var end_str=AP.time.time("%Y-%m-%d", AP.time.now());
			
			if (parseInt(Client.pageData.params.start) && parseInt(Client.pageData.params.end)){
				label="<span class='js-clickable'> Ngày tạo: <em>"+(AP.i18n.date(Client.pageData.params.start))+"</em> &rsaquo;&nbsp; <em>"+(AP.i18n.date(Client.pageData.params.end))+"</em> </span> &nbsp; &#8942; &nbsp; <span onclick='Board.filter.removeStartDate();' class='-ap icon-close' title='Remove this filter'></span>";
			}
			
			$("#js-header-startdate").html(label);
			
			$("#js-header-startdate .js-clickable").dateRangePicker({
				getValue: function(){
					return this.innerHTML;
				},
				setValue: function(s, from, to, from_ts, to_ts, click){

				},
				onSelect: function(from, to){
					AP.setURLParams({
						start: encodeURIComponent(AP.time.time("%d-%m-%Y", from)),
						end: encodeURIComponent(AP.time.time("%d-%m-%Y",to)),
					}, true);

					$(this).data('dateRangePicker').close();
				}
			});

			$("#js-header-startdate .js-clickable").data("dateRangePicker").setStart(start_str).setEnd(end_str);
		};
	};
	
	
	
	/**
	 * @desc Init group-completed task pref
	 */
	function initGCTPref(){
		if (!Client.pageData.project){
			return;
		}
		
		var grouped=Base.pref().get("pref_grouped_"+Client.pageData.project.id);
		if (!grouped || !parseInt(grouped)){
			grouped=1;
		}
		
		grouped=parseInt(grouped);
		Board.filter.grouped=grouped;
		
		if (grouped==1){
			$("#df-group-done").addClass("checked");		
		}else{
			$("#df-group-done").removeClass("checked");
		}
		
		$("#df-group-done").click(function(){
			var grouped=Board.filter.grouped;
			if (!grouped || !parseInt(grouped)){
				grouped=1;
			}
			
			grouped=-parseInt(grouped);
			Base.pref().set("pref_grouped_"+Client.pageData.project.id, grouped);
			Board.filter.grouped=grouped;
			
			if (grouped==1){
				$("#df-group-done").addClass("checked");
			}else{
				$("#df-group-done").removeClass("checked");
			}
			
			AP.xRefresh();
		});
	};
	
	
	function initStatusFilter(){
		var filter=Base.pref().get("pref_filter" + Client.pageData.project.id);
		if (!filter){
			filter="all";
		}
		
		Board.filter.filter=filter;
		
		Base.pref().set("pref_filter" + Client.pageData.project.id, filter);
		
		
		$("#js-canvas-filter .li").each(function(){
			var f=$(this).data("filter");
			var lb=$(this).data("label");
			if (f==filter){
				$(this).addClass("selected");
				$("#tasklists").removeClass().addClass("filter-"+f);
				$("#js-canvas-filter em").html(lb);
			}
			
			$(this).click(function(){
				var f=$(this).data("filter");
				var lb=$(this).data("label");
				Base.pref().set("pref_filter" + Client.pageData.project.id, f);
				Board.filter.filter=f;
				
				
				$(this).addClass("selected");
				$(this).siblings().removeClass("selected");
				
				if (Client.pageData.task_view=="table" || Client.pageData.task_view=="board" || Client.pageData.task_view=="people" || Client.pageData.task_view=="list"){
					Board.display();
				}
				
				$("#js-canvas-filter em").html(lb);
			});
		});
	};
	
	
	
	function sortByDeadline(e, f){
		var e1 = parseInt(e.deadline);
		var f1 = parseInt(f.deadline);
		var now = AP.time.now();

		if (!e1) {
			e1 = AP.time.beginOfDay(now) - 1;
		}
		if (!f1) {
			f1 = AP.time.beginOfDay(now) - 1;
		}

		return f1 - e1;
	};
	
};




Project.filter=Board.filter;




Board.list=new function __BoardList(){
	this.display=function(project){
		this.build(project);
		var p=Me.pref();
		
		$("#tasklists .tasklist").each(function(){
			var collapsed=p.get([project.id, $(this).data("id"), Board.data.model.metatype]);
			if (collapsed && parseInt(collapsed)){
				$(this).addClass("-collapsed");
			}
		});
		
		$("#tasklists").click(function(e){
			Board.clean("#tasklists", e.target);
		});
		
		Board.engine.init();
		Project.subheader.init();
	};
	
	
	/**
	 * @desc Event call when a new task is inserted
	 */
	this.taskInserted=function(task){
		if (task.metatype=="subtask"){
			if (task.parent_id && parseInt(task.parent_id)){
				if (!$("#task-"+task.parent_id).length){
					return;
				}
				
				var $box=$("#task-"+task.origin_export.id).parent().find(".js-subtasks").first();
				$box.removeClass("no-tasks");
				$box.append(Board.ui.renderItem(task));
			}
			return;
		}
		
		var tasklist=TaskList.fromContext(task.tasklist_id);
		Board.list.group.update(tasklist);
	};
	
	
	
	/**
	 * @desc Event called when a task is updated
	 */
	this.taskUpdated=function(task){
		if (Board.mode!="list"){
			return;
		}
		
		$("#tasklists #task-"+task.id).replaceWith(Board.ui.getSingleHTML(task));
		// $("#tasklists .js-subtasks-p" + task.id).insertAfter($("#tasklists .li-"+task.id));
		
		Board.list.group.updateStats();
	};
	

	
	this.build = function(project){
		$("#tasklists").empty();
		
		for (var i = 0; i < Board.data.model.groups.length; i++){
			var g=Board.data.model.groups[i];
			var html = Board.list.group.get(g);
			$(html).appendTo("#tasklists");
		}
		
		Board.list.group.updateStats();
		
		$("#tasklists .js-form-wrap").each(function(){
			Task.form.bindEvents(this);
		});
	};
	


	this.editing=function(ref){
		var li_ref = $(ref).closest(".li");
		if (li_ref.hasClass("js-task") || li_ref.hasClass("js-subtask")) {
			li_ref.toggleClass("editing").siblings().removeClass("editing");
			var $input = li_ref.find("textarea[name=name]");
			
			if (!$input.hasClass("__ap_enter_binded")){
				$input.enter(function(){
					var name=$(this).val();
					var id=$(this).closest(".li").data("id");
					
					Task.inline.edit(id, {"key": "name", value: name}, this);
				});
			}
			
			setTimeout(function(){
				$input.focus();
				var val=$input.val();
				$input.val("").val(val);
			},200);
		}
	};
	
	
	this.toggleTasklist=function(id, ref){
		var $box=$("#tasklist-"+id);
		if (!$box.length || $box.data("id")!=id){
			$(ref).closest(".tasklist").toggleClass("-collapsed");
			return;
		}
		
		$box.toggleClass("-collapsed");
		
		if (Client.pageData.project && Board.data.model){
			if ($box.hasClass("-collapsed")){
				Base.pref().set([Client.pageData.project.id, id, Board.data.model.metatype], 1)
			}else{
				Base.pref().set([Client.pageData.project.id, id, Board.data.model.metatype], 0)
			}	
		}
	};
	
	
	this.togglePending=function(id, ref){
		$box=$(ref).closest(".prev-area");
		$box.toggleClass("-collapsed");
		
		if (Client.pageData.project && Board.data.model){
			if ($box.hasClass("-collapsed")){
				Base.pref().set([Client.pageData.project.id, id, Board.data.model.metatype, "pending"], 1)
			}else{
				Base.pref().set([Client.pageData.project.id, id, Board.data.model.metatype, "pending"], 0)
			}	
		}
	};
	
	
	this.showPerson = function (person) {
		var project = Client.pageData.project;

		Project.display.side(project);
		UI.pageCountdown("#tasklists .countdown", true);
		AP.on("new-task", function (task, log, origin) {
			Project.tasklist.update(origin, task, 'new-task');
		});
		UI.progression(project, "#project-main-graph", {title: false});

		var tasks = Client.pageData.user_tasks;

		$("#user-tasks").html(AP.render(tasks, Todo.html));
		Todo.daySeparation("#tasklist-tasks", function (time){
			
		});
	};
	
	
	
	function getPersonHTML(e){
		var info="Member since "+UI.simpleTime(e.since);
		var person=People.get(e.username);
		
		return "<div class='li -icon-left unselectable url' onclick=\"Project.showPerson('"+e.username+"');\">" +
			"	<div class='inner'>" +
				"	<span class='icon'><span class='image'><img src='"+AP.xthumb(e.gavatar)+"'/></span></span>" +
				"	<div class='text ap-xdot'>" +
				"		<div class='name'>"+person.name+"</div>" +
				"		<b>@"+person.username+"</b>" +
				"		<div class='info text-9'>"+person.title+"</div>" +
				"	</div>" +
			"	</div>" +
			"</div>";
	};
	
};


Board.list.group=new function __BoardListGroup(){
	this.get = function(g){
		// Default tasklist (no ID)
		if (!g.id){
			return "<div class='tasklist js-group -sf' data-id='"+(g.id)+"' id='tasklist-0'> "+(getGroup(g))+" "+(getInlineForm(g))+" <div class='js-tasklist-tasks'>"+(List.ui.getGroup(g))+"</div> </div>";
		}
		
		return "<div class='tasklist js-tasklist js-group cs-"+(TaskList.isClosed(g))+"' data-id='"+(g.id)+"' id='tasklist-"+(g.id)+"'> "+(getGroup(g))+" "+(getInlineForm(g))+" <div class='js-tasklist-tasks'>"+(List.ui.getGroup(g))+"</div> </div>";
	};
	
	
	this.update=function(tasklist){
		if ($("#js-list-marker").length){
			return;
		}
		
		$('#tasklist-' + tasklist.id + " .js-tasklist-tasks").html(getTasksInList(tasklist));
	};
	
	
	this.updateStats=function(){
		$("#tasklists .js-group").each(function(){
			var total=$(this).find(".li.js-task").length;
			var done=$(this).find(".li.js-task.-done").length;
			
			if (total>0){
				$(this).find(".group-header .istats").html("<em>"+(done)+"</em>/"+(total)+"");	
			}
		});
	};
	
	
	
	function getGroup(group){
		var metatype=Board.data.model.metatype;
		
		
		var name='';
		var info='';
		var actions='';
		var review_flag="";
		
		if (metatype=='tasklist'){
			if (Project.isManager()){
				var ab=Project.option.tasklist(group);
				if (ab.length()){
					actions="<div class='more -cmenuw'> <div class='-cmenu -padding -no-icon'>"+(ab.inline())+"</div> </div>";	
				}
			}
			
			if (group.review && parseInt(group.review.enabled)){
				var exp=explain("This tasklist required review<br>Reviewed by: @"+(group.review.users[0])+"", {icon: false});
				review_flag="<span class='-infow review-flag'>&#10026;"+(exp)+"</span>";
			}
			
			var desc="&nbsp;&mdash;&nbsp; "+(safe(group.content))+"";
			if (!group.content || !group.content.length){
				desc='';
			}
			
			name="<div class='name ap-xdot'> <span class='url' title='"+(group.name)+"' id='task-list-name-"+(group.id)+"' data-url='paction/0/tasklist.toggle' data-id='"+(group.id)+"'>"+(group.name)+"</span> <span class='desc'>"+(desc)+"</span> </div>";
			
			info=""+(actions)+"";
		}
		
		if (metatype=='milestone'){
			if (Project.isManager()){
				var ab=Project.option.milestone(group);
				actions="<div class='more -cmenuw'> <div class='-cmenu -padding -no-icon'>"+(ab.inline())+"</div> </div>";
			}
			
			if (group.id){
				var u=People.get(group.user_id);
				
				name="<div class='name -ext ap-xdot'> <div class='ext-icon'> <div class='cal'>"+(AP.time.time('<em>%V</em><span>%d/%m</span>', group.time))+"</div> </div> <span class='url' title='"+(group.name)+"' data-url='paction/0/tasklist.toggle' data-id='"+(group.id)+"'>"+(group.name)+"</span> <div class='info ap-xdot'><em>"+(AP.time.time('%V, %d/%m',group.time))+"</em> &mdash; "+(u.name)+" &mdash; "+(u.title)+"</div> </div>";
				
				info=""+(actions)+"";	
			}else{
				name="<div class='name ap-xdot'> <span class='url' title='"+(group.name)+"' id='task-list-name-"+(group.id)+"' data-url='paction/0/tasklist.toggle' data-id='"+(group.id)+"'>"+(group.name)+"</span> </div>";
			}
			
		}
		
		
		if (metatype=='user'){
			if (group.id){
				name="<div class='name -ext ap-xdot'> <div class='ext-icon'> <div class='avatar'><img src='"+(AP.xthumb(group.gavatar))+"'/></div> </div> <span class='url' title='"+(group.name)+"' data-url='paction/0/tasklist.toggle' data-id='"+(group.id)+"'>"+(group.name)+"</span> <div class='info ap-xdot'>"+(group.title)+"</div> </div>";
				
			}else{
				name="<div class='name ap-xdot'> <span class='url' title='"+(group.name)+"' id='task-list-name-"+(group.id)+"' data-url='paction/0/tasklist.toggle' data-id='"+(group.id)+"'>"+(group.name)+"</span> </div>";
			}
			
		}
		
		
		return "<div class='group-header -"+(metatype)+"' data-metatype='"+(metatype)+"'> <div class='-collapsed-mask url' data-url='paction/0/tasklist.toggle' data-id='"+(group.id)+"'></div> <div class='collapse url' data-url='paction/0/tasklist.toggle' data-id='"+(group.id)+"'><span class='ficon-caret-right'></span></div> <div class='title'> "+(name)+" <div class='right'>"+(info)+""+(getCreateLink(group))+""+(review_flag)+"<span class='istats'></span></div> </div> </div>";
	};


	
	function getCreateLink(group) {
		if (!Client.pageData.context || !parseInt(Client.pageData.context.acl.task_create)){
			return "";
		}
		
		var id=group.id;
		if (Board.data.model.metatype=="user" && group.uid){
			id=group.username;
		}
		
		return "<div class='group-cta url unselectable' data-url='groupaction/"+(Board.data.model.metatype)+"/"+(id)+"/taskinlinecreate'><div class='text js-add-task'>Thêm công việc</div></div>";
	};
	
	
	
	function getInlineForm(group){
		if (!Client.pageData.context || !parseInt(Client.pageData.context.acl.task_create)){
			return "";
		}
		
		var iform=Task.form.getForm({tasklist: group, context: Client.pageData.context});
		
		return "<div class='bform-wrapper js-form-wrap' id='js-taskiform-"+(group.id)+"' data-id='"+(group.id)+"' data-metatype='"+(Board.data.model.metatype)+"'> <div class='fcta'><div class='text js-add-task'>Thêm công việc</div></div> <div class='aform tasklist-"+(group.id)+"' id='txadd-"+(group.id)+"'>"+(iform)+"</div> </div>";

	};
	
	
};


List.ui = new function __BoardUI(){
	this.getHTML=function(task, opts){
		return this.renderItem(task, opts);
	};
	
	this.getSingleHTML=function(task, opts){
		return getInternalHTML(task, opts);
	};
	
	
	this.getGroup=function(group){
		if (Client.pageData.task_view=="period"){
			return getPeriod(group);
		}
		
		if (Board.data.model.grouped!=1){
			return "<div class='js-list-section list tasks -all'>"+(getTasksHTML(group.tasks))+"</div>";
		}else{
			var active=getTasksHTML(group.tasks, function(e){
				return parseInt(e.status)!=1;
			});
			
			var done=getTasksHTML(group.tasks, function(e){
				return parseInt(e.status)==1;
			});
			
			return "<div class='js-list-section -normal list tasks'>"+(active)+"</div> <div class='js-list-section -done list tasks'>"+(done)+"</div>";
		}
	};
	
	
	/**
	 * @desc Getting a period with a list of tasks
	 */
	function getPeriod(group){
		var count=AP.array.count(group.tasks, function(e){
			return !parseInt(e.status) && !Task.cs.current(e); 
		});
		
		if (count){
			count="(<b>"+(count)+"</b>)&nbsp;";
		}else{
			count='';
		}
		
		var prev_title="<div class='prev-title url pending-tasks' onclick='Board.list.togglePending("+(group.id)+", this);'>"+(count)+"Công việc chưa hoàn thành từ tg trước</div>";
		var collapsed='';
		
		if (Client.pageData.project && Base.pref().get([Client.pageData.project.id, group.id, Board.data.model.metatype, "pending"])){
			collapsed=' -collapsed';
		}
		
		if (Board.data.model.grouped!=1){
			var current=getTasksHTML(group.tasks, function(e){
				return Task.cs.current(e);
			});
			
			var prev=getTasksHTML(group.tasks, function(e){
				return !parseInt(e.status) && !Task.cs.current(e);
			});
			
			return "<div class='js-list-section list tasks -all'>"+(current)+"</div> <div class='js-list-prev prev-area"+(collapsed)+"'> "+(prev_title)+" <div class='js-list-section list tasks -prev'>"+(prev)+"</div> </div>";
			
		}else{
			var active=getTasksHTML(group.tasks, function(e){
				return Task.cs.current(e) && parseInt(e.status)!=1;
			});
			
			var done=getTasksHTML(group.tasks, function(e){
				return Task.cs.current(e) && parseInt(e.status)==1;
			});
			
			var prev=getTasksHTML(group.tasks, function(e){
				return !Task.cs.current(e) && !parseInt(e.status);
			});
			
			return "<div class='js-list-section -normal list tasks'>"+(active)+"</div> <div class='js-list-section -done list tasks'>"+(done)+"</div> <div class='js-list-prev prev-area"+(collapsed)+"'> "+(prev_title)+" <div class='js-list-section list tasks -prev'>"+(prev)+"</div> </div>";
		}
	};
	
	
	
		
	function getTasksHTML(tasks, filter) {
		var html = "";
		for (var i = 0; i < tasks.length; i++){
			if (!tasks[i].visible){
				continue;
			}
			
			if (filter && !filter(tasks[i])){
			}else{
				html += Board.ui.getHTML(tasks[i]);	
			}
		}
		
		return html;
	};
	
	
	
	this.renderItem = function(task){
		var html=getInternalHTML(task);
		var view_options=AP.pageConfig.get("subtasks");
		var subtasks="";
		
		if (Client.pageData.task_view=="period" || Client.pageData.task_view=="stream"){
			if (Query.get("subtask")=="hide" && task.metatype == "subtask"){
				return '';
			}else{
				view_options='natural';
			}
		}
		
		if (view_options=="nested"){
			subtasks=AP.render(task.subtasks, function(e){
				return List.ui.renderItem(e);
			});
			
			subtasks="<div class='js-subtasks subtasks-wrapper js-subtasks-p"+(task.id)+"'>"+(subtasks)+"</div>";
		}else if (view_options=="natural"){
			if (Client.pageData.project && Client.pageData.project.metatype=="project"){
				if (task.metatype=="task" && task.subtasks && task.subtasks.length){
					subtasks=AP.render(task.subtasks, function(e){
						return Board.ui.renderItem(e);
					});
					
					subtasks="<div class='js-subtasks subtasks-wrapper js-subtasks-p"+(task.id)+"'>"+(subtasks)+"</div>";
				}else if (task.metatype=="task"){
					subtasks="<div class='js-subtasks subtasks-wrapper no-subtasks'></div>";
				}
			}else{
				if (Client.pageData.project && task.subtasks){
					subtasks=AP.render(task.subtasks, function(e){
						return List.ui.renderItem(e);
					});
					
					var more='';
					if (task.cached_subtasks && task.subtasks.length > task.cached_subtasks.length && task.metatype=="task"){
						more="<div class='subtask-more url' data-url='task/"+(task.id)+"'>Show more subtasks</div>";
					}
					
					subtasks="<div class='js-subtasks subtasks-wrapper js-subtasks-p"+(task.id)+"'>"+(subtasks)+"</div> "+(more)+"";
				}else{
					subtasks="<div class='js-subtasks subtasks-wrapper js-subtasks-p"+(task.id)+"'>"+(Board.sublist.getCachedSubtasks(task))+"</div>";	
				}
				
			}
		}
		
		html= ""+(html)+""+(subtasks)+"";
		
		if (task.metatype=="task"){
			var sortable=Board.filter.sortEnabled()?"<div class='sx'><span></span></div>":'';
			var idx="";
			
			if (Board.filter.sortEnabled()){
				idx="<div class='idx'></div>";
			}
			
			html="<div class='task-wrapper js-task' data-metatype='"+(task.metatype)+"' data-keywords='"+(task.keywords)+"' data-id='"+(task.id)+"'> "+(sortable)+""+(idx)+""+(html)+" </div>";
		}else{
			html=""+(html)+"";
		}
		
		return html;
	};

	
	function getInternalHTML(task){
		var status_class=(parseInt(task.status)?" -done":" -xdone");
		if (Compute.doneLate(task)){
			status_class+=' -late';
		}
		
		var check = "<div class='check url' data-xurl='action/"+(task.id)+"/check' data-status='"+(task.status)+"' data-acl='"+(task.acl.status)+"'> <div class='task-status "+(status_class)+"'></div> </div>";
		
		var ec = [];
		if (parseInt(task.status)){
			ec.push("-done");
		}
		
		if (parseInt(task.acl.review_enabled)){
			ec.push("-review");
		}
		
		if (!parseInt(task.acl.status)){
			ec.push("-locked");
		}
		
		
		var project=null;
		if (task.ns){
			project=Project.fromContext(task.ns.id);
		}
		
		var icons=Task.ui.icons(task, project);
		var labels=Task.ui.labels(task, project);


		if (Compute.doneLate(task) || Compute.overdue(task)){
			ec.push("-overdue");
		}

		if (Compute.dueToday(task)){
			ec.push("-due-today");
		}
		
		var user=null;
		
		var assign="<div class='assign -unassign url' data-xurl='action/"+(task.id)+"/assign' data-acl='"+(task.acl.assign)+"'> <div class='avatar'> <div class='imagew'><div class='user-add'></div></div> </div> <div class='fname ap-xdot -empty'>Giao việc</div> </div>";

		user=People.get(task.user_id);
		if (parseInt(task.user_id) && !user.error){
			assign="<div class='assign url -infow' data-xurl='action/"+(task.id)+"/assign' data-acl='"+(task.acl.assign)+"'> <div class='avatar'> <div class='image imagew'><img src='"+(AP.xthumb(user.gavatar))+"'/></div> </div> <div class='fname ap-xdot'>"+(user.first_name)+"</div> "+(explain(user.name+' @ '+user.username, true))+" </div>";
		} else if (!parseInt(task.acl.unassign)){
			assign="<div class='assign -unassign url'> <div class='avatar'><div class='imagew'><div class='lock ficon-lock'></div></div></div> <div class='fname ap-xdot -empty'>Unassign</div> </div>";
		}

		
		var star_icon = "<div class='icon star url' data-xurl='action/"+task.id+"/star' title='Đánh dấu ưu tiên'><span class='-ap icon-uniF186'></span></div>";
		if (UI.fav.isFav(task.id, Client.pageData.favs)){
			star_icon = "<div class='icon star -star url' data-xurl='action/"+task.id+"/star' title='Đánh dấu ưu tiên'><span class='-ap icon-star-full'></span></div>";
			ec.push("-starred");
		}

		var tlabels = AP.render(labels, function(e){
			if (e.url && e.url.length){
				return "<span class='label "+e.style+" url' data-xurl='"+e.url+"'>" + e.name + "</span>";
			}
			
			return "<span class='label "+e.style+"' data-xurl='"+e.url+"'>" + e.name + "</span>";
		});
		
		var icons_html = AP.render(icons, function(e){
			return "<span class='icon url -infow' data-xurl='"+(e.url)+"' data-acl='"+(e.acl)+"' data-value='"+(e.value)+"'> <span class='"+(e.icon)+"'></span> "+(explain(e.title, true))+" </span>";
		});
		
		var review_status="";
		if (parseInt(task.acl.review_enabled)){
			review_status=getReviewStatus(task);
		}
		
		var real_title="Tạo bởi @"+(task.creator_username)+" lúc "+(AP.i18n.datetime(task.since))+" | Order: "+(task.real_order)+"";
		var content=""+(Task.ui.getLocalLink(safe(task.content)))+" &middot;";
		if (!task.content || !task.content.length){
			content="No description &middot;"
		}
		
		var infos=Task.ui.info(task, project);
		
		var subtask_icon="";
		if (task.metatype=="subtask" || !task.metatype){
			subtask_icon="<div class='subtask-icon'></div>";
		}
		
		var html= "<div id='task-"+(task.id)+"' data-real_order='"+(task.real_order)+"' data-status='"+(task.status)+"' data-keywords='"+(task.keywords)+"' class='js-"+(task.metatype)+" li li-"+(task.id)+" -"+(Task.ui.grandState(task))+" "+(ec.join(' '))+"' data-id='"+(task.id)+"' data-user='"+(task.user_id)+"' data-username='"+(task.username)+"' data-deadline='"+(task.deadline)+"' data-starred='"+(task.starred)+"' data-complete='"+(task.complete)+"'> "+(subtask_icon)+" <div class='r'></div> <div class='rsep'></div> <div class='name'> <div class='ap-xdot' data-url='task/"+(task.id)+"'> <div class='mn'> <span class='url' data-url='task/"+(task.id)+"' title='"+(real_title)+"'>"+(task.name)+"</span> "+(infos)+" </div> </div> </div> <div class='xedit'> <textarea name='name' type='text' placeholder='Sửa công việc'>"+(task.name)+"</textarea> <span class='cancel url' data-xurl='action/0/mask'>Hủy</span> </div> "+(check)+" <div class='sicons'> "+(star_icon)+"</div> <div class='actions'>"+(icons_html)+"</div> <div class='timebox'> <div class='tx duration'>"+(Task.ui.grandDeadline(task))+"</div> </div> "+(assign)+" <div class='desc'> "+(review_status)+" <div class='content'> <div class='ap-xdot'> <div class='labels'>"+(tlabels)+"</div> <span class='inner'> "+(content)+" Created by @"+(task.creator_username)+" </span> </div> </div> </div> <div class='keywords' style='display:none'>"+(getKeywords(task))+"</div> </div>";
		
		return html;
	};
	
	
	this.scrollTop = function() {
		$('#project-canvas .scrollin').animate({scrollTop: 0}, 200);
	};
	

	function getKeywords(item) {
		var kw = "";
		kw += "@"+item.username+ " "+item.name;
		
		return kw;
	};
	
	
	function getReviewStatus(task){
		if (task.metatype=="subtask"){
			return "";
		}
		
		if (parseInt(task.status)){
			if (parseInt(task.acl.review)){
				return "<div class='review-status -done url' data-xurl='action/"+task.id+"/review' data-value='"+task.status+"'><span>Đã xong</span></div>";
			}else{
				return "<div class='review-status -done'><span>Đã xong</span></div>";
			}	
		}
		
		if (parseInt(task.review)){
			if (parseInt(task.acl.review)){
				return "<div class='review-status -review -dx url' data-xurl='action/"+task.id+"/review' data-value='"+task.status+"'><span class='anim-showhide-inf'>Đánh giá</span></div>";
			}
			
			return "<div class='review-status -review'><span class='anim-showhide-inf'>Đánh giá</span></div>";
		}
		
		return "<div class='review-status'><span>Đang làm</span></div>";
	};
};



// FIX
Board.ui=List.ui;


Board.engine=new function __BoardEngine(){
	/**
	 * @desc Get all possible inline actions for tasks
	 */
	this.getActions=function(task){
		
	};
	
	
	/**
	 * @desc Init the context menu
	 */
	this.init=function(){
		return;
		
		$("#tasklists").on("contextmenu", function(e){
			if (e.ctrlKey || $("#js-inline-edit").is(":visible")){
				return true;
			}
			
			e.preventDefault();
			$("#js-main-table .tr").removeClass("focused");
			
			var row=$(e.target).closest(".js-task");
			var id=row.data("id");
			
			row.addClass("selected");
			var task=AP.array.findObj(Client.pageData.tasks, id);
			if (!task){
				return;
			}
			
			var u=People.get(task.user_id);
			var content=task.content;
			if (!content){
				content="No description";
			}
			
			var image="<div class='image'> <img src='"+(AP.xthumb(u.gavatar))+"'/> </div>";
			
			if (!parseInt(task.user_id) || !parseInt(u.uid)){
				image="<div class='image -none'></div>";
			}
			
			var task_html="<div class='task-contextmenu'> "+(image)+" <div class='task-title ap-xdot url' data-url='task/"+(id)+"'>"+(task.name)+"</div> <div class='task-info ap-xdot'>"+(safe(content))+"</div> </div>";
			
			var menu=[
				task_html,
				"---",
				{
					label: "Edit task info", 
					icon: "ficon-pencil-square",
					url: "board/"+(row.data('id'))+"/gedit",
					data: {acl: 1}
				},
				{
					label: "Set duration", 
					icon: "ficon-pencil-square",
					url: "board/"+(row.data('id'))+"/gedit",
					data: {acl: 1}
				},
				{
					label: "Edit deadline", 
					icon: "ficon-pencil-square",
					url: "board/"+(row.data('id'))+"/gedit",
					data: {acl: 1}
				},
				{
					label: "Edit start time", 
					icon: "ficon-pencil-square",
					url: "board/"+(row.data('id'))+"/gedit",
					data: {acl: 1}
				},
				{
					label: "Add a new subtask", 
					icon: "ficon-indent",
					url: "board/"+(row.data('id'))+"/subtask",
					data: {acl: 1}
				},
				"---",
				{
					label: "Show task", 
					icon: "ficon-external-link-square",
					url: "task/"+(row.data('id'))+""
				},
				{
					label: "Duplicate task ...", 
					icon: "ficon-copy",
					url: "board/"+(row.data('id'))+"/duplicate",
					data: {acl: 1}
				},
				{
					label: "Duplicate to another project ...", 
					icon: "ficon-copy",
					url: "board/"+(row.data('id'))+"/duplicate.external",
					data: {acl: 1}
				},
				"---",
				{
					label: "Clear task deadline", 
					icon: "ficon-exclamation-circle",
					url: "board/"+(row.data('id'))+"/delete-deadline",
					data: {acl: 1}
				},
				{
					label: "Clear task starting time", 
					icon: "ficon-exclamation-circle",
					url: "board/"+(row.data('id'))+"/delete-startime",
					data: {acl: 1}
				},
				{
					label: "Remove task", 
					icon: "icon-uniF11F",
					url: "action/"+(row.data('id'))+"/remove",
					data: {acl: 1},
					css: "red"
				},
			];
			
			var top=e.pageY+8;
			var left=e.pageX;
			
			return Context.menu({x: left, y: top, type: "click"}, {menu: menu, layout:'compact', close: function(){
				$("#js-main-table .tr").removeClass("focused");
			}});
		});
	};
};


Board.sublist=new function __BoardSublist(){
	this.getCachedSubtasks=function(task){
		if (!task.cached_subtasks){
			return "";
		}
		
		if (AP.pageConfig.get("hide_all_subtasks") || AP.pageConfig.get("team_subtasks")==-1){
			return "";
		}
		
		var html="";
		for (var i=0; i<task.cached_subtasks.length; i++){
			task.cached_subtasks[i].acl={status: getStatus(task.cached_subtasks[i])};
			html+= List.ui.getHTML(task.cached_subtasks[i]);	
		}
		
		return "<div class='sublist'>"+(html)+"</div>";
	};
	
	
	this.update=function(task){
		$(".sublist #task-"+task.id).replaceWith(List.ui.getHTML(task));
	};
	
	function getStatus(task){
		if (task.user_id==Client.viewer.id || task.creator_id==Client.viewer.id){
			return 1;
		}
		
		if (Client.pageData.project && Project.isManager()){
			return 1;
		}
		
		return 0;
	};
};



Board.kb=new function __BoardKB(){
	this.mode="default";
	
	this.build=function(canvas){
		$(canvas).empty().html("<div class='stages clear-fix'></div>");
		var id=AP.uuid();
		var ew=0;
		
		if (Board.data.model.metatype=="tasklist" || Project.isManager()){
			ew=300;
		}
		
		
		var w=Board.data.model.groups.length*280+ew;
		if (w<$(window).width()){
			w=$(window).width();
		}
		
		$(canvas).find(".stages").attr("id", id).css("width", w);
		buildBoard(canvas);
		
		setHeight(canvas);
		AP.html.resize(function(){
			setHeight(canvas);	
		});
		
		$("#project-master").addClass("pboard");
		initBackground();
		
		$("#main-board").click(function(e){
			Board.clean("#main-board", e.target);
		});
		
		Board.kb.group.updateStats();
		
		if (!mobile()){
			$("#main-board").after(getStats());	
		}
		
		if (Client.pageData.project.metatype=="team"){
			initContinuousLoading();
		}
		
		$("#main-board").on("scroll", function(){
			var h=$(this).scrollTop();
			$(this).find(".stage .header").css({top: h+"px"});
			
			if (h>10){
				$(this).find(".stage .header").addClass("scrolled");
			}else{
				$(this).find(".stage .header").removeClass("scrolled");
			}
		});
	};
	
	
	this.refresh=function(){
		$("#main-board .stages").empty();
		buildBoard("#main-board");
		Board.kb.group.updateStats();
		Board.dnd();
	};
	
	
	this.taskUpdated=function(task){
		$("#js-task-"+task.id).replaceWith(getTask(task));
		Board.kb.group.updateStats();
		Board.updateEvents(task);
	};
	

	this.taskInserted=function(task){
		$("#main-board .js-stage-"+task.tasklist_id+" .items").prepend(getTask(task));
		Board.kb.group.updateStats();
	};
	
	
	function setHeight(canvas){
		var max=$(canvas).height()-100;
		$("#main-board .stages .stage").each(function(){
			var h=$(this).height();
			if (h>max){
				max=h;
			}
		});
		
		$(canvas).find(".stage").css("height", max);
	};
	
	
	function buildBoard(canvas){
		for (var i=0; i<Board.data.model.groups.length; i++){
			addStage(canvas, Board.data.model.groups[i]);
		}
		
		
		addCreatingStage(canvas);
	};
	
	function addStage(canvas, group){
		var tasklist_closed = '';
		var metatype=Board.data.model.metatype;
		
		if (metatype == 'tasklist'){
			var start=AP.time.now();
			var end=AP.time.now();
			var tasklist_closed = "cs-" + TaskList.isClosed(group, start, end);
		}	

		
		var stage_html="<div class='stage js-bucket "+(tasklist_closed)+" js-tasklist js-stage-"+(group.id)+"' id='js-stage-"+(group.id)+"' data-id='"+(group.id)+"' data-metatype='"+(metatype)+"'> <div class='r'></div> "+(getHeader(group))+" <div class='body'> <div class='wrap-in'> <div class='create-form'> <div id='js-create-form-"+(group.id)+"'></div> </div> <div class='items js-set'>"+(getTasks(group.tasks))+"</div> </div> </div> </div>";
		
		$(canvas).find(".stages").append(stage_html);
		
		if (parseInt(Client.pageData.project.acl.task_create)){
			buildInlineForm(group);	
		}
		
	};
	
	
	function addCreatingStage(canvas){
		if (Board.data.model.metatype=="tasklist"){
			var html="<div class='stage'> <div class='header' onclick='TaskList.create();'> <div class='name -add' title='Create tasklist'> <div class='gicon'><span class='-ap icon-plus2'></span></div> Thêm tasklist mới </div> <div class='bar'></div> <div> </div>";
			
			$(canvas).find(".stages").append(html);
		}
		
		
		if (Board.data.model.metatype=="milestone" && Project.isManager()){
			var html="<div class='stage'> <div class='header' onclick='Milestone.create();'> <div class='name -add' title='Create milestone'> <div class='gicon'><span class='-ap icon-plus2'></span></div> Thêm mục tiêu mới </div> <div class='bar'></div> <div> </div>";
			
			$(canvas).find(".stages").append(html);
		}
		
		
		if (Board.data.model.metatype=="user" && Project.isManager()){
			var html="<div class='stage'> <div class='header' onclick='Project.people.add();'> <div class='name -add' title='Add members'> <div class='gicon'><span class='-ap icon-plus2'></span></div> Thêm thành viên mới </div> <div class='bar'></div> <div> </div>";
			
			$(canvas).find(".stages").append(html);
		}
	};
	
	
	function getHeader(group){		
		return Board.kb.group.getHTML(group);
	};
	
	
	function getTasks(items){
		if (Board.data.model.grouped==1){
			var active= AP.render(items, function(e){
				if (parseInt(e.status)){
					return "";
				}
				
				return getTask(e);
			});
			
			var done= AP.render(items, function(e){
				if (!parseInt(e.status)){
					return "";
				}
				
				return getTask(e);
			});
			
			if (done.length){
				done="<div class='label-sep'><span>Công việc đã hoàn thành</span></div>" + done;
			}
			
			return active + done;
		}else{
			return AP.render(items, function(e){
				return getTask(e);
			});
		}
	};
	
	
	function getTask(task){
		if (!task.visible || task.metatype!="task"){
			return "";
		}
		
		return "<div class='item js-task -status-"+(task.status)+"' id='js-task-"+(task.id)+"' data-id='"+(task.id)+"' data-sid='"+(task.tasklist_id)+"' data-keywords='"+(task.keywords)+"'> "+(getTaskInner(task))+" </div>";
	};
	
	
	function getTaskInner(item){
		var u=People.get(item.username);
		
		var assign="<div class='assign -unassign relative url' data-xurl='action/"+item.id+"/assign' data-acl='"+item.acl.assign+"' data-view='board'>"+
		"	<div class='avatar'><span class='user-add'></span></div>" +
		"	<div class='deadline ap-xdot'><span class='none'>Giao việc</span></div>" +
		"</div>";
		
		if (!parseInt(item.acl.assign)){
			assign="<div class='assign -unassign relative url' data-xurl='action/"+item.id+"/assign' data-acl='"+item.acl.assign+"' data-view='board'>"+
			"	<div class='avatar'><span class='c'><span class='lock ficon-lock'></span></span></div>" +
			"	<div class='deadline ap-xdot'><span class='none'>Chưa giao</span></div>" +
			"</div>";
		}
		
		if (u && u.id){
			assign="<div class='assign relative url' data-xurl='action/1/assign' data-acl='"+item.acl.acl+"' data-view='board'>"+
			"	<div class='avatar'><img src='"+AP.xthumb(u.gavatar)+"'/></div>" +
			"	<div class='deadline ap-xdot'><span class='none'>"+u.first_name+"</span></div>" +
			"</div>";
		}
		
		
		var icons=[];
		
		if (parseInt(item.deadline)){
			icons.push({icon: "-ap icon-uniF10B", text: AP.time.time("%d/%m", item.deadline), url:"action/"+item.id+"/deadline", acl: item.acl.time})
		}else{
			if (parseInt(item.acl.time)){
				// icons.push({icon: "-ap icon-uniF10B", url:"action/"+item.id+"/deadline", acl: item.acl.time})	
			}
		}
		
		if (parseInt(item.urgent)){
			icons.push({icon: "ficon-exclamation-circle text-alt8", url:"action/"+item.id+"/urgent", acl: item.acl.desc})
		}
		
//		if (Task.fav.isFav(item.id)){
//			icons.push({icon: "-ap icon-star-full hl", url:"action/"+item.id+"/star"});
//		}else{
//			icons.push({icon: "-ap icon-star-empty", url:"action/"+item.id+"/star"});
//		}

		var review_class = '';
		var review_title = '';
		if (item.review == 1 && item.status == 0){
			// var review_class = 'review anim-showhide-inf';
			var review_title = "title='Công việc đang chờ được đánh giá bởi người giám sát'";
			icons.push({icon: "ficon-pause-circle anim-showhide-inf text-alt6", url:""})
		}

		var overdue_class = '';
		if (parseInt(item.overdue)){
			var overdue_class = 'kanban-overdue';
		}
		
		var tags_html="";
		var icons_html=AP.render(icons, function(e){
			if (e.text){
				return "<span class='icon url' data-view='board' data-xurl='"+e.url+"' data-acl='"+e.acl+"'><span class='"+e.icon+"'></span><span class='txt "+overdue_class+"'>&nbsp; "+e.text+"</span></span>";
			}else{
				return "<span class='icon url' data-view='board' data-xurl='"+e.url+"' data-acl='"+e.acl+"'><span class='"+e.icon+"'></span></span>";	
			}
		});
		
		
		if (item.__compute.files){
			icons_html="<span class='icon url' data-url='task/"+item.id+"' title='Attachments'><span class='-ap icon-uniF10A'></span><span class='txt'>"+item.__compute.files+"</span></span> "+icons_html;
		}
		
		if (item.__compute.checklists){
			icons_html="<span class='icon url' data-url='task/"+item.id+"' title='Checklists'><span class='-ap icon-uniF10E'></span> <span class='txt'>"+item.__compute.checklists+"</span></span> "+icons_html;
		}
		
		var tags=Project.taglist.parse(item.tags, Client.pageData.context);
		tags_html=AP.render(tags, function(e){
			return "<div class='tag url -bg-alt"+e.color+"-edge' data-xurl='action/filter/"+e.name+"' title='"+e.name+"'><span>"+e.name+"</span></div>";
		});
		
		
		if (tags.length){
			var list_tags = AP.array.select(tags, function(e){
				return e.name;
			});

			tags_html="<div class='tags clear-fix -collapsed url' data-view='board' data-value='"+list_tags.join(",")+"' title='"+list_tags.join(",")+"'>" + tags_html+"</div>";
		}
		
		var check="<div class='cb url "+(parseInt(item.status)?"-done":"")+"' data-status='"+item.status+"' data-xurl='action/"+item.id+"/check' data-acl='"+item.acl.status+"'><div class='task-status'></div></div>";
		
		if (Client.pageData.context && Client.pageData.context.template=="staging"){
			check="";
		}
		
		
		var cover_html="";
		if (item.cover){
			var src = item.cover.link;
			cover_html="<div class='cover url' data-url=':zoom' data-image='"+src+"'><div class='bound'><img src='"+src+"'/></div></div>";
		}

		var desc="<div class='desc'><div class='dr'></div> <div class='ap-xdot'>"+(item.content_short)+"</div> </div>";
		if (!item.content_short || !item.content_short.length){
			desc='';
		}
		
		return "<div class='item-cover'>"+(cover_html)+" "+(tags_html)+"</div> <div class='item-body relative'> "+(check)+" <div class='w url' "+(review_title)+" data-xurl='task/"+(item.id)+"'></div> <div class='name "+(review_class)+"'>"+(item.name)+"</div> "+(desc)+" <div class='info'> "+(assign)+" <div class='icons'>"+(icons_html)+"</div> </div> </div>";
	};
	
	
	
	function updateCounter(){
		$("#main-board .stage").each(function(){
			$(this).find(".header .count").html($(this).find(".item").length);
		});
	};
	

	function buildInlineForm(group){
		var options={};
		options.group=group;
		options.project=Client.pageData.project;
		return Project.tform.build(options);
	};
	
	
	function getTasklistIDs(){
		var ids=[];
		$("#main-board .stages .stage").each(function(){
			var sid=$(this).data("sid");
			if (parseInt(sid)){
				ids.push(sid);
			}
		});
		
		return ids;
	};
	
	
	
	function getStats(){
		var total=0, done=0, review=0, overdue=0;
		
		for (var i=0; i<Client.pageData.tasks.length; i++){
			var e=Client.pageData.tasks[i];
			total++;
			if (parseInt(e.overdue)){
				overdue++;
			}
			
			
			if (parseInt(e.status)){
				done++;
			}else if (parseInt(e.review)){
				review++;
			}
			
		}
		
		return "<div id='board-stats'><div class='items'>" +
			"<div class='item'><div class='s -bg-main'></div> <em>"+total+"</em> công việc</div>  " +
			"<div class='item'><div class='s -bg-alt4'></div> <em>"+done+"</em> hoàn thành</div> " +
			"<div class='item'><div class='s -bg-alt6'></div> <em>"+review+"</em> chờ review</div> " +
			"<div class='item'><div class='s -bg-alt8'></div> <em>"+overdue+"</em> quá hạn</div>" +
		"</div></div>";
	};
	
	
	
	this.page=0;
	this.onLoadingMore=false;
	
	/**
	 * @desc Init continuous loading of board view
	 */
	function initContinuousLoading(){
		Board.kb.page=1;
		Board.kb.onLoadingMore=false;
		
		$("#main-board").on("scroll", function(){
			var top=$(this).scrollTop();
			var h=$(this).innerHeight();
			var diff=top+h-$(this)[0].scrollHeight;
			
			if (diff>=0 && !Board.kb.onLoadingMore){
				Board.kb.onLoadingMore=true;
				Board.kb.page++;
				
				var params=Query.release();
				params.page=Board.kb.page;
				params.project_id=Client.pageData.project.id;
				params.view="board";
				
				UI.ajaxShow();
				AP.post("api/project/more.tasks", params, function(code){
					UI.ajaxHide();
					
					if (!code.good()){
						$.log("ERROR");
						return;
					}
					
					if (!code.tasks.length){
					}else{
						setTimeout(function(){
							Board.kb.onLoadingMore=false;
						}, 2000);
					}
					
					Board.data.insertList(code.tasks);
					Board.kb.refresh();
				});
			}
		});
	}
	
	
	
	function initBackground(){
		if (mobile()){
			return;
		}
		
		var index=(parseInt(Client.pageData.context.id)%3)+1;
		var default_bg=Client.image_url+'/bg/'+index+'.jpg';
		if (!Client.pageData.context || !Client.pageData.context.bg){
			return;
		}
		
		var type=Client.pageData.context.bg.type;
		
		var opt=parseFloat(Client.pageData.context.bg.mask);
		if (!opt || opt<0 || opt>100){
			opt=50;
		}
		
		var mask="<div class='wbg-mask' style='opacity: "+(opt/100)+"; filter: alpha(opacity="+(opt)+");'></div>";
		
		if (type=="image"){
			var url=Client.pageData.context.bg.url;
			$("#project-master").addClass("wbg");
			$("#header").addClass("wbg");
			$("#document").addClass("wbg").prepend("<div id='background' class='bg'><div class='fbg' style='background-image: url("+url+"); background-size: cover;'></div>"+mask+"</div>");
			
			var br=(parseInt(Client.pageData.context.bg.blurry)*13/60);
			
			$("#document .fbg").css({"-webkit-filter": "blur("+br+"px)", "filter": "blur("+br+"px)"});
			
		}else if (type=="dark"){
			$("#project-master").addClass("wbg");
			$("#header").addClass("wbg");
			$("#document").addClass("wbg").prepend("<div id='background' class='bg'><div class='fbg' style='background-image: url("+default_bg+"); background-size: cover;'></div>"+mask+"</div>");
		}else if (type=="default" || type=="color"){
			$("#project-master").addClass("wbg").prepend("<div id='background' class='stdfill'><div class='fill'></div>"+mask+"</div>");
			$("#header").addClass("wbg");
		}
	};
	
};


Board.kb.group=new function __BoardKBGroup(){
	this.getHTML=function(group){
		var metatype=Board.data.model.metatype;
		var actions='';
		var ec='';
		
		if (metatype=="tasklist"){
			if (Project.isManager() && group.id){
				ec=' -dd';
				actions="<div class='actions -cmenuw'> <div class='-cmenu -no-icon -padding'>"+(Project.option.tasklist(group).inline())+"</div> </div>";
			}
			
			return "<div class='header "+(ec)+"'> <div class='name ap-xdot' title='"+(group.name)+"'> <div class='gicon'><span class='-ap icon-list-unordered'></span></div> "+(group.name)+" </div> <div class='count'></div> <div class='bar'><div class='c'></div></div> "+(actions)+" </div>";	
		}
		
		if (metatype=="milestone"){
			if (Project.isManager() && group.id){
				ec=' -dd';
				actions="<div class='actions -cmenuw'> <div class='-cmenu -no-icon -padding'>"+(Project.option.milestone(group).inline())+"</div> </div>";
			}
			
			var name="["+(AP.time.time('%d/%m',group.time))+"] <span class='sub'>"+(group.name)+"</span>";
			if (!group.id || !group.time){
				name=group.name;
			}
			
			return "<div class='header "+(ec)+"'> <div class='name ap-xdot' title='"+(group.name)+"'> <div class='gicon'><span class='icon-base-calendar'></span></div> "+(name)+" </div> <div class='count'></div> <div class='bar'><div class='c'></div></div> "+(actions)+" </div>";	
		}
		
		
		if (metatype=="user"){
			var img="<img src='"+(AP.xthumb(group.gavatar))+"'>";
			var user="<span class='url' data-username='"+(group.username)+"'>"+(group.name)+"</span>";
			
			if (!group.uid || !parseInt(group.uid)){
				img='';
				user=""+(group.name)+"";
			}
			
			return "<div class='header'> <div class='name -cmenuw' title='"+(group.name)+"'> <div class='gicon'><div class='gimg'>"+(img)+"</div></div> "+(user)+" </div> <div class='count'></div> <div class='bar'><div class='c'></div></div> </div>";	
		}
	};
	
	
	this.updateStats=function(){
		$("#main-board .stages .stage").each(function(){
			var total=$(this).find(".item.js-task").length;
			var done=$(this).find(".item.js-task.-status-1").length;
			
			$(this).find(".header .count").html(""+(done)+"/"+(total)+"");
			var percent=0;
			if (total>0){
				percent=done*100/total;
			}
			
			$(this).find(".header .bar .c").css("width", percent+"%").attr("title", percent.toFixed(2)+"% completed");
		});
	};
	
};







Board.table=new function __BoardTable(){
	this.display=function(){
		Board.mode="table";
		
		initCanvas();
		initFooter();
		
		this.cell={width: 18, height: 29};
		var model=Board.data.model;
		

		this.width=1200+getTotalWidth();
		this.height=50+getTotalHeight(30);
		
		if (this.height<$(window).height()-80){
			this.height=$(window).height()-80;
		}
		
		this.summary=Project.summary.basic();
		
		var context=Client.pageData.context;
		var header=getCols(context);
		var body='';
		
		$("#js-main-table").css("min-height", 1000);
		$("#js-gantt-table").css("min-height", 1000);

		for (var i=0; i < model.groups.length; i++){
			body+=Board.table.group.getHTML(model.groups[i]);
			body+="<div class='js-group-wrapper' data-id='"+(model.groups[i].id)+"' data-metatype='"+(model.metatype)+"'>";
			
			var tasks = model.groups[i].tasks;
			for (j=0; j < tasks.length; j++){
				if (parseInt(tasks[j].visible)){
					body += getTaskHTML(tasks[j], j+1);
				}
			}
			
			body+='</div>';
		}

		$("#js-main-table .table").html("<div class='thead'>"+(header)+"</div> <div class='tbody'>"+(body)+"</div>");
		
		this.sdate=this.summary.gantt_start;
		this.edate=this.summary.gantt_end;
		this.range=Math.floor((this.edate-this.sdate)/(24*3600));

		var view=Base.pref().get(["gantt_gview", Client.pageData.project.id]);
		if (!view){
			view="gantt";
		}
		
		if (view=="gantt"){
			$("#board-table .section.gantt-table").show();
			Board.gantt.init();	
		}else{
			$("#board-table .section.custom-table").show();
			Board.ctable.init();
		}
		
		initScroller();
		
		$("#board-table").click(function(e){
			Board.clean("#board-table", e.target);
		});
		
		BaseTable.init("#js-main-table .table", {
			height: "auto",
			width: "auto",
			layout: "list",
			events: false
		});
		
		Board.dnd();
	};



	this.taskUpdated=function(task){
		if (!Client.pageData.context){
			return;
		}

		$("#js-main-table .task-"+task.id).replaceWith(getSingleTaskHTML(task));
		BaseTable.update("#js-main-table .task-"+task.id);
		Board.gantt.taskUpdated(task);
		Board.ctable.taskUpdated(task);
	};


	this.showInlineForm=function(ref){
	};

	
	/**
	 * @desc Get column
	 */
	function getCols(context){
		var std_cols="<div class='th' data-width='36'><div class='w'><span class='square'></span></div></div> <div class='th stroked' data-width='250'><div class='w'>Công việc</div></div>";
		if (parseInt(context.acl.task_create)){
			std_cols="<div class='th' data-width='36'>&nbsp;</div> <div class='th stroked' data-width='250'><div class='w -add' onclick='Project.tform.dialog();'>Thêm công việc mới</div> </div>";
		}
		
		return "<div class='tr cols xo'> <div class='th' data-width='10' style='padding:0; border-right:none'></div> "+(std_cols)+" <div class='th' data-width='50'><div class='w ext-label'>Start &rsaquo; deadline</div></div> <div class='th' data-width='50'><div class='w'></div></div> <div class='th' data-width='50'><div class='w ext-label'>Finished at</div></div> <div class='th' data-width='64'><div class='w'><div class='ap-xdot'></div></div></div> </div>";
	};

	
	/**
	 * @desc Add task
	 */
	function addTask(task, index){
		if (task.acl.view && parseInt(task.acl.view) == 1) {
			$("#js-main-table table").append(getTaskHTML(task, index));
		}
	};


	function getTaskHTML(task){
		var subtasks=AP.pageConfig.get("subtasks");
		
		return getSingleTaskHTML(task)+AP.render(task.subtasks, function(e){
			if (subtasks=="natural"){
				return getSingleTaskHTML(e);
			}
			
			return getTaskHTML(e);
		});
	};
	
	function getSingleTaskHTML(task){
		var level=getLevel(task);
		
		var context=Client.pageData.context;
		var is_active = (Query.getInt('task') !== 0 && Query.getInt('task') === parseInt(task.id)) ? "is-active" : "";

		var ec=[];
		if (parseInt(task.status)){
			ec.push("-done");
		}

		var assign="<div class='cu'><div class='avatar'><div class='image'><div class='user-add'></div></div></div> <div class='cu-name text-9'>Giao việc</div>";
		var u=People.get(task.username);
		if (u && u.id){
			assign="<div class='cu' title='"+u.name+" / "+u.title+"'><div class='image'><img src='"+AP.xthumb(u.gavatar)+"'/></div> <div class='cu-name ap-xdot'>"+u.first_name+"</div></div>";
		}

		var creator="<span class='none'>Giao việc</span>";
		var u=People.get(task.creator_username);
		if (u && u.id){
			creator="<div class='cu' title='"+u.name+" / "+u.title+"'><div class='image'><img src='"+AP.xthumb(u.gavatar)+"'/></div> <div class='cu-name ap-xdot'>"+u.first_name+"</div></div>";
		}


		var urgent="<span class='ddb'>Bình thường</span>";
		if (parseInt(task.urgent)){
			urgent="<span class='ddb -alert'>Khẩn cấp</span>";
		}
		
		var start_time="<span class='text-a'>--</span>";
		var deadline="<span class='text-a'>--</span>";
		var completed_time="<span class='text-a'>--</span>";
		
		if (parseInt(task.start_time)){
			start_time=AP.time.time("%d/%m", task.start_time);
		}
		
		if (parseInt(task.deadline)){
			deadline=AP.time.time("%d/%m", task.deadline);
		}
		
		if (parseInt(task.completed_time)){
			completed_time=AP.time.time("%d/%m", task.completed_time);
		}

		var sort_handler=(task.metatype=='task')?"<div class='sbar'></div>":'';
		var html="<div class='tr task js-"+(task.metatype)+" "+(is_active)+" task-"+(task.id)+" "+(ec.join(' '))+"' data-id='"+(task.id)+"' data-keywords='"+(task.keywords)+"' id='jsrow-"+(task.id)+"'> <div class='td'>"+(sort_handler)+"</div> <div class='td'> <div class='wrap'> <div class='cb url "+(parseInt(task.status)?' -done':'')+" "+(parseInt(task.acl.status)?' -okay':' -locked')+"' data-status='"+(task.status)+"' data-acl='"+(task.acl.status)+"' data-xurl='action/"+(task.id)+"/check'> <div class='task-status'></div> </div> </div> </div> <div class='td'> <div class='wrap'> <div class='std relative url' data-dburl='action/"+(task.id)+"/custom' data-url='task/"+(task.id)+"'  data-acl='"+(task.acl.name)+"' data-role='name' data-value='"+(task.name)+"' data-id='"+(task.id)+"' data-fid='name'> <div class='level level-"+(level)+"'><div class='ap-xdot'>"+(task.name)+"</div></div> </div> </div> </div> <div class='td'> <div class='wrap relative url -fit' data-url='action/"+(task.id)+"/starttime' data-acl='"+(task.acl.time)+"'> <div class='ap-xdot task-time'>"+(start_time)+"</div> </div> </div> <div class='td'> <div class='wrap relative url -fit' data-url='action/"+(task.id)+"/deadline' data-acl='"+(task.acl.time)+"'> <div class='ap-xdot task-time'>"+(deadline)+"</div> </div> </div> <div class='td'> <div class='wrap relative -locked -fit'> <div class='ap-xdot task-time'>"+(completed_time)+"</div> </div> </div> <div class='td'><div class='wrap'> "+(getCompletion(task))+" </div></div> </div>";

		return html;
	};
	
	
	function getLevel(task){
		var level=0;
		var p=task.parent;
		while (true){
			if (!p){
				break;
			}
			
			p=p.parent;
			level++;
		}
		
		return level;
	};

	
	
	
	function getWidth(field){
		if (field.type=="textarea"){
			return 200;
		}
		
		if (field.type=="checkbox"){
			return 50;
		}

		if (field.type=="datetime"){
			return 120;
		}
		
		return 80;
	};
	
	function getTotalWidth(){
		var total=0;
		for (var i=0; i<Client.pageData.context.form.length; i++){
			total+=getWidth(Client.pageData.context.form[i]);
		};
		return total;
	};
	
	function getTotalHeight(){		
		return Board.data.model.num_tasks*30+Board.data.model.num_groups*36;
	};
	
	
	function countTasks(tasks){
		var total=tasks.length;
		for (var i=0; i<tasks.length; i++){
			total+=countTasks(tasks[i].subtasks);
		}
		
		return total;
	};
	
	
	
	
	function inRange(ts, task){
		if (parseInt(task.deadline)){
			var deadline=parseInt(task.deadline);
			if (parseInt(task.start_time)){
				var stime=parseInt(task.start_time);
				if (ts>=stime && ts<=deadline){
					return true;
				}
			}else{
				if (ts>=deadline && ts-deadline<24*3600){
					return true;
				}
			}
		}
		
		return false;
	};
	
	
	
	function initFooter(){
		var html="<div class='tabs'> <div class='tab' data-view='gantt'>Xem gantt chart</div> <div class='tab' data-view='fields'>Xem trường dữ liệu tùy chỉnh</div> </div>";
		
		$("#board-table-footer").html(html);
		
		$("#board-table-footer .tab").click(function(){
			var view=$(this).data("view");
			Base.pref().set(["gantt_gview", Client.pageData.project.id], view);
			AP.xRefresh();
		}).each(function(){
			var view=Base.pref().get(["gantt_gview", Client.pageData.project.id]);
			if (!view){
				view="gantt";
			}
			
			if (view==$(this).data("view")){
				$(this).addClass("active");
			}else{
				$(this).removeClass("active");
			}
		});
	};
	
	
	
	function initCanvas(){
		var html="<div class='board-nav' id='js-board-nav'> <div class='nav-left'><div></div></div> <div class='nav-right'><div></div></div> <div class='clear'></div> </div> <div id='board-table' class='scroll-y forced-scroll'> <div class='section main-table'> <div class='wrapper' id='js-main-table'> <div class='table'></div> </div> </div> <div class='board-scroller'> <div class='section gantt-table hidden'> <div class='wrapper' id='js-gantt-table'> <div class='table'> <div class='table-top'><table></table></div> <div class='inner-grids'></div> <div class='todaymark'></div> <div class='truegrid'></div> </div> </div> </div> <div class='section custom-table hidden'> <div class='wrapper' id='js-custom-table'></div> </div> </div> </div>";
		
		$("#board-table-wrapper").html(html);
	};
	
	
	
	function initScroller(){
		$("#board-table").css("padding-bottom", $.sbWidth());
		
		$("#js-board-nav").css("height", $.sbWidth());
		$("#js-board-nav > div.nav-right > div").css("width", (19*this.range));
		$("#board-table .section.gantt-table .table").css("width", 19*this.range);
		
		var w1=$("#board-table .board-scroller .custom-table .table.js-basetable").width();
		var w2=$("#board-table .board-scroller .gantt-table .wrapper table").width();
		
		if (!w1){
			w1=0;
		}
		
		if (!w2){
			w2=0;
		}
		
		
		$("#js-board-nav .nav-right").scroll(function(){
			var left=$(this).scrollLeft();
			$("#board-table .section.gantt-table").css("margin-left", -left);
			$("#board-table .section.custom-table").css("margin-left", -left);
		});
		
		$("#js-board-nav .nav-right > div").width(Math.max(w1, w2));
		
		$("#board-table").on("scroll", function(){
			var t=$(this).scrollTop();
			if (t>0){
				$("#js-main-table .thead").css({top: t+"px"});
				$("#js-custom-table .thead").css({top: t+"px"});
				$("#js-gantt-table .table .table-top").css({top: t+"px"});
			}else{
				$("#js-main-table .thead").css({top: 0});
				$("#js-custom-table .thead").css({top: 0});
				$("#js-gantt-table .table .table-top").css({top: 0});
			}
		})
	};
	
	
	function getCompletion(task){
		var status=Task.ui.grandState(task);
		
		var complete=task.complete;
		var c='';
		var txt='Todo';
		
		if (status=='done'){
			c='';
			txt='Done';
		}
		
		if (status=='doing'){
			c="<div class='c' style='width:"+(complete)+"%'></div>"
			txt='Doing';
			if (parseInt(Client.pageData.project.percent_completion)){
				txt=""+(parseFloat(task.complete).toFixed(2))+"%";
			}
		}
		
		if (status=='review'){
			c='';
			txt='Review';
		}
		
		return "<div class='complete-bar is-"+(status)+"'>"+(c)+"<span class='txt'>"+(txt)+"<span></div>";
	};
	
};


Board.ctable=new function __BoardCTable(){
	this.init=function(){
		var header=getHeader(Client.pageData.project);
		var body='';
		for (var i=0; i<Board.data.model.groups.length; i++){
			body+="<div class='tr group'> <div class='inner'></div> </div>";
			
			for (var j=0; j<Board.data.model.groups[i].tasks.length; j++){
				body+=getTaskHTML(Board.data.model.groups[i].tasks[j]);
			}
		}
		
		$("#js-custom-table").html("<div class='table'>"+(header)+"<div class='tbody'>"+(body)+"</div></div>");
		
		BaseTable.init("#js-custom-table .table", {
			height: "auto",
			width: "auto",
			layout: "list",
			events: false
		});
	};
	
	
	
	this.taskUpdated=function(task){
		$("#js-custom-table .js-task-"+task.id).replaceWith(getSingleTaskHTML(task));
		BaseTable.update("#js-custom-table .js-task-"+task.id);
	};
	
	
	
	function getHeader(context){
		var customs=AP.render(context.form, function(e){
			if (parseInt(e.enabled)) {
				return "<div class='th js-resizable' data-key='"+(e.id)+"' data-width="+(getWidth(e))+" title='"+(e.name)+"'> <div class='wrap'> <div class='ap-xdot'>"+(e.name)+"</div> </div> </div>";
			} else {
				return '';
			}
		});
		
		
		return "<div class='thead'> <div class='tr cols clear-fix'> <div data-width='120' class='th js-resizable' data-key='milestone'> <div class='wrap'><div class='ap-xdot'>Milestone</div></div> </div> <div data-width='110' class='th js-resizable' data-key='assignee'> <div class='wrap'><div class='ap-xdot'>Giao cho</div></div> </div> <div data-width='120' class='th js-resizable' data-key='tags'> <div class='wrap'><div class='ap-xdot'>Nhãn</div></div> </div> "+(customs)+" <div data-width='120' class='th js-resizable' data-key='complete_time'> <div class='wrap'><div class='ap-xdot'>TG hoàn thành</div></div> </div> <div data-width='110' class='th js-resizable' data-key='created_by'> <div class='wrap'><div class='ap-xdot'>Tạo bởi</div></div> </div> <div data-width='120' class='th js-resizable' data-key='created_at'> <div class='wrap'><div class='ap-xdot'>Created at</div></div> </div> <div data-width='120' class='th js-resizable' data-key='last_update'> <div class='wrap'><div class='ap-xdot'>Last update</div></div> </div> </div> </div>";
	};
	
	
	function getTaskHTML(task){
		if (!task.visible){
			return '';
		}
		
		var subtasks=AP.pageConfig.get("subtasks");
		
		return getSingleTaskHTML(task)+AP.render(task.subtasks, function(e){
			if (subtasks=="natural"){
				return getSingleTaskHTML(e);
			}
			
			return getTaskHTML(e);
		});
	};
	
	
	/**
	 * @desc Rendering task HTML
	 */
	function getSingleTaskHTML(task){
		var context=Client.pageData.project;
		
		var custom=AP.render(context.form, function(e){
			if (parseInt(e.enabled)) {
				var dd='';
				if (e.type=='indicator' || e.type=='sindicator' || e.type=='select'){
					dd=' -dd';
				}
				
				return "<div class='td js-custom'> <div class='cell wrap js-custom-field pointer url -dx"+(task.acl.desc)+" "+(dd)+"' data-acl='"+(task.acl.desc)+"' data-url='action/"+(task.id)+"/fedit' data-fid='"+(e.id)+"' data-type='"+(e.type)+"' data-id='"+(task.id)+"'> "+(getCell(task, e))+" </div> </div>";
			} else {
				return '';
			}
		});

		var assign="<div class='user'> <div class='avatar'> <div class='image'><div class='user-add'></div></div> </div> <div class='user-name text-9'>Giao việc</div> </div>";
		
		var u=People.get(task.username);
		if (u && u.id){
			assign="<div class='user' title='"+(u.name)+" - "+(u.title)+"'> <div class='image'><img src='"+(AP.xthumb(u.gavatar))+"'/></div> <div class='user-name ap-xdot'>"+(u.first_name)+"</div> </div>";
		}

		var creator="<span class='none'>Giao việc</span>";
		
		var u=People.get(task.creator_username);
		if (u && u.id){
			creator="<div class='user' title='"+(u.name)+" "+(u.title)+"'> <div class='image'><img src='"+(AP.xthumb(u.gavatar))+"'/></div> <div class='user-name ap-xdot'>"+(u.first_name)+"</div> </div>";
		}


		var tags=Project.taglist.parse(task.tags);
		var tags_html="";

		if (tags.length){
			tags_html=AP.render(tags, function(e){
				return "<div class='itag'> <div class='iball -bg-alt"+(e.color)+"'></div> <div class='rtag relative'>"+(e.name)+"</div> </div>";
			});

			tags_html="<div class='itags ap-xdot'>"+(tags_html)+"</div>";
		}
		
		var finish = '';

		if (parseInt(task.overdue)){
		} else {
			if (parseInt(task.complete_time)){
				finish = AP.time.time("%h:%i", task.complete_time)+' '+AP.time.time("%d/%m/%Y", task.complete_time);
			} else {
				finish = "";
			}
		}

		
		var acl=parseInt(task.acl.status)+parseInt(task.acl.managed);
		if (acl){
			acl=1;
		}
		
		return "<div class='tr task js-task-"+(task.id)+"' data-name='"+(task.name)+"' data-taskgroup='"+(task.parent_id)+"' data-id='"+(task.id)+"' id='jsrow-"+(task.id)+"'> <div class='td'> <div class='wrap url -dx"+(acl)+"' data-url='action/"+(task.id)+"/milestone' data-acl='"+(acl)+"'>"+(Milestone.project.getCellHTML(task))+"</div> </div> <div class='td'> <div class='wrap url -dx"+(task.acl.desc)+"' data-xurl='action/"+(task.id)+"/assign' data-acl='"+(task.acl.assign)+"' data-view='table'> "+(assign)+" </div> </div> <div class='td'> <div class='wrap url -dx"+(task.acl.desc)+"' data-xurl='action/"+(task.id)+"/tags' data-acl='"+(task.acl.desc)+"' title='"+(task.tags.join(','))+"'> <div class='xo'>"+(tags_html)+"</div> </div> </div> "+(custom)+" <div class='td'> <div class='wrap'> <div class='ap-xdot'>"+(finish)+"</div> </div> </div> <div class='td'> <div class='wrap'>"+(creator)+"</div> </div> <div class='td'> <div class='wrap text-9' data-role='readonly'> <div class='ap-xdot'>"+(AP.i18n.datetime(task.since))+"</div> </div> </div> <div class='td'> <div class='wrap relative text-9' data-role='readonly'> <div class='ap-xdot'>"+(AP.i18n.datetime(task.last_update))+"</div> </div> </div> </div>";
	};
	
	
	
	function getWidth(field){
		if (field.type=="textarea"){
			return 200;
		}
		
		if (field.type=="checkbox"){
			return 60;
		}
		
		if (field.type=="attachment"){
			return 130;
		}
		
		if (field.type=="indicator" || field.type=="sindicator"){
			return 60;
		}

		if (field.type=="datetime"){
			return 120;
		}
		
		return 100;
	};
	
	
	function getCell(task, field){
		var custom_field_text = (field.type == 'text' || field.type == 'textarea') ? 'custom-field ap-xdot' : '';
		return "<div class='js-text-value relative "+(custom_field_text)+"'>"+(Task.field.display(task, field))+"</div>";
	};
	

};


Board.gantt=new function __BoardGantt(){
	this.init=function(){
		$("#js-gantt-table").css("height", Board.table.height);
		buildGrid(Board.table.sdate, Board.table.edate);
	};
	
	
	this.taskUpdated=function(task){
		if ($("#js-gantt-table .gbarwrapper-"+task.id).length){
			$("#js-gantt-table .gbarwrapper-"+task.id).replaceWith(getSingleTaskHTML(task));

			$("#js-gantt-table .gbarwrapper-"+task.id+" .gbar.-dx1").resizable({
				grid: 18,
				handles: 'e, w',
				stop: function(event, ui){
					var left=ui.position.left;
					var width=ui.size.width;

					updateDuration(ui.element, left, width);
				}
			}).draggable({
				axis: 'x',
				grid: [18, 0],
				stop: function(event, ui){
					var left=ui.position.left;
					var width=$(this).width();
					updateDuration(this, left, width);
				}
			});
		}
	};
	
	
	function buildGrid(sdate, edate){
		var inner_grids="";
		
		var mx="<tr class='months'>";
		var months=getMonths(sdate, edate);

		for (var i=0; i<months.length; i++){
			var m=months[i];
			mx+="<td colspan='"+m.span+"'>"+m.name+"</td>";
		}

		mx+="</tr>";

		var header="<tr class='hdays'>";
		for (var d=sdate; d<edate; d=d+24*3600){
			var dow=AP.time.time("%D", d).toLowerCase().substr(0,2);
			var dom=AP.time.time("%d", d);

			header+="<td class='hd -"+(dow)+"'><div class='d'><div class='dom'>"+(dom)+"</div></div></td>";
			inner_grids+="<div class='icol -"+(dow)+"'><div></div></div>";
		}

		header+="</tr>";

		$("#js-gantt-table table").html(mx+header);
		$("#js-gantt-table .inner-grids").html(inner_grids);


		var html="";
		for (var i=0; i < Board.data.model.groups.length; i++){
			
			html+="<div class='glist'></div>";

			var tasks = Board.data.model.groups[i].tasks;
			
			for (j=0; j < tasks.length; j++){
				if (!parseInt(tasks[j].acl.view) || !parseInt(tasks[j].visible)){
					continue;
				}
				
				html += getTaskHTML(tasks[j]);
			}
		}

		$("#js-gantt-table .truegrid").html(html);

		$("#js-gantt-table .truegrid .gbar").resizable({
			grid: 18,
			handles: 'e, w',
			stop: function(event, ui){
				var left=ui.position.left;
				var width=ui.size.width;

				updateDuration(ui.element, left, width);
			}
		}).draggable({
			axis: 'x',
			grid: [18, 0],
			stop: function(event, ui){
				var left=ui.position.left;
				var width=$(this).width();
				updateDuration(this, left, width);
			}
		});


		
		var today=(AP.time.beginOfDay()-Board.table.summary.gantt_start)/(24*3600);
		
		if (today>0){
			today=today*18;
			$("#js-gantt-table .todaymark").css({left: today+5});

			var left=today-$("#js-gantt-table").width()/2;

			if (left && left>0){
				$("#board-table .section.gantt-table").css("margin-left", -left);
				
				setTimeout(function(){
					$("#board-table-wrapper .board-nav .nav-right").scrollLeft(left+10);
				},100);
				
			}
		}
		
	};

	
	function getTaskHTML(task){
		var subtasks=AP.pageConfig.get("subtasks");
		
		return getSingleTaskHTML(task)+AP.render(task.subtasks, function(e){
			if (subtasks=="natural"){
				return getSingleTaskHTML(e);
			}
			
			return getTaskHTML(e);
		});
	};

	
	function getSingleTaskHTML(task){
		var main="";
		var left=0;
		var right=0;
		
		if (parseInt(task.start_time)){
			left=(AP.time.beginOfDay(task.start_time)-Board.table.summary.gantt_start)/(24*3600);
		}
		
		if (parseInt(task.deadline)){
			right=(AP.time.beginOfDay(task.deadline)-Board.table.summary.gantt_start)/(24*3600);
		}
		
		var w=28;
		if (!left){
			left=right;
		}
		
		if (!right){
			right=left;
		}
		
		left=left*18;
		right=(right+1)*18;

		
		var task_info="<div class='txt'><div class='ap-xdot'>"+(task.name)+" ["+(Task.ui.grandTime(task))+"]</div></div>";
		var user=People.get(task.user_id);
		if (user && parseInt(user.uid)){
			task_info+="<div class='user'> <div class='image'><img src='"+(AP.xthumb(user.gavatar))+"'/></div> <div class='uname'>"+(user.name)+"</div> </div>";
		}else if (parseInt(task.acl.assign)){
			task_info+="<div class='user url' data-url='action/"+(task.id)+"/assign'> <div class='user-add'></div> <div class='uname'>Assign</div> </div>";
		}
		
		var extra_class='';
		if (Compute.overdue(task)){
			extra_class='-overdue';
		}else if (Compute.doneLate(task)){
			extra_class='-late';
		}
		
		var w=right-left+1;
		if (left){
			var percent=task.complete;
			if (Client.pageData.project && parseInt(Client.pageData.project.percent_completion) && !parseInt(task.status)){
				main="<div class='gbar gbar-"+(task.id)+" -dx"+(task.acl.time)+" is-"+(Task.ui.grandState(task))+" "+(extra_class)+"' data-acl='"+(task.acl.time)+"' data-id='"+(task.id)+"' data-deadline='"+(task.deadline)+"' data-start_time='"+(task.start_time)+"' style='left: "+(left-1)+"px; width: "+(w)+"px'> <div class='td' style='width: "+(percent)+"%'></div> "+(task_info)+" </div>";
			}else{
				main="<div class='gbar gbar-"+(task.id)+" -dx"+(task.acl.time)+" is-"+(Task.ui.grandState(task))+" "+(extra_class)+"' data-acl='"+(task.acl.time)+"' data-id='"+(task.id)+"' data-deadline='"+(task.deadline)+"' data-start_time='"+(task.start_time)+"' style='left:"+(left-1)+"px; width: "+(w)+"px'> "+(task_info)+" </div>";	
			}
		}
		
		return "<div class='gbarwrapper gbarwrapper-"+(task.id)+"'>"+(main)+"</div>";
	};
	
	
	function getMonths(sdate, edate){
		var ms=[];
		var last=sdate;
		var last_ms=AP.time.time("%m/%Y", last);
		
		
		for (var i=sdate; i<edate; i=i+24*3600){
			var m=AP.time.time("%m/%Y", i);
			
			if (m!=last_ms){
				ms.push({
					sdate: last,
					edate: i,
					name: AP.time.time("%m - %Y", last),
					span: Math.floor((i-last)/(24*3600))
				});
				last=i;
				last_ms=AP.time.time("%m/%Y", i);
			}
		}
		
		ms.push({
			sdate: last,
			edate: edate,
			name: AP.time.time("%m - %Y", last),
			span: Math.floor((edate-last)/(24*3600))
		});
		
		
		return ms;
	};
	
	
	function updateDuration(ref, left, width){
		var id=$(ref).data("id");
		var current_deadline=$(ref).data("deadline");
		var current_start_date=$(ref).data("start_date");
		
		var stime=(Math.ceil(left/Board.table.cell.width))*(24*3600)+Board.table.summary.gantt_start;
		var deadline=stime+ Math.floor(width/Board.table.cell.width)*(24*3600)-1;
		
		Task.inline.editStartTimeDeadline(id, stime, deadline, ref);
	};

};


Board.table.group=new function __BoardTableGroup(){
	this.getHTML=function(group){
		var html="<div class='tr group' data-group='"+(group.id)+"'> <div class='inner'> <div class='dd'><span class='-ap icon-triangle-down'></span></div> <div class='gname'>"+(group.name)+"</div> </div> </div>";

		if (Board.data.model.metatype=="milestone"){
			var display="["+(AP.i18n.date(group.time))+"] <span class='sub'>"+(group.name)+"</span>";
			if (!group.id){
				display=""+(group.name)+"";
			}
			
			html="<div class='tr group' data-group='"+(group.id)+"'> <div class='inner'> <div class='dd'><div class='icon-base-calendar -dark' style='top:8px; margin-left:-1px;'></div></div> <div class='gname'>"+(display)+"</div> </div> </div>";
		}
		
		return html;
	};
};




Project.summary=new function __ProjectSummary(){
	this.basic=function(){
		var s={start: parseInt(Client.pageData.context.stime), end: parseInt(Client.pageData.context.etime)};
		
		var tstart=0;
		var tend=0;
		
		for (var i=0; i<Client.pageData.tasks.length; i++){
			var e=Client.pageData.tasks[i];
			
			if (parseInt(e.start_time)){
				if (!tstart || tstart > parseInt(e.start_time)){
					tstart=parseInt(e.start_time);
				}	
			}
			
			if (parseInt(e.deadline)){
				if (!tend || tend < parseInt(e.deadline)){
					tend=parseInt(e.deadline);
				}	
			}
			
		}

        if (!tstart){
            tstart=parseInt(Client.pageData.context.since);
        }	
		
		if (!parseInt(Client.pageData.context.stime)){
			s.start=tstart;
		}

		
		if (!tend || tend < tstart + 30 * 24 * 3600){
			tend=tstart + 30 * 24 * 3600;// #50960 Fix bug gantt chart bi trang
		}

        if (!parseInt(Client.pageData.context.etime)){
            s.end=tend;
        }

		tstart=AP.time.beginOfDay(tstart);
		tend=AP.time.beginOfDay(tend);

		s.task_start=tstart;
		s.task_end=tend;
		
		tstart=tstart-3*24*3600;
		tend=tend+3*24*3600;
		
		// maximum 9 months
		if (tstart + 31 * 9 * 86400 < tend) {
			tstart = tend - 31 * 9 * 86400;
		}
		
		tstart=AP.time.beginOfMonth(tstart);
		tend=AP.time.endOfMonth(tend);
		
		if (tend-tstart < 32*24*3600){
			tend=tend+20*24*3600;
			tstart=tstart-20*24*3600;
		}
		
		s.gantt_start=tstart;
		s.gantt_end=tend;
		
		return s;
	};
};




Board.printService=new function __BoardList(){
	this.init=function(project){
		this.build(project);
		
		UI.pageCountdown("#tasklists .countdown", true);
		
		$("#tasklists").click(function(e){
			Board.clean("#tasklists", e.target);
		});
	};
	
	
	this.insertTask=function(tasklist, task){
		$("#tasklist-"+tasklist.gid+" .tasks .none").hide();
		$("#tasklist-"+tasklist.gid+" .tasks").append(getTask(task));
	};
	
	
	this.build = function(project){
		Project.tasklists();
		$("#tasklists").empty();
		
		for (var i = 0; i < Client.pageData.tasklists.length; i++){
			var tasklist=Client.pageData.tasklists[i];
			for (var j=0; j<tasklist.tasks.length; j++){
				tasklist.tasks[j].visible=1;
			}
			
			var html = Board.ui.getTaskList(tasklist);
			
			$(html).appendTo("#tasklists");
		}
	};
	
	
	this.collapseSection = function(ref) {
	    var $parent = $(ref).closest('.tasklist');
	    
	    if ($parent.hasClass('-collapsed')) {
	        $parent.removeClass("-collapsed");
	        $('.tasks', $parent).slideDown(300);
	    } else {
	    	$parent.addClass("-collapsed");
            $('.tasks', $parent).slideUp(300);
	    }
	};
	
	
	
	this.editing=function(ref){
		$(ref).closest(".js-task").toggleClass("active").siblings().removeClass("active");
		var $input=$(ref).closest(".js-task").find("input[name=name]");
		
		if (!$input.hasClass("__ap_enter_binded")){
			$input.enter(function(){
				var name=$(this).val();
				var id=$(this).closest(".js-task").data("id");
				
				Task.inline.edit(id, {"key": "name", value: name}, this);
			});
		}
		
		setTimeout(function(){
			$input.focus();
			var val=$input.val();
			$input.val("").val(val);
		},300);
	};
	
	
	this.taskUpdated=function(task, ref){
		$("#tasklists .li-"+task.id).replaceWith(Board.ui.renderItem(task));
	};
	
};


Project.template=new function __ProjectTemplate(){
	this.getTemplates=function(callback){
		
	};	
	
	this.create=function(){
		var project=Client.pageData.context;
		var hiddens={project_id: Client.pageData.context.id};
		
		var form=Form.create('fly-workflow-fx',{'action': "api/template/save"})
			.hiddens(hiddens)
			.row(
				Form.label({label: "Template name"}),
				Form.input({name: 'name', type: "text", placeholder:"The template name"}).value(project.name)
			).addClass("-big")
			.row(
				Form.label({label: "Share with (users or teams)"}),
				Form.input({name: 'teams', type: "text", placeholder:"Type @ to tag", role:"teams"}).value([Client.viewer.username])
			)
			.row(
				Form.label({label: "Based on (project)"}),
				Form.input({name: 'name_fake', type: "fake"}).value('Project: ' + project.name)
			)
			.row(
				Form.label({label: "What to be included?"}),
				Form.input({name: 'options', type:"checkboxes", options:[
					{label:"Tasklists", value: 'tasklists'},
					{label:"Custom fields", value: 'fields'},
					{label:"Task permissions", value: 'acls'},
					{label:"Tags", value: 'tags'},
				]}).value(["tasklists", "fields", "acls", "tags"])
			)
			.buttons([
				{label: "Save template", action: function(){
					Form.submit("#fly-workflow-fx", function(code){
						if (!code.good()){
							return AP.alertError(code.message);
						}

						Form.hide("fly-workflow-fx");
						AP.alertSuccess("Save template successfully");
						Client.templates.push(code.template);
					})
				}, style: 'ok -success -rounded bold'},
				{label: "Huỷ", action: function(){
					Form.hide("fly-workflow-fx");
				}, style:'cancel -passive-2 -rounded'}
			])
			.render(function(form){
			});

		Form.pop({width: 420, label: 'Create a template from a project', layout: 'flat', closable : false}).setForm(form).show();

	};
	
	
	/**
	 * @desc Get options to form select
	 * @return Array
	 */
	this.options=function(){
		var opts=Form.convert(Client.templates);
		opts.unshift({label:"No template", value:0})
		
		return opts;
	};

	
};





var Side=new function __Side(){
	this.init=function(){
		if (!Client.pageData.tasks){
			return;
		}
		
		var action='';
		if (Project.isManager()){
			action="<div class='action' onclick='Milestone.create();'>Add</div>";
		}
		
		$("#project-side-canvas").html("<div id='project-side'> <div class='section js-project-overview'> <div class='overview'> <div id='js-project-overview'></div> </div> </div> <div class='section js-team-tasklists'> <div id='js-team-tasklists'></div> </div> <div class='section js-me-overview'> <div id='js-side-me'></div> </div> <div class='section js-milestones'> <div class='box'> <div class='box-title'>Mục tiêu"+(action)+"</div> <div id='js-side-milestones'></div> </div> </div> <div class='section js-project-stats'> <div id='js-side-stats'></div> </div> </div>");
		
		Side.overview.display("#js-project-overview");
		Side.me.init();
		Side.stats.init(); 
		Side.milestone.init();
		
		if (Client.pageData.project.metatype=="project"){
			$("#project-side .js-team-tasklists").hide();
		}else{
			var tasklists=AP.render(Client.pageData.tasklists, function(e){
				if (!parseInt(e.id)){
					return '';
				}
				
				return "<div class='link url' data-urlparam='tasklist' data-value='"+(e.id)+"'> <div class='name ap-xdot'>"+(e.name)+"</div> <div class='icon'><span class='ficon-folder-o'></span></div> </div>";
			});
			
			tasklists="<div class='link url' data-urlparam='tasklist' data-value=''> <div class='name'>Tất cả</div> <div class='icon'><span class='ficon-folder'></span></div> </div>"+tasklists;
			
			var action=Project.isManager()?`<div class='action' onclick='TaskList.create();'>Thêm</div>`:'';
			
			$("#js-team-tasklists").html("<div class='box'> <div class='box-title'>Nhóm công việc"+(action)+"</div> <div class='sidelinks'>"+(tasklists)+"</div> </div>");
			
			$("#js-team-tasklists .link").setActiveURLParam("tasklist", 0);
		}
	};
};


Side.overview=new function __SideOverview(){
	this.display=function(canvas){
		if (!canvas){
			canvas="#js-project-overview";
		}
		
		var context=Client.pageData.context;
		
		var percent=Compute.percent(context);
		var color=Compute.color(context);
		
		var stats=Compute.overview.init(Client.pageData.tasks);
		Side._stats=stats;
		
		var stime=AP.i18n.date(context.stime);
		if (!parseInt(context.stime)){
			stime="<span class='none'>Ngày bắt đầu</span>";
		}
		
		if (parseInt(context.acl.managed)){
			stime="<span class='url' data-xurl='paction/0/time'>"+stime+"</span>";	
		} else {
			stime="<span class='none'>"+stime+"</span>";
		}
		
		var etime=AP.i18n.date(context.etime);
		if (!parseInt(context.etime)){
			etime="<span class='none'>Ngày kết thúc</span>";
		}

		if (parseInt(context.acl.managed)) {
			etime="<span class='url' data-xurl='paction/0/time'>"+etime+"</span>";
		} else {
			etime="<span class='none'>"+etime+"</span>";
		}

		var followers = getFollowers(context);
		var number_followers = getNumberFollowers(context);
		var status_history = "<div class='status-history'>"+(Project.status.history(context))+"</div>";
		
		var manage="";
		if (parseInt(context.acl.managed)){
			manage="<div class='subsection'> <div class='subheader'> <div class='icon'><span class='ficon-cog'></span></div> <div class='title'><span class='url' data-xurl='settings'>Settings</span></div> </div> </div>";
		}
		
		manage='';
		
		var content=context.content;
		if (!content || !content.length){
			content="<span class='text-a'>No description</span>";
		}
		
		var dept_html='--';
		var d=Dept.fromContext(context.dept_id);
		if (d){
			dept_html="<span class='url' data-url='dept/"+(d.id)+"'>"+(d.name)+"</span>";
		}
		
		var html="<div class='box projinfo'> <div class='projname'>"+(context.name)+"</div> <div class='projdesc'> <span class='icon-desc'></span> "+(content)+" </div> <div class='row'> <span class='ficon-check-square-o icon'></span> "+(stats._overview.done_ontime+stats._overview.done_late)+"/"+(stats._overview.total)+" hoàn thành <div class='v -dd url inline'><b>"+(stats._overview.percent)+"</b>%</div> </div> <div class='bar -infow'> <div class='c' style='background-color: "+(Color.get(4))+"; width:"+(stats._overview.percent)+"%'></div> </div> <div class='row'> <span class='ficon-bookmark-o icon'></span> <div class='v -full'>"+(stime)+" - "+(etime)+"</div> </div> <div class='row'> <span class='ficon-folder-o icon'></span> Department <div class='v -dd url inline'>"+(dept_html)+"</div> </div> </div> <div class='subsection'> <div class='subheader'> <div class='icon'><div class='icon-desc -left' style='width:12px; margin-top:4px;'></div></div> <div class='title -dd url' data-url=':active:parent:parent'>"+(number_followers)+" thành viên</div> <div class='users'> "+(followers)+" </div> </div> <div class='body'> <div id='js-project-people' class='people'></div> </div> </div> <div class='subsection'> <div class='subheader'> <div class='icon'><span class='ficon-filter'></span></div> <div class='title url -dd' data-url=':active:parent:parent'>Hoạt động gần đây</div> <div class='side'></div> </div> <div class='body'> <div id='js-project-acts' class='acts'></div> </div> </div> <div class='subsection'> <div class='subheader'> <div class='icon'><span class='ficon-circle' style='color:"+(Project.status.color(context.stage))+"'></span></div> <div class='title -dd url' data-url=':active:parent:parent'>Trạng thái</div> <div class='side url inline' data-url='paction/"+(context.id)+"/status' style='background-color: "+(Color.rgba(Project.status.color(context.stage),0.1))+"; color:"+(Project.status.color(context.stage))+"'>"+(Project.status.getLabel(context.stage))+"</div> </div> <div class='body'> "+(status_history)+" </div> </div> "+(manage)+"";
		
		$(canvas).html(html);
		Project.people.side.display("#js-project-people");
		Side.act.display();
		
	};
	

	function getFollowers(context){
		return AP.render(context.followers, function(e, index){
			var u=People.get(e.username);
			if (!parseInt(u.uid)){
				return "";
			}
			
			if (index==10){
				return "<div class='avatar avatar-24 -circled relative'> <span class='more'><span style='font-size:11px; font-weight:normal; display:block; padding-top:2px;'>+"+(context.followers.length-9)+"</span></span> </div>";
			}
			
			if (index>10){
				return '';
			}
			var u = People.get(e.username);
			return "<div class='avatar avatar-24 -circled url' data-username='"+(u.username)+"'> <div class='image'><img src='"+(AP.xthumb(u.gavatar))+"'/></div> </div>";
		});
	};


	function getNumberFollowers(context){
		var followers = AP.array.filter(context.followers, function(e){
			var u=People.get(e.username);
			if (!parseInt(u.uid)){
				return "";
			}
			
			return e;
		});
		return followers.length;
	};

};


Side.act=new function __SideAct(){
	this.display=function(canvas){
		if (!canvas){
			canvas="#js-project-acts";
		}
		
		getActs(function(acts){
			var html=AP.render(acts, function(e){
				return Act.board.getHTML(e);
			});
			
			$(canvas).append(html);
		});
	};
	
	
	function getActs(callback){
		AP.post("api/activity/get", {id: Client.pageData.context.id}, function(code){
			if (!code.good()){
				// return AP.alertError(code.message);
				if (console){
					console.error(code.message);
				}
				
				return;
			}
			
			callback(code.activities);
		});
	};
};


Side.stats=new function __SideStats(){
	this.init=function(){
		var stats=Side._stats;
		var exp='';
		var users=AP.render(stats._users, function(u){
			return getUserStats(u);
		});
		
		
		var full_stats="<div class='box'> <div class='box-title'>Thông tin chung</div> <div class='graph-canvas'> <div class='graph' id='js-project-pie'></div> <div class='stats'> <div class='stat'><span class='s' style='background-color:"+(Color.get(4))+"'></span> <em>"+(stats._overview.done_ontime)+"</em> HT đúng hạn</div> <div class='stat'><span class='s' style='background-color:"+(Color.get(3))+"'></span> <em>"+(stats._overview.done_late)+"</em> HT muộn</div> <div class='stat'><span class='s' style='background-color:"+(Color.get('error'))+"'></span> <em>"+(stats._overview.overdue)+"</em> quá hạn</div> <div class='stat'><span class='s' style='background-color:"+(Color.get('doing'))+"'></span> <em>"+(stats._overview.active)+"</em> Todo + Doing</div> <div class='stat'><span class='s' style='background-color:"+(Color.get(2))+"'></span> <em>"+(stats._review.review)+"</em> đang chờ duyệt</div> </div> </div> <div class='projstats' style='display:none'> <div class='mstats'> <div class='stat'><em>"+(stats._overview.total)+"</em> công việc</div> <div class='stat'><em>"+(stats._overview.percent)+"<span>%</span></em> đã hoàn thành</div> </div> <div class='bar -infow'> <div class='c' style='background-color: "+(Color.get(4))+"; width:"+(stats._overview.percent)+"%'></div> "+(exp)+" </div> </div> </div> <div class='box burndown' style='height:200px; display:none' id='js-project-burndown'></div> <div class='subsection'> <div class='subheader'> <div class='icon'><span class='ficon-exclamation-circle red'></span></div> <div class='title url -dd' data-url=':active:parent:parent'>Quá hạn gần đây</div> <div class='side'><span class='count'></span></div> </div> <div class='body' id='js-side-project-overdues'></div> </div> <div class='subsection'> <div class='subheader'> <div class='icon'><span class='ficon-dot-circle-o -text-orange'></span></div> <div class='title url -dd' data-url=':active:parent:parent'>Chưa bắt đầu</div> <div class='side'><span class='count'></span></div> </div> <div class='body' id='js-side-project-todos'></div> </div> <div class='subsection'> <div class='subheader'> <div class='icon'><span class='ficon-filter'></span></div> <div class='title url -dd' data-url=':active:parent:parent'> Thống kê theo thành viên </div> </div> <div class='body'> <div class='ustats'>"+(users)+"</div> </div> </div>";
		
		if (!Client.pageData.tasks){
			full_stats='';
		}
		
		$("#js-side-stats").html(full_stats);
		Task.attention.list(Side._stats._collection.overdues, "#js-side-project-overdues", {limit: 10});
		Task.attention.list(Side._stats._collection.todos, "#js-side-project-todos", {limit: 10});
		
		
		
		$('#js-project-pie').highcharts({
			credits:{
				enabled: false
			},
			chart: {
				plotBackgroundColor: null,
				plotBorderWidth: null,
				plotShadow: false,
				type: 'pie',
				backgroundColor:'rgba(255, 255, 255, 0.0)',
			},
			title: {
				text: '',
				style: {fontSize: '13px', fontWeight: 'normal'},
				align: 'center',
				verticalAlign: 'middle',
			},
			tooltip: {
				pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
			},
			plotOptions: {
				pie: {
					allowPointSelect: true,
					cursor: 'pointer',
					dataLabels: {
						enabled: false
					},
					showInLegend: true,
					innerSize: '60%'
				}
			},
			legend:{
				itemStyle:{fontWeight: 'normal', fontSize: '9px'},
				enabled: false,
			},
			series: [{
				name: 'Tasks',
				colorByPoint: true,
				data: [{
					name: "In process ("+(stats._overview.active)+")",
					y: stats._overview.active,
				}, {
					name: "ht đúng hạn ("+(stats._overview.done_ontime)+")",
					y: stats._overview.done_ontime,
					color: "#24ce0e"
				}, {
					name: "ht muộn ("+(stats._overview.done_late)+")",
					y: stats._overview.done_late,
					color: "#cebd0c"
				}, {
					name: "Quá hạn ("+(stats._overview.late)+")",
					y: stats._overview.late,
					color:"#ce2a0d"
				}]
			}]
		});
		
		
//		$('#js-project-burndown').highcharts({
//			title: {
//			  text: 'Total tasks over time',
//			  x: -20, //center,
//			  style: {fontSize: '13px', fontWeight: 'bold'}
//			},
//			colors: ['blue', 'red'],
//			plotOptions: {
//			  line: {
//				lineWidth: 2
//			  },
//			  tooltip: {
//				hideDelay: 200
//			  }
//			},
//			subtitle: {
//			  text: '',
//			  x: -20
//			},
//			xAxis: {
//			  categories: ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Day 6',
//						   'Day 7', 'Day 8', 'Day 9', 'Day 10', 'Day 11', 'Day 12']
//			},
//			yAxis: {
//			  title: '',
//			  plotLines: [{
//				value: 0,
//				width: 1
//			  }],
//			  labels: {
//				  enabled: false
//			  }
//			},
//			tooltip: {
//			  valueSuffix: ' hrs',
//			  crosshairs: true,
//			  shared: true
//			},
//			legend: {
//				enabled:false,
//			  layout: 'vertical',
//			  align: 'right',
//			  verticalAlign: 'middle',
//			  borderWidth: 0
//			},
//			series: [{
//			  name: 'Ideal Burn',
//			  color: 'rgba(255,0,0,0.25)',
//			  lineWidth: 1,
//			  data: [110, 100, 90, 80, 70, 60, 50, 40, 30, 20, 10, 0].reverse()
//			}, {
//			  name: 'Actual Burn',
//			  color: 'rgba(0,120,200,0.75)',
//			  marker: {
//				radius: 6
//			  },
//			  data: [100, 110, 125, 95, 64, 76, 62, 44, 35, 29, 18, 2].reverse()
//			}]
//	  });
	};
	
	
	function getUserStats(u){
		var uhtml="<div class='avatar'><span class='-ap icon-uniF1AB'></span></div> <div class='uname'>Unassigned</div> <div class='uinfo'>"+(u.total)+" tasks</div>";
		
		if (u.username!='__unassigned'){
			var user=People.get(u.username);
			if (user){
				uhtml="<div class='avatar'><img src='"+(AP.xthumb(user.gavatar))+"'/></div> <div class='uname'>"+(user.name)+"</div> <div class='uinfo ap-xdot'>"+(user.title)+"</div>";
			}
		}
		
		var pdone_ontime, pdone_late, plate=0;
		if (u.total>0){
			pdone_ontime=u.done_ontime*100/u.total;
			pdone_late=u.done_late*100/u.total;
			plate=u.late*100/u.total;
		}
		
		return "<div class='user'> <div class='name'>"+(uhtml)+"</div> <div class='stat'> <div class='label'><em>"+(u.done_late+u.done_ontime)+"</em>/<em>"+(u.total)+"</em></div> <div class='bar'> <div class='c' style='background-color:"+(Color.get(4))+"; width: "+(pdone_ontime)+"%' title='HT đúng hạn: "+(u.done_ontime)+"'></div> <div class='c' style='background-color:"+(Color.get(2))+"; width: "+(pdone_late)+"%' title='HT muộn: "+(u.done_late)+"'></div> <div class='c' style='background-color:"+(Color.get(0))+"; width: "+(plate)+"%' title='Quá hạn: "+(u.late)+"'></div> </div> </div> </div>";
	};
	
	
};


Side.me=new function __SideMe(){
	this.init=function(){
		var stats=Side._stats;
		var exp=explain('Current completion: '+stats._overview.percent+"%", {icon: false});
		
		var html="<div class='box'> <div class='box-title'>Công việc của tôi</div> <div class='mstats'> <div class='stat'><em><span class='s d -bg-alt3'></span>"+(stats._me.active_todo)+"</em> Todo</div> <div class='stat'><em><span class='s d -bg-alt5'></span>"+(stats._me.active_doing)+"</em> Doing</div> <div class='stat'><em><span class='s d -bg-success'></span>"+(stats._me.done_ontime+stats._me.done_late)+"<span></span></em> Hoàn thành</div> </div> <div class='bar -infow'> <div class='c' style='background-color: "+(Color.get(4))+"; width:"+(stats._me.percent)+"%'></div> "+(exp)+" </div> </div> <div class='subsection active'> <div class='subheader'> <div class='icon'><span class='ficon-asterisk red'></span></div> <div class='title -dd url' data-url=':active:parent:parent'><b class='red ap-f15'>Cần lưu ý</b></div> <div class='side'><span class='count'></span></div> </div> <div class='body' id='js-side-attentions'></div> </div> <div class='subsection'> <div class='subheader'> <div class='icon'><span class='ficon-inbox'></span></div> <div class='title -dd url' data-url=':active:parent:parent'>Mới được giao</div> <div class='side'><span class='count'></span></div> </div> <div class='body' id='js-side-assigned'></div> </div> <div class='subsection'> <div class='subheader'> <div class='icon'><span class='ficon-inbox'></span></div> <div class='title -dd url' data-url=':active:parent:parent'>Giao đi &amp; quá hạn</div> <div class='side'><span class='count'></span></div> </div> <div class='body' id='js-side-assigning-late'></div> </div>";
		
		
		$("#js-side-me").html(html);
		
		Task.attention.list(Side._stats._collection.attentions, "#js-side-attentions", {});
		Task.attention.list(Side._stats._collection.assigned, "#js-side-assigned", {});
		Task.attention.list(Side._stats._collection.assigning_overdue, "#js-side-assigning-late", {});
	};
};


Side.milestone=new function __SideMilestone(){
	this.init=function(){
		if (!Client.pageData.milestones){
			return;
		}
		
		Client.pageData.milestones.sort(function(e, f){
			return parseInt(f.time)-parseInt(e.time);
		});
		
		var html=AP.render(Client.pageData.milestones, function(e){
			return getHTML(e);
		});
		
		$("#js-side-milestones").html("<div class='side-milestones'>"+(html)+"</div>");
	};


	this.update=function(code){
		var milestone = AP.array.findObj(Client.pageData.milestones, code.task.milestone_id);
		if (milestone) {
			milestone.total = milestone.total + 1;
		}
		Side.milestone.init();
	};


	this.removeTask=function(code){
		var milestone = AP.array.findObj(Client.pageData.milestones, code.task.milestone_id);
		if (milestone) {
			milestone.total = milestone.total - 1;
		}
		Side.milestone.init();
	};
	
	
	function getHTML(e){
		if (!parseInt(e.id)){
			return '';
		}
		
		var ec='';
		if (parseInt(e.time)>AP.time.now()){
			ec='-active';
		}
		
		if (parseInt(e.time)<AP.time.now()-30*24*3600){
			ec='-old';
		}
		
		var u=People.get(e.user_id);

		var user_html='';
		var user_info='';
		if (u && parseInt(u.uid)){
			user_html="<div class='avatar'><img src='"+(AP.xthumb(u.gavatar))+"'/></div>";
			user_info="<span class='url username'>"+(u.name)+"</span> &nbsp;&middot;&nbsp;";
		}
		
		return "<div class='milestone "+(ec)+"' data-id='"+(e.id)+"' title='"+(e.name)+" - "+(AP.i18n.date(e.time))+"'> <div class='status-icon'></div> <div class='mdate'>"+(AP.time.time('<em>%v</em><span>%d/%m</span>', e.time))+"</div> <div class='name ap-xdot url' data-url='milestone/"+(e.id)+"'>"+(e.name)+"</div> <div class='subtitle'> "+(user_info)+"<em>"+(e.done)+"/"+(e.total)+"</em> </div> <div class='bar hidden'> <div class='inner'> <div class='c' style='width:"+(e.complete)+"%'> <div class='candy -small -black'></div> </div> <div class='info'> <em>"+(e.done)+"/"+(e.total)+"</em> &mdash; <em>"+(parseFloat(e.complete).toFixed(1))+"</em>% <div class='extra'>"+(AP.time.time('%v, %d/%m/%Y', e.time))+"</div> </div> </div> </div> <div class='mng -cmenuw'> <span class='-ap icon-dots-two-horizontal'></span> <div class='-cmenu -no-icon -padding'> <div class='-item' onclick='Milestone.edit("+(e.id)+")'>Chỉnh sửa</div> <div class='-item' onclick='Milestone.remove("+(e.id)+")'>Xóa</div> </div> </div> </div>";
	};
	
};
var Stream=new function __TaskStream(){
	
};




Stream.filter=new function __StreamFilter(){
	this.activate=function(selector){
		$(selector).each(function(){
			var $this=$(this);
			var f=$this.data("filter");
			var df=$this.data("df");
			var prefix=$this.data("prefix");
			
			$(this).find(".url").each(function(){
				$(this).removeClass("selected active");	
				
				var v=$(this).data("value");
				if (v==Query.get(f) || (!Query.get(f) && !v)){
					$(this).addClass("selected active");
					var txt=$(this).text();
					
					if (!v){
						txt=df;
					}else{
						if (prefix){
							txt=""+(prefix)+"<em>"+(txt)+"</em>";
						}
					}
					
					$this.find(".js-current-filter").html(txt);
				} 
			});
		});
	};
	
	
	// STANDARD STATUS
	this.statuses="<div class='autohide dd -cmenuw js-filter-status' data-filter='status' data-df='Trạng thái' data-prefix='Trạng thái: '> <div class='label js-current-filter'>Trạng thái</div> <div class='-cmenu -padding -no-icon'> <div class='-item url' data-urlparam='status' data-value=''>Tất cả</div> <div class='-item url' data-urlparam='status' data-value='active'>Active (todo + doing)</div> <div class='-item url' data-urlparam='status' data-value='todo'>Todo</div> <div class='-item url' data-urlparam='status' data-value='doing'>Doing</div> <div class='-item url' data-urlparam='status' data-value='done'>Hoàn thành</div> <div class='-item url' data-urlparam='status' data-value='review'>Chờ review</div> <div class='-item-sep'></div> <div class='-item url' data-urlparam='status' data-value='donelate'>HT muộn</div> <div class='-item url' data-urlparam='status' data-value='overdue'>Quá hạn</div> <div class='-item url' data-urlparam='status' data-value='urgent'>Khẩn cấp</div> <div class='-item url' data-urlparam='status' data-value='important'>Quan trọng</div> </div> </div>";
	
	
	// STANDARD SUBTASKS
	this.subtasks="<div class='autohide dd -cmenuw js-filter-subtask' data-filter='subtask' data-df='Hiển thị subtasks'> <div class='label js-current-filter'>Hiển thị subtasks</div> <div class='-cmenu -padding -no-icon'> <div class='-item url' data-urlparam='subtask' data-value=''>Hiển thị subtasks</div> <div class='-item url' data-urlparam='subtask' data-value='hide'>Ẩn subtasks</div> </div> </div>";
	
	
	// STANDARD SUBTASKS
	this.orders="<div class='autohide dd -cmenuw js-filter-order' data-filter='order' data-df='Mới cập nhật' data-prefix='Sắp xếp: '> <div class='label js-current-filter'>Mới cập nhật</div> <div class='-cmenu -padding -no-icon'> <div class='-item url' data-urlparam='order' data-value=''>Mới cập nhật</div> <div class='-item url' data-urlparam='order' data-value='created'>Thời gian tạo</div> <div class='-item url' data-urlparam='order' data-value='deadline'>Deadline</div> </div> </div>";
	
};
var Team=new function __ProjectTeam(){
};



Team.form=new function __TeamForm(){
	/**
	 * @desc Create a new team
	 */
	this.create=function(){
		Tag.context(false);
		
		var data={metatype: "team"};
		
		var form=Form.create('fly-workflow-fx',{'action': "api/project/create"})
		.row(
			Form.label({label: "Tên phòng ban"}),
			Form.input({name: 'name', "placeholder":"Tên phòng ban"})
		).addClass("-big")
		.row(
			Form.label({label: "Thành viên quản trị"}),
			Form.input({name: 'owners', "placeholder":"Sử dụng @ để tag người quản trị", role:"tag"}).value("@"+Client.viewer.username+" ")
		).addClass("-big")
		.row(
			Form.label({label: "Thành viên khác"}),
			Form.input({name: 'followers', "placeholder":"Thành viên làm việc trong phòng ban, sử dụng @ để tag thành viên", role:"tag"})
		)
		.rowHidden(
			Form.label({label: "Thêm nhanh thành viên theo teams"}),
			Form.input({name: 'teams', "placeholder":"Type to select all members and teams", role: "teams"})
		).addClass("-big")
		.plain("<span class='a' id='js-form-add-teams'>Or add members by user groups ... </span>")
		.row(
			Form.label({label: "Mô tả phòng ban",}),
			Form.input({name: 'content', "placeholder":"Mô tả ngắn gọn về phòng ban", type:"textarea"})
		)
		.row(
			Form.label({label: "Deparment"}),
			Form.input({name: 'dept_id', "placeholder":"Department", type:"select", empty: {label: "Not specified", value:0}, options: Form.convert(Client.depts)})
		)
		.buttons([
		     {label: "Tạo phòng ban", action: function(){
		    	 Form.submit("#fly-workflow-fx", function(code){
		    		 if (!code.good()){
		    			 return AP.alertError(code.message);
		    		 }
		    		 
		    		 AP.redirect(code.project.path);
		    	 })
		     }, style: 'ok -success -rounded bold'},
		     {label: "Huỷ", action: function(){
		    	 Tag.context(true);
		    	 Form.hide("fly-workflow-fx");
		     }, style:'cancel -passive-2 -rounded'}
		])
		.hiddens(data)
		.render(function(form){
			$("#js-form-add-teams").click(function(){
				form.findRow("teams").show();
				form.find("teams").focus();
				$(this).parent().hide();
			});
		});
	
		Form.pop({width: 480, label: 'Tạo team mới', layout: 'flat', closable: false}).setForm(form).show().focus('name');
	
	};
	
	
	/**
	 * @desc Edit a team
	 */
	this.edit=function(project){
		var data={hid: project.hid, token: project.token};
		
		if(project.status != 0) {
            return AP.alertError("Dự án đang tạm đóng hoặc đã hoàn thành.");
        }
		
		var form=Form.create('fly-workflow-fx',{'action': "api/project/edit"})
		.row(
			Form.label({label: "Tên dự án",sublabel: "Tên dự án"}),
			Form.input({name: 'name', "placeholder":"Tên dự án"}).value(project.name)
		)
		.row(
			Form.label({label: "Mô tả dự án",sublabel: "Mô tả ngắn gọn về dự án"}),
			Form.input({name: 'content', "placeholder":"Mô tả ngắn gọn về dự án", type:"textarea"}).value(project.content)
		)
		.row(
			Form.label({label: "Người quản trị",sublabel: "Người quản trị có thể tạo và giao việc cho thành viên dự án. Bạn mặc định là một người quản trị."}),
			Form.input({name: '_owners', type:"fake"}).value(UI.objectsToUsernames(project.owners))
		)
		.row(
			Form.label({label: "Thành viên dự án",sublabel: "Thành viên làm việc trong dự án"}),
			Form.input({name: '_followers', type:"fake"}).value(UI.objectsToUsernames(project.followers))
		)
		.row(
			Form.label({label: "Ngày bắt đầu",sublabel: "Ngày bắt đầu dự án"}),
			Form.input({name: 'stime', "placeholder":"Chọn ngày bắt đầu", role:"date"}).value(UI.inputTime(project.stime))
		)
		.row(
			Form.label({label: "Ngày kết thúc",sublabel: "Ngày kết thúc dự án"}),
			Form.input({name: 'etime', "placeholder":"Chọn ngày kết thúc", role:"date"}).value(UI.inputTime(project.etime))
		)
		.rowHidden(
			Form.label({label: "Tag teams",sublabel: "Teams whose members who can create jobs in this workflow."}),
			Form.input({name: 'teams', "placeholder":"Type team name to start tagging"})
		)
		.buttons([
		     {label: "Chỉnh sửa dự án", action: function(){
		    	 Form.submit("#fly-workflow-fx", function(code){
		    		 if (!code.good()){
		    			 return AP.alertError(code.message);
		    		 }
		    		 
		    		 AP.toURL("project/"+code.project.id);
		    	 })
		     }, style: 'ok -success -rounded bold'},
		     {label: "Huỷ", action: function(){
		    	 Form.hide("fly-workflow-fx");
		     }, style:'cancel -passive-2 -rounded'}
		])
		.hiddens(data)
		.render(function(form){
		});
	
		Form.pop({width: 720, label: 'Sửa dự án: '+project.name
		}).setForm(form).show().focus('name');
	
		Tag.team(form.find("teams"));
	};
	

	
};


Team.filter=new function __TeamFilter(){
	this.init=function(){
		var view=AP.pageConfig.get("project_view");
		if (view=="period"){
			return initPeriodFilters();
		}else{
			return setTimeout(function(){
				initStreamFilters();
			});
		}
	};
	
	
	function initStreamFilters(){
		var ms=AP.render(Client.pageData.milestones, function(e){
			return "<div class='-item url' data-urlparam='milestone' data-value='"+(e.id)+"'>"+(e.name)+"</div>";
		});
		
		$('#js-stream-filters').html("<div class='dd -cmenuw js-auto-filter js-assignees' data-filter='assign'> <div class='label js-current-filter'>Giao cho</div> <div class='-cmenu -padding -no-icon'> <div class='-item url' data-urlparam='assign' data-value=''>Tất cả</div> <div class='-item url' data-urlparam='assign' data-value='me'>Giao cho tôi</div> <div class='-item url' data-urlparam='assign' data-value='assigning'>Giao bởi tôi</div> <div class='-item pick-assignee' data-urlparam='assign' data-value='custom'> Lựa chọn thành viên </div> </div> </div> <div class='dd -cmenuw js-auto-filter' data-filter='milestone' data-df='Tất cả mục tiêu' data-prefix='Mục tiêu: '> <div class='label js-current-filter'>Tất cả mục tiêu</div> <div class='-cmenu -padding -no-icon'> <div class='-item url' data-urlparam='milestone' data-value=''>Tất cả mục tiêu</div> "+(ms)+" </div> </div> <div class='right' style='width:5px;'></div>");
		
		setActiveFilter($("#js-stream-filters").find(".js-auto-filter"));
		
		$("#js-stream-filters").find(".pick-assignee").on("click", function(){
			UI.user.pick("Chọn người được giao", function(users){
				if (!users.length){
					AP.setURLParams({assign: null});
				}else{
					AP.setURLParams({assign: users.join("-")});
				}
				
			})
		});
		
		if (Query.get("assign")){
			var assignees=Query.get("assign");
			if (assignees=="me" || assignees=="assigning"){
				
			}else{
				var users=People.collect(assignees.split("-"));
				if (users.length){
					$("#js-stream-filters .js-assignees .-item").setActiveURLParam("assign", "custom");
					$("#js-stream-filters .js-assignees .js-current-filter").html("Assigned: "+AP.word.join(users, ", ",function(e){
						return e.name;
					}))
				}
			}
		}
		
		$("#project-filters").html(""+(Stream.filter.statuses)+" "+(Stream.filter.orders)+" "+(Stream.filter.subtasks)+"");
		
		Stream.filter.activate("#project-filters .js-filter-status");
		Stream.filter.activate("#project-filters .js-filter-order");
		Stream.filter.activate("#project-filters .js-filter-subtask");
		
		$("#project-filters .js-filter-order").removeClass("autohide");
		$("#project-filters .js-filter-status").removeClass("autohide");
		
		if (Client.pageData.task_view=="board"){
			initExtraBoardFilter("#project-filters .js-filter-subtask");
		}
	};
	
	
	
	
	function initPeriodFilters(){
		if (!Client.pageData.stack){
			alert("INVALID_PERIOD_FILTER");
			return;
		}
		
		var period_pref=AP.log.getAppCookie("pref_period_"+Client.pageData.project.id);
		if (!period_pref){
			period_pref="created";
		}
		
		Board.data.period_by=period_pref;
		
		
		var stack=Client.pageData.stack;
		var active="";
		if (parseInt(stack.active)){
			active=" <span title='Hiện tại'>&nbsp;<span class='-ap icon-flag text-success'></span></span>";
		}

		var stack_title = '';
		var stack_prev_title = '';
		var stack_next_title = '';
		if (stack.team_stack=="weekly") {
			stack_title = "Tuần "+(stack.title)+"";
			stack_prev_title = "Tuần "+(stack.prev.title)+"";
			stack_next_title = "Tuần "+(stack.next.title)+"";
		} else {
			stack_title = "Tháng "+(stack.title)+"";
			stack_prev_title = "Tháng "+(stack.prev.title)+"";
			stack_next_title = "Tháng "+(stack.next.title)+"";
		}
		
		var nav="<div class='team-nav js-team-nav'> <div id='js-team-hnav'> <span class='nav nav-left url' data-ts='"+(stack.prev.ts)+"' title='"+(stack_prev_title)+"'> <span class='-ap icon-chevron-left22'></span> </span> &nbsp; <span class='url' data-xurl='home'>"+(stack_title)+" "+(active)+"</span> &nbsp; <span class='nav nav-right url' data-ts='"+(stack.next.ts)+"' title='"+(stack_next_title)+"'> <span class='-ap icon-chevron-right22'></span> </span> </div> </div>";
		
		var order="<div class='filter autohide js-auto-filter' id='js-list-order' data-filter='order' data-prefix='v2.sort_by: '> <div class='js-current-filter'>v2.sort_by: <em>Thời gian cập nhật</em></div> <div class='dd'> <div class='li url' data-urlparam='order' data-value=''>Thời gian cập nhật</div> <div class='li url' data-urlparam='order' data-value='created'>Thời gian tạo</div> <div class='li url' data-urlparam='order' data-value='deadline'>Deadline</div> </div> </div>";
		
		
		var display_opts=Team.filter.display_options;
		
		
		$("#project-filters").html(""+(nav)+" "+(Stream.filter.statuses)+" "+(display_opts)+"");
		
		$("#project-filters .js-team-nav .nav").click(function(){
			var ts=$(this).data("ts");
			AP.setURLParams({ts: ts}, true);
		});	
		
		
		setActiveFilter("#project-filters .js-filter-status");
		
		$("#project-filters select").each(function(){
			var key=$(this).data("urlparam");
			var pref=$(this).data("pref");
			var cx=$(this).data("cookie");
			
			if (cx){
				var val=AP.log.getAppCookie("pref_"+cx+"_"+Client.pageData.project.id);
				if (val){
					$(this).val(val);
				}
				
				$(this).on("change", function(){
					var val=$(this).val();
					AP.log.setAppCookie("pref_"+cx+"_"+Client.pageData.project.id, val);
					AP.xRefresh();
				});
				
				return;
			}
			
			
			if (pref){
				var val=Base.pref().get("pref_"+pref+"_"+Client.pageData.project.id);
				if (val){
					$(this).val(val);
				}
				
				$(this).on("change", function(){
					var val=$(this).val();
					Base.pref().set("pref_"+pref+"_"+Client.pageData.project.id, val);
					AP.xRefresh();
				});
				
				return;
			}
			
			
			if (key && key.length && typeof key !="undefined"){
				$(this).on("change", function(){
					var val=$(this).val();
					
					if (!val){
						AP.setURLParams(assoc(key, null), true);	
					}else{
						AP.setURLParams(assoc(key, val), true);
					}
				});
				
				var cval=Query.get(key);
				if (cval){
					$(this).val(cval);
				}else{
					$(this).val("");
				}
			}
		});
		
		initGCTPref();
	};
	
	
	
	function initExtraBoardFilter(canvas){
		$(canvas).replaceWith("<div class='filter autohide'> <em>Hiển thị</em> &nbsp; <div class='dd'> <div class='select -no-border'> <div class='label'>Nhóm bởi</div> <select name='filter-groupby' data-pref='groupby'> <option value='tasklist'>Nhóm công việc</option> <option value='people'>Thành viên</option> <option value='milestone'>Mục tiêu</option> </select> </div> <div class='checkbox' id='df-group-done'> <div class='check'></div> <div class='label'>Nhóm công việc đã hoàn thành</div> </div> </div> </div>");
		
		$("#project-filters select[name=filter-groupby]").each(function(){
			var pref=$(this).data("pref");
			var val=Base.pref().get("pref_"+pref+"_"+Client.pageData.project.id);
			if (val){
				$(this).val(val);
			}
			
			$(this).on("change", function(){
				var val=$(this).val();
				Base.pref().set("pref_"+pref+"_"+Client.pageData.project.id, val);
				AP.xRefresh();
			});
			
			return;
		});
		
		initGCTPref();
	};
	
	
	
	
	
	
	/**
	 * @desc Init group-completed task pref
	 */
	function initGCTPref(){
		var grouped=Base.pref().get("pref_grouped_"+Client.pageData.project.id);
		if (!grouped || !parseInt(grouped)){
			grouped=1;
		}
		
		grouped=parseInt(grouped);
		Board.filter.grouped=grouped;
		
		if (grouped==1){
			$("#df-group-done").addClass("checked");		
		}else{
			$("#df-group-done").removeClass("checked");
		}
		
		$("#df-group-done").click(function(){
			var grouped=Board.filter.grouped;
			if (!grouped || !parseInt(grouped)){
				grouped=1;
			}
			
			grouped=-parseInt(grouped);
			Base.pref().set("pref_grouped_"+Client.pageData.project.id, grouped);
			Board.filter.grouped=grouped;
			
			if (grouped==1){
				$("#df-group-done").addClass("checked");
			}else{
				$("#df-group-done").removeClass("checked");
			}
			
			AP.xRefresh();
		});
	};
	
	
	
	function setActiveFilter(selector){
		$(selector).each(function(){
			var $this=$(this);
			var f=$this.data("filter");
			var df=$this.data("df");
			var prefix=$this.data("prefix");
			
			$(this).find(".url").each(function(){
				$(this).removeClass("selected active");	
				
				var v=$(this).data("value");
				if (v==Query.get(f) || (!Query.get(f) && !v)){
					$(this).addClass("selected active");
					var txt=$(this).text();
					
					if (!v){
						txt=df;
					}else{
						if (prefix){
							txt=""+(prefix)+"<em>"+(txt)+"</em>";
						}
					}
					
					$this.find(".js-current-filter").html(txt);
				} 
			});
		});
	};
	
	
	
	
	
	this.display_options="<div class='filter autohide'> <em>Hiển thị</em> &nbsp; <div class='dd'> <div class='select'> <div class='label'>Subtasks</div> <select name='filter-subtasks' data-urlparam='subtask'> <option value=''>Hiển thị</option> <option value='hide'>Không hiển thị</option> </select> </div> <div class='select -no-border'> <div class='label'>Period based on</div> <select name='filter-period' data-cookie='period'> <option value=''>Thời gian tạo</option> <option value='deadline'>Deadline</option> <option value='last_update'>Thời gian cập nhật</option> </select> </div> <div class='select -no-border'> <div class='label'>Nhóm bởi</div> <select name='filter-groupby' data-pref='groupby'> <option value='tasklist'>Nhóm công việc</option> <option value='people'>Thành viên</option> <option value='milestone'>Mục tiêu</option> </select> </div> <div class='checkbox' id='df-group-done'> <div class='check'></div> <div class='label'>Nhóm công việc đã hoàn thành</div> </div> </div> </div>";
};


Team.period=new function __TeamPeriod(){
	this.init=function(canvas){
		Board.data.init();
		$("#tasklists").empty();
		Board.list.display(Client.pageData.context);	
	};
	
	this.rebuild=function(){
		$("#tasklists").empty();
		Board.list.display(Client.pageData.context);
	};
};


/**
 * @desc Init infinite rendering list of tasks
 */

Team.stream=new function __BaseTeamList(){
	this.init=function(opts){
		Board.data.init();
		// buildModel();
		opts=$.extend({period:'weekly', show_more: true}, opts);
		this.opts=opts;
		
		Query.set("view", Client.pageData.task_view);
		Project.subheader.init();	
		
		var label="Recent tasks";
		if (Query.get("order")=="deadline"){
			label="Tasks sorted by deadline";	
		}else if (Query.get("order")=="created"){
			label="Recently created";	
		}
		
		var ord='';
		var real_order='';
		if (Query.get("order")){
			ord='&order='+Query.get('order');
			real_order=Query.get('order');
		}
		
		AP.pageConfig.set("team_order", real_order);
		
		var view_subtasks=1;
		if (Query.get("subtask")=="hide"){
			view_subtasks=-1;
		}
		
		AP.pageConfig.set("team_subtasks", view_subtasks);
		
		
		var more="<div class='load-more' onclick='Team.stream.more();'>Load more tasks</div>";
		if (!opts.show_more){
			more='';
		}
		
		var title="<div class='group-header'> <div class='title'> <div class='collapse'> <span class='ficon-caret-right'></span> </div> <div class='name'><span class='url' data-xurl='home?view=stream"+(ord)+"'>"+(label)+"</span></div> </div> <div class='right' style='max-width:none' id='js-stream-filters'></div> </div>";
		
		if (!Client.pageData.project){
			title='';
		}
		
		$(opts.canvas).html("<div class='tasklist'> "+(title)+"<div class='tasks js-list-tasks'></div>"+(more)+" </div>");
		
		this.page=1;
		for (var i=0; i< Client.pageData.tasks.length; i++){
			if (Client.pageData.tasks[i].metatype=="task"){
				appendTask(Client.pageData.tasks[i]);
			}
		}
	};
	
	
	/**
	 * @desc Fully rebuild the list
	 */
	this.rebuild=function(){
		$("#tasklists .tasks").empty();
		for (var i=0; i< Client.pageData.tasks.length; i++){
			if (Client.pageData.tasks[i].metatype=="task"){
				appendTask(Client.pageData.tasks[i]);
			}
		}
	};
	
	
	this.more=function(){
		this.page++;
		
		var params=Query.release();
		params.page=this.page;
		params.project_id=Client.pageData.project.id;
		
		UI.ajaxShow();
		AP.post("api/project/more.tasks", params, function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			for (var i=0; i<code.tasks.length; i++){
				Client.pageData.tasks.push(code.tasks[i]);	
			}
			
			Client.pageData.tasks=AP.array.uniqueObjects(Client.pageData.tasks);
			buildModel();
			
			appendTasks(code.tasks);
			Side.overview.display("#js-project-overview");
		});
	};
	
	
	/**
	 * @desc Append a single task
	 */
	function appendTask(task){
		if ($("#tasklists #task-"+(task.id)+"").length){
			return;
		}
		
		appendSeperator(task);
		
		var html=List.ui.getHTML(task,{team_view: 1});
		$("#tasklists .tasks").append(html);
	};
	
	
	function appendSeperator(task){
		var opts=Team.stream.opts;
		var id='';
		var title='';
		
		var ord=Query.get("order");
		var ts=task.last_update;
		
		if (ord=="created"){
			ts=task.since;
		}
		
		if (ord=="deadline"){
			ts=task.deadline;
		}
		
		if (opts.period=="monthly"){
			id=AP.time.beginOfMonth(ts);
			title='Tháng '+AP.time.time("%m/%Y", ts);
		}else{
			id=AP.time.beginOfWeek(ts);
			title='Tuần '+AP.i18n.dateRange(AP.time.beginOfWeek(ts), AP.time.endOfWeek(ts));
		}
		
		if (ts==0){
			id="x0";
			title="Others";
		}
		
		if ($("#tasklists").find(".sep-"+id).length){
			return;
		}
		
		$("#tasklists .tasks").append("<div class='list-sep sep-"+(id)+"'>"+(title)+"</div>");
	};
	
	
	/**
	 * @desc Append a task to the list
	 */
	function appendTasks(tasks){
		for (var i=0; i<tasks.length; i++){
			appendTask(tasks[i]);
		}
	};
	
	
	function buildModel(){
		// BUILDING THE TASK RELATIONSHIP
		for (var j = 0; j < Client.pageData.tasks.length; j++) {
			Client.pageData.tasks[j].visible=Project.filter.getVisible(Client.pageData.tasks[j]);
			
			Client.pageData.tasks[j].subtasks = AP.array.filter(Client.pageData.tasks, function(s){
				return parseInt(s.parent_id) == parseInt(Client.pageData.tasks[j].id);
			});

			Client.pageData.tasks[j].subtasks=AP.array.realOrder(Client.pageData.tasks[j].subtasks);
			
			Client.pageData.tasks[j].parent=AP.array.findObj(Client.pageData.tasks, Client.pageData.tasks[j].parent_id);
		}
	};
	

	
	
	// STANDARD SUBTASKS
	this.std_subtask_views="<div class='autohide dd -cmenuw js-auto-filter' data-filter='subtask' data-df='View subtasks'> <div class='label js-current-filter'>View subtasks</div> <div class='-cmenu -padding -no-icon'> <div class='-item url' data-urlparam='subtask' data-value=''>View subtasks</div> <div class='-item url' data-urlparam='subtask' data-value='hide'>Hide subtasks</div> </div> </div>";
	
};

var MyTask = new function __MyTask() {
	this.list = function (canvas){
		List.init({
			canvas: "#tasklists",
			show_more: false
		});
		
		$("#tasklists").append("<div class='sep-30'></div> <div id='js-pag' class='center'></div><div class='sep-30'></div><div class='sep-30'></div>");
		UI.paginate("#js-pag");
		return;
	};
};


var MT=MyTask;



MyTask.filter=new function __MyTaskFilter(){
	this.init=function(){
		$("#js-filter-add").click(function(){
			MT.filter.create();
		});
		
		Filter.init({	
			"display":"dialog",
			"filters":[ // Optional
				{"key":"ftype", name: "Loại công việc", "type":"match",
					options:[
						{label: "Công việc tôi được giao", value: "assigned"},
						{label: "Công việc tôi tạo", value: "created"},
						{label: "Công việc trong các phòng ban hoặc dự án tôi quản lý", value: "all"}
						]
				},
				{"key":"status", name: "Trạng thái công việc", "type":"match", options:[{"label": "Active", value: 'active'}, {label: "In review", value: 'review'}, {label: "Done", value: 'done'}]},
				{"key":"created", name: "Thời gian tạo", "type":"number", "role":"date"}, // Search deadline
				{"key":"created_within", name: "Tạo trong khoảng", "type":"match", options: getDateRanges()}, // Search deadline
				{"key":"deadline", name: "Hạn hoàn thành", "type":"number", "role":"date"}, // Search deadline
				{"key":"deadline_within", name: "Deadline trong khoảng", "type":"match", options: getDateRanges()}, // Search deadline
				{"key":"start_time", name: "Thời gian bắt đầu", "type":"number", "role":"date"}, // Search start time
				{"key":"start_time_within", name: "Bắt đầu trong khoảng", "type":"match", options: getDateRanges()}, // Search start time
				{"key":"overdue", name: "Quá hạn", "type":"match", options:[{"label": "Not overdue", value: "no"}, {label: "Overdue", value: "yes"}]},
				{"key":"urgent", name: "Khẩn cấp", "type":"match", options:[{"label": "Not urgent", value: "no"}, {label: "Urgent", value: "yes"}]},
				{"key":"q", name: "Tên công việc", "type":"match"}, // Search full text
				{"key":"tag", name: "Nhãn", "type":"match"},
				{"key":"assign", name: "Giao cho", "type":"match", role:"user"},
				{"key":"creator", name: "Được giao bởi", "type":"match", role:"user"},
				{"key":"project", name: "Dự án hoặc phòng ban", "type":"match", options:getProjectFilters()}
			],
			"search": function(data, url){ // Event call when the filter is set
				AP.toURL("tasks/filter?filter_status=1"+url);
			},
			"save": function(){ // Event call when the filter is save
				Filter.save("api/mytask/filter", function(code){
					Filter.hide();
					AP.redirect("tasks/filter?filter="+code.filter.id+""+code.filter.url);
				},{
					
				});
			},
			"remove": function(){
				 Filter.remove("api/mytask/filter/remove", function(code){
					AP.redirect("tasks");
				},{
					
				});	
			}
		});
		
		initList();
	};
	
	
	/**
	 * @desc Show current filter
	 */
	this.showCurrent=function(){
		var filters=AP.render(Client.filters, function(e){
				return "<div class='-item xo url' data-xurl='tasks/filter?filter="+(e.id)+""+(e.url)+"'> <span class='ficon-circle text-alt"+(e.color)+"'></span> &nbsp; "+(e.name)+" </div>";
		});
		
		var html="<div class='task-user-add -compact'> <div class='sicon'><span class='ficon-filter'></span></div> <div class='txt'> Custom filter: <span class='stitle url' data-url='tasks/filter?filter="+(Client.pageData.filter.id)+""+(Client.pageData.filter.url)+"'>"+(Client.pageData.filter.name)+"</span> </div> </div> <div class='side'> <div class='cta-slim hidden'>Export</div> <div class='dd -cmenuw'> <span>Other filters</span> <div class='-cmenu -padding -no-icon''> "+(filters)+" </div> </div> </div>";
		
		$("#subheader").html(html);
	};
	
	
	this.create=function(){
		Filter.create();
	};
	
	
	this.set=function(key){
		if (key=="overdue"){
			AP.setURLParams({"overdue": "yes"}, true);
		}else if (key=="urgent"){
			AP.setURLParams({"urgent": "yes"}, true);
		}else if (key=="today"){
			AP.setURLParams({"deadline_within": "1"}, true);
		}else if (key=="after"){
			AP.setURLParams({"after": "yes"}, true);
		}else if (key=="subtask"){
			AP.setURLParams({"subtask": "yes"}, true);
		}else if (key=="important"){
			AP.setURLParams({"important": "yes"}, true);
		}else {
			AP.setURLParams({"tag": key}, true);
		}
	};
	
	
	function getProjectFilters(){
		return AP.array.select(Client.projects, function(e){
			return {label: "["+e.metatype+"] "+e.name, value: e.id};
		});
	};
	
	
	function getDateRanges(){
		return [{label: "1 ngày", value: 1}, {label: "3 ngày", value: 3}, {label: "7 ngày", value: 7}, {label: "15 ngày", value: 15}, {label: "30 ngày", value: 30}];
	};
	
	
	function initList(){
		var html=AP.render(Client.filters, function(e){
			return "<div class='link xo' data-xurl='tasks/filter?filter="+(e.id)+""+(e.url)+"'> <div class='full-mask url' data-xurl='tasks/filter?filter="+(e.id)+""+(e.url)+"'></div> <div class='edit' onclick=\"Filter.edit("+(e.id)+",'"+(e.name)+"','"+(e.url)+"','"+(e.color)+"');\"> <span class='-ap icon-mode_edit'></span> </div> <div class='name'><span class='text-alt"+(e.color)+"'>"+(e.name)+"</span></div> <div class='icon'><span class='ficon-circle-o text-alt"+(e.color)+"'></span></div> </div>";
		});
		
		$("#js-cfilters").append(html);
		if (Query.getInt("filter")){
			$("#project-side .link").setActiveURLParam("filter");	
		}else{
			$("#project-side .link").setActiveURL();
		}
	};
	
	
	
};


MyTask.header=new function __MyTaskHeader(){
	this.init=function(){
		Client.pageData.filters=Client.filters;
		
		var cfs=AP.render(Client.filters, function(e){
			return "<div class='-item url' data-url='tasks/filter?filter="+(e.id)+""+(e.url)+"'>"+(e.name)+"</div>";
		});
		
		if (cfs && cfs.length){
			cfs+="<div class='-item-sep'></div>";
		}
		cfs+="<div class='-item -add' onclick='MT.filter.create();'>Thêm bộ lọc tùy chỉnh</div>";
		
		$("#header .js-header-custom-filters").html(cfs);
	};
	
	
	
	/**
	 * @desc Init repeated header
	 */
	this.initRepeated=function(){
		// Mytask query filter
		$("#js-mqs").enter(function(){
			var q=$(this).val();
			if (!q || !q.length){
				q=null;
			}
			
			AP.setURLParams({q: q}, true);
		}).val(Query.get("q"));
		
	
		var html_team=AP.render(Client.projects, function(e){
			if (e.metatype!="team"){
				return "";
			}
			return "<div class='-item js-project-"+(e.id)+" url' data-urlparam='project' data-value='"+(e.id)+"' data-id='"+(e.id)+"'> <span class='name block ap-xdot'>"+(e.name)+"</span> </div>";
		}); 
		
		
		var html_projects=AP.render(Client.projects, function(e){
			if (e.metatype=="team"){
				return "";
			}
			
			return "<div class='-item js-project-"+(e.id)+" url' data-urlparam='project' data-value='"+(e.id)+"'> <span class='name block ap-xdot'>"+(e.name)+"</span> </div>";
		}); 
		
		
		var html="<div class='-item-filter'> <input type='text' name='js-search-pfilter' id='js-search-pfilter' placeholder='Filter dự án & teams'> </div> <div class='scroll-y' style='max-height:300px; margin:0 -10px; padding:0 10px'> <div class='-item js-project-0 url' data-urlparam='project' data-value=''>Tất cả</div> <div class='js-all-projects-filter'> <div class='sub-tt'>Team</div> "+(html_team)+" <div class='sub-tt'>Dự án</div> "+(html_projects)+" </div> </div>";
		
		$("#js-phmenu").html(html).addClass("scroll-y").css("right", -12);
		
		
		if (Query.get("project")){
			var p=AP.array.findObj(Client.projects, Query.get("project"));
			if (p){
				$("#js-mproject .label em").html(p.name);
				$("#js-phmenu .-item").removeClass("checked");
				$("#js-phmenu .js-project-"+p.id).addClass("checked");
			}
		}else{
			$("#js-mproject .js-project-0").addClass("checked");
		}

		$("#js-search-pfilter").quickFilter("#js-mproject .js-all-projects-filter .-item", function($e, q){
			return AP.word.fulltextMatch($e.text(), q);
		});
	};
};


MT.repeated=new function __MyTaskRepeated(){
	this.init=function(){	
		$("#repeated-list .add").click(function(){
			var type=$(this).data("type");
			MT.repeated.create(type);
		});
		
		var weekly=AP.render(Client.pageData.repeated_tasks, function(e){
			if (e.freq!="weekly"){
				return "";
			}
			
			return getHTML(e);
		});
		
		var monthly=AP.render(Client.pageData.repeated_tasks, function(e){
			if (e.freq!="monthly"){
				return "";
			}
			
			return getHTML(e);
		});
		
		
		$("#js-weekly-group").after(weekly);
		$("#js-monthly-group").after(monthly);
		
		$("#repeated-list select").each(function(){
			$(this).val($(this).data("value"));
		}).on("change", function(){
			var val=$(this).val();
			var name=$(this).attr("name");
			
			var $row=$(this).closest(".js-item");
			var id=$row.data("id");
			
			MT.repeated.fix(id, name, val);
		});
		
		Form.inlineTagger("#repeated-list .user", {
			title:"Select user",
			multi: false,
			users: Client.people,
			select: function(user){
				var $row=$(this).closest(".js-item");
				var id=$row.data("id");
				MT.repeated.fix(id, "assign", user.username);
			}
		});
		
		$("#repeated-list .-item").click(function(){
			var action=$(this).data("action");
			var $row=$(this).closest(".js-item");
			var id=$row.data("id");
			
			if (action=="remove"){
				MT.repeated.remove(id);
			}
			
			if (action=="force-run"){
				MT.repeated.dryRun(id);
			}
			
			if (action=="duplicate"){
				MT.repeated.duplicate(AP.array.findObj(Client.pageData.repeated_tasks, id));
			}
			
			if (action=="edit"){
				var e=AP.array.findObj(Client.pageData.repeated_tasks, id);
				if (e){
					MT.repeated.edit(e);	
				}
			}
		});
	};
	
	
	
	this.create=function(type){
		if (!type){
			type="weekly";
		}
		
		var data={};
		var form = Form.create('deliverable-fx',{action: 'api/mytask/repeated/create'})
			.row(
				Form.label({label: "Tên công việc *", "sublabel":"Tên công việc"}),
				Form.input({name: 'name', "placeholder":"Tên công việc, bắt buộc *"})
			)
			.row(
				Form.label({label: "Tần suất lặp lại *", sublabel:"Hàng tuần hoặc hàng tháng"}),
				Form.input({name: 'freq', "placeholder":"", type:"select", options: [{label:"Hàng tuần", value: "weekly"}, {label:"Hàng tháng", value: "monthly"}]}).value(type)
			)
			.row(
				Form.label({label: "Các ngày lặp lại *", sublabel: "Danh sách tất cả các ngày lặp lại"}),
				Form.input({name: 'weekly_dates', type:"checkboxes", options: dowOptions()})
			)
			.row(
				Form.label({label: "Các ngày lặp lại *", sublabel: "Danh sách tất cả các ngày lặp lại"}),
				Form.input({name: 'monthly_dates', type:"text", placeholder:"Danh sách ngày, cách bằng dấu cách hoặc dấu phảy"})
			)
			.row(
				Form.label({label: "Phòng ban-Dự án", "sublabel":"Lựa chọn phòng ban-dự án"}),
				Form.input({name: 'ns_id', "placeholder":"Lựa chọn phòng ban-dự án", type: "select", options: projectOptions()})
			)
			.row(
				Form.label({label: "Nhóm công việc", "sublabel":"Lựa chọn nhóm công việc"}),
				Form.input({name: 'tasklist_id', type: "select", options: [], id:"js-tasklist-ip-id"})
			)
			.row(
				Form.label({label: "Giao cho", "sublabel":"Tag người được giao"}),
				Form.input({name: 'assign', "placeholder":"Tag người được giao", role:"user"})
			)
			.row(
				Form.label({label: "Deadline", "sublabel":"Số giờ cộng thêm"}),
				Form.input({name: 'deadline', "placeholder":"Ví dụ 8, 8.5, hay 30.5 để trống nếu không có deadline", unit: "Giờ"})
			)
			.row(
				Form.label({label: "Người theo dõi", "sublabel":"Danh sách người theo dõi"}),
				Form.input({name: 'followers', "placeholder":"Tag tất cả người cần theo dõi công việc", role:"tag"})
			)
			.row(
				Form.label({label: "Mô tả công việc", sublabel:"Mô tả chỉ tiết công việc"}),
				Form.input({name: 'content', "placeholder":"Mô tả công việc", type:"textarea"}).css({height: 100})
			)
			.row(
				Form.label({label: "Ngày bắt đầu", "sublabel":"Chọn ngày bắt đầu chu trình công việc lặp lại"}),
				Form.input({name: 'stime', "placeholder":"Chọn ngày bắt đầu", role:"date"}).value(AP.time.now())
			)
			.row(
				Form.label({label: "Ngày kết thúc", "sublabel":"Chọn ngày kết thúc chu trình công việc lặp lại"}),
				Form.input({name: 'etime', "placeholder":"Chọn ngày kết thúc", role:"date"})
			)
			.row(
				Form.label({label: "Trạng thái", "sublabel":"Kích hoạt hay không kích hoạt"}),
				Form.input({name: 'status', "placeholder":"Kích hoạt hay không kích hoạt", type: "select", options: statusOptions()})
			)
			.rowHTML("<div class='link'>More advanced options</div>")
			.rowHidden(
				Form.label({label: "Subtasks", sublabel:"Subtasks, one task a line, tag user to assign"}),
				Form.input({name: 'subtasks', "placeholder":"Subtasks, one task a line, tag user to assign", type:"textarea", role:"lines", data:{taggable: 1}}).css({height: 100})
			)
			.rowHidden(
				Form.label({label: "Checklists", sublabel:"Checklists, one todo a line, tag user to assign"}),
				Form.input({name: 'checklists', "placeholder":"Checklists, one todo a line, tag user to assign", type:"textarea", role:"lines", data:{taggable: 1}}).css({height: 100})
			)
			.render(function(form){
				initForm(form);
				form.selector(".link").click(function(){
					$(this).hide();
					form.findRow("subtasks").show();
					form.findRow("checklists").show();
				});
			})
			.hiddens(data)
			.buttons([
				 {label: "Tạo mới", action: function(){
					 Form.submit("deliverable-fx", function(code){
						 if (!code.good()){
							 return AP.alertError(code.message);
						 }
					
						 Form.hide("deliverable-fx");
						 UI.flash("Tạo thành công ...");
						 AP.xRefresh();
					 });
				 }, style: 'ok -success -rounded bold'},
				 {label: "Bỏ qua", action: function(){
					 Form.hide("deliverable-fx");
				 }, style:'-cancel -passive-2 rounded'}
			]);
			
			
			Form.pop({id:'deliverable-fx-dx', width: 600, label: 'Thêm công việc lặp lại', layout: 'inline'}).setForm(form).show();
			
	};
	
	
	
	this.edit=function(e){
		var user=People.get(e.assign_to);
		
		var deadline=deadline;
		if (e.deadline && parseFloat(e.deadline)>0.2){
			deadline=e.deadline;
		}
		
		var opts=[];
		var project=AP.array.findObj(Client.projects, parseInt(e.ns_id));
		if (project){
			opts=AP.select(project.cached_tasklists, function(e){
				return {label: e.name, value: e.id};
			});
		}

		var data={id: e.id};
		var form = Form.create('deliverable-fx',{action: 'api/mytask/repeated/edit'})
			.row(
				Form.label({label: "Tên công việc *", "sublabel":"Tên công việc"}),
				Form.input({name: 'name', "placeholder":"Tên công việc, bắt buộc *"}).value(e.name)
			)
			.row(
				Form.label({label: "Tần suất lặp lại *", sublabel:"Hàng tuần hoặc hàng tháng"}),
				Form.input({name: 'freq', "placeholder":"", type:"select", options: [{label:"Hàng tuần", value: "weekly"}, {label:"Hàng tháng", value: "monthly"}]}).value(e.freq).readOnly()
			)
			.row(
				Form.label({label: "Các ngày lặp lại *", sublabel: "Danh sách tất cả các ngày lặp lại"}),
				Form.input({name: 'weekly_dates', type:"checkboxes", options: dowOptions()}).value(e.dates)
			)
			.row(
				Form.label({label: "Các ngày lặp lại *", sublabel: "Danh sách tất cả các ngày lặp lại"}),
				Form.input({name: 'monthly_dates', type:"text", placeholder:"Danh sách ngày, cách bằng dấu cách hoặc dấu phảy"}).value(e.dates.join(", "))
			)
			.row(
				Form.label({label: "Giao cho", "sublabel":"Tag người được giao"}),
				Form.input({name: 'assign', "placeholder":"Tag người được giao", role:"user"}).value("@"+user.username)
			)
			.row(
				Form.label({label: "Deadline", "sublabel":"Số giờ cộng thêm"}),
				Form.input({name: 'deadline', "placeholder":"Ví dụ 8, 8.5, hay 30.5 để trống nếu không có deadline", unit: "Giờ"}).value(deadline)
			)
			.row(
				Form.label({label: "Người theo dõi", "sublabel":"Danh sách người theo dõi"}),
				Form.input({name: 'followers', "placeholder":"Tag tất cả người cần theo dõi công việc", role:"tag"}).value(e.followers)
			)
			.row(
				Form.label({label: "Phòng ban-Dự án", "sublabel":"Lựa chọn phòng ban-dự án"}),
				Form.input({name: 'ns_id', "placeholder":"Lựa chọn phòng ban-dự án", type: "select", options: projectOptions()}).value(e.ns_id)
			)
			.row(
				Form.label({label: "Nhóm công việc (tasklist)", "sublabel":"Lựa chọn nhóm công việc"}),
				Form.input({name: 'tasklist_id', "placeholder":"Lựa chọn nhóm công việc", type: "select", options: opts, id:"js-tasklist-ip-id"}).value(e.tasklist_id)
			)
			.row(
				Form.label({label: "Mô tả công việc", sublabel:"Mô tả chỉ tiết công việc"}),
				Form.input({name: 'content', "placeholder":"Mô tả công việc", type:"textarea"}).css({height: 100}).value(e.content)
			)
			.row(
				Form.label({label: "Ngày bắt đầu", "sublabel":"Chọn ngày bắt đầu chu trình công việc lặp lại"}),
				Form.input({name: 'stime', "placeholder":"Chọn ngày bắt đầu", role:"date"}).value(e.stime)
			)
			.row(
				Form.label({label: "Ngày kết thúc", "sublabel":"Chọn ngày kết thúc chu trình công việc lặp lại"}),
				Form.input({name: 'etime', "placeholder":"Chọn ngày kết thúc", role:"date"}).value(e.etime)
			)
			.row(
				Form.label({label: "Trạng thái", "sublabel":"Kích hoạt hay không kích hoạt"}),
				Form.input({name: 'status', "placeholder":"Kích hoạt hay không kích hoạt", type: "select", options: statusOptions()}).value(e.status)
			)
			.rowHTML("<div class='link'>More advanced options</div>")
			.rowHidden(
				Form.label({label: "Subtasks", sublabel:"Subtasks, one task a line, tag user to assign"}),
				Form.input({name: 'subtasks', "placeholder":"Subtasks, one task a line, tag user to assign", type:"textarea", role:"lines", data:{taggable: 1}}).css({height: 100}).value(e.subtasks)
			)
			.rowHidden(
				Form.label({label: "Checklists", sublabel:"Checklists, one todo a line, tag user to assign"}),
				Form.input({name: 'checklists', "placeholder":"Checklists, one todo a line, tag user to assign", type:"textarea", role:"lines", data:{taggable: 1}}).css({height: 100}).value(e.checklists)
			)
			.render(function(form){
				initForm(form, e);
				form.selector(".link").click(function(){
					$(this).hide();
					form.findRow("subtasks").show();
					form.findRow("checklists").show();
				});
			})
			.hiddens(data)
			.buttons([
				 {label: "Chỉnh sửa", action: function(){
					 Form.submit("deliverable-fx", function(code){
						 if (!code.good()){
							 return AP.alertError(code.message);
						 }
					
						 Form.hide("deliverable-fx");
						 UI.flash("Hoàn thành chỉnh sửa");
						 AP.refresh();
					 });
				 }, style: 'ok -success -rounded bold'},
				 {label: "Bỏ qua", action: function(){
					 Form.hide("deliverable-fx");
				 }, style:'-cancel -passive-2 rounded'}
			]);
			
			
			Form.pop({id:'deliverable-fx-dx', width: 600, label: 'Chỉnh sửa công việc lặp lại', layout: 'inline'}).setForm(form).show();
			
	};
	
	
	
	this.duplicate=function(e){
		var user=People.get(e.assign_to);
		
		var deadline=deadline;
		if (e.deadline && parseFloat(e.deadline)>0.2){
			deadline=e.deadline;
		}
		
		var opts=[];
		var project=AP.array.findObj(Client.projects, parseInt(e.ns_id));
		if (project){
			opts=AP.select(project.cached_tasklists, function(e){
				return {label: e.name, value: e.id};
			});
		}

		var data={id: e.id, freq: e.freq};
		var form = Form.create('deliverable-fx',{action: 'api/mytask/repeated/create'})
			.row(
				Form.label({label: "Tên công việc *", "sublabel":"Tên công việc"}),
				Form.input({name: 'name', "placeholder":"Tên công việc, bắt buộc *"}).value(e.name)
			)
			.row(
				Form.label({label: "Tần suất lặp lại *", sublabel:"Hàng tuần hoặc hàng tháng"}),
				Form.input({name: 'freqx', "placeholder":"", type:"select", options: [{label:"Hàng tuần", value: "weekly"}, {label:"Hàng tháng", value: "monthly"}]}).value(e.freq).readOnly()
			)
			.row(
				Form.label({label: "Các ngày lặp lại *", sublabel: "Danh sách tất cả các ngày lặp lại"}),
				Form.input({name: 'weekly_dates', type:"checkboxes", options: dowOptions()}).value(e.dates)
			)
			.row(
				Form.label({label: "Các ngày lặp lại *", sublabel: "Danh sách tất cả các ngày lặp lại"}),
				Form.input({name: 'monthly_dates', type:"text", placeholder:"Danh sách ngày, cách bằng dấu cách hoặc dấu phảy"}).value(e.dates.join(", "))
			)
			.row(
				Form.label({label: "Giao cho", "sublabel":"Tag người được giao"}),
				Form.input({name: 'assign', "placeholder":"Tag người được giao", role:"user"}).value("@"+user.username)
			)
			.row(
				Form.label({label: "Deadline", "sublabel":"Số giờ cộng thêm"}),
				Form.input({name: 'deadline', "placeholder":"Ví dụ 8, 8.5, hay 30.5 để trống nếu không có deadline", unit: "Giờ"}).value(deadline)
			)
			.row(
				Form.label({label: "Người theo dõi", "sublabel":"Danh sách người theo dõi"}),
				Form.input({name: 'followers', "placeholder":"Tag tất cả người cần theo dõi công việc", role:"tag"}).value(e.followers)
			)
			.row(
				Form.label({label: "Phòng ban-Dự án", "sublabel":"Lựa chọn phòng ban-dự án"}),
				Form.input({name: 'ns_id', "placeholder":"Tag người được giao", type: "select", options: projectOptions()}).value(e.ns_id)
			)
			.row(
				Form.label({label: "Nhóm công việc (tasklist)", "sublabel":"Lựa chọn nhóm công việc"}),
				Form.input({name: 'tasklist_id', "placeholder":"Lựa chọn nhóm công việc", type: "select", options: opts, id:"js-tasklist-ip-id"}).value(e.tasklist_id)
			)
			.row(
				Form.label({label: "Mô tả công việc", sublabel:"Mô tả chỉ tiết công việc"}),
				Form.input({name: 'content', "placeholder":"Mô tả công việc", type:"textarea"}).css({height: 100}).value(e.content)
			)
			.row(
				Form.label({label: "Ngày bắt đầu", "sublabel":"Chọn ngày bắt đầu chu trình công việc lặp lại"}),
				Form.input({name: 'stime', "placeholder":"Chọn ngày bắt đầu", role:"date"}).value(e.stime)
			)
			.row(
				Form.label({label: "Ngày kết thúc", "sublabel":"Chọn ngày kết thúc chu trình công việc lặp lại"}),
				Form.input({name: 'etime', "placeholder":"Chọn ngày kết thúc", role:"date"}).value(e.etime)
			)
			.row(
				Form.label({label: "Trạng thái", "sublabel":"Kích hoạt hay không kích hoạt"}),
				Form.input({name: 'status', "placeholder":"Kích hoạt hay không kích hoạt", type: "select", options: statusOptions()}).value(e.status)
			)
			.render(function(form){
				initForm(form, e);
			})
			.hiddens(data)
			.buttons([
				 {label: "Chỉnh sửa", action: function(){
					 Form.submit("deliverable-fx", function(code){
						 if (!code.good()){
							 return AP.alertError(code.message);
						 }
					
						 Form.hide("deliverable-fx");
						 UI.flash("Hoàn thành chỉnh sửa");
						 AP.refresh();
					 });
				 }, style: 'ok -success -rounded bold'},
				 {label: "Bỏ qua", action: function(){
					 Form.hide("deliverable-fx");
				 }, style:'-cancel -passive-2 rounded'}
			]);
			
			
			Form.pop({id:'deliverable-fx-dx', width: 600, label: 'Duplicate công việc lặp lại', layout: 'inline'}).setForm(form).show();
			
	};
	
	
	
	this.remove=function(id){
		AP.alertError("Please confirm that you want to remove this repeated task. This cannot be undone.", function(){
			UI.ajaxShow();
			AP.post("api/mytask/repeated/remove", {id: id}, function(code){
				UI.ajaxHide();
				
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				AP.alertSuccess("Đã xóa thành công");
				AP.refresh();
			});
		});
	};
	
	
	
	
	this.fix=function(id, key, value){
		UI.ajaxShow();
		AP.post("api/mytask/repeated/fix", {id: id, key: key, value: value}, function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			UI.flash("Chỉnh sửa thành công");
			AP.refresh();
		});
	};
	
	
	
	this.dryRun=function(id){
		AP.confirm("Force initializing this repeated task?", function(){
			UI.ajaxShow();
			AP.post("api/mytask/repeated/dryrun", {id: id}, function(code){
				UI.ajaxHide();
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				UI.flash("Run successfully ("+code.num_tasks+" tasks created)");
			});
		});
	};
	
	
	
	
	/**
	 * @desc Get a HTML to render a repeated tasks
	 */
	function getHTML(task){
		var p=People.get(task.assign_to);
		var user="<div class='user'>" +
		"	<div class='avatar avatar-32'><div class='user-add'></div></div>" +
		"	<div class='name'>Chưa được giao</div>" +
		"	<div class='title'>Bấm để giao việc</div>" +
		"</div>";
		
		if (p && parseInt(p.id)){
			user="<div class='user relative' data-value='"+p.id+"'>" +
			"	<div class='avatar avatar-32 -circled'><div class='image'><img src='"+AP.xthumb(p.gavatar)+"'/></div></div>" +
			"	<div class='name'>"+p.name+"</div>" +
			"	<div class='title absolute xo' style='right:0px; left:40px;'><div class=' ap-xdot'>"+p.title+"</div></div>" +
			"</div>";
		}
		
		var etime=" infinite";
		if (parseInt(task.etime)){
			etime = AP.i18n.date(task.etime);
		}

		var update_time = (task.data.base_date) ? UI.simpleTime(task.data.base_date) : "";

		return "" +
			"<tr class='js-item' data-id='"+task.id+"'>" +
			"	<td>" +
			"		<div class='main -s"+task.status+"'>" +
			"			<div class='name -item' data-action='edit' data-id='"+task.id+"'>"+task.name+"</div>" +
			"			<div class='desc'>"+task.content+"&nbsp;</div> " +
			"		</div>" +
			"	</td>" +
			"	<td>" +
			"		<div class='freq'><div class='d -item pointer' data-action='edit'>"+getDatesDisplay(task.dates, task.freq)+"</div></div>" +
			"		<div class='duration'>"+AP.i18n.dateRange(task.stime, task.etime)+"</div>" +
			"	</td>" +
			"	<td>" +
			"		<div class='freq'><div class='updated -item pointer'>"+update_time+"</div></div>" +
			"	</td>" +
			"	<td>"+user+"</td>" +
			"	<td>" +
			"		<div class='select'>" +
			"			<select name='ns_id' data-value='"+task.ns_id+"'>"+projectSelections()+"</select>" +
			"		</div>" +
			"	</td>" +
			"	<td>" +
			"		<div class='select'>" +
			"			<select name='status' data-value='"+task.status+"'>" +
			"				<option value='0'>Disabled</option><option value='1'>Enabled</option>" +
			"			</select>" +
			"		</div>" +
			"	</td>" +
			"	<td>" +
			"		<div class='cta -cmenuw'>" +
			"			<div class='cdot'><span class='-ap icon-dots-three-horizontal'></span></div>" +
			"			<div class='-cmenu -padding -no-icon absolute' style='top:27px; right:0px; width: 150px'>" +
			"				<div class='-item' data-action='edit'>Chỉnh sửa</div>" +
			"				<div class='-item' data-action='force-run'>Force run</div>" +
			"				<div class='-item' data-action='duplicate'>Nhân bản</div>" +
			"				<div class='-item' data-action='remove'>Xóa</div>" +
			"			</div>" +
			"		</div>" +
			"	</td>" +
			"</tr>";
	};
	
	
	function dowOptions(){
		return [{label: "Thứ 2", value: 2}, {label: "Thứ 3", value: 3},{label: "Thứ 4", value: 4}, {label: "Thứ 5", value: 5}, {label: "Thứ 6", value: 6}, {label: "Thứ 7", value: 7}, {label: "Chủ nhật", value: 8}];
	};
	
	function statusOptions(){
		return [{label: "kích hoạt", value: 1}, {label: "không kích hoạt", value: 0}];
	};
	
	function projectOptions(){
		var r= AP.select(Client.projects, function(e){
			if (!e.acl || !parseInt(e.acl.task_create) || !e.name || !e.name.length){
				return "";
			}
			
			return {label: "["+e.metatype+"] "+e.name, value: e.id};
		});
		
		r.unshift({label: "Lựa chọn team-project", value: 0});
		
		return r;
	};
	
	
	function projectSelections(){
		var ps=projectOptions();
		return AP.render(ps, function(e){
			return "<option value='"+e.value+"'>"+e.label+"</option>";
		});
	};
	
	
	function getDatesDisplay(dates, freq){
		if (!dates.length){
			return "NONE";
		}
		
		if (freq=="weekly"){
			var cn=false;
			var html=AP.render(dates, function(e){
				e=parseInt(e);
				if (e==8){
					cn=true;
					return "";
				}else{
					return ","+e;
				}
			});
			
			
			if (html.length){
				html= "T"+html.substr(1);
			}
			
			if (cn){
				if (html.length){
					return html+",CN";
				}else{
					return "CN";
				}
			}else{
				return html;
			}
		}else{
			return dates.join(", ");
		}
	};
	
	
	
	
	function initForm(form, e){
		form.find("freq").on("change", function(){
			var val=$(this).val();
			if (val=="weekly"){
				form.findRow("weekly_dates").show();
				form.findRow("monthly_dates").hide();
			}else{
				form.findRow("monthly_dates").show();
				form.findRow("weekly_dates").hide();
			}
		}).change();
		
		if (e && e.ns_id){
			form.find("ns_id").val(e.ns_id);	
		}
		
		form.find("ns_id").on("change", function(){
			var val=$(this).val();
			if (val && parseInt(val)){
				var project=AP.array.findObj(Client.projects, val);
				if (!project){
					$("#js-tasklist-ip-id").html("<option value='0'>-- Lựa chọn --</option>");	
				}else{
					var opts=AP.render(project.cached_tasklists, function(e){
						return "<option value='"+e.id+"'>"+e.name+"</option>";
					});
					
					$("#js-tasklist-ip-id").html(opts);	
				}
			}else{
				$("#js-tasklist-ip-id").html("<option value='0'>--Lựa chọn --</option>");
			}
		}).change();
		
		if (e && e.tasklist_id){
			form.find("tasklist_id").val(e.tasklist_id);
		}
	};
	
	
};


MyTask.form=new function __MTForm(){
	/**
	 * @desc Init subheader form
	 */
	this.init=function(){
		var html="<div id='subheader'> <div class='task-user-add -compact'> <div class='avatar'></div> <div class='txt'> <span class='action' onclick='Project.tform.dialog();'>Tạo công việc mới</span> </div> </div> <div class='side'> "+(this.master_filters)+" "+(this.status_filters)+" <div class='dd -cmenuw' data-param='project'> <em>All projects</em> <div class='-cmenu -padding -no-icon js-projects xo'> <div class='-item-filter'> <input type='text' name='js-search-pfilter' placeholder='Lọc nhanh'/> </div> <div class='js-all-projects-filter scroll-y' style='max-height:300px; margin:0 -10px; padding:0 10px'> <div class='-item url' data-urlparam='project' data-value=''>Tất cả dự án</div> </div> </div> </div> "+(this.sort_filters)+" </div> </div>";
		
		$("#js-myform").html(html);
		initProjects();
		initSubtaskFilters();
		bindStates();
		
		return;
	};
	
	
	/**
	 * @desc Init subheader for direct report team view
	 */
	this.initTeam=function(){
		var team_filters=AP.render(Client.pageData.users, function(e){
			return "<div class='-item url' data-urlparam='user' data-value='"+(e.id)+"'>"+(e.name)+"</div>";
		});
		
		
		var html="<div class='task-user-add -compact'> <div class='sicon'><span class='ficon-th-large'></span></div> <div class='txt'> <span class='stitle url' data-url='tasks/team'>Nhân viên của tôi</span> </div> </div> <div class='side'> <div class='dd -cmenuw' data-param='user'> <em>Tất cả</em> <div class='-cmenu -padding -no-icon'> <div class='-item url' data-urlparam='user' data-value=''>Tất cả</div> "+(team_filters)+" </div> </div> "+(this.status_filters)+" "+(this.sort_filters)+" </div>";
		
		$("#subheader").html(html);
		bindStates();
		
	};
	
	
	
	/**
	 * @desc Init subheader for following view
	 */
	this.initFollowing=function(){
		var html="<div class='task-user-add -compact'> <div class='sicon'><span class='ficon-flash'></span></div> <div class='txt'> <span class='stitle url' data-url='tasks/following'>Đang theo dõi</span> </div> </div> <div class='side'> "+(this.following_status_filters)+" "+(this.sort_filters)+" </div>";
		
		$("#subheader").html(html);
		bindStates();
		
	};
	
	
	
	
	/**
	 * @desc Detecting query and set the active url, and active labels
	 */
	function bindStates(){
		$("#subheader .dd").each(function(){
			var $this=$(this);
			var p=$(this).data("param");
			$(this).find(".-item.url").each(function(){
				if ($(this).data("value")==Query.get(p) || (!$(this).data("value") && !Query.get(p))){
					$(this).addClass("active selected");
					$this.find("em").html($(this).text());
					
					if ($(this).data("value")==Query.get(p) && Query.get(p)){
						$this.find("em").addClass("active");
					}else{
						$this.find("em").removeClass("active");
					}
				}
			});
		});
	};
	
	
	function initProjects(){
		$("#js-myform .js-projects .js-all-projects-filter").append(AP.render(Client.projects, function(e){
			return "<div class='-item ap-xdot url' data-urlparam='project' data-value='"+(e.id)+"'>"+(e.name)+"</div>";
		}));
		
		$("#js-myform .js-projects input").quickFilter("#js-myform .js-projects .js-all-projects-filter .url", function(e, q){
			return AP.word.fulltextMatch($(e).text(), q);
		});
	};
	
	
	function initSubtaskFilters(){
		var cf=AP.log.getCookie("mytask_subtasks");
		if (!cf){
			cf="natural";
		}
		
		if (cf=="none" || cf=="flatten"){
			AP.pageConfig.set("hide_all_subtasks", 1);
		}
		
		AP.pageConfig.set("subtasks", cf);
		
		$("#subheader select[name=js-subtask-options]").val(cf).on("change", function(){
			var v=$(this).val();
			AP.log.setCookie("mytask_subtasks", v);
			AP.xRefresh();
		});
	};
	
	
	
	this.status_filters="<div class='dd -cmenuw' data-param='status'> <em>Tất cả trạng thái</em> <div class='-cmenu -padding -no-icon'> <div class='-item url js-review-mark' data-urlparam='status' data-value=''>Tất cả trạng thái</div> <div class='-item url' data-urlparam='status' data-value='active'>Active (todo + doing)</div> <div class='-item url' data-urlparam='status' data-value='todo'>Todo</div> <div class='-item url' data-urlparam='status' data-value='doing'>Doing</div> <div class='-item url' data-urlparam='status' data-value='done'>Đã hoàn thành</div> <div class='-item url' data-urlparam='status' data-value='review'>Chờ review</div> <div class='-item-sep'></div> <div class='-item url' data-urlparam='status' data-value='donelate'>HT muộn</div> <div class='-item url' data-urlparam='status' data-value='overdue'>Quá hạn</div> <div class='-item url' data-urlparam='status' data-value='urgent'>Khẩn cấp</div> <div class='-item url' data-urlparam='status' data-value='important'>Quan trọng</div> </div> </div>";
	
	
	this.following_status_filters="<div class='dd -cmenuw' data-param='status'> <em>Tất cả trạng thái</em> <div class='-cmenu -padding -no-icon'> <div class='-item url' data-urlparam='status' data-value=''>Tất cả trạng thái</div> <div class='-item url' data-urlparam='status' data-value='todo'>Active (todo + doing)</div> <div class='-item url' data-urlparam='status' data-value='done'>Đã hoàn thành</div> <div class='-item-sep'></div> <div class='-item url' data-urlparam='status' data-value='overdue'>Quá hạn</div> </div> </div>";
	
	
	
	this.master_filters="<div class='dd -cmenuw' data-param='set'> <em>Created &amp; assigned</em> <div class='-cmenu -padding -no-icon'> <div class='-item url' data-urlparam='set' data-value=''>Giao &amp; được giao</div> <div class='-item url' data-urlparam='set' data-value='assigned'>CV được giao</div> <div class='-item url' data-urlparam='set' data-value='created'>CV giao đi</div> <div class='sep-10'></div> <div class='select'> <select name='js-subtask-options'> <option value='flatten'>Tasks &amp; subtasks</option> <option value='natural'>Một cấp subtasks</option> <option value='none'>Không subtasks</option> </select> </div> </div> </div>";
	
	
	this.sort_filters="<div class='dd -cmenuw' data-param='order'> <em>Recently updated</em> <div class='-cmenu -padding -no-icon'> <div class='-item url' data-urlparam='order' data-value=''>Thời gian cập nhật</div> <div class='-item url' data-urlparam='order' data-value='created'>Thời gian tạo</div> <div class='-item url' data-urlparam='order' data-value='deadline'>Thời hạn hoàn thành</div> </div> </div>";
	
};


MT.team=new function __MTTeam(){
	this.list=function(){	
		var users=Client.pageData.users;
		users.sort(function(e, f){
			if(e.stats.total == 0) {
				var e1 = 0;
			}

			if(f.stats.total == 0) {
				var f1 = 0;
			}

			if (parseInt(e.stats.total)){
				var e1=parseInt(e.stats.done)*100/parseInt(e.stats.total);
			}

			if (parseInt(f.stats.total)){
				var f1=parseInt(f.stats.done)*100/parseInt(f.stats.total);
			}

			if(Query.get("order") == 'quality') {
				return f1-e1;
			} else {
				return parseInt(f.stats.total) - parseInt(e.stats.total);
			}
		});
		
		$("#js-users-group").html(AP.render(users, function(e){
			return getHeader(e)+getProjects(e);
		}));
	};
	
	
	
	
	function getHeader(e){
		var w1=0, w2=0;
		
		if (parseInt(e.stats.total)){
			w1=parseInt(e.stats.done)*100/parseInt(e.stats.total);
			w2=parseInt(e.stats.overdue)*100/parseInt(e.stats.total);
		}
		
		return "<tr class='js-user-"+e.id+"'>" +
			"<td class='guser'>" +
			"	<div class='user url' data-url='/myteam/user/" + e.username + "'>" +
			"		<div class='avatar avatar-32 -circled'><div class='image'><img src='"+AP.xthumb(e.gavatar)+"'/></div></div>" +
			"		<div class='name'>"+e.name+"</div>" +
			"		<div class='info'>"+e.title+"</div>" +
			"	</div>" +
			"</td>" +
			"<td><b class='bc'>"+e.stats.project+"</b></td>" +
			"<td><b class='bc'>"+e.stats.total+"</b></td>" +
			"<td><b class='bc text-success'>"+e.stats.done+"</b></td>" +
			"<td><b class='bc'>"+e.stats.active+"</b></td>" +
			"<td><b class='bc'>"+e.stats.review+"</b></td>" +
			"<td><b class='bc'>"+e.stats.after+"</b></td>" +
			"<td><b class='bc text-error'>"+e.stats.overdue+"</b></td>" +
			"<td><div class='bar'><div class='p -done' style='width:"+w1+"%'></div> <div class='p -error' style='width:"+w2+"%'></div> </div></td>" +
		"</tr>";
	};
	
	function getProjects(e){
		return "";
	};
};


MyTask.side=new function __MyTaskSide(){
	this.init=function(){
		initCanvas();
		initDirectReports();
		initViewerStats();
		
		MyTask.filter.init();
		Side.milestone.init();
		
		$("#js-side-milestones .milestone").each(function(){
			$(this).find(".name").addClass("url").data({"url":"milestone/"+$(this).data("id")})
		})
		
		$("#js-side-milestones .milestone .name").setActiveURLParam("milestone");
		
		if (Client.path && Client.path.current=="tasks/following"){
			$("#js-cfilters").parent().parent().hide();
			$("#js-side-milestones").parent().parent().hide();
		}
		
		if (Client.path && Client.path.current=="tasks/team"){
			$("#js-cfilters").parent().parent().hide();
			$("#js-side-milestones").parent().parent().hide();
		}
		
		
		if (Client.path && Client.path.current=="tasks/filter"){
			$("#js-side-milestones").parent().parent().hide();
		}
	};
	
	
	
	function initCanvas(){
		var html="<div class='section'> <div class='overview'> <div class='box projinfo -with-image'> <div class='image'><img src='"+(AP.xthumb(Client.viewer.gavatar))+"'/></div> <div class='projname'>"+(Client.viewer.name)+"</div> <div class='projdesc'> "+(Client.viewer.title)+"&nbsp; </div> <div id='js-me-side-stats'></div> </div> </div> <div class='subsection'> <div class='subheader'> <div class='icon'><span class='ficon-asterisk'></span></div> <div class='title -dd' title='In the last 07 days'>Mới được giao</div> </div> </div> <div class='subsection'> <div class='subheader'> <div class='icon'><span class='ficon-asterisk'></span></div> <div class='title -dd' title='In the last 07 days'>Mới giao đi</div> </div> </div> </div> <div class='section js-milestones'> <div class='box'> <div class='box-title'>Mục tiêu</div> <div id='js-side-milestones' class='body'></div> </div> </div> <div class='section'> <div class='box'> <div class='box-title'> Bộ lọc tùy chỉnh <div class='action' id='js-filter-add'>+ Thêm</div> </div> <div class='sidelinks' id='js-cfilters'></div> </div> </div> <div class='section'> <div class='box' style='padding-bottom:0px;'> <div class='box-title'>Nhân viên của tôi</div> </div> <div class='body'> <div class='items' id='js-cmembers'></div> </div> </div>";
		
		$("#project-side").html(html);
	};
	
	
	function initViewerStats(){
		if (!Client.pageData.show_viewer){
			return;
		}

		var total=0;
		var done=0;
		var urgencies=[];
		
		for (var i=0; i<Client.pageData.tasks.length; i++){
			var task=Client.pageData.tasks[i];
			if (task.user_id==Client.viewer.id){
				if (parseInt(task.status)){
					done++;
				}else{
					if (parseInt(task.urgent)){
						urgencies.push(task);
					}
				}
				
				total++;
			}
		};
		
		var w=0;
		if (total>0){
			w=done*100/total;
		}
		
		var html="<div class='row'> <span class='ficon-check-square-o icon'></span> CV được giao <div class='v -dd url inline'><b>"+(w.toFixed(2))+"</b>%</div> </div> <div class='bar -infow'> <div class='c' style='background-color: "+(Color.get(4))+"; width:"+(w)+"%'></div> </div> <div class='row -upper'><div class='v -full'>"+(done)+"/"+(total)+" hoàn thành</div></div>";
		
		$("#js-me-side-stats").html(html);
		
	};
	
	
	function initDirectReports(){
		var html=AP.render(Client.people, function(e){
			if (!Me.isManagerOf(e)){
				return "";
			}
			
			return "<div class='user url' data-url='user/"+(e.username)+"'> <div class='name'> <div class='main'>"+(e.name)+"</div> <div class='info ap-xdot'>"+(e.title)+"&nbsp;</div> </div> <div class='avatar avatar-32 -circled'><div class='image'><img src='"+(AP.xthumb(e.gavatar))+"'/></div></div> </div>";
		});
		
		$("#js-cmembers").html("<div class='people'><div class='subbox'>"+(html)+"</div></div>");
	};
	
	
};



var UT=new function __UT(){
	
};



UT.list=new function __UTList(){
	this.init=function(opts){
		opts=$.extend({stats: true}, opts);
		
		if (opts.stats){
			this.showStats();	
		}
		
		var html="";
		var tasks=Client.pageData.tasks;
		var groups=UT.list.group(tasks, function(e){
			return {id: e.ns.id, name: e.ns.name};
		});
		
		for (var i=0; i<groups.length; i++){
			var g=groups[i];
			g.stats=computeBasicProjectStats(g);
			var tasks_html=AP.render(g.tasks, function(e){
				return Board.ui.getHTML(e);
			});
			
			html+="<div class='tasklist'> <div class='group-header'> <div class='collapse'><span class='-ap icon-triangle-right'></span></div> <div class='title pointer url' data-url='paction/0/tasklist.toggle'> "+(g.name)+" </div> </div> <div class='list tasks'>"+(tasks_html)+"</div> </div>";
		}
		
		
		var phtml=AP.render(groups, function(e){
			if (!e.stats.total){
				return "";
			}
			
			return "<div class='item js-item-"+e.id+"' data-project='"+e.id+"'>" +
				"<div class='ap-xdot label' title='"+e.name+"'>"+e.name+"</div>" +
				"<div class='num'><b>"+e.stats.total+"</b> công việc</div>" +
			"</div>";
		});
		
		if (Query.get("project")){
			phtml="<div class='item js-item' data-project='0'><div class='label'>Tất cả dự án - team</div></div>"+phtml;
		}
		
		
		$("#js-user-project-links").html(phtml);
		
		$("#js-user-project-links .item").click(function(){
			var id=$(this).data("project");
			if (!id){
				AP.setURLParams({project: null}, true);	
			}else{
				AP.setURLParams({project: id}, true);
			}
		});
		
		$("#tasklists").html(html);
		
		
		$("#tasklists").click(function(e){
			Board.clean("#tasklists", e.target);
		});
	};


	this.mobile = function () {
		return this.showStats();
	};
	
	
	
	this.group=function(objs, group_fn){
		var groups={};
		for (var i=0; i<objs.length; i++){
			var g=group_fn(objs[i]);
			if (groups["__g"+g.id]){
				groups["__g"+g.id].tasks.push(objs[i]);
			}else{
				groups["__g"+g.id]={id: g.id, name: g.name, tasks: [objs[i]]}
			}
		}
		
		var r=[];
		for (var key in groups){
			r.push(groups[key]);
		}
		
		return r;
	};
	
	
	
	this.showStats=function(){
		var time = AP.time.now();
		var etime = Query.get("etime");
		if (etime) {
			etime_array = etime.split("/");
			etime_string = etime_array[1] + "/" + etime_array[0] + "/" + etime_array[2];
			time = AP.time.midnight(new Date(etime_string) / 1000);
		}
		
		var today=getDaily(time);
		
		var percent_todo = today.total ? (100 * today.todo / today.total) : 0;
		var percent_doing = today.total ? (100 * today.doing / today.total) : 0;
		var percent_done = today.total ? (100 * today.done / today.total) : 0;
		var percent_done_late = today.total ? (100 * today.done_late / today.total) : 0;
		var percent_done_ontime = today.total ? (100 * today.done_ontime / today.total) : 0;
		var percent_overdue = today.total ? (100 * today.overdue / today.total) : 0;
		var percent_active = today.total ? (100 * today.active / today.total) : 0;
		
		$("#js-executive-stats").html("<div class='keynum'><b>"+AP.data.numberFormat(today.total)+"</b> <em>công việc</em></div>" +
		"<div class='visuals'>" +
			"<div class='bar'>" +
			"	<div class='-b a' style='width: "+percent_todo+"%'></div>" +
			"	<div class='-b o' style='width: "+percent_doing+"%'%'></div>" +
			"	<div class='-b s' style='width: "+percent_done+"%'%'></div>" +
			"</div>" +
			"<div class='txt'>" +
			"	<b class='text-main'>"+today.todo+"</b> cần làm &middot; " +
			"	<b class='text-alt6'>"+today.doing+"</b> đang làm &middot; " +
			"	<b class='text-success'>"+today.done+"</b> hoàn thành" +
			"</div>" +
		"</div>" +
		"<div class='xsep'></div>" +
		// "<div class='visuals'>" +
		// 	"<div class='bar'>" +
		// 	"	<div class='-b a' style='width: "+percent_active+"%'%'></div>" +
		// 	"	<div class='-b e' style='width: "+percent_overdue+"%'%'></div>" +
		// 	"	<div class='-b o' style='width: "+percent_done_late+"%'></div>" +
		// 	"	<div class='-b s' style='width: "+percent_done_ontime+"%'%'></div>" +
		// 	"</div>" +
		// 	"<div class='txt'>" +
		// 	"	<b class='text-main'>"+today.active+"</b> đang thực hiện &middot; " +
		// 	"	<b class='text-error'>"+today.overdue+"</b> quá hạn &middot; " +
		// 	"	<b class='text-alt6'>"+today.done_late+"</b> hoàn thành sau hạn &middot; " +
		// 	"	<b class='text-success'>"+today.done_ontime+"</b> hoàn thành đúng hạn" +
		// 	"</div>" +
		// "</div>" +
		"<div class='xsep'></div>" +
		"<div class='subnums'>" +
		"	<div class='subnum'><b class='text-alt7'><span class='url' data-xurl='action/filter/overdue'>"+AP.data.numberFormat(today.overdue)+"</span></b> <em>quá hạn</em></div>" +
		"	<div class='subnum'><b class='text-alt8'><span class='url' data-xurl='action/filter/urgent'>"+AP.data.numberFormat(today.urgent)+"</span></b> <em>khẩn cấp</em></div>" +
		"</div>" +
		// "<div class='subnums'>" +
		// "	<div class='subnum'><b class='text-alt7'><span class='url' data-xurl='action/filter/reviewing'>"+AP.data.numberFormat(today.review)+"</span></b> <em>chờ đánh giá</em></div>" +
		// "	<div class='subnum'><b class='text-alt8'><span class='url' data-xurl='action/filter/important'>"+AP.data.numberFormat(today.important)+"</span></b> <em>quan trọng</em></div>" +
		// "</div>" +
		"");
		
		
		var stime=parseInt(Client.pageData.cfilter.stime);
		var etime=parseInt(Client.pageData.cfilter.etime);
		
		var totals=[];
		var actives=[];
		var overdues=[];
		var reviews=[];
		var dones=[];
		var dates=[];
		
		for (var i=stime; i<etime; i=i+24*3600){
			var stat=getDaily(i);
			var d=AP.time.time("%d/%m", i);
			dates.push(d);
			
			totals.push([d, stat.total]);
			actives.push([d, stat.active]);
			dones.push([d, stat.done]);
			overdues.push([d, stat.overdue]);
		} 
		
		
		Highcharts.chart('container', {
			chart:{
				height: 190
			},
			title: {
				text: '',
				display: 'none'
			},
		
			yAxis: {
				title: {	
					text: null
				}
			},
			xAxis:{
				categories: dates
			},
			legend: {
				layout: 'vertical',
				align: 'right',
				verticalAlign: 'middle',
				itemStyle:{
					fontSize: '10px',
					fontWeight: 'normal'
				},
				itemWidth: 60
			},
			plotOptions: {
				series: {
					label: {
						connectorAllowed: false
					}
				},
			},
		
			series: [{
				name: 'Tất cả',
				data: totals,
				type: "area",
				opacity: 0.2
			}, {
				name: 'Hoàn thành',
				data: dones,
				color: "#7abd1a",
			}, {
				name: 'Quá hạn',
				data: overdues,
				color: "rgba(230,40,40,0.8)",
				fillColor: "rgba(230,40,40,0.1)"
			}],
		
			responsive: {
				rules: [{
					condition: {
						maxWidth: 500
					},
					chartOptions: {
						legend: {
							layout: 'horizontal',
							align: 'center',
							verticalAlign: 'bottom'
						}
					}
				}]
			}
		
		});
	};
	
	
	
	function getDaily(ts){
		var total=0;
		var todo=0;
		var doing=0;
		var done=0;
		var done_late=0;
		var done_ontime=0;
		var overdue=0;
		var active=0;
		var urgent=0;
		var important=0;
		var review=0;

		for (var i=0; i<Client.pageData.tasks.length; i++){
			var e = Client.pageData.tasks[i];
			var since_int = parseInt(e.since);
			var status_int = parseInt(e.status);
			var start_time_int = parseInt(e.start_time);
			var completed_time_int = parseInt(e.completed_time);
			var deadline_int = parseInt(e.deadline);
			var urgent_int = parseInt(e.urgent);
			var important_int = parseInt(e.important);
			var review_int = parseInt(e.review);

			if (ts > since_int){
				total++;

				if (!status_int && ((start_time_int > ts) || (!start_time_int)) ){
					todo++;
				}

				if (!status_int && (start_time_int < ts && start_time_int > 0)){
					doing++;
				}
				
				if (status_int){
					done++;
				}

				if (status_int && deadline_int && completed_time_int > deadline_int ){
					done_late++;
				}

				if (status_int && ((deadline_int && completed_time_int < deadline_int) || !deadline_int)){
					done_ontime++;
				}

				if (!status_int && (deadline_int && deadline_int < ts)){
					overdue++;
				}

				if (!status_int && ((deadline_int && deadline_int > ts) || !deadline_int)){
					active++;
				}
				
				if (urgent_int){
					urgent++;
				}

				if (important_int){
					important++;
				}
				
				if (review_int){
					review++;
				}
			}
		}
		
		return {total: total, todo: todo, doing: doing, done:done, done_late: done_late, done_ontime: done_ontime, overdue: overdue, active: active, urgent: urgent, important: important, review: review, ts: ts};
	};
	
	
	
	function computeBasicProjectStats(p){
		var total=0;
		var active=0;
		var overdue=0;
		var done=0;
		var review=0;
		
		for (var i=0; i<p.tasks.length; i++){
			total++;
			if (parseInt(p.tasks[i].status)){
				done++;
			}else if(parseInt(p.tasks[i].review)){
				review++;
			}else{
				active++;
			}
			
			if (parseInt(p.tasks[i].overdue)){
				overdue++;
			}
		}
		
		return {total: total, active: active, overdue: overdue, done:done, review: review}
	};
	
	
};





UT.menu=new function __UTMenu(){
	this.init=function(){
		Online.loaded(function(){
			Wework.people.menu();
		});
	};
};


UT.filter=new function __UTFilter(){
	this.init=function(){
		$("#ut-filter input[name=stime]").data("value", Client.pageData.cfilter.stime);
		$("#ut-filter input[name=etime]").data("value", Client.pageData.cfilter.etime);
		

		if ($("#ut-filter input[name=query]").val()){
			$("#ut-filter input[name=query]").after("<div class='-remove'><span class='-ap icon-close'></span></div>");
			$("#ut-filter .-remove").click(function(){
				$(this).closest(".input").find("input").val("").change();
			});	
		}
		
		$("#ut-filter .submit").click(function(){
			if ($("#ut-filter input[name=query]").length){
				$("#ut-filter input[name=query]").change();	
			}else{
				AP.xRefresh();
			}
		});
		
		$("#js-user-projects").append(AP.render(Client.pageData.user_projects, function(e){
			return "<option value='"+e.id+"'>"+e.name+"</option>";
		}));
		
		Form.render("#ut-filter");
		
		$("#ut-filter .js-fx").on("change", function(){
			var val=$(this).val();
			var key=$(this).data("key");
			
			var obj={};
			obj[key]=encodeURIComponent(val);
			
			if (val=="" || val==0){
				obj[key]=null;
				AP.setURLParams(obj, true);
			}else{
				AP.setURLParams(obj, true);
			}
		});
	
	};
};


UT.side=new function __UTAssign(){
	this.init=function(){
		initCanvas();
		initDirectReports();
		
		// Init milestones
		if (Client.pageData.milestones){
			Side.milestone.init();	
		}else{
			$("#js-side-milestones").parent().hide();
		}
	};
	
	
	function initCanvas(){
		var html="<div class='section'> <div class='overview'> <div class='box projinfo -with-image'> <div class='image'><img src='"+(AP.xthumb(Client.pageData.user.gavatar))+"'/></div> <div class='projname'>"+(Client.pageData.user.name)+"</div> <div class='projdesc'>"+(Client.pageData.user.title)+"&nbsp;</div> </div> </div> <div id='ut-stats'> <div class='box'> <div class='executive' id='js-executive-stats'></div> </div> <div class='box -middle'> <div class='graph'> <div id='js-graph'><div id='container'></div></div> </div> </div> <div class='box'> <div class='title'>Phân chia theo dự án</div> <div class='items scroll-y forced-scroll' id='js-user-project-links'></div> </div> </div> </div> <div class='section js-milestones'> <div class='box'> <div class='box-title'>Milestones</div> <div id='js-side-milestones' class='body'></div> </div> </div> <div class='section hidden'> <div class='box'> <div class='box-title'> Custom filters </div> <div class='sidelinks' id='js-cfilters'></div> </div> </div> <div class='section'> <div class='box' style='padding-bottom:0px;'> <div class='box-title'>Nhân viên của tôi</div> </div> <div class='body'> <div class='items' id='js-cmembers'></div> </div> </div>";
		
		$("#project-side").html(html);
	};
	
	
	function initDirectReports(){
		var people=Me.getDirectReports(Client.pageData.user);
		
		var html=AP.render(people, function(e){
			return "<div class='user url' data-url='user/"+(e.username)+"'> <div class='name'> <div class='main'>"+(e.name)+"</div> <div class='info ap-xdot'>"+(e.title)+"&nbsp;</div> </div> <div class='avatar avatar-32 -circled'><div class='image'><img src='"+(AP.xthumb(e.gavatar))+"'/></div></div> </div>";
		});
		
		$("#js-cmembers").html("<div class='people'><div class='subbox'>"+(html)+"</div></div>");
	};
	
};
var Dept=new function __ProjectDept(){
	this.fromContext=function(id){
		return AP.array.findObj(Client.depts, id);
	};
	
	
	/**
	 * @desc Create a project dept
	 */
	this.create=function(){	
		var data={};
		var form=Form.create('fly-tasklist-fx',{'action': "api/dept/create"})
		.row(
			Form.label({label: "Department name *"}),
			Form.input({name: 'name', placeholder: "Dept name"}).autoSubmit()
		).addClass("-big")
		.row(
			Form.label({label: "Department owners *"}),
			Form.input({name: 'owners', placeholder: "Dept owners can manage milestones", role:"tag"})
		).addClass("-big")
		.row(
			Form.label({label: "Group accesses"}),
			Form.input({name: 'teams', placeholder: "Leave blank to allow accesses for everyone", role:"teams"})
		)
		.buttons([
			 {label: "Create", action: function(){
				 Form.submit("#fly-tasklist-fx", function(code){
					 if (!code.good()){
						 return AP.alertError(code.message);
					 }
					 
					 UI.flash("Department created successfully ...");
					 Form.hide("fly-tasklist-fx");
					 AP.refresh();
				 })
			 }, style: 'ok -success -rounded bold'},
			 {label: "Hủy", action: function(){
				 Form.hide("fly-tasklist-fx");
			 }, style:'cancel -passive-2 -rounded'}
		])
		.hiddens(data)
		.render(function(fref){
		});


		Form.pop({id:'fly-tasklist-dx', width: 480, label: "Create a new department", layout: 'flat', closable: false}).setForm(form).show().focus('name');
	};
	
	
	/**
	 * @desc Create a project dept
	 */
	this.edit=function(id){
		var dept=Dept.fromContext(id);
		if (!dept){
			return;
		}
		
		var data={id: dept.id};
		var form=Form.create('fly-tasklist-fx',{'action': "api/dept/edit"})
		.row(
			Form.label({label: "Department name *"}),
			Form.input({name: 'name', placeholder: "Dept name"}).value(dept.name).autoSubmit()
		).addClass("-big")
		.row(
			Form.label({label: "Department owners *"}),
			Form.input({name: 'owners', placeholder: "Dept owners can manage milestones", role:"tag"}).value(dept.owners)
		).addClass("-big")
		.row(
			Form.label({label: "Group accesses"}),
			Form.input({name: 'teams', placeholder: "Leave blank to allow accesses for everyone", role:"teams"}).value(dept.teams)
		)
		.buttons([
			 {label: "Save", action: function(){
				 Form.submit("#fly-tasklist-fx", function(code){
					 if (!code.good()){
						 return AP.alertError(code.message);
					 }
					 
					 UI.flash("Department updated successfully ...");
					 Form.hide("fly-tasklist-fx");
					 AP.refresh();
				 })
			 }, style: 'ok -success -rounded bold'},
			 {label: "Hủy", action: function(){
				 Form.hide("fly-tasklist-fx");
			 }, style:'cancel -passive-2 -rounded'}
		])
		.hiddens(data)
		.render(function(fref){
		});


		Form.pop({id:'fly-tasklist-dx', width: 480, label: "Edit department", layout: 'flat', closable: false}).setForm(form).show().focus('name');
	};
	
	
	/**
	 * @desc Remove a department
	 */
	this.remove=function(id){
		// AP.alertError("Currently this function is not supported yet.");
		AP.confirm("Confirm to delete department? Only department without projects and milestones could be removed.", function(){
			UI.ajaxShow();
			AP.post("api/dept/remove",{id: id}, function(code){
				UI.ajaxHide();
				
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				UI.flash("Update successfully");
				AP.refresh();
			});
		});
	};
	
	
	/**
	 * @desc Build an array of groups, each containing projects
	 */
	this.build=function(projects){
		if (!projects){
			projects=Client.projects;
		}
		
		var groups=AP.array.group(projects, function(e){
			if (!parseInt(e.group_id)){
				return getEmptyGroup(e);
			}
			
			var g=Project.group.get(e.group_id);
			if (!g){
				return getEmptyGroup(e);
			}
			
			return g;
		});
		
		return groups;
	};
	
	
	
	function getEmptyGroup(e){
		return {id:0, name: "Uncategorized", order: 0}
		
	};
};



Dept.side=new function __DeptSide(){
	this.init=function(){
		var owners=AP.render(Client.pageData.dept.owners, function(e){
			var u=People.get(e);
			if (!u || !parseInt(u.uid)){
				return '';
			}
			
			return "<div class='user url' data-username='"+(u.username)+"'> <div class='avatar avatar-32 -circled''> <div class='image'><img src='"+(AP.xthumb(u.gavatar))+"'></div> </div> <div class='name'> <div class='main'><em class='url username'>"+(u.name)+"</em></div> <div class='info ap-xdot'>"+(u.title)+"</div> </div> </div>";
		});
		
		
		var teams=AP.render(Client.pageData.dept.teams, function(e){
			var u=UserGroup.get(e);
			if (!u){
				return '';
			}
			
			return "<div class='user url'> <div class='avatar avatar-32 -circled'> "+(UI.textAvatar(u.name, 32))+" </div> <div class='name'> <div class='main' style='padding:8px 0 8px 0'> <em class='url username'>"+(u.name)+"</em> </div> </div> </div>";
		});
		
		
		
		$("#js-dept-owners").html("<div class='subheader'> <div class='icon'><span class='ficon-bookmark'></span></div> <div class='title -dd url' data-url=':active:parent:parent'> Quản lý bởi "+(AP.data.zeroPrefix(Client.pageData.dept.owners.length))+" thành viên </div> </div> <div class='body'> <div class='people'> <div class='subbox'>"+(owners)+"</div> </div> </div>");
		
		
		$("#js-dept-teams").html("<div class='subheader'> <div class='icon'><span class='ficon-bullseye'></span></div> <div class='title -dd url' data-url=':active:parent:parent'> Có thể tiếp cận bởi "+(AP.data.zeroPrefix(Client.pageData.dept.teams.length))+" user groups </div> </div> <div class='body'> <div class='people'> <div class='subbox'>"+(teams)+"</div> </div> </div>");
		
		$("#js-side-projects").html(AP.render(Client.pageData.projects, function(e){
			return getProjects(e);
		}));
		
		$("#js-side-projects .js-complete-sektor").each(function () {
			$(this).angular({
				bg:"#eee",
				arc: true
			});
		});
	};
	
	
	
	function getProjects(e){
		var w=0;	
		if (parseInt(e.stats.total)){
			w=(parseInt(e.stats.complete)*100.0/parseInt(e.stats.total)).toFixed(1);
		}
		
		var content='No description';
		if (e.content){
			content=e.content;
		}
		return "<div class='proj url' data-url='"+(e.path)+"'> <div class='icon'> <div id='js-status-"+(e.id)+"' class='js-complete-sektor' style='width:28px; height:28px' data-color='"+(Color.get(4))+"' data-stroke='13' data-percent='"+(w)+"'></div> </div> <div class='name'>"+(e.name)+"</div> <div class='bar'> <div class='c' style='width:"+(w)+"%'></div> </div> <div class='info ap-xdot'><em>"+(w)+"</em>% &middot; "+(safe(content))+"</div> </div>";
	};
	
};


Dept.milestone=new function __DeptMilestones(){
	this.list=function(){
		if (!Client.pageData.milestones){
			return;
		}
		
		Client.pageData.milestones.sort(function(e1, e2){
			return parseInt(e2.time)-parseInt(e1.time);
		});
		
		
		var html=AP.render(Client.pageData.milestones, function(e){
			return getHTML(e);
		});
		
		$("#js-dept-milestones").html(html);
		
		
		// Filter
		$("#js-dept-header-search").attr("placeholder", "Lọc nhanh mục tiêu").quickFilter("#collection .li", function($e, q){
			return AP.word.fulltextMatch($e.text(), q);
		});
	};
	
	
	function getHTML(e){
		var ec='';
		if (parseInt(e.time)>=AP.time.now()){
			ec='-active';
		}
		
		var u=People.get(e.user_id);
		var p=Project.fromContext(e.project_id);
		
		if (!p){
			p={name: "Project #"+e.project_id, id: e.project_id, path: "project-"+e.project_id};
		}
		
		return "<tr class='tr li js-ms "+(ec)+"'> <td> <div class='ms-time'>"+(AP.time.time('<em>%V</em><span>%d/%m</span>', e.time))+"</div> </td> <td> <div class='ms'> <div class='ms-icon'></div> <div class='ms-title url' data-url='milestone/"+(e.id)+"'>"+(e.name)+"</div> <div class='info'>Tạo bởi @"+(e.username)+" lúc "+(AP.i18n.datetime(e.since))+"</div> </div> </td> <td> <div class='ms-project'> <span class='url' data-url='"+(p.path)+"'>"+(p.name)+"</span> </div> </td> <td> <div class='ms-bar' title='"+(e.done)+"/"+(e.total)+"'><div class='c' style='width:"+(e.complete)+"%'><div class='candy -black'></div></div></div> </td> <td> <div class='ms-owner url' data-username='"+(u.username)+"'> <div class='img'><img src='"+(AP.xthumb(u.gavatar))+"'/></div> <div class='uname ap-xdot'>"+(u.first_name)+"</div> </div> </td> </tr>";
	};
	
};


Dept.collection=new function __DeptCollection(){
	this.list=function(){
		var html=AP.render(Client.depts, function(e){
			var teams = "";
			if (e.teams.length){
				teams=AP.render(e.teams, function(t){
					var team=UserGroup.get(t);
					if (team === null) {
						return '';
					}

					return "<div class='avatar' title='"+(team.name)+"'>"+(UI.textAvatar(team.path, 32))+"</div>";
				});
			}
			
			return "<div class='item -compact'> <div class='w'> <div class='title url' data-url='"+(e.path)+"'>"+(e.name)+"</div> <div class='info'>Tạo bởi @"+(e.username)+" lúc "+(AP.i18n.date(e.since))+"</div> <div class='users clear-fix'>"+(teams)+"</div> </div> </div>";
		});
		
		$("#js-depts").html(html);
		
		$("#header .side .search input").quickFilter("#collection .item", function($e, q){
			return AP.word.fulltextMatch($e.text(), q);
		});
	};
};


Dept.projectManager=new function __DeptProjectManager(){
	this.init=function(){
		// Filter
		$("#js-dept-header-search").attr("placeholder", "Lọc nhanh dự án - teams").quickFilter("#list-projects .li", function($e, q){ 
			return AP.word.fulltextMatch($e.text(), q);
		});

		
		$("#list-projects th:eq(2)").hide();
		$("#list-projects tr").each(function(){
			$(this).find("td:eq(2)").hide();
		});
	};
};
var Milestone=new function __Milestone(){
	this.fromContext=function(id){
		if (Client.tempData && Client.tempData.milestone && parseInt(Client.tempData.milestone.id)==parseInt(id)){
			return Client.tempData.milestone;
		}
		
		return AP.array.findObj(Client.pageData.milestones, id);
	};
	
	this.display=function(id){
		return MilestoneDisplay.display(id);
	};
	
	
	/**
	 * @desc Create a new milestone
	 */
	this.create=function(){
		var data={project_id: Client.pageData.project.id};
		var form=Form.create('fly-tasklist-fx',{'action': "api/milestone/create"})
		.row(
			Form.label({label: "Milestone *"}),
			Form.input({name: 'name', placeholder: "Milestone name"}).autoSubmit()
		).addClass("-big")
		.row(
			Form.label({label: "Milestone date *"}),
			Form.input({name: 'date', placeholder: "Date of milestone", role:"date"})
		).addClass("-big")
		.row(
			Form.label({label: "Person in charge *"}),
			Form.input({name: 'username', placeholder: "Tag person in charge", role:"user"})
		)
		.row(
			Form.label({label: "Description *"}),
			Form.input({name: 'content', placeholder: "Milestone description", type:"textarea"})
		)
		.row(
			Form.label({label: "Linked project/team"}),
			Form.input({name: 'fake', placeholder: "", type:"fake"}).value(Client.pageData.project.name)
		)
		.buttons([
			 {label: "Create", action: function(){
				 Form.submit("#fly-tasklist-fx", function(code){
					 if (!code.good()){
						 return AP.alertError(code.message);
					 }
					 
					 UI.flash("Milestone created successfully ...");
					 Form.hide("fly-tasklist-fx");
					 AP.refresh();
				 })
			 }, style: 'ok -success -rounded bold'},
			 {label: "Hủy", action: function(){
				 Form.hide("fly-tasklist-fx");
			 }, style:'cancel -passive-2 -rounded'}
		])
		.hiddens(data)
		.render(function(fref){
			
		});

		Form.pop({id:'fly-tasklist-dx', width: 600, label: "Create a new milestone", layout: 'flat', closable: false}).setForm(form).show().focus('name');
	};
	
	
	
	/**
	 * @desc Edit a milestone
	 */
	this.edit=function(id){
		var m=Milestone.fromContext(id);
		if (!m){
			return;
		}
		
		var project=Project.fromContext(m.project_id);
		if (!project){
			return;
		}
		
		var data={project_id: project.id, id: m.id};
		var form=Form.create('fly-tasklist-fx',{'action': "api/milestone/edit"})
		.row(
			Form.label({label: "Milestone *"}),
			Form.input({name: 'name', placeholder: "Milestone name"}).value(m.name).autoSubmit()
		).addClass("-big")
		.row(
			Form.label({label: "Milestone date *"}),
			Form.input({name: 'date', placeholder: "Date of milestone", role:"date"}).value(m.time)
		).addClass("-big")
		.row(
			Form.label({label: "Person in charge *"}),
			Form.input({name: 'username', placeholder: "Tag person in charge", role:"user"}).value("@"+m.username)
		)
		.row(
			Form.label({label: "Description *"}),
			Form.input({name: 'content', placeholder: "Milestone description", type:"textarea"}).value(m.content)
		)
		.rowHidden(
			Form.label({label: "Status"}),
			Form.input({name: 'status', type:"select", options: [{label: "Active", value:0}, {label: "Inactive", value:-1}]}).value(m.status)
		).addClass("-big")
		.buttons([
			 {label: "Create", action: function(){
				Form.submit("#fly-tasklist-fx", function(code){
					if (!code.good()){
						return AP.alertError(code.message);
					}
					
					UI.flash("Milestone updated successfully ...");
					Form.hide("fly-tasklist-fx");
					AP.refresh();
				})
			 }, style: 'ok -success -rounded bold'},
			 {label: "Hủy", action: function(){
				 Form.hide("fly-tasklist-fx");
			 }, style:'cancel -passive-2 -rounded'}
		])
		.hiddens(data)
		.render(function(fref){
			fref.find("content").autoExpand();
		});


		Form.pop({id:'fly-tasklist-dx', width: 600, label: "Edit milestone", layout: 'flat', closable: false}).setForm(form).show().focus('name');
	};
	
	
	this.remove=function(id){
		var m=Milestone.fromContext(id);
		if (!m){
			return;
		}
		
		AP.confirmDelete("Confirm to delete this milestone? Task is not deleted but linking with this milestone is lost.", function(){
			UI.ajaxShow();
			AP.post("api/milestone/remove", {id: m.id}, function(code){
				UI.ajaxHide();
				
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				UI.flash("Milestone remove successfully ...");
				Form.hide("fly-tasklist-fx");
				AP.refresh();
			});
		});
	};
	
	
	
};







Milestone.project=new function __MileStoneProject(){	
	this.options=function(){
		var ms=null;
		
		if (Client.tempData){
			ms=Client.tempData.milestones;
		}
		
		if (!ms){
			ms=Client.pageData.milestones;
		}
		
		ms.sort(function(e1, e2){
			return parseInt(e2.time)-parseInt(e1.time);
		});
		
		var ts= AP.array.select(ms, function(e){
			if (!e.id){
				return {name: "No milestone", id: 0, color: 0, key: 0};
			}
			
			var c=1;
			if (parseInt(e.time)<AP.time.now()){
				c=0;
			}
			
			return {name: e.name+' ('+AP.i18n.date(e.time)+')', id: e.id, color: c, key: e.id};
		});
		
		
		if (!AP.array.findObj(ts, 0)){
			ts.push({name: 'No milestone', id: 0, color: 0, key: 0});
		}
		
		if (Project.isManager()){
			ts.push({name: 'Create milestone', id: -1, color: 0, key: -1});	
		}
		
		return ts;
	};
	
	
	/**
	 * @desc Get the HTML rendering the milestone of a single task
	 */
	this.getCellHTML=function(task){
		var ms=AP.array.findObj(Client.pageData.milestones, task.milestone_id);
		if (!ms){
			return "<div class='cell relative -dd url' data-url='action/"+(task.id)+"/table' data-field='milestone' data-acl='"+(task.acl.desc)+"' data-type='select' data-value='0'> <div class='ap-xdot'>--</div> </div>";
		}
		
		var now=AP.time.now();
		var time=parseInt(ms.time);
		
		var icon="<span class='ficon-arrow-circle-down text-a'></span>&nbsp;";
		var name="<span class='text-a'>"+(ms.name)+"</span>";
		
		if (time > now){
			icon="<span class='ficon-arrow-circle-up text-success'></span>&nbsp;";
			name="<span class='text-success thick'>"+(ms.name)+"</span>";
		}
		
		return "<div class='relative ap-xdot' title='"+(ms.name)+" | "+(AP.i18n.datetime(time))+"'>"+(icon)+" "+(name)+"</div>";
	};
	
};




MilestoneDisplay=new function __MSDisplay(){
	this.display=function(ms_id){
		AP.destroyDialog("#js-milestone-display");
		$("#s-milestone-display").remove();
		UI.ajaxShow();
		
		AP.customDialog("<div id='js-milestone-display'></div>", {id: "js-milestone-wrapper"})
		.width(800)
		.css({right: $.sbWidth()})
		.addClass("-full")
		.closable(false)
		.show();
		
		AP.loadInlineURL("dept/milestone", {id: ms_id}, "#js-milestone-display",{
			start: function(){
			}, end: function(){
				if (mobile()){
					$(document.body).addClass("xo");
					$("#document").hide();
				}
				
				AP.dialog("#js-milestone-display").balance();
			}, error: function(){
				MilestoneDisplay.close();
			}
		});

		Side.milestone.init();
		
		return;
	};
	
	
	/**
	 * @desc Safe close the milestone
	 */
	this.close=function(){
		if (!$("#js-milestone-display").length){
			return;
		}
		
		AP.destroyDialog("#s-milestone-display");
		AP.closeDialog("#js-milestone-display");
	};
	
	
	
	/**
	 * @desc Render a milestone
	 */
	this.render=function(ms){
		ms.stats=getStats(Client.tempData.tasks, ms);
		
		var content=ms.content;
		if (!content){
			content="<div class='-empty'>No description</div>";
		}
		
		var user=People.get(ms.user_id);
		var creator=People.get(ms.creator_id);
		
		if (parseInt(ms.time)>AP.time.now()){
			left=AP.time.remain(ms.time)+" remained";
		}else{
			left=AP.time.ago(ms.time);
		}

		var links = '';
		if (Client.tempData.dept) {
			links = "<span class='url' data-url='"+(Client.tempData.dept.path)+"'>"+(Client.tempData.dept.name)+"</span> &rsaquo; <span class='url' data-url='"+(Client.tempData.project.path)+"'>"+(Client.tempData.project.name)+"</span>";
		} else {
			links = "<span class='url' data-url=''>No department</span> &rsaquo; <span class='url' data-url='"+(Client.tempData.project.path)+"'>"+(Client.tempData.project.name)+"</span>";
		}
		
		var html="<div class='nav'> <div class='links'> "+(links)+" </div> <div class='side'> <div class='action' onclick='Milestone.edit("+(ms.id)+")'>Chỉnh sửa</div> <div class='close' onclick='MilestoneDisplay.close();'><span class='-ap icon-close'></span></div> </div> </div> <div class='cover'> <div class='date'> <em>"+(AP.time.time('%V', ms.time))+"</em> <span>"+(AP.time.time('%d/%m/%y', ms.time))+"</span> </div> <div class='visual'> <div id='js-ms-pie' class='chart'></div> <div class='counter'>"+(ms.stats.total)+"<span>công việc</span></div> </div> <div class='main'> <div class='title'>"+(ms.name)+"</div> <div class='info'>Tạo bởi <em class='url' data-username='"+(creator.username)+"'>"+(creator.name)+"</em> lúc "+(AP.i18n.datetime(ms.since))+" </div> <div class='info'>Thời gian: <em>"+(AP.time.time('%V, %d/%m/%Y',e.time))+"</em> &middot; "+(left)+"</div> <div class='info'>Linked project/team: <em class='url' data-url='"+(Client.tempData.project.path)+"'>"+(Client.tempData.project.name)+"</em></div> <div class='info'> <em>"+(ms.stats.total)+"</em> công việc &middot; <em>"+(ms.stats.done_ontime)+"</em> ht đúng hạn &middot; <em>"+(ms.stats.done_late)+"</em> ht muộn &middot; <em>"+(ms.stats.overdue)+"</em> quá hạn &middot; <em>"+(ms.stats.in_progress)+"</em> in progress <div class='side'><em>"+(ms.stats.percent.toFixed(2))+"</em>%</div> </div> </div> <div class='bar'> <div class='c' style='width:"+(ms.stats.percent)+"%'></div> </div> <div class='desc -nb'> <div class='title' style='padding:5px 0'>Thống kê dựa trên deadline mục tiêu</div> <div class='info'> <em>"+(ms.stats.real_done_ontime)+"</em> ht đúng hạn &middot; <em>"+(ms.stats.real_done_late)+"</em> ht muộn &middot; <em>"+(ms.stats.real_overdue)+"</em> quá hạn &middot; <em>"+(ms.stats.real_in_progress)+"</em> in progress <em>"+(ms.stats.real_percent.toFixed(1))+"</em>% </div> </div> <div class='desc -nb'> <div class='title' style='padding:5px 0'>Người phụ trách</div> <div class='content user url' data-username='"+(user.username)+"'> <div class='image'><img src='"+(AP.xthumb(user.gavatar))+"'/></div> <div class='name ap-xdot'>"+(user.name)+"</div> </div> </div> <div class='desc'> <div class='title'>Miêu tả mục tiêu</div> <div class='content'> "+(content)+" </div> </div> </div> <div class='section clear-fix'> <div class='header'> <div class='subtitle'>Danh sách công việc</div> <div class='tabs clear-fix'> <div class='tab active' data-tab='all'><span class='cb -all'></span><em>Tất cả</em> ("+(ms.stats.total)+")</div> <div class='tab' data-tab='in_progress'><span class='cb -in_progress'></span><em>Đang xử lý</em> ("+(ms.stats.in_progress)+")</div> <div class='tab' data-tab='overdue'><span class='cb -overdue'></span><em>Quá hạn</em> ("+(ms.stats.overdue)+")</div> <div class='tab' data-tab='late'><span class='cb -late'></span><em>HT muộn</em> ("+(ms.stats.done_late)+")</div> <div class='tab' data-tab='ontime'><span class='cb -ontime'></span><em>HT đúng hạn</em> ("+(ms.stats.done_ontime)+")</div> </div> </div> <div class='ms-filter'> <div class='input'> <input type='text' id='ms-quick-filter' placeholder='Lọc nhanh'/> </div> </div> <div class='body'> <div class='js-tasks ms-tasks'></div> </div> </div>";
		
		
		$("#milestone-display").html(html);
		showCharts(ms);
		renderTasks();
		
		$("#milestone-display .tabs .tab").click(function(){
			var v=$(this).data("tab");
			if (v=="all"){
				$(this).siblings().removeClass("active");
				$(this).addClass("active");
			}else{
				$(this).parent().children().first().removeClass("active");
				$(this).toggleClass("active");
			}
			
			filterTasks();
		});
		
		$("#ms-quick-filter").quickFilter("#milestone-display .js-tasks .task", function($e, q){
			var txt=$e.text();
			return AP.word.fulltextMatch(txt, q);
		});
		
		AP.dialog("#js-milestone-wrapper").balance();
	};
	
	
	
	
	function showCharts(ms){
		var stats={active: ms.stats.in_progress, done_ontime: ms.stats.done_ontime, done_late: ms.stats.done_late, overdue: ms.stats.overdue};
		
		$('#js-ms-pie').highcharts({
			credits:{
				enabled: false
			},
			chart: {
				plotBackgroundColor: null,
				plotBorderWidth: null,
				plotShadow: false,
				type: 'pie',
				backgroundColor:'rgba(255, 255, 255, 0.0)',
			},
			title: {
				text: '',
				style: {fontSize: '13px', fontWeight: 'normal'},
				align: 'center',
				verticalAlign: 'middle',
			},
			tooltip: {
				pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
			},
			plotOptions: {
				pie: {
					allowPointSelect: true,
					cursor: 'pointer',
					dataLabels: {
						enabled: false
					},
					showInLegend: true,
					innerSize: '80%'
				}
			},
			legend:{
				itemStyle:{fontWeight: 'normal', fontSize: '9px'},
				enabled: false,
			},
			series: [{
				name: 'Tasks',
				colorByPoint: true,
				data: [{
					name: "Active (not done, not overdue - "+(stats.active)+")",
					y: stats.active,
				}, {
					name: "ht đúng hạn ("+(stats.done_ontime)+")",
					y: stats.done_ontime,
					color: "#24ce0e"
				}, {
					name: "ht muộn ("+(stats.done_late)+")",
					y: stats.done_late,
					color: "#cebd0c"
				}, {
					name: "Quá hạn ("+(stats.done_late)+")",
					y: stats.overdue,
					color:"#ce2a0d"
				}]
			}]
		});
	};
	
	
	
	/**
	 * @desc Rendering a list of tasks of a milestone
	 */
	function renderTasks(ms){
		var html=AP.render(Client.tempData.tasks, function(e){
			return getHTML(e);
		});
		
		$("#milestone-display .js-tasks").html(html);
	};
	
	
	function getHTML(e){
		var state=Task.ui.grandState(e);
		if (state=="done"){
			if (Compute.doneLate(e)){
				state="late";	
			}else{
				state="ontime";
			}
		}else{
			if (Compute.overdue(e)){
				state="overdue";
			}else{
				state="in_progress"
			}
		}
		
		
		
		var labels=Task.ui.labels(e);
		
		var u=People.get(e.user_id);
		var img='';
		if (u && parseInt(u.uid)){
			img="<img src='"+(AP.xthumb(u.gavatar))+"'/>";
		}
		
		var contents=[];
		if (e.content && e.content.length){
			contents.push(safe(e.content));
		}
		
		contents.push(AP.render(labels, function(e){
			if (e.role=="milestone"){
				return "";
			}
			return "<span class='tag "+(e.style)+"'>"+(e.name)+"</span>";
		}));
		
		var content=contents.join(' &middot; ');
		if (!content || !content.length){
			content='No description';
		}
		
		var deadline=AP.time.time('<em>%V</em><span>%d/%m/%Y</span>', e.deadline);
		if (!parseInt(e.deadline)){
			deadline="<div class='none'>No deadline</div>";
		}
		
		return "<div class='task' data-state='"+(state)+"'> <div class='deadline'>"+(deadline)+"</div> <div class='status-wrapper'> <div class='status-icon -"+(state)+"'><span class='r'></span></div> </div> <div class='name url' data-url='task/"+(e.id)+"'>"+(e.name)+"</div> <div class='content ap-xdot'>"+(content)+"</div> <div class='assignee'><div class='image'>"+(img)+"</div></div> </div>";
	};
	
	
	
	function getStats(tasks, ms){
		var stats={
			total: 0, in_progress:0, overdue: 0, done_late:0, done_ontime:0,
			real_in_progress:0, real_overdue: 0, real_done_late:0, real_done_ontime:0, real_percent: 0
		};
		
		for (var i=0; i<tasks.length; i++){
			stats.total++;
			if (Compute.doneLate(tasks[i])){
				stats.done_late++;
			}else if (Compute.doneOntime(tasks[i])){
				stats.done_ontime++;
			}else if (Compute.overdue(tasks[i])){
				stats.overdue++;
			}else{
				stats.in_progress++;
			}
			
			if (parseInt(tasks[i].status)){
				if (Compute.doneLateAgainst(tasks[i], ms.time)){
					stats.real_done_late++;
				}else{
					stats.real_done_ontime++;
				}
			}else{
				if (Compute.overdueAgainst(tasks[i], ms.time)){
					stats.real_overdue++;
				}else{
					stats.real_in_progress++;
				}
			}
			
		}
		
		
		
		stats.percent=0;
		if (stats.total){
			stats.percent=100*(stats.done_late+stats.done_ontime)/(stats.total);
			stats.real_percent=100*(stats.real_done_late+stats.real_done_ontime)/(stats.total);
		}
		
		return stats;
	};
	
	
	function filterTasks(){
		var actives=[];
		$("#milestone-display .tabs .tab.active").each(function(){
			actives.push($(this).data("tab"));
		});
		
		$("#milestone-display .js-tasks .task").each(function(){
			var state=$(this).data("state");
			if (actives.indexOf("all")!=-1 || actives.indexOf(state)!=-1){
				$(this).removeClass("search_hidden");
			}else{
				$(this).addClass("search_hidden");
			}
		});
	};
	
};
Project.people=new function __ProjectPeople(){
	this.add=function(){
		return Project.people.side.addMulti('member', Client.pageData.context);
	};
	
	this.context=function(ref, username){
		var edit_by_admin=[];
		
		var user=People.get(username);
		if (!user){
			return;
		}

        var metatype = (Client.pageData.context.metatype == 'project') ? 'dự án' : 'team';
        
		if (Project.isManager()){
			if (Project.isManager(user)){
				edit_by_admin=[{'type' :'sep'},
	   		    	{label: 'Bỏ quyền quản lý <b> '+metatype+'</b>', icon:"icon-uniF108", action: function(){
	   		    		Project.role.set(user,  "member");
	   		    	}},
	   		    	{type :'sep'},
	   		   		{label: 'Xóa <b>'+user.name+'</b> khỏi ' + metatype, icon:"icon-uniF11F", action: function(){
	   		   			Project.role.remove(user);
	   		   		}}
	   			];
			}else{
				edit_by_admin=[{'type' :'sep'},
				    {label: 'Set quyền quản lý <b> '+metatype+'</b>', icon:"icon-star-empty", action: function(){
				    	Project.role.set(user, "owner");
				    }},
	   		    	{type :'sep'},
	   		   		{label: 'Xóa <b>'+user.name+'</b> khỏi ' + metatype, icon:"icon-uniF11F", action: function(){
	   		   			Project.role.remove(user);
	   		   		}}
	   			];
			}
			
		}
		
		return Context.menu(ref, {top: 30, left:-240, menu: [
 		    {label: 'Chat với <b>'+user.name+'</b>', 'icon': 'icon-uniF1D8', action: function(){
 		    	Base.message.peer(username, {'from': 'context'});
		    	Context.hide();
		    }},
		    {label: 'Xem profile của <b>'+user.name+'</b>', 'icon': 'icon-uniF1AB icm', action: Base.domain("account")+"/user/"+user.username},
		].concat(edit_by_admin)});
	
	};
	
};


Project.people.side=new function __ProjectPeopleSide(){
	this.display=function(canvas){
		var managed=parseInt(Client.pageData.context.acl.managed);
		var metatype = (Client.pageData.context.metatype == 'project') ? 'Quản lý dự án' : 'Quản lý team';
		$(canvas).html("" +
			"<div class='subbox' id='js-sidebox-owners'>" +
			"	<div class='title'><em>"+metatype+"</em><div class='actions'>" +
			(managed?"<div class='dd'><div class='cta' onclick=\"Project.people.side.addMulti('owner', Client.pageData.context);\">Thêm nhiều</div></div>":"") +
			"	</div>" +
			"</div>" +
			"	<div class='js-body'></div>" +
			"</div>" +
			"<div class='subbox' id='js-sidebox-members'>" +
			"	<div class='title'><em>Thành viên</em><div class='actions'>" +
			(managed?"<div class='dd'><div class='cta' onclick=\"Project.people.side.addMulti('member', Client.pageData.context);\">Thêm nhiều</div></div>":"") +
			"   </div>" +
			"</div>" +
			"	<div class='js-body'></div>" +
			"</div>" +
			"<div class='subbox' id='js-sidebox-clients'>" +
			"	<div class='title'><em>Làm việc với khách hàng</em><div class='actions'>" +
			(managed?"<div class='dd'><div class='cta' onclick=\"Project.people.side.addMulti('guest', Client.pageData.context);\">Thêm nhiều</div></div>":"") +
			"   </div>" +
			"</div>" +
			"	<div class='js-body'></div>" +
			"</div>");
		
		var count=0;
		
		$("#js-sidebox-owners .js-body").html(AP.render(Client.pageData.context.owners, function(e){
			var u=People.get(e.username);
			if (u.id == 0) {
				return "";
			}

			if (u){
				count++;
				return getHTML(u);
			}
		}));
		
		if (parseInt(managed)){
			placeHolder("#js-sidebox-owners .js-body",{
				label: "Thêm " + metatype,
				type: "owner"
			});
		}
		
		count=0;
		$("#js-sidebox-members .js-body").html(AP.render(Client.pageData.context.followers, function(e){
			if (AP.array.indexOf(Client.pageData.context.owners, e, function(a, b){return a.username==b.username;})!=-1){
				return "";
			}

			var u=People.get(e.username);
			if (u.metatype=="guest"){
				return "";
			}

			if(u.id == 0) {
				return "";
			}
			
			if (u){
				count++;
				return getHTML(u);
			}
		}));
		
		if (!count){
			$("#js-sidebox-members .js-body").html("<div class='none'>Không có thành viên nào</div>");
		}
		
		if (parseInt(managed)){
			placeHolder("#js-sidebox-members .body",{
				label: "Thêm " + "Thành viên",
				type: "member"
			});	
		}
		
		
		if (parseInt(Client.pageData.context.external)){
			count=0;			
			$("#js-sidebox-clients .js-body").html(AP.render(Client.pageData.context.followers, function(e){
				var u=People.get(e.username);
				if (u.metatype!="guest"){
					return "";
				}
				
				if (u){
					count++;
					return getHTML(u);
				}
			}));
			
			if (!count){
				$("#js-sidebox-clients .js-body").html("<div class='none'>Không có tài khoản khách hàng nào</div>");
			}
			
			if (parseInt(managed)){
				placeHolder("#js-sidebox-clients .js-body",{
					guest: true,
					label: "Thêm " + "tài khoản khách hàng",
					type: "guest"
				});
			}
		}
		else{
			$("#js-sidebox-clients").hide();
		}
		
		
		// Context menu
	};

	this.addMulti = function(role, item){
		var data = {id: item.id, role:role};
		var label = "Thêm nhiều "+role;
		Tag.context(false);
		var form = Form.create('fly-task-reassign-fx',{'action': "api/settings/role/multi"})
			.row(
				Form.label({label: label}),
				Form.input({name: 'name', type: "textarea", placeholder: "Sử dụng @ để tag thêm thành viên", role:"tag"}).css({height: 100})
			).addClass("-big")
			.buttons([
				{label: "Thêm", action: function(){
					Form.submit("#fly-task-reassign-fx", function(code){
						Tag.context(true);
						if (!code.good()){
							return AP.alertError(code.message);
						}
						
						Form.hide("fly-task-reassign-fx");
						UI.flash("Đã thêm thành công...");
						AP.refresh();
					})
				}, style: 'ok -success -rounded bold'},
				{label: "Huỷ", action: function(){
					Form.hide("fly-task-reassign-fx");
				}, style:'cancel -passive-2 -rounded'}
			]).hiddens(data);

		Form.pop({id:'fly-edititem-dx', width: 450, label: label, layout: 'flat'}).setForm(form).show().focus('name');

	};
	
	
	function getHTML(user){
		return "<div class='user'>" +
			"<div class='avatar avatar-32 -circled' data-username='"+user.username+"'>" +
				"<div class='image'><img src='"+AP.xthumb(user.gavatar)+"'></div>" +
			"</div>" +
			"<div class='name'>" +
			"	<div class='main'><em class='url username' data-username='"+user.username+"'>"+user.name+"</em></div>" +
			"	<div class='info ap-xdot'>"+user.title+"</div>" +
			"	<div class='info ap-xdot'>"+user.email+" &middot; "+user.phone+"</div>" +
			"</div>" +
			"<div class='actions owner' onclick=\"Project.people.context(this, '"+user.username+"');\">" +
			"	<div class='action'><span class='ap icon-dots-three-horizontal'></span></div>" +
			"</div>" +
		"</div>";
	};
	
	
	function placeHolder(box, options){
		options=$.extend({}, {label: "Thêm thành viên", type: "owner", guest: false}, options);
		
		$(box).data("type", options.type)
		$(box).append("<div class='user -add'>" +
				"<div class='avatar'><div class='add'></div></div>" +
				"<div class='txt'>"+options.label+"</div>" +
			"</div>");

		var position = {
			left: 30,
			top: 50
		};

		// var height = screen.height;
		// var top = $(box).offset().top;
		// var distance = height - top;
		// if (distance > 100 && distance < 500) {
		//	 var position={
		//		 left: 215,
		//		 top: -130
		//	 };
		// }

		// if (options.type == 'guest') {
		//	 var position = {
		//		 left: 215,
		//		 top: -60
		//	 };
		// }

		
		Form.inlineTagger($(box).find(".user.-add"), {
			title: options.label,
			select: function(user){
				var type=$(box).data("type");
				Project.role.set(user, type);
			},
			filter: function(user){
				if (options.guest){
					if (user.metatype!="guest"){
						return false;
					}
					
					return true;
				}else{
					if (user.metatype=="guest"){
						return false;
					}
					
					return true;	
				}
				
				
			},
			position:position,
			width: 250
		});
	};
};


Project.role=new function __ProjectRole(){
	this.set=function(user, type){
		UI.ajaxShow();
		var data={id: user.id, role: type};
		
		UI.ajaxShow();
		AP.xpost("api/settings/role/user", data, function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			
			UI.flash("Update successfully ...");
			AP.refresh();
		});
	};
	
	
	this.remove=function(user){
		UI.ajaxShow();
		var data={id: user.id};
		
		UI.ajaxShow();
		AP.xpost("api/settings/role/remove", data, function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			
			UI.flash("Update successfully ...");
			AP.refresh();
		});
	};
};
var Task = new function __ProjectTask(){
	/**
	 * @desc Smartly detect task by its id 
	*/	
	this.fromContext=function(id){
		if  (Client.tempData && Client.tempData.task && parseInt(id)==parseInt(Client.tempData.task.id)){
			return Client.tempData.task;
		}
		
		return AP.array.findObj(Client.pageData.tasks, id);
	};
		
	
	/**
	 * @desc Update the task 
	 */
	this.update=function(task, comment){
		return Project.on.taskUpdated(task, comment);
	};
	
	
	
	/**
	 * @desc Get item by a given id, handler with callback
	 */
	this.get = function(id, callback){
		UI.ajaxShow();
		AP.post("api/task/get", {'id': id}, function(code) {
			UI.ajaxHide();
			
			if(!code.good()) {
				return AP.alertError(code.message);
			}

			callback(code.task, code.project, code.tasklists);
		});
	};

   
	this.itemOptions = function(item_id) {
		Task.get(item_id, function(item, project, tasklists){
			var options = [];
			
			if ((item.state == "active") || (item.state == "overdue") || 1==1) {
				if (parseInt(item.acl.managed)){
					options.push({label:"Chỉnh sửa thông tin công việc", sublabel:"Chỉnh sửa các thông tin chính", "icon":"pen", "action": function(){
						return Task.dialog.edit(project, item, tasklists);
					}});
					
					options.push({label: "Giao lại cho người khác", sublabel:"Giao công việc này cho người khác", icon:"user5", action: function(){
						return Task.action.reassign(item);
					}});

					options.push({label: "Thêm nhiều người theo dõi", sublabel:"Thêm nhiều người theo dõi", icon:"address-book", action: function(){
						return Task.action.addMulti(item);
					}});

					options.push({label: "Nhân bản công việc", sublabel:"Nhân bản công việc này", icon:"squared-plus", action: function(){
						return Task.dialog.duplicate(project, item, tasklists);
					}});

					options.push({label: "Nhân bản công việc vào dự án khác", sublabel:"Nhân bản công việc vào dự án-phòng ban khác", icon:"squared-plus", action: function(){
						return Task.dialog.duplicateExternal(item);
					}});

					options.push({label: "Xóa công việc", sublabel:"Xóa công việc này", icon:"delete", action: function(){
						return Task.close(project, item);
					}});
				}
			} else {
				return AP.alertError("Công việc không ở trạng thái thực thi (đã hoàn thành hoặc đã huỷ).");
			}
			/*
			options.push({label:"<span class='red'>Xóa công việc</span>", "icon":"trash3", "action": function(){
				return AP.alertError("Tính năng đang được hoàn thiện");
			}});
			*/
			
			AP.actionMenu(options);
		});
	};
	
	
	
	/**
	 * @desc Display a single item 
	 */
	this.display = function(id){
		return TaskDisplay.display(id);
	};

	
	/**
	 * @desc Tick on a list
	 */
	this.setStatus = function(id, status, ref){
		var action="check";
		if (!status){
			action="uncheck";
		}
		
		UI.ajaxShow();
		AP.post("api/task/check",{action: action, id: id}, function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message)
			};
			
			UI.flash("Đã lưu thay đổi...");
			Project.on.taskUpdated(code.task, code.comment);
		});
	};
	
	
	
	this.setDeliverable = function(id, callback){
		var data = {id: id};
		
		var form = Form.create('deliverable-fx',{action: 'api/project/item/submit'})
		.note("Công việc này yêu cầu bạn phải cập nhật kết quả trước khi đánh dấu hoàn thành")
		.rowHidden(
			Form.label({label: "Tên công việc *", "subtitle":"Tên công việc"}),
			Form.input({name: 'name', "placeholder":"Tên công việc"})
		)
		.row(
			Form.label({label: "Mô tả kết quả đã thực hiện",}),
			Form.input({name: 'content', "placeholder":"Mô tả kết quả công việc", type:"textarea"}).css({height: 100})
		)
		.row(
			Form.label({label: "Gửi tài liệu", "sublabel":"Gửi tối đa 05 tệp kết quả"}),
			Form.input({'type':'file', "placeholder":"Lựa chọn tệp để tải lên", name:"file-1"})
		)
		.rowHidden(
			Form.noLabel(),
			Form.input({'type':'file', "placeholder":"Lựa chọn tệp để tải lên", name:"file-2"})
		)
		.rowHidden(
			Form.noLabel(),
			Form.input({'type':'file', "placeholder":"Lựa chọn tệp để tải lên", name:"file-3"})
		)
		.rowHidden(
			Form.noLabel(),
			Form.input({'type':'file', "placeholder":"Lựa chọn tệp để tải lên", name:"file-4"})
		)
		.rowHidden(
			Form.noLabel(),
			Form.input({'type':'file', "placeholder":"Lựa chọn tệp để tải lên", name:"file-5"})
		)
		.render(function(form){
			$("input[type=file]").change(function(){
				var $row=$(this).closest(".row");
				var $next=$row.next(".row");
				if ($next){
					$next.show();
				}
			});
		})
		.hiddens(data)
		.buttons([
			 {label: "Gửi kết quả công việc", action: function(){
				 Form.submit("deliverable-fx", function(code){
					 if (!code.good()){
						 return AP.alertError(code.message);
					 }
				
					 Form.hide("deliverable-fx");
					 UI.flash("Chúc mừng bạn! Công việc đã hoàn thành");
					 
					 // AP.sys.fire("tasklist.incr_done", code.item.tasklist_id);
					 
					 if (callback){
						 callback(code.item);
					 }
				 });
			 }, style: 'ok -success -rounded bold'},
			 {label: "Hủy", action: function(){
				 Form.hide("deliverable-fx");
			 }, style:'-cancel -passive-2 rounded'}
		]);
		
		
		Form.pop({id:'deliverable-fx-dx', width: 600, label: 'Cập nhật kết quả hoàn thành cho công việc này'}).setForm(form).show();
		
	};
	
	
	

	this.close = function(project, item){
		AP.confirm("Bạn có chắc mình muốn xóa công việc này? Bạn không thể khôi phục lại công việc đã bị xóa", function(code){
			UI.ajaxShow();
			AP.post("api/task/remove",{id: item.id}, function(code){
				UI.ajaxHide();
				AP.hideAlert();
				
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				UI.flash("Công việc đã được hủy :(");
				Side.milestone.removeTask(code);

				if (Client.pageData.context){
					AP.redirect(Client.pageData.context.path);
				} else {
					AP.setURLParams({task: null}, true);
				}
			});
		});
	};
	
	
	
	this.reject = function(item){
		var data = {id: item.id};
		
		var form = Form.create('fly-item-fx',{'action': "api/project/item/reject"})
		.row(
			Form.label({label: "Tên công việc"}),
			Form.input({name: 'name', type: "fake"}).value(item.name)
		)
		.row(
			Form.label({label: "Gửi tin nhắn tới @"+item.username+" *",sublabel: "Gửi tin nhắn giải thích lí do từ chối thực hiện công việc này"}),
			Form.input({name: 'message', type: "textarea"}).css({height: 100})
		)
		.buttons([
			 {label: "Từ chối thực hiện", action: function(){
				 Form.submit("#fly-item-fx", function(code){
					 if (!code.good()){
						 return AP.alertError(code.message);
					 }
					 
					 Form.hide("fly-item-fx");
					 
					 UI.flash("Công việc được từ chối...");
				 })
			 }, style: 'ok -success -rounded bold'},
			 {label: "Hủy", action: function(){
				 Form.hide("fly-item-fx");
			 }, style:'cancel -passive-2 -rounded'}
		]).hiddens(data);
		
		Form.pop({width: 600, label: 'Từ chối thực hiện công việc này'
		}).setForm(form).show().focus('message');
	};
	
	
	
	
	/**
	 * @todo Remake this -- ERROR
	 */
	this.forward = function(item){
		var data = {id: item.id};
		
		var form = Form.create('fly-item-fx', {'action': "api/project/item/forward"})
		.row(
			Form.label({label: "Chuyển tiếp tới *",sublabel: "Lựa chọn thành viên mà bạn muốn chuyển giao quyền thực hiện công việc này"}),
			Form.input({name: 'assign_to', "placeholder":"Sử dụng @ để tag thành viên nhận chuyển giao", role:"tag"})
		)
		.buttons([
			 {label: "Chuyển giao công việc", action: function(){
				 Form.submit("#fly-item-fx", function(code){
					 if (!code.good()){
						 return AP.alertError(code.message);
					 }
					 
					 Form.hide("fly-item-fx");
					 
					 UI.flash("Công việc được chuyển giao thành công...");
				 })
			 }, style: 'ok -success -rounded bold'},
			 {label: "Hủy", action: function(){
				 Form.hide("fly-item-fx");
			 }, style:'cancel -passive-2 -rounded'}
		]).hiddens(data);
		
		Form.pop({width: 420, label: 'Chuyển giao công việc'
		}).setForm(form).show().focus('assign_to');
	};
};










Task.dialog=new function __TaskDialog(){
	this.add=function(project, tasklist_id, deadline, user){
		if (!tasklist_id){
			tasklist_id=0;
		}

		if (project.status != 0) {
			return AP.alertError("Dự án đang tạm đóng hoặc đã hoàn thành.");
		}

		var data={id: project.id, hid: project.hid, token: project.token};
		
		var form=Form.create('fly-workflow-fx',{'action': "api/task/add"})
		.row(
			Form.label({label: "Tên công việc *"}),//viết @ để tag tên người thực hiện
			Form.input({name: 'name', placeholder: "Thêm công việc", "role": "tag"}).autoSubmit()
		).addClass("-big")
		.row(
			Form.label({label: "Thuộc nhóm công việc *"}),
			Form.input({name: 'tasklist_id', type:'select', options: TaskList.getOptions(project.cached_tasklists)}).value(tasklist_id)
		);

		 if (deadline) {
			form.row(
				 Form.label({label: "Có deadline hay không?"}),
				 Form.input({name: 'has_deadline', type:"list", options:[{label: "Không đặt deadline", value:0}, {label: "Đặt deadline cho công việc", value:1}]}).value(1)
			);
			form.rowHidden(
				Form.label({label: "Đặt deadline cho công việc"}),
				Form.input({name: 'deadline', type: "text", role: "date", placeholder: "Click để chọn deadline"}).value(deadline)
			)
		 } else {
			 form.row(
				 Form.label({label: "Có deadline hay không?"}),
				 Form.input({name: 'has_deadline', type:"list", options:[{label: "Không đặt deadline", value:0}, {label: "Đặt deadline cho công việc", value:1}]}).value(0)
			 );
			 form.rowHidden(
				 Form.label({label: "Đặt deadline cho công việc"}),
				 Form.input({name: 'deadline', type: "text", role: "date", placeholder: "Click để chọn deadline"})
			 );
		 };

		form.wrap("Tùy chọn nâng cao","#item_add_advopts")
		.row(
			Form.label({label: "Mức độ ưu tiên?"}),
			Form.input({name: 'urgent', type:"list", options: Task.option.urgencies()}).value(0)
		)
		.row(
			Form.label({label: "Mức độ quan trọng?"}),
			Form.input({name: 'urgent', type:"list", options: Task.option.importances()}).value(0)
		)
		.row(
			Form.label({label: "Tags"}),
			Form.input({name: 'tags', type: "text", placeholder:"Type to select"})
		)
		.rowHidden(
			Form.label({label: "Yêu cầu kết quả công việc? *"}),
			Form.input({name: 'deliverable', placeholder:"", type:"list", options: [{label:"Không yêu cầu", value:0}, {label:"Có, cần gửi lại kết quả công việc", value:1}]}).value(0)
		);

		 if(user) {
			 form.row(
				 Form.label({label: "Giao cho"}),
				 Form.input({name: 'assign', "placeholder":"Sử dụng @ để tag chính xác một người được giao", "role":"user"}).value('@'+user.username)
			 )
		 } else {
			 form.row(
				 Form.label({label: "Giao cho"}),
				 Form.input({name: 'assign', "placeholder":"Sử dụng @ để tag chính xác một người được giao", "role":"user"})
			 )
		 }

		 form.row(
			Form.label({label: "Thành viên theo dõi"}),
			Form.input({name: 'followers', "placeholder":"Sử dụng @ để tag thêm thành viên theo dõi", "role":"tag"})
		 )
		 .row(
			Form.label({label: "Ngày bắt đầu công việc"}),
			Form.input({name: 'start_time', type:"text", role: "date", placeholder: "Ngày bắt đầu mặc định là hôm nay"})
		 )
		 .row(
			Form.label({label: "Mô tả thêm về công việc"}),
			Form.input({name: 'content', type:"textarea"}).css({height: 100})
		 );

		 if (project.form){
			 for (var i=0; i<project.form.length; i++){
				var row=project.form[i];

				if (row.type=="text"){
					form.row(
						Form.label({label: row.name}),
						Form.input({name: row.id, type:"text", placeholder: row.name})
					);
				}

				if (row.type=="int"){
					form.row(
						Form.label({label: row.name}),
						Form.input({name: row.id, type:"text", role: "int", placeholder: row.name})
					);
				}

				if (row.type=="date"){
					form.row(
						Form.label({label: row.name}),
						Form.input({name: row.id, type:"text", role: "date", placeholder: row.name})
					);
				}

				if (row.type=="datetime"){
					form.row(
						Form.label({label: row.name}),
						Form.input({name: row.id, type:"datetime", role: "date", placeholder: row.name})
					);
				}

				if (row.type=="textarea"){
					form.row(
						Form.label({label: row.name}),
						Form.input({name: row.id, type:"textarea", placeholder: row.name})
					);
				}

				if (row.type=="select"){
					form.row(
						Form.label({label: row.name}),
						Form.input({name: row.id, type:"list", options: getListOptions(row)})
					).addClass("-active");
				}

				if (row.type=="checkbox"){
					form.row(
						Form.label({label: row.name}),
						Form.input({name: row.id, type:"list", options: getCheckboxOptions(row)})
					).addClass("-active");
				}
			 }
		 }
		
		
		form.wrap()
		.rowHTML("<span class='link advlink'>+ Thêm lựa chọn nâng cao</span>")
		.buttons([
			 {label: "Thêm công việc", action: function(){
				 Form.submit("#fly-workflow-fx", function(code){
					 if (!code.good()){
						 return AP.alertError(code.message);
					 }
					 
					 UI.flash("Đã thêm thành công...");
					 Form.hide("fly-workflow-fx");
					 AP.xRefresh();
					 // Project.on.taskCreated(code.task);
				 })
			 }, style: 'ok -success -rounded bold'},
			 {label: "Huỷ bỏ", action: function(){
				 Form.hide("fly-workflow-fx");
			 }, style:'cancel -passive-2 -rounded'}
		])
		.hiddens(data)
		.render(function(fref){
			fref.selector(".advlink").click(function(){
				$("#item_add_advopts").toggle();
			});
			
			fref.find("has_deadline").change(function(){
				var val=parseInt($(this).val());
				if (val==1){
					fref.findRow("deadline").show();
				}else{
					fref.findRow("deadline").hide();
					fref.find("deadline").val("");
				}
			}).change();
			
			var tags=project.tags.slice(0);
			tags=AP.array.select(tags, function(e){
				e.label=e.name.toLowerCase();
				return e;
			});
			
			var $input=fref.find("tags");
			AP.UI.tagcloud($input, project.tags, {
				render: function(){
					
				},
			});
			
			setTimeout(function(){
				fref.find("name").focus();
			}, 300);
		});
	
		
		Form.pop({id:'fly-workflow-dx', width: 480, label: 'Create a new task in '+project.name, layout: 'flat', closable: false}).setForm(form).show().focus('name');
	
	};

	this.editTask = function(){
		var project = Client.tempData.context;
		var task = Client.tempData.task;
		return this.edit(project, task);
	};

	this.editItem = function(item_id) {
		Task.get(item_id, function(item, project){
			return Task.dialog.edit(project, item)
		});
	}

	this.edit = function(project, item) {
		var tasklists=project.cached_tasklists;
		
		var data = {hid: item.hid, token: item.token};
		var currDeadline = AP.time.now();
		if (item.has_deadline == 1) {
			currDeadline = item.deadline;
		}
		
		if(typeof item.start_time == 'undefined' || item.start_time == null) {
			item.start_time = item.since;
		}
		
		var form = Form.create('fly-edititem-fx',{'action': "api/task/edit"})
		.row(
			Form.label({label: "Tên công việc *"}),
			Form.input({name: 'name', placeholder: "Tên công việc"}).value(item.name)
		).addClass("-big")
		.row(
			Form.label({label: "Thành viên thực hiện"}),
			Form.input({name: 'assign', "placeholder":"Sử dụng @ để tag thêm thành viên theo dõi", "type":"fake"}).value('@'+item.username)
		)
		.row(
			Form.label({label: "Thuộc nhóm công việc *"}),
			Form.input({name: 'tasklist_id', type:'select', options: TaskList.getOptions(tasklists)}).value(item.tasklist_id)
		)
		.rowHTML("<span class='link advlink'>+ Thêm lựa chọn nâng cao</span>")
		.wrap("Tùy chọn nâng cao","#item_edit_advopts")
		.row(
			Form.label({label: "Mức độ ưu tiên?"}),
			Form.input({name: 'urgent', type:"list", options:[{label: "Bình thường", value:0}, {label: "Khẩn cấp", value:1}]}).value(item.urgent)
		)
		.row(
			Form.label({label: "Mô tả thêm về công việc"}),
			Form.input({name: 'content', type:"textarea", placeholder:"Mô tả công việc"}).css({height: 100}).value(Textarea.simple(item.content))
		);

		if (project.form){
			for (var i=0; i<item.form.length; i++){
				var row=item.form[i];

				if (row.type=="text"){
					form.row(
						Form.label({label: row.name}),
						Form.input({name: row.id, type:"text", placeholder: row.name}).value(row.value)
					);
				}

				if (row.type=="int"){
					form.row(
						Form.label({label: row.name}),
						Form.input({name: row.id, type:"text", role: "int", placeholder: row.name}).value(row.value)
					);
				}

				if (row.type=="float"){
					form.row(
						Form.label({label: row.name}),
						Form.input({name: row.id, type:"text", role: "float", placeholder: row.name}).value(row.value)
					);
				}

				if (row.type=="date"){
					form.row(
						Form.label({label: row.name}),
						Form.input({name: row.id, type:"text", role: "date", placeholder: row.name}).value(row.value)
					);
				}

				if (row.type=="datetime"){
					form.row(
						Form.label({label: row.name}),
						Form.input({name: row.id, type:"datetime", role: "date", placeholder: row.name}).value(row.value)
					);
				}

				if (row.type=="textarea"){
					form.row(
						Form.label({label: row.name}),
						Form.input({name: row.id, type:"textarea", placeholder: row.name}).value(row.value.br2nl())
					);
				}

				if (row.type=="select"){
					form.row(
						Form.label({label: row.name}),
						Form.input({name: row.id, type:"list", options: getListOptions(row)}).value(row.value)
					).addClass("-active");
				}

				if (row.type=="checkbox"){
					form.row(
						Form.label({label: row.name}),
						Form.input({name: row.id, type:"list", options: getCheckboxOptions(row)}).value(row.value)
					).addClass("-active");
				}
			}
		};
		form.wrap()
		.buttons([
			{label: "Chỉnh sửa công việc", action: function(){
				Form.submit("#fly-edititem-fx", function(code){
					if (!code.good()){
						return AP.alertError(code.message);
					}
					 
					UI.flash("Đã sửa thành công...");

					var tid = code.task.tasklist_id;

					Task.inline.updateTaskList(tid);

					Project.on.taskUpdated(code.task);
					Form.hide("fly-edititem-fx");
				})
			}, style: 'ok -success -rounded bold'},
			{label: "Huỷ bỏ", action: function(){
				Form.hide("fly-edititem-fx");
			}, style:'cancel -passive-2 -rounded'}
		])
		.hiddens(data)
		.render(function(fref){
			fref.selector(".advlink").click(function(){
				$(this).parent().hide();
				$("#item_edit_advopts").show();
			});
			
			if(item.has_deadline == 1) {
				fref.findRow("deadline").show();
			}
			
			fref.find("has_deadline").change(function(){
				var val=parseInt($(this).val());
				if (val==1){
					fref.findRow("deadline").show();
				}else{
					fref.findRow("deadline").hide();
				}
			}).change();
			
			setTimeout(function(){
				
				fref.find("name").focus();
			}, 300);
		});
		
		Form.pop({id:'fly-edititem-dx', width: 600, label: 'Sửa công việc: '+item.name, layout: 'flat'}).setForm(form).show().focus('name');
	};

	this.duplicate = function(project, item, tasklists) {
		var data = {id: project.id, hid: item.hid, token: item.token};
		var currDeadline = AP.time.now();
		if (item.has_deadline == 1) {
			currDeadline = item.deadline;
		}

		if (typeof item.start_time == 'undefined' || item.start_time == null) {
			item.start_time = item.since;
		}

		var form = Form.create('fly-edititem-fx',{'action': "api/task/duplicate"})
			.row(
				Form.label({label: "Tên công việc *"}),
				Form.input({name: 'name', placeholder: "Tên công việc"}).value('Bản sao của '+item.name)
			).addClass("-big")
			.row(
				Form.label({label: "Thành viên thực hiện"}),
				Form.input({name: 'assign', "placeholder":"Sử dụng @ để tag thêm thành viên theo dõi", "role":"tag"}).value('@'+item.username)
			)
			.row(
				Form.label({label: "Có deadline hay không?"}),
				Form.input({name: 'has_deadline', type:"list", options:[{label: "Không đặt deadline", value:0}, {label: "Đặt deadline cho công việc", value:1}]}).value(item.has_deadline)
			)
			.rowHidden(
				Form.label({label: "Đặt deadline cho công việc"}),
				Form.input({name: 'deadline', type: "text", role: "date", placeholder: "Click để chọn deadline"}).value(currDeadline)
			)



			if (item.metatype == 'subtask' && item.origin_export.type == "projecttasks") {
				form.row(
					Form.label({label: "Duplicate as subtask of"}),
					Form.input({name: 'subtask_origin', type:'select', options: [{label: item.origin_export.name, value: item.origin_export.id}, {label: "No, duplicate as ordinary task", value: 0}]})
				);
			} else {
				form.row(
					Form.label({label: "Thuộc nhóm công việc *"}),
					Form.input({name: 'tasklist_id', type:'select', options: TaskList.getOptions(tasklists)}).value(item.tasklist_id)
				)
				.row(
					Form.label({label: "Duplicate subtasks?"}),
					Form.input({name: 'keep_subtasks', type:'select', options: [{label: "YES", value:1}, {label: "NO", value: 0}]})
				);
			}

			form.rowHTML("<span class='link advlink'>+ Thêm lựa chọn nâng cao</span>")
			.wrap("Tùy chọn nâng cao","#item_edit_advopts")
			.row(
				Form.label({label: "Mức độ ưu tiên?"}),
				Form.input({name: 'urgent', type:"list", options:[{label: "Bình thường", value:0}, {label: "Khẩn cấp", value:1}]}).value(item.urgent)
			)
			.row(
				Form.label({label: "Yêu cầu kết quả công việc? *"}),
				Form.input({name: 'deliverable', placeholder:"", type:"list", options: [{label:"Không yêu cầu", value:0}, {label:"Có, cần gửi lại kết quả công việc", value:1}]}).value(item.req_deliverable)
			).addClass("-active")
			.row(
				Form.label({label: "Thành viên theo dõi"}),
				Form.input({name: 'followers', "placeholder":"Sử dụng @ để tag thêm thành viên theo dõi", "role":"tag"}).value(UI.objectsToUsernames(item.followers))
			)
			.row(
				Form.label({label: "Mô tả thêm về công việc"}),
				Form.input({name: 'content', type:"textarea"}).css({height: 100}).value(item.content.br2nl())
			)
			.row(
				Form.label({label: "Ngày bắt đầu công việc"}),
				Form.input({name: 'start_time',   role: "date", placeholder: "Ngày bắt đầu mặc định là hôm nay"}).value(item.start_time)
			);

		if (item.form){
			for (var i=0; i<item.form.length; i++){
				var row=item.form[i];

				if (row.type=="text"){
					form.row(
						Form.label({label: row.name}),
						Form.input({name: row.id, type:"text", placeholder: row.name}).value(row.value)
					);
				}

				if (row.type=="int"){
					form.row(
						Form.label({label: row.name}),
						Form.input({name: row.id, type:"text", role: "int", placeholder: row.name}).value(row.value)
					);
				}

				if (row.type=="date"){
					form.row(
						Form.label({label: row.name}),
						Form.input({name: row.id, type:"text", role: "date", placeholder: row.name}).value(row.value)
					);
				}

				if (row.type=="datetime"){
					form.row(
						Form.label({label: row.name}),
						Form.input({name: row.id, type:"datetime", role: "date", placeholder: row.name}).value(row.value)
					);
				}

				if (row.type=="textarea"){
					form.row(
						Form.label({label: row.name}),
						Form.input({name: row.id, type:"textarea", placeholder: row.name}).value(row.value.br2nl())
					);
				}

				if (row.type=="select"){
					form.row(
						Form.label({label: row.name}),
						Form.input({name: row.id, type:"list", options: getListOptions(row)}).value(row.value)
					).addClass("-active");
				}

				if (row.type=="checkbox"){
					form.row(
						Form.label({label: row.name}),
						Form.input({name: row.id, type:"list", options: getCheckboxOptions(row)}).value(row.value)
					).addClass("-active");
				}
			}
		};
		form.wrap()
			.buttons([
				{label: "Nhân bản công việc", action: function(){
					Form.submit("#fly-edititem-fx", function(code){
						if (!code.good()){
							return AP.alertError(code.message);
						}

						UI.flash("Nhân bản thành công...");
						AP.xRefresh();
						// Project.on.taskCreated(code.task, tasklists);
						Form.hide("fly-edititem-fx");
					})
				}, style: 'ok -success -rounded bold'},
				{label: "Huỷ bỏ", action: function(){
					Form.hide("fly-edititem-fx");
				}, style:'cancel -passive-2 -rounded'}
			])
			.hiddens(data)
			.render(function(fref){
				fref.selector(".advlink").click(function(){
					$(this).parent().hide();
					$("#item_edit_advopts").show();
				});

				if(item.has_deadline == 1) {
					fref.findRow("deadline").show();
				}

				fref.find("has_deadline").change(function(){
					var val=parseInt($(this).val());
					if (val==1){
						fref.findRow("deadline").show();
					}else{
						fref.findRow("deadline").hide();
					}
				}).change();

				setTimeout(function(){

					fref.find("name").focus();
				}, 300);
			});


		Form.pop({id:'fly-edititem-dx', width: 600, label: 'Nhân bản công việc: '+item.name, layout: 'flat'}).setForm(form).show().focus('name');
	};
	
	
	/**
	 * @desc Duplicate external
	 */
	this.duplicateExternal=function(task){
		var form = Form.create('deliverable-fx',{action: 'api/task/dup.ext'})
		.row(
			Form.label({label: "Chọn phòng ban hoặc dự án"}),
			Form.input({name: 'project_id', type: "select", options: projectOptions()})
		)
		.row(
			Form.label({label: "Thuộc nhóm công việc"}),
			Form.input({name: 'tasklist_id', "placeholder":"Thuộc nhóm công việc", type: "select", options: [], id:"js-tasklist-ip-id"})
		)
		.row(
			Form.label({label: "Deadline cho công việc"}),
			Form.input({name: 'deadline', type: "text", role: "date", placeholder: "Click để chọn deadline"}).value(task.deadline)
		)
		.row(
			Form.label({label: "Duplicate subtasks?"}),
			Form.input({name: 'keep_subtasks', type:'select', options: [{label: "YES", value:1}, {label: "NO", value: 0}]})
		)
		.render(function(form){
			initForm(form);
			Form.improveSelect(form.find("project_id"), {empty: 0});
		})	
		.hiddens({id: task.id})
		.buttons([
			 {label: "Nhân bản", action: function(){
				 Form.submit("#deliverable-fx", function(code){
					 UI.ajaxHide();
					 if (!code.good()){
						 return AP.alertError(code.message);
					 }
					
					 AP.alertSuccess("Đã nhân bản công việc thành công!");
					 Form.hide("deliverable-fx");
				 });
			 }, style: 'ok -success -rounded bold'},
			 {label: "Bỏ qua", action: function(){
				 Form.hide("deliverable-fx");
			 }, style:'-cancel -passive-2 rounded'}
		]);
		
		
		Form.pop({id:'deliverable-fx-dx', width: 480, layout: "flat", label: "Duplicate task to another project/team", closable: false}).setForm(form).show();

	};

	
	
	
	function getListOptions(row){
		var opts=[];
		for (var i=0; i<row.options.length; i++){
			opts.push({label: row.options[i], value: row.options[i]})
		}
		
		return opts;
	};
	
	function getCheckboxOptions(row){
		return [{label: "Yes", value:'yes'}, {label: "No", value: 'no'}];
	};
	
	
	function initForm(form){
		form.find("project_id").on("change", function(){
			var val=$(this).val();
			if (val && parseInt(val)){
				var project=AP.array.findObj(Client.projects, val);
				if (!project){
					$("#js-tasklist-ip-id").html("<option value='0'>-- Lựa chọn --</option>");
				}else{
					var opts=AP.render(project.cached_tasklists, function(e){
						return "<option value='"+e.id+"'>"+e.name+"</option>";
					});
					
					$("#js-tasklist-ip-id").html(opts);	
				}
			}else{
				$("#js-tasklist-ip-id").html("<option value='0'>-- Lựa chọn --</option>");
			}
		}).change();
	};

	
	function projectOptions(){
		var r= AP.select(Client.projects, function(e){
			if (!e.acl || !parseInt(e.acl.task_create) || !e.name || !e.name.length){
				return "";
			}
			
			return {label: "["+e.metatype+"] "+e.name, value: e.id};
		});
		
		r.unshift({label: "Chọn phòng ban hoặc dự án", value: 0});
		
		return r;
	};
	
};


Task.form=new function __TaskForm(){
	this.__pending=true;
	
	this.setPending=function(flag){
		this.__pending=flag;
		AP.transition="BLOCKED";
	};
	
	
	this.getForm=function(opts){
		var p=0;
		if (opts.context){
			p=opts.context.id;
		}
		
		
		var exp_add=explain('Click hoặc Enter để thêm',true);
		var exp_assignee=explain('Click để giao việc cho một người', true);
		var exp_deadline=explain('Click để chọn deadline', true);
		
		return "<div class='task-iform'> <form method='POST' action='api/task/add'> <div class='hidden'><input type='hidden' name='id' value='"+(p)+"'/></div> <div class='hidden'><input type='hidden' name='milestone_id'/></div> <div class='hidden'><input type='hidden' name='tasklist_id'/></div> <div class='hidden'><input type='hidden' name='status' value='0'/></div> <div class='hidden'><input type='hidden' name='assign'/></div> <div class='hidden'><input type='hidden' name='deadline'/></div> <div class='hidden'><input type='hidden' name='tags'/></div> <div class='task-cb'><div class='task-status'></div></div> <div class='input'><input name='name' type='text' placeholder='Tên công việc *' autocomplete='off'/></div> <div class='input -desc'><textarea name='content' type='text' placeholder='Miêu tả công việc' autocomplete='off'></textarea></div> <div class='submit -infow'> &check; THÊM "+(exp_add)+" </div> <div class='acts clear-fix'> <div class='action -dd -js-avatar -icon -infow'> <div class='icon avatar-add'><div class='ph'><span class='-ap icon-uniF13B'></span></div></div> <em class='v'>Giao cho</em> "+(exp_assignee)+" </div> <div class='action -dd -icon -js-deadline -infow'> <span class='icon ficon-calendar-empty'></span> <em class='v'>Deadline</em> "+(exp_deadline)+" </div> <div class='action -dd -js-tasklist -icon'> <em class='v'>Set tasklist</em> </div> <div class='action -dd -js-milestone -icon'><em class='v'>Set milestone</em></div> <div class='action -dd -js-tags -icon'><em class='v'>Set tags</em></div> </div> <div class='more-link'>Thêm lựa chọn</div> </form> </div>";
	};
	
	
	
	/**
	 * @desc Bind events for the form
	 */
	this.bindEvents=function(canvas){
		var id=$(canvas).data("id");
		var metatype=$(canvas).data("metatype");
		var obj=Board.data.fromContext(id, metatype);
	
		if (metatype=="user"){
			setUser($(canvas), obj, true);
		}
		
		if (metatype=="tasklist"){
			setTasklist($(canvas), obj, true);
		}
		
		if (metatype=="milestone"){
			setMilestone($(canvas), obj, true);
		}
		
		if (metatype=="task"){
			setTask($(canvas), obj, false);
		}
		
		
		var $canvas=$(canvas);
//		$canvas.find(".fcta .js-add-task").click(function(){
//			$(this).closest(".js-form-wrap").toggleClass("-sf");
//			if ($(this).closest(".js-form-wrap").hasClass("-sf")){
//				$(this).closest(".js-form-wrap").find("input[name=name]").focus();
//			}
//		});
		
		$canvas.find(".submit").click(function(){
			submitTask(this);
		});
		
		$canvas.find("input[name=name]").enter(function(){
			submitTask(this);
		});
		
		$canvas.find("input[name=content]").enter(function(){
			submitTask(this);
		});
		
		Tag.user($canvas.find("input[name=name]"), Project.getPeople());
		
		$canvas.find(".task-status").click(function(){
			var val=parseInt($canvas.find("input[name=status]").val());
			if (val==1){
				val=0;
			}else{
				val=1;
			}
			
			$canvas.find("input[name=status]").val(val);
			if (val){
				$canvas.find(".task-status").addClass("-done");		
			}else{
				$canvas.find(".task-status").removeClass("-done");
			}
			
			$canvas.find("input[name=name]").focus();
		});
		
		
		if ($canvas.find(".action.-js-avatar").hasClass("-readonly")){
		}else{
			Form.inlineTagger($canvas.find(".action.-js-avatar"), {
				title: "Người thực hiện",
				select: function(user){
					setUser($(this).closest(".task-iform"), user);
				},	
				filter: function(user){
					return Project.isMember(user);
				},
				position:{
					top:35
				},
				more: "People outside project/team",
				remove: function(){
					$(this).closest(".task-iform").find("input[name=assign]").val("");
					$(this).closest(".task-iform").find(".avatar-add").html("<div class='ph'><span class='-ap icon-uniF13B'></span></div>");
					$(this).closest(".task-iform").find(".action.-js-avatar em.v").html("Assign");
				}
			});
		}
		
		
		Form.inlineDatePicker($canvas.find(".action.-js-deadline"), function(date){
			$(this).closest(".task-iform").find("input[name=deadline]").val(AP.time.time("%d/%m/%Y", date));
			$(this).closest(".task-iform").find(".action.-js-deadline em.v").html(AP.time.time("%d/%m/%Y", date));
		}, {
			position:{
				top: 32,
				left: -40
			}
		});
		
		
		// TAGGING MILESTONES
		if ($canvas.find(".action.-js-milestone").hasClass("-readonly")){
		}else{
			Form.inlineLabelTagger($canvas.find(".action.-js-milestone"), function(item){
				var mid=$(item).data("id");
				if (mid==-1){
					return addMilestone();
				}
				
				setMilestone($(item).closest(".task-iform"), Milestone.fromContext(mid));
			}, {
				labels: Milestone.project.options(Client.pageData.project),
				position:{top:32, left:-20},
				click: false,
				selected: [],
				title: "Chọn mục tiêu",
				filter: false
			});	
		}
		
		
		// TAGGING TAKLISTS
		if ($canvas.find(".action.-js-tasklist").hasClass("-readonly")){
		}else{
			Form.inlineLabelTagger($canvas.find(".action.-js-tasklist"), function(item){
				setTasklist($(item).closest(".task-iform"), TaskList.fromContext($(item).data("id")));
			}, {
				labels: Client.pageData.tasklists,
				position:{top:32, left:-20},
				click: false,
				selected: [],
				title: "Set tasklist",
				filter: false
			});
		}
		
		
		
		// TAGGING TAGS
		Form.inlineLabelTagger($canvas.find(".action.-js-tags"), function(item){
			setTimeout(function(){
				setTags(item)
			});
		}, {
			labels: Task.option.tags(Client.pageData.project, true),
			position:{top:32, left:-20},
			click: false,
			selected: [],
			title: "Set tasklist",
			filter: false,
			multi: true
		});
		
	};
	
	
	
	/**
	 * @desc Finally submitting task
	 */
	function submitTask(ref){
		Form.submitFrom(ref, function(code){
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			if (code.updated_tags){
				if (Client.pageData.project){
					Client.pageData.project.tags=code.updated_tags;
					Client.pageData.context.tags=code.updated_tags;
					Project.taglist.reload(Client.pageData.project, Client.pageData.project.tags);
				}
			}
			
			var id=$(ref).closest(".js-form-wrap").attr("id");
			Side.milestone.update(code);
			Project.on.taskCreated(code.task);
			
			rebuildForm(id);
		});
	};
	
	
	/**
	 * @desc Set the default user
	 */
	function setUser($canvas, user, readonly){
		if (readonly){
			$canvas.find(".action.-js-avatar").addClass("-readonly");
		}
		
		if (!user){
			$canvas.find("input[name=assign]").val("");
			$canvas.find(".avatar-add").html("");
			$canvas.find(".action.-js-avatar em.v").html("Assign to");
		}
		
		$canvas.find("input[name=assign]").val(user.username);
		$canvas.find(".avatar-add").html("<div class='image'><img src='"+AP.xthumb(user.gavatar)+"'/></div>");
		$canvas.find(".action.-js-avatar em.v").html(user.name);
	};
	
	
	/**
	 * @desc Setting tasklist directly
	 */
	function setTasklist($canvas, tasklist, readonly){
		if (!tasklist){
			return;
		}
		
		if (readonly){
			$canvas.find(".action.-js-tasklist").addClass("-readonly");
		}
		
		$canvas.find(".action.-js-tasklist .api-tag").each(function(){
			if (tasklist.id==$(this).data("id")){
				$(this).addClass("selected");
			}else{
				$(this).removeClass("selected");
			}
		});
		
		$canvas.find("input[name=tasklist_id]").val(tasklist.id);
		$canvas.find(".action.-js-tasklist em.v").html("Tasklist: <em>"+tasklist.name+"</em>");
	};
	
	
	
	/**
	 * @desc Setting milestone directly
	 */
	function setMilestone($canvas, milestone, readonly){
		if (!milestone){
			return;
		}
		
		if (readonly){
			$canvas.find(".action.-js-milestone").addClass("-readonly");
		}
		
		$canvas.find(".action.-js-milestone .api-tag").each(function(){
			if (milestone.id==$(this).data("id")){
				$(this).addClass("selected");
			}else{
				$(this).removeClass("selected");
			}
		});
		
		$canvas.find("input[name=milestone_id]").val(milestone.id);
		if (milestone.id && parseInt(milestone.id) && parseInt(milestone.id)>0){
			$canvas.find(".action.-js-milestone em.v").html("Milestone: <em>["+AP.time.time("%d/%m", milestone.time)+"] "+milestone.name+"</em>");	
		}else{
			$canvas.find(".action.-js-milestone em.v").html("Set milestone");
		}
	};
	
	
	
	function setTags(selected){
		var id=$(selected).data("id");
		if (id==-2 || id=="-2"){
			$(selected).removeClass("selected");
			var id=$(selected).closest(".js-form-wrap").attr("id");
			Project.taglist.quickCreate(Client.pageData.project, function(tag){
				AP.xRefresh(function(){
					setTimeout(function(){
						rebuildForm(id);
					}, 300);
				});
			});
			return;
		}
		
		if (id==-1 || id=="-1"){
			$(selected).removeClass("selected");
			AP.confirm("You need to move to another page for this setting. Move anyway?", function(){
				return AP.toURL(Client.pageData.project.path+"/settings?s=tags");
			});
			
			return;
		}
		
		var $list=$(selected).closest(".api-tags");
		var tags=[];
		$list.find(".api-tag.selected").each(function(){
			tags.push($(this).data("id"));
		});
		
		if (tags.length){
			$list.closest(".action").find("em").html("Tags: <em>"+tags.join(", ")+"</em>");	
		}else{
			$list.closest(".action").find("em").html("Set tags");
		}
		
		$list.closest(".task-iform").find("input[name=tags]").val(tags.join(", "));
	};
	
	
	
	
	/**
	 * @desc Add a new milestone
	 */
	function addMilestone(){
		AP.confirm("Confirm to add a new milestone? Unsaved inputs may be lost.", function(){
			Milestone.create();
		});
	};
	
	
	function rebuildForm(id){
		$("#"+id).closest(".js-group").find(".group-cta.url").click();
		
		setTimeout(function(){
			$("#"+id).find("input[name=name]").focus();
		}, 200);
	};
	
};


Task.option = new function __TaskOption() {
	this.urgencies = function () {
		return [
			{
				label: "Bình thường",
				value: "0",
				color: "0",
				name: "Bình thường",
				id: 0
			},
			{
				label: "Khẩn cấp",
				value: "1",
				color: "8",
				name: "Khẩn cấp",
				id: 1
			}
		];
	};


	this.importances = function () {
		return [
			{
				label: "Bình thường", value: "0", color: "0", name: "Bình thường", id: 0
			},
			{
				label: "Quan trọng", value: "1", color: "4", name: "Quan trọng", id: 1
			}
		];
	};


	this.reviews = function (assignee) {
		if (assignee) {
			return [
				{
					label: "Chờ review", value: "0", color: "6", name: "Chờ review", id: 0
				},
				{
					label: "Đang làm", value: "2", "color": "7", name: "Đang làm", id: 2
				}
			];
		}
		return [
			{
				label: "Chờ review", value: "0", color: "6", name: "Chờ review", id: 0
			},
			{
				label: "Hoàn thành", value: "1", "color": "4", name: "Hoàn thành", id: 1
			},
			{
				label: "Đang làm", value: "2", "color": "7", name: "Đang làm", id: 2
			}
		];
	};

	this.tags = function (context, add_button) {
		if (!context) {
			context = Project.inspect();
		}

		if (!context) {
			return [];
		}

		var tags = context.tags;

		var r = AP.select(tags, function (e) {
			e.id = e.key;
			return e;
		});

		if (add_button) {
			r.push({
				label: "Thêm nhanh nhãn mới",
				name: "Thêm nhanh nhãn mới",
				value: -2,
				color: 0,
				id: -2,
				icon: "-ap icon-plus3"
			});
			r.push({
				label: "Quản lý và sửa nhãn",
				name: "Quản lý và sửa nhãn",
				value: -1,
				color: 0,
				id: -1,
				icon: "-ap icon-price-tag2"
			});
		}

		return r;
	};
};


Task.field=new function __TaskField(){
	this.date=function(val){
		if (!parseInt(val)){
			return "<span class='empty-date'></span>";
		}
		
		return AP.time.time("%d/%m/%Y", val);
	};
	
	
	this.val=function(task, field){
		var row=AP.array.single(task.form, function(e){
			return e.id==field.id;
		});
		
	
		if (!row){
			return "";
		}
		
		if (row.type=="int" || row.type=="float"){
			if (row.value=="false" || row.value===false){
				return "";
			}
		}
		
		return row.value;
	};
	
	
	this.display=function(task, field){
		var row=AP.array.single(task.form, function(e){
			return e.id==field.id;
		});


		if (field.type=="checkbox"){
			if (!row){
				return "<div class='cb -v' data-value=''><div class='task-status relative'></div></div>";
			}

			if (row.value=="yes"){
				return "<div class='cb -done -v' data-value='yes'><div class='task-status custom-done relative'></div></div>";
			}
			
			return "<div class='cb -v'  data-value=''><div class='task-status relative'></div></div>";
		}
		
		if (!row){
			return "";
		}	
		
		if (field.type=="int"){
			if (!AP.data.isInt(row.value)){
				return "";
			}
			return AP.data.numberFormat(row.value);
		}
		
		if (field.type=="date"){
			return row.display;
		}

		if (field.type=="float"){
			return row.value;
		}

		if (field.type=="datetime"){
			if (row.display == row.value) {
				return row.value;
			}
			return row.display;
		}
		
		return row.value;
	};
	
};


Task.inline=new function __TaskInline(){
	this.fix=function(id, key, value, ref){
		return this.edit(id, {key: key, value: value}, ref);
	};
	
	this.edit=function(id, kv, ref){
		UI.ajaxShow();
		AP.post("api/task/fix",{id: id, key: kv.key, value: kv.value}, function(code){
			UI.ajaxHide();	
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			UI.flash("Task updated ...");

			if (code.comment) {
				Task.inline.insertComment(code.comment, code.task);
			}

			if (kv.key=="milestone") {
				Side.milestone.update(code);
			}
			
			Task.ie.close();
			Project.on.taskUpdated(code.task);
		});
	};
	
//	
//	this.editDuration=function(id, start, deadline, ref){
//		UI.ajaxShow();
//		AP.post("api/task/fix",{id: id, key: "duration", start: start, deadline: deadline}, function(code){
//			UI.ajaxHide();
//			
//			if (!code.good()){
//				return AP.alertError(code.message);
//			}
//			
//			UI.flash("Task updated ...");
//			Project.on.taskUpdated(code.task);
//		});
//	};
//	
	
	this.editStartTimeDeadline=function(id, start, deadline, ref){
		UI.ajaxShow();
		AP.post("api/task/fix",{id: id, key: "starttime.deadline", start: start, deadline: deadline}, function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			UI.flash("Task updated ...");
			Project.on.taskUpdated(code.task);
		});
	};
	
	
	this.assign=function(id, uid, ref){
		this.edit(id, {key: "assign", value: uid}, ref);
	};
	
	
	this.updateTaskList=function(id, list_id, ref){
		this.edit(id, {key: "tasklist", value: list_id}, ref);
	};
	
	
	this.editCustom=function(id, kv, ref){
		this.edit(id, kv, ref);
	};
	
	
	/**
	 * @desc Remove a task
	 */
	this.remove=function(id, ref){
		AP.confirm("Bạn có chắc chắn muốn xóa công việc này?", function(){
			UI.ajaxShow();
			AP.post("api/task/remove",{id: id}, function(code){
				UI.ajaxHide();
				
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				UI.flash("Công việc đã được xóa ...");
				Side.milestone.removeTask(code);
				Project.on.taskDeleted(id);
			});
		});
	};

	
	
	/**
	 * @desc Edit a custom field
	 */
	this.editCustomField=function(task, fid, ref){
		if (!task){
			return;
		}

		var project = Client.pageData.project;
		if (typeof project === 'undefined') {
			project = Client.tempData.context;
		}

		var row=AP.array.findObj(project.form, fid);
		if (!row){
			return;
		}

		var field=AP.array.findObj(task.form, fid);

		var value='';
		if (field){
			if (row.type == 'datetime') {
				if (field.display) {
					var display = field.display.split(" ");
					if (display[0].length < display[1].length) {
						field.display = display[1] + " " + display[0];
					}
				}
			}
			value=field.display;
			field.value = field.display;
		} else {
			field = {
				id:row.id, 
				name:row.name, 
				value:"", 
				display:"", 
				type:row.type, 
				options:row.options, 
				placeholder:row.placeholder
			};
		}

		var data = {id: task.id, key: "custom_field", fid:fid};
		
		var form = Form.create('fly-edititem-fx',{'action': "api/task/fix"})
		.row(
			Form.label({label: "Tên công việc *"}),
			Form.input({name: 'name', type:"fake"}).value(task.name)
		).addClass("-big")
		.customForm([row], [field])
		
		.buttons([
			 {label: "Save", action: function(){
				 Form.submit("#fly-edititem-fx", function(code){
					 if (!code.good()){
						 return AP.alertError(code.message);
					 }
					 
					 UI.flash("Đã sửa thành công...");
					 Form.hide("fly-edititem-fx");
					 
					 Task.update(code.task, code.comment);
				 })
			 }, style: 'ok -success -rounded bold'},
			 {label: "Huỷ bỏ", action: function(){
				 Form.hide("fly-edititem-fx");
			 }, style:'cancel -passive-2 -rounded'}
		])
		.hiddens(data);
	
		Form.pop({id:'fly-edititem-dx', width: 640, label: "Edit custom field value"}).setForm(form).show().focus('value');
	};
	
	
	
	/**
	 * @desc Safely insert comment
	 */
	this.insertComment = function(comment, origin){
		if (!comment){
			return;
		}
		
		if (comment.metatype=="system"){
			Comment.insertLog("#js-task-logs", comment);
			return;
		}
		
		if (!origin){
			return;
		}
		
		$canvas = $('#task-comments');
		Comment.ui.insert($canvas, origin, comment);
		
		// $canvas.trigger("commentposted", code.task);
		// $canvas.find(".comment-counter-"+origin.gid).html(origin.stats.comments);
		// AP.fire("comment.posted", [origin, comment]);
	};


	/**
	 * @desc Safely update tasklist
	 */
	this.updateTaskList = function(tasklist_id){
		var tid = tasklist_id;

		var select_tasklist = $("#js-project-task .js-task-main .desc .js-select-tl");
		var items = $("#js-project-task .js-task-main .desc .js-select-tl .-items");
		var tasklist_name = items.find("[data-tid='"+(tid)+"']").text();
		var select_tasklists_html = items.html();

		select_tasklist.html(tasklist_name + "<div class='-items'>" + select_tasklists_html + "</div>");
	};
	
};


Task.fav=new function __ProjectFav(){
    this.toggle = function(ref) {
		var id=$(ref).closest(".js-task").data("id");
    	UI.fav.update("api/task/fav", {
    		target: {id: id}, 
    		list: [],
    	}, function(fav, list, code){
    		Client.pageData.favs=list;
    		Project.on.taskUpdated(code.task);
    	});
    	
    	return;
    };
    
    this.isFav=function(id){
    	return UI.fav.isFav(id, Client.pageData.favs);
    };
    
};


Task.action=new function __TaskAction(){
	this.follow=function(flag){
		UI.ajaxShow();
		AP.post("api/task/action",{id: Client.tempData.task.id, flag: flag, user_id: Client.viewer.id, action: "follow"}, function(code){
			UI.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			TaskDisplay.taskUpdated(code.task);
		});
	};	
	
	
	this.setFollow=function(user){
		UI.ajaxShow();
		AP.post("api/task/action",{id: Client.tempData.task.id, flag: 1, user_id: user.id, action: "follow"}, function(code){
			UI.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			TaskDisplay.taskUpdated(code.task);

			if(window.location.href.indexOf("calendar") >= 0) {
				$("#js-project-item .actions .-close").hide();
			}
		});
	};
	
	
	/**
	 * @desc Setting real order
	 */
	this.setOrder=function(id, prev_id, tasklist_id){
		UI.ajaxShow();
		AP.post("api/task/reorder",{id: id, prev_id: prev_id, tid: tasklist_id}, function(code){
			UI.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
		});
	};
	
	
	this.edit=function(id){
		
	};
	
	
	this.reassign=function(id){
		if (AP.data.isObject(id)){
			id=id.id;
		}
		
		Task.ie.close();
		UI.user.picker({
			title: "Chọn một người để giao việc",
			multi: false,
			callback: function(users){
				if (users.length==1){
					Task.inline.assign(id, users[0]);
				}
			}
		});
	};



	this.addMulti=function(item){
		var role = "followers";
		var data = {id: item.id, role:role};
		var label = "Thêm nhiều "+role;
		Tag.context(false);
		var form = Form.create('fly-task-add-multi-followers-fx',{'action': "api/task/add.multi.followers"})
			.row(
				Form.label({label: label}),
				Form.input({name: 'name', type: "textarea", placeholder: "Sử dụng @ để tag thêm nhiều người theo dõi", role:"tag"}).css({height: 100})
			).addClass("-big")
			.buttons([
				{label: "Thêm", action: function(){
					Form.submit("#fly-task-add-multi-followers-fx", function(code){
						Tag.context(true);
						if (!code.good()){
							return AP.alertError(code.message);
						}
						
						Form.hide("fly-task-add-multi-followers-fx");
						UI.flash("Đã thêm thành công...");
						AP.refresh();
					})
				}, style: 'ok -success -rounded bold'},
				{label: "Huỷ", action: function(){
					Form.hide("fly-task-add-multi-followers-fx");
				}, style:'cancel -passive-2 -rounded'}
			]).hiddens(data);

		Form.pop({id:'fly-task-add-multi-followers-fx-dx', width: 450, label: label, layout: 'flat'}).setForm(form).show().focus('name');
	};
};


Task.file=new function __TaskFile(){
	 this.remove = function (fileId){
        var task = Client.tempData.task;
        var params={task_id: task.id, id: fileId};

        AP.confirm("Bạn có muốn xóa file này ? ", function(){
            UI.ajaxShow();
            AP.post("api/task/delete-file", params, function(code){
                UI.ajaxHide();
                if (!code.good()){
                    return AP.alertError(code.message);
                }

                UI.flash("File đã được xóa ...");
                // AP.xRefresh();
                Project.on.taskUpdated(code.task);
            });
        });
    };    
};


Task.cs = new function __TaskCS(){
	this.current = function (task) {
		var order = Board.data.period_by;
		if (!order){
			order="created";
		}
		
		var time = 0;
		var stack=Client.pageData.stack;
		
		if (order == "deadline") {
			time = parseInt(task.deadline);
		} else if (order == "created") {
			time = parseInt(task.since);
		}else{
			time = parseInt(task.last_update);
		}

		var stime = parseInt(stack.stime);
		var etime = parseInt(stack.etime);

		if (time >= stime & time <= etime){
			return 1;
		}

		if (order == "deadline" && !time) {
			return 1;
		}

		return 0;
	};

	
	

	this.previous = function (task) {
		return !this.current(task);
	};
};


/**
 * @desc Task inline edit form, could be use in TaskDisplay or TaskBoard
 */

Task.ie=new function __TaskInlineEditForm(){
	this.init=function(ref, task, key){
		if (AP.data.isInt(task)){
			task=Task.fromContext(task);
		}
		
		if (!task){
			alert("CANNOT_FIND_TASK");
			return;
		}
		
		initCanvas(ref);
		$("#ie-body").css({top:0, left:0});
		if (key=="deadline"){
			$("#ie-body").css({left:-30});
		}
		
		var project=Project.fromContext(task.ns.id);

		if (!project){
			alert("CANNOT_FIND_PROJECT");
			return;
		}
		
		if (key=="duration"){
			return quickTextInline(task, key);
		}
		
		if (key=="tags"){
			return quickTagsInline(task, key, project);
		}
		
		if (key=="milestone"){
			return quickMilestoneInline(task, key, project);
		}

		if (key=="assign"){
			return quickAssignInline(task, key, project, ref);
		}
		
		if (key=="deadline"){
			if (parseInt(project.deadline_has_time)){
				return quickDeadlineAndTimeInline(task, key, project);	
			}
			
			return quickDeadlineDateInline(task, key, project);				
		}
		
		if (key=="starttime"){
			return quickStarttimeInline(task, key, project, ref);
		}
		
		initBody(task, key);
		
	};
	
	
	this.close=function(){
		$("#ie-wrapper-global").remove();
		
		if (mobile()){
			$(document.body).removeClass("xo");
		}
	};
	
	this.hide=function(){
		return this.close();
	};
	
	
	
	function initCanvas(ref){
		if ($("#ie-wrapper-global").length){
			$("#ie-wrapper-global").remove();
		}
				
		var style={};
		var top=$(ref).offset().top+$(ref).outerHeight();
		if (mobile()){
			top=$(ref).offset().top+20;
		}
		
		var left=$(ref).offset().left;
		
		style["padding-top"]=top+"px";
		style["padding-left"]=left+"px";
		
		var html="<div id='ie-wrapper-global' class='ie-wrapper-global'> <div class='ie-close' onclick='Task.ie.close();'></div> <div class='ie-wrapper scroll-y'> <div class='ie-close' onclick='Task.ie.close();'></div> <div class='ie-real-wrapper' style='"+(formatStyle(style))+"'> <div class='ie-close' onclick='Task.ie.close();'></div> <div class='ie-real'> <div id='ie-body' class='ie-body'></div> </div> </div> </div> </div>";
		
		if (mobile()){
			$(document.body).addClass("xo");
		}
		
		$(html).appendTo(document.body);
	};
	
	
	
	function quickTextInline(task, key){
		var html="<div class='white-form'> <input type='hidden' name='id' value='"+(task.id)+"'/> <input type='hidden' name='key' value='"+(key)+"'/> <div class='input'><input name='value' type='text' placeholder='Enter value'></div> <div class='footer'> <div class='cta'>Lưu</div> <div class='cancel' onclick='Task.ie.close();'>Bỏ qua</div> </div> </div>";
		
		$(html).appendTo("#ie-body");
		$("#ie-body input").focus();
		
		$("#ie-body .cta").click(function(){
			var data=getData();
			UI.ajaxShow();
			AP.post("api/task/fix", data, function(code){
				UI.ajaxHide();
				
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				Project.on.taskUpdated(code.task);
			})
		});
	};
	
	
	
	function quickTagsInline(task, key, project){
		Form.inlineLabelTagger("#ie-body", function(item){
			var id=task.id;
			var tag=$(item).data("id");
			var $this=$("#ie-body");
			
			if (tag=="-1" || tag==-1){
				return AP.toURL(project.path+"/settings?s=tags");	
			}
			
			if (tag=="-2" || tag==-2){
				Project.taglist.quickCreate(project, function(tag){
					Task.inline.edit(id, {key: "tag", value: tag.name});
				});
				return;
			}
			
			Task.inline.edit(id, {key: "tag", value: tag}, $this);
		}, {
			labels: Task.option.tags(project, true),
			position:{top:2, left:0},
			click: true,
			selected: task.tags,
			title: "Select tags"
		});
		
		$("#ie-body").find(".ap-inline-tagger").click(function(){
			Task.ie.close();
		});
	};
	
	
	function quickMilestoneInline(task, key, project){
		Form.inlineLabelTagger("#ie-body", function(item){
			var id=task.id;
			var tag=$(item).data("id");
			
			if (tag=="-1" || tag==-1){
				return Milestone.create();	
			}

			var old = AP.array.findObj(Client.pageData.milestones, task.milestone_id);
			if (old) {
				old.total = old.total - 1;
			}

			Task.inline.edit(id, {key: "milestone", value: tag});
		}, {
			labels: Milestone.project.options(project),
			position:{top:2, left:-20},
			click: true,
			selected: [task.milestone_id],
			title: "Chọn mục tiêu",
			filter: false
		});
		
		$("#ie-body").find(".ap-inline-tagger").click(function(){
			Task.ie.close();
		});
	};
	
	
	
	/**
	 * @desc Quickly assign a task to another
	 */
	function quickAssignInline(task, key, project, ref){
		var people=Project.getPeople(project);
		var left=0;
		if (ref && $(ref).tagName()=="em"){
			left=-180;
		}
		
		Form.inlineTagger("#ie-body", {
			title: "Giao cho",
			click: true,
			position: {top:5, left:left}, 
			select: function(user){
				var id=task.id;
				Task.inline.assign(id, user.id);
			},
			hide: function(){
				var $box=$(this).closest(".js-task");
				setTimeout(function(){
				}, 150);
			},
			remove: function(){
				var id=task.id;
				UI.ajaxShow();
				AP.post("api/task/delete-assign",{id: id}, function(code){
					UI.ajaxHide();

					if (!code.good()){
						return AP.alertError(code.message);
					}

					UI.flash("Đã hủy giao việc ...");
					Task.ie.close();
					Task.inline.insertComment(code.comment, code.task);
					Project.on.taskUpdated(code.task);
				});
			},
			footer: "<div onclick='Task.action.reassign("+(task.id)+")'>Giao cho người bên ngoài dự án/team</div>",
			users: people
		});
	};
	
	
	
	function quickDeadlineDateInline(task, key, project){
		if (!parseInt(project.deadline_has_time)){
			extra='';
		}
		
		$("#ie-body").html("<div class='cform'> <div class='title'> Chọn deadline </div> <div class='side'> <span class='action url' title='Remove task deadline' data-url='action/"+(task.id)+"/deadline-remove'>Bỏ deadline</span> </div> <div class='relative js-date-picker'></div> </div>");
		
		var value=parseInt(task.deadline);
		Form.inlineDatePicker("#ie-body .js-date-picker", function(date){
			Task.ie.close();
			Task.inline.edit(task.id, {key: "deadline", value: AP.i18n.date(date)}, this);
		}, {
			click: true,
			clickOut: false,
			auto: false,
			position: {top:0, left:0},
			hide: function(){
			},
			value: value
		});
		
		Form.render("#ie-body");
		
		$("#ie-body .save").click(function(){
			var data=getData();
			UI.ajaxShow();
			AP.post("api/task/fix", data, function(code){
				UI.ajaxHide();
				
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				Task.ie.close();
				Task.inline.insertComment(code.comment, code.task);
				Project.on.taskUpdated(code.task);
			});
		});
	};
	
	
	function quickDeadlineAndTimeInline(task, key, project){
		var extra="<div class='extra'> <div class='row' style='padding-right:0px'> <div class='input'> <input type='text' data-role='date' name='deadline-date' placeholder='Chọn ngày' data-value='"+(task.deadline)+"'/> </div> </div> <div class='sep-10'></div> <div class='row'> <input type='hidden' name='id' value='"+(task.id)+"'/> <input type='hidden' name='key' value='deadline'/> <div class='input'> <input type='text' data-role='time' name='deadline-time' data-value='"+(task.deadline)+"'/> </div> <div class='save'>Lưu</div> </div> </div>";
		
		if (!parseInt(project.deadline_has_time)){
			extra='';
		}
		
		$("#ie-body").html("<div class='cform'> <div class='title'> Chọn deadline </div> <div class='side'> <span class='action url' title='Remove task deadline' data-url='action/"+(task.id)+"/deadline-remove'>Bỏ deadline</span> </div> "+(extra)+" </div>");
		
	
		Form.render("#ie-body");
		
		$("#ie-body .save").click(function(){
			var data=getData();
			UI.ajaxShow();
			AP.post("api/task/fix", data, function(code){
				UI.ajaxHide();
				
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				Task.ie.close();
				Task.inline.insertComment(code.comment, code.task);
				Project.on.taskUpdated(code.task);
			});
		});
	};
	
	
	
	
	function quickStarttimeInline(task, key, project, ref){
		var left=0;
		var top=0;
		
		if ($(ref).closest(".side-body").length){
			left=-150;
			top=5;
		}
		
		var extra="<div class='extra'> <div class='row' style='padding-right:0px'> <div class='input'> <input type='text' data-role='date' name='starttime-date' placeholder='Chọn ngày' data-value='"+(task.start_time)+"'/> </div> </div> <div class='sep-10'></div> <div class='row'> <input type='hidden' name='id' value='"+(task.id)+"'/> <input type='hidden' name='key' value='start_time'/> <div class='input'> <input type='text' data-role='time' placeholder='Chọn giờ' name='starttime-time' data-value='"+(task.start_time)+"'/> </div> <div class='save'>Lưu</div> </div> </div>";
		
		
		$("#ie-body").html("<div class='cform'> <div class='title'> Chọn tg bắt đầu </div> <div class='side'> <span class='action url' title='Xóa tg bắt đầu' data-url='action/"+(task.id)+"/starttime-remove'>Xóa tg bắt đầu</span> </div> "+(extra)+" </div>").css({left: left, top: top});
		
		Form.render("#ie-body");
		
		$("#ie-body .save").click(function(){
			var data=getData();
			UI.ajaxShow();
			AP.post("api/task/fix", data, function(code){
				UI.ajaxHide();
				
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				Task.ie.close();
				Task.inline.insertComment(code.comment, code.task);
				Project.on.taskUpdated(code.task);
			});
		});
	};
	
	
	
	
	function initBody(task, key){
		
	};
	
	
	
	/**
	 * @desc Get string formatting the element
	 */
	function formatStyle(styles){
		var html='';
		for (var key in styles){
			var value=styles[key];
			if (value===null){
				continue;
			}
			html+=""+(key)+":"+(value)+";";
		}
		
		return html;
	};
	
	
	
	/**
	 * @desc Get data inside the inline edit
	 */
	function getData(){
		var r={};
		var data=$("#ie-body :input").serializeArray();
		for (var i=0; i<data.length; i++){
			r[data[i].name]=data[i].value;
		}
		
		return r;
	};
};


Task.ui=new function __TaskUI(){
	
	this.grandState=function(task){
		if (parseInt(task.status)==1){
			return "done";
		}
		
		var stime=parseInt(task.start_time);
		if (stime && stime <= AP.time.now()){
			return "doing";
		}
		
		return "todo";
	};
	
	
	this.grandDeadline=function(task){
		if (!task.deadline || !parseInt(task.deadline)){
			return '';
		}
		
		var time=AP.time.time('%d/%m', task.deadline);
		if (Client.pageData.project && parseInt(Client.pageData.project.deadline_has_time)){
			time=AP.time.time('%H:%i %d/%m', task.deadline);
		}
		
		if (Compute.doneLate(task) || Compute.overdue(task)){
			return "<em class='red url' data-url='action/"+(task.id)+"/deadline' data-acl='"+(task.acl.time)+"'>"+(time)+"</em>";
		}
		
		return "<em class='url' data-url='action/"+(task.id)+"/deadline' data-acl='"+(task.acl.time)+"'>"+(time)+"</em>";
	};
	
	
	
	
	this.grandTime=function(task){
		var html='';
		if (parseInt(task.duration)){
			html=""+(AP.i18n.duration(task.duration, true))+"";
		}
		
		var time=this.grandDuration(task);
		
		if (html && time){
			return ""+(html)+", "+(time)+"";	
		}
		
		return ""+(html)+""+(time)+"";
	};
	
	
	
	this.grandDuration=function(task){
		var time='';
		if (parseInt(task.start_time) && parseInt(task.deadline)){			
			if (AP.time.sameMonth(task.start_time, task.deadline)){
				time="<em>"+(AP.time.time('%d',task.start_time))+"</em>-"+(AP.time.time('<em>%d</em>/%m',task.deadline))+"";
			}else{
				time="<em>"+(AP.time.time('%d/%m',task.start_time))+"</em> &#x203A; <em>"+(AP.time.time('%d/%m',task.deadline))+"</em>";
			}
		}else if (parseInt(task.start_time)){
			time="Started <em>"+(AP.time.time('%d/%m',task.start_time))+"</em>";	
		}else if (parseInt(task.deadline)){
			if (Client.pageData.project && parseInt(Client.pageData.project.deadline_has_time)){
				time=""+(AP.time.time('%H:%i <em>%d/%m</em>',task.deadline))+"";		
			}else{
				time="<em>"+(AP.time.time('%d/%m',task.deadline))+"</em>";	
			}
		}
		
		return time;
	};
	
	
	
	this.icons=function(task, project){
		var icons=[];
		
		if (parseInt(task.acl.name)){
			icons.push({icon: "ficon-pencil-square", title: "Chỉnh sửa", url:"action/"+task.id+"/edit", value: "", acl: task.acl.name});
		}
		
		if (parseInt(task.acl.time)){
			icons.push({icon: "ficon-calendar", title: "Deadline hoàn thành", url:"action/"+task.id+"/deadline", value: task.deadline, acl: task.acl.time});
			icons.push({icon: "ficon-play-circle", title: "Ngày bắt đầu", url:"action/"+task.id+"/startdate", value: task.start_time, acl: task.acl.time});
		}
		
		// icons.push({icon: "ficon-calendar", title: "Thêm vào lịch", url:"#", value: "", data: task});
		
		if (parseInt(task.acl.desc)){
			icons.push({icon: "ficon-exclamation-circle", title: "Độ khẩn cấp", url:"action/"+task.id+"/urgent", value: task.urgent, acl: task.acl.desc});
			icons.push({icon: "ficon-bookmark", title: "Quan trọng", url:"action/"+task.id+"/important", value: task.important, acl:task.acl.desc});
			
			icons.push({icon: "ficon-bell", title: "Milestone", url:"action/"+task.id+"/milestone", value: task.milestone_id, acl:task.acl.desc});
			
			if (Client.path.app != 'tasks') {
				icons.push({icon: "ficon-tag", title: "Gắn nhãn", url:"action/"+task.id+"/tags", value: task.tags.join(",")});
			}
		}
		
		if (parseInt(task.acl.remove)){
			icons.push({icon: "ficon-trash-o", title: "Xóa công việc", url:"action/"+task.id+"/remove", acl: task.acl.remove});
		}
		
		return icons;
	};
	
	
	this.labels=function(task, project){
		var labels=[];
		
		if (!Client.pageData.context && project){
			labels.push({name: project.name, style:"tag-alt"+project.color+"-edge js-tag", url:project.path});
		}
		
		if (Client.pageData.project && Client.pageData.milestones && Client.pageData.milestones.length && parseInt(task.milestone_id)){
			var ms=Milestone.fromContext(task.milestone_id);
			if (ms){
				var color="main";
				labels.push({name: AP.time.time('%d/%m', ms.time)+" &rsaquo; "+ms.name, style:"tag-"+color+"-edge js-tag", url:"action/filter/milestone-"+ms.id, role:"milestone"});	
			}
		}
		
		if (Client.pageData.project && parseInt(Client.pageData.project.percent_completion) && parseInt(task.complete) && parseInt(task.complete)!=100){
			labels.push({name: task.complete+"%", style: "std js-tag"});
		}
		
		if (parseInt(task.urgent) == 1){
			labels.push({name: "Khẩn cấp", style:"x-error js-tag", url:"action/filter/urgent"});
		}
		
		if (parseInt(task.important) == 1){
			labels.push({name: "Quan trọng", style:"x-hl js-tag", url:"action/filter/important"});
		}

		if (task.metatype == "subtask"){
			if (!Client.pageData.project){
				labels.push({name: "Subtask of "+task.origin_export.name, style:"x-edge js-subtag", url:"action/filter/subtask"});	
			}else{
				labels.push({name: "Subtask", style:"x-edge js-subtag", url:"action/filter/subtask"});
			}
		}

		if (Compute.overdue(task)){
			labels.push({name: "Quá hạn", style:"std x-error js-tag", url:"action/filter/overdue"});
		}
		
		if (Compute.doneLate(task)){
			labels.push({name: "HT sau deadline", style:"std x-overdue js-tag", url:"action/filter/donelate"});
		}
		
		if (!parseInt(task.status) && parseInt(task.deadline) && AP.time.sameDay(task.deadline, AP.time.now())){
			labels.push({name: "Hết hạn hôm nay", style:"std x-hl js-tag", url:"action/filter/today"});
		}
		
		if (parseInt(task.start_time)){
			labels.push({name: "<span class='ficon-caret-right'></span> bắt đầu "+AP.time.time("%d/%m", task.start_time), style:"std js-tag", url:"action/filter/start-"+AP.time.time("%d/%m", task.start_time), value: task.start_time});
		}
		
		if (task.tags && task.tags.length){
			var tags=Project.taglist.parse(task.tags, project);
			for (var i=0; i<tags.length; i++){
				labels.push({name: tags[i].name, style:"tag-alt"+tags[i].color+" -colorful js-tag", url:"action/filter/"+tags[i].key, role: "tag", color: tags[i].color});
			}
		}
		
		
		return labels;
	};
	
	
	
	this.info=function(task, project){
		var info_attachment='';
		var info_checklist='';
		var info_comment='';
		
		if (task.files && task.files.length){
			info_attachment="<span class='istat' title='Attachments'><span class='-ap icon-uniF10A'></span> "+(task.files.length)+"</span>";
		}
		
		if (task.checklists && task.checklists.length){
			info_checklist=Checklist.info(task.checklists);
		}
		
		if (task.stats && task.stats.comments && parseInt(task.stats.comments)){
			info_comment="<span class='istat' title='Comments'><span class='-ap icon-bubble3'></span> "+(task.stats.comments)+"</span>";
		}
		
		return "<span class='istats'>"+(info_comment)+""+(info_attachment)+""+(info_checklist)+"</span>";
	};


	this.getLocalLink=function(content){
		return content.replace(/⑊/g,'&#92;').replace(/&#9290;/g, '&#92;');
	};
	
};


Task.attention=new function __TaskAttention(){
	this.list=function(tasks, canvas, opts){
		if (!opts){
			opts={};
		}
		
		opts=$.extend({limit: 10, auto_collapsed: false});
		
		if (!tasks || !tasks.length){
			if (opts.autocollapse){
				$(canvas).parent().hide();
			}
			
			return;
		}
		
		$(canvas).parent().find(".count").html(tasks.length);
		
		
		var html=AP.render(tasks, function(e, index){
			if (index>=opts.limit){
				if (index==opts.limit){
					return "<div class='imore'>"+(tasks.length-opts.limit)+" more tasks</div>";
				}
				return '';
			}
			
			return getTask(e);
		});
		
		$(canvas).html("<div class='task-elist'>"+(html)+"</div>");
		
		fixOverlap(canvas);
	};
	
	
	function getTask(task){
		var deadline='';
		
		if (parseInt(task.deadline)){
			deadline="<div class='tlabel'>"+(AP.i18n.date(task.deadline))+"</div>";
			if (Compute.overdue(task)){
				deadline="<div class='tlabel -red'>overdue</div>"
			}
		}
		
		var uc='';
		var icon="<div class='sicon -"+(Task.ui.grandState(task))+"'></div>";
		if (parseInt(task.urgent)){
			uc=' -urgent';
			icon="<div class='sicon -image'><img src='"+(Client.image_url)+"/icons/flag/1.png'/></div>";
		}
		
		return "<div class='itask "+(uc)+" url' data-url='task/"+(task.id)+"'> "+(icon)+" <div class='iname'>"+(task.name)+"</div> <div class='iside clear-fix'>"+(deadline)+"</div> </div>";
	};
	
	
	function fixOverlap(canvas){
		$(canvas).find(".itask").each(function(){
			var len=$.trim($(this).find(".iside").text()).length;
			if (len){
				$(this).css({paddingRight: len*5+15});	
			}
		});
	};
};




var TaskDisplay=new function __TaskDisplay(){
	this.last_scroll=-1;
	
	this.display=function(id){
		$(".note-popover").remove();
		
		if ($("#main-board").length || mobile()){
			return TaskDisplay.displayDialog(id);
		}
		
		if ($("#js-calendar").length){
			return TaskDisplay.displayDialog(id);
		}
		
		if (!$("#tasklists").length && !$("#acts").length){
			return TaskDisplay.displayDialog(id);
		}

		MilestoneDisplay.close();
		
		if (Topic.display.visible()){
			Topic.display.close();	
		}
		
		
		if ($("#project-master").length){
			TaskDisplay.last_scroll=$("#project-master").scrollTop();
		}
		
		TaskCanvas.init();
		
		
		AP.loadInlineURL("task/display", {id: id, view_token: Query.get("view_token")}, "#js-project-task", {
			start: function(){
				
			}, end: function(){
				if (mobile()){
					$(document.body).removeClass("xo");
				}
				$(window).resize();
				scrollToTask(id);
			}, error: function(){
				
			}
		});
	};
	
	/**
	 * @desc Display a task in a dialog
	 */
	this.displayDialog = function(task_id){
		AP.destroyDialog("#js-task-dialog");
		$("#js-task-dialog").remove();
		
		UI.ajaxShow();
		AP.customDialog("<div id='js-project-task'></div>", {id: "js-task-dialog"})
		.width(960)
		.addClass("-task-display")
		.css({right: $.sbWidth()})
		.closable(false) 
		.show();
		
		AP.loadInlineURL("task/display", {id: task_id, view_token: Query.get("view_token")}, "#js-project-task", {
			start: function(){
			}, end: function(){
				if (mobile()){
					$(document.body).addClass("xo");
					$("#document").hide();
				}
				
				$("#js-project-task").prepend("<div class='task-dialog-header'> <div class='nav'> <div class='url' data-url='"+(Client.tempData.context.path)+"'> <span class='-ap icon-chevron-left22'></span> "+(Client.tempData.context.name)+" </div> </div> <div class='close' title='Close' onclick='TaskDisplay.close();'><span class='-ap icon-close'></span></div> </div>");
				AP.dialog("#js-task-dialog").balance();
			}, error: function(){
				
			}
		});
		
		return;
		
	};
	
	/**
	 * @desc Handle the case a task is updated on main display
	 */
	this.taskUpdated=function(task, key){
		if (Client.tempData && Client.tempData.task && parseInt(Client.tempData.task.id) == parseInt(task.id)){
			if (key){
				if (key=="checklists"){
					initChecklists(task);
				}
				
				return;
			}
			
			Client.tempData.task=task;
			initMain(task);
			initDesc(task);
			initCTA(task);
			initResult(task);
			initChecklists(task);
			
			TaskDisplay.side.update(task)
		}
	};

	
	/**
	 * @desc Check if there is some task to be displayed
	 */
	this.visible=function(){
		return $("#project-item-canvas").length;
	};
	
	
	/**
	 * @desc Close a task display
	 */
	this.close = function(){
		TaskCanvas.close();
		AP.setURLParams({task: null});
		
		if (mobile()){
			$(document.body).removeClass("xo");
			$("#document").show();
		};
		
		if ($("#project-master").length && TaskDisplay.last_scroll>0){
			$("#project-master").scrollTop(TaskDisplay.last_scroll);
			TaskDisplay.last_scroll=-1;
		}
	};
	
	
	/**
	 * @desc Rendering the task
	 */
	this.render=function(){
		initCanvas(Client.tempData.task);
		
		initMain(Client.tempData.task);
		initCTA(Client.tempData.task);
		initResult(Client.tempData.task);
		
		initChecklists(Client.tempData.task);
		initDesc(Client.tempData.task);
		initSubtasks(Client.tempData.task);
		
		
		TaskDisplay.side.init(Client.tempData.task);
		
		
		// Init comments
		Comment.auto("#js-task-comments", Client.tempData.task,{
			header: 0,
			theme: 'gray',
			autofocus: 0,
			tagdir: 'bottom',
			logs: 1
		});
		
		if (!mobile()){
			$("#tasklists .li").setActive(".li-"+Client.tempData.task.id);
			$("#tasklists .li").removeClass("focusing");
			$("#tasklists .li-"+Client.tempData.task.id).addClass("focusing");	
		}
		
		// Set URLs
		AP.setURLParams({task:Client.tempData.task.id});
		Form.inlineCleaner("#js-project-task");
		
		$("#js-project-task").click(function(e){
			Board.clean("#js-project-task", e.target);
		});
	};

	
	/**
	 * @desc Initializing the canvas to show task
	 */
	function initCanvas(task){
		var html="";
		
		var canvas="<div class='section js-task-main'> <div class='task-header'></div> <div class='task-main'></div> <div class='task-cta'></div> <div class='task-desc' id='js-task-desc'> <div class='actions'> <div class='action js-edit'>Chỉnh sửa</div> <div class='action js-checklist' onclick='Checklist.showForm(this, 1);'>Thêm checklist</div> </div> <div class='title'>Miêu tả công việc</div> <div class='edit-box js-task-content'></div> <div class='js-task-files task-files'></div> </div> </div> <div class='section task-checklists' id='js-checklists'></div> <div class='section task-result' id='js-taskresult'></div> <div class='section' id='js-task-subtasks'> <div class='subtask-title'>Subtasks</div> <div class='subtasks' id='js-subtasks-"+(task.id)+"'></div> </div> <div id='js-task-mobile-fix'></div> <div class='section task-comments'> <div class='top'> Bình luận (<span class='comment-count comment-counter-"+(task.gid)+"' id='comment-counter-"+(task.gid)+"'>"+(task.stats.comments)+"</span>) </div> <div id='js-task-comments'></div> </div>";
		
		$("#js-task-display .main-body").html(canvas);
		
		if (mobile()){
			$("#js-task-display .side-body").appendTo("#js-task-mobile-fix");
		}
	}
	
	
	/**
	 * @desc Init main (header + general info + call to action)
	 */
	function initMain(task){
		var project = Client.tempData.context;
		var tags_plain=task.tags.join(",");
		
		
		var labels=[];
		if (parseInt(task.urgent) === 1){
			labels.push({name: "Khẩn cấp", style:"tag-error-more js-tag", url:"action/filter/urgent"});
		}
		
		if (parseInt(task.important) === 1){
			labels.push({name: "Quan trọng", style:"tag-success-more js-tag", url:"action/filter/urgent"});
		}
		
		if (Compute.overdue(task)){
			labels.push({name: "Quá hạn", style:"tag-alt7-more x-error js-tag", url:"action/filter/overdue"});
		}
		
		if (Compute.doneLate(task)){
			labels.push({name: "HT sau deadline", style:"tag-alt7-more x-error js-tag", url:"action/filter/donelate"});
		}
		
		if (task.tags && task.tags.length){
			var tags=Project.taglist.parse(task.tags);
			for (var i=0; i<tags.length; i++){
				labels.push({name: tags[i].name, style:"tag-alt"+tags[i].color+" -colorful js-tag", url:"action/filter/"+tags[i].key, role: "tag", color: tags[i].color});
			}
		}
		
		var tags_html=AP.render(labels, function(e){
			return "<div class='tag "+e.style+" url' data-url='"+e.url+"'>"+e.name+"</div>";
		});
		
		
		var add_tag="<div class='tag js-task-detail -add url' data-src='task.display' data-xurl='action/"+task.id+"/tags' data-value='"+tags_plain+"'><span class='-ap icon-plus2'></span>&nbsp; thêm nhãn</div>";
		if (!parseInt(task.acl.desc)){
			add_tag="";
		}
		
		if (!tags_html || !tags_html.length){
			if (!add_tag || !add_tag.length){
				tags_html="<span class='exp'>Chi tiết công việc</span>";
			}
		}
		
		
		var star="<span class='ficon-star-o'></span>";
		if (UI.fav.isFav(task.id, Client.pageData.favs)){
			star="<span class='ficon-star text-yellow'></span>";
		}
		
		var urgent="<div class='action -urgent"+(task.urgent)+" url' title='Toggle urgent flag' data-acl='"+(task.acl.desc)+"' data-xurl='action/"+(task.id)+"/urgent' data-value='"+(task.urgent)+"'><span class='ficon-exclamation-circle'></span></div>";
		
		var important="<div class='action url -important"+(task.important)+"' title='Toggle important flag' data-acl='"+(task.acl.desc)+"' data-xurl='action/"+(task.id)+"/important' data-value='"+(task.important)+"'><span class='ficon-bookmark-o'></span></div>";
		if (parseInt(task.important)){
			var important="<div class='action url -important"+(task.important)+"' title='Toggle important flag' data-acl='"+(task.acl.desc)+"' data-xurl='action/"+(task.id)+"/important' data-value='"+(task.important)+"'><span class='ficon-bookmark'></span></div>";
		}
		
		if (!parseInt(task.acl.desc)){
			urgent="";
			important="";
		}
		
		var select_tasklists = AP.render(project.cached_tasklists, function(e) {
			if (parseInt(e.id)==0) {
				return "<div class='-item url' data-url='action/"+(task.id)+"/tasklist' data-tid='"+(e.id)+"' data-id='"+(e.id)+"'>Chưa phân loại</div>";
			} else {
				return "<div class='-item url' data-url='action/" + task.id + "/tasklist' data-tid='" + e.id + "' data-id='" + e.id + "'>" + e.name + "</div>";
			}
		});

		var tl = AP.array.findObj(project.cached_tasklists, task.tasklist_id);
		if (!tl) {
			tl = {id: 0, name: ""};
		}

		if (task.metatype == "subtask") {
			select_tasklists = "<div class='-item'>Chưa phân loại</div>";
			if (tl.id > 0) {
				select_tasklists = "<div class='-item' data-tid='" + tl.id + "' data-id='" + tl.id + "'>" + tl.name + "</div>";
			}
		}
		
		select_tasklists="<div class='-items'>"+select_tasklists+"</div>";
		
		var edit_form="<div class='edit-form'> <form method='post' action='api/task/fix'> <div class='row'> <input type='hidden' name='id' value='"+(task.id)+"'/> <input type='hidden' name='key' value='name'/> <textarea class='-big' name='value'>"+(task.name)+"</textarea> </div> <div class='edit-ctas clear-fix'> <div class='save url' data-url='action/0/submitnow'>Lưu thay đổi</div> <div class='cancel url' data-url='action/0/submitcancel'>Bỏ qua</div> <div class='note'>Nhấn Enter để lưu nhanh &middot; <b class='url' data-url='action/0/submitcancel'>Bỏ qua</b></div> </div> </form> </div>";
		
		if (!parseInt(task.acl.name)){
			edit_form="";
		}
		
	
		var deadline="Chọn deadline";
		
		if (parseInt(task.deadline)){
			deadline=AP.i18n.date(task.deadline);
			if (parseInt(project.deadline_has_time)){
				deadline=AP.i18n.datetime(task.deadline);	
			}
		}
		
		deadline="Deadline: <span class='url em inline' data-url='action/"+(task.id)+"/deadline' data-acl='"+(task.acl.time)+"'>"+(deadline)+"</div>";
		
		var startdate="<em class='a normal js-set-startdate'>Chọn ngày bắt đầu</em>";
		if (parseInt(task.stime)){
			startdate="Ngày bắt đầu: <em>"+AP.i18n.datetime(task.stime)+"</em>";
		}

		deadline="<div class='deadline'>" +
		"	<div class='url' data-url='action/"+task.id+"/startdate' data-src='' data-acl='"+task.acl.time+"'>"+startdate+"</div>" +
		"	<span class='inline'>&nbsp; <span class='-ap icon-arrow-right'></span> &nbsp;</span>" +
		"	<div class='deadline-display inline'>"+deadline+"</div>" +
		"</div>";
		
		var gen_prev = "";

		if (typeof task.data.gen_prev !== 'undefined'){
            var open_link = "data-url='"+(task.data.gen_prev.link)+"'";
            if (task.data.gen_prev.type == "projecttasks"){
                open_link = "onclick='TaskDisplay.openTaskNewTab("+(task.data.gen_prev.id)+")'";
            }
            gen_prev="<div class='desc origin_link'> <span class='-ap icon-uniF143'></span>&nbsp; Linked to <span class='url' "+(open_link)+">"+(task.data.gen_prev.name)+"</span> </div>";
        }

		if (task.origin_export && task.origin_export.name && task.origin_export.type != "repeatedtasks"){
			gen_prev="<div class='desc origin_link'> <span class='-ap icon-uniF143'></span>&nbsp; Linked to <span class='url' data-xurl='task/"+(task.origin_export.id)+"'>"+(task.origin_export.name)+"</span> </div>";
		}

		if (task.origin_export && typeof task.origin_export.abs_link != 'undefined' && task.origin_export.abs_link != '') {
			t_origin_lnk = task.origin_export.abs_link;
			gen_prev="<div class='desc origin_link'> <span class='-ap icon-uniF143'></span>&nbsp; Linked to <span class='url' data-url='"+(task.origin_export.abs_link)+"'>"+(task.origin_export.name)+"</span> </div>";
		}
		
		var grand_state=Task.ui.grandState(task);
		var grand_state_html='';
		if (grand_state=='done'){
			grand_state_html="<span class='ficon-check-circle text-success'></span>&nbsp; <b class='text-success'>Done</b> &middot;";
		}else if (grand_state=='doing'){
			grand_state_html="<span class='ficon-circle anim-showhide-inf' style='color:#5da4ed'></span>&nbsp; Doing &middot;";
		}else{
			grand_state_html="<span class='ficon-circle-o'></span>&nbsp; Todo &middot;";
		}

		var tl_name = parseInt(tl.id) ? tl.name : "Chưa phân loại";
		
		var html="<div class='edit-box compact edit-task-name'> <div class='edit-display'><h1>"+(task.name)+"</h1></div> "+(edit_form)+" </div> <div class='desc'> "+(grand_state_html)+" Trong <span class='url url-detail' data-url='"+(project.path)+"'>"+(project.name)+"</span>&nbsp; &rsaquo; &nbsp; <span class='dd unselectable js-select-tl'>"+(tl_name)+" "+(select_tasklists)+"</span> </div> <div class='desc'><span class='-ap icon-uniF10B'></span>&nbsp; "+(deadline)+"</div> "+(gen_prev)+"";
		
		
		$("#js-task-display .task-main").html(html);
		var tags="<div class='tags clear-fix'> "+(tags_html)+""+(add_tag)+"</div>";
		var options=(parseInt(task.acl.managed)?("<div class='action -more' onclick='Task.itemOptions("+task.id+");'><span class='-ap icon-dots-three-horizontal'></span></div>"):"");
		
		
		$("#js-task-display .task-header").html(
			""+(tags)+" <div class='actions'> <div class='action -close' title='Close task preview' onclick='TaskDisplay.close();'><span class='-ap icon-close'></span></div> <div class='action -star url' title='Toggle favourite task' data-xurl='action/"+(task.id)+"/star'>"+(star)+"</div> <div class='action -calendar url' title='Add to calendar' data-url='action/"+(task.id)+"/addtocalendar'><span class='ficon-calendar-plus-o'></span></div> "+(important)+" "+(urgent)+" "+(options)+" </div>");
		
		
		if (parseInt(task.acl.name)){
			$("#js-task-display .js-select-tl").click(function(){
				$(this).toggleClass("active");
			});
		}
		
		$("#js-project-task .edit-task-name .edit-display").click(function(){
			if (parseInt(task.acl.name)) {
				$(this).closest(".edit-box").addClass("editing");
			}
		});
		
		$("#js-project-task .edit-form textarea").autoExpand();
	};
	
	
	
	/**
	 * @desc Init task description, binding necessary events
	 */
	function initDesc(task){
		var drive_button='';
		if (!mobile() && Client.viewer.metatype!='guest'){
			drive_button="<div class='action js-upload-drive'>Thêm tài liệu từ Base Drive</div>";
		}
		
		var file_headers="<div class='title'>Attachments</div> <div class='actions'> <div class='action js-upload'>Thêm tài liệu</div> "+(drive_button)+" </div>";
		
		var files_html=AP.render(task.files, function(e){
			return getFile(e, task);
		});
		
		if (!files_html || !files_html.length){
			files_html="<div class='text-a' style='padding-top:5px; padding-bottom:5px;'>No document attached</div>";
		}
		
		if (Base.config.file_preview){
			files_html="<div class='file-previews clear-fix'>"+(files_html)+"</div>";
		}
		
		
		$("#js-task-display .task-desc .js-task-files").html(file_headers+ "<div class='files'>"+files_html+"</div>");
		
		Base.file.previewMultiples("#js-task-display .files", ".name");
		
		var cx=People.get(task.creator_username);
		

		var content="<div class='no-content'>Chưa có mô tả cho công việc này</div>";
		if (task.content && task.content.length){
			content = Task.ui.getLocalLink(task.content);
		}
		
		var custom_fields="";
		if (task.form && task.form.length){
			custom_fields="<div class='edit-custom'>"+AP.render(task.form, function(e){
				var editable="";
				if (parseInt(task.acl.desc)){
					editable="<div class='edit-icon url' data-url='action/"+(task.id)+"/fedit' data-fid='"+(e.id)+"'> <span class='ficon-pencil-square'></span> <span class='ap-f12'>Chỉnh sửa</span> </div>";
				}
				
				return "<div class='cr'> <div class='lb ap-xdot'>"+(e.name)+"</div> <div class='db'>"+(Task.ui.getLocalLink(e.display))+"&nbsp;</div> "+(editable)+" </div>";
			})+"</div>";
		}
		
		
		var desc="<div class='edit-display'> <div class='desc acl-"+(task.acl.desc)+"'> <div class='icon-desc -right'></div> "+(content)+" </div> </div> <div class='edit-form edit-content'> <form method='post' action='api/task/fix'> <input type='hidden' name='id' value='"+(task.id)+"'/> <input type='hidden' name='key' value='content'/> <div class='row'><textarea placeholder='Miêu tả công việc' name='value'></textarea></div> <div class='row clear-fix'> <div class='button -cta url' data-xurl='action/0/submitinline' data-key='content'>Lưu</div> <div class='cancel url' data-xurl='action/0/submitcancel'><span class='-ap icon-close'></span></div> </div> </form> </div>" +
			custom_fields+"";
		
		$("#js-task-desc .js-task-content").html(desc);
		$("#js-task-desc .js-task-content .desc").linkify();
		
		UI.editor("#js-task-desc textarea[name=value]",{
			minHeight: 100,
			value: Textarea.simple(task.content)
		});

		AP.uploadable("#js-task-desc .js-upload-drive", {
			action: "api/task/upload",
			name: "file",
			data: {
				id: task.id
			},
			multi: true,
			drive: true
		}, function(code){
			if (code.good()){
				initDesc(code.task);
			}
		});

		AP.uploadable("#js-task-desc .js-upload", {
			action: "api/task/upload",
			name: "file",
			data: {
				id: task.id
			},
			multi: true
		}, function(code){
			if (code.good()){
				initDesc(code.task);
			}
		});
		
		$("#js-task-desc .js-edit").click(function () {
			if (parseInt(task.acl.desc)) {
				$("#js-task-desc .edit-box").addClass("editing");
			}
		});

		$("#js-project-task .edit-box textarea").enter(function(){
			Form.submitFrom(this, function(code){
				if (!code.good()){
					return AP.alertError(code.message);
				}

				UI.flash("Task updated ...");
				Project.on.taskUpdated(code.task, code.comment);
			});
		});
	};
	
	
	
	/**
	 * @desc Scroll to an item when there is such item on the right
	 */
	function scrollToTask(task_id){
		if ($("#tasklists").length && $("#task-"+task_id).length){
			var pscroll=$("#tasklists").scrollTop();
			var ptop=$("#tasklists").offset().top;
			var ph=$("#tasklists").height();
			
			
			var etop=$("#task-"+task_id).offset().top;
			
			var rel_top=etop-ptop;
			var rel_bottom=rel_top+$("#task-"+task_id).height();
			
			if (rel_top < 0){
				$("#tasklists").scrollTop(etop);
			}else if (rel_bottom > ph){
				$("#tasklists").scrollTop(etop-ptop-50);
			}
		}
	};
	
	
	
	/**
	 * @desc Init the main task cta
	 */
	function initCTA(task){
		var assign="<div class='avatar avatar-32 -circled'><div class='user-add'></div></div>" +
			"<div class='name' style='padding-top:8px;'>Giao việc</div>";
		
		var user=People.get(task.username);
		if (user && user.id) {
			assign="<div class='avatar avatar-32 -circled'><div class='image'><img src='"+AP.xthumb(user.gavatar)+"'/></div></div>" +
			"<div class='name'>"+user.name+"</div>" +
			"<div class='info'>"+user.title+"</div>";
		}
				
		var label="<div class='lb'>Đang làm</div>";
		var exp="Click để đánh dấu hoàn thành";

		if (parseInt(task.review)) {
			exp="Đang chờ xác nhận hoàn thành";
			label="<div class='lb'>Đang chờ review</div>";
			
			if (parseInt(task.acl.review)){
				exp="Click để xác nhận hoàn thành";
			}else{
				
			}
		}


		var review_action = "";
		if (task.status == 0 && task.review == 0) {
			review_action = "";
		} else {
			review_action = "data-xurl='action/"+task.id+"/review'";
			if (task.user_id == Client.viewer.id) {
				review_action += " data-assignee='1'";
			}
		}

		if (!parseInt(task.status)){
			label="<div class='lb'>Đang làm</div>";
		}
		
		var grand_status="";
		if (parseInt(task.status)){
			grand_status="-done";
			label="<div class='lb'>Hoàn thành</div>";
			exp='';
		}else if (parseInt(task.review)){
			grand_status="-review";
			label="<div class='lb'>Chờ review</div>";
		}
		
		var duration='';
		if (Client.tempData.context.task_duration){
			var duration_text=AP.i18n.duration(task.duration);
			if (!parseInt(task.duration)){
				duration_text="Chưa xác lập";
			}
			duration="<div class='task-duration acl-"+(task.acl.time)+" url' data-url='action/"+(task.id)+"/duration'> <div class='label'>Tgian định mức</div> <div class='value'>"+(duration_text)+"</div> </div>";
		}
		

		exp=(exp && exp.length)?`<div class='exp'><div class='t'>${exp}</div></div>`:'';
		
		var cta="<div class='cta "+(grand_status)+" url clickable-"+(task.acl.status)+"'> "+(exp)+" <div class='box url' data-url='action/"+(task.id)+"/check' data-status='"+(task.status)+"' data-acl='"+(task.acl.status)+"'></div> <div class='label url "+(review_action.length?'with-review':'')+"' data-detail='1' "+(review_action)+" data-value='"+(task.status)+"'>"+(label)+"</div> </div> "+(duration)+" <div class='assign js-task-detail url' data-metatype='"+(task.metatype)+"' data-url='action/"+(task.id)+"/assign' data-acl='"+(task.acl.assign)+"' data-src='task.display'>"+(assign)+"</div>";
				
		$("#js-task-display .task-cta").html(cta);
	};
	
	
	/**
	 * @desc Init task result/deliverable
	 */
	function initResult(task){
		var hidden='';
		var cta="<div class='cta-block'> <span class='a normal std js-result-clickable'>Cập nhật kết quả công việc</span> hoặc <span class='a normal std relative xo js-result-upload'>upload file</span> &middot; <span class='a normal std relative xo js-drive-result-upload'>upload from Base Drive</span> </div>";
		
		if (!parseInt(task.acl.result)){
			cta="";
		}
		
		var content = Task.ui.getLocalLink(task.result.content);
		if (!content.length && !task.result.files.length){
			hidden='hidden';
			
			if (parseInt(task.acl.result)){
				content="";
			}else{
				content="<div class='li -del -content'>Chưa có cập nhật kết quả công việc</div>";
			}
			
			if (!parseInt(task.acl.result)){
				$("#js-taskresult").hide();
				return;
			}
		}
		
		var disable_percent_completion = '';
		if (!parseInt(Client.tempData.context.percent_completion)){
			disable_percent_completion = "disabled";
		}
		
		var edit_completion="<div class='completion'> <div class='label'>Hoàn thành</div> <input type='text' name='complete' placeholder='Enter %' value='"+(parseInt(task.complete))+"%' "+(disable_percent_completion)+"/> <div class='bar'><div class='b' style='width:"+(task.complete)+"%'></div></div> </div>";
		
		var visual_bar_top="<div class='completion-slider' title='Slide to set task completion'> <div class='completion'>"+(parseInt(task.complete))+"%</div> </div>";
		
		if (!parseInt(task.acl.result)){
			visual_bar_top="<div class='completion-slider' title='Slide to set task completion'> <div class='cur' style='width:"+(task.complete)+"%'></div> <div class='completion'>"+(parseInt(task.complete))+"%</div> </div>";
			
			edit_completion='';
		}
		
		
		if (!parseInt(Client.tempData.context.percent_completion)){
			visual_bar_top='';
		}
		
		
		
		if (parseInt(task.status)==1){
			visual_bar_top="<div class='completion-slider'> <div class='cur' style='width:100%'></div> <div class='completion'>"+(task.complete)+"%</div> </div>";
		}
		
		
		
		
		var html="<div class='top'> "+(visual_bar_top)+" Kết quả công việc </div> <div class='postform "+(hidden)+"'> <div class='textarea -wc-"+(Client.tempData.context.percent_completion)+"'> "+(edit_completion)+" <textarea name='content' rows='5' data-id='"+(task.id)+"' placeholder='Cập nhật kết quả công việc'>"+(Textarea.simple(task.result.content))+"</textarea> </div> <div class='display'><div class='content'>"+(content)+"</div></div> <div class='submit'> <div class='button js-result-save -cta'>Lưu</div> <div class='button js-result-cancel -cancel'>Bỏ qua</div> </div> <div class='files'></div> </div> "+(cta)+" </div>";
		
		$("#js-taskresult").html(html).removeClass("editing");
		
		$("#js-taskresult .files").html(AP.render(task.result.files, function(e){
			var actions="<span class='actions'> <span class='action js-file-remove' title='Xóa file' data-task='"+(task.id)+"' data-id='"+(e.id)+"'><span class='-ap icon-uniF11F'></span></span> <a class='action' title='Download file' target='_blank' href='"+(Base.file.download(e.name, e.fid))+"'><span class='-ap icon-download3'></span></a> </span>";
			
			if (!parseInt(task.acl.result)){
				actions="<span class='actions'> <a class='action' title='Download file' target='_blank' href='"+(Base.file.download(e.name, e.fid))+"'><span class='-ap icon-download3'></span></a> </span>";
			}
			
			return "<div class='li -file pointer'><span class='icon'><span class='-ap icon-uniF10A'></span></span> <span class='name' data-file='"+(e.url)+"'>"+(e.name)+"</span> "+(actions)+" </div>";
		}));
		
		
		if (!parseInt(task.acl.result)){
			return;
		}
		
		// BINDING EVENTS
		
		AP.uploadable("#js-taskresult .js-result-upload", {
			action: "api/task/result.upload",
			name: "file",
			data: {
				id: task.id
			},
			multi: true
		}, function(code){
			if (code.good()){
				initResult(code.task);
			}
		});
		
		
		AP.uploadable("#js-taskresult .js-drive-result-upload", {
			action: "api/task/result.upload",
			name: "file",
			data: {
				id: task.id
			},
			multi: true,
			drive: true
		}, function(code){
			if (code.good()){
				initResult(code.task);
			}
		});
		
		
		$("#js-taskresult .js-file-remove").click(function(){
			var fid=$(this).data("id");
			var id=$(this).data("task");
			AP.confirm("Are you sure that you want to remove this file? It cannot be undone.", function(){
				UI.ajaxShow();
				AP.post("api/task/result.fileremove", {id: id, fid: fid}, function(code){
					UI.ajaxHide();
					if (!code.good()){
						return AP.alertError(code.message)
					}
					
					initResult(code.task);
				});
			});
		});
		
		$("#js-taskresult .js-result-clickable").click(function(){
			$("#js-taskresult").addClass("editing");
			$("#js-taskresult textarea").focus();
		});
		
		$("#js-taskresult .js-result-cancel").click(function(){
			$("#js-taskresult").removeClass("editing");
		});
		
		$("#js-taskresult .js-result-save").click(function(){
			var content=$("#js-taskresult textarea[name=content]").val();
			var complete=$("#js-taskresult input[name=complete]").val();
			
			var id=$("#js-taskresult textarea").data("id");
			
			UI.ajaxShow();
			AP.post("api/task/result.content", {content: content, complete: complete, id: id}, function(code){
				UI.ajaxHide();
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				initResult(code.task);
			});
		});
		
		// Slider
		
		if (!parseInt(task.status)){
			$("#js-taskresult .completion-slider").slider({
				value: parseInt(task.complete),
				range: "min",
				slide: function(event, ui){
					$("#js-taskresult input[name=complete]").val(ui.value+"%");
					$("#js-taskresult .bar .b").css({width: ui.value+"%"});
					$("#js-taskresult .top .completion").html(ui.value+"%");
				},
				stop: function(event, ui){
					$("#js-taskresult").addClass("editing");
					$("#js-taskresult textarea").focus();
					
					$("#js-taskresult input[name=complete]").val(ui.value+"%");
					$("#js-taskresult .bar .b").css({width: ui.value+"%"});
					$("#js-taskresult .top .completion").html(ui.value+"%");
				}
			});
		}
		
		Base.file.previewMultiples("#js-taskresult",".li .name");
		$("#js-taskresult .content").linkify();
	};
	
	
	
	function getFile(e, task){
		var icon=UI.file.ficon(e.name);
		var color=UI.file.color(e.name);
		var icolor=UI.file.iconColor(icon);
		
		var url = (e.trello == 1) ? e.fid : Base.file.download(e.name, e.fid);
		var remove=(parseInt(task.acl.desc)?"<span class='action autohide' onclick=\"Task.file.remove('"+e.id+"');\"><em>Remove</em></span>":"");
		
		if (Base.config.file_preview==1){
			var preview="<div class='preview name' data-file='"+(e.url)+"'> <div class='fname pointer'><div class='txt'>"+(e.name)+"</div></div> <div class='icon-bg' style='background-color:"+(icolor)+"'> <div class='icon'><span class='-ap icon-"+(icon)+"'></span></div> <div class='rname'>"+(e.name)+"</div> </div> </div>";
			
			if (parseInt(e.image) && e.url){
				preview="<div class='preview name' data-file='"+(e.url)+"'> <div class='fname pointer'><div class='txt'>"+(e.name)+"</div></div> <div class='preview-img'><img src='"+(AP.zthumb(e.url))+"'/></div> </div>";
			}
			
			return "<div class='file-preview'> <div class='inner'> "+(preview)+" <div class='actions'> "+(remove)+" <a class='action txt normal' target='_blank' title='Download' href='"+(url)+"'><em>Download</em></a> </div> </div> </div>"
		}
		
		return "<div class='file'> <div class='icon'><span class='-ap icon-"+(icon)+" text-alt"+(color)+"'></span></div> <div class='name pointer' data-file='"+(e.url)+"'>"+(e.name)+"</div> <div class='actions'> "+(remove)+" <a class='action txt normal' target='_blank' title='Download' href='"+(url)+"'><em>Download</em></a> </div> </div>";
	};
	

	/**
	 * @desc Init a list of checklists
	 */
	function initChecklists(task){
		if (!parseInt(task.acl.desc)) {
			$("#js-task-display .task-desc .js-upload").hide();
			$("#js-task-display .task-desc .js-upload-drive").hide();
		}

		if (!parseInt(task.acl.checklist)){
			$("#js-task-display .task-desc .js-checklist").hide();
		}
		
		if (!task.checklists.length){
			$("#js-checklists").hide();
		}

		Checklist.init("#js-checklists", task);
	};
	
	
	
	function initSubtasks(task){
		var html="<div id='js-subtasks-area-"+(task.id)+"'></div>";
		$("#js-subtasks-"+task.id).html(html);
		
		Base.task.embed(task, {
			canvas:"#js-subtasks-area-"+task.id,
			header: 0,
			project_id: task.project_id,
			tasklist_id: false
		});
	};


	this.openTaskNewTab = function(id){
        window.open(Client.url + "/tasks?task=" + id, '_blank');
    };
	
};


var Checklist = new function __CheckList(){
	this.url="api/checklist";
	
	this.init=function(canvas, object){
		var header="";
		if (object.checklists.length > 0){
			header="<div class='checklist-top'>Checklists</div>";
		}
		$("#js-checklists").empty().html("<div class='w-checklists'>"+header+"</div>");
		$("#js-checklists .edit-form input[name=checklist_name]").enter(function(){
			Checklist.submitForm(this);
		});

		if (object.checklists.length > 0) {
			for (var i=0; i<object.checklists.length; i++){
				addChecklist(object.checklists[i], object, canvas);
			}
		}

		// Init sortable
		if (parseInt(object.acl.checklist)){
			$("#js-checklists .w-checklists").sortable({
				helper:'clone',
				handle: ".handler",
				axis: "y",
				stop: function(event, ui){
					var id=$(ui.item).data("id");
					var index=$(ui.item).index();
					Checklist.moveChecklist(id, index, Client.tempData.task);
				}	
			});
			
			// Sortable
			for (var i=0; i<object.checklists.length; i++){
				$("#checklist-"+object.checklists[i].id+" .items").sortable({
					axis: 'y',
					handle: ".move",
					stop: function(event, ui){
						var todo_id=$(ui.item).data("todo");
						var index=$(ui.item).index();
						var checklist_id=$(ui.item).closest(".js-checklist").data("id");
						Checklist.moveChecklistItem(todo_id, index, checklist_id, Client.tempData.task);
					}
				});
			}
			
			$("#js-checklists .w-checklists").disableSelection();
		}
		
		var len=$("#js-checklists .js-checklist").length+1;
		$("#js-checklists").prepend("<div class='edit-form'><form method='post' action='"+this.url+"/list.create'>" +
			"<input type='hidden' name='id' value='"+object.id+"'/>"+
			"<div class='row'>" +
			"	<input type='text' placeholder='Tạo một checklist mới' name='checklist_name' value='Checklist #"+len+"'/>" +
			"</div>" +
			"<div class='row clear-fix'>" +
			"	<div class='button -cta' onclick='Checklist.submitForm(this);'>Thêm checklist</div>" +
			"	<div class='cancel' onclick='Checklist.showForm(this, false);'><span class='-ap icon-close'></span></div>" +
			"</div>" +
		"</form></div>");
		
		$("#js-checklists .edit-form input[name=checklist_name]").enter(function(){
			Checklist.submitForm(this);
		});
	};

	this.edit=function(ref){
		var checklist=$(ref).closest(".js-checklist").data("id");
		var name=$(ref).closest(".js-checklist").data("name");
		var id=Client.tempData.task.id;
		var hiddens={id:id, checklist: checklist};

		var form=Form.create('tree-node-fx',{action: 'api/checklist/list.edit'})
			.row(
				Form.label({label: "Tên checklist"}),
				Form.input({name: 'name', "placeholder":"Tên checklist"}).value(name).autoSubmit()
			)
			.hiddens(hiddens)
			.buttons([
				{label: "Cập nhật tên checklist", action: function(){
					Form.submit("tree-node-fx", function(code){
						if (!code.good()){
							return AP.alertError(code.message);
						}

						Form.hide("tree-node-fx");
						UI.flash("Update successfully ...");
						Task.inline.insertComment(code.comment, code.task);
						$("#checklist-"+code.checklist.id+" .top").html(code.checklist.name);
						$("#checklist-"+code.checklist.id).data('name', code.checklist.name);
					});
				}, style: 'ok -success -rounded bold'},
				{label: "Hủy", action: function(){
					Form.hide("tree-node-fx");
				}, style:'cancel -passive-2 -rounded'}
			]).settings();

		Form.pop({id:'tree-node-fx-dx', width: 400, label: 'Cập nhật tên checklist', layout: 'flat'}).setForm(form).show().focus('name');
	};
	
	
	this.remove=function(ref){
		var checklist=$(ref).closest(".js-checklist").data("id");
		var id=Client.tempData.task.id;
		
		AP.confirm("Bạn có muốn xóa checklist này và các việc tương ứng?", function() {
			AP.post(Checklist.url+"/list.remove", {id: id, checklist: checklist}, function(code){
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				Task.update(code.task, code.comment);
			});
		});	
	};
	
	
	this.moveChecklist=function(checklist_id, index, task){
		UI.ajaxShow();
		AP.post(Checklist.url+"/list.move",{checklist: checklist_id, id: task.id, index: index}, function(code){
			UI.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			Client.tempData.task=code.task;
			TaskDisplay.taskUpdated(code.task, "checklists");
		});
	};
	
	
	this.moveChecklistItem=function(item_id, index, checklist_id, task){
		UI.ajaxShow();
		AP.post(Checklist.url+"/move",{checklist: checklist_id, id: task.id, index: index, todo: item_id}, function(code){
			UI.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			Client.tempData.task=code.task;
			TaskDisplay.taskUpdated(code.task, "checklists");
		});
	};
	
	
	this.move=function(id, prev){
	};
	
	
	
	this.closeInput = function(ref) {
		$(ref).closest(".input").removeClass("focus");
	};
	
	this.submit=function(ref, object){
		var $box=$(ref).closest(".input");
		var name=$box.find("input[name=checklist]").val();
		var status=$box.find("input[name=status]").val();
		
		if (name && name.length){
			UI.ajaxShow();
			
			AP.post(this.url+"/add", {name: name, status: status, id: object.id, token: object.token, checklist: $(ref).closest(".js-checklist").data("id")}, function(code){
				UI.ajaxHide();
				
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				$box.find("input[name=checklist]").val("").focus();
				
				var $canvas=$box.closest(".js-checklist").find(".items");
				$canvas.prepend(getItemHTML(code.item, code.task));
			});
		}
	};
	
	
	
	/**
	 * @desc Toggle check/uncheck item
	 */
	this.toggle=function(ref){
		var $box=$(ref).closest(".item");
		var todo=$box.data("todo");
		var id=$box.data("id");
		var checklist=$box.closest(".js-checklist").data("id");
		
		UI.ajaxShow();
		AP.post(this.url+"/toggle", {id: id, checklist: checklist, todo: todo}, function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			if (parseInt(code.item.status)){
				$box.addClass("-checked");
			}else{
				$box.removeClass("-checked");
			}

			Task.inline.insertComment(code.comment, code.task);
			TaskDisplay.taskUpdated(code.task, "checklists");
		});
	};
	
	
	
	/**
	 * @desc Edit a single item in a checklist
	 */
	this.editItem = function(ref){
		var $box = $(ref).closest(".item");
		var id = $box.data("todo");
		
		var data = {todo: id, checklist: $box.closest(".js-checklist").data("id"), "id": $box.data("id")};
		
		// if (Client.pageData.project.status != 0) {
		//	 return;
		// }
		
		var form = Form.create('fly-proj-editchk-fx',{'action': Checklist.url+"/edit"})
		.row(
			Form.label({label: "Todo"}),
			Form.input({name: 'name', placeholder: "Todo"}).value($box.data("name")).autoSubmit()
		).addClass("-big")
		.buttons([
			 {label: "Lưu thay đổi", action: function(){
				 Form.submit("#fly-proj-editchk-fx", function(code){
					 if (!code.good()){
						 return AP.alertError(code.message);
					 }
					 
					 Form.hide("fly-proj-editchk-fx");
					 
					 UI.flash("Đã sửa checklist");
					 Task.inline.insertComment(code.comment, code.task);
					 $(".js-item-"+id+"").replaceWith(getItemHTML(code.item, code.task));
					 
				 })
			 }, style: 'ok -success -rounded bold'},
			 {label: "Hủy", action: function(){
				 Form.hide("fly-proj-editchk-fx");
			 }, style:'cancel -passive-2 -rounded'}
		]).hiddens(data);
		
		Form.pop({width: 420, label: 'Chỉnh sửa', layout: 'flat'}).setForm(form).show().focus('name');
	};
	
	
	/**
	 * @desc Remove a checklist item
	 */
	this.removeItem = function(ref){
		var $box = $(ref).closest(".item");
		var todo = $box.data("todo");
		var id = $box.data("id");
		var checklist = $box.closest(".js-checklist").data("id");
		
		AP.confirm("Bạn có muốn xóa item này?", function() {
			AP.post(Checklist.url+"/remove", {id: id, todo: todo, checklist: checklist}, function(code){
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				var $canvas = $(ref).closest(".item");
				$canvas.slideUp(300, function(){
					$(this).remove();
				});

				Task.inline.insertComment(code.comment, code.task);
			});
		});
	};
	
	
	this.assignItem=function(task_id, item_id, user, ref){
		var checklist=$(ref).closest(".js-checklist").data("id");
		
		UI.ajaxShow();
		AP.post(Checklist.url+"/assign", {id: task_id, todo: item_id, username: user.username, checklist: checklist}, function(code){
			UI.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			Client.tempData.task=code.task;
			Task.inline.insertComment(code.comment, code.task);
			TaskDisplay.taskUpdated(code.task, "checklists");
		});
	};
	
	
	this.submitForm=function(ref){
		Form.submitFrom(ref, function(code){
			if (!code.good()){
				return AP.alertError(code.message);
			}
			Checklist.init("#js-checklists", code.task);
			UI.flash("Đã thêm checklist");
			Task.inline.insertComment(code.comment, code.task);
			TaskDisplay.taskUpdated(code.task, "checklists");
			$("#js-checklists .checklist:eq(0)").find("input[name=checklist]").focus();
		});
	};
	
	
	this.showForm=function(ref, flag){
		$("#js-checklists").show();
		
		if (flag){
			$("#js-checklists .edit-form").addClass("block");
			$("#js-checklists .edit-form input[name=checklist_name]").focus();
		}
		
		$(ref).closest(".edit-form").removeClass("block");
	};
	
	
	
	this.info=function(checklists){
		var total=0;
		var done=0;
		for (var i=0; i<checklists.length; i++){
			for (var j=0; j<checklists[i].items.length; j++){
				total++;
				if (parseInt(checklists[i].items[j].status)){
					done++;
				}
			}
		}
		
		if (total>0){
			return "<span class='istat' title='Checklist info'><span class='-ap icon-ion-android-checkbox-outline'></span> <em>"+(done)+"/"+(total)+"</em></span>";
		}
	};
	
	
	function addChecklist(checklist, object, canvas){
		$(canvas).find(".w-checklists").append(getHTML(checklist, object));
		
		var $box=$("#checklist-"+checklist.id);
		
		$box.find("input[name=checklist]").enter(function(){
			Checklist.submit(this, object);
		}).on("focus", function(){
			$(this).closest(".input").addClass("focus");
		});
		
		$box.find(".state-icon").click(function(){
			var $input=$(this).closest(".input").find("input[name=status]");
			var val=$input.val();
			if (val==1){
				$input.val(0);
			}else{
				$input.val(1);
			}
			
			checkState($(this).closest(".input"));
		});
		
		$box.find(".submit").click(function(){
			Checklist.submit(this, object);
		});
		
		checkState($box.find(".input"));
		
		$box.find(".items").html(AP.render(checklist.items, function(e){
			return getItemHTML(e, object);
		}));
	};
	
	
	
	
	

	function getHTML(checklist, object){
		var form="<div class='input'>" +
		"	<input type='hidden' name='status' value='0'/>" +
		"	<div class='cta-icon'><span class='-ap icon-plus2'></span></div>" +
		"	<input type='text' name='checklist' placeholder='Create todo, nhấn Enter để gửi'/>" +
		"	<div class='submit'><div>Thêm</div></div>" +
		"	<div class='cancel' title='Huỷ' onclick='Checklist.closeInput(this);'><span class='-ap icon-close'></span></div>" +
		"	<div class='state-icon -infow'>" +
		"		<div class='-infobox -up -w100 unselectable'><div class='-box'>Nhấp để chọn hoặc bỏ chọn</div></div>" +
		"		<span class='icon'></span>" +
		"	</div>" +
		"</div>";
		
		if (!parseInt(object.acl.checklist)){
			form="";
		}
		
		var actions="<div class='action' onclick='Checklist.edit(this);'>Chỉnh sửa</div>" +
		"<div class='action' onclick='Checklist.remove(this);'>Xóa</div>";
		
		if (!parseInt(object.acl.checklist)){
			actions="";
		}
		
		return "<div class='checklist js-checklist' data-name='"+checklist.name+"' id='checklist-"+checklist.id+"' data-id='"+checklist.id+"'>" +
			"<div class='actions'>" + actions + "</div>" +
			"<div class='top'><span class='-ap icon-list2 handler'></span><span class='url' data-url=':collapse:parent:parent'>"+checklist.name+"</span></div>" +
			form +
			"<div class='items relative'></div>" +
		"</div>";
	}
	
	
	
	
	function checkState($box){
		var $input=$box.find("input[name=status]");
		var val=$input.val();
		if (val==1 || val=="1"){
			$box.find(".state-icon").addClass("selected");
		}else{
			$box.find(".state-icon").removeClass("selected");
		}
	};


	function getItemHTML(e, object) {
		var ec = [];
		if (parseInt(e.status)) {
			ec.push("-checked");
		} else {
			ec.push("-unchecked");
		}

		var assign = "<div class='assign url' data-url='action/" + object.id + "/checklist' data-action='assign' data-id='" + e.id + "'>" +
			"<div class='avatar avatar-24'><div class='user-add user6'></div></div>" +
			"</div>";

		if (e.assign) {
			var user = People.get(e.assign);
			if (user) {
				assign = "<div title='" + user.name + " (@" + e.assign + ")" + "' class='assign url' data-url='action/" + object.id + "/checklist' data-action='assign' data-id='" + e.id + "'>" +
					"<div class='avatar avatar-24 -circled'><div class='image'><img src='" + AP.xthumb(user.gavatar) + "'/></div></div>" +
					"</div>";
			}
		}

		return "<div class='item " + ec.join(" ") + " js-item-" + e.id + "' data-todo='" + e.id + "' data-id='" + object.id + "' data-name='" + e.name + "'>" +
			(parseInt(object.acl.checklist) ? "<div class='move'></div>" : "") +
			"<div class='date'>" + AP.time.time("%H:%i %d/%m", e.since) + "</div>" +
			"<div class='-ap opt text-9 text-remove-hover' title='Xoá' data-url='action/" + object.id + "/checklist' data-action='remove' onclick='Checklist.removeItem(this);'><span class='-ap icon-trash'></span></div>" +
			"<div class='-ap opt text-9 text-edit-hover' title='Sửa' data-url='action/" + object.id + "/checklist' data-action='edit' onclick='Checklist.editItem(this);'><span class='-ap icon-mode_edit'></span></div>" +
			assign +
			"<div class='name'>" + e.name + "</div>" +
			"<div class='icon' onclick='Checklist.toggle(this)'></div>" +
			"</div>";
	};
};


var CheckList = Checklist;


var TaskCanvas=new function __TaskCanvas(){
	this.init=function(){
		if (mobile()){
			$(document.body).addClass("xo").animate({scrollTop: 0}, 200);
			return;
		}
		
		var html="<div id='project-task-canvas'> <div id='project-task-scrollable' class='scroll-y forced-scroll'> <div id='task-canvas-wrapper'> <div id='js-project-task'></div> </div> </div> </div>";
		
		if ($("#project-master").length){
			if (!$("#project-task-canvas").length){
				$("#project-master").before(html);
			}else{
				$("#js-project-task").empty();
			}
			
			if (!$("#tasklists").length){
				$("#project-task-canvas").addClass("without-tasklists")	
			}
		}else if ($("#base-canvas").length){
			if (!$("#project-task-canvas").length){
				$("#base-canvas").before(html);
			}else{
				$("#js-project-task").empty().removeClass();
			}
			
			$("#project-task-canvas").addClass("without-tasklists")
		}
		
	
		$("#project-task-canvas").show();
		
		$("#project-master").addClass("showing-task").removeClass("scroll-y");
		$("#base-canvas").addClass("showing-task").removeClass("scroll-y");
		
		$("#tasklists").addClass("scroll-y");
		$("#board-table .main-table tr.ts").removeClass('is-active');
	};
	
	
	
	/**
	 * @desc Event on closing the task preview
	 */
	this.close=function(){
		AP.destroyDialog("#js-task-dialog");
		
		$("#project-task-canvas").hide();
		$("#project-master").removeClass("showing-task");
		
		if (!$("#board-table-wrapper").length || !$("#base-calendar").length){
			$("#project-master").addClass("scroll-y");
		}
		
		$("#base-canvas").removeClass("showing-task");
		$("#tasklists").removeClass("scroll-y");
		
		$(".js-task").removeClass("active")
		$("#board-table .main-table tr.ts").removeClass('is-active');
		
		
		AP.closeDialog("#js-task-dialog");
		
		if (mobile()){
			$(document.body).removeClass("xo");
		}
	};
};


TaskDisplay.side=new function __TaskDisplaySide(){
	this.init=function(){
		Client.tempData.task.assigner=People.get(Client.tempData.task.creator_id);
		
		initSideCanvas(Client.tempData.task);
		initFollowers(Client.tempData.task);
		
		
//		var rem="";
//		if (parseInt(task.deadline)){
//			rem=" &middot; Còn <em>"+AP.time.remain(task.deadline)+"</em>";
//			if (parseInt(task.deadline)<AP.time.beginOfDay(AP.time.now())){
//				rem=" &middot; Qua deadline";
//			}else if (parseInt(task.deadline) == AP.time.beginOfDay(AP.time.now())){
//				rem=" &middot; Hết hạn hôm nay";
//			}
//		}
			
		Comment.showLogs("#js-task-logs", Client.tempData.logs);
		$("#js-project-task .section").on("click", ".title", function(){
			$(this).closest(".section").toggleClass("collapsed");
		});
	}; 
	
	
	
	/**
	 * @desc Side re-render on task update
	 */
	this.update=function(task){
		task.assigner=People.get(task.creator_id);
		
		initSideCanvas(task);
		initFollowers(task);
		
		$("#js-project-task .section").on("click", ".title", function(){
			$(this).closest(".section").toggleClass("collapsed");
		});
	};
	
	
	/**
	 * @desc Display followers
	 */
	function initFollowers(task){
		var followers=AP.render(task.followers, function(e){
			var u=People.get(e.username);
			return "<div class='user'> <div class='avatar avatar-32 -circled url' data-username='"+(e.username)+"'> <div class='image'><img src='"+(AP.xthumb(e.gavatar))+"'/></div> </div> <div class='uname'>"+(u.name)+"</div> <div class='uinfo'>"+(u.title)+"&nbsp;</div> </div>";
		});
		
		var button="<div class='add url' data-url='action/"+(task.id)+"/addfollower'> <span class='icon'></span><div class='txt'>Follower</div> </div>";
		
		if (parseInt(task.acl.managed) || (task.username == Client.viewer.username)){
			button="<div class='add url -follow' data-url='action/"+(task.id)+"/extfollower' data-value=''> <span class='icon'></span><div class='txt' title='Thêm người theo dõi từ hệ thống, bấm thêm một lần nữa để xóa người theo dõi khỏi công việc'>Thêm từ ngoài</div> </div> <div class='add url -follow' data-url='action/"+(task.id)+"/addfollower' data-value=''> <span class='icon'></span><div class='txt' title='Thêm người theo dõi từ dự án này, bấm thêm một lần nữa để xóa người theo dõi khỏi công việc'>Người theo dõi</div> </div>";
		}else{
			if (!Me.isFollower(task)) {
				button = "<div class='add url -follow' data-url='action/" + task.id + "/follow'>" +
					"<span class='icon'></span><div class='txt'>Follow</div>" +
					"</div>";
			} else {
				button = "<div class='add url -unfollow' data-url='action/" + task.id + "/unfollow'>" +
					"<span class='icon'></span><div class='txt'>Unfollow</div>" +
					"</div>";
			}
		}
		
		var html=followers + "<div class='buttons clear-fix'>"+(button)+"</div>";
		
		$("#js-task-display .js-followers").html(html);
	};
	
	
	/**
	 * @desc Init side canvas
	 */
	function initSideCanvas(task){
		var start_cta="<div class='section -fit'> <div class='start'> <div class='icon anim-showhide-inf'><span class='-ap icon-play_circle_filled'></span></div> <div class='label'>Công việc chưa bắt đầu</div> <div class='info'>Công việc đang được giao cho bạn</div> <div class='ctas clear-fix'> <div class='cta url' data-url='action/"+(task.id)+"/startnow' data-acl='"+(task.acl.status)+"'><span class='-ap icon-play_arrow'></span> Bắt đầu ngay</div> <div class='cta-less url' data-url='action/"+(task.id)+"/starttime' data-acl='"+(task.acl.status)+"'>Chọn tgian</div> </div> </div> </div>";
		
		if (parseInt(task.user_id)!=parseInt(Client.viewer.id)){
			start_cta='';
		}else if (parseInt(task.start_time)){
			start_cta="<div class='section -fit'> <div class='start'> <div class='icon'><span class='-ap icon-play_circle_filled'></span></div> <div class='label'>Task is started "+(AP.time.ago(task.start_time))+"</div> <div class='info'>This task is assigned to you</div> </div> </div>";
		}
		
		
		var linking_milestone='';
		
		if (parseInt(task.acl.edit) || parseInt(task.acl.managed)){
			linking_milestone="<div class='section -fit -orange'> <div class='p-msg -orange'> <div class='msg'>Chưa liên kết với mục tiêu</div> <em class='cta url' data-url='action/"+(task.id)+"/milestone' data-acl='"+(task.acl.status)+"'>Lựa chọn mục tiêu <span class='-ap icon-chevron-down2'></span></em> </div> </div>";
			
			if (parseInt(task.milestone_id)){
				var m=Milestone.fromContext(task.milestone_id);
				if (m){
					linking_milestone="<div class='section -fit'> <div class='start'> <div class='icon'><span class='-ap icon-equalizer'></span></div> <div class='label url' data-url='milestone/"+(m.id)+"'>"+(m.name)+"</div> <div class='info url' data-url='action/"+(task.id)+"/milestone'>Click để chọn lại mục tiêu <span class='-ap icon-chevron-down'></span></div> </div> </div>";	
				}
			}
		}
		
		
		var overdue_cta="<div class='section -fit'> <div class='overdue'> <div class='icon anim-showhide-inf'><span class='-ap icon-error'></span></div> <div class='label'>Công việc đã quá hạn</div> <div class='side'>"+(AP.i18n.date(task.deadline))+"</div> </div> </div>";
		
		if (!parseInt(task.deadline) || !Compute.overdue(task)){
			overdue_cta='';
		}
		
		
		if (Compute.lateComplete(task)){
			overdue_cta="<div class='section -fit'> <div class='overdue -late'> <div class='icon'><span class='-ap icon-error'></span></div> <div class='label'>Hoàn thành muộn</div> </div> </div>";
		}
		
		
		if (!parseInt(task.user_id) && parseInt(task.acl.assign)){
			start_cta="<div class='section -fit'> <div class='p-msg'> <span class='msg'>Công việc chưa được giao cho ai <em class='url' data-url='action/"+(task.id)+"/assign' data-acl='"+(task.acl.assign)+"'>Giao ngay?</em></span> </div> </div>";
		}
		
		
		
		
		var info_start_time="<div class='row'> <div class='icon'><span class='ficon-chevron-circle-right'></span></div> <div class='label'>Bắt đầu: <em>"+(AP.i18n.datetime(task.start_time))+"</em></div> </div>";
		
		if (!parseInt(task.start_time)){
			info_start_time='';
		}
		
		
		var info_complete_time="<div class='row'> <div class='icon'><span class='ficon-check-square'></span></div> <div class='label'>HT lúc: <em>"+(AP.i18n.datetime(task.complete_time))+"</em></div> </div>";
		
		if (!parseInt(task.complete_time) || !parseInt(task.status)){
			info_complete_time='';
		}
		
		var info_duration="<div class='row'> <div class='icon'><span class='ficon-fa'></span></div> <div class='label'>TG cho phép: <em>"+(AP.i18n.duration(task.duration))+"</em></div> </div>";
		
		if (!parseInt(task.duration)){
			info_duration='';
		}
		
		var info_complete='';
		var project=Project.inspect();
		
		if (project && parseInt(project.percent_completion) && !parseInt(task.status)){
			info_complete="<div class='row'> <div class='icon'><span class='ficon-check-circle-o'></span></div> <div class='label'>Phần trăm HT: <em>"+(AP.data.numberFormat(task.complete))+"</em>%</span></div> </div>";
		}
		
		var info_deadline="<div class='row'> <div class='icon'><span class='ficon-clock-o'></span></div> <div class='label'>Deadline: <em>"+(AP.i18n.datetime(task.deadline))+"</em></span></div> </div>";
		
		if (!parseInt(task.deadline)){
			info_deadline='';
		}
		
		var infobox="<div class='section'> <div class='exec-rows'> <div class='row'> <div class='icon'><span class='ficon-user-circle-o'></span></div> <div class='label'>TG tạo: <em>"+(AP.i18n.datetime(task.since))+"</em></div> </div> <div class='row'> <div class='icon'><span class='ficon-clock-o'></span></div> <div class='label'>TG cập nhật: <em>"+(AP.i18n.datetime(task.last_update))+"</em></div> </div> "+(info_start_time)+" "+(info_complete_time)+" "+(info_deadline)+" "+(info_duration)+" "+(info_complete)+" </div> </div>";
		

		
		var html=""+(overdue_cta)+" "+(start_cta)+" "+(linking_milestone)+" <div class='section'> <div class='title'>Người giao việc</div> <div class='assigner body'> <div class='user'> <div class='image'><img src='"+(AP.xthumb(task.assigner.gavatar))+"'/></div> <div class='name'>"+(task.assigner.name)+"</div> <div class='info'>"+(task.assigner.title)+"&nbsp;</div> </div> </div> </div> "+(infobox)+" <div class='section' id='js-task-followers'> <div class='title'>Người theo dõi</div> <div class='body followers clear-fix js-followers'></div> </div> <div class='section collapsed'> <div class='title'>Activity logs <div class='side'> <div class='count'></div> </div> </div> <div class='body'> <div id='js-task-logs'></div> </div> </div>"
		;
		
		$("#js-project-task .side-body").html(html);
	};
	
};


Task.calendar=new function __TaskCalendar(){
	this.googleLink = "";
	this.iCalLink = "";
	this.generateGoogleLink = function(title, desc, startStr, endStr) {
		var dates='';
		
		if (!startStr && endStr){
			dates='date='+endStr;
		}else if (!endStr && startStr){
			dates='date='+startStr;
		}else if (startStr && !endStr){
			dates='dates=';
		}else{
			if (startStr && endStr){
				dates='dates='+startStr+"/"+endStr;	
			}
		}
		
		this.googleLink = encodeURI([
			'https://www.google.com/calendar/render',
			'?action=TEMPLATE',
			'&text=' + (title || ''),
			'&'+dates,
			'&details=' + (desc || ''),
			'&sprop=&sprop=name:'
		].join(''));
	};

	this.generateiCalLink = function(title, desc, url, startStr, endStr) {
		this.iCalLink = encodeURI(
			'data:text/calendar;charset=utf8,' + [
				'BEGIN:VCALENDAR',
				'VERSION:2.0',
				'BEGIN:VEVENT',
				'URL:' + url,
				'DTSTART:' + (startStr || ''),
				'DTEND:' + (endStr || ''),
				'SUMMARY:' + (title || ''),
				'DESCRIPTION:' + (desc || ''),
				'LOCATION:',
				'END:VEVENT',
				'END:VCALENDAR'].join('\n')
		);
	};

	this.createLink = function(type) {
		if (type == 'google') {
			AP.toURL(this.googleLink);
		} else {
			window.open(this.iCalLink);
		}
	};
	
	
	this.add = function(id) {
		var task=Task.fromContext(id);
		if (!task){
			return;
		}
		
		var name=task.name;
		var content=task.content;
		var start=parseInt(task.start_time);
		var end=parseInt(task.deadline);
		
		var startTime = new Date(start * 1000);
		var endTime = new Date(end * 1000);

		var startStr = startTime.toISOString().replace(/-|:|\.\d+/g, '');
		var endStr = endTime.toISOString().replace(/-|:|\.\d+/g, '');
		if (!start || !parseInt(start)){
			startStr='';
		}
		
		if (!end || !parseInt(end)){
			endStr='';
		}
		
		this.generateGoogleLink(name, content, startStr, endStr);
		this.generateiCalLink(name, content, startStr, endStr);

		var html="" +
			"<div class='list list-actions -border'>" +
			"<div class='li item unselectable' onclick=\"Task.calendar.createLink('google');\">" +
			"   <div class='-icon -big' style='top: 10px;'><span class='-ap icon-google2'></span></div> Thêm vào lịch google" +
			"</div>" +
			"<div class='li item unselectable' onclick=\"Task.calendar.createLink();\">" +
			"   <div class='-icon -big' style='top: 10px;'><span class='-ap icon-apple'></span></div> Thêm vào iCalendar" +
			"</div>" +
			"</div>";

		AP.customDialog(html, "custom-extcal").width(280).style("-full").show();
	};

};
var Calendar = new function __Calendar(){
	this.endpoint="api/calendar";	
	this.c=null;
	
	this.init=function(canvas, endpoint, render){
		var project = Client.pageData.project;
		var c=new BaseCalendar(canvas, endpoint, render, project);
		if (Query.getInt("ts")){
			c.cur=Query.getInt("ts");
		}

		if (Query.get("q")){
			c.q=Query.get("q");
		}
		
		c.init();
		$(canvas).addClass("__jscalendar").data("calendar", c);
		
		this.c=c;
		return c;
	};
	
	this.get=function(ref){
		return $(ref).closest(".__jscalendar").data("calendar");
	};

	this.displayItem = function(canvas, item){
		if (this.c){
			this.c._displayItem(canvas, item);	
		}
	};

	this.taskCreated=function(task){
		if (!$("#js-calendar").length){
			return;
		}
		
		this.displayItem("#js-calendar", task);
		AP.closeDialog("#js-project-item");
	};

	this.taskUpdated=function(task){
		if (!$("#js-calendar").length){
			return;
		}
		
		$("#js-task-id-"+task.id).remove();
		this.displayItem("#js-calendar", task);
	};

	this.taskDeleted=function(task_id){
		if (!$("#js-calendar").length){
			return;
		}
		
		$("#js-task-id-"+task_id).remove();
		AP.closeDialog("#js-project-item");
	};

	this.add = function(deadline) {
		var project = Client.pageData.project;
		Task.dialog.add(project, null, deadline);
	};

	this.hoverCell = function () {
		$("#js-calendar").on("mouseover",'.js-task-calendar-task-name', function () {
			if ($("#show_task_hover").is(':hidden')) {
				var status = $(this).data("status");
				$("#show_task_hover").removeClass($(this).data("error"));
				$("#show_task_hover").removeClass($(this).data("out_of_date"));
				$("#show_task_hover").removeClass($(this).data("success"));
				$("#show_task_hover").removeClass($(this).data("pending"));

				$("#show_task_hover").addClass(status);

				switch (status) {
					case "error":
						$("#js-calendar .status_name").removeClass("anim-showhide-inf");
						$("#js-calendar .status_name").removeClass("icon-flash");
						$("#js-calendar .status_name").removeClass("icon-check2");
						$("#js-calendar .status_name").removeClass("icon-out_of_date");
						$("#js-calendar .status_name").addClass("icon-close");
						break;
					case "out_of_date":
						$("#js-calendar .status_name").addClass("anim-showhide-inf");
						$("#js-calendar .status_name").removeClass("icon-flash");
						$("#js-calendar .status_name").removeClass("icon-check2");
						$("#js-calendar .status_name").removeClass("icon-close");
						$("#js-calendar .status_name").addClass("icon-out_of_date");
						$("#js-calendar .status_name").addClass("icon-flash");
						break;
					case "success":
						$("#js-calendar .status_name").removeClass("anim-showhide-inf");
						$("#js-calendar .status_name").removeClass("icon-flash");
						$("#js-calendar .status_name").removeClass("icon-close");
						$("#js-calendar .status_name").removeClass("icon-out_of_date");
						$("#js-calendar .status_name").addClass("icon-check2");
						break;
					case "pending":
						$("#js-calendar .status_name").removeClass("icon-close");
						$("#js-calendar .status_name").removeClass("icon-check2");
						$("#js-calendar .status_name").removeClass("icon-out_of_date");
						$("#js-calendar .status_name").addClass("anim-showhide-inf");
						$("#js-calendar .status_name").addClass("icon-flash");
						break;
				}
				var wrap = $("#js-calendar .body").offset();
				var offset = $(this).offset();
				$("#show_task_hover").css("top", offset.top - wrap.top + 35);
				if(offset.left < 250) {
					var screen_width = screen.width;
					$("#show_task_hover").css("right", screen_width  - 650);//offset.left
				} else {
					$("#show_task_hover").css("left", offset.left - wrap.left - 260);
				}

				var id = $(this).data("id");
				var info = [];
				info.name = $(this).data("name");
				info.username = $(this).data("username");
				info.creator_username = $(this).data("creator_username");
				info.deadline = $(this).data("deadline");
				info.since = $(this).data("since");
				setInfoTask(info);
				$("#show_task_hover").show();

			}
		}).on('mouseleave', '.js-task-calendar-task-name', function () {
			$("#show_task_hover").hide();
		});
	};
	
	
	function setInfoTask(info) {
		var creator = __getUserByUsername(info.creator_username);
		if (!creator) {
			var creator = [];
			creator.name = info.creator_username;
			creator.username = info.creator_username;
		}

		var assigner = __getUserByUsername(info.username);
		if (!assigner) {
			var assigner = [];
			assigner.name = info.username;
			assigner.username = info.username;
		}
		var deadline = AP.time.time("%H:%i %d/%m/%Y", info.deadline);
		var create_at = AP.time.time("%H:%i %d/%m/%Y", info.since);
		$("#show_task_hover .t_title").html(info.name);
		$("#show_task_hover .creator .t_name").html(creator.name);
		$("#show_task_hover .creator .t_username").html("(" + creator.username + ")");
		$("#show_task_hover .assigner .t_name").html(assigner.name);
		$("#show_task_hover .assigner .t_username").html("(" + assigner.username + ")");
		$("#show_task_hover .deadline .t_deadline").html(deadline);
		$("#show_task_hover .create_at .t_create_at").html(create_at);
	};
};





function BaseCalendar(canvas, endpoint, render, project){
	this.endpoint=endpoint;
	this.render=render;
	this.cur=AP.time.now();
	this.q="";
	this.canvas=canvas;
	
	this.init=function(){
		var canvas=this.canvas;
		build(this.canvas, this, project);
		
		this.getItems({}, function(items){
			displayItems(canvas, items);
		});
	}
		
	this.next=function(){
		var current_date = new Date((this.cur)*1000);
		var first_day = new Date(current_date.getFullYear(), current_date.getMonth()+1, 1);
		this.cur = first_day.getTime()/1000;
		this.init();
		
		AP.setURLParams({ts: this.cur});
	};
	
	
	this.prev=function(){
		var current_date = new Date((this.cur)*1000);
		var first_day = new Date(current_date.getFullYear(), current_date.getMonth()-1, 1);
		this.cur = first_day.getTime()/1000;
		this.init();
		
		AP.setURLParams({ts: this.cur});
	};
	
	
	this.today=function(){
		this.cur=AP.time.now();
		this.init();
		
		AP.setURLParams({ts: null});
	};
	
	this.getItems=function(options, callback){
		options=$.extend({}, {ts: this.cur, q: this.q}, options);
		UI.ajaxShow();
		AP.post(this.endpoint, options, function(code){
			UI.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			items=code.items.slice(0);
			items.sort(function(e, f){
				return parseInt(e.deadline) - parseInt(f.deadline);
			});
			
			for (var i=0; i<items.length; i++){
				$.log(AP.i18n.date(items[i].deadline));
			}
			
			if (callback){
				callback(items);
			}
		});
	};
	
	
	
	this.getItem=function(id, callback){
		UI.ajaxShow();
		AP.post(this.endpoint, options, function(code){
			UI.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			callback(code.item);
		})
	};
	
	
	this._displayItem=function(canvas, item){
		return displayItem(canvas, item);
	}
	
	
	function displayItems(canvas, items){
		for (var i=0; i<items.length; i++){
			displayItem(canvas, items[i]);
		}
	};
	
	function displayItem(canvas, item){
		var didx=AP.time.time("%d%m%Y", item.deadline);
		var $box=$(canvas).find(".day-"+didx);

		if (!$box.length){
			return;
		}	

		if (item.username) {
			var user=People.get(item.username);
			var img = "<img src='" + AP.xthumb(user.gavatar) + "'>";
		} else {
			var img = "<div class='user-add'></div>";
		}

		var pass = (item.deadline < AP.time.beginOfDay(AP.time.now())) ? 'overdue' : '';
		var done = (item.status == 1) ? 'done' : 'active';
		var me="";
		if (item.username==Client.viewer.username){
			me=" -me";
		}
		var html="<div class='item js-task-calendar "+(me)+" "+(pass)+"  "+(done)+" url' id='js-task-id-"+(item.id)+"' data-url='task/"+(item.id)+"' data-keywords='"+(item.keywords)+"'> <div class='mask full-mask'></div> <div class='user-image'><div class='image imagew' id='user-image-id-"+(item.id)+"'>"+(img)+"</div></div> <div class='text js-task-calendar-task-name' data-since='"+(item.since)+"' data-deadline='"+(item.deadline)+"' data-username='"+(item.username)+"' data-creator_username='"+(item.creator_username)+"' data-name='"+(item.name)+"' data-id='"+(item.id)+"' id='calendar-task-name-"+(item.id)+"'>"+(item.name)+"</div> </div>";

		$box.find(".items").append(html);
	};
	
	
	function build(canvas, calendar, project){
		header(canvas, calendar);
		body(canvas, calendar, project);
	};
	
	
	function header(canvas, calendar){
		$(canvas).find(".days").append("<div class='day'>Thứ hai</div> <div class='day'>Thứ ba</div> <div class='day'>Thứ tư</div> <div class='day'>Thứ năm</div> <div class='day'>Thứ sáu</div> <div class='day'>Thứ bảy</div> <div class='day'>Chủ nhật</div>");
		
		$(canvas).find(".js-cur").html(AP.time.time("%m/%Y", calendar.cur));
		$(canvas).find(".js-today").html(AP.time.time("%h:%i %d/%m/%Y", AP.time.now()));
	};
	
	
	function body(canvas, calendar,project){
		var $c=$(canvas).find(".month");
		$c.empty();
		
		var date=new Date(calendar.cur * 1000);
		
		var first=new Date(date.getFullYear(), date.getMonth(), 1);
		var last=new Date(date.getFullYear(), date.getMonth()+1, 0);
		var now=AP.time.now();
		
		var dow=first.getDay();
		var start=unixTS(first);
		var end=unixTS(last);
		
		if (dow==1){
		}else{
			start=start-(dow-1)*(24*3600);
		}
		
		
		var total_days=Math.floor((end-start)/(24*3600));
		var total_weeks=Math.ceil(total_days/7);
		var h=(100.0/total_weeks);

		for (var i=0; i<total_weeks; i++){
			var w=i;
			var html="";
			for (var j=0; j<7; j++){
				var ec="";
				var ts=start+(i*7+j)*(24*3600);

				if (AP.time.time("%d/%m/%Y", ts)==AP.time.time("%d/%m/%Y", now)){
					ec="-today";
				}else if (AP.time.time("%m/%Y", ts)!=AP.time.time("%m/%Y", unixTS(first))){
					ec="-xm";
				}
				
				html+="<div class='day day-"+(AP.time.time('%d%m%Y', ts))+" "+(ec)+"'> <div class='label'><div class='date'>"+(AP.time.time('%d', ts))+"</div></div> <div class='dmask' onclick='Calendar.add("+(ts)+");'></div> <div class='items'> <div class='dmask' onclick='Calendar.add("+(ts)+");'></div> </div> </div>"; 
				
				//<div style='margin-top: 52px;margin-left: 127px;font-size: 11px'>3 more</div>
			}
			
			$c.append("<div class='week' style='height: "+h+"%'>"+html+"</div>");
		};
		
		$c.find(".items").css("right", -$.sbWidth()).css("overflow-y","scroll");
	};
	
	
	function unixTS(date){
		return Math.floor(date.getTime()/1000);
	};
};
var myCalendar = new function __MyCalendar(){
	this.endpoint="api/calendar/me";
	this.c=null;
	
	this.init=function(canvas, endpoint, render){
		var c=new BaseCalendar(canvas, endpoint, render);
		if (Query.getInt("ts")){
			c.cur=Query.getInt("ts");
		}

		if (Query.get("q")){
			c.q=Query.get("q");
		}
		
		c.init();
		$(canvas).addClass("__jscalendar").data("calendar", c);
		
		this.c=c;
		return c;	
	};
	
	this.get=function(ref){
		return $(ref).closest(".__jscalendar").data("calendar");
	};

	this.taskUpdated=function(task){
		$("#js-calendar #calendar-task-name-"+task.id).html(task.name);
	};

	this.add = function(deadline) {
		Project.pick(function(project){
			Task.dialog.add(project, null, deadline, Client.viewer);
		}, "Select a team/project");
	};
};var Setting=new function __Setting(){
	this.init=function(){
	
	};
	
	
	/**
	 * @desc Quick fix a property
	 */
	this.fix=function(key, value, callback){
		var data={key: key, value: value};
		
		UI.ajaxShow();
		AP.xpost("api/settings/fix", data, function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			
			UI.flash("Update successfully ...");
			if (callback){
				callback();
			}
		});
	};
};



Setting.edit=new function __SettingEdit(){
	this.init=function(){
		initMainForm();
		initPeriod();
		initColorForm();
		initOptions();
		initTeamPrefs();
		Setting.tags.init("#js-edit-tags");
	};	
	
	
	this.initEmailPrefs=function(){
		var project_type = (Client.pageData.context.metatype == 'team') ? 'team' : 'dự án';
		UI.setting("Các thao tác liên quan đến công việc")
		.add({
			title: "Email giao việc (gửi đến người được giao)",
			options: {"yes": "Yes", "no": "No"},
			value: Client.pageData.options.task_assign,
			name: "task_assign",
			url: Client.pageData.context.path+"/api/settings/pref"
		})
		.add({
			 title: "Email khi công việc được chỉnh sửa",
			 options: {"yes": "Yes", "no": "No"},
			 value: Client.pageData.options.task_edit,
			 name: "task_edit",
			 url: Client.pageData.context.path+"/api/settings/pref"
		})
		//
		// .add({
		//	  title: "Email khi công việc quá hạn",
		//	  options: {"yes": "Yes", "no": "No"},
		//	  value: Client.pageData.options.task_overdue,
		//	  name: "task_overdue",
		//	  url: Client.pageData.context.path+"/api/settings/pref"
		// })
		.add({
			title: "Email cho người được giao việc khi trạng thái công việc được cập nhật (doing-done)",
			options: {"yes": "Yes", "no": "No"},
			value: Client.pageData.options.task_status_update,
			name: "task_status_update",
			url: Client.pageData.context.path+"/api/settings/pref"
		})
		.add({
			 title: "Email khi xóa công việc",
			 options: {"yes": "Yes", "no": "No"},
			 value: Client.pageData.options.task_delete,
			 name: "task_delete",
			 url: Client.pageData.context.path+"/api/settings/pref"
		})

		.callback(function(name, value){
			Client.pageData.options[name]=value;
		})
		.showYesNo("#js-proj-settings");

		UI.setting(project_type)
			.add({
				title: "Email khi " +project_type+ " được chỉnh sửa",
				options: {"yes": "Yes", "no": "No"},
				value: Client.pageData.options.project_edit,
				name: "project_edit",
				url: Client.pageData.context.path+"/api/settings/pref"
			})
			.add({
				title: "Email khi xóa " + project_type,
				options: {"yes": "Yes", "no": "No"},
				value: Client.pageData.options.project_delete,
				name: "project_delete",
				url: Client.pageData.context.path+"/api/settings/pref"
			})
			.add({
				title: "Email khi có tài liệu mới",
				options: {"yes": "Yes", "no": "No"},
				value: Client.pageData.options.file_upload,
				name: "file_upload",
				url: Client.pageData.context.path+"/api/settings/pref"
			})
			// .add({
			//	 title: "Email hàng ngày vào buổi sáng để tổng hợp công việc",
			//	 options: {"yes": "Yes", "no": "No"},
			//	 value: Client.pageData.options.reminder_daily,
			//	 name: "reminder_daily",
			//	 url: Client.pageData.context.path+"/api/settings/pref"
			// })
			.callback(function(name, value){
				Client.pageData.options[name]=value;
			})
			.showYesNo("#js-proj-settings-new");

	};
	
	
	
	this.initBGEdit=function(){
		var html="<div class='selections'> <div class='select' data-value='dark'><span class='square -bg-gray'></span> Dark</div> <div class='select' data-value='light'><span class='square -bg-white'></span> Light</div> <div class='select' data-value='color'><span class='square -bg-main'></span> Default color</div> <div class='select' data-value='image'><span class='square -bg-image'></span> Custom image</div> </div> <div class='bg-upload hidden'> <div class='image'></div> <div class='mask'></div> <div class='footer'> <div class='upload' id='js-upload-button'>Upload</div> <div class='cancel'>Remove current background</div> <div class='sliders clear-fix'> <div class='opacity-slider'> Mask darkness <div class='slider js-darkness'></div> </div> <div class='opacity-slider'> Blurriness <div class='slider js-blurry'></div> </div> </div> </div> </div>";
		
		
		$("#js-bg-manager").html(html);
		$("#js-bg-manager .cancel").click(function(){
			removeBackground();
		});
		
		$("#js-bg-manager .selections .select").on("click", function(){
			var val=$(this).data("value");
			setBackgroundType(val);
		});
		
		
		var current_type=Client.pageData.project.bg.type;
		if (!current_type){
			current_type="dark";
		}
		
		if (current_type=='image'){
			$("#js-bg-manager .bg-upload").show();
		}
		
		$("#js-bg-manager .selections .select").each(function(){
			if ($(this).data("value")==current_type){
				$(this).addClass("active");
			}
		});
		
		
		
		var url = Client.pageData.project.bg.url;
		$("#js-bg-manager .bg-upload .image").html("<img src='"+(url)+"'/>");
		AP.uploadable("#js-bg-manager .upload",{
			action: Client.pageData.context.path+"/api/settings/bg.upload",
			name: "file",
			image: 1
		}, function(code){
			UI.flash("Save successfully ...");
			AP.refresh();
		});
		
		
		// Blrry slider
		
		var current_blurry=0;
		if (Client.pageData.project.bg.blurry){
			current_blurry=parseInt(Client.pageData.project.bg.blurry);
		}
		
		var br=(parseInt(current_blurry)*13/60);
		$("#js-bg-manager .image img").css({
			"-webkit-filter": "blur("+br+"px)",
			"filter": "blur("+br+"px)"
		});
		
		$("#js-bg-manager .slider.js-blurry").slider({
			value: current_blurry,
			min: 1,
			range: "min",
			stop: function(event, ui){
				fixBg("blurry", {value: ui.value});
				
				var br=(parseInt(ui.value)*13/60);
				$("#js-bg-manager .image img").css({
					"-webkit-filter": "blur("+br+"px)",
					"filter": "blur("+br+"px)"
				});
			}
		});
		
		
		// Darkness slider
		
		var current_mask=50;
		if (Client.pageData.project.bg.mask){
			current_mask=parseInt(Client.pageData.project.bg.mask);
		}
		
		$("#js-bg-manager .mask").css({
			opacity: parseInt(current_mask)/100
		});
		
		$("#js-bg-manager .slider.js-darkness").slider({
			value: current_mask,
			min: 1,
			range: "min",
			stop: function(event, ui){
				fixBg("mask", {value: ui.value});
				$("#js-bg-manager .mask").css({
					opacity: parseInt(ui.value)/100
				});
			}
		});
	};
	
	

	/**
	 * @desc Remove background image
	 * @return void
	 */
	function removeBackground(){
		AP.confirm("Bạn có muốn xóa ảnh background ?", function(){
			fixBg("bg.remove");
			
			var data={fix:'bg.remove', id: Client.pageData.project.id};
			UI.ajaxShow();
			AP.post("api/settings/bg.fix", data, function(code){
				UI.ajaxHide();
				if (!code.good()){
					return AP.alertError(code.message);
				}
				UI.flash("Đã xóa ảnh background thành công !");
				AP.xRefresh();
			});
		});
	};
		
	
	
	
	
	/**
	 * @desc Set background type
	 * @return void
	 */
	function setBackgroundType(type){
		fixBg("type", {value: type});
	};
	
	
	
	function fixBg(key, data){
		if (!data){
			data={};
		}
		
		data.id=Client.pageData.project.id;
		data.fix=key;
		
		UI.ajaxShow();
		AP.post("api/settings/bg.fix", data, function(code){
			UI.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			UI.flash("Update successfully ...");
			Client.pageData.project.bg=code.bg;
			Setting.edit.initBGEdit();
		});
	};
	
	
	
	function initMainForm(){
		$("#js-edit-form").find("input, select, textarea, .trumbowyg-box").click(function(){
			$("#js-edit-form").addClass("editing");
		});
		
		$("#js-edit-form").find(".on-edit .button.-cta").click(function(){
			Form.submitFrom(this, function(code){
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				UI.flash("Update successfully");
				AP.refresh();
			});
		});
		
		
		// Edit department
		$("#js-edit-dept-form").find(".on-edit .button.-cta").click(function(){
			Form.submitFrom(this, function(code){
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				UI.flash("Update successfully");
				AP.refresh();
			});
		});
		
		$("#js-edit-dept-form").preventAutoSubmit();
		
		
		$("#js-edit-form").find(".on-edit .button.-cancel").click(function(){
			$("#js-edit-form").removeClass("editing");
		});
		
		$("#js-edit-form select[name=review]").on("change", function(){
			var v=$(this).val();
			if (parseInt(v)){
				$("#js-edit-form .js-review").show();				
			}else{
				$("#js-edit-form .js-review").hide();
			}
		}).change();
	};
	
	
	function initColorForm(){
		$("#js-edit-colors").html(AP.render(range(0,10), function(e){
			return "<div class='color -bg-alt"+e+"' data-color='"+e+"'></div>";
		}));
		
		$("#js-edit-colors .color").click(function(){
			var $this=$(this);
			$(this).siblings().removeClass("active");
			$(this).addClass("active");
			
			Setting.fix("color", $(this).data("color"));
		});
		
		
		$("#js-edit-colors .color").each(function(){
			var color=$(this).data("color");
			if (parseInt(color)==parseInt(Client.pageData.context.color)){
				$(this).addClass("active");
			}
		})
	};
	
	
	function initPeriod(){
		
		var html="<span class='a'>Đặt thời gian bắt đầu và kết thúc dự án</em>";
		if (parseInt(Client.pageData.context.stime)){
			html="<span class='pointer'><span class='-ap icon-uniF1072 ap-f16'></span> &nbsp; <em>"+AP.i18n.date(Client.pageData.context.stime)+"</em> - <em>"+AP.i18n.date(Client.pageData.context.etime)+"</em></span>";
		}
		
		$("#js-project-period").html(html).click(function(){
			Project.manage.fixTime();
		});
	};
	
	
	
	function initOptions(){
		var opts={"list": "List view (default)", "table": "Table view with Gantt","board": "Board (kanban) view"};
		if (Client.pageData.context.metatype=="team"){
			opts={"list": "Stream view (default)", "period": "Period view (weekly or monthly)","board": "Board (kanban) view"};
		}
		if (Client.pageData.context.metatype=="private"){
			opts={"list": "Stream view (default)", "period": "Period view (weekly or monthly)","board": "Board (kanban) view"};
		}
		
		UI.setting("System settings")
		.add({
			title: "Default view",
			options: opts,
			value: Client.pageData.options.view,
			name: "view",
			url: Client.pageData.context.path+"/api/settings/pref"
		})
		.show("#js-proj-settings");
	  
	};
	
	
	
	function initTeamPrefs(){
		if (!$("#js-team-prefs").length){
			return;
		}
		
		$("#js-team-prefs select[name=team_stack]").val(Client.pageData.options.team_stack).on("change", function(){
			Setting.fix("team_stack", $(this).val());
		});
	};
	

};


Setting.tags=new function __SettingTags(){
	this.init=function(canvas){
		var context=Client.pageData.context;
		buildList();
		
		$(canvas).find("form").attr("action", context.path+"/api/settings/tags/edit");
		Form.inlineColorTagger($(canvas).find(".tag-add .square"),function(color){
			$(this).closest("form").find("input[name=color]").val(color);
			$(this).closest("form").find("input[name=name]").focus();
			$(this).closest(".square").find("em").removeClass().addClass("-bg-alt"+color);
		},{
			width: 200,
			left: 0
		}); 
		
		$(canvas).find(".tag-add .square em").click(function(){
			$(this).parent().find(".ap-inline-colors").toggle();
		});
		
		
		$(canvas).find(".ip input").click(function(){
			$(this).closest(".tag-add").addClass("active");
		}).enter(function(){
			updateTag(this);
		});
		
		$(canvas).find(".submit").click(function(){
			updateTag(this);
		})
	};
	
	
	this.remove=function(tag){
		AP.confirm("Remove this tag from the list?", function(){
			var context=Client.pageData.context;
			AP.xpost("api/settings/tags/remove",{name: tag}, function(code){
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				Client.pageData.context.tags=code.tags;
				buildList();
				setForm("", "auto");
			});
		});
	};
	
	
	function updateTag(ref){
		Form.submitFrom(ref, function(code){
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			Client.pageData.context.tags=code.tags;
			buildList();
			setForm("", "auto");
		});
	};
	
	
	function buildList(){
		$("#js-edit-tags").find(".list").html(AP.render(Client.pageData.context.tags, function(e){
			return "<div class='tag -bg-alt"+e.color+"-less text-alt"+e.color+"' data-key='"+e.key+"' data-name='"+e.name+"' data-color='"+e.color+"'>" +
				"<div class='square -bg-alt"+e.color+"'></div> " +
				"<span class='js-name name pointer'>"+e.name+"</span>" +
				"<div class='remove' title='Remove this tag'><span class='-ap icon-close'></span></div>"+
			"</div>";
		}));
		
		$("#js-edit-tags").find(".list .remove").click(function(){
			var key=$(this).closest(".tag").data("key");
			Setting.tags.remove(key);
		});
		
		$("#js-edit-tags").find(".list .js-name").click(function(){
			var key=$(this).closest(".tag").data("key");
			var name=$(this).closest(".tag").data("name");
			var color=$(this).closest(".tag").data("color");
			setForm(name, color);
		});
	};
	
	
	function setForm(name, color){
		if (color && AP.data.isInt(color)){
			$("#js-edit-tags .tag-add input[name=color]").val(color);
			Form.inlineColorTagger("#js-edit-tags .tag-add .square", "set", color);
			$("#js-edit-tags .tag-add .square em").removeClass().addClass("-bg-alt"+color);
		}
		
		$("#js-edit-tags .tag-add input[name=name]").val(name).click();
		setTimeout(function(){
			$("#js-edit-tags .tag-add input[name=name]").focus();
		}, 200);
		
	};
	
};
var Tool=new function __Tool(){
	
};



Tool.importer=new function __ToolImporter(){
	this.submit=function(ref){
		Form.submitFrom(ref, function(code){
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			AP.alertSuccess("Import successfully!", function(){
				AP.redirect(Client.pageData.context.path+"/home");
			});
		},{
			
		})
	};
	
	
	
	this.bindTemplates=function(canvas){
		$(canvas).html(AP.render(Client.pageData.templates, function(e){
			return "<div class='item'>" +
				"<div class='icon'><span class='-ap icon-file-empty'></span></div>" +
				"<div class='name'>"+e.name+"</div>" +
				"<div class='info'>"+e.file+"</div>" +
				"<div class='side'>" +
				"	<div class='b preview url' data-blank='1' data-url='"+Client.static_url+"/samples/"+e.file+"'>Preview</div>" +
				"	<div class='b submit' data-file='"+e.file+"'>Import</div>" +
				"</div>" +
			"</div>";
		}));
		
		$(canvas).find(".submit").click(function(){
			var file=$(this).data("file");
			AP.confirm("Xác nhận import công việc từ file này?", function(){
				AP.xpost("api/settings/import/local",{file: file},function(code){
					if (!code.good()){
						return AP.alertError(code.message);
					}
					
					AP.alertSuccess("Import successfully!", function(){
						AP.redirect(Client.pageData.context.path+"/home");
					});
					
				})
			});
		});
	};
	
};



FormBuilder = new function __FormBuilder(){
	this.options={};
	
	this.obj=null;
	var lock=false;
	
	this.init=function(){
		this.options={
			url: Client.pageData.context.path+"/api/settings/form/fields",
			custom: Client.pageData.context.path+"/api/settings/form/custom"
		};
		
		showFields();
		this.obj=Client.pageData.context;
		
		$("#custom-form .item.real").each(function(){
			$(this).find(".switch").on("click mouseup",function(){
				if (lock){
					return
				}
				
				lock=true;
				var enabled=getEnabled(this);
				
				if (enabled){
					$(this).removeClass("-on").addClass("-off");
					$(this).parent().find(".st").html("Disabled");
					setEnabled(this, 0);
				}else{
					$(this).removeClass("-off").addClass("-on");
					$(this).parent().find(".st").html("<em class='text-success'>Enabled</em>");
					setEnabled(this, 1);
				}
			});
			
			$(this).find(".checkbox").click(function(){
				var enabled=getRequired(this);
				if (enabled){
					$(this).parent().find(".ip-required").val(0);
					setRequired(this, 0);
				}else{
					$(this).parent().find(".ip-required").val(1);
					setRequired(this, 1);
				}
			});
		});
		
		
		$("#custom-form .item").addClass("first");

		AP.dnd("#setting", "api/settings/form/custom/dnd", {
			id: this.obj.id,
			multi: 0
		}, function(code){
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			UI.flash("UPDATE_SUCCESSFULLY");
			AP.refresh();
		},{
			accept: "xls, xlsx"
		});
	};
	
	
	this.remove=function(ref){
		AP.confirm("Bạn có muốn xóa custom field này ?", function(){
			var name=$(ref).closest(".item").data("id");
			UI.ajaxShow();
            var project_id = Client.pageData.project.id;
			AP.post(FormBuilder.options.custom+"/remove", {
				obj: FormBuilder.obj.id,
				name: name,
                project_id: project_id
			}, function(code){
				UI.ajaxHide();
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				UI.flash("Content removed ...");
				$(ref).closest(".item").slideUp(300, function(){
					$(this).remove();
				});
			});
		});
	};
	
	
	this.move=function(ref, dir){
		var name=$(ref).closest(".item").data("id");
		UI.ajaxShow();
		AP.post(FormBuilder.options.custom+"/move", {
			obj: FormBuilder.obj.id,
			name: name,
			dir: dir
		}, function(code){
			UI.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			UI.flash("Content updated ...");
			$(ref).closest(".item").move(dir, true);
		});
	};
	
	
	this.edit=function(ref){
		var id=$(ref).closest(".item").data("id");
		var item=AP.array.find(Client.pageData.form.customs, function(e){
			return e.id==id;
		});
		if (!item){
			return;
		}
	
		
		FormBuilder.custom.edit(item);
	};


	this.editKey=function(ref){
		var id=$(ref).closest(".item").data("id");
		var item=AP.array.find(Client.pageData.form.customs, function(e){
			return e.id==id;
		});
		if (!item){
			return;
		}
		
		FormBuilder.custom.editKey(item);
	};

	
	function showFields(){
		$("#js-fields").html(AP.render(Client.pageData.form.rows, function(e){
			if (e.id=="cv" || e.id=="phone" || e.id=="title"){
				return "";
			}
			return getRowHTML(e);
		}));
		
		
		$("#js-base-fields").html(AP.render(Client.pageData.form.rows, function(e){
			if (e.id=="cv" || e.id=="phone" || e.id=="title"){
				return getRowHTML(e);
			}
			
			return "";
		}));
		
		
		$("#js-custom-forms").html(AP.render(Client.pageData.form.customs, function(e){
			return getRowHTML(e, true);
		}));
		
		
		$("#custom-form .item.real").each(function(){
			var required=parseInt($(this).data("required"));
			var enabled=parseInt($(this).data("enabled"));
			
			if (enabled){
				$(this).find(".ip-enabled").val(1);
				$(this).find(".switch").removeClass("-off").addClass("-on");
				$(this).find(".st").html("<em class='text-success'>Show on home</em>");
			}
			
			if (required){
				$(this).find(".ip-required").val(1);
				$(this).find(".checkbox").addClass("checked");
			}
		});
	};
	
	
	
	function getEnabled(ref){
		var val=$(ref).closest(".item").find(".ip-enabled").val();
		if (val && parseInt(val)){
			return 1;
		}
		
		return 0;
	};
	
	function setEnabled(ref, val){
		$(ref).closest(".item").find(".ip-enabled").val(val);
		var name=$(ref).closest(".item").data("id");
		
		UI.ajaxShow();
		AP.post(FormBuilder.options.url+"/set", {
			obj: Client.pageData.context.id,
			name: name,
			type: "enabled",
			value: val
		}, function(code){
			lock=false;
			UI.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			UI.flash("Content saved ...");
		});
	};
	
	
	function getRequired(ref){
		var val=parseInt($(ref).closest(".item").find(".ip-required").val());
		if (val){
			return 1;
		}
		
		return 0;
	};
	
	
	function setRequired(ref, val){
		if (val==1){
			$(ref).addClass("checked");
		}else{
			$(ref).removeClass("checked");
		}
		
		
		var name=$(ref).closest(".item").data("id");
		
		UI.ajaxShow();
		AP.post(FormBuilder.options.url+"/set", {
			obj: Client.pageData.context.id,
			name: name,
			type: "required",
			value: val
		}, function(code){
			UI.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			UI.flash("Content saved ...");
		});
	};
	
	
	
	
	function getRowHTML(e, custom){
		var actions="";
		if (custom){
			actions="<div class='actions'>" +
				"<span class='-ap icon-uniF116' title='Edit input' onclick='FormBuilder.edit(this);'></span> &nbsp; " +
				"<span class='-ap icon-uniF12A' title='Edit input key' onclick='FormBuilder.editKey(this);'></span> &nbsp; " +
				"<span class='-ap icon-close' onclick=\"FormBuilder.remove(this);\"></span> &nbsp; " +
				"<span class='-ap icon-chevron-thin-up' onclick=\"FormBuilder.move(this, 'up');\"></span> &nbsp; " +
				"<span class='-ap icon-chevron-thin-down' onclick=\"FormBuilder.move(this, 'down');\"></span>" +
			"</div>";
		}
		
		return "<div class='item real' data-id='"+e.id+"' data-enabled='"+e.enabled+"' data-required='"+e.required+"'>"+
			"<input type='hidden' class='ip-enabled' name='"+e.id+"-enabled' value='0'/>" +
			"<input type='hidden' class='ip-required' name='"+e.id+"-required' value='0'/>" +
			"<div class='checkbox'>"+
				"<div class='checkbox-icon'></div>"+
				"<div class='label'>Required?</div>"+
			"</div>"+
			"<div class='label'>"+e.name+"</div>"+
			"<div class='type'>"+FormBuilder.type.display(e.type)+"</div>"+
			actions + 
			"<div class='switch -off'></div>"+
			"<div class='st'>Do not show</div>"+
		"</div>";
	};
};



FormBuilder.custom=new function __FormBuilderCustom(){
	this.add=function(ref, callback){
		var data={id: Client.pageData.context.id, token: Client.pageData.context.token};
        
		var form=Form.create('custom-question-fx',{'action': Client.pageData.context.path+"/api/settings/form/custom/add"})
		.row(
		    Form.label({label: "Loại dữ liệu đầu vào *"}),
		    Form.input({name: 'metatype', type:'select', options: questionTypes()})
		).addClass("-big required")
		.row(
		    Form.label({label: "Tên trường dữ liệu *"}),
		    Form.input({name: 'name', type:"text", placeholder:"Tên trường dữ liệu *"})
		).addClass("-big required")
		.row(
		    Form.label({label: "Giải thích hoặc hướng dẫn thêm về câu hỏi"}),
		    Form.input({name: 'content', type:'text', placeholder:"Giải thích thêm (không bắt buộc)"})
		)
		.rowHidden(
		    Form.label({label: "Các lựa chọn, cách nhau bởi dấu phẩy hoặc chấm phẩy *"}),
		    Form.input({name: 'options', type:'text'})
		)
		.rowHidden(
		    Form.label({label: "{{js.field.required|Bắt buộc trả lời?}}"}),
		    Form.input({name: 'required', type:'select', options: requiredOptions()})
		)
		.buttons([
             {label: "Thêm trường mới", action: function(){
                 Form.submit("#custom-question-fx", function(code){
                     if (!code.good()){
                         return AP.alertError(code.message);
                     }
                     
                     Form.hide("custom-question-fx");     
                     UI.flash("Question created ...");
                     
                     if (callback){
                    	 callback(code.row);
                     }else{
                    	 AP.xRefresh();
                     }
                     
                 })
             }, style: 'ok -success -rounded bold'},
             {label: "Hủy bỏ", action: function(){
                 Form.hide("custom-question-fx");
             }, style:'cancel -passive-2 -rounded'}
        ])
        .hiddens(data)
		.render(function(form){
			form.find("metatype").on("change", function(){
				var val=$(this).val();
				if (val=="select" || val=="select-m"){
					form.findRow("options").show();
				}else{
					form.findRow("options").hide();
				}
			})
		});
		    
		Form.pop({width: 480, label: 'Thêm trường dữ liệu', layout: "flat", closable: false}).setForm(form).show().focus('name');
	};
	
	
	
	
	this.edit=function(obj, callback){
		var project_id = Client.pageData.project.id
		var data={id: obj.id, project_id: project_id};
        var options="";
        if (obj.options && AP.data.isArray(obj.options)){
        	options=obj.options.join(", ");
        }
        
		var form=Form.create('custom-question-fx',{'action': "api/settings/form/custom/edit"})
		.row(
		    Form.label({label: "Loại dữ liệu đầu vào *"}),
		    Form.input({name: 'metatype', type:'select', options: questionTypes()}).value(obj.type)
		)
		.row(
		    Form.label({label: "Tên trường dữ liệu *"}),
		    Form.input({name: 'name', type:"text", placeholder:"Tên trường dữ liệu"}).value(obj.name)
		).addClass("-big required")
		.row(
		    Form.label({label: "Mô tả trường dữ liệu"}),
		    Form.input({name: 'content', type:'text'}).value(obj.placeholder)
		)
		.rowHidden(
			Form.label({label: "Các lựa chọn, cách nhau bởi dấu phẩy hoặc chấm phẩy *"}),
			Form.input({name: 'options', type:'text'}).value(obj.options)
		)
		.rowHidden(
			Form.label({label: "{{js.field.required|Bắt buộc trả lời?}}"}),
			Form.input({name: 'required', type:'select', options: requiredOptions()})
		)
		.buttons([
             {label: "Chỉnh sửa trường dữ liệu", action: function(){
                 Form.submit("#custom-question-fx", function(code){
                     if (!code.good()){
                         return AP.alertError(code.message);
                     }
                     
                     Form.hide("custom-question-fx");     
                     UI.flash("Trường dữ liệu đã được cập nhật ...");
                     
                     if (callback){
                    	 callback(code.row);
                     }else{
                    	 AP.xRefresh();
                     }
                     
                 })
             }, style: 'ok -success -rounded bold'},
             {label: "Hủy bỏ", action: function(){
                 Form.hide("custom-question-fx");
             }, style:'cancel -passive-2 -rounded'}
        ])
        .hiddens(data)
		.render(function(form){
			form.find("metatype").on("change", function(){
				var val=$(this).val();
				if (val=="select" || val=="select-m"){
					form.findRow("options").show();
				}else{
					form.findRow("options").hide();
				}
			}).change();
		});
		    
		Form.pop({width: 600, label: 'Chỉnh sửa trường dữ liệu', layout: "flat", closable: false}).setForm(form).show().focus('name');
	};



	this.editKey=function(obj, callback){
		var data={id: Client.pageData.project.id, token: Client.pageData.project.token, item: obj.id};
		var options="";
		if (obj.options && AP.data.isArray(obj.options)){
			options=obj.options.join(", ");
		}
		
		var form=Form.create('custom-question-fx',{'action': FormBuilder.options.custom+"/edit.key"})
		.row(
			Form.label({label: "Tên trường dữ liệu *"}),
			Form.input({name: 'name', type:"fake", placeholder:"Tên trường dữ liệu"}).value(obj.name)
		)
		.row(
			Form.label({label: "Mã trường dữ liệu *"}),
			Form.input({name: 'row_key', type:'text', placeholder:"Mã trường dữ liệu"}).value(obj.id)
		)
		.buttons([
			 {label: "Hoàn thành", action: function(){
				 Form.submit("#custom-question-fx", function(code){
					 if (!code.good()){
						 return AP.alertError(code.message);
					 }
					 
					 Form.hide("custom-question-fx");	 
					 UI.flash("Form edited ...");
					 
					 if (callback){
						 callback(code.row);
					 }else{
						 AP.xRefresh();
					 }
					 
				 })
			 }, style: 'ok -success -rounded bold'},
			 {label: "Hủy bỏ", action: function(){
				 Form.hide("custom-question-fx");
			 }, style:'cancel -passive-2 -rounded'}
		])
		.hiddens(data)
		.render(function(form){
		});
			
		Form.pop({width: 400, label: 'Chỉnh sửa mã input', layout: "flat", closable: false}).setForm(form).show().focus('row_key');
	};
	
	
	function questionTypes(){
		return [
		        {value: "text", "label":"Text (single-line)"},
		        {value: "textarea", "label":"Long text (multi-line)"},
            	{value: "int", "label":"Số (number)"},
            	{value: "float", "label":"Số thực (thập phân)"},
		        {value: "date", "label":"Ngày (date)"},
		        {value: "datetime", "label":"Ngày giờ (datetime)"},
		        {value: "checkbox", "label":"Checkbox"},
		        // {value: "attachment", "label":"Attachments (files)"},
		        {value: "select", "label":"Dropdown list (single answer)"}
	//	        {value: "select-m", "label":"Dropdown list (multi answers)"}
		       ]; 
	};
	
	
	function requiredOptions(){
		return [{value: "0", label: "No / Không bắt buộc"}, {value: 1, label: "Yes / Bắt buộc ứng viên trả lời"}];
	};
	
};


FormBuilder.type=new function __FormBuilderType(){
	this.display=function(type){
		return "<div class='ftype -bg-alt"+UI.str2int(type)+"-less'>"+type+"</div>";
	};
	
	
	this.icon=function(type){
		
	};
	
};
var ACL=new function __ACL(){
	this.display=function(){
	};
	
	this.config=function(opts){
		
		var canvas=opts.canvas;
		var roles=opts.roles;
		var headers=opts.headers;
		var rows=opts.rows;
		var key=opts.key;
		
		
		var html="<tr class='acl-header'>" +
			"<th>Phân quyền</th>" +
			AP.render(headers, function(e){
				return "<th style='width:110px'>"+e.name+"</th>";	
			}) +
		"</tr>";

		for (var i=0; i<rows.length; i++){
			var row=rows[i];
			
			html+=getHTML(row, key);
		}


		$(canvas).find("table").html(html);
		
		$(canvas).find(".js-acl-atom").click(function(){
			var $this=$(this);
			if ($this.hasClass("locked")){
				return;
			}
			
			ACL.setRole($(this).data("role"), $(this).data("priv"), $(this).data("key"), function(code){
				if (parseInt(code.status)){
					$this.addClass("-on");
				}else{
					$this.removeClass("-on");
				}
			});
		});
	};
	
	
	/**
	 * @desc Check if $role has permission to do $fn
	 */
	this.on=function(role, fn){
		
	};
	
	
	this.setRole=function(role, priv, key, callback){
		var data={role: role, priv: priv, key: key};
		
		UI.ajaxShow();
		AP.xpost("api/acl/switch", data, function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			
			UI.flash("Update successfully ...");
			if (callback){
				callback(code);
			}
		});
	};
	
	
	function getHTML(row, key){
		return "<tr class='field' data-name='"+row.key+"'>" +
			"	<td class='role'>" +
			"		<div class='role-name'>"+row.label+"</div>" +
			"		<div class='role-info'>"+row.sublabel+"</div>" +
			"	</td>" +
			getPrivs(row, key)+
			"</tr>";
	};
	
	
	function getPrivs(row, key){
		return AP.render(row.privs, function(e){
			if (parseInt(e.value)){
				return "<td><div class='status -on js-acl-atom' data-key='"+key+"' data-role='"+e.key+"' data-priv='"+row.key+"'></div></td>";
			}
			
			return "<td><div class='status -off js-acl-atom' data-key='"+key+"' data-role='"+e.key+"' data-priv='"+row.key+"'></div></td>";
		});
	};
	
	
};var Wework=new function __Wework(){
};



Wework.projects = new function __WeWorkProjects(){
	this.filter = "all";
	this.stagefilter = "all";
	this.default_view="table";
	
	this.initTabs = function () {
		this.filter = "all";

		$("#collection .header .side .icon").click(function () {
			var view = $(this).data("view");
			AP.log.setValue("projects_view", view);
			Wework.projects.display();
			
			$(this).siblings().removeClass("active");
			$(this).addClass("active");
		}).each(function () {
			var view = $(this).data("view");
			var cview = AP.log.getValue("projects_view");
			
			if (!cview) {
				cview = Wework.projects.default_view;
			}

			if (view == cview) {
				$(this).addClass("active");
			} else {
				$(this).removeClass("active");
			}
		});


		$("#js-plist-filter .li").click(function () {
			$(this).addClass("active");
			$(this).siblings().removeClass("active");
			$("#js-plist-filter").removeClass("active");

			Wework.projects.filter = $(this).data("filter");
			Wework.projects.refilter();
		});

		$("#js-plist-stage-filter .li").click(function () {
			$(this).addClass("active");
			$(this).siblings().removeClass("active");
			$("#js-plist-stage-filter").removeClass("active");

			Wework.projects.stagefilter = $(this).data("filter");
			Wework.projects.refilter();
		});

	};


	this.display = function (type) {
		$("#collection .projects").empty();
		$("#collection .table").empty();

		var projects = Client.pageData.projects;

		var view = AP.log.getValue("projects_view");
		if (mobile()){
			view = "card";
		}else if (!view){
			view=this.default_view;
		}
		
		if (Client.pageData.dept){
			view="table";
		}

		if (view == "card"){
			for (var i = 0; i < projects.length; i++) {
				var html = getHTML(projects[i]);
				$(html).appendTo("#collection .projects");
			}
			
			$("#collection .projects").show();
		}else{
			$("#collection .projects").hide();
			var groups = projects;

			var html = "";
			for (var i = 0; i < groups.length; i++) {
				if (groups[i].type && groups[i].type == "category") {
					html += "<tr><td colspan='8' class='category'> <div class='name'><span class='-ap icon-triangle-right'></span>&nbsp; <span class='name'>" + groups[i].name + "</span></div></td></tr>";
				} else {
					html += getListHTML(groups[i], view);
				}
			}

			$("#collection .table").html("<table>" + getHeader(type, view) + html + "</table>");
		}

		this.refilter();

		$("#collection .js-complete-sektor").each(function () {
			$(this).angular({
				bg:"#e5e5e5",
				arc: false
			});
		});
		
		// Fixing orders
		$("#collection tbody").sortable({
			items: ".js-project",
			helper: 'clone',
			axis: 'y',
			handle: ".rx",
			forcePlaceholderSize: true,
			start: function(event, ui){
				$(ui.helper).addClass("tr-dragging");
			},
			over: function(event, ui){
				// Setting order	
			},
			stop: function(event, ui){
				var project_id=$(ui.item).data("id");
				var index=$(ui.item).index();
				setPosition(project_id, index);
			}
		});
	};


	this.refilter = function () {
		$("#collection .js-project").each(function () {
			var status = parseInt($(this).data("status"));
			var stage = $(this).data("stage");
			var okay = false;
			if (status == 0 && Wework.projects.filter == 'active') {
				okay = true;
			}

			if (status == 0 && Wework.projects.filter == 'running') {
				okay = true;
			}

			if (status == -1 && Wework.projects.filter == 'closed') {
				okay = true;
			}

			if (okay || Wework.projects.filter == "all") {
				// continue filtering by stage
				if (Wework.projects.stagefilter == "all") {
					$(this).show();
				} else {
					if (stage.indexOf(Wework.projects.stagefilter) !== -1) {
						$(this).show();
					} else {
						$(this).hide();
					}
				}
			} else {
				$(this).hide();
			}
		});


		if (Wework.projects.filter == "all") {
			$('#js-current-filter-tags .js-filter-tag').addClass("hidden");
			if (Wework.projects.stagefilter == "all") {
				$('#js-current-filter-tags').addClass("hidden");
				$('#js-current-filter-tags .js-stagefilter-tag').addClass("hidden");
			} else {
				$('#js-current-filter-tags').removeClass("hidden");
				$('#js-current-filter-tags .js-stagefilter-tag').removeClass("hidden").html(Wework.projects.stagefilter);
			}
		} else {
			$('#js-current-filter-tags').removeClass("hidden");
			$('#js-current-filter-tags .js-filter-tag').removeClass("hidden").html(Wework.projects.filter);
			if (Wework.projects.stagefilter == "all") {
				$('#js-current-filter-tags .js-stagefilter-tag').addClass("hidden");
			} else {
				$('#js-current-filter-tags .js-stagefilter-tag').removeClass("hidden").html(Wework.projects.stagefilter);
			}
		}
	};


	this.quickFilter = function () {
		var delay_timer=0;
		$("#js-side-psearch").on("input",function(){
			var $this = $(this);
			clearTimeout(delay_timer);
			
			delay_timer = setTimeout(function(){
				var q=$this.val();
				executeFilter(q);
			}, 300);
		});
	};


	function executeFilter(q){
			if (!q){
				q="";
			}
			
			q=$.trim(q).toLowerCase();
			q=purifyStrict(q);
			$.log(q);
			
			$("#list-project .ui-sortable .js-project").each(function(){
				if (!q){
					if ($(this).hasClass("search_hidden")){
						$(this).removeClass('search_hidden');
					}

				}else{
					if (matched(this, q)){
						$(this).removeClass("search_hidden");
					}else{
						$(this).addClass("search_hidden");
					}
				}
			});
	};


	function matched(elem, q) {
		var keywords = purifyStrict($(elem).text());
		return keywords.indexOf(q)!=-1;
	};


	function getHeader(type) {
		var name = 'Dự án &amp; team';
			
		return "<thead><tr class='theader'> <th style='width:30px; min-width:30px;'>&nbsp;</th> <th><div class='lead' style='margin-left:-20px'>"+(name)+"</div></th> <th style='width:130px'>Department</th> <th style='width:120px'>Thành viên</th> <th style='width:130px'>Thống kê</th> <th style='width:80px'>Trạng thái</th> <th style='width:120px'>&nbsp;</th> <th style='width:80px; min-width:80px'>&nbsp;</th> </tr></thead>";
	};


	function getListHTML(system) {
		var content = "No description";

		if (system.content && system.content.length) {
			content = system.content;
		}

		var stats = system.stats;
		system.complete = stats.complete;

		var d = Math.floor((parseInt(system.etime) - AP.time.now()) / (24 * 3600));
		var days_left = "<span class='count'>Còn <b>" + d + "</b> ngày</span>";
		if (d < 0) {
			days_left = "<span class='count'>Đã qua deadline</span>";
		}

		var percent = 0;
		if (parseInt(stats.total)) {
			percent = (parseInt(stats.complete) * 100.0 / stats.total).toFixed(1);
		}

		var color = UI.color.percent(percent);

		if (system.metatype=='project' && parseInt(system.stime) && parseInt(system.etime)){
			system.percent=percent;
			color=UI.color.progress(system);
		}

		var cat=" ";
		if (system.category){
			cat=system.category;
		}

		var cat_html="";
		
		content=safe(system.content);
		if (!content || !content.length){
			content="Chưa có miêu tả";
		}

		var edit_button = "<div class='-item url' data-url='"+(system.path)+"'>Xem chi tiết</div> <div class='-item url' data-url='"+(system.path)+"' data-blank='1'>Mở trong tab mới</div>";
		
		if (parseInt(system.acl.managed) || Me.isSystemOwner()){
			edit_button+="<div class='-item-sep'></div> <div class='-item url' data-url='paction/"+(system.id)+"/edit'>Chỉnh sửa nhanh</div> <div class='-item url' data-url='paction/"+(system.id)+"/status'>Cập nhật trạng thái</div> <div class='-item url' data-url='"+(system.path)+"/settings'>Quản lý</div>";
		}
		
		var dept=Dept.fromContext(system.dept_id);
		if (dept){
			dept_html="<div class='dept'><span class='a normal std url' data-url='dept/"+(dept.id)+"'>"+(dept.name)+"</span></div>";
		}else{
			dept_html="<div class='dept -none text-8'>No department</div>";
		}
		
		var old_cat='';
		if (system.category){
			old_cat="Old category: <em class='text-3'>"+(system.category)+"</em> &middot;";
		}
		
		return "<tr class='li item-"+(system.id)+" js-project' data-id='"+(system.id)+"' data-stage='"+(system.stage)+"' data-status='"+(system.status)+"' title='"+(content)+"'> <td> <div class='rx' title='Move team and project up or down'></div> </td> <td> <div class='icon' title='Completed: "+(percent)+"%'> <div id='js-status-"+(system.id)+"' class='js-complete-sektor' style='width:20px; height:20px' data-color='"+(Color.get(system.color))+"' data-bg='rgba(0,0,0,0.13)' data-arc='1' data-percent='"+(percent)+"'></div> </div> <div class='title url' title='"+(system.name)+"' data-url='"+(system.path)+"'>"+(system.name)+"</div> <div class='info relative' style='height:13px;'> <div class='absolute ap-xdot' style='width:100%'>"+(old_cat)+""+(content)+" &middot; Cập nhật "+(AP.time.ago(system.last_update))+"</div> </div> </td> <td> <div class='relative'><div class='absolute ap-xdot' style='width:100%'>"+(dept_html)+"</div></div> </td> <td><div class='users clear-fix'>"+(getTeams(system, 24))+"</div></td> <td> <div class='bar'> <div class='stats'><b>"+(stats.complete)+"</b>/<b>"+(stats.total)+"</b> hoàn thành <span class='right'><b>"+(stats.overdue)+"</b> quá hạn</span></div> <div class='complete' style='width:"+(percent)+"%; background-color:"+(color)+"'></div> </div> </td> <td><div class='status -"+(system.status)+"'>"+(getStatus(system.status))+"</div></td> <td><div class='status -"+(system.stage)+"'>"+(getStage(system.stage))+"</div></td> <td> <div class='edit-dd -cmenuw'>Option <span class='-ap icon-triangle-down'></span> <div class='-cmenu -no-icon -padding w200'>"+(edit_button)+"</div> </div> </td> </tr>";
	};




	function getHTML(system){
		var content="";

		if (system.content && system.content.length){
			content=" &middot; "+safe(system.content);
		}

		var stats=system.stats;
		system.complete=stats.complete;
		var color=UI.color.progress(system);

		var d=Math.floor((parseInt(system.etime) - AP.time.now())/(24*3600));
		var days_left="<span class='count'>Còn <b>"+d+"</b> ngày</span>";
		if (d<0){
			days_left="<span class='count'>Đã qua deadline</span>";
		}

		var percent=0;	
		if (parseInt(stats.total)){
			percent=(parseInt(stats.complete)*100.0/stats.total).toFixed(1);
		}

		var color=UI.color.percent(percent);

		if (parseInt(system.stime) && parseInt(system.etime)){
			color=UI.color.progress(percent, system.stime, system.etime);
		}

		if (mobile){
			return "<div class='item item-"+(system.id)+" js-project' data-stage='"+(system.stage)+"' data-status='"+(system.status)+"'> <div class='w'> <div class='istats'>"+(stats.complete)+"/"+(stats.total)+"</div> <div class='title url ap-xdot' title='"+(system.name)+"' data-url='"+(system.path)+"'>"+(system.name)+"</div> <div class='info'>Tạo ngày "+(AP.i18n.date(system.since))+" &middot; Cập nhật "+(AP.time.ago(system.last_update))+""+(content)+"</div> <div class='users clear-fix'>"+(getTeams(system))+"</div> <div class='bar'> <div class='stats'> <b>"+(stats.complete)+"</b>/<b>"+(stats.total)+"</b> hoàn thành <span class='right'><b>"+(stats.overdue)+"</b> quá hạn</span> </div> <div class='complete' style='width:"+(percent)+"%; background-color:"+(color)+"'></div> </div> </div> </div>";
			
		}else{
			return "<div class='item item-"+(system.id)+" js-project' data-stage='"+(system.stage)+"' data-status='"+(system.status)+"'> <div class='w'> <div class='title url ap-xdot' title='"+(system.name)+"' data-url='"+(system.path)+"'>"+(system.name)+"</div> <div class='info ap-xdot'>"+(safe(content))+"</div> <div class='users clear-fix'>"+(getTeams(system))+"</div> <div class='bar'> <div class='stats'> <b>"+(stats.complete)+"</b>/<b>"+(stats.total)+"</b> hoàn thành <span class='right'><b>"+(stats.overdue)+"</b> quá hạn</span> </div> <div class='complete' style='width:"+(percent)+"%; background-color:"+(color)+"'></div> </div> <div class='footer'>Tạo ngày "+(AP.i18n.date(system.since))+" &middot; Cập nhật "+(AP.time.ago(system.last_update))+"</div> </div> </div>";	
		}
	};


	function getTeams(system, size){
		if (!size){
			size=32;
		}
		var total = system.followers.length;
		var html = "";
		var counter=0;
		
		for (i = 0; i < system.followers.length; i++) {
			var u=People.get(system.followers[i].username);
			if (!u || !parseInt(u.uid)){
				continue;
			}
			
			counter++;
			if (counter < 5) {
				html += "<div class='avatar avatar-"+size+" -circled url' data-username='"+system.followers[i].username+"'>" +
					"<div class='image'><img src='"+AP.xthumb(u.gavatar)+"'/></div>"+
					"</div>";
			}
		}

		if (counter < 5) {
			return html;
		}

		return html + "<div class='avatar avatar-"+size+" -circled -infow'>" +
			"<span class='-infobox -up -w200'><span class='-box block normal'>"+(total - 4)+" người khác</span></span>" +
			"<div class='more'><span>"+(total - 4)+"</span></div>" +
			"</div>";

	};

	
	function getStatus(status){
		if (parseInt(status)==0){
			return "<div class='stage -bg-success'>Active</div>";	
		}else{
			return "<div class='stage -bg-error'>Closed</div>";
		}
	};
	
	
	function getStage(stage){
		return "<div class='stage -edge' style='background-color:"+(Color.rgba(Project.status.color(stage),0.1))+"; color:"+(Color.adjust(Project.status.color(stage),10,20))+"'>"+(Project.status.getShortLabel(stage))+"</div>";
	};
	
	
	/**
	 * @desc Setting position of a project
	 */
	function setPosition(project_id, index){
		UI.ajaxShow();
		AP.post("api/project/reorder", {project_id: project_id, index:index, sorter: "global"}, function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			UI.flash("Update successfully");
		});
	};
};


Wework.people=new function __WeWorkPeople(){
	this.filter="all";
	this.type="project";	

	this.initTabs=function(){
		$("#collection .header .side .icon").click(function(){
			var view=$(this).data("view");
			AP.log.setAppCookie("people_view", view);
			Wework.projects.display();
			$(this).addClass("active");
			$(this).siblings().removeClass("active");
		}).each(function(){
			var view=$(this).data("view");
			var cview=AP.log.getAppCookie("people_view");
			if (!cview){
				cview="list";
			}

			if (view==cview){
				$(this).addClass("active");
			}else{
				$(this).removeClass("active");
			}
		});
	};


	this.init = function(type){
		$("#js-side-member-search").quickFilter("#collection .js-person", function($elem, q){
			q=purify(q);
			var kw=$elem.data("member");
			if (kw) {
				return kw.toLowerCase().indexOf(q)!=-1;
			}
		});
		
		this.initTabs();
		
		if (!type){
			type=this.type;
		}
		
		if (!type){
			type="project";
		}
		
		this.type=type;
		this.render();
	};
	
	
	this.menu=function(){
		return;
		
		var people=Client.people.slice(0);
		people.sort(function(e, f){
			return porder(f)-porder(e);
		});
		
		$("#js-cmembers").html(AP.render(people, function(e){
			if (parseInt(e.id) == parseInt(Client.viewer.id)){
				return "";
			}
			if (porder(e)>=8){
				return getMenuItem(e);
			}
			
			return "";
		}));
		
		
		$("#js-other-members").html(AP.render(people, function(e){
			if (porder(e)<8 && porder(e)>=3){
				return getMenuItem(e);
			}
			
			return "";
		}));
		
		
		$("#js-guests").html(AP.render(people, function(e){
			if (porder(e)<=1){
				return getMenuItem(e);
			}
			
			return "";
		}));
		
		$("#myside .item").setActiveURL();
		
		$("#js-ufilters").quickFilter("#myside .item", function($elem, q){
			var kw=$elem.data("keywords");
			q=purify(q);
			return kw.toLowerCase().indexOf(q)!=-1;
		});
	}; 
	
	
	this.initTabs=function(){
		this.filter="all";
		
		$("#header .itabs .tab").click(function(){
			var view=$(this).data("view");
			AP.log.setAppCookie("people_view", view);
			Wework.people.render();
			$(this).addClass("active");
			$(this).siblings().removeClass("active");
		}).each(function(){
			var view=$(this).data("view");
			var cview=AP.log.getAppCookie("people_view");
			if (!cview){
				cview="card";
			}
			
			if (view==cview){
				$(this).addClass("active");
			}else{
				$(this).removeClass("active");
			}
		});
		
		$("#collection .header .filter .li").click(function(){
			var filter=$(this).data("filter");
			$(this).addClass("active");
			$(this).siblings().removeClass("active");
			
			Wework.people.filter=filter;
			Wework.people.refilter();
		});
		
	};
	

	
	this.render=function(){
		$("#collection .projects").empty();
		$("#collection .table").empty();
		
		var people=Client.people;
		people.sort(function(e, f){
			return porder(f)-porder(e);
		});
		
		var view=AP.log.getAppCookie("people_view");
		
		if (view=="card"){
			var has_guest=false;
			for (var i = 0; i< people.length; i++){
				if (people[i].metatype=="guest" && !has_guest){
					has_guest=true;
					$("<div class='gsep' id='js-guests'>Tài khoản khách</div>").appendTo("#collection .projects");
				}
				
				var html = getCardHTML(people[i]);
				$(html).appendTo("#collection .projects");
			}
		}else{
			var html="";
			var has_guest=false;
			for (var i = 0; i< people.length; i++){				
				if (people[i].metatype=="guest" && !has_guest){
					has_guest=true;
					html+="<tr><td colspan='5' class='gsep' id='js-guests'>Tài khoản khách</td></tr>";
				}
				html += getListHTML(people[i]);
			}
			
			$("#collection .table").html("<table>"+getHeader() + html+"</table>");
		}
		
		this.refilter();
	};
	
	
	this.refilter=function(){
		$("#collection .js-person").each(function(){
			var stage=$(this).data("stage");
			if (stage==Wework.projects.filter || Wework.projects.filter =="all"){
				$(this).show();
			}else{
				$(this).hide();
			}
		});
	};
	
	
	function getHeader(){
		return "<tr class='theader'>" +
			"<th style='width:5px'>&nbsp;</th>" +
			"<th><div class='lead' style='margin-left:-20px'>Họ và tên</div></th>" +
			"<th style='width:20%'>Liên hệ</th>" +
			"<th style='width:20%'>Người quản lý</th>" +
			"<th style='width:150px'>&nbsp;</th>" +
		"</tr>";
	};
	
	
	function getListHTML(user){
		var content="No description";
		
		if (user.content && user.content.length){
			content=user.content;
		}
		
		var stats={};
		user.complete=stats.complete;
		
		var d=Math.floor((parseInt(user.etime) - AP.time.now())/(24*3600));
		var days_left="<span class='count'>Còn <b>"+d+"</b> ngày</span>";
		if (d<0){
			days_left="<span class='count'>Đã qua deadline</span>";
		}
		
		var percent=0;
		if (parseInt(stats.total)){
			percent=(parseInt(stats.complete)*100.0/stats.total).toFixed(1);
		}
		
		var color=UI.color.percent(percent);
		
		
		if (user.metatype=='project' && parseInt(user.stime) && parseInt(user.etime)){
			user.percent=percent;
			color=UI.color.progress(user);
		}
		
		var stage=user.stage;
		if (!stage){
			stage="Running";
		}
		
		var color="alt0";
		if (Online.isOnline(user.username)){
			color="success";
		}
		
		var manager="";
		if (!user.manager || !user.manager.length){
			manager="";
		}else{
			var us=People.getList(user.manager);
			manager=AP.render(us, function(e){
				return "<div class='avatar avatar-32 -circled url' data-username='"+e.username+"'><div class='image'><img src='"+AP.xthumb(e.gavatar)+"'/></div></div>";
			});
		}
		
		return "<tr class='li item-"+user.id+" js-person' data-keyword='"+user.keywords+"'>" +
			"<td></td>" +
			"<td>" +
			"	<div class='user'>" +
			"		<div class='avatar avatar-32 -circled "+(Online.isOnline(user.username)?" -online":"")+"'><div class='image'><img src='"+AP.xthumb(user.gavatar)+"'/></div></div>" +
			"		<div class='title url ap-xdot' title='"+user.name+"' data-url='user/"+user.username+"'>"+user.name+"</div>" +
			"		<div class='info ap-xdot'>"+user.title+"</div>" +
			"	</div>" +
			"</td>" +
			"<td>" +
			"	<div class='relative'><div class='absolute ap-xdot' style='width:100%'>"+safe(user.email)+"</div></div>" +
			"</td>" +
			"<td>" +
			"	<div class='users clear-fix'>"+manager+"</div>" +
			"</td>" +
			"<td>" +
			"	<div class='buttons -two clear-fix -std'>" +
			"		<div class='button url' data-url='user/"+user.username+"'>&#9655; Chi tiết</div>" +
			"		<div class='button' onclick=\"Base.message.peer('"+user.username+"')\">Nhắn tin</div>" +
			"	</div>" +
			"</td>" +
		"</tr>";
	};
	
	
	
	
	function getCardHTML(user){
		var stats={};
		user.complete=stats.complete;
		var color=UI.color.progress(user);
		
		var d=Math.floor((parseInt(user.etime) - AP.time.now())/(24*3600));
		var days_left="<span class='count'>Còn <b>"+d+"</b> ngày</span>";
		if (d<0){
			days_left="<span class='count'>Đã qua deadline</span>";
		}
		
		var percent=0;
		if (parseInt(stats.total)){
			percent=(parseInt(stats.complete)*100.0/stats.total).toFixed(1);
		}
		
		var color=UI.color.percent(percent);
		
		if (parseInt(user.stime) && parseInt(user.etime)){
			color=UI.color.progress(percent, user.stime, user.etime);
		}
		
		return "<div class='item item-"+user.id+" js-person'><div class='w'>" +
			"<div class='title url ap-xdot' title='"+user.name+"' data-url='user/"+user.username+"'>"+user.name+"</div>" +
			"<div class='avatar avatar-40 -circled'><div class='image'><img src='"+AP.xthumb(user.gavatar)+"'/></div></div>" +
			"<div class='info ap-xdot'>"+user.title+"</div>" +
			"<div class='info ap-xdot'>"+user.email+"</div>" +
			"<div class='footer'>Tham gia từ "+AP.i18n.date(user.since)+" &middot; <span class='url' data-username='"+user.username+"' data-intent='chat'>Nhắn tin</span></div>" +
		"</div></div>";
	};
	
	
	function getTeams(system, size){
		if (!size){
			size=32;
		}
		return AP.render(system.followers, function(e){
			var u=People.get(e.username);
				return "<div class='avatar avatar-"+size+" -circled url' data-username='"+u.username+"'>" +
					"<div class='image'><img src='"+AP.xthumb(u.gavatar)+"'/></div>"+
				"</div>";
		});
	};
	
	
	function porder(e){
		if (e.username==Client.viewer.username){
			return 10;
		}
		
		if (Me.isManagerOf(e)){
			return 9;
		}
		
		if (Me.isManagedBy(e)){
			return 8;
		}
		
		if (Me.shareManager(e)){
			return 7;
		}
		
		if (e.metatype=="guest"){
			return 1;
		}
		
		return 3;
	};
	
	
	
	function getMenuItem(e){
		return "<div class='item url' data-url='user/"+e.username+"' data-keywords='"+e.keywords+"'>" +
			"<div class='name'>"+e.name+"</div>" +
			"<div class='avatar'><img src='"+AP.xthumb(e.gavatar)+"'></div>" +
		"</div>";
	};
	
};


Wework.video=new function __WeworkVideo(){
	this.display=function(){
		var html="";
		for (var i=0; i<Client.pageData.videos.length; i++){
			html+=getTab(Client.pageData.videos[i], i);
		}
		
		$("#video-side .tabs").html(html);
		
		$("#video-side .tabs .tab").click(function(){
			$(this).siblings().removeClass("active");
			$(this).addClass("active");
			renderVideo($(this).data("url"), true);
		});
		
		
		// Init the first video
		$("#video-side .tabs .tab").setActive(0);
		renderVideo($("#video-side .tabs .tab:eq(0)").data("url"));
		
		AP.html.resize(function(){
			if (!$("#js-yt-iframe").length){
				return;
			}
			
			var w=$("#js-video").width();
			var h=Math.floor(w*600/1060);
			$("#js-yt-iframe").attr("width", w).attr("height", h);
		});
		
	};
	
	
	
	function getTab(video, index){
		return "<div class='tab' data-index='"+index+"' data-url='"+video.url+"'>" +
			"<div class='icon'><span class='-ap icon-play2'></span></div>" +
			"<div class='link'>"+video.name+"</div>" +
			"<div class='info'>"+video.length+"s</div>" +
		"</div>";
	};
	
	
	function renderVideo(url, autoplay){
		var real_url=url;
		if (autoplay){
			real_url=url+"?autoplay=1";
		}
		
		var w=$("#js-video").width();
		var h=Math.floor(w*600/1060);
		var html='<iframe id="js-yt-iframe" width="'+w+'" height="'+h+'" src="'+real_url+'" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>';
		$("#js-video").html(html);
	};
	
};


Wework.system=new function __WeworkSystem(){
	this.init=function(){
		$("#js-header-startdate").dateRangePicker({
			getValue: function(){
				return this.innerHTML;
			},
			setValue: function(s, from, to, from_ts, to_ts, click){

			},
			onSelect: function(from, to){
				AP.setURLParams({
					start: encodeURIComponent(AP.time.time("%d-%m-%Y", from)),
					end: encodeURIComponent(AP.time.time("%d-%m-%Y",to)),
				}, true);

				$(this).data('dateRangePicker').close();
			}
		}).find(".js-range").html("<em>"+AP.i18n.date(Client.pageData.params.start)+"</em> › <em>"+AP.i18n.date(Client.pageData.params.end)+"</em>");

		$("#js-header-startdate").data("dateRangePicker").setStart(Client.pageData.params.start_str).setEnd(Client.pageData.params.end_str);

		var info=Client.pageData.data;
		$("#js-assigners-task").html(AP.render(info, function(e){
			return getHeader(e);
		}));
		$("#total_projects").html(Client.pageData.total_projects);
		$("#total_teams").html(Client.pageData.total_teams);
		$("#total_running_projects").html(Client.pageData.total_running_projects);
		$("#total_closed_projects").html(Client.pageData.total_closed_projects);
		$("#total_users").html(Client.pageData.total_users);
		$("#total_tasks").html(Client.pageData.total_tasks);
		$("#total_subtasks").html(Client.pageData.total_subtasks);
		
		BaseTable.init("#js-report-table",{
			height: function(){
				return $(window).height()-205;
			},
			width: "auto",
			sorter: true
		});
	}

	function getHeader(e){

		var done = AP.array.filter(e.data.tasks, function(e){
			return e.status == 1;
		});
		var active = AP.array.filter(e.data.tasks, function(e){
			return e.status == 0 && e.review == 0;
		});
		var review = AP.array.filter(e.data.tasks, function(e){
			return e.status == 0 && e.review == 1;
		});

		var overdue = AP.array.filter(e.data.tasks, function(e){
			var now = AP.time.now();
			if (parseInt(e.deadline)){
				if (!parseInt(e.status) && now  > parseInt(e.deadline)){
					return true;
				}
			}	
		});

		var done_late = AP.array.filter(e.data.tasks, function(e){
			return Compute.doneLate(e);
		});

		var pc=0, pl=0, po=0;
		if (e.data.tasks.length){
			pc=(done.length*100.0/e.data.tasks.length).toFixed(2);
			pl=(done_late.length*100.0/e.data.tasks.length).toFixed(2);
			po=(overdue.length*100.0/e.data.tasks.length).toFixed(2);
		}
		
		return "<tr class='js-user'> <td class='-fl'> <div class='user url' data-url='user/"+(e.username)+"'> <div class='avatar avatar-32 -circled'><div class='image'><img src='"+(AP.xthumb(e.gavatar))+"'/></div></div> <div class='name'>"+(e.name)+"</div> <div class='info'>"+(e.title)+"&nbsp;</div> </div> </td> <td><b class='bc'>"+(e.data.project)+"</b></td> <td><b class='bc'>"+(e.data.team)+"</b></td> <td><b class='bc'>"+(e.data.tasks.length)+"</b></td> <td><b class='bc'>"+(e.data.subtasks.length)+"</b></td> <td><b class='bc text-success'>"+(done.length)+"</b></td> <td><b class='bc'>"+(active.length)+"</b></td> <td><b class='bc'>"+(review.length)+"</b></td> <td><b class='bc'>"+(done_late.length)+"</b></td> <td><b class='bc'>"+(overdue.length)+"</b></td> <td class='-fr'> <div class='bar'> <div class='b -bg-success' style='width:"+(pc)+"%'></div> <div class='b -bg-alt6' style='width:"+(pl)+"%'></div> <div class='b -bg-error' style='width:"+(po)+"%'></div> </div> </td> </tr>";
	};
};



(function($){$.extend({tablesorter:new
function(){var parsers=[],widgets=[];this.defaults={cssHeader:"header",cssAsc:"headerSortUp",cssDesc:"headerSortDown",cssChildRow:"expand-child",sortInitialOrder:"asc",sortMultiSortKey:"shiftKey",sortForce:null,sortAppend:null,sortLocaleCompare:true,textExtraction:"simple",parsers:{},widgets:[],widgetZebra:{css:["even","odd"]},headers:{},widthFixed:false,cancelSelection:true,sortList:[],headerList:[],dateFormat:"us",decimal:'/\.|\,/g',onRenderHeader:null,selectorHeaders:'thead th',debug:false};function benchmark(s,d){log(s+","+(new Date().getTime()-d.getTime())+"ms");}this.benchmark=benchmark;function log(s){if(typeof console!="undefined"&&typeof console.debug!="undefined"){console.log(s);}else{alert(s);}}function buildParserCache(table,$headers){if(table.config.debug){var parsersDebug="";}if(table.tBodies.length==0)return;var rows=table.tBodies[0].rows;if(rows[0]){var list=[],cells=rows[0].cells,l=cells.length;for(var i=0;i<l;i++){var p=false;if($.metadata&&($($headers[i]).metadata()&&$($headers[i]).metadata().sorter)){p=getParserById($($headers[i]).metadata().sorter);}else if((table.config.headers[i]&&table.config.headers[i].sorter)){p=getParserById(table.config.headers[i].sorter);}if(!p){p=detectParserForColumn(table,rows,-1,i);}if(table.config.debug){parsersDebug+="column:"+i+" parser:"+p.id+"\n";}list.push(p);}}if(table.config.debug){log(parsersDebug);}return list;};function detectParserForColumn(table,rows,rowIndex,cellIndex){var l=parsers.length,node=false,nodeValue=false,keepLooking=true;while(nodeValue==''&&keepLooking){rowIndex++;if(rows[rowIndex]){node=getNodeFromRowAndCellIndex(rows,rowIndex,cellIndex);nodeValue=trimAndGetNodeText(table.config,node);if(table.config.debug){log('Checking if value was empty on row:'+rowIndex);}}else{keepLooking=false;}}for(var i=1;i<l;i++){if(parsers[i].is(nodeValue,table,node)){return parsers[i];}}return parsers[0];}function getNodeFromRowAndCellIndex(rows,rowIndex,cellIndex){return rows[rowIndex].cells[cellIndex];}function trimAndGetNodeText(config,node){return $.trim(getElementText(config,node));}function getParserById(name){var l=parsers.length;for(var i=0;i<l;i++){if(parsers[i].id.toLowerCase()==name.toLowerCase()){return parsers[i];}}return false;}function buildCache(table){if(table.config.debug){var cacheTime=new Date();}var totalRows=(table.tBodies[0]&&table.tBodies[0].rows.length)||0,totalCells=(table.tBodies[0].rows[0]&&table.tBodies[0].rows[0].cells.length)||0,parsers=table.config.parsers,cache={row:[],normalized:[]};for(var i=0;i<totalRows;++i){var c=$(table.tBodies[0].rows[i]),cols=[];if(c.hasClass(table.config.cssChildRow)){cache.row[cache.row.length-1]=cache.row[cache.row.length-1].add(c);continue;}cache.row.push(c);for(var j=0;j<totalCells;++j){cols.push(parsers[j].format(getElementText(table.config,c[0].cells[j]),table,c[0].cells[j]));}cols.push(cache.normalized.length);cache.normalized.push(cols);cols=null;};if(table.config.debug){benchmark("Building cache for "+totalRows+" rows:",cacheTime);}return cache;};function getElementText(config,node){var text="";if(!node)return"";if(!config.supportsTextContent)config.supportsTextContent=node.textContent||false;if(config.textExtraction=="simple"){if(config.supportsTextContent){text=node.textContent;}else{if(node.childNodes[0]&&node.childNodes[0].hasChildNodes()){text=node.childNodes[0].innerHTML;}else{text=node.innerHTML;}}}else{if(typeof(config.textExtraction)=="function"){text=config.textExtraction(node);}else{text=$(node).text();}}return text;}function appendToTable(table,cache){if(table.config.debug){var appendTime=new Date()}var c=cache,r=c.row,n=c.normalized,totalRows=n.length,checkCell=(n[0].length-1),tableBody=$(table.tBodies[0]),rows=[];for(var i=0;i<totalRows;i++){var pos=n[i][checkCell];rows.push(r[pos]);if(!table.config.appender){var l=r[pos].length;for(var j=0;j<l;j++){tableBody[0].appendChild(r[pos][j]);}}}if(table.config.appender){table.config.appender(table,rows);}rows=null;if(table.config.debug){benchmark("Rebuilt table:",appendTime);}applyWidget(table);setTimeout(function(){$(table).trigger("sortEnd");},0);};function buildHeaders(table){if(table.config.debug){var time=new Date();}var meta=($.metadata)?true:false;var header_index=computeTableHeaderCellIndexes(table);$tableHeaders=$(table.config.selectorHeaders,table).each(function(index){this.column=header_index[this.parentNode.rowIndex+"-"+this.cellIndex];this.order=formatSortingOrder(table.config.sortInitialOrder);this.count=this.order;if(checkHeaderMetadata(this)||checkHeaderOptions(table,index))this.sortDisabled=true;if(checkHeaderOptionsSortingLocked(table,index))this.order=this.lockedOrder=checkHeaderOptionsSortingLocked(table,index);if(!this.sortDisabled){var $th=$(this).addClass(table.config.cssHeader);if(table.config.onRenderHeader)table.config.onRenderHeader.apply($th);}table.config.headerList[index]=this;});if(table.config.debug){benchmark("Built headers:",time);log($tableHeaders);}return $tableHeaders;};function computeTableHeaderCellIndexes(t){var matrix=[];var lookup={};var thead=t.getElementsByTagName('THEAD')[0];var trs=thead.getElementsByTagName('TR');for(var i=0;i<trs.length;i++){var cells=trs[i].cells;for(var j=0;j<cells.length;j++){var c=cells[j];var rowIndex=c.parentNode.rowIndex;var cellId=rowIndex+"-"+c.cellIndex;var rowSpan=c.rowSpan||1;var colSpan=c.colSpan||1
var firstAvailCol;if(typeof(matrix[rowIndex])=="undefined"){matrix[rowIndex]=[];}for(var k=0;k<matrix[rowIndex].length+1;k++){if(typeof(matrix[rowIndex][k])=="undefined"){firstAvailCol=k;break;}}lookup[cellId]=firstAvailCol;for(var k=rowIndex;k<rowIndex+rowSpan;k++){if(typeof(matrix[k])=="undefined"){matrix[k]=[];}var matrixrow=matrix[k];for(var l=firstAvailCol;l<firstAvailCol+colSpan;l++){matrixrow[l]="x";}}}}return lookup;}function checkCellColSpan(table,rows,row){var arr=[],r=table.tHead.rows,c=r[row].cells;for(var i=0;i<c.length;i++){var cell=c[i];if(cell.colSpan>1){arr=arr.concat(checkCellColSpan(table,headerArr,row++));}else{if(table.tHead.length==1||(cell.rowSpan>1||!r[row+1])){arr.push(cell);}}}return arr;};function checkHeaderMetadata(cell){if(($.metadata)&&($(cell).metadata().sorter===false)){return true;};return false;}function checkHeaderOptions(table,i){if((table.config.headers[i])&&(table.config.headers[i].sorter===false)){return true;};return false;}function checkHeaderOptionsSortingLocked(table,i){if((table.config.headers[i])&&(table.config.headers[i].lockedOrder))return table.config.headers[i].lockedOrder;return false;}function applyWidget(table){var c=table.config.widgets;var l=c.length;for(var i=0;i<l;i++){getWidgetById(c[i]).format(table);}}function getWidgetById(name){var l=widgets.length;for(var i=0;i<l;i++){if(widgets[i].id.toLowerCase()==name.toLowerCase()){return widgets[i];}}};function formatSortingOrder(v){if(typeof(v)!="Number"){return(v.toLowerCase()=="desc")?1:0;}else{return(v==1)?1:0;}}function isValueInArray(v,a){var l=a.length;for(var i=0;i<l;i++){if(a[i][0]==v){return true;}}return false;}function setHeadersCss(table,$headers,list,css){$headers.removeClass(css[0]).removeClass(css[1]);var h=[];$headers.each(function(offset){if(!this.sortDisabled){h[this.column]=$(this);}});var l=list.length;for(var i=0;i<l;i++){h[list[i][0]].addClass(css[list[i][1]]);}}function fixColumnWidth(table,$headers){var c=table.config;if(c.widthFixed){var colgroup=$('<colgroup>');$("tr:first td",table.tBodies[0]).each(function(){colgroup.append($('<col>').css('width',$(this).width()));});$(table).prepend(colgroup);};}function updateHeaderSortCount(table,sortList){var c=table.config,l=sortList.length;for(var i=0;i<l;i++){var s=sortList[i],o=c.headerList[s[0]];o.count=s[1];o.count++;}}function multisort(table,sortList,cache){if(table.config.debug){var sortTime=new Date();}var dynamicExp="var sortWrapper = function(a,b) {",l=sortList.length;for(var i=0;i<l;i++){var c=sortList[i][0];var order=sortList[i][1];var s=(table.config.parsers[c].type=="text")?((order==0)?makeSortFunction("text","asc",c):makeSortFunction("text","desc",c)):((order==0)?makeSortFunction("numeric","asc",c):makeSortFunction("numeric","desc",c));var e="e"+i;dynamicExp+="var "+e+" = "+s;dynamicExp+="if("+e+") { return "+e+"; } ";dynamicExp+="else { ";}var orgOrderCol=cache.normalized[0].length-1;dynamicExp+="return a["+orgOrderCol+"]-b["+orgOrderCol+"];";for(var i=0;i<l;i++){dynamicExp+="}; ";}dynamicExp+="return 0; ";dynamicExp+="}; ";if(table.config.debug){benchmark("Evaling expression:"+dynamicExp,new Date());}eval(dynamicExp);cache.normalized.sort(sortWrapper);if(table.config.debug){benchmark("Sorting on "+sortList.toString()+" and dir "+order+" time:",sortTime);}return cache;};function makeSortFunction(type,direction,index){var a="a["+index+"]",b="b["+index+"]";if(type=='text'&&direction=='asc'){return"("+a+" == "+b+" ? 0 : ("+a+" === null ? Number.POSITIVE_INFINITY : ("+b+" === null ? Number.NEGATIVE_INFINITY : ("+a+" < "+b+") ? -1 : 1 )));";}else if(type=='text'&&direction=='desc'){return"("+a+" == "+b+" ? 0 : ("+a+" === null ? Number.POSITIVE_INFINITY : ("+b+" === null ? Number.NEGATIVE_INFINITY : ("+b+" < "+a+") ? -1 : 1 )));";}else if(type=='numeric'&&direction=='asc'){return"("+a+" === null && "+b+" === null) ? 0 :("+a+" === null ? Number.POSITIVE_INFINITY : ("+b+" === null ? Number.NEGATIVE_INFINITY : "+a+" - "+b+"));";}else if(type=='numeric'&&direction=='desc'){return"("+a+" === null && "+b+" === null) ? 0 :("+a+" === null ? Number.POSITIVE_INFINITY : ("+b+" === null ? Number.NEGATIVE_INFINITY : "+b+" - "+a+"));";}};function makeSortText(i){return"((a["+i+"] < b["+i+"]) ? -1 : ((a["+i+"] > b["+i+"]) ? 1 : 0));";};function makeSortTextDesc(i){return"((b["+i+"] < a["+i+"]) ? -1 : ((b["+i+"] > a["+i+"]) ? 1 : 0));";};function makeSortNumeric(i){return"a["+i+"]-b["+i+"];";};function makeSortNumericDesc(i){return"b["+i+"]-a["+i+"];";};function sortText(a,b){if(table.config.sortLocaleCompare)return a.localeCompare(b);return((a<b)?-1:((a>b)?1:0));};function sortTextDesc(a,b){if(table.config.sortLocaleCompare)return b.localeCompare(a);return((b<a)?-1:((b>a)?1:0));};function sortNumeric(a,b){return a-b;};function sortNumericDesc(a,b){return b-a;};function getCachedSortType(parsers,i){return parsers[i].type;};this.construct=function(settings){return this.each(function(){if(!this.tHead||!this.tBodies)return;var $this,$document,$headers,cache,config,shiftDown=0,sortOrder;this.config={};config=$.extend(this.config,$.tablesorter.defaults,settings);$this=$(this);$.data(this,"tablesorter",config);$headers=buildHeaders(this);this.config.parsers=buildParserCache(this,$headers);cache=buildCache(this);var sortCSS=[config.cssDesc,config.cssAsc];fixColumnWidth(this);$headers.click(function(e){var totalRows=($this[0].tBodies[0]&&$this[0].tBodies[0].rows.length)||0;if(!this.sortDisabled&&totalRows>0){$this.trigger("sortStart");var $cell=$(this);var i=this.column;this.order=this.count++%2;if(this.lockedOrder)this.order=this.lockedOrder;if(!e[config.sortMultiSortKey]){config.sortList=[];if(config.sortForce!=null){var a=config.sortForce;for(var j=0;j<a.length;j++){if(a[j][0]!=i){config.sortList.push(a[j]);}}}config.sortList.push([i,this.order]);}else{if(isValueInArray(i,config.sortList)){for(var j=0;j<config.sortList.length;j++){var s=config.sortList[j],o=config.headerList[s[0]];if(s[0]==i){o.count=s[1];o.count++;s[1]=o.count%2;}}}else{config.sortList.push([i,this.order]);}};setTimeout(function(){setHeadersCss($this[0],$headers,config.sortList,sortCSS);appendToTable($this[0],multisort($this[0],config.sortList,cache));},1);return false;}}).mousedown(function(){if(config.cancelSelection){this.onselectstart=function(){return false};return false;}});$this.bind("update",function(){var me=this;setTimeout(function(){me.config.parsers=buildParserCache(me,$headers);cache=buildCache(me);},1);}).bind("updateCell",function(e,cell){var config=this.config;var pos=[(cell.parentNode.rowIndex-1),cell.cellIndex];cache.normalized[pos[0]][pos[1]]=config.parsers[pos[1]].format(getElementText(config,cell),cell);}).bind("sorton",function(e,list){$(this).trigger("sortStart");config.sortList=list;var sortList=config.sortList;updateHeaderSortCount(this,sortList);setHeadersCss(this,$headers,sortList,sortCSS);appendToTable(this,multisort(this,sortList,cache));}).bind("appendCache",function(){appendToTable(this,cache);}).bind("applyWidgetId",function(e,id){getWidgetById(id).format(this);}).bind("applyWidgets",function(){applyWidget(this);});if($.metadata&&($(this).metadata()&&$(this).metadata().sortlist)){config.sortList=$(this).metadata().sortlist;}if(config.sortList.length>0){$this.trigger("sorton",[config.sortList]);}applyWidget(this);});};this.addParser=function(parser){var l=parsers.length,a=true;for(var i=0;i<l;i++){if(parsers[i].id.toLowerCase()==parser.id.toLowerCase()){a=false;}}if(a){parsers.push(parser);};};this.addWidget=function(widget){widgets.push(widget);};this.formatFloat=function(s){var i=parseFloat(s);return(isNaN(i))?0:i;};this.formatInt=function(s){var i=parseInt(s);return(isNaN(i))?0:i;};this.isDigit=function(s,config){return/^[-+]?\d*$/.test($.trim(s.replace(/[,.']/g,'')));};this.clearTableBody=function(table){if($.browser.msie){function empty(){while(this.firstChild)this.removeChild(this.firstChild);}empty.apply(table.tBodies[0]);}else{table.tBodies[0].innerHTML="";}};}});$.fn.extend({tablesorter:$.tablesorter.construct});var ts=$.tablesorter;ts.addParser({id:"text",is:function(s){return true;},format:function(s){return $.trim(s.toLocaleLowerCase());},type:"text"});ts.addParser({id:"digit",is:function(s,table){var c=table.config;return $.tablesorter.isDigit(s,c);},format:function(s){return $.tablesorter.formatFloat(s);},type:"numeric"});ts.addParser({id:"currency",is:function(s){return/^[£$€?.]/.test(s);},format:function(s){return $.tablesorter.formatFloat(s.replace(new RegExp(/[£$€]/g),""));},type:"numeric"});ts.addParser({id:"ipAddress",is:function(s){return/^\d{2,3}[\.]\d{2,3}[\.]\d{2,3}[\.]\d{2,3}$/.test(s);},format:function(s){var a=s.split("."),r="",l=a.length;for(var i=0;i<l;i++){var item=a[i];if(item.length==2){r+="0"+item;}else{r+=item;}}return $.tablesorter.formatFloat(r);},type:"numeric"});ts.addParser({id:"url",is:function(s){return/^(https?|ftp|file):\/\/$/.test(s);},format:function(s){return jQuery.trim(s.replace(new RegExp(/(https?|ftp|file):\/\//),''));},type:"text"});ts.addParser({id:"isoDate",is:function(s){return/^\d{4}[\/-]\d{1,2}[\/-]\d{1,2}$/.test(s);},format:function(s){return $.tablesorter.formatFloat((s!="")?new Date(s.replace(new RegExp(/-/g),"/")).getTime():"0");},type:"numeric"});ts.addParser({id:"percent",is:function(s){return/\%$/.test($.trim(s));},format:function(s){return $.tablesorter.formatFloat(s.replace(new RegExp(/%/g),""));},type:"numeric"});ts.addParser({id:"usLongDate",is:function(s){return s.match(new RegExp(/^[A-Za-z]{3,10}\.? [0-9]{1,2}, ([0-9]{4}|'?[0-9]{2}) (([0-2]?[0-9]:[0-5][0-9])|([0-1]?[0-9]:[0-5][0-9]\s(AM|PM)))$/));},format:function(s){return $.tablesorter.formatFloat(new Date(s).getTime());},type:"numeric"});ts.addParser({id:"shortDate",is:function(s){return/\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}/.test(s);},format:function(s,table){var c=table.config;s=s.replace(/\-/g,"/");if(c.dateFormat=="us"){s=s.replace(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/,"$3/$1/$2");}else if(c.dateFormat=="uk"){s=s.replace(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/,"$3/$2/$1");}else if(c.dateFormat=="dd/mm/yy"||c.dateFormat=="dd-mm-yy"){s=s.replace(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2})/,"$1/$2/$3");}return $.tablesorter.formatFloat(new Date(s).getTime());},type:"numeric"});ts.addParser({id:"time",is:function(s){return/^(([0-2]?[0-9]:[0-5][0-9])|([0-1]?[0-9]:[0-5][0-9]\s(am|pm)))$/.test(s);},format:function(s){return $.tablesorter.formatFloat(new Date("2000/01/01 "+s).getTime());},type:"numeric"});ts.addParser({id:"metadata",is:function(s){return false;},format:function(s,table,cell){var c=table.config,p=(!c.parserMetadataName)?'sortValue':c.parserMetadataName;return $(cell).metadata()[p];},type:"numeric"});ts.addWidget({id:"zebra",format:function(table){if(table.config.debug){var time=new Date();}var $tr,row=-1,odd;$("tr:visible",table.tBodies[0]).each(function(i){$tr=$(this);if(!$tr.hasClass(table.config.cssChildRow))row++;odd=(row%2==0);$tr.removeClass(table.config.widgetZebra.css[odd?0:1]).addClass(table.config.widgetZebra.css[odd?1:0])});if(table.config.debug){$.tablesorter.benchmark("Applying Zebra widget",time);}}});})(jQuery);
var Dashboard=new function __DashBoard(){
	
};




Dashboard.filter=new function __DashboardFilter(){
	this.init=function(){
		$("#js-db-filters .filter.js-department .-cmenu").append(AP.render(Client.depts, function(e){
			return "<div class='-item url' data-urlparam='dept' data-value='"+(e.id)+"'>"+(e.name)+"</div>";
		}));
		
		var range='All ranges';
		if (Client.pageData.range){
			range=AP.i18n.range(Client.pageData.range.start, Client.pageData.range.end);
		}

		$("#js-db-filters .js-duration em").html(range);
		
		
		$("#js-db-filters .js-duration").click(function(){
			UI.rangePicker(function(start, end){
				AP.setURLParams({start: start, end: end}, true);
			});
		});
		
		$("#js-db-filters .js-by .-item").setActiveData("value", Query.get("by"));
		$("#js-db-filters .js-department .-item").setActiveData("value", Query.get("dept"));
		$("#js-db-filters .js-assignees .-item").setActiveData("value", Query.get("assignees"));
		$("#js-db-filters .js-subtaskopt .-item").setActiveData("value", Query.get("subtaskopt"));
		$("#js-db-filters .js-status .-item").setActiveData("value", Query.get("status"));
		
		
		$("#js-db-filters .-item.active").each(function(){
			var v=$(this).text();
			$(this).closest(".filter").find("em").html(v);
		});
	};
};


Dashboard.grid=new function __DBGrid(){
	this.init=function(){
		$("#db-canvas .db-grid").each(function(){
			var col=$(this).data("col");
			
			$(this).find(".box").each(function(){
				var c=$(this).data("col");
				
				if (AP.data.isString(c)){
					var parts=c.split(",", 2);
					if (parts.length==2 && parseFloat(parts[0]) && parseFloat(parts[1])){
						var cx=parseFloat(parts[0]);
						var rx=parseFloat(parts[1]);
						var h=100*rx/cx;
						
						var w=100.0*cx/col;
						$(this).css("width", w+"%").addClass("std").wrapInner("<div class='inner'></div>").append("<div class='s' style='padding-bottom:"+(h)+"%'></div>");
					}
					
				}else if (c && parseInt(c)){
					var w=100.0*c/col;
					$(this).css("width", w+"%").addClass("std").wrapInner("<div class='inner'></div>").append("<div class='s'></div>");
				}
				
				var $h=$(this).find(".header");
				if (!$h.find(".side").length){
					$h.append("<div class='side'></div>");
				}
			})
		});
	};
};


Dashboard.builder=new function __DashboardBuilder(){
	
	this.build=function(){
		initTaskStatusReport();
		initTaskLateReport();
		initTopPerformers();
		initMemberReport();
		
		initDailyReport();
		initWeeklyReport();
		
		initProjectReport();
		initDeptReport();
		initMilestoneReport();
		initTagCloud();
		initGridStats();
		
		initWorkloadReport();
		
		$("#db-canvas .js-count").each(function(){
			var k=$(this).data("key");
			if (Dashboard.model.stats[k]){
				$(this).html(AP.data.numberFormat(Dashboard.model.stats[k]));
			}else{
				$(this).html(0);
			}
		});
	};
	
	
	
	/**
	 * @desc Init standard reports for todo, doing, done_late, done_ontime, using PIE chart
	 */
	function initTaskStatusReport(){
		var stats={done_ontime: Dashboard.model.getStat("tasks_done_ontime"), done_late: Dashboard.model.getStat("tasks_done_late"), in_progress: Dashboard.model.getStat("tasks_in_progress"), overdue: Dashboard.model.getStat("tasks_overdue")};
		
		$('#js-task-status-report').css("height", $('#js-task-status-report').width()*0.6);
		var html="<div class='legends -inline'> <div class='legend'><div class='circle' style='background-color:"+(Color.get('success'))+"'></div> "+(Dashboard.model.getStatDisplay('tasks_done_ontime'))+" done ontime</div> <div class='legend'><div class='circle' style='background-color:"+(Color.get('late'))+"'></div> "+(Dashboard.model.getStatDisplay('tasks_done_late'))+" done late</div> <div class='legend'><div class='circle' style='background-color:"+(Color.get('doing'))+"'></div> "+(Dashboard.model.getStatDisplay('tasks_in_progress'))+" in progress</div> <div class='legend'><div class='circle' style='background-color:"+(Color.get('overdue'))+"'></div> "+(Dashboard.model.getStatDisplay('tasks_overdue'))+" overdue</div> </div> <div class='gcount'>"+(Dashboard.model.getStatDisplay('tasks'))+"<em>tasks</em></div>";
		
		$('#js-task-status-report').after(html);
		
		$('#js-task-status-report').highcharts({
			credits: {
				enabled: false
			},
			chart: {
				plotBackgroundColor: null,
				plotBorderWidth: null,
				plotShadow: false,
				type: 'pie',
				backgroundColor:'rgba(255, 255, 255, 0.0)',
			},
			title: {
				text: '',
				style: {fontSize: '13px', fontWeight: 'normal'},
				align: 'center',
				verticalAlign: 'middle',
			},
			tooltip: {
				pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
			},
			plotOptions: {
				pie: {
					allowPointSelect: true,
					cursor: 'pointer',
					dataLabels: {
						enabled: false
					},
					showInLegend: true,
					innerSize: '80%'
				}
			},
			legend:{
				itemStyle:{fontWeight: 'normal', fontSize: '9px'},
				enabled: false,
			},
			series: [{
				name: 'Tasks',
				colorByPoint: true,
				data: [{
					name: "Overdue ("+(stats.overdue)+")",
					y: stats.overdue,
					color: Color.get('overdue')
				},{
					name: "Doing ("+(stats.in_progress)+")",
					y: stats.in_progress,
					color: Color.get('doing')
				}, {
					name: "ht đúng hạn ("+(stats.done_ontime)+")",
					y: stats.done_ontime,
					color: Color.get('success')
				}, {
					name: "ht muộn ("+(stats.done_late)+")",
					y: stats.done_late,
					color: Color.get('late')
				}]
			}]
		});
	};
	
	
	/**
	 * @desc Visualize how late tasks are handled
	 */
	function initTaskLateReport(){
		var overdue=Dashboard.model.getStat("tasks_overdue");
		var active=Dashboard.model.getStat("tasks_active");
		var overdue_percent=0;
		if (active>0){
			overdue_percent=(overdue*100.0/active).toFixed(1);
		}
		
		var done=Dashboard.model.getStat("tasks_done");
		var done_late=Dashboard.model.getStat("tasks_done_late");
		var late_percent=0;
		if (done>0){
			late_percent=(done_late*100.0/done).toFixed(1);
		}
		
		
		$("#js-task-late-report").html("<div class='istats'> <div class='istat'> <div class='percent' data-bg='#e5e5e5' data-percent='"+(overdue_percent)+"' data-text='"+(overdue_percent)+"%'  data-color='"+(Color.get('error'))+"'></div> <div class='stat'> <div class='number'><em style='color:"+(Color.get('error'))+"'>"+(overdue)+"</em></div> <div class='sub'>overdue tasks</div> <div class='sub ap-xdot'>over <em>"+(active)+"</em> active tasks</div> </div> </div> <div class='istat'> <div class='percent' data-bg='#e5e5e5' data-percent='"+(late_percent)+"' data-text='"+(late_percent)+"%' data-color='"+(Color.get('late'))+"'></div> <div class='stat'> <div class='number'><em style='color:"+(Color.get('late'))+"'>"+(done_late)+"</em></div> <div class='sub'>late completed tasks</div> <div class='sub ap-xdot'>over <em>"+(done)+"</em> completed tasks</div> </div> </div> <div class='istat'> <div class='plain'> <span class='icon ficon-exclamation-circle'></span> <b class='js-count' data-key='tasks_no_deadline'></b> tasks are created without deadline </div> </div> </div>");
		
		$("#js-task-late-report .percent").each(function(){
			$(this).angular({
				arc: true
			});
		});
	};
	
	
	
	
	function initTopPerformers(){
		var people=Dashboard.model.getTop("people", 5, function(e){
			if (e.obj && e.obj.id && !e.obj.error){
				return e.stats.done;	
			}
			
			return 0;
		});
		
		var html=AP.render(people, function(p){
			var w=0;
			if (p.stats.total>0){
				w=(p.stats.done*100/p.stats.total).toFixed(1);
			}
			return "<div class='item'> <div class='icon'><div class='avatar'><img src='"+(AP.xthumb(p.obj.gavatar))+"'/></div></div> <div class='name'><span class='url' data-username='"+(p.obj.username)+"'>"+(p.obj.name)+"</span></div> <div class='info'><em>"+(p.stats.done)+"</em>/"+(p.stats.total)+" completed tasks</div> <div class='side'> <div class='bar'> <div class='c' style='width: "+(w)+"%'></div> <div class='txt'>"+(w)+"%</div> </div> </div> </div>";
		});
		
		$("#js-top-performers").html(html);
	};
	
	
	
	function initMemberReport(){
		var html=AP.render(Dashboard.model.people, function(p){
			var w=0;
			if (p.stats.total>0){
				w=(p.stats.done*100/p.stats.total).toFixed(1);
			}
			
			var name=p.obj.name;
			if (p.obj.error){
				name='Unassigned';
			}
			
			return "<div class='item'> <div class='icon'><div class='avatar'><img src='"+(AP.xthumb(p.obj.gavatar))+"'/></div></div> <div class='name'><span class='url' data-username='"+(p.obj.username)+"'>"+(name)+"</span></div> <div class='info'><em>"+(p.stats.total)+"</em> assigned tasks</div> <div class='side'> <div class='col' style='width:100px;'>"+(mbar(p.stats))+"</div> <div class='col' style='width: 60px; padding:2px 0'><em style='color:"+(Color.get('success'))+"'>"+(p.stats.done_ontime)+"</em></div> <div class='col' style='width: 60px; padding:2px 0'><em style='color:"+(Color.get('late'))+"'>"+(p.stats.done_late)+"</em></div> <div class='col' style='width: 60px; padding:2px 0'><em style='color:"+(Color.get('overdue'))+"'>"+(p.stats.overdue)+"</em></div> <div class='col' style='width: 60px; padding:2px 0'><em style='color:"+(Color.get('review'))+"'>"+(p.stats.review)+"</em></div> </div> </div>";
		});
		
		$("#js-members-report").html(html);
		
		// SHOW MOST ACTIVE
		var top_actives=Dashboard.model.getTop("people", 10, function(e){
			if (e.obj && e.obj.id && !e.obj.error){
				return e.stats.active;	
			}
			
			return 0;
		});
		
		
		var html=AP.render(top_actives, function(p){
			var w=0;
			if (p.stats.total>0){
				w=(p.stats.done*100/p.stats.total).toFixed(1);
			}
			return "<div class='item'> <div class='icon'><div class='avatar'><img src='"+(AP.xthumb(p.obj.gavatar))+"'/></div></div> <div class='name'><span class='url' data-username='"+(p.obj.username)+"'>"+(p.obj.name)+"</span></div> <div class='info'><em>"+(p.stats.active)+"</em>/"+(p.stats.total)+" active tasks</div> </div>";
		});
		
		$("#js-members-top-pendings-report").html(html);
		
		
		// SHOW MOST LATE js-members-top-lates-report
		var top_lates=Dashboard.model.getTop("people", 10, function(e){
			if (e.obj && e.obj.id && !e.obj.error){
				return e.stats.done_late + e.stats.overdue;	
			}
			
			return 0;
		});
		
		
		var html=AP.render(top_lates, function(p){
			var w=0;
			if (p.stats.total>0){
				w=(p.stats.done*100/p.stats.total).toFixed(1);
			}
			return "<div class='item'> <div class='icon'><div class='avatar'><img src='"+(AP.xthumb(p.obj.gavatar))+"'/></div></div> <div class='name'><span class='url red' data-username='"+(p.obj.username)+"'>"+(p.obj.name)+"</span></div> <div class='info'><em>"+(p.stats.overdue)+"</em> overdue &middot; "+(p.stats.done_late)+" done late</div> </div>";
		});
		
		$("#js-members-top-lates-report").html(html);
	};	
	
	
	
	function initDailyReport(){
		legends("#js-task-daily-report", [
			{label: "Total tasks", color: "#48856c"},
			{label: "Total in progress", color: Color.get("doing")},
			{label: "Total done", color: Color.get("success")},
			{label: "Total overdue", color: Color.get("overdue")}
		]);
		
		$('#js-task-daily-report').highcharts({
			chart:{
				type: "column"
			},
			credits: {
				enabled: false
			},
			title:{
				style:{
					display : 'none'
				}
			},
			xAxis: {
				categories: Dashboard.model.timeLabels("daily")
			},
			yAxis: {	
				title: {
					text: 'Number of tasks'
				}
			},
			legend: {
				layout: 'vertical',
				align: 'right',
				verticalAlign: 'top',
				float: true
			},
			plotOptions: {
				series: {
					label: {
						connectorAllowed: false
					},
					stacking: 'normal',
					marker: {
						radius: 3
					}
				}
			},	

			series: [{
				name: 'Total tasks created',
				data: Dashboard.model.timeAggregated("daily", "total"),
				color: "#48856c",
				lineWidth: 1,
				showInLegend: false,
				type: "line"
			}, {
				name: 'Task completed',
				data: Dashboard.model.timeAggregated("daily", "done"),
				color: Color.get("success"),
				showInLegend: false
			}, {
				name: 'Task overdue',
				data: Dashboard.model.timeAggregated("daily", "overdue"),
				color: Color.get("overdue"),
				showInLegend: false
			}],
		});
	};
	
	
	
	function initWeeklyReport(){
		var weekly=[{
				name: 'Tasks',
				data: Dashboard.model.timeSeries("weekly", "total")
			}, {
				name: 'In progress',
				data: Dashboard.model.timeSeries("weekly", "in_progress")
			}, {
				name: 'Done',
				data: Dashboard.model.timeSeries("weekly", "done")
			}, {
				name: 'Overdue',
				data: Dashboard.model.timeSeries("weekly", "overdue")
			}
		];
			
			
		$('#js-task-weekly-report').highcharts({
			chart: {
				type: 'column'
			},
			title:{
				style:{
					display : 'none'
				}
			},
			xAxis: {
				categories: Dashboard.model.timeLabels("weekly", 6),
				tickInterval: Math.floor(Dashboard.model.weekly.length/6)
			},
			yAxis: {
				title: {
					text: 'Number of tasks'
				}
			},
			credits: {
				enabled: false
			},
			series: weekly
		});
	};
	
	
	
	
	function initProjectReport(){
		$("#js-report-projects").html(AP.render(Dashboard.model.projects, function(e){
			if (!e.obj){
				return "";
			}
			
			var icon="<img src='"+(Client.share_url)+"/fav_icons/"+(e.obj.icon)+".png'/>";
			
			if (!e.obj.icon){
				icon=UI.textAvatar(e.obj.path);
			}
			
			var content=safe(e.obj.content);
			if (!content){
				content="No description";
			}
			
			
			var range=AP.i18n.range(e.obj.stime, e.obj.etime)+ " &middot; ";
			if (e.obj.metatype!="project"){
				range="";
			}
			
			if (!e.obj.stime && !e.obj.etime){
				range="";
			}
			
			return "<tr> <td> <div class='wrapper' style='height:40px;'> <div class='obj'> <div class='icon'>"+(icon)+"</div> <div class='name ap-xdot url' data-url='"+(e.obj.path)+"'><span class='url'>"+(e.obj.name)+"</span></div> <div class='info ap-xdot'><span class='upper'>"+(e.obj.metatype)+"</span> &middot; "+(range)+" "+(content)+"</div> </div> </div> </td> <td><span class='count'>"+(e.stats.total)+"</span></td> <td><span class='count' style='color:"+(Color.get('success'))+"'>"+(e.stats.done)+"</span></td> <td><span class='count' style='color:"+(Color.get('overdue'))+"'>"+(e.stats.overdue)+"</span></td> <td><span class='count' style='color:"+(Color.get('review'))+"'>"+(e.stats.review)+"</span></td> <td> <div class='relative'> "+(mbar(e.stats,true))+" </div> </td> </tr>";
		}));
		
		
		var overdue_percent=10;
		var late_percent=10;
		var active=10;
		var overdue=10;
		var done=10;
		var done_late=10;
		
		$("#js-team-report").html("<div class='grid-stats'> <div class='stat' style='height:auto;'> <div class='v js-count' data-key='real_teams_active'></div> <div class='sub -upper'>active teams</div> <span class='sub'><b class='js-count text-8' data-key='real_teams_closed'></b> teams are closed</span> </div> <div class='stat' style='height:auto;'> <div class='v js-count' data-key='tasks_team'></div> <div class='sub -upper'>tasks in teams</div> <span class='sub'><b class='js-count text-success' data-key='tasks_team_done'></b> done &middot; <b class='js-count text-error' data-key='tasks_team_overdue'></b> overdue</span> </div> </div>");
		
		$("#js-task-late-report .percent").each(function(){
			$(this).angular({
				arc: true
			});
		});
		
		
		$("#js-project-status").html("<div class='split-view'> <div class='graph' id='js-project-state-graph'></div> <div class='main'> <div class='title'><b class='js-count' data-key='real_projects'></b> projects</div> <div class='legends'> <div class='legend'><div class='circle' style='background-color:"+(Color.get('ontrack'))+"'></div> "+(Dashboard.model.getStat('projects_ontrack'))+" on track</div> <div class='legend'><div class='circle' style='background-color:"+(Color.get('offtrack'))+"'></div> "+(Dashboard.model.getStat('projects_offtrack'))+" off track</div> <div class='legend'><div class='circle' style='background-color:"+(Color.get('atrisk'))+"'></div> "+(Dashboard.model.getStat('projects_atrisk'))+" at risk</div> <div class='legend'><div class='circle' style='background-color:"+(Color.get('success'))+"'></div> "+(Dashboard.model.getStat('projects_success'))+" closed & successful</div> <div class='legend'><div class='circle' style='background-color:"+(Color.get('failed'))+"'></div> "+(Dashboard.model.getStat('projects_failed'))+" closed & failed</div> <div class='legend'><div class='circle' style='background-color:"+(Color.get('canceled'))+"'></div> "+(Dashboard.model.getStat('projects_canceled'))+" closed & cancel</div> </div> </div> </div>");
		
		$('#js-project-state-graph').highcharts({
			credits: {
				enabled: false
			},
			chart: {
				plotBackgroundColor: null,
				plotBorderWidth: null,
				plotShadow: false,
				type: 'pie',
				backgroundColor:'rgba(255, 255, 255, 0.0)',
			},
			title: {
				text: '',
				style: {fontSize: '13px', fontWeight: 'normal'},
				align: 'center',
				verticalAlign: 'middle',
			},
			tooltip: {
				pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
			},
			plotOptions: {
				pie: {
					allowPointSelect: true,
					cursor: 'pointer',
					dataLabels: {
						enabled: false
					},
					showInLegend: true,
					innerSize:"80%"
				}
			},
			legend:{
				itemStyle:{fontWeight: 'normal', fontSize: '9px'},
				enabled: false,
			},
			series: [{
				name: 'Projects',
				colorByPoint: true,
				data: [{
					name: "On track",
					y: Dashboard.model.getStat("projects_ontrack"),
					color: Color.get('ontrack')
				},{
					name: "Off track",
					y: Dashboard.model.getStat("projects_offtrack"),
					color: Color.get('offtrack')
				}, {
					name: "At risk",
					y: Dashboard.model.getStat("projects_atrisk"),
					color: Color.get('atrisk')
				},{
					name: "Closed & successful",
					y: Dashboard.model.getStat("projects_success"),
					color: Color.get('success')
				},{
					name: "Closed & failed",
					y: Dashboard.model.getStat("projects_failed"),
					color: Color.get('failed')
				}, {
					name: "Closed & canceled",
					y: Dashboard.model.getStat("projects_canceled"),
					color: Color.get('canceled')
				}]
			}]
		});
	};
	
	
	
	function initDeptReport(){
		$("#js-dept-report").html(AP.render(Dashboard.model.depts, function(e){
			var icon=UI.textAvatar(e.obj.path);
			
			var content=safe(e.obj.content);
			if (!content){
				content="No description";
			}
			
			return "<tr> <td> <div class='wrapper' style='height:40px;'> <div class='obj'> <div class='icon'>"+(icon)+"</div> <div class='name ap-xdot url' data-url='"+(e.obj.path)+"'><span class='url'>"+(e.obj.name)+"</span></div> <div class='info ap-xdot'><em>Department</em> &middot; "+(e.stats.total)+" projects &amp; teams</div> </div> </div> </td> <td><span class='count'>"+(e.stats.total)+"</span></td> <td><span class='count' style='color:"+(Color.get('success'))+"'>"+(e.stats.done)+"</span></td> <td><span class='count' style='color:"+(Color.get('overdue'))+"'>"+(e.stats.overdue)+"</span></td> <td><span class='count' style='color:"+(Color.get('review'))+"'>"+(e.stats.review)+"</span></td> <td> <div class='relative'> "+(mbar(e.stats,true))+" </div> </td> </tr>";
		}));
		
		
		var series=[{
			name: 'Tasks',
			data: Dashboard.model.timeSeries("depts", "total")
		}, {
			name: 'In progress',
			data: Dashboard.model.timeSeries("depts", "in_progress")
		}, {
			name: 'Done',
			data: Dashboard.model.timeSeries("depts", "done")
		}, {
			name: 'Overdue',
			data: Dashboard.model.timeSeries("depts", "overdue")
		}, {
			name: 'In review',
			data: Dashboard.model.timeAggregated("depts", "review")
		}
	];
		
		$('#js-dept-task-allocation').highcharts({
			chart: {
				type: 'column'
			},
			title: {
				text: '',
				style:{
					display:"none"
				}
			},
			xAxis: {
				categories: Dashboard.model.labels("depts")
			},
			yAxis: {
				title: {
					text: 'Number of tasks'
				}
			},
			credits: {
				enabled: false
			},
			series: series
		});
	};
	
	
	/**
	 * @desc Init milestone reports
	 */
	function initMilestoneReport(){
		$("#js-milestones-report").html(AP.render(Dashboard.model.milestones, function(e){
			if (!e.obj || !parseInt(e.obj.id)){
				return "";
			}
			
			var icon=UI.textAvatar(e.obj.name);
			var content=safe(e.obj.content);
			if (!content){
				content="No description";
			}
			
			var u=People.get(e.obj.user_id);
			var color="#999";
			var complete=e.obj.complete;
			
			if (parseInt(e.obj.time)>AP.time.now()){
				color=Color.get("doing");
				
				if (parseFloat(complete)>=80){
					color=Color.get("done");	
				}
			}else{
				if (parseFloat(complete)<=50){
					color=Color.get("error");	
				}else if (parseFloat(complete)>=80){
					color=Color.get("done");	
				}
			}
			
			return "<tr> <td> <div class='wrapper' style='height:40px;'> <div class='obj'> <div class='icon'> <div class='js-percent' style='width:32px; height:32px;' data-text='"+(parseFloat(complete).toFixed(0))+"%' data-percent='"+(complete)+"' data-color='"+(color)+"'></div> </div> <div class='name ap-xdot url' data-url='milestone/"+(e.obj.id)+"'><span class='url'>"+(e.obj.name)+"</span></div> <div class='info ap-xdot'>"+(content)+"</div> </div> </div> </td> <td> <div class='wrapper' style='height:40px;'> <div class='obj'> <div class='icon'><div class='avatar'><img src='"+(AP.thumb(u.gavatar))+"'/></div></div> <div class='name ap-xdot'><span class='url ap-f13' data-username='"+(u.username)+"'>"+(u.name)+"</span></div> <div class='info ap-xdot'>"+(u.title)+"</div> </div> </td> <td> <span class='icon-base-increase'></span> <span class='count' style='color:"+(Color.get('success'))+"'>+"+(e.stats.done)+"</span>/<span class='count normal'>"+(e.stats.total)+"</span> </td> <td><div class='date' style='padding-top:3px; font-weight:500; color:"+(color)+"'>"+(AP.i18n.date(e.obj.time))+"</div></td> </tr>";
		}));
		
		$("#js-milestones-report .js-percent").each(function(){
			$(this).angular({
				arc: true,
				bg: "#eee"
			});
		});
		
		
		
		var stats={done_ontime: Dashboard.model.getStat("tasks_done_ontime"), done_late: Dashboard.model.getStat("tasks_done_late"), in_progress: Dashboard.model.getStat("tasks_in_progress"), overdue: Dashboard.model.getStat("tasks_overdue")};
		
		$('#js-milestone-depts').css("height", $('#js-milestone-depts').width()*1.0);
		var data=AP.array.select(Dashboard.model.depts, function(e){
			return {name: e.obj.name+" ("+e.stats.milestones+" milestones)", y: e.stats.milestones};
		});
		
		$('#js-milestone-depts').highcharts({
			credits: {
				enabled: false
			},
			chart: {
				plotBackgroundColor: null,
				plotBorderWidth: null,
				plotShadow: false,
				type: 'pie',
				backgroundColor:'rgba(255, 255, 255, 0.0)',
			},
			title: {
				text: '',
				style: {fontSize: '13px', fontWeight: 'normal'},
				align: 'center',
				verticalAlign: 'middle',
				style: {
					display:'none'
				}
			},
			tooltip: {
				pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
			},
			plotOptions: {
				pie: {
					allowPointSelect: true,
					cursor: 'pointer',
					dataLabels: {
						enabled: false
					},
					showInLegend: true
				}
			},
			legend:{
				itemStyle:{fontWeight: 'normal', fontSize: '11px'},
				enabled: true,
			},
			series: [{
				name: 'Milestones',
				colorByPoint: true,
				data: data
			}]
		});
		
		
		var top_finishers=[];
		var people={};
		var depts={};
		
		for (var i=0; i<Dashboard.model.milestones.length; i++){
			var m=Dashboard.model.milestones[i];
			if (!m.obj){
				continue;
			}
			
			if (!people["k"+m.obj.user_id]){
				people["k"+m.obj.user_id]={id: m.obj.user_id, count:1, total: parseFloat(m.obj.complete)};
			}else{
				people["k"+m.obj.user_id].count++;
				people["k"+m.obj.user_id].total+=parseFloat(m.obj.complete);
			}
		}
		
		for (var key in people){
			people[key].user=People.get(people[key].id);
			people[key].avg_complete=0;
			if (people[key].count){
				people[key].avg_complete=people[key].total/people[key].count;
			}
			top_finishers.push(people[key]);
		}
		
		top_finishers.sort(function(e, f){
			return f.avg_complete-e.avg_complete;
		});
		
		$("#js-top-milestone-finishers").html(AP.render(top_finishers, function(e, index){
			if (index>=5){
				return "";
			}
			
			return "<div class='item'> <div class='icon'><div class='avatar'><img src='"+(AP.xthumb(e.user.gavatar))+"'/></div></div> <div class='name'><span class='url' data-username='"+(e.user.username)+"'>"+(e.user.name)+"</span></div> <div class='info'><em>"+(e.count)+"</em> milestones in charged</div> <div class='info'><em>"+(e.avg_complete.toFixed(1))+"</em>% completed</div> </div>";
		}));
	};
	
	
	
	function initTagCloud(){
		var data=AP.array.select(Dashboard.model.tags, function(e){
			return {name: e.id, weight: e.tasks.length};
		});	
		
		
		$("#js-task-tagcloud").highcharts({
			plotOptions:{
				wordcloud:{
					minFontSize: 5,
					style: {
						fontWeight:500
					}
				}
			},
			series: [{
				type: 'wordcloud',
				data: data,
				name: 'Tasks',
				rotation: {
					from: -60,
					to: 60,
					orientations: 5
				},
			}],
			title: {
				text: '',
				style:{
					display: "none"
				}
			}
		});
	};
	
	
	
	function initGridStats(){
		var html="<div class='note'>Only tasks will reported duration are measured</div> <div class='stat'> <div class='v'>"+(Dashboard.avg.weeklyTasks())+"</div> <span class='sub'>Avg. tasks created</span> <span>per week</span> </div> <div class='stat'> <div class='v'>"+(Dashboard.avg.weeklyPersonalTasks())+"</div> <span class='sub'>Avg. tasks per weekly</span> <span>per person</span> </div> <div class='stat'> <div class='v'>"+(Dashboard.avg.projectTasks())+"</div> <span class='sub'>Avg. number of tasks</span> <span>per project</span> </div> <div class='stat'> <div class='v'>"+(Dashboard.model.getStatDisplay('comments'))+"</div> <span class='sub'>Total number of </span> <span>comments</span> </div>";
		
		$("#js-grid-stats").html(html);
	}
	
	
	
	function initWorkloadReport(){
		var html=AP.render(Dashboard.model.people, function(p){
			if (!p.obj){
				return "";
			}
			
			return "<div class='item'> <div class='icon'><div class='avatar'><img src='"+(AP.xthumb(p.obj.gavatar))+"'/></div></div> <div class='name'><span class='url' data-username='"+(p.obj.username)+"'>"+(p.obj.name)+"</span></div> <div class='info'>"+(p.stats.reported_total)+" reported tasks</div> <div class='side'> <div class='bigcount'>"+(AP.data.numberFormat(p.stats.duration/3600))+"<span>h</span></div> </div> </div>";
		});
		
		$("#js-report-workloads").html("<div class='list'>"+(html)+"</div>");
		
		
		
		html=AP.render(Dashboard.model.projects, function(p){
			if (!p.obj){
				return "";
			}
			
			return "<div class='item'> <div class='icon'>"+(getIcon(p))+"</div> <div class='name'><span class='url' data-url='"+(p.obj.path)+"'>"+(p.obj.name)+"</span></div> <div class='info'>"+(p.stats.reported_total)+" reported tasks</div> <div class='side'> <div class='bigcount'>"+(AP.data.numberFormat(p.stats.duration/3600))+"<span>h</span></div> </div> </div>";
		});
		
		$("#js-report-project-workloads").html("<div class='list'>"+(html)+"</div>");
		
		
		
		
		html=AP.render(Dashboard.model.milestones, function(p){
			if (!p.obj){
				return "";
			}
			
			return "<div class='item'> <div class='icon'></div> <div class='name'><span class='url' data-url='milestone/"+(p.obj.id)+"'>"+(p.obj.name)+"</span></div> <div class='info'>"+(p.stats.reported_total)+" reported tasks</div> <div class='side'> <div class='bigcount'>"+(AP.data.numberFormat(p.stats.duration/3600))+"<span>h</span></div> </div> </div>";
		});
		
		$("#js-report-ms-workloads").html("<div class='list'>"+(html)+"</div>");
		
		
		
		// INIT WORKLOAD BY DEPARTMENTS
		
		var data=AP.select(Dashboard.model.depts, function(e){
			return {name: e.obj.name+ ": "+(AP.data.numberFormat(e.stats.duration/3600))+"h", y: e.stats.duration}
		});
				
		$('#js-report-dept-workloads .graph').css("height", $('#js-report-dept-workloads').width()*1.0).highcharts({
			credits: {
				enabled: false
			},
			chart: {
				plotBackgroundColor: null,
				plotBorderWidth: null,
				plotShadow: false,
				type: 'pie',
				backgroundColor:'rgba(255, 255, 255, 0.0)',
			},
			title: {
				text: '',
				style: {fontSize: '13px', fontWeight: 'normal'},
				align: 'center',
				verticalAlign: 'middle',
			},
			tooltip: {
				pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
			},
			plotOptions: {
				pie: {
					allowPointSelect: true,
					cursor: 'pointer',
					dataLabels: {
						enabled: false
					},
					showInLegend: true
				},
			},
			legend:{
				itemStyle:{fontWeight: 'normal', fontSize: '12px'},
			},
			series: [{
				name: 'Reported hours',
				colorByPoint: true,
				data: data
			}]
		});
		
		
	};
	
	
	
	
	
	function legends(id, labels){
		var labels_html=AP.render(labels, function(e){
			return "<div class='legend'><span class='dot' style='background-color:"+(e.color)+"'></span> "+(e.label)+"</div>";
		});
		
		$(id).closest(".box").find(".header .side").append("<div class='ilegends'>"+(labels_html)+"</div>");
	};
	
	
	
	function mbar(stats, soft){
		var percent_in_progress=0;
		var percent_overdue=10;
		var percent_done_ontime=0;
		var percent_done_late=0;
		
		if (stats.total>0){
			percent_overdue=stats.overdue*100/stats.total;
			percent_in_progress=stats.in_progress*100/stats.total;
			percent_done_ontime=stats.done_ontime*100/stats.total;
			percent_done_late=stats.done_late*100/stats.total;
		}
		
		if (soft){
			return "<div class='mbar clear-fix -soft'> <div class='b -infow' style='width:"+(percent_done_ontime)+"%; background-color:#8fc79c;'>"+(explain('Done ontime: '+stats.done_ontime,true))+"</div> <div class='b -infow' style='width:"+(percent_done_late)+"%; background-color:#dbd491;'>"+(explain('Done late: '+stats.done_late,true))+"</div> <div class='b -infow' style='width:"+(percent_overdue)+"%; background-color:#d1837d;'>"+(explain('Overdue: '+stats.overdue,true))+"</div> <div class='b -infow' style='width:"+(percent_in_progress)+"%; background-color:#a8d3f0;'>"+(explain('In progress: '+stats.in_progress,true))+"</div> </div>";
		}
		
		return "<div class='mbar clear-fix'> <div class='b -infow' style='width:"+(percent_done_ontime)+"%; background-color:"+(Color.get('success'))+";'>"+(explain('Done ontime: '+stats.done_ontime,true))+"</div> <div class='b -infow' style='width:"+(percent_done_late)+"%; background-color:"+(Color.get('late'))+";'>"+(explain('Done late: '+stats.done_late,true))+"</div> <div class='b -infow' style='width:"+(percent_overdue)+"%; background-color:"+(Color.get('overdue'))+";'>"+(explain('Overdue: '+stats.overdue,true))+"</div> <div class='b -infow' style='width:"+(percent_in_progress)+"%; background-color:"+(Color.get('doing'))+";'>"+(explain('In progress: '+stats.in_progress,true))+"</div> </div>";
	};
	
	
	
	function getIcon(e){
		if (!e.obj){
			return UI.textAvatar(e.id);
		}
		
		var icon="<img src='"+(Client.share_url)+"/fav_icons/"+(e.obj.icon)+".png'/>";
		
		if (!e.obj.icon){
			icon=UI.textAvatar(e.obj.path);
		}
		
		return icon;
	};
	
};


Dashboard.model=new function __DashboardModel(){
	this._people={};
	this._assigners={};
	this._projects={};
	this._milestones={};
	this._dept={};
	this._daily={};
	this._weekly={};
	this._tags={};
	
	this.stats={};
	
	
	/**
	 * @desc Init data model, require O(n) operation
	 */
	this.init=function(){
		this._people={};
		this._assigners={};
		this._projects={};
		this._depts={};
		this._milestones={};
		this._dept={};
		
		this._daily={};
		this._weekly={};
		this._tags={};
		
		this.stats={};
		
		this.initFinder("projects", Client.pageData.projects);
		this.initFinder("depts", Client.depts);
		this.initFinder("milestones", Client.pageData.milestones);
		
		for (var i=0; i<Client.pageData.tasks.length; i++){
			var task=Client.pageData.tasks[i];
			
			task.project=this.get("projects", task.project_id);
			if (task.project){
				task.dept=this.get("depts", task.project.dept_id);
			}
			
			if (task.project && task.project.metatype=="project"){
				this.increase("tasks_project", 1);
			}else if (task.project && task.project.metatype=="team"){
				this.increase("tasks_team", 1);
				if (parseInt(task.status)){
					this.increase("tasks_team_done", 1);	
				}else if (Compute.overdue(task)){
					this.increase("tasks_team_overdue", 1);
				}
			}
			
			this.put(task, "people", task.user_id);
			this.put(task, "projects", task.project_id);
			this.put(task, "milestones", task.milestone_id);
			this.put(task, "assigners", task.creator_id);
			
			this.put(task, "daily", AP.time.beginOfDay(task.since));
			this.put(task, "weekly", AP.time.beginOfWeek(task.since));
			
			
			if (task.dept){
				this.put(task, "depts", task.dept.id);
			}
			
			this.increase("tasks", 1);
			var state=Task.ui.grandState(task);
			
			if (parseInt(task.status)){
				this.increase("tasks_done", 1);
			}else{
				this.increase("tasks_active", 1);
			}
			
			if (!parseInt(task.deadline)){
				this.increase("tasks_no_deadline", 1);
			}
			
			if (state=="todo"){
				this.increase("tasks_todo", 1);
			}else if (state=="doing"){
				this.increase("tasks_doing", 1);
			}else{
				if (Compute.doneLate(task)){
					this.increase("tasks_done_late", 1);
				}else{
					this.increase("tasks_done_ontime", 1);
				}
			}
			
			
			if (parseInt(task.urgent) && !parseInt(task.important)){
				this.increase("esn_10", 1)
			}else if (!parseInt(task.urgent) && parseInt(task.important)){
				this.increase("esn_01", 1)
			}else if (parseInt(task.urgent) && parseInt(task.important)){
				this.increase("esn_11", 1)
			}else{
				this.increase("esn_00", 1)
			}
			
			if (parseInt(task.review)){
				this.increase("tasks_review", 1);
				if (Compute.overdue(task)){
					this.increase("tasks_review_overdue", 1);
				}
			}
			
			if (Compute.overdue(task)){
				this.increase("tasks_overdue", 1);
			}else if (!parseInt(task.status)){
				this.increase("tasks_in_progress", 1);
			}
			
			this.increase("comments", task.stats.comments);
			
			for (var j=0; j<task.tags.length; j++){
				this.put(task, "tags", task.tags[j]);
			}
			
			if (parseInt(task.duration)){
				this.increase("tasks_reported");
				this.increase("tasks_duration", parseInt(task.duration));
			}
		}
		
		
		
		// Custom stats
		for (var k in this._milestones){
			var m=this._milestones[k];
			var obj=Dashboard.model.get("milestones", m.key);
			if (obj){
				this.customIncrease("depts", obj.dept_id, "milestones");
				this.customIncrease("people", obj.user_id, "milestones");	
			}
		}
		
		
		// Flatten data
		this.flatten("people", function(id){
			return People.get(id);
		});
		
		this.flatten("projects", function(id){
			return Dashboard.model.get("projects",id);
		});
		
		this.flatten("milestones", function(id){
			return Dashboard.model.get("milestones",id);
		});
		
		this.flatten("depts", function(id){
			return Dashboard.model.get("depts",id);
		});

		this.flatten("tags", function(id){
			return {id: id, label: id};
		});
		
		
		
		this.flatten("daily", function(id){
			return {id: parseInt(id)};
		});
		
		this.fillup("daily");
		
		this.flatten("weekly", function(id){
			return {id: parseInt(id)};
		});
		
		this.fillup("weekly", 7);
		
		
		
		
		
		
		// COMPUTE COUNTERS
		this.set("milestones", this.milestones.length);
		this.set("people", AP.array.count(this.people, function(e){
			return e.obj && !e.obj.error;
		}));
		
		
		for (var i=0; i<this.projects.length; i++){
			var p=this.projects[i].obj;
			if (!p || p.metatype!="project"){
				continue;
			}
			
			this.increase("real_projects");
			if (!parseInt(p.external)){
				this.increase("real_projects_internal");
			}else{
				this.increase("real_projects_external");
			}
			
			if (!parseInt(p.status)){
				if (p.stage=="offtrack"){
					this.increase("projects_offtrack");
				}else if (p.stage=="atrisk"){
					this.increase("projects_atrisk");
				}else{
					this.increase("projects_ontrack");
				}
			}else{
				if (p.stage=="failed"){
					this.increase("projects_failed");
				}else if (p.stage=="success"){
					this.increase("projects_success");
				}else if (p.stage=="canceled"){
					this.increase("projects_canceled");
				}else{
					this.increase("projects_closed");
				}
			}
		}
		
		
		
		this.set("real_teams", AP.array.count(this.projects, function(e){
			return e.obj && e.obj.metatype=="team";
		}));
		
		this.set("real_teams_internal", AP.array.count(this.projects, function(e){
			return e.obj && e.obj.metatype=="team" && !parseInt(e.obj.external);
		}));
		
		this.set("real_teams_external", AP.array.count(this.projects, function(e){
			return e.obj && e.obj.metatype=="team" && parseInt(e.obj.external);
		}));
		
		this.set("real_teams_active", AP.array.count(this.projects, function(e){
			return e.obj && e.obj.metatype=="team" && parseInt(e.obj.status)==0;
		}));
		
		this.set("real_teams_closed", AP.array.count(this.projects, function(e){
			return e.obj && e.obj.metatype=="team" && parseInt(e.obj.status)==-1;
		}));
		this.set("people_internal", AP.array.count(this.people, function(e){
			return e.obj && !e.obj.error && e.obj.metatype!="guest";
		}));
		
		this.set("people_guest", AP.array.count(this.people, function(e){
			return e.obj && !e.obj.error && e.obj.metatype=="guest";
		}));
		
		this.set("projects", this.projects.length);
		this.set("projects_require_review", AP.array.count(this.projects, function(e){
			return e.obj && parseInt(e.obj.review_enabled);
		}));
		
		
		
		// Resort for friendlier display
		this.people.sort(function(e,f){
			if (!parseInt(f.obj.id)){
				return -1;
			}
			
			if (!parseInt(e.obj.id)){
				return 1;
			}
			
			return f.tasks.length-e.tasks.length;
		});
		
		this.projects.sort(function(e,f){
			return f.tasks.length-e.tasks.length;
		});
		
		this.milestones.sort(function(e,f){
			if (e.obj && f.obj){
				return parseInt(f.obj.time)-parseInt(e.obj.time);	
			}
			
			return 0;
		});
		
		
		// Fix for local stats
		this.stats.tasks_duration=(this.getStat("tasks_duration")/3600).toFixed(1)
		this.stats.tasks_unreported=this.getStat("tasks")-this.getStat("tasks_reported");
		if (Client.pageData.context && this.daily.length){
			this.stats.project_days=(this.daily[this.daily.length-1].id-this.daily[0].id)/(24*3600)+1;
			var holidays=0;
			var starter=this.daily[0].id;
			while (true){
				var test = new Date(starter*1000);
				if (test.getDay()==6 || test.getDay()==0){
					holidays++;
				}
				
				starter+=24*3600;
				if (starter>=this.daily[this.daily.length-1].id || holidays>=1000){
					break;
				}
			}
			
			this.stats.project_holidays=holidays;
			this.stats.project_working_days=this.stats.project_days-holidays;
		}
	};
	
	
	/**
	 * @desc Getting stat about a key
	 */
	this.getStat=function(key){
		if (this.stats[key]){
			return this.stats[key];
		}
		
		return 0;
	};
	
	
	this.getStatDisplay=function(key){
		return AP.data.numberFormat(this.getStat(key));
	};
	
	
	this.getTop=function(set, limit, cmp){
		var chosen={};
		
		for (var i=0; i<limit; i++){
			var max=-10000;
			var found=-1;
			
			for (var j=0; j<this[set].length; j++){
				if (chosen["k"+j]){
					continue;
				}
				
				var temp=cmp(this[set][j]);
				if (!temp){
					continue;
				}
				
				if (temp>max){
					max=temp;
					found=j;
				}
			}
			
			if (found>-1){
				chosen["k"+found]=found+1;
			}
			
		}
		
		
		var r=[];
		for (var key in chosen){
			r.push(this[set][chosen[key]-1]);
		}
		
		return r;
	};
	
	
	
	
	this.put=function(task, key, value){
		if (this["_"+key]["k"+value]){
			this["_"+key]["k"+value].tasks.push(task);
		}else{
			this["_"+key]["k"+value]={key: value, tasks: [task], stats: {milestones: 0}};
		}
	};
	
	
	
	this.flatten=function(key, getter){
		var r=[];
		
		for (var index in this["_"+key]){
			var objkey = this["_"+key][index].key;
			
			if (parseInt(objkey)) {
				var objreal=getter(objkey);
				var obj={id: objkey, obj: objreal, stats: getStats(this["_"+key][index].tasks), tasks: this["_"+key][index].tasks};
				
				for (var rk in this["_"+key][index].stats){
					obj.stats[rk]=this["_"+key][index].stats[rk];
				}
				
				r.push(obj);
			}
		}
		
		this[key]=r;
		return r;
	};
	
	
	/**
	 * @desc Fill in the gap betweens missing date
	 */
	this.fillup=function(key, space){
		if (!space){
			space=1;
		}
		
		this[key].sort(function(e,f){
			return f.id - e.id;
		});
		
		if (!this[key].length){
			return;
		}
		
		this[key]=this[key].reverse();
		return;
		
		
		
		var count=0;
		var cur_ts=this[key][0].id;
		var cur_index=1;
		
		var r=[this[key][0]];
		
		while (true){
			if (cur_index>=this[key].length){
				break;
			}
			
			cur_ts=cur_ts-space*24*3600;
			
			if (cur_ts>this[key][cur_index].id){
				r.push({id: cur_ts, obj: {id: cur_ts}, tasks: [], stats: emptyStats()});
				count++;
			}else if (cur_ts==this[key][cur_index].id){
				r.push(this[key][cur_index]);
				cur_index++;
			}else{
				break; // ERROR - should not be here
			}
			
			if (count>180){
				break;
			}
		}
		
		this[key]=r.reverse();
	};
	
	
	
	this.increase=function(key, val){
		if (!val){
			val=1;
		}
		
		if (this.stats[key]){
			this.stats[key]+=val;
		}else{
			this.stats[key]=val;
		}
	};
	
	
	this.set=function(key, val){
		if (!val){
			val=0;
		}
		
		this.stats[key]=val;
	};
	
	
	
	/**
	 * @desc Increase a stat $sat for a set $set
	 */
	this.customIncrease=function(set, id, stat){
		if (this["_"+set]["k"+id]){
			this["_"+set]["k"+id].stats[stat]++;;
		}
	};
	
	
	
	/**
	 * @desc Init cache for O(1) finders
	 */
	this.initFinder=function(key, arr){
		this["__"+key]={};
		for (var i=0; i<arr.length; i++){
			this["__"+key]["k"+arr[i].id]=arr[i];
		}
	};
	
	
	this.get=function(key, id){
		if (this["__"+key] && this["__"+key]["k"+id]){
			return this["__"+key]["k"+id];
		}
		
		return null;
	};
	
	
	/**
	 * @desc Build up a time series
	 */
	this.timeSeries=function(key, field){
		var r=[];
		for (var i=0; i<this[key].length; i++){
			var val=this[key][i].stats[field];
			r.push(val);
		}
		
		return r;
	};
	
	
	/**
	 * @desc Build up an aggregating series
	 */
	this.timeAggregated=function(key, field){
		var r=[];
		var cur=0;
		
		for (var i=0; i<this[key].length; i++){
			var val=this[key][i].stats[field];
			cur+=val;
			r.push(cur);
		}
		
		return r;
	};
	
	
	this.timeLabels=function(key, space){
		var r=[];
		for (var i=0; i<this[key].length; i++){
			if (space){
				r.push(AP.time.time("%d", this[key][i].id)+"-"+AP.time.time("%d/%m", this[key][i].id+space*24*3600));	
			}else{
				r.push(AP.time.time("%d/%m", this[key][i].id));
			}
		}
		
		return r;
	};
	
	
	/**
	 * @desc Simple label collectors
	 */
	this.labels=function(key){
		var r=[];
		for (var i=0; i<this[key].length; i++){
			if (!this[key][i].obj){
				r.push("Not specified");
			}else{
				r.push(this[key][i].obj.name);	
			}
		}
		
		return r;
	};
	
	
	function count(obj){
		var total=0;
		for (var key in obj){
			total++;
		}
		
		return total;
	};
	
	
	
	function getStats(tasks){
		var stats=emptyStats();
		stats.total=tasks.length;
		
		for (var i=0; i<tasks.length; i++){
			var task=tasks[i];
			var is_done=(parseInt(task.status)==1);
			var state=Task.ui.grandState(task);
			
			if (is_done){
				stats.done++;
				if (Compute.doneLate(task)){
					stats.done_late++;
				}else{
					stats.done_ontime++;
				}
			}else{
				stats.active++;
				if (state=="todo"){
					stats.todo++;
				}else{
					stats.doing++;
				}
				
				if (parseInt(task.review)){
					stats.review++;
				}
				
				if (Compute.overdue(task)){
					stats.overdue++;
				}else{
					stats.in_progress++;
				}
			}
			
			stats.duration+=parseFloat(task.duration);
			if (parseFloat(task.duration)>0.01){
				stats.reported_total++;
			}
		}
		
		return stats;
	};
	
	
	function emptyStats(){
		return {total: 0, reported_total:0, done: 0, done_late:0, done_ontime:0, in_progress:0, overdue:0, todo:0, doing:0, active: 0, review:0, duration: 0};
	}
};


Dashboard.avg=new function __DashboardAVG(){
	this.weeklyTasks=function(){
		var total=0;
		for (var i=0; i<Dashboard.model.daily.length; i++){
			total+=Dashboard.model.daily[i].stats.total;
		}
		
		return (7*total/Dashboard.model.daily.length).toFixed(1);
	};
	
	
	this.weeklyPersonalTasks=function(){
		var people=AP.array.filter(Dashboard.model.people, function(e){
			return e.obj && e.obj.id;
		});
		
		if (!people.length){
			return 0;
		}
		
		
		return (this.weeklyTasks()/people.length).toFixed(1);
	};
	
	
	this.projectTasks=function(){
		if (!Dashboard.model.stats.real_projects){
			return 0;
		}
		
		return (Dashboard.model.stats.tasks_project/Dashboard.model.stats.real_projects).toFixed(1);
	};
	
	
	this.teamWeeklyTasks=function(){
		return 0;
	};
	
	this.weeklyWorkload=function(){
		return 0;
	};
	
	this.medianWeeklyWorkload=function(){
		return 0;
	};
	
	
	
	function median(set, key){
		return 0;
	};
	
};

var Drive=new function __Drive(){
};




Drive.folder=new function __DriveFolder(){	
	this.pendingPaste={};

	this.create = function() {
		var folder_id = Client.pageData.folder ? Client.pageData.folder.id : 0;
		var data = {sysid: Client.pageData.project.id, folder_id: folder_id};

		var form = Form.create('fly-proj-addfolder-fx',{'action': "api/base/file/folder/create"})
			.row(
				Form.label({label: "Tên thư mục"}),
				Form.input({name: 'name', "placeholder":"Tên thư mục"}).autoSubmit()
			)
			.buttons([
				{label: "Thêm thư mục", action: function(){
					Form.submit("#fly-proj-addfolder-fx", function(code){
						if (!code.good()){
							return AP.alertError(code.message);
						}

						Form.hide("fly-proj-addfolder-fx");
						UI.flash("Đã thêm thư mục...");
						AP.xRefresh();
					})
				}, style: 'ok -success -rounded bold'},
				{label: "Hủy", action: function(){
					Form.hide("fly-proj-addfolder-fx");
				}, style:'cancel -passive-2 -rounded'}
			]).hiddens(data);

		Form.pop({width: 480, label: 'Thêm thư mục trong dự án', layout: "flat"}).setForm(form).show().focus('name');
	};

	
	/**
	 * @desc Edit a folder
	 */
	this.edit=function(ref){
		var folder=getFolder(ref);
		if (!folder){
			return;
		}
		
		var hiddens={id: folder.id, token: folder.token};
	
		var form=Form.create('tree-node-fx',{action: 'api/base/file/folder/edit'})
		.row(
			Form.label({label: "Tên thư mục"}),
			Form.input({name: 'name', "placeholder":"Tên thư mục"}).value(folder.name).autoSubmit()
		)
		.hiddens(hiddens)
		.buttons([
			 {label: "Cập nhật thư mục", action: function(){
				 Form.submit("tree-node-fx", function(code){
					 if (!code.good()){
						 return AP.alertError(code.message);
					 }
				
					 Form.hide("tree-node-fx");
					 UI.flash("Đã cập nhật thư mục");
					 AP.xRefresh();
				 });
			 }, style: 'ok -success -rounded bold'},
			 {label: "Hủy", action: function(){
				 Form.hide("tree-node-fx");
			 }, style:'cancel -passive-2 -rounded'}
		]).settings();
		
		Form.pop({id:'tree-node-fx-dx', width: 400, label: 'Cập nhật thư mục', layout: 'flat'}).setForm(form).show().focus('name');
	};
	
	this.moveFolder=function(ref){
		var folder=getFolder(ref);
		if (!folder){
			return;
		}
		
		this.pendingPaste={
			action: "move",
			type: "folder",
			item: folder
		};
		
		AP.alertSuccess("Đã copy thư mục. Vui lòng chọn một thư mục khác để paste");
	};
	
	
	/**
	 * @desc Copy a folder out to another project
	 */
	this.copyFolderOut=function(ref){
		var folder=getFolder(ref);
		if (!folder){
			return;
		}
		
		this.pendingPaste={
			action: "move",
			type: "folder",
			item: folder,
			to_external: 1
		};
		
		AP.alertSuccess("Đã copy thư mục. Vui lòng chọn một thư mục trong project/team khác để paste");
	};
	
	
	this.moveNow=function(ref){
		if (this.pendingPaste.to_external){
			return this.executeCopyOut(ref);
		}
		
		var folder=getFolder(ref);
		
		var data={id: this.pendingPaste.item.id, action: "move", to: folder.id};
		UI.ajaxShow();
		AP.post("api/base/file/folder/move", data, function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			UI.flash("Đã di chuyển thư mục thành công !");
			AP.xRefresh();
		});
	};
	
	
	
	this.executeCopyOut=function(ref){
		AP.confirm("Please confirm to copy the folder <b>"+this.pendingPaste.item.name+"</b> to this (external) folder. A maximal of 50 files and 100 folders can be copied.", function(){
			var data={id: Drive.folder.pendingPaste.item.id, action: "move", to: 0, to_project_id: Client.pageData.project.id};
			
			var folder=getFolder(ref);
			if (folder){
				data.to=folder.id;
			}
			
			UI.ajaxShow();
			AP.post("api/base/file/folder/copy.out", data, function(code){
				UI.ajaxHide();
				
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				UI.flash("Đã copy thư mục thành công !");
				AP.xRefresh();
			});
		});
	};
	
	
	
	this.options=function(ref){
		AP.actionMenu(this.getOptions(ref));
	};
	
	 
	this.getOptions=function(ref){
		var actions=[];
		actions.push({label: "Sửa thư mục", icon:"uniF116", action: function(){
			Drive.folder.edit(ref);
		}});
		
		actions.push({label: "Di chuyển thư mục này tới  ...", icon:"uniF15F", action: function(){
			Drive.folder.moveFolder(ref);
		}});
		
		if (Project.isManager()){
			actions.push({label: "Copy folder ra bên ngoài  ...", icon:"uniF15F", action: function(){
				Drive.folder.copyFolderOut(ref);
			}});	
		}
		
		
		if (this.pendingPaste && this.pendingPaste.action){
			var e=this.pendingPaste;
			actions.push({label: "Paste thư mục ["+e.item.name+"]", icon:"uniF10E", action: function(){
				Drive.folder.moveNow(ref);
			}});
		}

		if (Drive.file.pendingPaste && Drive.file.pendingPaste.action){
			var e=Drive.file.pendingPaste;
			actions.push({label: "Paste file ["+e.item.name+"]", icon:"uniF10E", action: function(){
				Drive.file.moveNow(ref);
			}});
		}
		
		actions.push({label: "Xóa thư mục này", icon:"uniF11F", action: function(){
			Drive.folder.remove(ref);
		}});
		
		
		return actions;
	};
	
	
	function getFolder(ref){
		var folder={};
		if (ref){
			var $canvas=$(ref).closest('.item');
			var id=$canvas.data("id");
			var name=$canvas.data("name");
			var token=$canvas.data("token");
			folder={id: id, name: name, token: token, ns_id: Client.pageData.context.id};
		}else{
			folder=Client.pageData.folder;
		}
		
		return folder;
	};
	

	this.displayAsOptions=function(canvas){
		var html=UI.tree.options(Client.pageData.cats);
		$(canvas).html(html);
	};

	
	/**
	 * @desc Init navigation
	 */
	this.initNav=function(){
		var html=AP.render(Client.pageData.traces, function(e, index, total){
			var icon="&nbsp;<span class='-ap icon-chevron-small-right'></span>&nbsp;";
			if (index==total-1){
				icon='';
			}
			return "<span class='url' data-xurl='documents/folder/"+(e.id)+"'>"+(e.name)+"</span>"+(icon)+"";
		});
		
		html="<span class='url' data-xurl='documents'>Documents</span>&nbsp;<span class='-ap icon-chevron-small-right'></span>&nbsp;" + html;
		
		$("#js-drive-folder-navs").html(html);
	};
	
	
	
	/**
	 * @desc Remove folder, safely remove all nested too
	 */
	this.remove=function(ref){
		var folder=getFolder(ref);
		var hiddens={id: folder.id, token: folder.token};
		
		AP.confirmDelete("Delete this folder will also delete all internal files and sub-folders (if you are project owners). Are you sure?", function(){
			UI.ajaxShow();
			AP.post("api/base/file/folder/remove", hiddens, function(code){
				UI.ajaxHide();
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				UI.flash("Folder removed ...");
				AP.xRefresh();
			});
		});
	};
	
	
	
};








Drive.file=new function __DriveFile(){
	this.pendingPaste={};
	this.display=function(fid){
		AP.loadInlineURL(Client.pageData.context.path+"/file", {id: fid}, "#file-display-canvas", {
			start: function(){
			},
			end: function(){
				AP.setURLParams({"show": fid});
			}
		});
	};
	
	this.extDisplay=function(fid){
		AP.loadInlineURL(Client.pageData.context.path+"/filext", {id: fid}, "#file-display-canvas", {
			start: function(){
			},
			end: function(){
				AP.setURLParams({"show": fid});
			}
		});
	};
	
	
	this.onDisplay=function(){
		if ($("#file-display").length){
			return true;
		}
		
		return false;
	};
	
	this.close=function(){
		$("#file-display").fadeOut(300, function(){
			$(this).remove();
			if (Client.pageData.direct_file){
			}else{
				AP.setURLParams({"show": null});
			}
		});
	};
	
	this.clean=function(){
		$("#file-display").remove();
	};
	
	this.ext=function(){
		$("#file-display").toggleClass("ext");
	};
	
	
	this.next=function(){

	};



	/**
	 * @desc Edit a file
	 */
	this.edit=function(id, token, name){
		var hiddens={id: id, token: token};
	
		var form=Form.create('tree-node-fx',{action: 'api/base/file/edit'})
		.row(
			Form.label({label: "Tên tài liệu"}),
			Form.input({name: 'name', "placeholder":"Tên tài liệu"}).value(name).autoSubmit()
		)
		.hiddens(hiddens)
		.buttons([
			 {label: "Chỉnh sửa tên tài liệu", action: function(){
				 Form.submit("tree-node-fx", function(code){
					 if (!code.good()){
						 return AP.alertError(code.message);
					 }

					 Form.hide("tree-node-fx");
					 AP.closeDialog(this);
					 UI.flash("File đã được chỉnh sửa");

					 AP.xRefresh();
				 });
			 }, style: 'ok -success -rounded bold'},
			 {label: "Hủy", action: function(){
				 Form.hide("tree-node-fx");
			 }, style:'cancel -passive-2 -rounded'}
		]).settings();
		
		Form.pop({id:'tree-node-fx-dx', width: 400, label: 'Chỉnh sửa tên tài liệu', layout: 'flat'}).setForm(form).show().focus('name');
	};

	function isImage(file){
		if (file.image && parseInt(file.image)){
			return true;
		}

		return false;
	};

	function isEmbeddable(file){
		var ext=UI.file.icon(file.name);

		if (file.metatype=="onedrive" && (ext=="png" || ext=="jpg" || ext=="jpeg" || ext=="gif")){
			return true;
		}

		// if (file.metatype=="dropbox" && file.preview && file.preview.length && (ext=="png" || ext=="jpg" || ext=="jpeg" || ext=="gif")){
		//	 return true;
		// }

		if (file.metatype=="dropbox" && (ext=="png" || ext=="jpg" || ext=="jpeg" || ext=="gif")){
			return true;
		}

		if (file.metatype == "google" || file.metatype == "googledrive"){
			return true;
		}

		if (file.metatype == "base" || file.metatype == "basedraw"){
			return true;
		}

		if (ext=="word" || ext=="excel" || ext=="pdf" || ext=="ppt" || ext=="txt"){
			return true;
		}

		return false;
	};

	

	this.showRev=function(file, rev){
		BC.main(Drive.file.getMain(rev));
		BC.title(Drive.file.getTitle(file, rev));
	};

	this.showRevs=function(){
		var file=this.file;
		if (!file){
			return;
		}

		var options=AP.select(file.revs, function(e, index){
			return {data: e, type: 'rev', label: "<b>Rev "+(index+1)+"</b>: "+e.name, sublabel: "Created at "+UI.simpleTime(e.since),"icon":"label_outline"};
		});

		options.push({type:'rev','label':"<b>Current version</b>: "+file.name, sublabel: "Created at "+UI.simpleTime(file.since), data: file});
		if (parseInt(file.user_id)==parseInt(Client.viewer.id)){
			options.push({type:'action','label':'<b>Create/upload a new revison</b>', sublabel:'Click to start creating a new version of this file', data: file});
		}


		AP.selectAction(options, function(opt){
			if (opt.type && opt.type=='action'){
				return Drive.file.newRev(opt.data.hid, opt.data.token, opt.data.gid);
			}
			Drive.file.showRev(Drive.file.file,opt.data);
		});
	};

	this.newRev=function(hid, token, gid){
		Drive.picker.pick(null, hid);
	};
	
	this.options=function(ref){
		AP.actionMenu(this.getOptions(ref));
	};

	this.PreviewOptions=function(){
		var file=Drive.file.file;
		var actions=[];

		var download=file.src;
		if (file.metatype=="" || file.metatype=="upload"){
			download=Client.url+'/files/download?id='+file.id+"&token="+file.token+"&key="+file.src;
		}

		actions.push({label: "Tải file", icon: "download", url: download});

		// if (file.user.id==Client.viewer.id){
		//	 actions.push({label: "Thêm phiên bản mới", icon: "upload3", action: function(){
		//		 Drive.file.newRev(file.hid,file.token,file.gid);
		//	 }});
		// }

		actions.push({label: "Mở rộng màn hình xem", icon: "open_in_new", action: function(){
			BC.extend();
		}});

		AP.actionMenu(actions);
	};

	this.getOptions=function(ref){
		var actions=[];
		// actions.push({label: "Chỉnh sửa tên", icon:"uniF116", action: function(){
		// 	Drive.file.edit(ref);
		// }});
		
		actions.push({label: "Di chuyển file tới thư mục", icon:"uniF15F", action: function(){
			Drive.file.moveFile(ref);
		}});
		
		actions.push({label: "Xóa file", icon:"uniF11F", action: function(){
			Drive.file.remove(ref);
		}});
		
		
		return actions;
	};

	this.moveFile=function(ref){
		var file=getFile(ref);
		if (!file){
			return;
		}

		this.pendingPaste={
			action: "move",
			type: "file",
			item: file
		};

		AP.alertSuccess("Đã copy tài liệu. Vui lòng chọn một thư mục khác để paste");
	};

	function getFolder(ref){
		var folder={};
		if (ref){
			var $canvas=$(ref).closest('.item');
			var id=$canvas.data("id");
			var name=$canvas.data("name");
			var token=$canvas.data("token");
			folder={id: id, name: name, token: token};
		}else{
			folder=Client.pageData.folder;
		}

		return folder;
	};

	this.moveNow=function(ref){
		var folder=getFolder(ref);

		var data={id: this.pendingPaste.item.id, action: "move", to: folder.id};
		UI.ajaxShow();
		AP.post("api/base/file/move", data, function(code){
			UI.ajaxHide();

			if (!code.good()){
				return AP.alertError(code.message);
			}

			UI.flash("Đã di chuyển file thành công !");
			AP.xRefresh();
		});
	};

	this.remove=function(ref){
		var file=getFile(ref);
		var hiddens={id: file.id, token: file.token};
		
		AP.confirm("Bạn có muốn xóa tài liệu: <b>"+file.name+"</b>? ", function(){
			UI.ajaxShow();
			AP.post("api/base/file/remove", hiddens, function(code){
				UI.ajaxHide();
				if (!code.good()){
					return AP.alertError(code.message);
				}
				UI.flash("Tài liệu đã được xóa ...");
				AP.xRefresh();
			});
		});
	};

	function getFile(ref){
		var file={};
		if (ref){
			var $canvas=$(ref).closest('.item');
			var id=$canvas.data("id");
			var name=$canvas.data("name");
			var token=$canvas.data("token");
			file={id: id, name: name, token: token};
		}
		
		return file;
	}

	this.preview=function(hid, token){
		AP.ajaxShow();
		AP.post("api/base/file/get",{file_id: hid, token: token}, function(code){
			AP.ajaxHide();
			if (!code.good()){
				AP.alertError(code.message);
				return;
			}

			Drive.file.displayImage(code.file);
		});
	};

	this.displayImage=function(file){	
		Drive.file.file=file;
		BC.title(Drive.file.getTitle(file));
		BC.side(Drive.file.getSide(file));
		BC.main(Drive.file.getMain(file));
		BC.show();

		Comment.auto("#side-comment-"+file.id, file);
		Comment.attachBottom("#bside", file);
		
		// $("#side-followers").html(BC.ui.followers(file));
		
		Follow.auto("#side-followers", {
			followers: file.followers,
			users: Client.people,
			endpoint: "api/base/file/follow",
			style: "compact",
			owners: [file.username],
			data: {obj_id: file.id, obj_token: file.token}
		});
	};

	
	this.getSide=function(file){
		return "<div id='side-followers' class='section'></div> <div id='side-comment-"+file.id+"'></div>";
	};
	

	this.getTitle=function(file, rev){
		var name=file.name;

		var meta=file.metatype;
		var since=file.since;
		if (rev){
			name=rev.name;
			download=rev.src;
			meta=rev.metatype;
			since=rev.since;
		}


		var icon=UI.file.icon(name);

		var download=file.src;
		if (meta=="" || meta=="upload"){
			// download=Client.url+'/files/download?id='+file.id+"&token="+file.token+"&key="+file.src;
		}

		if (meta=="base" && file.fid){
			download = Base.file.download(file.name, file.fid);
		}

		var rev_action='';
		if (parseInt(file.user_id)==parseInt(Client.viewer.id)){
		}


		var edit_action=" &middot; <span class='a action std' onclick=\"Drive.file.edit('"+file.id+"','"+file.token+"','"+file.name+"');\">Chỉnh sửa</span>";

		if (parseInt(file.user.id)!= parseInt(Client.viewer.id)){
			edit_action="";
		}

		var revs_action="";
		if (file.revs && file.revs.length){
			revs_action="<span class='action icon' title='Revisions' onclick='Drive.file.showRevs();'><span class='count'>"+file.revs.length+"</span><span class='-ap icon-layers2'></span></span>";
		}

		var other=" &middot; <span class='a action std advanced' onclick=\"Drive.file.PreviewOptions('"+file.hid+"','"+file.token+"','"+file.name+"');\">Thêm tùy chọn</span>";



		return "" +
			"<div class='image'><img src='"+Client.share_url+"/32/file-"+icon+".png'></div>"+
			"<h1 class='ap-xdot' title='"+name+"'>"+name+"</h1>" +
			"<h3>Tạo bởi <span class='a std url username'>@"+file.username+"</span> &middot; "+UI.simpleTime(since)+" &middot; Cập nhật lần cuối "+UI.simpleTime(file.last_update)+" " +
			edit_action+
			rev_action+
			other+
			"</h3>" +
			"<div class='actions align-right'>" +
			revs_action+
			"   <span class='action icon' title='Extend preview' onclick='BC.extend();'><span class='-ap icon-open_in_new'></span></span>" +
			"   <a class='action icon' target='_blank' href='"+download+"' title='Download the file'><span class='-ap icon-get_app'></span></a>" +
			"</div>";
	};

	
	this.getMain=function(file){
		var regEx = /(?:\.([^.]+))?$/;
		var fileExtension = regEx.exec(file.name)[1];
		if (isImage(file) && !file.metatype=="googledrive" && !file.metatype=="dropbox" && !file.metatype=="onedrive"){
			return "<div class='embed-20'><div class='image'><img src='"+file.src+"'/></div></div>";
		} else if (isImage(file) && (file.metatype=="base" || file.metatype=="basedraw" || file.metatype=="upload")) {
			return "<div class='embed-20'><div class='image'><img src='"+file.src+"'/></div></div>";
		}else if (isEmbeddable(file) || (fileExtension == "txt")){
			if (file.metatype=="onedrive"){
				var url=file.src+"&em=2";


				// get cid
				var pos = url.indexOf('resid=');
				var suburl = url.substring(pos);
				var pivot = suburl.indexOf('!');
				var cid = suburl.substring(6, pivot);

				url = url.replace("redir?","embed?cid="+cid+"&");

				return "<div class='embed-20'>" +
					"<iframe src=\""+url+"\" style='width:100%; height:100%;' frameborder='0' scrolling='no'></iframe>"+
					"</div>";
			}else if (file.metatype=="dropbox"){
				var url=file.preview;
				if (!url){
					return "<div style='margin-top: 60px; font-size: 15px; text-align:center;'>" +
						"<div class='featured' style='margin-bottom: 15px;'>This file has been picked from Dropbox and can't be previewed.</div>" +
						"<a href='" + file.src + "' target='_blank'>Click here to download file</a>" +
						"</div>";
				}

				url=url.replace("bounding_box=75","bounding_box=800");
				return "<div class='embed-20'><div class='image'><img src='"+url+"'/></div></div>"
			}else if (file.metatype == "googledrive" || file.metatype == "google"){
				console.log('file main google');
				if ($.inArray(fileExtension, ['gdoc', 'gsheet', 'gdraw', 'gslides']) < 0) {
					return "<div class='embed-20'>" +
						"<iframe src=\""+file.src+"\" style='width:100%; height:100%;' frameborder='0'></iframe>"+
						"</div>";
				} else {
					return "<div class='embed-20'>" +
						"<iframe src=\""+file.src.substr(0, file.src.lastIndexOf('?'))+"\" style='width:100%; height:100%;' frameborder='0'></iframe>"+
						"</div>";
				}
			}

			// M$ Office file types
			if ($.inArray(fileExtension, ['doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx']) >= 0) {
				return "<div class='embed-20'>" +
					"<iframe src=\"https://view.officeapps.live.com/op/view.aspx?src="+file.url+"\" style='width:100%; height:100%;' frameborder='0'></iframe>"+
					"</div>";
			}

			if (Client.https) {
				return "<div class='embed-20'>" +
					"<iframe src=\"https://docs.google.com/gview?url="+file.url+"&embedded=true\" style='width:100%; height:100%;' frameborder='0'></iframe>"+
					"</div>";
			}
			return "<div class='embed-20'>" +
				"<iframe src=\"http://docs.google.com/gview?url="+file.url+"&embedded=true\" style='width:100%; height:100%;' frameborder='0'></iframe>"+
				"</div>";
		}else{
			var download=file.url;
			return "<div class='center' style='padding:20px;'>No preview available. Please <a href='"+download+"' target='_blank'>download the file</a>.</div>";
		}
	};
	
};


Drive.engine=new function __DriveExt(){
	this.uploadFile = function (file, hid) {
		var sysid = Client.pageData.context.id;
		var folder_id = Client.pageData.folder ? Client.pageData.folder.id : 0;
		var src = (file.metatype != 'googledrive') ? file.weblink : file.preview;

		if (file.metatype == 'base') {
			src = file.src;
		}

		AP.post("api/base/file/upload.basedrive",{
			sysid: sysid,
			hid: hid,
			metatype: file.metatype,
			folder_id: folder_id,
			fid: file.fid,
			file_name: file.name,
			download_link: (file.download) ? (file.download) : file.embedUrl,
			preview:(file.preview) ? file.preview : file.embedUrl,
			file_size: (file.size) ? file.size : file.sizeByte,
			file_extension: (file.is_image == 1 && file.metatype == 'base') ? 'png' :file.ext,
			src : src
		},
		function(code){
			UI.ajaxHide();

			if (!code.good()){
				return AP.alertError(code.message);
			}
			AP.xRefresh();
		});
	};
};
var Onboard = new function __Onboard(){
	this.next=function(){
		
	};
	
	this.saveAndContinue=function(){
		var app=Client.path.current;
		if (app=="onboard" || app=="onboard/company" || app=="onboard/"){
			this.saveCompany();
		}else if (app=="onboard/user"){
			AP.toURL("onboard/team");
		}else if (app=="onboard/team"){
			AP.redirect("onboard/final");
		}else{
			AP.toURL("home");
		}
	};
	
	
	this.skip=function(){
		
	};
	
	
	this.saveCompany=function(refresh){
		save("#js-free-label", function(code){
			if (code.refresh){
				AP.redirect("onboard/company");
				return;
			}
			
			if (refresh){
				AP.refresh();
			}else{
				AP.toURL("onboard/user");	
			}
		});
	};
	
	function save(label, callback){
		Form.submitFrom(label, function(code){
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			callback(code);
		},{})
	};
};



Onboard.member=new function __OnboardMember(){
	this.init=function(input){
		$(input).each(function(){
			$(this).enter(function(){
				var users=$(this).val();
				var role=$(this).data("role");
				if (!users || !users.length){
					return;
				}
				setRole(users, role);
			});
			
			$(this).closest(".qf").find(".add").click(function(){
				$(this).closest(".qf").find("input").triggerEnter();
			});
		});
    };

	this.filter = function() {
        $("#js-onboard-search input").on("input",function(){
            var q=$(this).val();
            if (!q){
                q="";
            }

            q=$.trim(q).toLowerCase();
            q=purify(q);

            $(".users .user").each(function(){
                if(!q) {
                    if ($(this).hasClass("search_hidden") && $(this).css('display', 'none')){
                        $(this).css('display', 'block');
                    }
                } else {
                    if (matched(this, q) && $(this).css('display') != 'none'){
                        $(this).removeClass("search_hidden");
                    } else 	{
                        $(this).addClass("search_hidden");
                        $(this).css('display', 'none');
                    }
                }
            });
        });
	}

	this.display=function(canvas){
		$("#js-people").html(AP.render(Client.people, function(e){
			return getPersonHTML(e);
		}));
		
		
		$("#onboard select.rs").each(function(){
			var username=$(this).data("username");
			$(this).val("member");
			
//			if (Role.manager(username)){
//				$(this).val("manager");
//			}else if (Role.manager(username)){
//				$(this).val("executive");
//			}else{
//				
//			}
		});
		
		$("#js-people select.rs").each(function(){
			var priv=parseInt($(this).data("priv"));
			if (priv==10){
				$(this).val("admin");
			}else if (priv==13){
				$(this).val("owner");
			}
			
			$(this).change(function(){
				var val=$(this).val();
				var username=$(this).data("username");
				
				AP.post(Base.domain("account")+'/ajax/api/network/role/set', {username: username, role: val}, function(code){
					if (!code.good()){
						return AP.alertError(code.message);
					}
					
					AP.alertSuccess("Updated successfully ...");
				});
				
			});
		});
		
	};
	
	
	
	this.create=function(role){
		if (!role){
			role="";
		}
		
		var form=Form.create('create-account-fx',{action: Base.domain("account")+'/ajax/api/company/account/create'})
		.row(
			Form.label({label: "Họ và tên *",sublabel: "Họ và tên"}),
			Form.input({name: 'name', "placeholder":"Họ và tên"})
		)
		.row(
			Form.label({label: "Username *",sublabel: "<span class='red'>Username của tài khoản là duy nhất và sẽ không thể thay đổi sau khi được tạo - vui lòng lựa chọn username phù hợp.</span>"}),
			Form.input({name: 'username', "placeholder":"Chỉ gồm các ký tự thông thường, không có dấu hoặc tiếng việt"})
		)
		.row(
			Form.label({label: "Email tài khoản *",sublabel: "Một mật khẩu tạm thời sẽ được gửi đến email này."}),
			Form.input({name: 'email', "placeholder":"Email tài khoản"})
		)
		.row(
			Form.label({label: "Chức danh",sublabel: "Chức danh, chức vụ hoặc vị trí trong công ty"}),
			Form.input({name: 'title', "placeholder":"Chức danh"})
		)
		.row(
			Form.label({label: "Phân quyền sử dụng", sublabel: "Phân quyền sử dụng"}),
			Form.input({name: 'priv', "type":"select", options: privOptions()}).value(role)
		)
		.hiddens(
			{
				token:Client.system.token,
				app: Client.base.app
			}
		)
		.buttons([
		     {label: "Tạo tài khoản mới", action: function(){
		    	 Form.submit("#create-account-fx", function(code){
		    		 if (!code.good()){
		    			 return AP.alertError(code.message);
		    		 }
		    	
		    		 
		    		 Form.hide("create-account-fx");
		    		 AP.alertSuccess("Tài khoản đã được tạo thành công.", function(){
		    			 AP.refresh();
		    		 });
		    		 //setRole(code.user.username, role, function(e){
		    		 //	 AP.refresh();
	    			 // });
		    	 });
		     }, style: 'ok -success -rounded -bold'},
		     {label: "Cancel", action: function(){
		    	 Form.hide("create-account-fx");
		     }, style:'cancel -passive-2 -rounded'}
		]).settings();
	
		Form.pop({id: 'create-team-fx-dx', width: 600, label: 'Tạo tài khoản mới'}).setForm(form).show();
	};
	
	
	
	function getPersonHTML(p){
		return "<div class='user' data-keywords='"+p.username+" "+p.name+"'>" +
				"<div class='avatar avatar-40'><div class='image'><img src='"+AP.xthumb(p.gavatar)+"'/></div></div>" +
				"<div class='main'>" +
				"	<div class='name url' data-username='"+p.username+"'>"+p.name+"</div>" +
				"	<div class='info'>"+p.title+"&nbsp;</div>" +
				"</div>" +
				"<div class='role'>"+getRole(p)+"</div>" +
			"</div>";
	};
	
	
	function getRole(p){
		return "<select class='rs' name='' data-username='"+p.username+"' data-priv='"+p.role+"'>" +
				"<option value='member'>Regular Member</option>" +
				"<option value='admin'>System Admin</option>" +
				"<option value='owner'>System Owner</option>" +
			"</select>";
	};
	
	
	function privOptions(){
		return [{label: "Thành viên thông thường", "value":""}, {label: "Admin", "value":"admin"}, {label: "System owner (super admin)", "value":"owner"}];
	};
	
	
	function setRole(users, role, callback){
		if (!role || !role.length){
			return;
		}
		
		UI.ajaxShow();
		AP.post("api/onboard/member/assign", {"role": role, "users": users}, function(code){
			UI.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			if (callback){
				callback();
			}else{
				UI.flash("Update successfully ...");
				AP.refresh();	
			}
		});
	};

    function matched(elem, q){
        var keyword = String($(elem).data("keywords"));
        var word=keyword.toLowerCase();
        var parts=q.split(" ");
        for (var i=0; i<parts.length; i++){
            if ($.trim(parts[i])){
                if (word.indexOf(parts[i])==-1){
                    return false;
                }
            }
        }
        return true;
    };
};


Onboard.team=new function __OnboardMember(){
	this.display=function(canvas){
		$("#js-teams").html(AP.render(Client.units, function(e){
			return getTeamHTML(e);
		}));
	};
	
	
	this.create=function(role){
		if (!role){
			role="";
		}
		
		var form=Form.create('create-account-fx',{action: Base.domain("account")+'/ajax/api/company/team/create'})
		.row(
			Form.label({label: "Tên phòng ban *",sublabel: "The business unit name"}),
			Form.input({name: 'name', "placeholder":"The business unit name"})
		)
		.row(
			Form.label({label: "Đường dẫn *",sublabel: "<span class='red'>Đường dẫn là duy nhất và sẽ không thể thay đổi sau khi được tạo - vui lòng lựa chọn phù hợp.</span>"}),
			Form.input({name: 'path', "placeholder":"Team directory, only regular characters"})
		)
		.row(
			Form.label({label: "Người phụ trách *",sublabel: "Please select one person to lead the team"}),
			Form.input({name: 'leader', "placeholder":"Type @ to select one person", role:"user"})
		)
		.row(
			Form.label({label: "Các thành viên khác *",sublabel: "Please select other members"}),
			Form.input({name: 'users', "placeholder":"Type @ to tag any other people", role:"tag"})
		)
		.row(
			Form.label({label: "Miêu tả thêm",sublabel: "Short description"}),
			Form.input({name: 'content', type: "textarea", "placeholder":"Write short description about the business unit"})
		)
		.hiddens(
			{
				token:Client.system.token,
				app: Client.base.app,
				type: 3
			}
		)
		.buttons([
		     {label: "Thêm mới", action: function(){
		    	 Form.submit("#create-account-fx", function(code){
		    		 if (!code.good()){
		    			 return AP.alertError(code.message);
		    		 }
		    	
		    		 
		    		 Form.hide("create-account-fx");
		    		 AP.alertSuccess("Tean đã được tạo thành công.", function(){
		    			 AP.refresh();
		    		 });
		    		 //setRole(code.user.username, role, function(e){
		    		 //	 AP.refresh();
	    			 // });
		    	 });
		     }, style: 'ok -success -rounded -bold'},
		     {label: "Cancel", action: function(){
		    	 Form.hide("create-account-fx");
		     }, style:'cancel -passive-2 -rounded'}
		]).settings();
	
		Form.pop({id: 'create-team-fx-dx', width: 600, label: 'Thêm bộ phận mới'}).setForm(form).show();
	};
	
	
	
	function getTeamHTML(p){
		if (p.metatype!="unit"){
			return "";
		}
		
		return "<div class='user'>" +
				"<div class='avatar avatar-40'><div class='image'>"+UI.textAvatar(p.name, 40)+"</div></div>" +
				"<div class='main'>" +
				"	<div class='name url' data-url='"+Base.domain("account")+"/company/g/"+p.path+"'>"+p.name+"</div>" +
				"	<div class='info'>@"+p.path+"&nbsp;</div>" +
				"</div>" +
				"<div class='role'>"+getUsers(p)+"</div>" +
			"</div>";
	};
	
	
	function getUsers(p){
		return "";
	};

};


Onboard.language=new function __OnboardLanguage(){
	this.init=function(){
		$("#setup .selections .select").on("click", ".checkbox", function(){
			var $box=$(this).parent();
			
			var val=$box.data("value");
			$("#js-language").val(val);
			
			$box.siblings().removeClass("selected");
			$box.addClass("selected");
		});
		
		
		var lang=Client.config.mailbox.lang;
		if (!lang || !lang.length){
			lang="vi";
		}
		
		if (lang){
			$("#setup .selections .select.select-"+lang+" .checkbox").click();
		}
	};
};


if (Client.viewer && Client.viewer.id && !mobile()){
	var path=Client.path.app;
	if (path!="setup" && Client.require_setup){
		AP.redirect("setup");
	}
}



Onboard.setup=new function __OnboadSetup(){
	this.init=function(){
		initMenu();
	};
	
	
	this.initSampleData=function(){
		UI.ajaxShow();
		AP.post("api/setup/sampledata",{}, function(code){
			UI.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			AP.alertSuccess("Đã tạo dữ liệu mẫu thành công!");
			setTimeout(function(){
				AP.redirect("home");
			}, 500);
		});
	};
	
	
	
	
	function initMenu(){
		if (Client.path.app!="setup"){
			return;
		}
		
		var back="<div class='box'><div class='li' onclick=\"AP.redirect('home');\">" +
		"	<div class='icon'><span class='-ap icon-arrow-left2'></span></div>" +
		"	<div class='name'>Quay lại Wework</div>" +
		"</div></div>";
		
		if (parseInt(Client.require_setup)){
			back="";
		}
		
		
		var html=back +"<div class='box'>" +
			"<div class='title'>Setup hệ thống</div>" +
			"<div class='li url' data-url='setup'>" +
			"	<div class='icon'><span class='-ap icon-cog3'></span></div>" +
			"	<div class='name'>Cài đặt ban đầu</div>" +
			"</div>" +
			"<div class='li url' data-url='setup/video'>" +
			"	<div class='icon'><span class='-ap icon-play2'></span></div>" +
			"	<div class='name'>Xem video hướng dẫn</div>" +
			"</div>" +
		"</div>";
		
		$("#navigator .boxes").empty().html(html);
		
		$("#navigator .li").setActiveURL();
	};
	
};
var Message=new function __Message(){
	this.__mode="native";
	this.httpbase=(parseInt(Client.https)?"https":"http");
	this.api=(Client.base && (Client.base.app=="message" || Client.base.app=="msg"))?"":(this.httpbase+"://" + CONFIG.api + "."+Client.domain+"/ajax/");
	
	this.mode=function(){
		if (arguments.length==0){
			return this.__mode;
		}
		
		return (this.mode==arguments[0]);
	};
	
	
	/**
	 * @desc Add a new message
	 */
	this.addMessage=function(message, channel){
		this.html.addMessage(message, channel);
	};
	
	
	/**
	 * @desc Create an event listener
	 */
	this.on=function(event, fx, $this){
		this.event.bind(event, fx, $this);
		return this;
	};
	
	
	/**
	 * @desc Trigger an event 
	 */
	this.trigger=function(event, data){
		this.event.trigger(event, data);
		return this;
	};
	
	
	/**
	 * @desc Alias of trigger
	 */
	this.fire=function(event, data){
		this.event.trigger(event, data);
		return this;
	};
	
	
	/**
	 * @desc Forward a file to another channel
	 */
	this.forwardFile=function(ref){
		var $box=$(ref).closest(".message").find(".attachments .att").first();
		var file={id: $box.data("file_id"), name: $box.data("file_name")};
		forwardNow(file);
	};
	
	
	this.forwardFileOnSidebar=function(ref){
		var $box=$(ref).closest(".file");
		var file={id: $box.data("file_id"), name: $box.data("file_name")};
		forwardNow(file);
	};
	
	
	function forwardNow(file){
		if (!file || !file.id){
			return;
		}
		
		if (!Channel.manager.channels || !Channel.manager.channels.length){
			return;
		}
		
		UI.picker(Channel.manager.channels, function(c){
			UI.ajaxShow();
			AP.post(Base.domain("message")+"/ajax/api/message/file/forward", {id: file.id, channel_id: c.id, name:file.name}, function(code){
				UI.ajaxHide();
				
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				UI.flash("Forward successfully ...");
			});
		}, {
			title:"Select one channel to send the file"
		});
	};
	
};



Message.socket = new function __MessageSocket(){
	this.send=function(event, data, callback){
		Live.emit(event, data);
		if (callback){
			this.on(event, callback)
		}
	};
	
	
	this.emit=function(event, data, callback){
		this.send(event, data, callback);
	};
	
	
	this.emitMe=function(event, data){
		data.event=event;
		Live.emit("justme", data);
	};
	
	
	this.localEmit=function(event, data, callback){
		this.emit("local.emit."+event, data, callback);
	};
	
	
	this.on=function(event, callback){
		Live.me.on(event, callback); 
	};
};


Message.event=new function __MsgEvent(){
	this.events={};
	this.__fired={};
	
	this.clear=function(){
		this.events={};
		this.__fired={};
	};
	
	this.removeListener=function(ev){
		if (this.events[ev] && this.events[ev].length){
			this.events[ev]=[];
			delete this.events[ev];
		}
	};
	
	this.off= this.removeListener;
	
	this.trigger=function(ev, data){
		$.log("Event "+ev+" fired at "+AP.time.time("%H:%i:%s"));
		
		if (this.events[ev] && this.events[ev].length){
			for (var i=0; i<this.events[ev].length; i++){
				var fn=this.events[ev][i];
				if (!fn){
					break;
				}
				
				if (fn._caller){
					fn.apply(fn._caller, data);
				}else{
					if (AP.data.isArray(data)){
						fn.apply(undefined, data);
					}else{
						fn(data);	
					}
					
				}
			}
		}
		
		this.__fired[ev]=1;
		return this;
	};
	
	
	this.release=function(ev){
		if (this.events[ev] && this.events[ev].length){
			while (true){
				var fn=this.events[ev].shift();
				if (!fn){
					break;
				}
				
				if (fn._caller){
					fn.apply(fn._caller);
				}else{
					fn();
				}
			}
		}
		
		this.__fired[ev]=1;
		return this;
	};
	
	
	this.bind=function(ev, fx, _caller){
		if (!this.events[ev]){
			this.events[ev]=[];
		}
		
		if (_caller){
			fx._caller=_caller;
		}
		
		this.events[ev].push(fx);
		
		return this;
	};
	
	
	this.bindAll=function(ev, fx, _caller){
		if (!this.events[ev]){
			this.events[ev]=[];
		}
		
		if (_caller){
			fx._caller=_caller;
		}
		
		this.events[ev]=[fx]; // Replace
		
		return this;
	};
	
	
	this.fired=function(ev){
		if (this.__fired[ev]){
			return true;
		}
		return false;
	};
};










Message.eventOnce=new function __MsgEvent(){
	this.events={};
	
	this.clear=function(){
		this.events={};
	};
	
	this.removeListener=function(ev){
		if (this.events[ev]){
			this.events[ev]=null;
			delete this.events[ev];
		}
	};
	
	this.trigger=function(ev, data){
		if (this.events[ev]){
			var fn=this.events[ev];
			if (!fn){
				return;
			}
			
			if (fn._caller){
				fn.apply(fn._caller, data);
			}else{
				if (AP.data.isArray(data)){
					fn.apply(undefined, data);
				}else{
					fn(data);	
				}
				
			}
			
			delete this.events[ev];
		}
		
		return this;
	};
	
	
	
	this.bind=function(ev, fx, _caller){
		if (_caller){
			fx._caller=_caller;
		}
		
		this.events[ev]=fx;
		
		return this;
	};
	
	
};


Message.bindEvents=function(){
	Message.socket.on("message.updated", function(msgdata){
		var channel=msgdata.channel;
		var message=msgdata.message;
		var notis=msgdata.notis;
		var actives=msgdata.actives;
		var seens=msgdata.seens;
		
		// FORCE UPDATE
		if (message.__action && message.__action=="update"){
			if (message.__action_notis){
				Message.notify.reaction(message, channel, message.__action_notis);
			}
			
			return Message.html.onUpdate(message, channel);
		}
		
		if (message.__action && message.__action=="remove"){
			return Message.html.onRemove(message, channel);
		}
	});
	
	
	Message.socket.on("message.received", function(msgdata){
		var channel=msgdata.channel;
		var message=msgdata.message;
		var notis=msgdata.notis;
		var actives=msgdata.actives;
		var seens=msgdata.seens;
		
		if (message && message.intent && message.intent=="call" && parseInt(message.user.id)!=parseInt(Client.viewer.id)){
			Message.notify.ringing(message);
		}
		
		if (message.__action && message.__action=="update"){
			return Message.html.onUpdate(message, channel);
		}
		
		if (message.__action && message.__action=="remove"){
			return Message.html.onRemove(message, channel);
		}
		
		
		if (Message.checkpoint.received(message)){
			Base.console("WOW -- RECEIVED MESSAGE & INGORED @L15 --"+message.id);
			return;
		}
		
		if (message.content=="buzz!"){
			DN.bip(6, message.id);
		}
		
		if (msgdata.notis_opt && msgdata.notis_opt=='on'){
			Message.notify.now(message, channel, notis);	
		}
		
		if (!Channel.isDisplayed(channel.id)){
			if (msgdata.notis_opt=="off"){
				Message.canvas.onMessage(message, channel);
				return; // SILENT
			}
			Channel.open(channel.id, {intent: "message", "just_open": 1}, function(){
				Message.html.forceScrollBottom(channel.id);
				setTimeout(function(){
					Message.html.forceScrollBottom(channel.id);
				},1000);
				
				setTimeout(function(){
					Message.html.forceScrollBottom(channel.id);
				},3000);
			});
		}else{
			Message.html.addMessage(message, channel);
		}
		
		
		// Message.panel.onMessage(message, channel);
		// Message.panel.onMessageReceive(message, channel);
		// Channel.fixUnread(channel);
		// Base.title.update();
		
		Message.canvas.onMessage(message, channel);
		
		seens=AP.array.filter(seens, function(e){
			return AP.array.contain(channel.followers, e, function(f, e){
				return parseInt(f)==parseInt(e);
			});
		});
		
		Message.seen.render(channel.id, seens, actives);
	});
	
	
	Message.socket.on("message.deleted", function(msgdata){
	});
	
	
	Message.socket.on("typings", function(data){
		Message.form.updateTypings(data.channel_id, data.users);
	});
	
	
	
	Message.socket.on("call.closed", function(data){
		DN.bipInf("ringing", false);
		AP.dialog("#alert").hide();
	});
	
	Message.socket.on("call.close", function(data){
		DN.bipInf("ringing", false);
		AP.dialog("#alert").hide();
	});
	
	
	Message.socket.on("channel.me.close", function(data){
		if ($("#channel-"+data.id).length){
			Message.render.destroy("#channel-"+data.id+" .js-channel-close");
		}
	});
};



AP.rewrite('r/file/([a-zA-Z0-9]+)/([a-zA-Z0-9]+)', 'messages/file?c=$1&file=$2', function(qs){
	Channel.open(qs.c, function(){
		BaseFile.open(qs.file);
	});
});


Message.notify= new function __MessageParser(){
	this.badge=function(){
		var total=Channel.countUniqueUnreads();
		
		if (total>0){
			if ($("#base-message-badge").length){
				$("#base-message-badge").html(total).show();
			}
		}else{
			if ($("#base-message-badge").length){
				$("#base-message-badge").html("").hide();
			}
		}
	};
	
	this.ringing=function(message){
		if (notified(message.id)){
			return;
		}
		
		logNotified(message.id);
		
		DN.bipInf("ringing", true);
		AP.alert(message.plaintext, [
          {label: "Cancel",  action: function(){
        	  Message.socket.emitMe("call.close", {id: 0});
        	  
        	  DN.bipInf("ringing", false);
        	  AP.dialog("#alert").hide();
          }, style: "er confirm-button"},
          {label: "Join call",  action: function(){
        	  Message.socket.emitMe("call.close", {id: 0});
        	  
        	  DN.bipInf("ringing", false);
        	  AP.dialog("#alert").hide();
        	  AP.toURL(message.intentdata.call);
          }, style: "ss confirm-button"}
        ],"<div class='ring-animation'><div class='-ap icon-phone-handset'></div></div>",{
			closable: false
		});
	};
	
	
	this.now=function(message, channel, notis){
		if (this.ignored(channel)){
			return;
		}
		
		if (Channel.isActive(channel.id) || Base.systemActive()){
			notis.__is_base_message=1;
			notify(message, channel, notis);
		}else{
			setTimeout(function(){
				notify(message, channel, notis);
			},300);
		}
	};
	
	
	
	this.ignored=function(channel){
		return false;
	};
	
	
	this.reaction=function(message, channel, reaction){
		if (parseInt(message.user.id)!=parseInt(Client.viewer.id) || reaction.username==Client.viewer.username){
			return;
		}
		
		if (notified(message.id+"-"+reaction.reaction)){
			return;
		}
		
		var u=People.get(reaction.username);
		var notis={};
		
		notis.body=u.name+" reacted :"+reaction.reaction+": on your message";
		notis.icon=AP.thumb(u.gavatar);
		notis.title="[Base Message] "+Channel.engine.getDisplayName(channel);
		notis.url="base-message://messages/"+message.channel_id+"/"+message.id;
		
		DN.show(notis);
		DN.bip(3, message.id);
		logNotified(message.id);
	};
	
	
	
	function notify(message, channel, notis){
		if (notified(message.id)){
			Base.console("NEW MESSAGE NOTIFY SKIP --- "+message.id);
			return;
		}
		
		// Desktop notification or not?
		if (parseInt(channel.inspect.notis)){
			notis.body=notis.content;
			notis.icon=notis.image;
			if (!notis.url){
				notis.url=notis.link;
			}
			
			Base.console("NEW MESSAGE NOTIFY",notis);
			notis.title="[Base Message] "+Channel.engine.getDisplayName(channel);
			
			DN.show(notis);
			DN.bip(3, message.id);
			logNotified(message.id);
		}else{
			$$(function(){
				$.log("Ignore notification on direct message ...");
			});
		}
	};
	
	

	function notified(msgid){
		var lm=Clog.getCookie("__lm");
		if (!lm){
			lm=[];
		}else{
			lm=lm.split(" ");
		}
		
		if (AP.array.find(lm, msgid)){
			return true;
		}
		
		return false;
	};
	
	
	function logNotified(msgid){
		msgid=""+msgid+"";
		
		var lm=Clog.getCookie("__lm");
		if (!lm){
			lm=[];
		}else{
			lm=lm.split(" ");
		}
		
		lm.push(msgid);
		lm=AP.array.unique(lm, function(e1, e2){
			return e1==e2;
		});
		
		if (lm.length>=11){
			lm=lm.slice(lm.length-10);
		}
		
		Clog.setCookie("__lm", lm.join(" "));
	};
};


Message.checkpoint=new function __MessageCheckpoint(){
	this._received={};
	this._received_ids=[];
	this._received_len=90;
	this._received_max=100;
	
	
	/**
	 * @desc Fix multiple received. Allow once received only
	 * @use if (Message.received(msg)){}
	 */
	this.received=function(msg){
		if (this._received["msg@"+msg.id]){
			return true;
		}
		this._received["msg@"+msg.id]=1;
		this._received_ids.push(msg.id);
		
		if (this._received_ids.length>=this._received_max){
			var temp={};
			for (var i=this._received_ids.length-this._received_len; i<this._received_ids.length; i++){
				temp["msg@"+this._received_ids[i]]=this._received["msg@"+this._received_ids[i]];
			}
			
			this._received=temp;
			this._received_ids=this._received_ids.slice(this._received_ids.length-this._received_len);
		}
		
		return false;
	};
	
	
};


Message.sender=new function __MessageSender(){
	/**
	 * @desc Send a text message
	 */
	this.text=function(text, channel){
		Channel.setActive(channel.id);
		
		var state=AP.uuid();
		var data={
			state: state,
			content: text,
			channel_id: channel.id,
		};
		
		var pending_msg={
			state: state,
			content: text,
			channel_id: channel.id,
			id: state,
			since: AP.time.now(),
			user: Client.viewer,
			metatype: "message",
			type: "text",
			attachments: []
		};
		
		Message.form.onSending(pending_msg, channel);
		
		AP.post(Message.api+"api/message/message/save", data, function(code){
			if (!code.good()){
				Message.trigger("message.rejected", [data, data.state]);
				return AP.alertError(code.message);
			}
			
			Message.form.onSent(code.message, data.state);
		});
	};
	
	
	this.buzz=function(channel){
		this.text("buzz!", channel);
	};
	
	
	this.drive=function(channel){
		Base.drive.pick({
			multi: 1, 
			ext: 1,
			callback: function(files){
				if (!channel){
					return;
				}
				
				if (!files.length){
					return;
				}
				
				var state=AP.uuid();
				var data={
					state: state,
					content: "shared files",
					channel_id: channel.id,
					type: 'drivefile',
				};
				

				var bfs=fix_post_array(files, "bf");
				for (var key in bfs){
					data[key]=bfs[key];
				}
				
				var pending_msg={
					state: state,
					content: "shared files",
					channel_id: channel.id,
					id: state,
					since: AP.time.now(),
					user: Client.viewer,
					metatype: "message",
					type: "drivefile",
					attachments: files
				};
				
				Message.form.onSending(pending_msg, channel);
				
				AP.post(Message.api+"api/message/file/drive.upload", data, function(code){
					if (!code.good()){
						Message.trigger("message.rejected", [data, data.state]);
						return AP.alertError(code.message);
					}
					
					Message.form.onSent(code.message, data.state);
				});
            }
        });
	};
	
	
	this.sticker=function(channel, sticker_key, sticker_src){
		if (!channel){
			return;
		}
		
		var state=AP.uuid();
		var data={
			state: state,
			content: sticker_key,
			channel_id: channel.id,
			type: 'sticker',
		};
		
		
		var pending_msg={
			state: state,
			content: sticker_key,
			channel_id: channel.id,
			id: state,
			since: AP.time.now(),
			user: Client.viewer,
			metatype: "message",
			type: "sticker",
			sticker_src: sticker_src,
			attachments: []
		};
		
		Message.form.onSending(pending_msg, channel);
		
		AP.post(Message.api+"api/message/message/save", data, function(code){
			if (!code.good()){
				Message.trigger("message.rejected", [data, data.state]);
				return AP.alertError(code.message);
			}
			
			Message.form.onSent(code.message, data.state);
		});
	};
	
	
	this.event=function(event, data){
		return this.socket.send(event, data);
	};
	
	
    
    this.feedback = function(channel) {
        var hiddens = {id: channel.id};
        
        var form = Form.create('feedback-fx', {'action': Message.api + "api/message/channel/feedback"})
            .row(
                Form.noLabel(),
                Form.input({name: 'feedback', "type": "textarea", "placeholder": "The content of your feedback"}).css({height: 120})
            )
            .hiddens(hiddens)
            .buttons([
                {label: "Submit", action: function() {
                    Form.submit("feedback-fx", function(code) {
                    if (!code.good()) {
                        return AP.alertError(code.message);
                    }
                    
                    Form.hide("feedback-fx");
                    // UI.flash("Form submitted");
                    return AP.alertSuccess(code.message);
                    });
                }, style: 'ok -success -rounded bold'},
                {label: "Cancel", action: function() {
                    Form.hide("feedback-fx");
                }, style: 'cancel passive-3 rounded'}
            ]).settings({block: true});
        
        Form.pop({id:'feedback-fx-dx', width: 600, label: icon("entypo ticon-docs") + 'Send a feedback/report'}).setForm(form).show().focus('feedback');
    };
    
	function fix_post_array(files, name){
		var data={};
		for (var i=0; i<files.length; i++){
			for (var key in files[i]){
				data[name+""+i+"_"+key]=files[i][key];
			}
		}
		
		$.log(data);
		return data;
	};
};


Message.seen=new function __MsgSeen(){
	this.init=function(){
		Message.socket.on("channel.user.active", function(data){
			var channel_id=parseInt(data.channel_id);
			var user_id=parseInt(data.user_id);
			
			var $box=$("#channel-"+channel_id+" .channel-seens");
			if (!$box.length){
				return;
			}
			
			var seens=$box.data("seens");
			if (!seens){
				seens=[];
			}
			
			insertSeens($box, seens, user_id);
		});
		
		Message.socket.on("channel.seens", function(data){
			Message.seen.render(data.channel_id, data.seens);
		});
	};
	
	
	this.get=function(channel, callback){
		Message.socket.emit("channel.seens", {channel_id: channel.id, channel_token: channel.token});
	};
	
	
	this.render=function(channel_id, seens, actives){
		var $box=$("#channel-"+channel_id+" .channel-seens");
		if (!$box.length){
			return;
		}
		
		$box.data("seens", seens);
		display($box);
	};
	
	
	function display($box){
		var seens=$box.data("seens");
		if (!seens){
			return;
		}
		
		var html=AP.render(seens, function(e, index){			
			var u=People.get(e);
			if (!u.uid || !parseInt(u.uid)){
				return "";
			}
			
			return "<div class='avatar' title='Seen by "+(u.name)+" (@"+(u.username)+")'><img src='"+(AP.xthumb(u.gavatar))+"'></div>";
		});
		
		$box.html("<div class='avatars'>"+html+"</div>");
	};
	
	
	function insertSeens($box, seens, user_id){
		seens.push(parseInt(user_id));
		seens=AP.array.unique(seens);
		$box.data("seens", seens);
		display($box);
	};
};



Message.call=new function __ChannelCall(){
	this.click=function(channel){
		window.open(Base.domain("message")+"/videocall/"+channel.id,"","width=800,height=600");
		
		UI.ajaxShow();
		AP.post(Message.api+"api/message/call/start",{id: channel.id}, function(code){
			UI.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
		});
	};
	
	this.display=function(call_id){
		Message.socket.emitMe("call.close", {id: call_id});
	};
	
	
	this.show=function(call){
		Message.callrender.reset();
		Message.callrender.join(call, function(){
			Message.callrender.prepare();
		});
	};
	
	
	
	this.getCallInfo=function(call_id, callback){
		AP.post(Message.api+"api/message/call/info",{id: call_id}, function(code){
			UI.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			callback(code.call);
		});
	};
};






Message.callrender = new function __MessageCallRender(){
	this.loaded=false;
	this.room=null;
	this.previewMedia=null;
	
	
	this.reset=function(call){
		if (!$("#call-canvas").length){
			$("<div id='call-canvas'></div>").appendTo("#document");
		}
		
		$("#call-canvas").empty().show().html("<div class='canvas loading'><div class='in'>" +
			"<div class='loading'><span class='ficon-spin ficon-spinner'></span> &nbsp; Waiting for participants ...</div>" +
			"<div class='video-area' id='remote-media'></div>" +
			"<div class='preview' id='my-media'></div>" +
		"</div></div>" +
		"<div class='buttons'>" +
		"	<div class='bt button-audio' onclick='Message.callrender.stopAudio();'><div class='signal'></div><span class='-ap icon-mic3'></span></div>" +
		"	<div class='bt -er' onclick='Message.callrender.disconnect();'><div class='signal'></div><span class='-ap icon-phone-hang-up'></span></div>" +
		"	<div class='bt button-video' onclick='Message.callrender.stopVideo();'><div class='signal'></div><span class='-ap icon-videocam'></span></div>" +
		"</div>").show();
	};
	
	
	this.join=function(call, callback){
		getToken(call, function(data){
			var videoClient = new Twilio.Video.Client(data.token);
			videoClient.connect({to: call.room}).then(function(room) {
				Message.callrender.room=room;
				
				// Draw local video, if not already previewing
				if (!Message.callrender.previewMedia) {
					room.localParticipant.media.attach('#my-media');
				}
				  
				room.participants.forEach(function (participant) {
					$.log("Already in Room: '" + participant.identity + "'");
					participant.media.attach('#remote-media');
					$("#call-canvas .canvas").removeClass("loading");
				});

				// When a participant joins, draw their video on screen
				room.on('participantConnected', function (participant) {
					$.log("Joining: '" + participant.identity + "'");
					participant.media.attach('#remote-media');
					$("#call-canvas .canvas").removeClass("loading");
				});

				// When a participant disconnects, note in log
				room.on('participantDisconnected', function (participant) {
					$.log("Participant '" + participant.identity + "' left the room");
					participant.media.detach();
				});
				
				room.on('disconnected', function () {
					room.localParticipant.media.detach();
					room.participants.forEach(function (participant) {
						participant.media.detach();
					});
					Message.callrender.room=null;
					$("#call-canvas").empty().hide();
				  });

				
				
				callback();
			}, function (error) {
				$.log('Could not connect to Twilio: ' + error.message);
				AP.alertError("Could now start the call. Make sure that the camera and speaker are ON.", function(){
					Message.callrender.disconnect();
				})
			});
		});
	};
	
	
	this.prepare=function(){
		return;
		
		if (!this.previewMedia) {
			this.previewMedia = new Twilio.Video.LocalMedia();
			Twilio.Video.getUserMedia().then(
				function (mediaStream) {
					Message.callrender.previewMedia.addStream(mediaStream);
					Message.callrender.previewMedia.attach('#my-media');
				},
				function (error) {
					console.error('Unable to access local media', error);
					log('Unable to access Camera and Microphone');
				}
			);
		};
	};
	
	
	this.disconnect=function(){
		if (this.room){
			this.room.disconnect();
		}
		
		$("#call-canvas").fadeOut(300, function(){
			$(this).remove();
		});
	};
	
	
	this.stopVideo=function(){
		if (!this.room){
			return;
		}
		
		$("#call-canvas .buttons .button-video").toggleClass("disabled");
		
		var localMedia=this.room.localParticipant.media;
		localMedia.videoTracks.forEach(function (track) {
			if (track.isEnabled) {
				track.disable();
			} else {
				track.enable();
			}
		});
	};
	
	this.stopAudio=function(){
		if (!this.room){
			return;
		}
		
		$("#call-canvas .buttons .button-audio").toggleClass("disabled");
		
		var localMedia=this.room.localParticipant.media;
		localMedia.audioTracks.forEach(function (track) {
			if (track.isEnabled) {
				track.disable();
			} else {
				track.enable();
			}
		});
	};
	
	function getToken(call, callback){
		initJS(function(){
			UI.ajaxShow();
			AP.post(Message.api+"api/message/call/token", {id: call.id},function(code){
				UI.ajaxHide();
				
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				callback(code.token);
			});
		});
	};
	
	
	function initJS(callback){
		if (Message.callrender.loaded){
			callback();
			return;
		}
		
		$.apScript("https://media.twiliocdn.com/sdk/js/video/releases/1.0.0-beta2/twilio-video.js", function(){
			Message.callrender.loaded=true;
			callback();
		}, "twilio-lib");
	};
};



Message.html=new function __MessageHTML(){
	this.onUpdate=function(message, channel){
		$("#msg-"+message.id+" .reaction-list").replaceWith(Like.reaction.getReactions(message));
		$("#msg-"+message.id+" .reaction-wrapper").html(Like.reaction.getReactionIcon(message));
		// $("#msg-"+message.id+" .linked.js-actions").html(getActions(message));
		
		if ($("#msg-"+message.id).hasClass("-linked")){
			var r=$("#msg-"+message.id+" .msg-reactions").width()+10;
			
			$("#msg-"+message.id+" .linked-time").css({right: 15+r});
		}
	};
	
	
	this.onRemove=function(message, channel){
		$("#msg-"+message.id+" .body").html("<span class='msg-body'>"+message.content+"</span>");
		$("#msg-"+message.id+" .attachments").remove();
	};
	
	
	
	this.addMessage=function(message, channel){
		addDaySeparation(message, channel);
		removePending(message, channel);
		
		var html=getMessageHTML(message, channel);
		var last=getLastMessage(channel);
		append(html, channel);
		
		if (linkable(message, last)){
			$("#msg-"+message.id).addClass("-linked");
			if (!last.elem.hasClass("-linked")){
				last.elem.addClass("-first");
			}
		}else{
			$("#msg-"+message.id).addClass("-leading");
		}
		
		$("#msg-"+message.id).addClass("__p");
		
		this.scrollDown(message.id, channel, 0);

	};
	
	
	/**
	 * @desc Prepend message
	 */
	this.prependMessage=function(message, channel){
		prependDaySeparation(message, channel);
		var html=getMessageHTML(message, channel);
		prepend(html, channel);
	};
	
	
	this.updateMessage=function(message, channel, state){
		var html=getMessageHTML(message, channel);
	};
	
	
	this.getHTML=function(message, channel, ns){
		return getMessageHTML(message, channel, ns);
	};
	
	
	/**
	 * @desc Linking a group of messages
	 */
	this.linkGroup=function(channel){
		var $box=$("#channel-"+channel.id+" .channel-messages");
		$box.children().each(function(){
			var $this=$(this);
			if ($this.hasClass("__p") || $this.hasClass("ds")){
				return;
			}
			
			$this.addClass("__p");
			
			var $prev=$this.prev();
			
			var _linkable=false;
			if ($prev && $prev.length && $prev.hasClass("message")){
				if ($prev.data("user")==$this.data("user") && AP.time.sameDay($prev.data("ts"), $this.data("ts"))){
					if ($this.data('metatype')==$prev.data('metatype') && !parseInt($this.data('attachments')) && $this.data('metatype')=="message"){
						_linkable=true;
					}
				}
			}
			
			if (_linkable){
				$this.addClass("-linked");
				if (!$prev.hasClass("-linked")){
					$prev.addClass("-first");
				}
			}else if ($this.hasClass("message")){
				$this.addClass("-leading");	
			}
		});
	};
	
	
	
	/**
	 * @desc Add a pending (fake) message
	 */
	this.addPendingMessage=function(message, channel){
		addDaySeparation(message, channel);
		if (message.content && message.content.length){
			message.content=safe(message.content);	
		}
		
		var html="<div class='message -saved' data-user='"+message.user.id+"' data-metatype='"+message.metatype+"' data-subtype='"+message.subtype+"' data-ts='"+message.since+"' id='msg-"+message.id+"'>" +
			"<div class='wrapper'>" +
			"	<div class='image'>"+getUser(message.user)+"</div>" +
			"	<div class='content'>" +
			"		<div class='header'>" +
			"			<em>"+message.user.name+"</em>" +
					"	<span class='time'>"+getTime(message.since)+"</span>" +
					"</div>" +
					"<div class='body'>"+getContent(message)+"</div>"+
			"		<div class='linked-time'>"+getTime(message.since)+"</div>" +
			"	</div>" +
			"</div>" +
		"</div>";
		
		var last=getLastMessage(channel);
		append(html, channel);
		
		if (linkable(message, last)){
			$("#msg-"+message.id).addClass("-linked");
			if (!last.elem.hasClass("-linked")){
				last.elem.addClass("-first");
			}
		}
		
		this.scrollDown(null, channel, 100);
	}
	
	
	
	
	
	this.scrollDown=function(msgid, channel, anim_time, callback, offset){
		var cid=Channel.id(channel);
		
		var $target=null;
		if (!msgid){
			$target=$("#channel-"+cid+" .channel-messages").children().last();
		}else{
			$target=$("#msg-"+msgid);
		}
		
		if (typeof anim_time=="undefined"){
			anim_time=500;
		}
		
		var $box=$target;
		if (!$box.length){
			return;
		}
		
		var h=$box.position().top;
		var $canvas=$box.closest('.scrollin');
		
		if (!offset){
			offset=10;
		}
		
		var st= h+$canvas.scrollTop()-offset;

		$canvas.animate({scrollTop: st}, anim_time, function(){
			if (callback){
				callback();
			}
		});
	};
	
	this.scrollBottom=function(channel_id, offset){
		this.scrollDown(0, channel_id, 100, null, -200);
		$("#channel-"+channel_id).removeClass("has_new_message");
	};
	
	
	this.forceScrollBottom=function(channel_id){
		var $c=$("#channel-"+channel_id+" .scrollin");
		if ($c && $c.length){
			$c.scrollTop($c[0].scrollHeight);	
		}
	};
	
	
	this.scrollTop=function(channel, anim_time, callback){
		this.scrollDown($("#channel-"+channel.id).find(".message").first(), channel, anim_time, callback);
	};
	
	
	function removePending(msg){
		if (!msg.state || !msg.state.length || parseInt(msg.user.id)!=parseInt(Client.viewer.id)){
			return; // No duplication
		}
		
		if ($("#msg-"+msg.state).length){
			$("#msg-"+msg.state).remove();
		}
	};
	
	
	function addDaySeparation(message, channel){
		var $last=getLastMessage(channel);
		if (!$last || !$last.ts){
			return;
		}
		
		var ts=$last.ts;
		
		if (AP.time.sameDay(message.since, ts)){
			return "";
		}
		
		append("<div class='ds'><div class='date'>"+AP.time.time("%D, %d/%m/%Y", message.since)+"</div></div>", message.channel_id);
	};
	
	
	function prependDaySeparation(message, channel){
		var $first=getFirstMessage(channel);
		if (!$first || !$first.ts){
			return;
		}
		
		var ts=$first.ts;
		
		if (AP.time.sameDay(message.since, ts)){
			return "";
		}
		
		prepend("<div class='ds'><div class='date'>"+AP.time.time("%D, %d/%m/%Y", message.since)+"</div></div>", message.channel_id);
	};
	
	
	
	function getLastMessage(channel){
		var $last=$("#channel-"+channel.id+" .message").last();
		if (!$last || !$last.data("metatype")){
			return {};
		}
		
		return {elem: $last, metatype: $last.data("metatype"), type: $last.data("type"), "ts": $last.data("ts"), "user": $last.data("user"), counter: 0}
	};
	
	
	
	function getFirstMessage(channel){
		var $first=$("#channel-"+channel.id+" .message").first();
		if (!$first || !$first.data("metatype")){
			return {};
		}
		
		
		return {elem: $first, metatype: $first.data("metatype"), type: $first.data("type"), "ts": $first.data("ts"), "user": $first.data("user"), counter: 0}
	};
	
	
	
	
	function linkable(msg, last){
		if (msg.subtype=="sticker"){
			return false;
		}
		
		if (!msg.attachments){
			return false; // Data error
		}
		
		if (!parseInt(last.user)){
			return false;
		}
		
		if (last.counter>=5){
			return false;
		}
		
		var ts=parseInt(last.ts);
		var mts=parseInt(msg.since);
		
		if (!AP.time.sameDay(ts, mts) || Math.abs(mts-ts)>=300){
			return false;
		}
		
		return msg.user.id==last.user && msg.metatype==last.metatype && !msg.attachments.length && msg.metatype=="message";
	};
	
	
	function getContent(message){
		if (message.content=="buzz!"){
			return "<span class='msg-buzz bold red upper'>BUZZ!</span>";
		}
		if (message.type=="sticker" && message.sticker_src && message.sticker_src.length){
			return "<div class='sticker'><img src='"+message.sticker_src+"'/></div>";
		}

		if (message.subtype=="sticker"){
			return "<div class='sticker'><img src='"+message.content+"'/></div>";
		}
		
		if (!message.content.length){
			return "";
		}
		
		if (message.subtype=="log"){
			return "<span class='log'>"+message.content+"</span>";
		}
		
		
		var mc=UI.emotion(UI.parse(message.content));
		if (mc.length){
			mc=mc.replace(/⑊/g,'&#92;').replace(/&#9290;/g, '&#92;');
		}
		return "<span class='msg-body'>"+mc+"</span>";
	};
	
	function getAttachments(message){
		if (!message.attachments.length) return "";
		
		return AP.render(message.attachments, function(att){
			return getAttachment(att);
		})
	};
	
	function getAttachment(att){
		return Message.attachment.get(att);
	};
	
	
	function getUser(user){
		if (user.bot){
			$.log(user);
			image=user.image;
			
			if (!image){
				image=Client.share_url+"/bots/"+user.username+".png";
			}
			return "<div class='avatar'><img src='"+image+"'/></div>";	
		}
		return "<div class='avatar'><img src='"+AP.thumb(user.gavatar)+"'/></div>";
	};
	
	
	function getActions(message){
		var hl="";
		if (parseInt(message.pinned)){
			hl="hl";
		}
		
		var shl="";
//		if (Channel.star.starred(message.id)){
//			shl="hl";
//		}
		
		return "<span class='action "+shl+"'' onclick='Message.toggleStar(this);'>" +
				"<span class='actiontt'><span class='ttb'>Star message</span></span>" +
				"<span class='-ap icon-star_outline'></span>" +
			"</span>"+
		"<span class='action "+hl+"' onclick='Message.togglePin(this);'>" +
			"<span class='actiontt'><span class='ttb'>Pin message</span></span>" +
			"<span class='-ap icon-pin-outline'></span>" +
		"</span>";
	};
	
	function getTime(time){
		return AP.time.time("%H:%i", time);
	};
	
	
	
	function append(text, channel){
		$("#channel-"+channel.id+" .channel-messages").append(text);
	};
	
	
	function prepend(text, channel){
		$("#channel-"+channel.id+" .channel-messages").prepend(text);
	};
	
	
	
	
	
	function getMessageHTML(message, channel, ns){
		var msguser=message.user;
		var user=null;
		var extra="";
		if (parseInt(msguser.id) && msguser.username){
			user=People.get(msguser.username);
			if (!user){
				return "";
			}
		}else if(parseInt(msguser.id)===0 && msguser.username=="_bot"){
			user=msguser.user_export;
			user.bot=1;
			if (msguser.gavatar){
				user.image=msguser.gavatar;
			}
			
			extra="<span class='bottype'>BOT</span>";
			if (user.instant){
				extra="<span class='bottype'>IBOT</span>";	
			}
		}
		
		var na=0;
		if (message.attachments){
			na=message.attachments.length;
		}
		
		if (!ns){
			ns="msg";
		}
		
		var forward="";
		if (message.attachments && message.attachments.length && message.intent=="file"){
			forward="&nbsp; <span class='action pointer' onclick='Message.forwardFile(this);' title='Forward this file ..'> <span class='-ap icon-forward'></span> </span>";
		}
		
		var html="<div class='message -saved' title='"+AP.time.time("%H:%i %d/%m",message.since)+" - "+AP.time.ago(message.since)+"' data-msgid='"+message.id+"' data-user='"+message.user.id+"' data-metatype='"+message.metatype+"' data-type='"+message.subtype+"' data-ts='"+message.since+"' data-attachments='"+na+"' id='"+ns+"-"+message.id+"'>" +
			"<div class='wrapper'>" +
			"	<div class='image'>"+getUser(user)+"</div>" +
			"	<div class='content'>" +
			"		<div class='header ap-xdot'>" +
			"			<em class='url' data-username='"+user.username+"'>"+user.name+"</em>" + extra +
					"	<span class='time ap-f12'>"+getTime(message.since)+forward+"</span>" +
					"	<span class='actions'>"+getActions(message)+"</span>" +
					"</div>" +
			"		<div class='body-wrapper'>" +
			"			<div class='msg-reaction-button scale-small'>"+Like.reaction.getReactionIcon(message)+"</div>"+
			"			<div class='body'>"+getContent(message)+"</div>" +
			"		</div>" +
			"		<div class='linked'>"+getActions(message)+"</div>" +
			"		<div class='linked-time'>"+getTime(message.since)+"</div>" +
			((message.attachments && message.attachments.length)?("<div class='attachments'>"+getAttachments(message)+"</div>"):"") +
				Like.reaction.getReactions(message)+
			"	</div>" +
			"</div>" +
		"</div>";
		
		return html;
	}
};


Message.attachment = new function __MessageAttachments(){
	this.get=function(att, index){
		if (!att || !att.metatype){
			return "";
		}
		
		if (att.metatype=="base"){
			return "<div class='att -fileatt -filedrive -idx"+index+" -with-file-icon' data-metatype='"+att.metatype+"'>" +
				"<div class='att-box'>" +
					"<div class='att-file-icon'><img src='"+Client.share_url+"/32/file-text2.png'/></div>"+
					"<div class='att-title'><span class='a url' onclick=\"Base.file.preview('"+att.src+"');\">"+att.name+"</span></div>"+
					"<div class='att-footer'><span class='a url' onclick=\"Base.file.preview('"+att.src+"');\">Chi tiết</span> &middot; <a target='_blank' href='"+att.download+"'>Download</a></div>"+
				"</div>" +
				getCollapse(att)+
			"</div>";
		}
		
		if (att.metatype=="dropbox" || att.metatype=="onedrive" || att.metatype=="googledrive"){
			return "<div class='att -fileatt -filedrive -idx"+index+" -with-file-icon' data-metatype='"+att.metatype+"'>" +
				"<div class='att-box'>" +
					"<div class='att-file-icon'><img src='"+Client.share_url+"/32/file-"+att.metatype+".png'/></div>"+
					"<div class='att-title'><span class='a url' data-url='"+att.weblink+"' target='_blank'>"+att.name+"</span></div>"+
					"<div class='att-footer'><a href='"+att.weblink+"' target='_blank'>Chi tiết</a> &middot; <a target='_blank' href='"+att.download+"'>Download</a></div>"+
				"</div>" +
				getCollapse(att)+
			"</div>";
		}
		
		if (att.metatype=="link" || att.metatype=="video" || att.metatype=="file" || att.metatype=="topic" || 1==1){
			var extra='';
			if (att.metatype=="file" && att.cache){
				extra="data-file_id='"+(att.cache.id)+"' data-file_name='"+(att.title)+"'";
			}
			
			return "<div class='att "+getClass(att)+"' data-metatype='"+att.metatype+"'"+extra+">" +
				getImage(att)+
				"<div class='att-box'>" +
					getLeft(att)+
					getHeader(att)+
					getDisplayFile(att)+
					getCover(att)+
					getTitle(att)+
					getText(att)+
					getFeatures(att)+
					getPlayVideo(att)+
					getFooter(att)+
				"</div>" +
				getCollapse(att)+
			"</div>";
		}
	};
	
	
	
	
	this.collapse=function(ref){
		var $att=$(ref).closest(".att");
		if ($att.hasClass("-collapsed")){
			$(".att-image", $att).slideDown(300);
			$(".att-text", $att).slideDown(300);
			$(".att-footer", $att).slideDown(300);
			$(".att-video", $att).slideDown(300);
			$(".att-display-file", $att).slideDown(300);
			$att.removeClass("-collapsed");
		}else{
			// $att.toggleClass("-collapsed");
			$(".att-image", $att).slideUp(300);
			$(".att-text", $att).slideUp(300);
			$(".att-footer", $att).slideUp(300);
			$(".att-video", $att).slideUp(300);
			$(".att-display-file", $att).slideUp(300);
			$att.addClass("-collapsed");
		}
	};
	
	
	function getClass(att){
		var cs=[];
		if (att.image && att.image.length && att.metatype!="video" && att.metatype!="file"){
			cs.push("-with-image");
		}else if (att.icon && att.icon.length){
			if (att.size && att.size=="small"){
				cs.push("-with-small-icon");
			}else{
				cs.push("-with-icon");	
			}
		}
		
		if (att.metatype=="file"){
			cs.push("-fileatt");
			
			if(typeof att !== 'undefined' && typeof att.image !== 'undefined') {
			    if (!att.image && !att.image.length){
	                cs.push("-with-file-icon");
	            }
			}
		}
		
		return cs.join(" ");
	};
	
	
	function getLeft(att){
		if (att.metatype=="file"){
			return "";
		}
		
		if (att.icon && att.icon.length){
			return "<div class='att-icon'><img src='"+Client.share_url+"/messages/"+att.icon+"'/></div>";
		}
		
		return "<div class='att-r'></div>";
	};
	
	function getImage(att){
		if (att.metatype=='video' || att.metatype=='file'){
			return "";
		}
		
		if (att.image && att.image.length){
			return "<div class='att-image'><div class='img'><img src='"+AP.thumb(att.image)+"'/></div></div>";
		}
		
		
		return "";
	};
	
	
	
	
	function getHeader(att){
		return "";
	};
	
	function getTitle(att){
		if (!att.title || !att.title.length){
			return "";
		}
		
		if (att.metatype=="file" && att.src){
			return "<div class='att-title'><span class='a url' data-url=':file' data-file='"+att.src+"'>"+att.title+"</span></div>";
		}
		
		if (!att.url){
			return "<div class='att-title'>"+att.title+"</div>";
		}
		
		return "<div class='att-title'>"+Base.a(att.url, att.title)+"</div>";
	};
	
	function getText(att){
		if (att.text && att.text.length){
			return "<div class='att-text'>"+att.text+"</div>";
		}
		
		return "";
	};
	
	
	function getFeatures(att){
		if (att.features && att.features.length){
			return "<div class='att-features'>"+AP.render(att.features, function(e){
				return getFeature(e);
			})+"</div>";
		}
		
		return "";
	};
	
	
	function getFeature(e){
		if (!e.label){
			return "";
		}
		
		if (parseInt(e.short)){
			return "<div class='feature -s'>" +
				"<div class='label ap-xdot'>"+e.label+"</div>" +
				"<div class='value ap-xdot' title='"+e.evalue+"'>"+e.value+"</div>" +
			"</div>";
		}
		
		return "<div class='feature -xs'>" +
			"<div class='label'>"+e.label+"</div>" +
			"<div class='value'>"+e.value+"</div>" +
		"</div>";
	};
	
	
	function getFooter(att){
		if (!att.footer || !att.footer.length){
			if (att.metatype=="file"){
				return "<div class='att-footer'>"+att.size+" KB &middot; <a href='"+att.download+"' target='_blank'>Download</a></div>";	
			}
			
			return "";
		}
		
		if (!att.footer_url || !att.footer_url.length){
			return "<div class='att-footer'>"+getFooterIcon(att)+""+att.footer+"</div>";
		}
		
		return "<div class='att-footer'>"+getFooterIcon(att)+"<a href='"+att.footer_url+"' target='_blank'>"+att.footer+"</a></div>";
		
	};
	
	
	function getFooterIcon(att){
		if (att.footer_icon && att.footer_icon.length){
			var parts=att.footer_icon.split(" ");
			if (parts.length==2){
				return "<span class='att-footer-icon'><span class='-ap icon-"+parts[0]+"'></span></span>";
			}else{
				return "<span class='att-footer-icon'><span class='-ap icon-"+parts[0]+"'></span></span>";
			}
		}

		return "";
	}
	
	function getPlayVideo(att){
		if (att.metatype!='video'){
			return "";
		}
		
		if (att.image && att.image.length){
			return "<div class='att-video'>" +
				"<div class='video-screen'><img src='"+att.image+"'/></div>" +
				"<div class='video-mask'></div>" +
				"<div class='play-button'>" +
				"	<div class='button-fix'></div>" +
				"	<div class='button' data-play-url='"+att.video_play_url+"'><span class='-ap icon-play_circle_filled'></span></div>" +
				"</div>" +
				"<div class='link-button'><a target='_blank' href='"+att.url+"'><span class='-ap icon-open_in_new'></span></a></div>" +
			"</div>";
		}
		
		return "";
	};
	
	
	/**
	 * @desc Special case, get displayed video
	 */
	function getDisplayFile(att){
		if (att.metatype!="file"){
			return "";
		}
		
		if (att.image && att.image.length){
			return "<div class='att-display-file'><span class='url' data-url=':file' data-file='"+att.src+"'><img src='"+att.image+"'/></span></div>";
		}else{
			var icon=UI.file.icon(UI.file.ext(att.name));
			return "<div class='att-file-icon'><img src='"+Client.share_url+"/32/file-"+icon+".png'/></div>";
		}
		
		
		return "";
	};
	
	
	function getCover(att){
		if (!att.cover || !att.cover.length){
			return "";
		}
		
		if (att.cover_url && att.cover_url.length){
			return "<div class='att-cover'><a href='"+att.cover_url+"'><img src='"+att.cover+"'/></a></div>";
		}else{
			return "<div class='att-cover'><span><img src='"+att.cover+"'/></span></div>";
		}
	};
	
	
	
	function getCollapse(att){
		if (!att.title || !att.title.length){
			return "";
		}
		return "<div class='att-collapse' onclick=\"Message.attachment.collapse(this);\"><span class='-ap icon-chevron-down2'></span></div>";
	};
};


Message.form = new function __MessageForm(){
	this.imTyping=false; // I'm currently not typing
	
	this.globalInit=function(){
		
	};
	
	
	/**
	 * @desc Only build after the Channel.channel is fully loaded
	 */
	this.build=function(channel){		
		this.untyping();
		this.imTyping=false;
		
		$("#channel-"+channel.id).data("channel", channel);
		
		this.initTyping(channel);
		$("#channel-"+channel.id+" .msg-input").on("input focus", function(){
			Message.form.updateState(this);
		}).on("blur", function(){
			Message.form.untyping(channel);
			Message.form.updateState(this);
		});
		
		Tag.user("#channel-"+channel.id+" .msg-input", People.collect(channel.followers));
		$("#channel-"+channel.id+" .msg-input").autoExpand();
		
		
		$("#channel-"+channel.id+" .msg-input").enter(function(){
			Message.form.send(this);
		}).screencopy(Message.api+"api/message/file/screenshot", function(code){
		},{
			channel_id: channel.id, channel_token: channel.token
		});
		
		AP.uploadable("#channel-"+channel.id+" .channel-upload-file",{
			action: Message.api+"api/message/file/upload",
			data: {channel_id: channel.id, dnd: 1, multi: 1},
			multi: 1
		}, function(code){
			$.log(code);
		});
		
		AP.uploadable("#channel-"+channel.id+" .channel-upload-image",{
			action: Message.api+"api/message/file/upload",
			data: {channel_id: channel.id, dnd: 1, multi: 1},
			multi: 1
		}, function(code){
			$.log(code);
		});

		$("#channel-"+channel.id+" .channel-buzz").click(function(){
			Message.sender.buzz(channel);
        });
        
        $("#channel-" + channel.id + " .channel-feedback").click(function(){
			Message.sender.feedback(channel);
		});
		
		$("#channel-"+channel.id+" .channel-like").click(function(){
			Message.sender.text("(Y)", channel);
		});
		
		
		$("#channel-"+channel.id+" .channel-upload-drive").click(function(){
			Message.sender.drive(channel);
		});
		
		this.initDnD(channel);
		Sticker.init(channel);
		
		$("#channel-"+channel.id+" .scrollin").on("scroll", function(e){
			if (e.originalEvent && e.originalEvent.isTrusted){
				$(this).data("last_scroll", AP.time.now());
			}
		});
		// .after("<div class='new_message_trigger' onclick='Message.form.forceScrollDown(this);'><span class='-ap icon-arrow_drop_down'></span> New message</div>");
	};
	
	
	this.initDnD=function(channel){
		AP.dnd("#channel-"+channel.id, Message.api+"api/message/file/upload",{
			"channel_id": channel.id,
			"channel_token": channel.token,
			"dnd": 1
		}, function(code){
			$.log(code);
		},{
			multi: true
		});
	};
	
	
	this.onSending=function(msgdata, channel){
		$("#channel-"+channel.id+" .msg-input").val("").trigger("keypress").focus().change().height(26);
		Message.html.addPendingMessage(msgdata, channel);
	};
	
	this.onSent=function(msg, state){
		this.untyping();
	};
	
	
	this.send=function(ref){
		var $canvas=$(ref).closest(".msg-channel");
		var channel=$canvas.data("channel");
		
		var content=$(ref).val();
		if (!content.length){
			return;
		}
		
		Message.sender.text(content, channel);
	};

	
	
	this.typing_last_time=AP.time.now();
	this.typing_last_event="none";
	this.typing_last_channel=0;
	this.typing_text=0;
	
	
	this.initTyping=function(channel){
		var id=Channel.id(channel);
		$("#channel-"+id+" .msg-input").on("keyup", function(e){
			Message.form.checkTyping(id);
		});
	};
	

	this.untyping=function(){
		if (this.imTyping){
			this.imTyping=false;
			Message.socket.send("imtyping", 0);
		}else{
			if (AP.time.now()-this.typing_last_time>3 || 1==1){
				this.typing_last_time=AP.time.now();
				this.typing_event="untyping";
				Message.socket.send("imtyping", 0);
			}
		}
		
		this.imTyping=false;
	};
	
	
	
	this.checkTyping=function(channel){		
		if (!Base.tabActive()){
			this.untyping();
			return;
		}
		
		var id=Channel.id(channel);
		
		var val=$("#channel-"+id+" .msg-input").val();
		if (val && val.length){
			this.typing_last_time=AP.time.now();
			this.typing_event="typing";
			
			if (!this.imTyping){
				this.imTyping=true;
				if (val != this.typing_text){
					typing_text=val;
					Message.socket.send("imtyping", id);
				}
				
				setTimeout(function(){
					if (Message.form.typing_event=="typing" && AP.time.now() - Message.typing_last_time >=5){
						Message.form.untyping();
					}
				}, 6000);
			}
		}else{
			this.untyping();
		}
	};
	
	

	this.updateTypings=function(channel_id, users){
		if (!$("#channel-typing-"+channel_id).length){
			return;
		}
		
		var typings=AP.array.filter(users, function(e){
			if (e.id==Client.viewer.id){
				return false;
			}
			return true;
		});
		
		if (!typings.length){
			$("#channel-typing-"+channel_id).slideUp(50);
			$("#channel-"+channel_id+" .channel-typing-fix").hide();
			return;
		};
		
		var text=AP.word.join(typings, ", ",function(e){
			var person=People.getID(e.id);
			return "<span class='av'><img src='"+AP.xthumb(person.gavatar)+"'/></span><em>"+person.first_name+"</em>";
		});
		
		// Get scroll position
		var offset_bottom=getOffsetBottom("#channel-typing-"+channel_id);
		var last_time=$("#channel-typing-"+channel_id).closest(".scrollin").data("last_scroll");
		
		if (offset_bottom>30 || (last_time && AP.time.now()-parseInt(last_time) > 30)){
			showNewMessageBelow(channel_id);
			$("#channel-typing-"+channel_id).show();
		}else{
			$("#channel-typing-"+channel_id).slideDown(100, function(){
				Message.html.forceScrollBottom(channel_id);
			});
		}
		
		if (typings.length>=2){
			$("#channel-typing-"+channel_id+" .typing .text").html(text+" are tyings <span class='dots'><span></span></span>");	
		}else{
			$("#channel-typing-"+channel_id+" .typing .text").html(text+" đang viết <span class='dots'><span></span></span>");
		}
		
		$("#channel-"+channel_id+" .channel-typing-fix").show();
	};
	
	
	this.updateState=function(ref){
		var channel=getChannel(ref);
		if (!channel){
			return;
		}
		
		var val=$(ref).val();
		if (val && val.length){
			$("#msg-form-"+channel.id).addClass("active");
		}else{
			$("#msg-form-"+channel.id).removeClass("active");
		}
	};
	
	
	this.forceScrollDown=function(ref){
		var $box=$(ref).closest(".msg-channel");
		$box.removeClass("has_new_message");
		Message.html.forceScrollBottom($box.data("id"));
	};

	
	/**
	 * @desc Get offset relative to bottom
	 */
	function getOffsetBottom(eid){
		var $c=$(eid).closest(".scrollin");
		if (!$c.length){
			return;
		}
		
		var offset=$c[0].scrollHeight-$c[0].offsetHeight - $c[0].scrollTop;
		
		return offset;
	};
	
	
	
	function showNewMessageBelow(channel_id){
		// $("#channel-"+channel_id).addClass("has_new_message");
	};
};



Message.cache=new function __MessageCache(){
	this.data={};
	
	this.get=function(id){
		return null;
		
		if (AP.data.isObject(id)){
			return id;
		}
		var c=AP.array.findObj(Channel.manager.channels, id);
		if (c){
			return {channel: c, messages: [], page_token: 0};
		}
		
		return null;
	};
	
	
	this.getValue=function(obj, key){
		if (this.data["x"+obj.id+"_"+key]){
			return this.data["x"+obj.id+"_"+key];
		}
		
		return null;
	};
	
	this.setValue=function(obj, key, value){
		this.data["x"+obj.id+"_"+key]=value;
	};
	
	
	this.currentChannels=function(){
		var cs=Clog.getCookie("msgchannels");
		if (cs && cs.length){
			try{
				var r= JSON.parse(cs);
				if (r.length && !r[0].id){
					return [];
				}
				
				return r;	
			}catch(e){
				return [];
			}
		}
		
		return [];
	};
	
	
//	this.setCurrentChannels=function(ids){
//		Clog.setCookie("msgchannels", JSON.stringify(ids));
//	};
//	
	
	this.auto=function(){
		var r=[];
		
		$("#js-msg-boxes .msg-channel.is-channel").each(function(){
			var id=$(this).data("id");
			var c=0;
			if ($(this).hasClass("collapsed")){
				c=1;
			}
			
			r.push({id: id, c: c});
		});
		
		r=r.slice(0, 4);
		Clog.setCookie("msgchannels", JSON.stringify(r));
		
		if ($("#msg-panel").length && $("#msg-panel").hasClass("collapsed")){
			Clog.setCookie("msgpc", 1); 	
		}else{
			Clog.setCookie("msgpc", 0);
		}
	};
	
	
	this.removeCachedChannel=function(id){
		Clog.removeCookie("msgchannels");
	};
	
};



function getChannel(ref){
	return $(ref).closest(".msg-channel").data("channel");
};
	
var Channel = new function __Channel(){
	this.channel=null; // The currently active channel
	this.previous=null; // Cache only
	this.channels=[];
	this.current_id=null;
	
	if (typeof Client.base != 'undefined' && Client.base.channels){
		this.__channels=Client.base.channels; // The list of all initally loaded channels, can load more
		if (this.__channels){
			this.channels=this.__channels.slice();
		}	
	}
	
	this.id=function(channel){
		if (AP.data.isObject(channel)){
			return channel.id;
		}
		
		return channel;
	};
	
	
	/**
	 * @desc Check if the channel with ID is currently active
	 */
	this.isActive=function(id){
		// $.log([this.current.name, this.current.id, id]);
		return this.current_id==id;
	};
	
	
	this.setActive=function(channel_id){
		Message.socket.send("channel.active", channel_id);
		
		if (channel_id && parseInt(channel_id)){
			$("#js-msg-boxes .msg-channel").setActive("#channel-"+channel_id);
			Message.canvas.onChannelActive(channel_id);
		}else{
			$("#js-msg-boxes .msg-channel").removeClass("active");
		}
	};
	
	
	this.isDisplayed=function(id){
		return $("#channel-"+id).length>=1;
	};
	
	
	/**
	 * @desc Get channel with channel_id and callback 
	 */
	this.get=function(channel_id, callback, intent){
		if (!channel_id || !AP.data.isInt(channel_id)){
			return;
		}
		var obj = Message.cache.get(channel_id);
		if (obj){
			callback(obj.channel, obj.messages, obj.page_token);
			return;
		}
		
		UI.ajaxShow();
		AP.post(Message.api+"api/message/channel/get", {id: channel_id}, function(code){
			UI.ajaxHide();
			if (!code.good()){
				// Clog.removeLog("__channel");
				if (intent && intent=="cache"){
					Message.cache.removeCachedChannel(channel_id);	
				}else{
					AP.alertError("We have trouble loading messages ["+channel_id+"] ... Please refresh to continue...");	
				}
				
				Channel.close(channel_id);
				return;
			}
			
			callback(code.channel, code.messages, code.page_token, code.stars);
		});
	};
	
	
	
	
	/**
	 * @desc Load the channel
	 */
	this.open=function(channel_id, opts, callback){
		if (this.isDisplayed(channel_id)){
			fixIntention(channel_id, opts.intent);
			return;
		}
		
		if (this.channel && this.channel.id==channel_id){
			if (callback){
				callback();
			}
			return;
		}
		
		this.get(channel_id, function(channel, messages, page_token, stars){
			Channel.openDirect(channel, messages, page_token, stars, callback, opts);
		}, opts.intent);
	};


	this.openDirect=function(channel, messages, page_token, stars, callback, opts){
		display(channel, messages, page_token, stars, callback, opts);
		// Channel.setActive(channel.id);
		// Message.socket.send("channel.active", channel.id);
	};
	
	
	this.close=function(channel){
		var id=Channel.id(channel);
//		var cs=Message.cache.currentChannels();
//		cs=AP.array.filter(cs, function(e){
//			return parseInt(e)!=parseInt(id);
//		});
//		
//		Message.cache.setCurrentChannels(cs);
		
		if (id){
			Message.socket.emitMe("channel.me.close", {id: id});
		}
	};
	
	
	
	this.showMessages=function(channel, messages){
		for (var i=messages.length-1; i>=0; i--){
			Message.addMessage(messages[i], channel);
		};
	};
	

	this.loadPrevious=function(channel){
		var loading=Message.cache.getValue(channel, "loading");
		var page_token=Message.cache.getValue(channel, "page_token");
		if (loading=="0"){
			loading=0;
		}
		
		if (loading || !page_token){
			return;
		}
		
		Message.cache.setValue(channel, "loading", 1);
		UI.ajaxShow();
		
		var $box=$("#channel-"+channel.id+" .scrollin");
		var current_offset=$box[0].scrollHeight;
		
		AP.post(Message.api+"api/message/message/previous", {token: page_token, id: channel.id}, function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				Message.cache.setValue(channel, "loading", 0);
				return AP.alertError("Cannot load previous message");
			}
			
			Message.cache.setValue(channel, "page_token", code.page_token);
			
			for (var i=0; i<code.messages.length; i++){
				Message.html.prependMessage(code.messages[i], channel);
			}
			
			Message.html.linkGroup(channel);
			
			if (code.messages.length){
				current_offset=$box[0].scrollHeight-current_offset;
				$box.scrollTop(current_offset);
				
				Message.cache.setValue(channel, "loading", 0);
			}else{
				Message.cache.setValue(channel, "loading", 0);
			}
			
		});
	};
	
	
	
	function display(channel, messages, page_token, stars, callback, opts){
		if ($("#channel-"+channel.id).length){
			if (opts.prepend){
				$("#channel-"+channel.id).removeClass("collapsed");
				Message.render.balance();
			}
			
			return;
		}
		
		Message.render.channel(channel, opts);
		
		if (!page_token){
			page_token=0;
		}
			
		Message.cache.setValue(channel, "page_token", page_token);
		Channel.showMessages(channel, messages);
		
		if (callback){
			callback();
		};
		
		
		fixIntention(channel.id, opts.intent);
		
	};
	
	
	
	function fixIntention(channel_id, intent){
		if (intent){
			if (intent=="panel"){
				if ($("#channel-"+channel_id).hasClass("collapsed")){
					$("#channel-"+channel_id).removeClass("collapsed");
					Message.canvas.balance();
				}
				
				setTimeout(function(){
					$.log("#channel-"+channel_id+" textarea.msg-input");
					$("#channel-"+channel_id+" textarea.msg-input").autofocus();
				}, 200);
				
				Channel.setActive(channel_id);
			}
		}
	};
	
	
	
};






Channel.manager=new function __ChannelManager(){
	this.channels=[];
	this.ready=0;
	
	this.load=function(callback, set){
		if (!set){
			set="";
		}

		AP.post(Message.api+"api/channel/channels", {'set': set}, function(code){
			if (!code.good()){
				return false;
			}
			
			Channel.manager.channels=code.channels.slice();
			Channel.manager.ready=1;
			Channel.manager.getUnreads(callback);
			return;
		});
	};
	
	
	
	/**
	 * @desc Getting unread counts and last messages of all channels to be cared
	 */
	this.getUnreads = function(callback){
		var ids=AP.select(this.channels, function(e){
			return e.id;
		});
		

		Message.socket.emit("channels.get",{ids: ids}, function(data){
			for (var i=0; i<data.length; i++){
				setUnreadCount(data[i].id, data[i].unread_count);
			}
			
			// Message.notify.badge();
			
			if (callback){
				callback(Channel.manager.channels);
			}
		});
	};
	
	
	this.getChannelUnread=function(channel_id){
		for (var i=0; i<this.channels.length; i++){
			if (this.channels[i].id==channel_id){
				return parseInt(this.channels[i].unread_count);
			}
		}
		
		return 0;
	};
	
	
	this.fixUnread=function(channel){
		for (var i=0; i<this.channels.length; i++){
			if (this.channels[i].id==channel.id){
				this.channels[i].unread_count=parseInt(channel.unread_count);
				break;
			}
		}
	};
	
	
	
	this.countUniqueUnreads=function(){
		var total=0;
		for (var i=0; i<this.channels.length; i++){
			if (parseInt(this.channels[i].unread_count)){
				total++;	
			}
		}	
		
		return total;
	};
	
	
	
	
	function setUnreadCount(channel_id, unread_count){
		for (var i=0; i<Channel.manager.channels.length; i++){
			if (Channel.manager.channels[i].id==channel_id){
				Channel.manager.channels[i].unread_count=parseInt(unread_count);
				return;
			}
		}
	};
};


Channel.fav=new function __ChannelFav(){
	this.favs=[];
	
	this.toggle=function(id){
	};
	
	this.reset=function(stars){
		if (stars){
			this.stars=stars;
		}else{
			this.stars=[];
		}
	}
	
	this.fav=function(id){
		return (this.stars.indexOf(id)!=-1);
	};
};


Channel.engine=new function __ChannelEngine(){
	this.isDeactivated=function(channel){
		if (channel.subtype =="peer"){
			for (var i=0; i<channel.followers.length; i++){
				var id=channel.followers[i];
				if (id!=Client.viewer.id){
					var u=People.get(id);
					if (!u || !u.id || u.username=="none"){
						return true;
					}
				}
			}
		}
		
		return false;
	};
	
	
	
	this.getImage=function(channel){
		if (channel.metatype=="channel" && channel.subtype=="user"){
			return getSelfImage(channel);
		}
		
		if (channel.metatype=="channel" || channel.metatype=="unit"){
			return getChannelImage(channel);
		}
		
		if (channel.metatype=="dm" && channel.subtype=="peer"){
			return getPeerImage(channel);
		}
		
		if (channel.metatype=="dm"){
			return getGroupImage(channel);
		}
		
		if (channel.metatype=="project"){
			return getProjectIcon(channel.subtype);
		}
		
		return "";
	};

	
	this.getDisplayName=function(channel){
		if (channel.metatype=="dm"){
			if (channel.subtype=="peer"){
				var ua = People.get(channel.followers[0]);
				var ub = People.get(channel.followers[1]);
				
				if (ua.id==Client.viewer.id){
					return ub.name;
				}else{
					return ua.name;
				}
			}
		}else if (channel.metatype=="channel" && channel.subtype=="user"){
			return "Cá nhân";
		}
		
		return channel.name;
	};
	
	
	this.lastMessage=function(channel){
		var last=channel.latest;
		if (!last){
			return "Conversation just started";	
		}
		
		if (last && last.content){
			user=People.get(last.username);
			if (!user){
				return "Conversation just started";
			}
			
			var sign=" ";
			if (last.content && last.content.charAt(0)==":"){
				sign="";
			}
			
			return getLastDisplay(user, sign+last.content);
		}
		
		return "Conversation just started";
	};
	
		
	this.fromMessage=function(last){
		var user;
		if (last && last.content){
			if (last.username){
				user=People.get(last.username);
			}else{
				user=People.get(last.user.username);	
			}
			
			if (!user){
				return "Conversation just started";
			}
			
			var sign=": ";
			if (last.content && last.content.charAt(0)==":"){
				sign="";
			}
			
			return getLastDisplay(user, sign+last.content);
		};
		
		return "Conversation just started";
	};
		
		
		
	function getLastDisplay(user, msg){
		if (!parseInt(user.id) && user.username=="_bot"){
			return "<div class='msg'> <div class='ap-xdot'><em>BOT</em> "+(msg)+"</div> </div>";
		}
		
		if (!msg){
			msg="Conversation just started";
		}
		if (msg){
			return "<div class='tinyavt'><img src='"+AP.xthumb(user.gavatar)+"'></div>" +
				"<div class='msg'><div class='ap-xdot'><em>"+user.first_name+"</em>"+msg+"</div></div>";
		}
		
		return "";
	};
	
	
	
	function getSelfImage(c){
		return "<div class='image'><div class='single'><img src='"+AP.thumb(Client.viewer.gavatar)+"'></div></div>";
	};
	
	
	function getPeerImage(c){
		var user=People.get(c.followers[0]);
		if (user.username==Client.viewer.username){
			user=People.get(c.followers[1]);
		}
		
		return "<div class='image'><div class='single'><img src='"+AP.thumb(user.gavatar)+"'></div></div>";
	};
	
	
	function getGroupImage(c){
		var teams=c.followers;
		
		if (teams.length==3){
			var u0=People.get(teams[0]);
			var u1=People.get(teams[1]);
			var u2=People.get(teams[2]);
			
			return "<div class='avatars -three'>" +
					"<div class='avatar -first'><img src='"+AP.thumb(u0.gavatar)+"'/></div>" +
					"<div class='avatar -second -bb -bl'><img src='"+AP.thumb(u1.gavatar)+"'/></div>" +
					"<div class='avatar -third -bl'><img src='"+AP.thumb(u2.gavatar)+"'/></div>" +
				"</div>";
		}
		
		if (teams.length>=4){
			var u0=People.get(teams[0]);
			var u1=People.get(teams[1]);
			var u2=People.get(teams[2]);
			var u3=People.get(teams[3]);
			
			return "<div class='avatars -four'>" +
					"<div class='avatar -first -bb -br'><img src='"+AP.thumb(u0.gavatar)+"'/></div>" +
					"<div class='avatar -second -bb'><img src='"+AP.thumb(u1.gavatar)+"'/></div>" +
					"<div class='avatar -third -bl'><img src='"+AP.thumb(u2.gavatar)+"'/></div>" +
					"<div class='avatar -forth'><img src='"+AP.thumb(u3.gavatar)+"'/></div>" +
				"</div>";
		}
		
		
		
		return "";
	};
	
	
	
	function getProjectIcon(type){
		return "<div class='full-mask -bg-alt"+Client.viewer.color+"'></div> <div class='box-text'><span class='-ap icon-timeline normal'></span></div>";
	};
	
	
	function getChannelImage(c){
		var txt=c.name.substr(0,2);
		var parts=c.name.split(" ", 2);
		if (parts.length>=2){
			txt=parts[0].charAt(0)+parts[1].charAt(0);
		}
		return "<div class='full-mask -bg-alt"+c.color+"'></div> <div class='box-text'><span>"+txt+"</span></div>";
	};
	
	
	
};




var BaseFile=new function __BaseFile(){
	this.getPage=function(page_id, callback){
		if (!Channel.channel){
			return;
		}
		
		UI.ajaxShow();
		AP.post(Message.api+"api/message/file/page", {channel_id: Channel.channel.id, page: page_id}, function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			callback(code.files);
		});
	};
	
	
	this.open=function(file_id){
		this.get(file_id, function(file){
			BaseFile.display(file);
		});
	};
	
	
	this.get=function(file_id, callback){
		UI.ajaxShow();
		AP.post(Message.api+"api/message/file/get", {file_id: file_id}, function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			callback(code.file);
		});
	};
	
	

	this.url=function(file){
		return "r/file/"+file.channel_id+"/"+file.id;
	};
	
	
	this.furl=function(folder){
		if (AP.data.isString(folder)){
			return "r/folder/"+Channel.channel.id+"/"+folder;
		}
		
		return "r/folder/"+folder.channel_id+"/"+folder.id;
	};
	
	
	this.initUploadButton=function(btn_id, channel_id, folder_id){
		if (!folder_id){
			folder_id=0;
		}
		
		$(btn_id).data("action", Message.api+"api/message/file/upload");
		
		AP.uploadable(btn_id, {
	        preview: 0,
	        action: "upload_url",
	        name: "file",
	        data: {channel_id: channel_id, folder_id: folder_id}
	    }, function(code){
	        AP.xRefresh();
	    });
	};
	
	this.preview = function(id) {
	    BaseFile.get(id, function(file) {
	        if(file.metatype == "upload") {
	            file.src = file.url;
	        }
	        
	        FileX.quickPreview(file);
	    });
	};
	
	this.manageOptions = function(obj) {
        var actions = [];
        var uid = $(obj).parent().data("uid");
        
        if(uid == Client.viewer.id || Me.isOwner(Client.pageData.project) || Me.isSystemAdmin()) {
            actions.push({label: "<span class='text-error'>Xoá tệp tin này</span>", sublabel: "", icon: "icon-cloud_off", action: function() {
                BaseFile.removeFile($(obj).parent().data("fid"));
            }});
            
            return Context.menu(obj, {top: 30, left: -250, menu: actions});
        }
    };
    
    this.removeFile = function(fid) {
        AP.confirm("Bạn có chắc muốn xoá tệp tin này?", function() {
            UI.ajaxShow();
            AP.post(Message.api + "api/message/file/remove", {channel_id: Channel.channel.id, id: fid, hid: Client.pageData.project.hid}, function(code){
                UI.ajaxHide();
                if (!code.good()){
                    return AP.alertError(code.message);
                }
                
                UI.flash("Đã xoá tệp tin...");
                
                AP.xRefresh();
            });
        });
    };
};


BaseFile.display=function(file){
	FileX.quickPreview(file.url);
};




var Sticker = new function __Sticker(){
	this.sets={};
	this.num_sets=0;
	
	this.init=function(channel){
		if ($("#msg-stickers-"+channel.id).hasClass("__sinit")){
			return;
		}
		
		$("#msg-stickers-"+channel.id).addClass("__sinit");
		$("#msg-form-"+channel.id+" .channel-smiley-input").click(function(){
			var c=getChannel(this);
			if ($("#msg-stickers-"+channel.id).is(":visible")){
				Sticker.hideSelections(c);	
			}else{
				Sticker.showSelections(c);
			}
		});
		
		$("#msg-form-"+channel.id+" .smiley-closable").click(function(){
			var c=getChannel(this);
			Sticker.hideSelections(c);
		});
		
		this.listStickerSets(channel);
		Sticker.set.display(channel, "popular");
		
		Layout.scrollable("#msg-stickers-"+channel.id+" .msg-selection-canvas");
	};
	
	
	this.showSelections=function(channel){
		$("#msg-stickers-"+channel.id).show();
		$("#msg-stickers-"+channel.id).parent().addClass("active");
	};
	
	this.hideSelections=function(channel){
		$("#msg-stickers-"+channel.id).hide();
		$("#msg-stickers-"+channel.id).parent().removeClass("active");
	};
	
	this.send=function(ref, sticker_key, sticker_src){
		var channel=getChannel(ref);
		this.hideSelections(channel);
		return Message.sender.sticker(channel, sticker_key, sticker_src);
	};
	
	
	this.load=function(key, configs){
		configs.key=key;
		configs.index=this.num_sets;
		
		this.sets[key]=configs;
		this.num_sets++;
	};
	
	
	this.getConfig=function(key){
		if (this.sets[key]){
			return this.sets[key];
		}
		
		return null;
	};
	
	
	this.listStickerSets=function(channel){
		var html="";
		var index=0;
		for (var key in this.sets){
			var e=this.sets[key];
			html+= "<div class='item ap-xdot' data-index='"+index+"' data-set='"+e.key+"' onclick=\"Sticker.set.choose(this, '"+e.key+"')\">"+e.name+"</div>";
			index++;
		}
		
		$("#msg-stickers-"+channel.id+" .sticker-set-slider").html(html);
	};
	
	this.countSets=function(){
		return this.num_sets;
	};
	
	function getChannel(ref){
		return $(ref).closest(".msg-channel").data("channel");
	};
};




Sticker.set=new function __StickerSet(){
	this.cur=0;
	
	this.display=function(channel, setkey){
		var config=Sticker.getConfig(setkey);
		var set=this.load(config);
		this.displaySelection(channel, set);
	};
	
	this.load=function(config){
		if (config===null){
			config="popular";
		}
		
		if (AP.data.isString(config)){
			config=Sticker.getConfig(config);
		}
		var set={};
		set.config=config;
		set.name=config.name;
		set.key=config.key;
		set.index=config.index;
		set.items=getItems(config);
		return set;
	};
	
	this.displaySelection=function(channel, set){
		var html= AP.render(set.items, function(e){
			return "<div class='item' onclick=\"Sticker.send(this, '"+e.key+"','"+e.src+"');\"><div class='img'><img src='"+e.src+"'/></div></div>";
		});
		
		$("#msg-stickers-"+channel.id+" .msg-sticker-selections").html(html);
		
		$("#msg-stickers-"+channel.id+" .sticker-set-slider .item").each(function(){
			if ($(this).data("set")==set.key){
				$(this).addClass("active");
			}else{
				$(this).removeClass("active");
			}
		})
	};
	
	
	
	this.choose=function(ref, setkey){
		var channel=getChannel(ref);
		var set=this.load(setkey);
		this.displaySelection(channel, set);
		refocus(channel, set);
	};
	
	
	this.move=function(ref, dir){
		var channel=null;
		if (ref.id && ref.token){
			channel=ref;
		}else{
			channel=getChannel(ref);
		}
		
		this.cur+=dir;
		if (this.cur >= Sticker.countSets()-4){
			this.cur=Sticker.countSets()-5;
		}
		if (this.cur<0){
			this.cur=0;
		}
		
		reposition(channel, this.cur);
	};
	
	function getChannel(ref){
		return $(ref).closest(".msg-channel").data("channel");
	};
	
	function refocus(channel, set){
		var cur=Sticker.set.cur;
		
		var index=set.index;
		if (index <= cur){
			if (index>0){
				Sticker.set.move(channel, -1);
			}else{
				reposition(channel, index);
			}
		}else{
			if (index >= cur+3 && index < Sticker.countSets()-2){
				Sticker.set.move(channel, 1);
			}
		}
	};
	
	
	function reposition(channel, index){
		if (index < Sticker.countSets()-4){
			Sticker.set.cur=index;
			var left=index * 80;
			$("#msg-stickers-"+channel.id+" .sticker-set-slider").animate({"left": -left}, 200, function(){});	
		}
	};
	
	
	function getItems(config){
		var items=[];
		
		for (var i=parseInt(config.start); i<=parseInt(config.end); i++){
			var src="png";
			if (config.file=="gif"){
				src="gif";
			}
			items.push({
				type: "image",
				key: config.key+"-"+i+"."+src,
				src: Client.share_url+"/stickers/"+config.key+"/"+i+"."+src
			});
		}
		
		return items;
	};
};


Sticker.load("special",{
	"name":"Special",
	"type":"simple",
	"file":"png",
	"start":1,
	"end":68,
});


Sticker.load("popular",{
	"name":"Popular",
	"type":"popular",
	"file":"png",
	"start":1,
	"end":130,
});



Sticker.load("tuzki",{
	"name":"Tuzki",
	"type":"simple",
	"file":"gif",
	"start":1,
	"end":15,
});


Sticker.load("puppy",{
	"name":"Puppy",
	"type":"simple",
	"file":"gif",
	"start":1,
	"end":16,
});



Sticker.load("kitty",{
	"name":"Kitty",
	"type":"simple",
	"file":"gif",
	"start":1,
	"end":16,
});



Sticker.load("cute",{
	"name":"Cute",
	"type":"simple",
	"file":"gif",
	"start":1,
	"end":24,
});





Sticker.load("cotton",{
	"name":"Candy",
	"type":"simple",
	"file":"gif",
	"start":1,
	"end":24,
});





Sticker.load("nerd",{
	"name":"Nerdy",
	"type":"simple",
	"file":"gif",
	"start":1,
	"end":15,
});



Sticker.load("bunny",{
	"name":"Bunny",
	"type":"simple",
	"file":"png",
	"start":1,
	"end":36,
});


Sticker.load("rabbit",{
	"name":"Rabbit",
	"type":"simple",
	"file":"png",
	"start":1,
	"end":29,
});



Sticker.load("princess",{
	"name":"Princess",
	"type":"simple",
	"file":"png",
	"start":1,
	"end":40,
});



Sticker.load("owl",{
	"name":"Owla",
	"type":"simple",
	"file":"gif",
	"start":1,
	"end":24,
});




Sticker.load("pancake",{
	"name":"Pancake",
	"type":"simple",
	"file":"png",
	"start":1,
	"end":17,
});



Sticker.load("bigeye",{
	"name":"Big Eyes",
	"type":"simple",
	"file":"gif",
	"start":1,
	"end":16,
});


Sticker.load("alien",{
	"name":"Alien",
	"type":"simple",
	"file":"gif",
	"start":1,
	"end":43,
});






Sticker.load("fatcat",{
	"name":"Fatcat",
	"type":"simple",
	"file":"png",
	"start":1,
	"end":36,
});



Sticker.load("snoppy",{
	"name":"Snoppy",
	"type":"simple",
	"file":"png",
	"start":1,
	"end":28,
});


Sticker.load("jellyfish",{
	"name":"Jellyfish",
	"type":"simple",
	"file":"png",
	"start":1,
	"end":40,
});


Sticker.load("ducky",{
	"name":"Ducky",
	"type":"simple",
	"file":"png",
	"start":1,
	"end":32,
});



Sticker.load("meow",{
	"name":"Meow",
	"type":"simple",
	"file":"png",
	"start":1,
	"end":26,
});


Sticker.load("potato",{
	"name":"Potato",
	"type":"simple",
	"file":"png",
	"start":1,
	"end":50,
});


Sticker.load("troll",{
	"name":"Meme",
	"type":"simple",
	"file":"png",
	"start":1,
	"end":16,
});





/**
 * @desc General
 */

AP.rewrite('r/messages/([0-9]+)$', 'messages?c=$1', function(qs){
	Channel.open(qs.c, {intent: "notification"}, function(){
		$.log("Please focusing on ... "+qs.c);
	});
});


AP.rewrite('messages/([0-9]+)/([0-9]+)', 'messages?c=$1&msg=$2', function(qs){
	Channel.open(qs.c, {intent: "panel"}, function(){
		$.log("On notification  ... "+qs.msg);
	});
});


AP.rewrite('call/([a-zA-Z0-9\-]+)', 'call?code=$1', function(qs){
	Message.call.display(qs.code);
	window.open(Base.domain("message")+"/videocall/"+qs.code,"","width=900,height=500");
});


/**
 * @desc Rewrite files
 */

AP.rewrite('r/files/([a-zA-Z0-9]+)', 'messages/files?c=$1', function(qs){
});


AP.rewrite('r/folder/([a-zA-Z0-9]+)/([a-zA-Z0-9]+)', 'messages/folder?c=$1&folder=$2', function(qs){
	$.log(qs);
	// TODO: display folder
});


AP.rewrite('r/file/([a-zA-Z0-9]+)/([a-zA-Z0-9]+)', 'messages/file?c=$1&file=$2', function(qs){
	BaseFile.open(qs.file);
//	Channel.open(qs.c, function(){
//		BaseFile.open(qs.file);
//	});
});









/**
 * @desc Live binding
 */
$("#channel-canvas").delegate(".msg-tag", 'click',function(){
	var val=$(this).text();
	Channel.search.search({
		type: "tag",
		q:  val
	});
});



Message.API=new function __MessageLinkingAPI(){
	this.__channels=null;
	
	/**
	 * @desc Linking a particular system/network
	 */
	this.dialog=function(system){
		var base=system.base;
		var selected=[];
		if (base && base.channels){
			selected=AP.select(base.channels, function(e){
				return e.id;
			});
		}
		

		
		this.getChannels(function(channels){
			var actions=[];
			for (var i=0; i<channels.length; i++){
				var c=channels[i];
				actions.push({
					label: c.name,
					value: c.id,
					id: c.id,
					channel: c
				});
			}
			
			AP.selectActions(actions, function(cs){
				var ids=AP.select(cs, function(e){
					return e.channel.id;
				});
				
				if (!ids.length){
					return;
				}
				
				Base.linking.link(system, ids);
			},{
				search: 1,
				selected: selected
			});
		});
		
	};
	
	
	
	this.link=function(system, ids){
		var links=ids;
		if (AP.data.isArray(ids)){
			links=ids.join(",");
		}
		
		UI.ajaxShow();
		AP.post("api/base/link", {sysid: system.id, systoken: system.token, links: links}, function(code){
			UI.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			AP.alertSuccess("Link successfully", function(){
				AP.refresh();
			});
		})
	};
	
	
	
	this.getChannels=function(callback){
		if (this.__channels){
			return callback(this.__channels)
		}
		
		UI.ajaxShow();
		AP.post(Message.api+"api/message/channel/mine", {}, function(code){
			UI.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			Message.API.__channels=code.channels;
			callback(code.channels);
		})
	};
	
	
	this.show=function(){
		$("#msg-root").show();
	};
	
	this.hide=function(){
		$("#msg-root").hide();
	};
};


Base.linking=new function __BaseLinking(){
	this.api=(Client.base && Client.base.app=="base")?"":((parseInt(Client.https)?"https":"http")+"://" + CONFIG.api + "." + Client.domain + "/ajax/");
	
	/**
	 * @desc Linking a particular system/network
	 */
	this.dialog=function(system){
		var base=system.base;
		var selected=[];
		if (base && base.channels){
			selected=AP.select(base.channels, function(e){
				return e.id;
			});
		}
		

		
		this.getChannels(function(channels){
			var actions=[];
			for (var i=0; i<channels.length; i++){
				var c=channels[i];
				actions.push({
					label: c.name,
					value: c.id,
					id: c.id,
					channel: c
				});
			}
			
			AP.selectActions(actions, function(cs){
				var ids=AP.select(cs, function(e){
					return e.channel.id;
				});
				
				if (!ids.length){
					return;
				}
				
				Base.linking.link(system, ids);
			},{
				search: 1,
				selected: selected
			});
		});
		
	};
	
	
	
	this.link=function(system, ids){
		UI.ajaxShow();
		AP.post("api/base/link", {sysid: system.id, systoken: system.token, links: ids.join(",")}, function(code){
			UI.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			AP.alertSuccess("Link successfully", function(){
				AP.refresh();
			});
		})
	};
	
	
	
	this.getChannels=function(callback){
		AP.ajaxSetup({
			__sessionid:  Client.secureData.session,
			__otp:  Client.secureData.otp,
		});
		
		UI.ajaxShow();
		AP.post(this.api+"api/message/channel/mine", {}, function(code){
			UI.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			callback(code.channels);
		})
	}
};

Message.canvas=new function __MessageCanvas(){
	this.inited=false;
	this.root="#document";
	
	this.init=function(){
		if (this.inited){
			return;
		}
		
		this.inited=true;
		
		Online.loaded(function(){
			build();
		});
	};
	
	this.setChannels=function(channels){
		var html=AP.render(Channel.manager.channels, function(e){
			return getChannelHTML(e);
		});
		
		$("#msg-panel .section-messages").html(html);
		
		
		html=AP.render(Channel.manager.channels, function(e){
			if (e.metatype!="channel"){
				return "";
			}
			return "<div class='item' onclick=\"Channel.open("+e.id+", {intent: 'panel'});\">" +
				"<div class='channel-image'>"+Channel.engine.getImage(e)+"</div>"+
				"<div class='name ap-xdot'>"+Channel.engine.getDisplayName(e)+"</div>" +
			"</div>";
		});
		
		$("#msg-panel .section-channels").html(html);
		countingTotalUnreads();
	};
	
	
	this.balance=function(){
		return Message.render.balance();
	};
	
	
	this.onMessage=function(message, channel){
		if ($("#msg-panel .item.is-channel.js-channel-"+channel.id).length){
			$("#msg-panel .item.is-channel.js-channel-"+channel.id).remove();
		}
		
		$("#msg-panel .section-messages").prepend(getChannelHTML(channel));
		countingTotalUnreads();
	};
	
	
	this.onChannelActive=function(channel_id){
		$("#msg-panel .item.is-channel.js-channel-"+channel_id).removeClass("-focus")
		
		if ($("#msg-panel .item.is-channel.js-channel-"+channel_id).length){
			$("#msg-panel .item.is-channel.js-channel-"+channel_id).removeClass("-unread");
			$("#msg-panel .item.is-channel.js-channel-"+channel_id).addClass("-focus");
			countingTotalUnreads();
		}
	};
	
	
	this.activateSearch=function(ref){
		if ($(ref).closest(".msg-channel").hasClass("collapsed")){
			$("#msg-panel").removeClass("collapsed");	
			$("#msg-root").removeClass("collapsed");
			Message.canvas.balance();
		}
		
		$("#msg-panel .channel-gsearch").show();
		$("#js-channel-gsearch").next().val("").autofocus();
	};
	
	
	
	function build(){
		var html="<div id='msg-root'>" +
			getPanel()+
			"<div id='js-msg-boxes' class='msg-boxes'></div>"+
		"</div>";
		
		$(Message.canvas.root).append(html);
		$("#msg-panel").find(".js-channel-minus").click(function(){
			$(this).closest(".msg-channel").toggleClass("collapsed");
			$("#msg-root").toggleClass("collapsed");
			Message.canvas.balance();
		});
		
		Layout.scrollable("#msg-panel .sections");
		
		$("#msg-panel .tabs .js-tab").click(function(){
			$(this).siblings().removeClass("active");
			$(this).addClass("active");
			var tab=$(this).data("tab");
			$("#msg-panel .sections .section").setActive(".section-"+tab);
		});
		
		
		buildPeople();
		
		var collapsed=Clog.getCookie("msgpc");
		if (collapsed && parseInt(collapsed)){
			collapsed=1;
		}else{
			collapsed=0;
		}
		
		if (collapsed){
			$("#msg-root").addClass("collapsed");
		}
		
		
		$("#msg-panel .channel-header .title").click(function(){
			if ($(this).closest(".msg-channel").hasClass("collapsed")){
				$("#msg-panel").removeClass("collapsed");	
				$("#msg-root").removeClass("collapsed");
				Message.canvas.balance();
			}
		});
		
		$("#msg-panel .channel-gsearch .close").click(function(){
			$("#msg-panel .channel-gsearch").hide();
		});
		
		
		$("#js-channel-gsearch").livesearch(Message.api+"/api/channel/search",{
			select: function(e){
				Channel.open(e.id,{intent: "panel"});
				$("#msg-panel .channel-gsearch").hide();
			}
		});
	};
	
	
	function getPanel(){
		var collapsed=Clog.getCookie("msgpc");
		if (collapsed && parseInt(collapsed)){
			collapsed=1;
		}else{
			collapsed=0;
		}
	
		var people="";
		var html="<div class='msg-channel "+(collapsed?" collapsed":" ")+"' id='msg-panel'>" +
			"<div class='channel-header'>" +
			"	<div class='channel-gsearch hidden'><div class='input'><input placeholder='Find chat groups' id='js-channel-gsearch' name='q'/></div> <div class='close'><span class='-ap icon-uniF108'></span></div></div>" +
			"	<div class='title ap-xdot'>" +
			"		<div class='channel-explain -on-collapsed'><div class='cr'></div><div class='cus'><div class='cx'>Mở rộng</div></div></div>" +
			"		<span class='count js-total-unread-count'></span>"+Client.system.name+"" +
				"</div>" +
			"	<div class='icons'>" +
			"		<div class='icon js-channel-minus'><div class='hexp'><div class='txt'>Phóng to / Thu nhỏ</div></div><span class='ficon-minus'></span></div>" +
			"		<div class='icon js-channel-search' onclick='Message.canvas.activateSearch(this);'><div class='hexp'><div class='txt'>Tìm nhóm chat</div></div><span class='ficon-search'></span></div>" +
			"		<div class='icon js-channel-expand url' data-url='"+Base.domain("message")+"/home'><div class='hexp'><div class='txt'>Chuyển đến trang Message</div></div><span class='-ap icon-open'></span></div>" +
			"	</div>" +
			"</div>" +
			"<div class='tabs'>" +
			"	<div class='tab js-tab js-tab-messages active' data-tab='messages'>Messages</div>" +
			"	<div class='tab js-tab js-tab-channels' data-tab='channels' style='display: none'># Channels</div>" +
			"	<div class='tab js-tab js-tab-people' data-tab='people'><span class='-ap icon-controller-record text-success'></span>&nbsp; Online<span class='count js-online-count'></span></div>" +
			"	<div class='tab js-tab-create' onclick='Message.create.channel();'>+ New</div>" +
			"</div>" +
			"<div class='sections scrollable' data-autoscroll='1'>" +
			"	<div class='section section-messages active'></div>" +
			"	<div class='section section-channels'></div>" +
			"	<div class='section section-people'></div>" +
			"</div>" +
		"</div>";
		
		return html;
	};
	
	
	
	function buildPeople(){
		$("#msg-panel .js-online-count").html("&nbsp; "+Online.people.length+"");
		
		var html=AP.render(Online.people, function(e){
			var user=People.get(e.username);
			if (!user){
				return "";
			}
			
			return "<div class='item js-person' data-kw='"+user.keywords+"' onclick=\"Base.message.peer('"+user.id+"');\">" +
				"<div class='channel-image'><div class='image'><div class='single'><img src='"+AP.thumb(user.gavatar)+"'/></div></div></div>"+
				"<div class='name ap-xdot'>"+user.name+"</div>" +
				"<div class='signal -online'></div>" +
			"</div>";
		});
		
		html+="<div class='sep'>Offline</div>" + AP.render(Client.people, function(e){
			if (!Online.isOnline(e.username)){
				var user=People.get(e.username);
				return "<div class='item js-person' data-kw='"+user.keywords+"' onclick=\"Base.message.peer('"+user.id+"');\">" +
					"<div class='channel-image'><div class='image'><div class='single'><img src='"+AP.thumb(user.gavatar)+"'/></div></div></div>"+
					"<div class='name ap-xdot'>"+user.name+"</div>" +
					"<div class='signal -offline'></div>" +
				"</div>";
			}
			
			return "";
		});
		

		$("#msg-panel .section-people").html("<div class='panel-search'><input type='text' placeholder='Tìm nhanh thành viên' name='search' id='js-panel-psearch'/></div>"+html);
		$("#js-panel-psearch").quickFilter("#msg-panel .js-person",function($e, q){
			var str=$e.data("kw");
			q=purify(q);
			return str.toLowerCase().indexOf(q)!=-1;
		})
	};
	
	
	
	function getChannelHTML(e){
		var unread_class=(parseInt(e.unread_count)?" -unread":"");
		var unread_count=parseInt(e.unread_count);
		if (unread_count>=10){
			unread_count=9;
		}
		
		if (Channel.engine.isDeactivated(e)){
			return "";
		}
		
		return "<div class='item is-channel js-channel-"+e.id+" "+unread_class+"' onclick=\"Channel.open("+e.id+",{'intent':'panel'});\">" +
			"<div class='channel-image'>"+Channel.engine.getImage(e)+"</div>"+
			"<div class='name ap-xdot'>"+Channel.engine.getDisplayName(e)+"</div>" +
			"<div class='channel-lm'>"+Channel.engine.lastMessage(e)+"</div>" +
			"<div class='unread-count'>"+unread_count+"</div>" +
		"</div>";
	};
	
	
	function countingTotalUnreads(){
		var len=$("#msg-panel .section-messages .item.-unread").length;
		if (len){
			$("#msg-panel .js-total-unread-count").html(len).show();
		}else{
			$("#msg-panel .js-total-unread-count").html(0).hide();
		}
	};
};


Message.render=new function __MessageRender(){
	/**
	 * @desc Render a message channel
	 */
	this.channel=function(channel, opts){		
		if (!opts){
			opts=$.extend({}, {prepend: false}, opts);
		}
		
		var ec=[];
		if (parseInt(opts.collapsed)){
			ec.push("collapsed");
		}
		
		channel._followers=AP.select(channel.followers, function(e){
			var u=People.get(e);
			if (!u.id || !parseInt(u.uid)){
				return null;
			}
			
			return u;
		});
		
		var has_online=false;
		var users=AP.render(channel._followers,function(e, index){
			if (index>=5){
				return "";
			}
			
			if (e.id==Client.viewer.id && channel.subtype=="peer"){
				return "";
			}
			
			if (Online.isOnline(e.username)){
				has_online=true;
				return "<div class='li -online'>"+e.name+"</div>";	
			}
			
			return "<div class='li'>"+e.name+"</div>";
			
		});
		
		if (channel._followers.length>5){
			users+="<div class='li -more url' data-url='"+Base.domain('message')+"/messages/"+channel.id+"'>Xem thêm</div>";
		}
		
		
		var channel_explain="<div class='channel-explain'><div class='cr'></div><div class='cus'>"+users+"</div></div>";
		var online="";
	
		if (has_online && channel.subtype=="peer"){
			online=" -online";
		}
		
		var html="<div class='msg-channel is-channel "+ec.join(" ")+"' id='channel-"+channel.id+"' data-id='"+channel.id+"'>" +
				"<div class='channel-header'>" +
				"	<div class='title"+online+"' title='"+Channel.engine.getDisplayName(channel)+"'>"+channel_explain+"<div class='ap-xdot'><span class='url' data-url='"+Base.domain("message")+"/messages/"+channel.id+"'>"+Channel.engine.getDisplayName(channel)+"</span></div></div>" +
				"	<div class='count'></div>" +
				"	<div class='icons'>" +
				"		<div class='icon js-channel-minus'><div class='hexp'><div class='txt'>Thu nhỏ / phóng to</div></div><span class='ficon-minus'></span></div>" +
				"		<div class='icon js-channel-call hide-on-collapsed'><div class='hexp'><div class='txt'>Video call</div></div><span class='-ap icon-phone4'></span></div>"+
				"		<div class='icon js-channel-add-people hide-on-collapsed'><div class='hexp'><div class='txt'>Thêm thành viên</div></div><span class='ficon-plus'></span></div>" +
				"		<div class='icon js-channel-close'><div class='hexp'><div class='txt'>Đóng</div></div><span class='-ap icon-ion-android-close'></span></div>" +
				"	</div>" +
				"</div>" +
				"<div class='channel-useradd'>" +
				"	<div class='panel-search'><input type='text' name='useradd' placeholder='+ thành viên để chat'/></div>" +
				"	<div class='submit'>Thêm</div>" +
				"</div>" +
				"<div class='channel-body scrollable'>" +
				"	<div class='channel-messages' id='channel-messages-"+channel.id+"'></div>" +
				"	<div class='channel-typing' id='channel-typing-"+channel.id+"'>" +
				"		<div class='seen hidden'></div>"+
				"		<div class='typing'>" +
				"			<div class='bubbles'>" +
				"				<div class='box'><div class='b b1'></div><div class='b b2'></div><div class='b b3'></div></div>" +
				"			</div>" +
				"			<div class='text'></div>" +
				"		</div>" +
				"	</div>" +
				"	<div class='channel-typing-fix hidden' style='height: 10px;'></div>" +
				"	<div class='channel-seens'></div>" +
				"</div>" +
				"<div class='channel-form' id='channel-form-"+channel.id+"'>"+getForm(channel)+"</div>" +
			"</div>";
		
		if (opts.prepend){
			$("#js-msg-boxes").prepend(html);
		}else{
			$("#js-msg-boxes").append(html);	
		}
		
		
		$("#channel-"+channel.id).find(".js-channel-minus").click(function(){
			$(this).closest(".msg-channel").toggleClass("collapsed");
			Message.render.balance();
		});
		
		$("#channel-"+channel.id).find(".js-channel-add-people").click(function(){
			$(this).closest(".msg-channel").find(".channel-useradd").toggleClass("active");
			
			if ($(this).closest(".msg-channel").find(".channel-useradd").hasClass("active")){
				$(this).closest(".msg-channel").find(".channel-useradd input").focus();
			}
		});
		
		
		$("#channel-"+channel.id).find(".js-channel-close").click(function(){
			var elem=this;
			var val=$(this).closest(".msg-channel").find("textarea.msg-input").val();
			
			if (val && val.length){
				AP.confirm("Please confirm to close the chatbox? You currently have unsent message.", function(){
					Channel.close($(elem).closest(".msg-channel").data("channel"));
					Message.render.destroy(elem);
				});
			}else{
				Channel.close($(elem).closest(".msg-channel").data("channel"));
				Message.render.destroy(elem);	
			}
		});
		
		$("#channel-"+channel.id).find(".js-channel-call").click(function(){
			var c=$(this).closest(".msg-channel").data("channel");
			AP.confirm("Start a video call within the channel?", function(){
				Message.call.click(c);
			});
		});
		
		$("#channel-"+channel.id+ " .channel-header .title").css({"marginRight": $("#channel-"+channel.id+ " .channel-header .icons").width()});
		
		Layout.scrollable("#js-msg-boxes .channel-body");
		Message.form.build(channel);
		this.balance();
		infiniteScrolling(channel);
		
		Tag.user("#channel-"+channel.id+" .channel-useradd input[name=useradd]", Client.people);
		Message.seen.get(channel, function(seens){
			
		});
		
		$("#channel-"+channel.id+" .channel-useradd .submit").click(function(){
			var val=$(this).parent().find("input").val();
			var channel=getChannel(this);
			
			if (!channel || !val.length){
				$("#channel-"+channel.id+" .channel-useradd").removeClass("active");
				return;
			}
			
			// $("#channel-"+channel.id+" .channel-useradd").removeClass("active");
			
			if (channel.subtype=="peer"){
				val=AP.render(channel._followers, function(e){
					if (e.username==Client.viewer.username){
						return "";
					}
					
					return "@"+e.username+" ";
				})+val;
				
				if (channel.subtype=="peer"){
					return Message.create.channel({
						"usernames_text": val
					});
				}	
			}else{
				var ref=this;
				UI.ajaxShow();
				AP.post(Message.api+"api/message/channel/manage/add.people", {users: val, id: channel.id}, function(code){
					UI.ajaxHide();
					
					if (!code.good()){
						return AP.alertError(code.message);
					}
					
					Message.render.destroy(ref);
					Channel.open(code.channel.id, {
						intent: 'click'
					}, function(){
						
					});
				});
				
			}
			
		});
		
		
		$("#channel-"+channel.id+" .channel-body").click(function(){
			var id=$(this).closest(".msg-channel").data("id");
			Channel.setActive(id);
		});
		
		$("#channel-"+channel.id+" .channel-form").click(function(){
			var id=$(this).closest(".msg-channel").data("id");
			Channel.setActive(id);
		});
	};
	
	
	/**
	 * @desc Balance positions of all channel box
	 */
	this.balance=function(){
		var cr=0;
		$("#js-msg-boxes .msg-channel").each(function(index){
			var w=$(this).width();
			if ($(this).hasClass("collapsed")){
				w=180;
			}else{
				w=270;
			}
			
			if ($(this).hasClass("hidden")){
				w=-15;
			}
			
			$(this).css("right", cr);
			cr+=w+15;
			
			$(this).find(".channel-header .title").css({"marginRight": $(this).find(".channel-header .icons").width()});
		});
		
		Message.cache.auto();
	};
	
	
	this.destroy=function(ref){
		var $box=$(ref).closest(".msg-channel");
		$box.remove();
		this.balance();
	};
	
	
	function getForm(channel){
		var mr=$.sbWidth();
		
		return "<div id='msg-form-"+channel.id+"' class='msg-form'>" +
			"<div class='wrapper'>" +
				"<div class='option'><span class='-ap icon-add'></span></div>"+
				"<div class='ctas-w' style='right:"+mr+"px'>"+getFormButtons(channel)+"</div>"+
				"<div class='send' onclick='Message.form.send(this)'>" +
				"	<div class='circle'><div class='c'><span class='-ap icon-navigation'></span></div></div>" +
				"	<div class='text'>Press enter to submit</div>" +
				"</div>" +
				"<div class='textarea'><div class='inputw'>" +
				"	<div class='input'>" +
				"		<textarea rows='1' class='msg-input' data-tagdir='bottom' data-full='1' name='content' placeholder='Type to send message'></textarea>" +
				"		<div class='help hidden'></div>" +
				"	</div>" +
				"</div></div>" +
			"</div>" +
		"</div>";
	};
	
	
	function getFormButtons(channel){
		return "<div class='ctas'>" +
			"<div class='action buzz channel-buzz' data-action='buzz'>" +
				"<span class='-ap icon-new'></span>" +
			"</div>" +
			"<div class='action channel-upload-drive' data-action='drive'>" +
				"<span class='-ap icon-uniF10D2'></span>" +
			"</div>" +
			"<div class='action att channel-upload-file'>" +
				"<span class='-ap icon-uniF10A'></span>" +
			"</div>" +
			"<div class='action image channel-upload-image'>" +
				"<span class='-ap icon-images'></span>" +
			"</div>" +
			"<div class='smiley-wrapper'>" +
			"	<div class='smiley-closable'></div>" +
			"	<div class='action smiley channel-smiley-input'>" +
				"	<span class='-ap icon-insert_emoticon'></span>" +
				"</div>" +
				"<div id='msg-stickers-"+channel.id+"' class='msg-stickers unselectable'>" +
				"	<div class='triangle'></div>" +
				"	<div class='nav prev' onclick='Sticker.set.move(this, -1);'><span class='-ap icon-circle-left'></span></div>" +
				"	<div class='nav next' onclick='Sticker.set.move(this, 1);'><span class='-ap icon-circle-right'></span></div>" +
				"	<div class='box'>" +
				"		<div class='header'><div class='sticker-set-slider'></div></div>" +
				"		<div class='msg-selection-canvas' class='scrollable' data-autoscroll='1' data-autohide='1'>" +
				"			<div class='selection msg-sticker-selections'></div>" +
				"		</div>" +
				"	</div>" +
			"	</div>" +
			"</div>" +
				"<div class='action like channel-like' data-action='like'>" +
				"<span class='-ap icon-thumbs-up2'></span>" +
			"</div>" +
		"</div>";
	};
	
	
	function infiniteScrolling(channel){
		if ($("#channel-"+channel.id+" .channel-body").hasClass("__inf")){
			return;
		}
		
		$("#channel-"+channel.id+" .channel-body").addClass("__inf");
		$("#channel-"+channel.id+" .channel-body > .scrollin").scroll(function(){
			var t=$(this).scrollTop();
			if (t<=50){
				Channel.loadPrevious(channel);
			}
		});
	};
};


Message.create=new function __MessageCreate(){
	this.channel=function(options){
		if (!options){
			options={};
		}
		
		options=$.extend({}, {}, options);
		
		if (!$("#js-channel-create").length){
			var html=getHTML(options);
			$(html).prependTo("#js-msg-boxes");
			bindEvents(options);
			Message.canvas.balance();
		}else{
			$("#js-channel-create").prependTo("#js-msg-boxes").removeClass("hidden");
			reset();
			Message.canvas.balance();
		}
		
		autofocus(options);
		if (options.usernames_text){
			$("#js-channel-create input[name=to]").val(options.usernames_text);
			$("#js-channel-create textarea").focus();
		}
	};
	
	
	this.peer=function(code){
		Channel.openDirect(code.channel, code.messages, code.page_token, code.stars, function(){			
		}, {
			prepend: true
		});
	};
	
	
	function getHTML(options){
		return "<div class='msg-channel is-channel smart-create' id='js-channel-create'>" +
			"<div class='channel-header'>" +
			"	<div class='title'>New message</div>" +
			"	<div class='icons'><div class='icon js-create-close'><span class='-ap icon-ion-android-close'></span></div></div>" +
			"</div>" +
			"<div class='channel-create'>" +
			"	<div class='label'>To:</div>" +
			"	<div class='input'><input name='to' placeholder='Type @ to tag'/></div>" +
			"</div>" +
			"<div class='channel-body'></div>" +
			"<div class='channel-form'>" +
			"	<div class='msg-form'>" +
			"		<div class='textarea'>" +
			"			<div class='inputw'><textarea name='content' placeholder='Type to send message'></textarea></div>" +
			"		</div>" +
			"		<div class='smart-send'>Send</div>" +
			"	</div>" +
			"</div>"+
		"</div>";
	};
	
	
	function createNow(){
		var users=$("#js-channel-create input[name=to]").val();
		var content=$("#js-channel-create textarea[name=content]").val();
		
		AP.post(Message.api+"api/message/channel/create",{users: users, content: content}, function(code){
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			$("#js-channel-create").addClass("hidden");
			
			Channel.open(code.channel.id, {
				intent: "click",
				prepend: true
			});
			
//			Channel.openDirect(code.channel, code.messages, code.page_token, code.stars, function(){
//				
//			}, {
//				prepend: true
//			});
		});
	};
	
	
	function bindEvents(options){
		Tag.user("#js-channel-create input[name=to]", Client.people);
		
		$("#js-channel-create textarea[name=content]").enter(function(){
			createNow(this);
		});
		
		$("#js-channel-create .smart-send").click(function(){
			createNow(this);
		});
		
		$("#js-channel-create .js-create-close").click(function(){
			$("#js-channel-create").addClass("hidden");
			Message.canvas.balance();
		});
		
		$("#js-channel-create textarea[name=content]").height(24).autoExpand();
	};
	
	
	function autofocus(options){
		if (options.users){
			$("#js-channel-create input[name=to]").val(AP.word.join(options.users, " ", function(e){
				return "@"+e+"";
			})+" ");	
		}
		
		if (!options.users || !options.users.length){
			$("#js-channel-create input[name=to]").focus();	
		}else{
			$("#js-channel-create textarea[name=content]").focus();
		}
	};
	
	
	function reset(){
		$("#js-channel-create input[name=to]").val("");
		$("#js-channel-create textarea[name=content]").val("");
		$("#js-channel-create textarea[name=content]").height(26)
	};
};






Message.base=new function __MessageBase(){
	this.init=function(){
		if (parseInt(Client.viewer.disabled_message)==2){
			$.log("MESSAGE_DISABLED_ON_THIS_ACCOUNT");
			return;
		}
		
		AP.sys.on("socket.ready", function(){
			$(document).ready(function(){
				if (!Client.mobile && parseInt(Client.viewer.id)){
					if (Client.base){
						Message.base.run();
						
						$(window).on("blur", function(){
							Channel.setActive(0);
							Message.form.untyping();
						}).on("focus", function(){
							
						}).on("unload", function(){
							Message.form.untyping();
						});
						
					}
				}
			});
		});
	};
	
	
	this.run=function(){
		if (!Client.mobile && parseInt(Client.viewer.id)){
			Message.canvas.init();
			Message.seen.init();
			
			Channel.manager.load(function(channels){
				Message.canvas.setChannels(channels);
			});
			
			Message.bindEvents();
			var cs=Message.cache.currentChannels();
			
			for (var i=0; i<Math.min(cs.length,5); i++){
				var c=cs[i];
				if (!c || !c.id){
					continue;
				}
				
				Channel.open(c.id, {collapsed: parseInt(c.c), intent: "cache"});
			};
		};
	};
};




Message.mode("base");
Message.base.init();!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var f;"undefined"!=typeof window?f=window:"undefined"!=typeof global?f=global:"undefined"!=typeof self&&(f=self),f.io=e()}}(function(){var define,module,exports;return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);throw new Error("Cannot find module '"+o+"'")}var f=n[o]={exports:{}};t[o][0].call(f.exports,function(e){var n=t[o][1][e];return s(n?n:e)},f,f.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s}({1:[function(_dereq_,module,exports){module.exports=_dereq_("./lib/")},{"./lib/":2}],2:[function(_dereq_,module,exports){var url=_dereq_("./url");var parser=_dereq_("socket.io-parser");var Manager=_dereq_("./manager");var debug=_dereq_("debug")("socket.io-client");module.exports=exports=lookup;var cache=exports.managers={};function lookup(uri,opts){if(typeof uri=="object"){opts=uri;uri=undefined}opts=opts||{};var parsed=url(uri);var source=parsed.source;var id=parsed.id;var io;if(opts.forceNew||opts["force new connection"]||false===opts.multiplex){debug("ignoring socket cache for %s",source);io=Manager(source,opts)}else{if(!cache[id]){debug("new io instance for %s",source);cache[id]=Manager(source,opts)}io=cache[id]}return io.socket(parsed.path)}exports.protocol=parser.protocol;exports.connect=lookup;exports.Manager=_dereq_("./manager");exports.Socket=_dereq_("./socket")},{"./manager":3,"./socket":5,"./url":6,debug:10,"socket.io-parser":46}],3:[function(_dereq_,module,exports){var url=_dereq_("./url");var eio=_dereq_("engine.io-client");var Socket=_dereq_("./socket");var Emitter=_dereq_("component-emitter");var parser=_dereq_("socket.io-parser");var on=_dereq_("./on");var bind=_dereq_("component-bind");var object=_dereq_("object-component");var debug=_dereq_("debug")("socket.io-client:manager");var indexOf=_dereq_("indexof");var Backoff=_dereq_("backo2");module.exports=Manager;function Manager(uri,opts){if(!(this instanceof Manager))return new Manager(uri,opts);if(uri&&"object"==typeof uri){opts=uri;uri=undefined}opts=opts||{};opts.path=opts.path||"/socket.io";this.nsps={};this.subs=[];this.opts=opts;this.reconnection(opts.reconnection!==false);this.reconnectionAttempts(opts.reconnectionAttempts||Infinity);this.reconnectionDelay(opts.reconnectionDelay||1e3);this.reconnectionDelayMax(opts.reconnectionDelayMax||5e3);this.randomizationFactor(opts.randomizationFactor||.5);this.backoff=new Backoff({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()});this.timeout(null==opts.timeout?2e4:opts.timeout);this.readyState="closed";this.uri=uri;this.connected=[];this.encoding=false;this.packetBuffer=[];this.encoder=new parser.Encoder;this.decoder=new parser.Decoder;this.autoConnect=opts.autoConnect!==false;if(this.autoConnect)this.open()}Manager.prototype.emitAll=function(){this.emit.apply(this,arguments);for(var nsp in this.nsps){this.nsps[nsp].emit.apply(this.nsps[nsp],arguments)}};Manager.prototype.updateSocketIds=function(){for(var nsp in this.nsps){this.nsps[nsp].id=this.engine.id}};Emitter(Manager.prototype);Manager.prototype.reconnection=function(v){if(!arguments.length)return this._reconnection;this._reconnection=!!v;return this};Manager.prototype.reconnectionAttempts=function(v){if(!arguments.length)return this._reconnectionAttempts;this._reconnectionAttempts=v;return this};Manager.prototype.reconnectionDelay=function(v){if(!arguments.length)return this._reconnectionDelay;this._reconnectionDelay=v;this.backoff&&this.backoff.setMin(v);return this};Manager.prototype.randomizationFactor=function(v){if(!arguments.length)return this._randomizationFactor;this._randomizationFactor=v;this.backoff&&this.backoff.setJitter(v);return this};Manager.prototype.reconnectionDelayMax=function(v){if(!arguments.length)return this._reconnectionDelayMax;this._reconnectionDelayMax=v;this.backoff&&this.backoff.setMax(v);return this};Manager.prototype.timeout=function(v){if(!arguments.length)return this._timeout;this._timeout=v;return this};Manager.prototype.maybeReconnectOnOpen=function(){if(!this.reconnecting&&this._reconnection&&this.backoff.attempts===0){this.reconnect()}};Manager.prototype.open=Manager.prototype.connect=function(fn){debug("readyState %s",this.readyState);if(~this.readyState.indexOf("open"))return this;debug("opening %s",this.uri);this.engine=eio(this.uri,this.opts);var socket=this.engine;var self=this;this.readyState="opening";this.skipReconnect=false;var openSub=on(socket,"open",function(){self.onopen();fn&&fn()});var errorSub=on(socket,"error",function(data){debug("connect_error");self.cleanup();self.readyState="closed";self.emitAll("connect_error",data);if(fn){var err=new Error("Connection error");err.data=data;fn(err)}else{self.maybeReconnectOnOpen()}});if(false!==this._timeout){var timeout=this._timeout;debug("connect attempt will timeout after %d",timeout);var timer=setTimeout(function(){debug("connect attempt timed out after %d",timeout);openSub.destroy();socket.close();socket.emit("error","timeout");self.emitAll("connect_timeout",timeout)},timeout);this.subs.push({destroy:function(){clearTimeout(timer)}})}this.subs.push(openSub);this.subs.push(errorSub);return this};Manager.prototype.onopen=function(){debug("open");this.cleanup();this.readyState="open";this.emit("open");var socket=this.engine;this.subs.push(on(socket,"data",bind(this,"ondata")));this.subs.push(on(this.decoder,"decoded",bind(this,"ondecoded")));this.subs.push(on(socket,"error",bind(this,"onerror")));this.subs.push(on(socket,"close",bind(this,"onclose")))};Manager.prototype.ondata=function(data){this.decoder.add(data)};Manager.prototype.ondecoded=function(packet){this.emit("packet",packet)};Manager.prototype.onerror=function(err){debug("error",err);this.emitAll("error",err)};Manager.prototype.socket=function(nsp){var socket=this.nsps[nsp];if(!socket){socket=new Socket(this,nsp);this.nsps[nsp]=socket;var self=this;socket.on("connect",function(){socket.id=self.engine.id;if(!~indexOf(self.connected,socket)){self.connected.push(socket)}})}return socket};Manager.prototype.destroy=function(socket){var index=indexOf(this.connected,socket);if(~index)this.connected.splice(index,1);if(this.connected.length)return;this.close()};Manager.prototype.packet=function(packet){debug("writing packet %j",packet);var self=this;if(!self.encoding){self.encoding=true;this.encoder.encode(packet,function(encodedPackets){for(var i=0;i<encodedPackets.length;i++){self.engine.write(encodedPackets[i])}self.encoding=false;self.processPacketQueue()})}else{self.packetBuffer.push(packet)}};Manager.prototype.processPacketQueue=function(){if(this.packetBuffer.length>0&&!this.encoding){var pack=this.packetBuffer.shift();this.packet(pack)}};Manager.prototype.cleanup=function(){var sub;while(sub=this.subs.shift())sub.destroy();this.packetBuffer=[];this.encoding=false;this.decoder.destroy()};Manager.prototype.close=Manager.prototype.disconnect=function(){this.skipReconnect=true;this.backoff.reset();this.readyState="closed";this.engine&&this.engine.close()};Manager.prototype.onclose=function(reason){debug("close");this.cleanup();this.backoff.reset();this.readyState="closed";this.emit("close",reason);if(this._reconnection&&!this.skipReconnect){this.reconnect()}};Manager.prototype.reconnect=function(){if(this.reconnecting||this.skipReconnect)return this;var self=this;if(this.backoff.attempts>=this._reconnectionAttempts){debug("reconnect failed");this.backoff.reset();this.emitAll("reconnect_failed");this.reconnecting=false}else{var delay=this.backoff.duration();debug("will wait %dms before reconnect attempt",delay);this.reconnecting=true;var timer=setTimeout(function(){if(self.skipReconnect)return;debug("attempting reconnect");self.emitAll("reconnect_attempt",self.backoff.attempts);self.emitAll("reconnecting",self.backoff.attempts);if(self.skipReconnect)return;self.open(function(err){if(err){debug("reconnect attempt error");self.reconnecting=false;self.reconnect();self.emitAll("reconnect_error",err.data)}else{debug("reconnect success");self.onreconnect()}})},delay);this.subs.push({destroy:function(){clearTimeout(timer)}})}};Manager.prototype.onreconnect=function(){var attempt=this.backoff.attempts;this.reconnecting=false;this.backoff.reset();this.updateSocketIds();this.emitAll("reconnect",attempt)}},{"./on":4,"./socket":5,"./url":6,backo2:7,"component-bind":8,"component-emitter":9,debug:10,"engine.io-client":11,indexof:42,"object-component":43,"socket.io-parser":46}],4:[function(_dereq_,module,exports){module.exports=on;function on(obj,ev,fn){obj.on(ev,fn);return{destroy:function(){obj.removeListener(ev,fn)}}}},{}],5:[function(_dereq_,module,exports){var parser=_dereq_("socket.io-parser");var Emitter=_dereq_("component-emitter");var toArray=_dereq_("to-array");var on=_dereq_("./on");var bind=_dereq_("component-bind");var debug=_dereq_("debug")("socket.io-client:socket");var hasBin=_dereq_("has-binary");module.exports=exports=Socket;var events={connect:1,connect_error:1,connect_timeout:1,disconnect:1,error:1,reconnect:1,reconnect_attempt:1,reconnect_failed:1,reconnect_error:1,reconnecting:1};var emit=Emitter.prototype.emit;function Socket(io,nsp){this.io=io;this.nsp=nsp;this.json=this;this.ids=0;this.acks={};if(this.io.autoConnect)this.open();this.receiveBuffer=[];this.sendBuffer=[];this.connected=false;this.disconnected=true}Emitter(Socket.prototype);Socket.prototype.subEvents=function(){if(this.subs)return;var io=this.io;this.subs=[on(io,"open",bind(this,"onopen")),on(io,"packet",bind(this,"onpacket")),on(io,"close",bind(this,"onclose"))]};Socket.prototype.open=Socket.prototype.connect=function(){if(this.connected)return this;this.subEvents();this.io.open();if("open"==this.io.readyState)this.onopen();return this};Socket.prototype.send=function(){var args=toArray(arguments);args.unshift("message");this.emit.apply(this,args);return this};Socket.prototype.emit=function(ev){if(events.hasOwnProperty(ev)){emit.apply(this,arguments);return this}var args=toArray(arguments);var parserType=parser.EVENT;if(hasBin(args)){parserType=parser.BINARY_EVENT}var packet={type:parserType,data:args};if("function"==typeof args[args.length-1]){debug("emitting packet with ack id %d",this.ids);this.acks[this.ids]=args.pop();packet.id=this.ids++}if(this.connected){this.packet(packet)}else{this.sendBuffer.push(packet)}return this};Socket.prototype.packet=function(packet){packet.nsp=this.nsp;this.io.packet(packet)};Socket.prototype.onopen=function(){debug("transport is open - connecting");if("/"!=this.nsp){this.packet({type:parser.CONNECT})}};Socket.prototype.onclose=function(reason){debug("close (%s)",reason);this.connected=false;this.disconnected=true;delete this.id;this.emit("disconnect",reason)};Socket.prototype.onpacket=function(packet){if(packet.nsp!=this.nsp)return;switch(packet.type){case parser.CONNECT:this.onconnect();break;case parser.EVENT:this.onevent(packet);break;case parser.BINARY_EVENT:this.onevent(packet);break;case parser.ACK:this.onack(packet);break;case parser.BINARY_ACK:this.onack(packet);break;case parser.DISCONNECT:this.ondisconnect();break;case parser.ERROR:this.emit("error",packet.data);break}};Socket.prototype.onevent=function(packet){var args=packet.data||[];debug("emitting event %j",args);if(null!=packet.id){debug("attaching ack callback to event");args.push(this.ack(packet.id))}if(this.connected){emit.apply(this,args)}else{this.receiveBuffer.push(args)}};Socket.prototype.ack=function(id){var self=this;var sent=false;return function(){if(sent)return;sent=true;var args=toArray(arguments);debug("sending ack %j",args);var type=hasBin(args)?parser.BINARY_ACK:parser.ACK;self.packet({type:type,id:id,data:args})}};Socket.prototype.onack=function(packet){debug("calling ack %s with %j",packet.id,packet.data);var fn=this.acks[packet.id];fn.apply(this,packet.data);delete this.acks[packet.id]};Socket.prototype.onconnect=function(){this.connected=true;this.disconnected=false;this.emit("connect");this.emitBuffered()};Socket.prototype.emitBuffered=function(){var i;for(i=0;i<this.receiveBuffer.length;i++){emit.apply(this,this.receiveBuffer[i])}this.receiveBuffer=[];for(i=0;i<this.sendBuffer.length;i++){this.packet(this.sendBuffer[i])}this.sendBuffer=[]};Socket.prototype.ondisconnect=function(){debug("server disconnect (%s)",this.nsp);this.destroy();this.onclose("io server disconnect")};Socket.prototype.destroy=function(){if(this.subs){for(var i=0;i<this.subs.length;i++){this.subs[i].destroy()}this.subs=null}this.io.destroy(this)};Socket.prototype.close=Socket.prototype.disconnect=function(){if(this.connected){debug("performing disconnect (%s)",this.nsp);this.packet({type:parser.DISCONNECT})}this.destroy();if(this.connected){this.onclose("io client disconnect")}return this}},{"./on":4,"component-bind":8,"component-emitter":9,debug:10,"has-binary":38,"socket.io-parser":46,"to-array":50}],6:[function(_dereq_,module,exports){(function(global){var parseuri=_dereq_("parseuri");var debug=_dereq_("debug")("socket.io-client:url");module.exports=url;function url(uri,loc){var obj=uri;var loc=loc||global.location;if(null==uri)uri=loc.protocol+"//"+loc.host;if("string"==typeof uri){if("/"==uri.charAt(0)){if("/"==uri.charAt(1)){uri=loc.protocol+uri}else{uri=loc.hostname+uri}}if(!/^(https?|wss?):\/\//.test(uri)){debug("protocol-less url %s",uri);if("undefined"!=typeof loc){uri=loc.protocol+"//"+uri}else{uri="https://"+uri}}debug("parse %s",uri);obj=parseuri(uri)}if(!obj.port){if(/^(http|ws)$/.test(obj.protocol)){obj.port="80"}else if(/^(http|ws)s$/.test(obj.protocol)){obj.port="443"}}obj.path=obj.path||"/";obj.id=obj.protocol+"://"+obj.host+":"+obj.port;obj.href=obj.protocol+"://"+obj.host+(loc&&loc.port==obj.port?"":":"+obj.port);return obj}}).call(this,typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{debug:10,parseuri:44}],7:[function(_dereq_,module,exports){module.exports=Backoff;function Backoff(opts){opts=opts||{};this.ms=opts.min||100;this.max=opts.max||1e4;this.factor=opts.factor||2;this.jitter=opts.jitter>0&&opts.jitter<=1?opts.jitter:0;this.attempts=0}Backoff.prototype.duration=function(){var ms=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var rand=Math.random();var deviation=Math.floor(rand*this.jitter*ms);ms=(Math.floor(rand*10)&1)==0?ms-deviation:ms+deviation}return Math.min(ms,this.max)|0};Backoff.prototype.reset=function(){this.attempts=0};Backoff.prototype.setMin=function(min){this.ms=min};Backoff.prototype.setMax=function(max){this.max=max};Backoff.prototype.setJitter=function(jitter){this.jitter=jitter}},{}],8:[function(_dereq_,module,exports){var slice=[].slice;module.exports=function(obj,fn){if("string"==typeof fn)fn=obj[fn];if("function"!=typeof fn)throw new Error("bind() requires a function");var args=slice.call(arguments,2);return function(){return fn.apply(obj,args.concat(slice.call(arguments)))}}},{}],9:[function(_dereq_,module,exports){module.exports=Emitter;function Emitter(obj){if(obj)return mixin(obj)}function mixin(obj){for(var key in Emitter.prototype){obj[key]=Emitter.prototype[key]}return obj}Emitter.prototype.on=Emitter.prototype.addEventListener=function(event,fn){this._callbacks=this._callbacks||{};(this._callbacks[event]=this._callbacks[event]||[]).push(fn);return this};Emitter.prototype.once=function(event,fn){var self=this;this._callbacks=this._callbacks||{};function on(){self.off(event,on);fn.apply(this,arguments)}on.fn=fn;this.on(event,on);return this};Emitter.prototype.off=Emitter.prototype.removeListener=Emitter.prototype.removeAllListeners=Emitter.prototype.removeEventListener=function(event,fn){this._callbacks=this._callbacks||{};if(0==arguments.length){this._callbacks={};return this}var callbacks=this._callbacks[event];if(!callbacks)return this;if(1==arguments.length){delete this._callbacks[event];return this}var cb;for(var i=0;i<callbacks.length;i++){cb=callbacks[i];if(cb===fn||cb.fn===fn){callbacks.splice(i,1);break}}return this};Emitter.prototype.emit=function(event){this._callbacks=this._callbacks||{};var args=[].slice.call(arguments,1),callbacks=this._callbacks[event];if(callbacks){callbacks=callbacks.slice(0);for(var i=0,len=callbacks.length;i<len;++i){callbacks[i].apply(this,args)}}return this};Emitter.prototype.listeners=function(event){this._callbacks=this._callbacks||{};return this._callbacks[event]||[]};Emitter.prototype.hasListeners=function(event){return!!this.listeners(event).length}},{}],10:[function(_dereq_,module,exports){module.exports=debug;function debug(name){if(!debug.enabled(name))return function(){};return function(fmt){fmt=coerce(fmt);var curr=new Date;var ms=curr-(debug[name]||curr);debug[name]=curr;fmt=name+" "+fmt+" +"+debug.humanize(ms);window.console&&console.log&&Function.prototype.apply.call(console.log,console,arguments)}}debug.names=[];debug.skips=[];debug.enable=function(name){try{localStorage.debug=name}catch(e){}var split=(name||"").split(/[\s,]+/),len=split.length;for(var i=0;i<len;i++){name=split[i].replace("*",".*?");if(name[0]==="-"){debug.skips.push(new RegExp("^"+name.substr(1)+"$"))}else{debug.names.push(new RegExp("^"+name+"$"))}}};debug.disable=function(){debug.enable("")};debug.humanize=function(ms){var sec=1e3,min=60*1e3,hour=60*min;if(ms>=hour)return(ms/hour).toFixed(1)+"h";if(ms>=min)return(ms/min).toFixed(1)+"m";if(ms>=sec)return(ms/sec|0)+"s";return ms+"ms"};debug.enabled=function(name){for(var i=0,len=debug.skips.length;i<len;i++){if(debug.skips[i].test(name)){return false}}for(var i=0,len=debug.names.length;i<len;i++){if(debug.names[i].test(name)){return true}}return false};function coerce(val){if(val instanceof Error)return val.stack||val.message;return val}try{if(window.localStorage)debug.enable(localStorage.debug)}catch(e){}},{}],11:[function(_dereq_,module,exports){module.exports=_dereq_("./lib/")},{"./lib/":12}],12:[function(_dereq_,module,exports){module.exports=_dereq_("./socket");module.exports.parser=_dereq_("engine.io-parser")},{"./socket":13,"engine.io-parser":25}],13:[function(_dereq_,module,exports){(function(global){var transports=_dereq_("./transports");var Emitter=_dereq_("component-emitter");var debug=_dereq_("debug")("engine.io-client:socket");var index=_dereq_("indexof");var parser=_dereq_("engine.io-parser");var parseuri=_dereq_("parseuri");var parsejson=_dereq_("parsejson");var parseqs=_dereq_("parseqs");module.exports=Socket;function noop(){}function Socket(uri,opts){if(!(this instanceof Socket))return new Socket(uri,opts);opts=opts||{};if(uri&&"object"==typeof uri){opts=uri;uri=null}if(uri){uri=parseuri(uri);opts.host=uri.host;opts.secure=uri.protocol=="https"||uri.protocol=="wss";opts.port=uri.port;if(uri.query)opts.query=uri.query}this.secure=null!=opts.secure?opts.secure:global.location&&"https:"==location.protocol;if(opts.host){var pieces=opts.host.split(":");opts.hostname=pieces.shift();if(pieces.length){opts.port=pieces.pop()}else if(!opts.port){opts.port=this.secure?"443":"80"}}this.agent=opts.agent||false;this.hostname=opts.hostname||(global.location?location.hostname:"localhost");this.port=opts.port||(global.location&&location.port?location.port:this.secure?443:80);this.query=opts.query||{};if("string"==typeof this.query)this.query=parseqs.decode(this.query);this.upgrade=false!==opts.upgrade;this.path=(opts.path||"/engine.io").replace(/\/$/,"")+"/";this.forceJSONP=!!opts.forceJSONP;this.jsonp=false!==opts.jsonp;this.forceBase64=!!opts.forceBase64;this.enablesXDR=!!opts.enablesXDR;this.timestampParam=opts.timestampParam||"t";this.timestampRequests=opts.timestampRequests;this.transports=opts.transports||["polling","websocket"];this.readyState="";this.writeBuffer=[];this.callbackBuffer=[];this.policyPort=opts.policyPort||843;this.rememberUpgrade=opts.rememberUpgrade||false;this.binaryType=null;this.onlyBinaryUpgrades=opts.onlyBinaryUpgrades;this.pfx=opts.pfx||null;this.key=opts.key||null;this.passphrase=opts.passphrase||null;this.cert=opts.cert||null;this.ca=opts.ca||null;this.ciphers=opts.ciphers||null;this.rejectUnauthorized=opts.rejectUnauthorized||null;this.open()}Socket.priorWebsocketSuccess=false;Emitter(Socket.prototype);Socket.protocol=parser.protocol;Socket.Socket=Socket;Socket.Transport=_dereq_("./transport");Socket.transports=_dereq_("./transports");Socket.parser=_dereq_("engine.io-parser");Socket.prototype.createTransport=function(name){debug('creating transport "%s"',name);var query=clone(this.query);query.EIO=parser.protocol;query.transport=name;if(this.id)query.sid=this.id;var transport=new transports[name]({agent:this.agent,hostname:this.hostname,port:this.port,secure:this.secure,path:this.path,query:query,forceJSONP:this.forceJSONP,jsonp:this.jsonp,forceBase64:this.forceBase64,enablesXDR:this.enablesXDR,timestampRequests:this.timestampRequests,timestampParam:this.timestampParam,policyPort:this.policyPort,socket:this,pfx:this.pfx,key:this.key,passphrase:this.passphrase,cert:this.cert,ca:this.ca,ciphers:this.ciphers,rejectUnauthorized:this.rejectUnauthorized});return transport};function clone(obj){var o={};for(var i in obj){if(obj.hasOwnProperty(i)){o[i]=obj[i]}}return o}Socket.prototype.open=function(){var transport;if(this.rememberUpgrade&&Socket.priorWebsocketSuccess&&this.transports.indexOf("websocket")!=-1){transport="websocket"}else if(0==this.transports.length){var self=this;setTimeout(function(){self.emit("error","No transports available")},0);return}else{transport=this.transports[0]}this.readyState="opening";var transport;try{transport=this.createTransport(transport)}catch(e){this.transports.shift();this.open();return}transport.open();this.setTransport(transport)};Socket.prototype.setTransport=function(transport){debug("setting transport %s",transport.name);var self=this;if(this.transport){debug("clearing existing transport %s",this.transport.name);this.transport.removeAllListeners()}this.transport=transport;transport.on("drain",function(){self.onDrain()}).on("packet",function(packet){self.onPacket(packet)}).on("error",function(e){self.onError(e)}).on("close",function(){self.onClose("transport close")})};Socket.prototype.probe=function(name){debug('probing transport "%s"',name);var transport=this.createTransport(name,{probe:1}),failed=false,self=this;Socket.priorWebsocketSuccess=false;function onTransportOpen(){if(self.onlyBinaryUpgrades){var upgradeLosesBinary=!this.supportsBinary&&self.transport.supportsBinary;failed=failed||upgradeLosesBinary}if(failed)return;debug('probe transport "%s" opened',name);transport.send([{type:"ping",data:"probe"}]);transport.once("packet",function(msg){if(failed)return;if("pong"==msg.type&&"probe"==msg.data){debug('probe transport "%s" pong',name);self.upgrading=true;self.emit("upgrading",transport);if(!transport)return;Socket.priorWebsocketSuccess="websocket"==transport.name;debug('pausing current transport "%s"',self.transport.name);self.transport.pause(function(){if(failed)return;if("closed"==self.readyState)return;debug("changing transport and sending upgrade packet");cleanup();self.setTransport(transport);transport.send([{type:"upgrade"}]);self.emit("upgrade",transport);transport=null;self.upgrading=false;self.flush()})}else{debug('probe transport "%s" failed',name);var err=new Error("probe error");err.transport=transport.name;self.emit("upgradeError",err)}})}function freezeTransport(){if(failed)return;failed=true;cleanup();transport.close();transport=null}function onerror(err){var error=new Error("probe error: "+err);error.transport=transport.name;freezeTransport();debug('probe transport "%s" failed because of error: %s',name,err);self.emit("upgradeError",error)}function onTransportClose(){onerror("transport closed")}function onclose(){onerror("socket closed")}function onupgrade(to){if(transport&&to.name!=transport.name){debug('"%s" works - aborting "%s"',to.name,transport.name);freezeTransport()}}function cleanup(){transport.removeListener("open",onTransportOpen);transport.removeListener("error",onerror);transport.removeListener("close",onTransportClose);self.removeListener("close",onclose);self.removeListener("upgrading",onupgrade)}transport.once("open",onTransportOpen);transport.once("error",onerror);transport.once("close",onTransportClose);this.once("close",onclose);this.once("upgrading",onupgrade);transport.open()};Socket.prototype.onOpen=function(){debug("socket open");this.readyState="open";Socket.priorWebsocketSuccess="websocket"==this.transport.name;this.emit("open");this.flush();if("open"==this.readyState&&this.upgrade&&this.transport.pause){debug("starting upgrade probes");for(var i=0,l=this.upgrades.length;i<l;i++){this.probe(this.upgrades[i])}}};Socket.prototype.onPacket=function(packet){if("opening"==this.readyState||"open"==this.readyState){debug('socket receive: type "%s", data "%s"',packet.type,packet.data);this.emit("packet",packet);this.emit("heartbeat");switch(packet.type){case"open":this.onHandshake(parsejson(packet.data));break;case"pong":this.setPing();break;case"error":var err=new Error("server error");err.code=packet.data;this.emit("error",err);break;case"message":this.emit("data",packet.data);this.emit("message",packet.data);break}}else{debug('packet received with socket readyState "%s"',this.readyState)}};Socket.prototype.onHandshake=function(data){this.emit("handshake",data);this.id=data.sid;this.transport.query.sid=data.sid;this.upgrades=this.filterUpgrades(data.upgrades);this.pingInterval=data.pingInterval;this.pingTimeout=data.pingTimeout;this.onOpen();if("closed"==this.readyState)return;this.setPing();this.removeListener("heartbeat",this.onHeartbeat);this.on("heartbeat",this.onHeartbeat)};Socket.prototype.onHeartbeat=function(timeout){clearTimeout(this.pingTimeoutTimer);var self=this;self.pingTimeoutTimer=setTimeout(function(){if("closed"==self.readyState)return;self.onClose("ping timeout")},timeout||self.pingInterval+self.pingTimeout)};Socket.prototype.setPing=function(){var self=this;clearTimeout(self.pingIntervalTimer);self.pingIntervalTimer=setTimeout(function(){debug("writing ping packet - expecting pong within %sms",self.pingTimeout);self.ping();self.onHeartbeat(self.pingTimeout)},self.pingInterval)};Socket.prototype.ping=function(){this.sendPacket("ping")};Socket.prototype.onDrain=function(){for(var i=0;i<this.prevBufferLen;i++){if(this.callbackBuffer[i]){this.callbackBuffer[i]()}}this.writeBuffer.splice(0,this.prevBufferLen);this.callbackBuffer.splice(0,this.prevBufferLen);this.prevBufferLen=0;if(this.writeBuffer.length==0){this.emit("drain")}else{this.flush()}};Socket.prototype.flush=function(){if("closed"!=this.readyState&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length){debug("flushing %d packets in socket",this.writeBuffer.length);this.transport.send(this.writeBuffer);this.prevBufferLen=this.writeBuffer.length;this.emit("flush")}};Socket.prototype.write=Socket.prototype.send=function(msg,fn){this.sendPacket("message",msg,fn);return this};Socket.prototype.sendPacket=function(type,data,fn){if("closing"==this.readyState||"closed"==this.readyState){return}var packet={type:type,data:data};this.emit("packetCreate",packet);this.writeBuffer.push(packet);this.callbackBuffer.push(fn);this.flush()};Socket.prototype.close=function(){if("opening"==this.readyState||"open"==this.readyState){this.readyState="closing";var self=this;function close(){self.onClose("forced close");debug("socket closing - telling transport to close");self.transport.close()}function cleanupAndClose(){self.removeListener("upgrade",cleanupAndClose);self.removeListener("upgradeError",cleanupAndClose);close()}function waitForUpgrade(){self.once("upgrade",cleanupAndClose);self.once("upgradeError",cleanupAndClose)}if(this.writeBuffer.length){this.once("drain",function(){if(this.upgrading){waitForUpgrade()}else{close()}})}else if(this.upgrading){waitForUpgrade()}else{close()}}return this};Socket.prototype.onError=function(err){debug("socket error %j",err);Socket.priorWebsocketSuccess=false;this.emit("error",err);this.onClose("transport error",err)};Socket.prototype.onClose=function(reason,desc){if("opening"==this.readyState||"open"==this.readyState||"closing"==this.readyState){debug('socket close with reason: "%s"',reason);var self=this;clearTimeout(this.pingIntervalTimer);clearTimeout(this.pingTimeoutTimer);setTimeout(function(){self.writeBuffer=[];self.callbackBuffer=[];self.prevBufferLen=0},0);this.transport.removeAllListeners("close");this.transport.close();this.transport.removeAllListeners();this.readyState="closed";this.id=null;this.emit("close",reason,desc)}};Socket.prototype.filterUpgrades=function(upgrades){var filteredUpgrades=[];for(var i=0,j=upgrades.length;i<j;i++){if(~index(this.transports,upgrades[i]))filteredUpgrades.push(upgrades[i])}return filteredUpgrades}}).call(this,typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"./transport":14,"./transports":15,"component-emitter":9,debug:22,"engine.io-parser":25,indexof:42,parsejson:34,parseqs:35,parseuri:36}],14:[function(_dereq_,module,exports){var parser=_dereq_("engine.io-parser");var Emitter=_dereq_("component-emitter");module.exports=Transport;function Transport(opts){this.path=opts.path;this.hostname=opts.hostname;this.port=opts.port;this.secure=opts.secure;this.query=opts.query;this.timestampParam=opts.timestampParam;this.timestampRequests=opts.timestampRequests;this.readyState="";this.agent=opts.agent||false;this.socket=opts.socket;this.enablesXDR=opts.enablesXDR;this.pfx=opts.pfx;this.key=opts.key;this.passphrase=opts.passphrase;this.cert=opts.cert;this.ca=opts.ca;this.ciphers=opts.ciphers;this.rejectUnauthorized=opts.rejectUnauthorized}Emitter(Transport.prototype);Transport.timestamps=0;Transport.prototype.onError=function(msg,desc){var err=new Error(msg);err.type="TransportError";err.description=desc;this.emit("error",err);return this};Transport.prototype.open=function(){if("closed"==this.readyState||""==this.readyState){this.readyState="opening";this.doOpen()}return this};Transport.prototype.close=function(){if("opening"==this.readyState||"open"==this.readyState){this.doClose();this.onClose()}return this};Transport.prototype.send=function(packets){if("open"==this.readyState){this.write(packets)}else{throw new Error("Transport not open")}};Transport.prototype.onOpen=function(){this.readyState="open";this.writable=true;this.emit("open")};Transport.prototype.onData=function(data){var packet=parser.decodePacket(data,this.socket.binaryType);this.onPacket(packet)};Transport.prototype.onPacket=function(packet){this.emit("packet",packet)};Transport.prototype.onClose=function(){this.readyState="closed";this.emit("close")}},{"component-emitter":9,"engine.io-parser":25}],15:[function(_dereq_,module,exports){(function(global){var XMLHttpRequest=_dereq_("xmlhttprequest");var XHR=_dereq_("./polling-xhr");var JSONP=_dereq_("./polling-jsonp");var websocket=_dereq_("./websocket");exports.polling=polling;exports.websocket=websocket;function polling(opts){var xhr;var xd=false;var xs=false;var jsonp=false!==opts.jsonp;if(global.location){var isSSL="https:"==location.protocol;var port=location.port;if(!port){port=isSSL?443:80}xd=opts.hostname!=location.hostname||port!=opts.port;xs=opts.secure!=isSSL}opts.xdomain=xd;opts.xscheme=xs;xhr=new XMLHttpRequest(opts);if("open"in xhr&&!opts.forceJSONP){return new XHR(opts)}else{if(!jsonp)throw new Error("JSONP disabled");return new JSONP(opts)}}}).call(this,typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"./polling-jsonp":16,"./polling-xhr":17,"./websocket":19,xmlhttprequest:20}],16:[function(_dereq_,module,exports){(function(global){var Polling=_dereq_("./polling");var inherit=_dereq_("component-inherit");module.exports=JSONPPolling;var rNewline=/\n/g;var rEscapedNewline=/\\n/g;var callbacks;var index=0;function empty(){}function JSONPPolling(opts){Polling.call(this,opts);
this.query=this.query||{};if(!callbacks){if(!global.___eio)global.___eio=[];callbacks=global.___eio}this.index=callbacks.length;var self=this;callbacks.push(function(msg){self.onData(msg)});this.query.j=this.index;if(global.document&&global.addEventListener){global.addEventListener("beforeunload",function(){if(self.script)self.script.onerror=empty},false)}}inherit(JSONPPolling,Polling);JSONPPolling.prototype.supportsBinary=false;JSONPPolling.prototype.doClose=function(){if(this.script){this.script.parentNode.removeChild(this.script);this.script=null}if(this.form){this.form.parentNode.removeChild(this.form);this.form=null;this.iframe=null}Polling.prototype.doClose.call(this)};JSONPPolling.prototype.doPoll=function(){var self=this;var script=document.createElement("script");if(this.script){this.script.parentNode.removeChild(this.script);this.script=null}script.async=true;script.src=this.uri();script.onerror=function(e){self.onError("jsonp poll error",e)};var insertAt=document.getElementsByTagName("script")[0];insertAt.parentNode.insertBefore(script,insertAt);this.script=script;var isUAgecko="undefined"!=typeof navigator&&/gecko/i.test(navigator.userAgent);if(isUAgecko){setTimeout(function(){var iframe=document.createElement("iframe");document.body.appendChild(iframe);document.body.removeChild(iframe)},100)}};JSONPPolling.prototype.doWrite=function(data,fn){var self=this;if(!this.form){var form=document.createElement("form");var area=document.createElement("textarea");var id=this.iframeId="eio_iframe_"+this.index;var iframe;form.className="socketio";form.style.position="absolute";form.style.top="-1000px";form.style.left="-1000px";form.target=id;form.method="POST";form.setAttribute("accept-charset","utf-8");area.name="d";form.appendChild(area);document.body.appendChild(form);this.form=form;this.area=area}this.form.action=this.uri();function complete(){initIframe();fn()}function initIframe(){if(self.iframe){try{self.form.removeChild(self.iframe)}catch(e){self.onError("jsonp polling iframe removal error",e)}}try{var html='<iframe src="javascript:0" name="'+self.iframeId+'">';iframe=document.createElement(html)}catch(e){iframe=document.createElement("iframe");iframe.name=self.iframeId;iframe.src="javascript:0"}iframe.id=self.iframeId;self.form.appendChild(iframe);self.iframe=iframe}initIframe();data=data.replace(rEscapedNewline,"\\\n");this.area.value=data.replace(rNewline,"\\n");try{this.form.submit()}catch(e){}if(this.iframe.attachEvent){this.iframe.onreadystatechange=function(){if(self.iframe.readyState=="complete"){complete()}}}else{this.iframe.onload=complete}}}).call(this,typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"./polling":18,"component-inherit":21}],17:[function(_dereq_,module,exports){(function(global){var XMLHttpRequest=_dereq_("xmlhttprequest");var Polling=_dereq_("./polling");var Emitter=_dereq_("component-emitter");var inherit=_dereq_("component-inherit");var debug=_dereq_("debug")("engine.io-client:polling-xhr");module.exports=XHR;module.exports.Request=Request;function empty(){}function XHR(opts){Polling.call(this,opts);if(global.location){var isSSL="https:"==location.protocol;var port=location.port;if(!port){port=isSSL?443:80}this.xd=opts.hostname!=global.location.hostname||port!=opts.port;this.xs=opts.secure!=isSSL}}inherit(XHR,Polling);XHR.prototype.supportsBinary=true;XHR.prototype.request=function(opts){opts=opts||{};opts.uri=this.uri();opts.xd=this.xd;opts.xs=this.xs;opts.agent=this.agent||false;opts.supportsBinary=this.supportsBinary;opts.enablesXDR=this.enablesXDR;opts.pfx=this.pfx;opts.key=this.key;opts.passphrase=this.passphrase;opts.cert=this.cert;opts.ca=this.ca;opts.ciphers=this.ciphers;opts.rejectUnauthorized=this.rejectUnauthorized;return new Request(opts)};XHR.prototype.doWrite=function(data,fn){var isBinary=typeof data!=="string"&&data!==undefined;var req=this.request({method:"POST",data:data,isBinary:isBinary});var self=this;req.on("success",fn);req.on("error",function(err){self.onError("xhr post error",err)});this.sendXhr=req};XHR.prototype.doPoll=function(){debug("xhr poll");var req=this.request();var self=this;req.on("data",function(data){self.onData(data)});req.on("error",function(err){self.onError("xhr poll error",err)});this.pollXhr=req};function Request(opts){this.method=opts.method||"GET";this.uri=opts.uri;this.xd=!!opts.xd;this.xs=!!opts.xs;this.async=false!==opts.async;this.data=undefined!=opts.data?opts.data:null;this.agent=opts.agent;this.isBinary=opts.isBinary;this.supportsBinary=opts.supportsBinary;this.enablesXDR=opts.enablesXDR;this.pfx=opts.pfx;this.key=opts.key;this.passphrase=opts.passphrase;this.cert=opts.cert;this.ca=opts.ca;this.ciphers=opts.ciphers;this.rejectUnauthorized=opts.rejectUnauthorized;this.create()}Emitter(Request.prototype);Request.prototype.create=function(){var opts={agent:this.agent,xdomain:this.xd,xscheme:this.xs,enablesXDR:this.enablesXDR};opts.pfx=this.pfx;opts.key=this.key;opts.passphrase=this.passphrase;opts.cert=this.cert;opts.ca=this.ca;opts.ciphers=this.ciphers;opts.rejectUnauthorized=this.rejectUnauthorized;var xhr=this.xhr=new XMLHttpRequest(opts);var self=this;try{debug("xhr open %s: %s",this.method,this.uri);xhr.open(this.method,this.uri,this.async);if(this.supportsBinary){xhr.responseType="arraybuffer"}if("POST"==this.method){try{if(this.isBinary){xhr.setRequestHeader("Content-type","application/octet-stream")}else{xhr.setRequestHeader("Content-type","text/plain;charset=UTF-8")}}catch(e){}}if("withCredentials"in xhr){xhr.withCredentials=true}if(this.hasXDR()){xhr.onload=function(){self.onLoad()};xhr.onerror=function(){self.onError(xhr.responseText)}}else{xhr.onreadystatechange=function(){if(4!=xhr.readyState)return;if(200==xhr.status||1223==xhr.status){self.onLoad()}else{setTimeout(function(){self.onError(xhr.status)},0)}}}debug("xhr data %s",this.data);xhr.send(this.data)}catch(e){setTimeout(function(){self.onError(e)},0);return}if(global.document){this.index=Request.requestsCount++;Request.requests[this.index]=this}};Request.prototype.onSuccess=function(){this.emit("success");this.cleanup()};Request.prototype.onData=function(data){this.emit("data",data);this.onSuccess()};Request.prototype.onError=function(err){this.emit("error",err);this.cleanup(true)};Request.prototype.cleanup=function(fromError){if("undefined"==typeof this.xhr||null===this.xhr){return}if(this.hasXDR()){this.xhr.onload=this.xhr.onerror=empty}else{this.xhr.onreadystatechange=empty}if(fromError){try{this.xhr.abort()}catch(e){}}if(global.document){delete Request.requests[this.index]}this.xhr=null};Request.prototype.onLoad=function(){var data;try{var contentType;try{contentType=this.xhr.getResponseHeader("Content-Type").split(";")[0]}catch(e){}if(contentType==="application/octet-stream"){data=this.xhr.response}else{if(!this.supportsBinary){data=this.xhr.responseText}else{data="ok"}}}catch(e){this.onError(e)}if(null!=data){this.onData(data)}};Request.prototype.hasXDR=function(){return"undefined"!==typeof global.XDomainRequest&&!this.xs&&this.enablesXDR};Request.prototype.abort=function(){this.cleanup()};if(global.document){Request.requestsCount=0;Request.requests={};if(global.attachEvent){global.attachEvent("onunload",unloadHandler)}else if(global.addEventListener){global.addEventListener("beforeunload",unloadHandler,false)}}function unloadHandler(){for(var i in Request.requests){if(Request.requests.hasOwnProperty(i)){Request.requests[i].abort()}}}}).call(this,typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"./polling":18,"component-emitter":9,"component-inherit":21,debug:22,xmlhttprequest:20}],18:[function(_dereq_,module,exports){var Transport=_dereq_("../transport");var parseqs=_dereq_("parseqs");var parser=_dereq_("engine.io-parser");var inherit=_dereq_("component-inherit");var debug=_dereq_("debug")("engine.io-client:polling");module.exports=Polling;var hasXHR2=function(){var XMLHttpRequest=_dereq_("xmlhttprequest");var xhr=new XMLHttpRequest({xdomain:false});return null!=xhr.responseType}();function Polling(opts){var forceBase64=opts&&opts.forceBase64;if(!hasXHR2||forceBase64){this.supportsBinary=false}Transport.call(this,opts)}inherit(Polling,Transport);Polling.prototype.name="polling";Polling.prototype.doOpen=function(){this.poll()};Polling.prototype.pause=function(onPause){var pending=0;var self=this;this.readyState="pausing";function pause(){debug("paused");self.readyState="paused";onPause()}if(this.polling||!this.writable){var total=0;if(this.polling){debug("we are currently polling - waiting to pause");total++;this.once("pollComplete",function(){debug("pre-pause polling complete");--total||pause()})}if(!this.writable){debug("we are currently writing - waiting to pause");total++;this.once("drain",function(){debug("pre-pause writing complete");--total||pause()})}}else{pause()}};Polling.prototype.poll=function(){debug("polling");this.polling=true;this.doPoll();this.emit("poll")};Polling.prototype.onData=function(data){var self=this;debug("polling got data %s",data);var callback=function(packet,index,total){if("opening"==self.readyState){self.onOpen()}if("close"==packet.type){self.onClose();return false}self.onPacket(packet)};parser.decodePayload(data,this.socket.binaryType,callback);if("closed"!=this.readyState){this.polling=false;this.emit("pollComplete");if("open"==this.readyState){this.poll()}else{debug('ignoring poll - transport state "%s"',this.readyState)}}};Polling.prototype.doClose=function(){var self=this;function close(){debug("writing close packet");self.write([{type:"close"}])}if("open"==this.readyState){debug("transport open - closing");close()}else{debug("transport not open - deferring close");this.once("open",close)}};Polling.prototype.write=function(packets){var self=this;this.writable=false;var callbackfn=function(){self.writable=true;self.emit("drain")};var self=this;parser.encodePayload(packets,this.supportsBinary,function(data){self.doWrite(data,callbackfn)})};Polling.prototype.uri=function(){var query=this.query||{};var schema=this.secure?"https":"http";var port="";if(false!==this.timestampRequests){query[this.timestampParam]=+new Date+"-"+Transport.timestamps++}if(!this.supportsBinary&&!query.sid){query.b64=1}query=parseqs.encode(query);if(this.port&&("https"==schema&&this.port!=443||"http"==schema&&this.port!=80)){port=":"+this.port}if(query.length){query="?"+query}return schema+"://"+this.hostname+port+this.path+query}},{"../transport":14,"component-inherit":21,debug:22,"engine.io-parser":25,parseqs:35,xmlhttprequest:20}],19:[function(_dereq_,module,exports){var Transport=_dereq_("../transport");var parser=_dereq_("engine.io-parser");var parseqs=_dereq_("parseqs");var inherit=_dereq_("component-inherit");var debug=_dereq_("debug")("engine.io-client:websocket");var WebSocket=_dereq_("ws");module.exports=WS;function WS(opts){var forceBase64=opts&&opts.forceBase64;if(forceBase64){this.supportsBinary=false}Transport.call(this,opts)}inherit(WS,Transport);WS.prototype.name="websocket";WS.prototype.supportsBinary=true;WS.prototype.doOpen=function(){if(!this.check()){return}var self=this;var uri=this.uri();var protocols=void 0;var opts={agent:this.agent};opts.pfx=this.pfx;opts.key=this.key;opts.passphrase=this.passphrase;opts.cert=this.cert;opts.ca=this.ca;opts.ciphers=this.ciphers;opts.rejectUnauthorized=this.rejectUnauthorized;this.ws=new WebSocket(uri,protocols,opts);if(this.ws.binaryType===undefined){this.supportsBinary=false}this.ws.binaryType="arraybuffer";this.addEventListeners()};WS.prototype.addEventListeners=function(){var self=this;this.ws.onopen=function(){self.onOpen()};this.ws.onclose=function(){self.onClose()};this.ws.onmessage=function(ev){self.onData(ev.data)};this.ws.onerror=function(e){self.onError("websocket error",e)}};if("undefined"!=typeof navigator&&/iPad|iPhone|iPod/i.test(navigator.userAgent)){WS.prototype.onData=function(data){var self=this;setTimeout(function(){Transport.prototype.onData.call(self,data)},0)}}WS.prototype.write=function(packets){var self=this;this.writable=false;for(var i=0,l=packets.length;i<l;i++){parser.encodePacket(packets[i],this.supportsBinary,function(data){try{self.ws.send(data)}catch(e){debug("websocket closed before onclose event")}})}function ondrain(){self.writable=true;self.emit("drain")}setTimeout(ondrain,0)};WS.prototype.onClose=function(){Transport.prototype.onClose.call(this)};WS.prototype.doClose=function(){if(typeof this.ws!=="undefined"){this.ws.close()}};WS.prototype.uri=function(){var query=this.query||{};var schema=this.secure?"wss":"ws";var port="";if(this.port&&("wss"==schema&&this.port!=443||"ws"==schema&&this.port!=80)){port=":"+this.port}if(this.timestampRequests){query[this.timestampParam]=+new Date}if(!this.supportsBinary){query.b64=1}query=parseqs.encode(query);if(query.length){query="?"+query}return schema+"://"+this.hostname+port+this.path+query};WS.prototype.check=function(){return!!WebSocket&&!("__initialize"in WebSocket&&this.name===WS.prototype.name)}},{"../transport":14,"component-inherit":21,debug:22,"engine.io-parser":25,parseqs:35,ws:37}],20:[function(_dereq_,module,exports){var hasCORS=_dereq_("has-cors");module.exports=function(opts){var xdomain=opts.xdomain;var xscheme=opts.xscheme;var enablesXDR=opts.enablesXDR;try{if("undefined"!=typeof XMLHttpRequest&&(!xdomain||hasCORS)){return new XMLHttpRequest}}catch(e){}try{if("undefined"!=typeof XDomainRequest&&!xscheme&&enablesXDR){return new XDomainRequest}}catch(e){}if(!xdomain){try{return new ActiveXObject("Microsoft.XMLHTTP")}catch(e){}}}},{"has-cors":40}],21:[function(_dereq_,module,exports){module.exports=function(a,b){var fn=function(){};fn.prototype=b.prototype;a.prototype=new fn;a.prototype.constructor=a}},{}],22:[function(_dereq_,module,exports){exports=module.exports=_dereq_("./debug");exports.log=log;exports.formatArgs=formatArgs;exports.save=save;exports.load=load;exports.useColors=useColors;exports.colors=["lightseagreen","forestgreen","goldenrod","dodgerblue","darkorchid","crimson"];function useColors(){return"WebkitAppearance"in document.documentElement.style||window.console&&(console.firebug||console.exception&&console.table)||navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31}exports.formatters.j=function(v){return JSON.stringify(v)};function formatArgs(){var args=arguments;var useColors=this.useColors;args[0]=(useColors?"%c":"")+this.namespace+(useColors?" %c":" ")+args[0]+(useColors?"%c ":" ")+"+"+exports.humanize(this.diff);if(!useColors)return args;var c="color: "+this.color;args=[args[0],c,"color: inherit"].concat(Array.prototype.slice.call(args,1));var index=0;var lastC=0;args[0].replace(/%[a-z%]/g,function(match){if("%"===match)return;index++;if("%c"===match){lastC=index}});args.splice(lastC,0,c);return args}function log(){return"object"==typeof console&&"function"==typeof console.log&&Function.prototype.apply.call(console.log,console,arguments)}function save(namespaces){try{if(null==namespaces){localStorage.removeItem("debug")}else{localStorage.debug=namespaces}}catch(e){}}function load(){var r;try{r=localStorage.debug}catch(e){}return r}exports.enable(load())},{"./debug":23}],23:[function(_dereq_,module,exports){exports=module.exports=debug;exports.coerce=coerce;exports.disable=disable;exports.enable=enable;exports.enabled=enabled;exports.humanize=_dereq_("ms");exports.names=[];exports.skips=[];exports.formatters={};var prevColor=0;var prevTime;function selectColor(){return exports.colors[prevColor++%exports.colors.length]}function debug(namespace){function disabled(){}disabled.enabled=false;function enabled(){var self=enabled;var curr=+new Date;var ms=curr-(prevTime||curr);self.diff=ms;self.prev=prevTime;self.curr=curr;prevTime=curr;if(null==self.useColors)self.useColors=exports.useColors();if(null==self.color&&self.useColors)self.color=selectColor();var args=Array.prototype.slice.call(arguments);args[0]=exports.coerce(args[0]);if("string"!==typeof args[0]){args=["%o"].concat(args)}var index=0;args[0]=args[0].replace(/%([a-z%])/g,function(match,format){if(match==="%")return match;index++;var formatter=exports.formatters[format];if("function"===typeof formatter){var val=args[index];match=formatter.call(self,val);args.splice(index,1);index--}return match});if("function"===typeof exports.formatArgs){args=exports.formatArgs.apply(self,args)}var logFn=enabled.log||exports.log||console.log.bind(console);logFn.apply(self,args)}enabled.enabled=true;var fn=exports.enabled(namespace)?enabled:disabled;fn.namespace=namespace;return fn}function enable(namespaces){exports.save(namespaces);var split=(namespaces||"").split(/[\s,]+/);var len=split.length;for(var i=0;i<len;i++){if(!split[i])continue;namespaces=split[i].replace(/\*/g,".*?");if(namespaces[0]==="-"){exports.skips.push(new RegExp("^"+namespaces.substr(1)+"$"))}else{exports.names.push(new RegExp("^"+namespaces+"$"))}}}function disable(){exports.enable("")}function enabled(name){var i,len;for(i=0,len=exports.skips.length;i<len;i++){if(exports.skips[i].test(name)){return false}}for(i=0,len=exports.names.length;i<len;i++){if(exports.names[i].test(name)){return true}}return false}function coerce(val){if(val instanceof Error)return val.stack||val.message;return val}},{ms:24}],24:[function(_dereq_,module,exports){var s=1e3;var m=s*60;var h=m*60;var d=h*24;var y=d*365.25;module.exports=function(val,options){options=options||{};if("string"==typeof val)return parse(val);return options.long?long(val):short(val)};function parse(str){var match=/^((?:\d+)?\.?\d+) *(ms|seconds?|s|minutes?|m|hours?|h|days?|d|years?|y)?$/i.exec(str);if(!match)return;var n=parseFloat(match[1]);var type=(match[2]||"ms").toLowerCase();switch(type){case"years":case"year":case"y":return n*y;case"days":case"day":case"d":return n*d;case"hours":case"hour":case"h":return n*h;case"minutes":case"minute":case"m":return n*m;case"seconds":case"second":case"s":return n*s;case"ms":return n}}function short(ms){if(ms>=d)return Math.round(ms/d)+"d";if(ms>=h)return Math.round(ms/h)+"h";if(ms>=m)return Math.round(ms/m)+"m";if(ms>=s)return Math.round(ms/s)+"s";return ms+"ms"}function long(ms){return plural(ms,d,"day")||plural(ms,h,"hour")||plural(ms,m,"minute")||plural(ms,s,"second")||ms+" ms"}function plural(ms,n,name){if(ms<n)return;if(ms<n*1.5)return Math.floor(ms/n)+" "+name;return Math.ceil(ms/n)+" "+name+"s"}},{}],25:[function(_dereq_,module,exports){(function(global){var keys=_dereq_("./keys");var hasBinary=_dereq_("has-binary");var sliceBuffer=_dereq_("arraybuffer.slice");var base64encoder=_dereq_("base64-arraybuffer");var after=_dereq_("after");var utf8=_dereq_("utf8");var isAndroid=navigator.userAgent.match(/Android/i);var isPhantomJS=/PhantomJS/i.test(navigator.userAgent);var dontSendBlobs=isAndroid||isPhantomJS;exports.protocol=3;var packets=exports.packets={open:0,close:1,ping:2,pong:3,message:4,upgrade:5,noop:6};var packetslist=keys(packets);var err={type:"error",data:"parser error"};var Blob=_dereq_("blob");exports.encodePacket=function(packet,supportsBinary,utf8encode,callback){if("function"==typeof supportsBinary){callback=supportsBinary;supportsBinary=false}if("function"==typeof utf8encode){callback=utf8encode;utf8encode=null}var data=packet.data===undefined?undefined:packet.data.buffer||packet.data;if(global.ArrayBuffer&&data instanceof ArrayBuffer){return encodeArrayBuffer(packet,supportsBinary,callback)}else if(Blob&&data instanceof global.Blob){return encodeBlob(packet,supportsBinary,callback)}if(data&&data.base64){return encodeBase64Object(packet,callback)}var encoded=packets[packet.type];if(undefined!==packet.data){encoded+=utf8encode?utf8.encode(String(packet.data)):String(packet.data)}return callback(""+encoded)};function encodeBase64Object(packet,callback){var message="b"+exports.packets[packet.type]+packet.data.data;return callback(message)}function encodeArrayBuffer(packet,supportsBinary,callback){if(!supportsBinary){return exports.encodeBase64Packet(packet,callback)}var data=packet.data;var contentArray=new Uint8Array(data);var resultBuffer=new Uint8Array(1+data.byteLength);resultBuffer[0]=packets[packet.type];for(var i=0;i<contentArray.length;i++){resultBuffer[i+1]=contentArray[i]}return callback(resultBuffer.buffer)}function encodeBlobAsArrayBuffer(packet,supportsBinary,callback){if(!supportsBinary){return exports.encodeBase64Packet(packet,callback)}var fr=new FileReader;fr.onload=function(){packet.data=fr.result;exports.encodePacket(packet,supportsBinary,true,callback)};return fr.readAsArrayBuffer(packet.data)}function encodeBlob(packet,supportsBinary,callback){if(!supportsBinary){return exports.encodeBase64Packet(packet,callback)}if(dontSendBlobs){return encodeBlobAsArrayBuffer(packet,supportsBinary,callback)}var length=new Uint8Array(1);length[0]=packets[packet.type];var blob=new Blob([length.buffer,packet.data]);return callback(blob)}exports.encodeBase64Packet=function(packet,callback){var message="b"+exports.packets[packet.type];if(Blob&&packet.data instanceof Blob){var fr=new FileReader;fr.onload=function(){var b64=fr.result.split(",")[1];callback(message+b64)};return fr.readAsDataURL(packet.data)}var b64data;try{b64data=String.fromCharCode.apply(null,new Uint8Array(packet.data))}catch(e){var typed=new Uint8Array(packet.data);var basic=new Array(typed.length);for(var i=0;i<typed.length;i++){basic[i]=typed[i]}b64data=String.fromCharCode.apply(null,basic)}message+=global.btoa(b64data);return callback(message)};exports.decodePacket=function(data,binaryType,utf8decode){if(typeof data=="string"||data===undefined){if(data.charAt(0)=="b"){return exports.decodeBase64Packet(data.substr(1),binaryType)}if(utf8decode){try{data=utf8.decode(data)}catch(e){return err}}var type=data.charAt(0);if(Number(type)!=type||!packetslist[type]){return err}if(data.length>1){return{type:packetslist[type],data:data.substring(1)}}else{return{type:packetslist[type]}}}var asArray=new Uint8Array(data);var type=asArray[0];var rest=sliceBuffer(data,1);if(Blob&&binaryType==="blob"){rest=new Blob([rest])}return{type:packetslist[type],data:rest}};exports.decodeBase64Packet=function(msg,binaryType){var type=packetslist[msg.charAt(0)];if(!global.ArrayBuffer){return{type:type,data:{base64:true,data:msg.substr(1)}}}var data=base64encoder.decode(msg.substr(1));if(binaryType==="blob"&&Blob){data=new Blob([data])}return{type:type,data:data}};exports.encodePayload=function(packets,supportsBinary,callback){if(typeof supportsBinary=="function"){callback=supportsBinary;supportsBinary=null}var isBinary=hasBinary(packets);if(supportsBinary&&isBinary){if(Blob&&!dontSendBlobs){return exports.encodePayloadAsBlob(packets,callback)}return exports.encodePayloadAsArrayBuffer(packets,callback)}if(!packets.length){return callback("0:")}function setLengthHeader(message){return message.length+":"+message}function encodeOne(packet,doneCallback){exports.encodePacket(packet,!isBinary?false:supportsBinary,true,function(message){doneCallback(null,setLengthHeader(message))})}map(packets,encodeOne,function(err,results){return callback(results.join(""))})};function map(ary,each,done){var result=new Array(ary.length);var next=after(ary.length,done);var eachWithIndex=function(i,el,cb){each(el,function(error,msg){result[i]=msg;cb(error,result)})};for(var i=0;i<ary.length;i++){eachWithIndex(i,ary[i],next)}}exports.decodePayload=function(data,binaryType,callback){if(typeof data!="string"){return exports.decodePayloadAsBinary(data,binaryType,callback)}if(typeof binaryType==="function"){callback=binaryType;binaryType=null}var packet;if(data==""){return callback(err,0,1)}var length="",n,msg;for(var i=0,l=data.length;i<l;i++){var chr=data.charAt(i);if(":"!=chr){length+=chr}else{if(""==length||length!=(n=Number(length))){return callback(err,0,1)}msg=data.substr(i+1,n);if(length!=msg.length){return callback(err,0,1)}if(msg.length){packet=exports.decodePacket(msg,binaryType,true);if(err.type==packet.type&&err.data==packet.data){return callback(err,0,1)}var ret=callback(packet,i+n,l);if(false===ret)return}i+=n;length=""}}if(length!=""){return callback(err,0,1)}};exports.encodePayloadAsArrayBuffer=function(packets,callback){if(!packets.length){return callback(new ArrayBuffer(0))}function encodeOne(packet,doneCallback){exports.encodePacket(packet,true,true,function(data){return doneCallback(null,data)})}map(packets,encodeOne,function(err,encodedPackets){var totalLength=encodedPackets.reduce(function(acc,p){var len;if(typeof p==="string"){len=p.length}else{len=p.byteLength}return acc+len.toString().length+len+2},0);var resultArray=new Uint8Array(totalLength);var bufferIndex=0;encodedPackets.forEach(function(p){var isString=typeof p==="string";var ab=p;if(isString){var view=new Uint8Array(p.length);for(var i=0;i<p.length;i++){view[i]=p.charCodeAt(i)}ab=view.buffer}if(isString){resultArray[bufferIndex++]=0}else{resultArray[bufferIndex++]=1}var lenStr=ab.byteLength.toString();for(var i=0;i<lenStr.length;i++){resultArray[bufferIndex++]=parseInt(lenStr[i])}resultArray[bufferIndex++]=255;var view=new Uint8Array(ab);for(var i=0;i<view.length;i++){resultArray[bufferIndex++]=view[i]}});return callback(resultArray.buffer)})};exports.encodePayloadAsBlob=function(packets,callback){function encodeOne(packet,doneCallback){exports.encodePacket(packet,true,true,function(encoded){var binaryIdentifier=new Uint8Array(1);binaryIdentifier[0]=1;if(typeof encoded==="string"){var view=new Uint8Array(encoded.length);for(var i=0;i<encoded.length;i++){view[i]=encoded.charCodeAt(i)}encoded=view.buffer;binaryIdentifier[0]=0}var len=encoded instanceof ArrayBuffer?encoded.byteLength:encoded.size;var lenStr=len.toString();var lengthAry=new Uint8Array(lenStr.length+1);for(var i=0;i<lenStr.length;i++){lengthAry[i]=parseInt(lenStr[i])}lengthAry[lenStr.length]=255;if(Blob){var blob=new Blob([binaryIdentifier.buffer,lengthAry.buffer,encoded]);doneCallback(null,blob)}})}map(packets,encodeOne,function(err,results){return callback(new Blob(results))})};exports.decodePayloadAsBinary=function(data,binaryType,callback){if(typeof binaryType==="function"){callback=binaryType;binaryType=null}var bufferTail=data;var buffers=[];var numberTooLong=false;while(bufferTail.byteLength>0){var tailArray=new Uint8Array(bufferTail);var isString=tailArray[0]===0;var msgLength="";for(var i=1;;i++){if(tailArray[i]==255)break;if(msgLength.length>310){numberTooLong=true;break}msgLength+=tailArray[i]}if(numberTooLong)return callback(err,0,1);bufferTail=sliceBuffer(bufferTail,2+msgLength.length);msgLength=parseInt(msgLength);var msg=sliceBuffer(bufferTail,0,msgLength);if(isString){try{msg=String.fromCharCode.apply(null,new Uint8Array(msg))}catch(e){var typed=new Uint8Array(msg);msg="";for(var i=0;i<typed.length;i++){msg+=String.fromCharCode(typed[i])}}}buffers.push(msg);bufferTail=sliceBuffer(bufferTail,msgLength)}var total=buffers.length;buffers.forEach(function(buffer,i){callback(exports.decodePacket(buffer,binaryType,true),i,total)})}}).call(this,typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"./keys":26,after:27,"arraybuffer.slice":28,"base64-arraybuffer":29,blob:30,"has-binary":31,utf8:33}],26:[function(_dereq_,module,exports){module.exports=Object.keys||function keys(obj){var arr=[];var has=Object.prototype.hasOwnProperty;for(var i in obj){if(has.call(obj,i)){arr.push(i)}}return arr}},{}],27:[function(_dereq_,module,exports){module.exports=after;function after(count,callback,err_cb){var bail=false;err_cb=err_cb||noop;proxy.count=count;return count===0?callback():proxy;function proxy(err,result){if(proxy.count<=0){throw new Error("after called too many times")}--proxy.count;if(err){bail=true;callback(err);callback=err_cb}else if(proxy.count===0&&!bail){callback(null,result)}}}function noop(){}},{}],28:[function(_dereq_,module,exports){module.exports=function(arraybuffer,start,end){var bytes=arraybuffer.byteLength;start=start||0;end=end||bytes;if(arraybuffer.slice){return arraybuffer.slice(start,end)}if(start<0){start+=bytes}if(end<0){end+=bytes}if(end>bytes){end=bytes}if(start>=bytes||start>=end||bytes===0){return new ArrayBuffer(0)}var abv=new Uint8Array(arraybuffer);var result=new Uint8Array(end-start);for(var i=start,ii=0;i<end;i++,ii++){result[ii]=abv[i]}return result.buffer}},{}],29:[function(_dereq_,module,exports){(function(chars){"use strict";exports.encode=function(arraybuffer){var bytes=new Uint8Array(arraybuffer),i,len=bytes.length,base64="";for(i=0;i<len;i+=3){base64+=chars[bytes[i]>>2];base64+=chars[(bytes[i]&3)<<4|bytes[i+1]>>4];base64+=chars[(bytes[i+1]&15)<<2|bytes[i+2]>>6];base64+=chars[bytes[i+2]&63]}if(len%3===2){base64=base64.substring(0,base64.length-1)+"="}else if(len%3===1){base64=base64.substring(0,base64.length-2)+"=="}return base64};exports.decode=function(base64){var bufferLength=base64.length*.75,len=base64.length,i,p=0,encoded1,encoded2,encoded3,encoded4;if(base64[base64.length-1]==="="){bufferLength--;if(base64[base64.length-2]==="="){bufferLength--}}var arraybuffer=new ArrayBuffer(bufferLength),bytes=new Uint8Array(arraybuffer);for(i=0;i<len;i+=4){encoded1=chars.indexOf(base64[i]);encoded2=chars.indexOf(base64[i+1]);encoded3=chars.indexOf(base64[i+2]);encoded4=chars.indexOf(base64[i+3]);bytes[p++]=encoded1<<2|encoded2>>4;bytes[p++]=(encoded2&15)<<4|encoded3>>2;bytes[p++]=(encoded3&3)<<6|encoded4&63}return arraybuffer}})("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/")},{}],30:[function(_dereq_,module,exports){(function(global){var BlobBuilder=global.BlobBuilder||global.WebKitBlobBuilder||global.MSBlobBuilder||global.MozBlobBuilder;var blobSupported=function(){try{var b=new Blob(["hi"]);return b.size==2}catch(e){return false}}();var blobBuilderSupported=BlobBuilder&&BlobBuilder.prototype.append&&BlobBuilder.prototype.getBlob;function BlobBuilderConstructor(ary,options){options=options||{};var bb=new BlobBuilder;for(var i=0;i<ary.length;i++){bb.append(ary[i])}return options.type?bb.getBlob(options.type):bb.getBlob()}module.exports=function(){if(blobSupported){return global.Blob}else if(blobBuilderSupported){return BlobBuilderConstructor}else{return undefined}}()}).call(this,typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{}],31:[function(_dereq_,module,exports){(function(global){var isArray=_dereq_("isarray");module.exports=hasBinary;function hasBinary(data){function _hasBinary(obj){if(!obj)return false;if(global.Buffer&&global.Buffer.isBuffer(obj)||global.ArrayBuffer&&obj instanceof ArrayBuffer||global.Blob&&obj instanceof Blob||global.File&&obj instanceof File){return true}if(isArray(obj)){for(var i=0;i<obj.length;i++){if(_hasBinary(obj[i])){return true}}}else if(obj&&"object"==typeof obj){if(obj.toJSON){obj=obj.toJSON()}for(var key in obj){if(obj.hasOwnProperty(key)&&_hasBinary(obj[key])){return true}}}return false}return _hasBinary(data)}}).call(this,typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{isarray:32}],32:[function(_dereq_,module,exports){module.exports=Array.isArray||function(arr){return Object.prototype.toString.call(arr)=="[object Array]"}},{}],33:[function(_dereq_,module,exports){(function(global){(function(root){var freeExports=typeof exports=="object"&&exports;var freeModule=typeof module=="object"&&module&&module.exports==freeExports&&module;var freeGlobal=typeof global=="object"&&global;if(freeGlobal.global===freeGlobal||freeGlobal.window===freeGlobal){root=freeGlobal}var stringFromCharCode=String.fromCharCode;function ucs2decode(string){var output=[];var counter=0;var length=string.length;var value;var extra;while(counter<length){value=string.charCodeAt(counter++);if(value>=55296&&value<=56319&&counter<length){extra=string.charCodeAt(counter++);if((extra&64512)==56320){output.push(((value&1023)<<10)+(extra&1023)+65536)}else{output.push(value);counter--}}else{output.push(value)}}return output}function ucs2encode(array){var length=array.length;var index=-1;var value;var output="";while(++index<length){value=array[index];if(value>65535){value-=65536;
output+=stringFromCharCode(value>>>10&1023|55296);value=56320|value&1023}output+=stringFromCharCode(value)}return output}function createByte(codePoint,shift){return stringFromCharCode(codePoint>>shift&63|128)}function encodeCodePoint(codePoint){if((codePoint&4294967168)==0){return stringFromCharCode(codePoint)}var symbol="";if((codePoint&4294965248)==0){symbol=stringFromCharCode(codePoint>>6&31|192)}else if((codePoint&4294901760)==0){symbol=stringFromCharCode(codePoint>>12&15|224);symbol+=createByte(codePoint,6)}else if((codePoint&4292870144)==0){symbol=stringFromCharCode(codePoint>>18&7|240);symbol+=createByte(codePoint,12);symbol+=createByte(codePoint,6)}symbol+=stringFromCharCode(codePoint&63|128);return symbol}function utf8encode(string){var codePoints=ucs2decode(string);var length=codePoints.length;var index=-1;var codePoint;var byteString="";while(++index<length){codePoint=codePoints[index];byteString+=encodeCodePoint(codePoint)}return byteString}function readContinuationByte(){if(byteIndex>=byteCount){throw Error("Invalid byte index")}var continuationByte=byteArray[byteIndex]&255;byteIndex++;if((continuationByte&192)==128){return continuationByte&63}throw Error("Invalid continuation byte")}function decodeSymbol(){var byte1;var byte2;var byte3;var byte4;var codePoint;if(byteIndex>byteCount){throw Error("Invalid byte index")}if(byteIndex==byteCount){return false}byte1=byteArray[byteIndex]&255;byteIndex++;if((byte1&128)==0){return byte1}if((byte1&224)==192){var byte2=readContinuationByte();codePoint=(byte1&31)<<6|byte2;if(codePoint>=128){return codePoint}else{throw Error("Invalid continuation byte")}}if((byte1&240)==224){byte2=readContinuationByte();byte3=readContinuationByte();codePoint=(byte1&15)<<12|byte2<<6|byte3;if(codePoint>=2048){return codePoint}else{throw Error("Invalid continuation byte")}}if((byte1&248)==240){byte2=readContinuationByte();byte3=readContinuationByte();byte4=readContinuationByte();codePoint=(byte1&15)<<18|byte2<<12|byte3<<6|byte4;if(codePoint>=65536&&codePoint<=1114111){return codePoint}}throw Error("Invalid UTF-8 detected")}var byteArray;var byteCount;var byteIndex;function utf8decode(byteString){byteArray=ucs2decode(byteString);byteCount=byteArray.length;byteIndex=0;var codePoints=[];var tmp;while((tmp=decodeSymbol())!==false){codePoints.push(tmp)}return ucs2encode(codePoints)}var utf8={version:"2.0.0",encode:utf8encode,decode:utf8decode};if(typeof define=="function"&&typeof define.amd=="object"&&define.amd){define(function(){return utf8})}else if(freeExports&&!freeExports.nodeType){if(freeModule){freeModule.exports=utf8}else{var object={};var hasOwnProperty=object.hasOwnProperty;for(var key in utf8){hasOwnProperty.call(utf8,key)&&(freeExports[key]=utf8[key])}}}else{root.utf8=utf8}})(this)}).call(this,typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{}],34:[function(_dereq_,module,exports){(function(global){var rvalidchars=/^[\],:{}\s]*$/;var rvalidescape=/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g;var rvalidtokens=/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g;var rvalidbraces=/(?:^|:|,)(?:\s*\[)+/g;var rtrimLeft=/^\s+/;var rtrimRight=/\s+$/;module.exports=function parsejson(data){if("string"!=typeof data||!data){return null}data=data.replace(rtrimLeft,"").replace(rtrimRight,"");if(global.JSON&&JSON.parse){return JSON.parse(data)}if(rvalidchars.test(data.replace(rvalidescape,"@").replace(rvalidtokens,"]").replace(rvalidbraces,""))){return new Function("return "+data)()}}}).call(this,typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{}],35:[function(_dereq_,module,exports){exports.encode=function(obj){var str="";for(var i in obj){if(obj.hasOwnProperty(i)){if(str.length)str+="&";str+=encodeURIComponent(i)+"="+encodeURIComponent(obj[i])}}return str};exports.decode=function(qs){var qry={};var pairs=qs.split("&");for(var i=0,l=pairs.length;i<l;i++){var pair=pairs[i].split("=");qry[decodeURIComponent(pair[0])]=decodeURIComponent(pair[1])}return qry}},{}],36:[function(_dereq_,module,exports){var re=/^(?:(?![^:@]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/;var parts=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];module.exports=function parseuri(str){var src=str,b=str.indexOf("["),e=str.indexOf("]");if(b!=-1&&e!=-1){str=str.substring(0,b)+str.substring(b,e).replace(/:/g,";")+str.substring(e,str.length)}var m=re.exec(str||""),uri={},i=14;while(i--){uri[parts[i]]=m[i]||""}if(b!=-1&&e!=-1){uri.source=src;uri.host=uri.host.substring(1,uri.host.length-1).replace(/;/g,":");uri.authority=uri.authority.replace("[","").replace("]","").replace(/;/g,":");uri.ipv6uri=true}return uri}},{}],37:[function(_dereq_,module,exports){var global=function(){return this}();var WebSocket=global.WebSocket||global.MozWebSocket;module.exports=WebSocket?ws:null;function ws(uri,protocols,opts){var instance;if(protocols){instance=new WebSocket(uri,protocols)}else{instance=new WebSocket(uri)}return instance}if(WebSocket)ws.prototype=WebSocket.prototype},{}],38:[function(_dereq_,module,exports){(function(global){var isArray=_dereq_("isarray");module.exports=hasBinary;function hasBinary(data){function _hasBinary(obj){if(!obj)return false;if(global.Buffer&&global.Buffer.isBuffer(obj)||global.ArrayBuffer&&obj instanceof ArrayBuffer||global.Blob&&obj instanceof Blob||global.File&&obj instanceof File){return true}if(isArray(obj)){for(var i=0;i<obj.length;i++){if(_hasBinary(obj[i])){return true}}}else if(obj&&"object"==typeof obj){if(obj.toJSON){obj=obj.toJSON()}for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key)&&_hasBinary(obj[key])){return true}}}return false}return _hasBinary(data)}}).call(this,typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{isarray:39}],39:[function(_dereq_,module,exports){module.exports=_dereq_(32)},{}],40:[function(_dereq_,module,exports){var global=_dereq_("global");try{module.exports="XMLHttpRequest"in global&&"withCredentials"in new global.XMLHttpRequest}catch(err){module.exports=false}},{global:41}],41:[function(_dereq_,module,exports){module.exports=function(){return this}()},{}],42:[function(_dereq_,module,exports){var indexOf=[].indexOf;module.exports=function(arr,obj){if(indexOf)return arr.indexOf(obj);for(var i=0;i<arr.length;++i){if(arr[i]===obj)return i}return-1}},{}],43:[function(_dereq_,module,exports){var has=Object.prototype.hasOwnProperty;exports.keys=Object.keys||function(obj){var keys=[];for(var key in obj){if(has.call(obj,key)){keys.push(key)}}return keys};exports.values=function(obj){var vals=[];for(var key in obj){if(has.call(obj,key)){vals.push(obj[key])}}return vals};exports.merge=function(a,b){for(var key in b){if(has.call(b,key)){a[key]=b[key]}}return a};exports.length=function(obj){return exports.keys(obj).length};exports.isEmpty=function(obj){return 0==exports.length(obj)}},{}],44:[function(_dereq_,module,exports){var re=/^(?:(?![^:@]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/;var parts=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];module.exports=function parseuri(str){var m=re.exec(str||""),uri={},i=14;while(i--){uri[parts[i]]=m[i]||""}return uri}},{}],45:[function(_dereq_,module,exports){(function(global){var isArray=_dereq_("isarray");var isBuf=_dereq_("./is-buffer");exports.deconstructPacket=function(packet){var buffers=[];var packetData=packet.data;function _deconstructPacket(data){if(!data)return data;if(isBuf(data)){var placeholder={_placeholder:true,num:buffers.length};buffers.push(data);return placeholder}else if(isArray(data)){var newData=new Array(data.length);for(var i=0;i<data.length;i++){newData[i]=_deconstructPacket(data[i])}return newData}else if("object"==typeof data&&!(data instanceof Date)){var newData={};for(var key in data){newData[key]=_deconstructPacket(data[key])}return newData}return data}var pack=packet;pack.data=_deconstructPacket(packetData);pack.attachments=buffers.length;return{packet:pack,buffers:buffers}};exports.reconstructPacket=function(packet,buffers){var curPlaceHolder=0;function _reconstructPacket(data){if(data&&data._placeholder){var buf=buffers[data.num];return buf}else if(isArray(data)){for(var i=0;i<data.length;i++){data[i]=_reconstructPacket(data[i])}return data}else if(data&&"object"==typeof data){for(var key in data){data[key]=_reconstructPacket(data[key])}return data}return data}packet.data=_reconstructPacket(packet.data);packet.attachments=undefined;return packet};exports.removeBlobs=function(data,callback){function _removeBlobs(obj,curKey,containingObject){if(!obj)return obj;if(global.Blob&&obj instanceof Blob||global.File&&obj instanceof File){pendingBlobs++;var fileReader=new FileReader;fileReader.onload=function(){if(containingObject){containingObject[curKey]=this.result}else{bloblessData=this.result}if(!--pendingBlobs){callback(bloblessData)}};fileReader.readAsArrayBuffer(obj)}else if(isArray(obj)){for(var i=0;i<obj.length;i++){_removeBlobs(obj[i],i,obj)}}else if(obj&&"object"==typeof obj&&!isBuf(obj)){for(var key in obj){_removeBlobs(obj[key],key,obj)}}}var pendingBlobs=0;var bloblessData=data;_removeBlobs(bloblessData);if(!pendingBlobs){callback(bloblessData)}}}).call(this,typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"./is-buffer":47,isarray:48}],46:[function(_dereq_,module,exports){var debug=_dereq_("debug")("socket.io-parser");var json=_dereq_("json3");var isArray=_dereq_("isarray");var Emitter=_dereq_("component-emitter");var binary=_dereq_("./binary");var isBuf=_dereq_("./is-buffer");exports.protocol=4;exports.types=["CONNECT","DISCONNECT","EVENT","BINARY_EVENT","ACK","BINARY_ACK","ERROR"];exports.CONNECT=0;exports.DISCONNECT=1;exports.EVENT=2;exports.ACK=3;exports.ERROR=4;exports.BINARY_EVENT=5;exports.BINARY_ACK=6;exports.Encoder=Encoder;exports.Decoder=Decoder;function Encoder(){}Encoder.prototype.encode=function(obj,callback){debug("encoding packet %j",obj);if(exports.BINARY_EVENT==obj.type||exports.BINARY_ACK==obj.type){encodeAsBinary(obj,callback)}else{var encoding=encodeAsString(obj);callback([encoding])}};function encodeAsString(obj){var str="";var nsp=false;str+=obj.type;if(exports.BINARY_EVENT==obj.type||exports.BINARY_ACK==obj.type){str+=obj.attachments;str+="-"}if(obj.nsp&&"/"!=obj.nsp){nsp=true;str+=obj.nsp}if(null!=obj.id){if(nsp){str+=",";nsp=false}str+=obj.id}if(null!=obj.data){if(nsp)str+=",";str+=json.stringify(obj.data)}debug("encoded %j as %s",obj,str);return str}function encodeAsBinary(obj,callback){function writeEncoding(bloblessData){var deconstruction=binary.deconstructPacket(bloblessData);var pack=encodeAsString(deconstruction.packet);var buffers=deconstruction.buffers;buffers.unshift(pack);callback(buffers)}binary.removeBlobs(obj,writeEncoding)}function Decoder(){this.reconstructor=null}Emitter(Decoder.prototype);Decoder.prototype.add=function(obj){var packet;if("string"==typeof obj){packet=decodeString(obj);if(exports.BINARY_EVENT==packet.type||exports.BINARY_ACK==packet.type){this.reconstructor=new BinaryReconstructor(packet);if(this.reconstructor.reconPack.attachments===0){this.emit("decoded",packet)}}else{this.emit("decoded",packet)}}else if(isBuf(obj)||obj.base64){if(!this.reconstructor){throw new Error("got binary data when not reconstructing a packet")}else{packet=this.reconstructor.takeBinaryData(obj);if(packet){this.reconstructor=null;this.emit("decoded",packet)}}}else{throw new Error("Unknown type: "+obj)}};function decodeString(str){var p={};var i=0;p.type=Number(str.charAt(0));if(null==exports.types[p.type])return error();if(exports.BINARY_EVENT==p.type||exports.BINARY_ACK==p.type){var buf="";while(str.charAt(++i)!="-"){buf+=str.charAt(i);if(i==str.length)break}if(buf!=Number(buf)||str.charAt(i)!="-"){throw new Error("Illegal attachments")}p.attachments=Number(buf)}if("/"==str.charAt(i+1)){p.nsp="";while(++i){var c=str.charAt(i);if(","==c)break;p.nsp+=c;if(i==str.length)break}}else{p.nsp="/"}var next=str.charAt(i+1);if(""!==next&&Number(next)==next){p.id="";while(++i){var c=str.charAt(i);if(null==c||Number(c)!=c){--i;break}p.id+=str.charAt(i);if(i==str.length)break}p.id=Number(p.id)}if(str.charAt(++i)){try{p.data=json.parse(str.substr(i))}catch(e){return error()}}debug("decoded %s as %j",str,p);return p}Decoder.prototype.destroy=function(){if(this.reconstructor){this.reconstructor.finishedReconstruction()}};function BinaryReconstructor(packet){this.reconPack=packet;this.buffers=[]}BinaryReconstructor.prototype.takeBinaryData=function(binData){this.buffers.push(binData);if(this.buffers.length==this.reconPack.attachments){var packet=binary.reconstructPacket(this.reconPack,this.buffers);this.finishedReconstruction();return packet}return null};BinaryReconstructor.prototype.finishedReconstruction=function(){this.reconPack=null;this.buffers=[]};function error(data){return{type:exports.ERROR,data:"parser error"}}},{"./binary":45,"./is-buffer":47,"component-emitter":9,debug:10,isarray:48,json3:49}],47:[function(_dereq_,module,exports){(function(global){module.exports=isBuf;function isBuf(obj){return global.Buffer&&global.Buffer.isBuffer(obj)||global.ArrayBuffer&&obj instanceof ArrayBuffer}}).call(this,typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{}],48:[function(_dereq_,module,exports){module.exports=_dereq_(32)},{}],49:[function(_dereq_,module,exports){(function(window){var getClass={}.toString,isProperty,forEach,undef;var isLoader=typeof define==="function"&&define.amd;var nativeJSON=typeof JSON=="object"&&JSON;var JSON3=typeof exports=="object"&&exports&&!exports.nodeType&&exports;if(JSON3&&nativeJSON){JSON3.stringify=nativeJSON.stringify;JSON3.parse=nativeJSON.parse}else{JSON3=window.JSON=nativeJSON||{}}var isExtended=new Date(-0xc782b5b800cec);try{isExtended=isExtended.getUTCFullYear()==-109252&&isExtended.getUTCMonth()===0&&isExtended.getUTCDate()===1&&isExtended.getUTCHours()==10&&isExtended.getUTCMinutes()==37&&isExtended.getUTCSeconds()==6&&isExtended.getUTCMilliseconds()==708}catch(exception){}function has(name){if(has[name]!==undef){return has[name]}var isSupported;if(name=="bug-string-char-index"){isSupported="a"[0]!="a"}else if(name=="json"){isSupported=has("json-stringify")&&has("json-parse")}else{var value,serialized='{"a":[1,true,false,null,"\\u0000\\b\\n\\f\\r\\t"]}';if(name=="json-stringify"){var stringify=JSON3.stringify,stringifySupported=typeof stringify=="function"&&isExtended;if(stringifySupported){(value=function(){return 1}).toJSON=value;try{stringifySupported=stringify(0)==="0"&&stringify(new Number)==="0"&&stringify(new String)=='""'&&stringify(getClass)===undef&&stringify(undef)===undef&&stringify()===undef&&stringify(value)==="1"&&stringify([value])=="[1]"&&stringify([undef])=="[null]"&&stringify(null)=="null"&&stringify([undef,getClass,null])=="[null,null,null]"&&stringify({a:[value,true,false,null,"\x00\b\n\f\r	"]})==serialized&&stringify(null,value)==="1"&&stringify([1,2],null,1)=="[\n 1,\n 2\n]"&&stringify(new Date(-864e13))=='"-271821-04-20T00:00:00.000Z"'&&stringify(new Date(864e13))=='"+275760-09-13T00:00:00.000Z"'&&stringify(new Date(-621987552e5))=='"-000001-01-01T00:00:00.000Z"'&&stringify(new Date(-1))=='"1969-12-31T23:59:59.999Z"'}catch(exception){stringifySupported=false}}isSupported=stringifySupported}if(name=="json-parse"){var parse=JSON3.parse;if(typeof parse=="function"){try{if(parse("0")===0&&!parse(false)){value=parse(serialized);var parseSupported=value["a"].length==5&&value["a"][0]===1;if(parseSupported){try{parseSupported=!parse('"	"')}catch(exception){}if(parseSupported){try{parseSupported=parse("01")!==1}catch(exception){}}if(parseSupported){try{parseSupported=parse("1.")!==1}catch(exception){}}}}}catch(exception){parseSupported=false}}isSupported=parseSupported}}return has[name]=!!isSupported}if(!has("json")){var functionClass="[object Function]";var dateClass="[object Date]";var numberClass="[object Number]";var stringClass="[object String]";var arrayClass="[object Array]";var booleanClass="[object Boolean]";var charIndexBuggy=has("bug-string-char-index");if(!isExtended){var floor=Math.floor;var Months=[0,31,59,90,120,151,181,212,243,273,304,334];var getDay=function(year,month){return Months[month]+365*(year-1970)+floor((year-1969+(month=+(month>1)))/4)-floor((year-1901+month)/100)+floor((year-1601+month)/400)}}if(!(isProperty={}.hasOwnProperty)){isProperty=function(property){var members={},constructor;if((members.__proto__=null,members.__proto__={toString:1},members).toString!=getClass){isProperty=function(property){var original=this.__proto__,result=property in(this.__proto__=null,this);this.__proto__=original;return result}}else{constructor=members.constructor;isProperty=function(property){var parent=(this.constructor||constructor).prototype;return property in this&&!(property in parent&&this[property]===parent[property])}}members=null;return isProperty.call(this,property)}}var PrimitiveTypes={"boolean":1,number:1,string:1,undefined:1};var isHostType=function(object,property){var type=typeof object[property];return type=="object"?!!object[property]:!PrimitiveTypes[type]};forEach=function(object,callback){var size=0,Properties,members,property;(Properties=function(){this.valueOf=0}).prototype.valueOf=0;members=new Properties;for(property in members){if(isProperty.call(members,property)){size++}}Properties=members=null;if(!size){members=["valueOf","toString","toLocaleString","propertyIsEnumerable","isPrototypeOf","hasOwnProperty","constructor"];forEach=function(object,callback){var isFunction=getClass.call(object)==functionClass,property,length;var hasProperty=!isFunction&&typeof object.constructor!="function"&&isHostType(object,"hasOwnProperty")?object.hasOwnProperty:isProperty;for(property in object){if(!(isFunction&&property=="prototype")&&hasProperty.call(object,property)){callback(property)}}for(length=members.length;property=members[--length];hasProperty.call(object,property)&&callback(property));}}else if(size==2){forEach=function(object,callback){var members={},isFunction=getClass.call(object)==functionClass,property;for(property in object){if(!(isFunction&&property=="prototype")&&!isProperty.call(members,property)&&(members[property]=1)&&isProperty.call(object,property)){callback(property)}}}}else{forEach=function(object,callback){var isFunction=getClass.call(object)==functionClass,property,isConstructor;for(property in object){if(!(isFunction&&property=="prototype")&&isProperty.call(object,property)&&!(isConstructor=property==="constructor")){callback(property)}}if(isConstructor||isProperty.call(object,property="constructor")){callback(property)}}}return forEach(object,callback)};if(!has("json-stringify")){var Escapes={92:"\\\\",34:'\\"',8:"\\b",12:"\\f",10:"\\n",13:"\\r",9:"\\t"};var leadingZeroes="000000";var toPaddedString=function(width,value){return(leadingZeroes+(value||0)).slice(-width)};var unicodePrefix="\\u00";var quote=function(value){var result='"',index=0,length=value.length,isLarge=length>10&&charIndexBuggy,symbols;if(isLarge){symbols=value.split("")}for(;index<length;index++){var charCode=value.charCodeAt(index);switch(charCode){case 8:case 9:case 10:case 12:case 13:case 34:case 92:result+=Escapes[charCode];break;default:if(charCode<32){result+=unicodePrefix+toPaddedString(2,charCode.toString(16));break}result+=isLarge?symbols[index]:charIndexBuggy?value.charAt(index):value[index]}}return result+'"'};var serialize=function(property,object,callback,properties,whitespace,indentation,stack){var value,className,year,month,date,time,hours,minutes,seconds,milliseconds,results,element,index,length,prefix,result;try{value=object[property]}catch(exception){}if(typeof value=="object"&&value){className=getClass.call(value);if(className==dateClass&&!isProperty.call(value,"toJSON")){if(value>-1/0&&value<1/0){if(getDay){date=floor(value/864e5);for(year=floor(date/365.2425)+1970-1;getDay(year+1,0)<=date;year++);for(month=floor((date-getDay(year,0))/30.42);getDay(year,month+1)<=date;month++);date=1+date-getDay(year,month);time=(value%864e5+864e5)%864e5;hours=floor(time/36e5)%24;minutes=floor(time/6e4)%60;seconds=floor(time/1e3)%60;milliseconds=time%1e3}else{year=value.getUTCFullYear();month=value.getUTCMonth();date=value.getUTCDate();hours=value.getUTCHours();minutes=value.getUTCMinutes();seconds=value.getUTCSeconds();milliseconds=value.getUTCMilliseconds()}value=(year<=0||year>=1e4?(year<0?"-":"+")+toPaddedString(6,year<0?-year:year):toPaddedString(4,year))+"-"+toPaddedString(2,month+1)+"-"+toPaddedString(2,date)+"T"+toPaddedString(2,hours)+":"+toPaddedString(2,minutes)+":"+toPaddedString(2,seconds)+"."+toPaddedString(3,milliseconds)+"Z"}else{value=null}}else if(typeof value.toJSON=="function"&&(className!=numberClass&&className!=stringClass&&className!=arrayClass||isProperty.call(value,"toJSON"))){value=value.toJSON(property)}}if(callback){value=callback.call(object,property,value)}if(value===null){return"null"}className=getClass.call(value);if(className==booleanClass){return""+value}else if(className==numberClass){return value>-1/0&&value<1/0?""+value:"null"}else if(className==stringClass){return quote(""+value)}if(typeof value=="object"){for(length=stack.length;length--;){if(stack[length]===value){throw TypeError()}}stack.push(value);results=[];prefix=indentation;indentation+=whitespace;if(className==arrayClass){for(index=0,length=value.length;index<length;index++){element=serialize(index,value,callback,properties,whitespace,indentation,stack);results.push(element===undef?"null":element)}result=results.length?whitespace?"[\n"+indentation+results.join(",\n"+indentation)+"\n"+prefix+"]":"["+results.join(",")+"]":"[]"}else{forEach(properties||value,function(property){var element=serialize(property,value,callback,properties,whitespace,indentation,stack);if(element!==undef){results.push(quote(property)+":"+(whitespace?" ":"")+element)}});result=results.length?whitespace?"{\n"+indentation+results.join(",\n"+indentation)+"\n"+prefix+"}":"{"+results.join(",")+"}":"{}"}stack.pop();return result}};JSON3.stringify=function(source,filter,width){var whitespace,callback,properties,className;if(typeof filter=="function"||typeof filter=="object"&&filter){if((className=getClass.call(filter))==functionClass){callback=filter}else if(className==arrayClass){properties={};for(var index=0,length=filter.length,value;index<length;value=filter[index++],(className=getClass.call(value),className==stringClass||className==numberClass)&&(properties[value]=1));}}if(width){if((className=getClass.call(width))==numberClass){if((width-=width%1)>0){for(whitespace="",width>10&&(width=10);whitespace.length<width;whitespace+=" ");}}else if(className==stringClass){whitespace=width.length<=10?width:width.slice(0,10)}}return serialize("",(value={},value[""]=source,value),callback,properties,whitespace,"",[])}}if(!has("json-parse")){var fromCharCode=String.fromCharCode;var Unescapes={92:"\\",34:'"',47:"/",98:"\b",116:"	",110:"\n",102:"\f",114:"\r"};var Index,Source;var abort=function(){Index=Source=null;throw SyntaxError()};var lex=function(){var source=Source,length=source.length,value,begin,position,isSigned,charCode;while(Index<length){charCode=source.charCodeAt(Index);switch(charCode){case 9:case 10:case 13:case 32:Index++;break;case 123:case 125:case 91:case 93:case 58:case 44:value=charIndexBuggy?source.charAt(Index):source[Index];Index++;return value;case 34:for(value="@",Index++;Index<length;){charCode=source.charCodeAt(Index);if(charCode<32){abort()}else if(charCode==92){charCode=source.charCodeAt(++Index);switch(charCode){case 92:case 34:case 47:case 98:case 116:case 110:case 102:case 114:value+=Unescapes[charCode];Index++;break;case 117:begin=++Index;for(position=Index+4;Index<position;Index++){charCode=source.charCodeAt(Index);if(!(charCode>=48&&charCode<=57||charCode>=97&&charCode<=102||charCode>=65&&charCode<=70)){abort()}}value+=fromCharCode("0x"+source.slice(begin,Index));break;default:abort()}}else{if(charCode==34){break}charCode=source.charCodeAt(Index);begin=Index;while(charCode>=32&&charCode!=92&&charCode!=34){charCode=source.charCodeAt(++Index)}value+=source.slice(begin,Index)}}if(source.charCodeAt(Index)==34){Index++;return value}abort();default:begin=Index;if(charCode==45){isSigned=true;charCode=source.charCodeAt(++Index)}if(charCode>=48&&charCode<=57){if(charCode==48&&(charCode=source.charCodeAt(Index+1),charCode>=48&&charCode<=57)){abort()}isSigned=false;for(;Index<length&&(charCode=source.charCodeAt(Index),charCode>=48&&charCode<=57);Index++);if(source.charCodeAt(Index)==46){position=++Index;for(;position<length&&(charCode=source.charCodeAt(position),charCode>=48&&charCode<=57);position++);if(position==Index){abort()}Index=position}charCode=source.charCodeAt(Index);if(charCode==101||charCode==69){charCode=source.charCodeAt(++Index);if(charCode==43||charCode==45){Index++}for(position=Index;position<length&&(charCode=source.charCodeAt(position),charCode>=48&&charCode<=57);position++);if(position==Index){abort()}Index=position}return+source.slice(begin,Index)}if(isSigned){abort()}if(source.slice(Index,Index+4)=="true"){Index+=4;return true}else if(source.slice(Index,Index+5)=="false"){Index+=5;return false}else if(source.slice(Index,Index+4)=="null"){Index+=4;return null}abort()}}return"$"};var get=function(value){var results,hasMembers;if(value=="$"){abort()}if(typeof value=="string"){if((charIndexBuggy?value.charAt(0):value[0])=="@"){return value.slice(1)}if(value=="["){results=[];for(;;hasMembers||(hasMembers=true)){value=lex();if(value=="]"){break}if(hasMembers){if(value==","){value=lex();if(value=="]"){abort()}}else{abort()}}if(value==","){abort()}results.push(get(value))}return results}else if(value=="{"){results={};for(;;hasMembers||(hasMembers=true)){value=lex();if(value=="}"){break}if(hasMembers){if(value==","){value=lex();if(value=="}"){abort()}}else{abort()}}if(value==","||typeof value!="string"||(charIndexBuggy?value.charAt(0):value[0])!="@"||lex()!=":"){abort()}results[value.slice(1)]=get(lex())}return results}abort()}return value};var update=function(source,property,callback){var element=walk(source,property,callback);if(element===undef){delete source[property]}else{source[property]=element}};var walk=function(source,property,callback){var value=source[property],length;if(typeof value=="object"&&value){if(getClass.call(value)==arrayClass){for(length=value.length;length--;){update(value,length,callback)}}else{forEach(value,function(property){update(value,property,callback)})}}return callback.call(source,property,value)};JSON3.parse=function(source,callback){var result,value;Index=0;Source=""+source;result=get(lex());if(lex()!="$"){abort()}Index=Source=null;return callback&&getClass.call(callback)==functionClass?walk((value={},value[""]=result,value),"",callback):result}}}if(isLoader){define(function(){return JSON3})}})(this)},{}],50:[function(_dereq_,module,exports){module.exports=toArray;function toArray(list,index){var array=[];index=index||0;for(var i=index||0;i<list.length;i++){array[i-index]=list[i]}return array}},{}]},{},[1])(1)});var Live=new function __Live(){
	this.__enabled=1;
	this.__authenticated=0;
	this.__bind={};

	this.mode="socket"; // {rest, socket}
	
	this.online=[];
	
	this.off=function(){
		this.__enabled=0;
		if (this.me){
			this.me.io.autoConnect=false;
			this.me.io._reconnection=false;
			// this.me.reconnect=false;
			// this.me.reconnect(false);
			this.me.disconnect();
		}
	};
	
	var error_count=0;
	this.onConnectionError=function(){
		if (this.__enabled==0){
			return;
		}
		
		if (mobile()){
			return;
		}
		
		if (Client.base && Client.base.app=="message"){
			var html="<div id='socket-disconnected'> <div class='txt'>Real-time connection to server is interrupted due to unstable internet connection. Messages and notifications may not be real-time. Please refresh to continue.</div> <div class='cta url' data-url=':refresh'>Refresh</div> </div>";
			
			if ($("#socket-disconnected").length){
				// $("#socket-disconnected").remove();
				return;
			}else{
				error_count++;
				if (error_count>=2){
					$(document.body).append(html);
					$("#document").css("top", 50);
				}
			}
		}else{
			var $title=$("#msg-panel .title");
			if ($title.length){
				$title.prepend("<span class='inline' title='Real-time connection is interrupted'><span class='-ap icon-info'></span></span>");
			}
		}
	};
	
	
	/**
	 * @desc Create a live connection and try to authenticated
	 */
	this.join=function(url){
		if (!Client.viewer || !Client.system || N.__off || !this.__enabled){
			return;
		}
		
		var query="ns="+Client.system.id+"&nstoken="+Client.system.token+"&id="+Client.viewer.id+"&username="+Client.viewer.username+
		"&token="+Client.secureData.token+"&session="+Client.secureData.session+"&type=session&fake="+"justatest";
		
		if (Client.base){
			query="ns="+Client.system.id+"&nstoken="+Client.system.token+"&id="+Client.viewer.id+"&username="+Client.viewer.username+
			"&token="+Client.base.secureData.token+"&session="+Client.base.secureData.session+"&type=session&fake="+"justatest";	
		}
		
		var allow_reconnect=true;
		if (!this.__enabled){
			allow_reconnect=false;
		}
		
		var socket = io.connect(url, 
			{
				query:query, 
				reconnect: true, 
				reconnection: true,
				reconnectionAttempts: 200,
				reconnectionDelay: 5000,
				transports: ['websocket', 'flashsocket', 'htmlfile', 'xhr-polling', 'jsonp-polling', 'polling']
			}
		);
		 
		socket.data={};
		socket.data.url=url;
		socket.data.authenticated=false;
		
		authenticate(socket);
		
		socket.on('authenticated', function(data){
			console.log("Socket authenticated ...");
			socket.data.authenticated=true;
			
			if (!Live.__authenticated){
				Live.__authenticated=1;
				AP.sys.fire("socket.ready");
			}else{
				AP.sys.fire("socket.reconnection.ready");
			}
			
			N.ui.trigger(data);
			
		});	
		
		socket.on("authentication.error", function(msg){
			console.log("authentication.error");
			$.log(msg);
		});
		
		socket.on('connect_error', function(){
			console.log('connection_error');
			Live.onConnectionError();
		});
		
		socket.on('error', function(){
			console.log('connection_error');
			Live.onConnectionError();
		});
		
		socket.on("disconnect", function(){
			if (Live.__enabled || N.__off){
				return;
			}
			 
			$.log("Socket disconnected ...");
			 // reconnect(socket); 
		});
		 
		 
		socket.on("clog", function(message){
		});
		 
		socket.on("__log__", function(data){
			$.log(data);
		});		 
		
		return socket;
	};
	
	
	this.post=function(event, data, callback, once){
		if (this.auth()){
			this.emit(event, data);
			if (once){
				if (this.__bind[event]){
					// return;
				}
				
				this.me.off(event);
				
				this.__bind[event]=data;
				this.me.once(event, callback);
			}else{
				this.me.on(event, callback);
			}
		}
	};
	
	this.send=function(event, data, callback, once){
		return this.post(event, data, callback, once);
	};
	
	
	
	this.on=function(event, callback){
		if (!this.me){
			return;
		}
		this.me.on(event, callback);
	};
	
	
	this.auth=function(){ 
		return this.me && this.me.data.authenticated;
	};
	
	
	this.update=function(data){
		if (!data){
			data={};
		}
		if (Live.auth()){
			Live.emit("update",data);
		}
	};
	
	
	this.broadcast=function(users, data){
		if (Live.auth()){
			Live.emit("p2p",{
				 "users": users,
				 "data": data
			});
		}
	};
	
	
	this.emit=function(event, data){
		if (!Live.me){
			$.log("Unauthenticated socket");
			return;
		}
		
		$$(function(){
			$.log("socket-event ["+event+"], with data:");
			$.log(data);
		});
		
		Live.me.emit(event, data);
	}
	
	
	
	function authenticate(socket){
		var networks=[];
		if (!Client.networks){
			return;
		}
		
		for (var i=0; i<Client.networks.length; i++){
			 var n=Client.networks[i];
			 var is_root=0;
			 if (parseInt(n.type)==13){
				 is_root=1;
			 }
			 networks.push({"id": n.id, "token": n.token, "path": n.path, "name": n.name, "root": is_root});
		}
	};
	
	
	function reconnect(socket){
		$.log("Reconnecting ...");
	};
};



Live.response=new function __LiveResponse(){
	this.comment=function(comment){
		var $box=$("#auto-comments-"+comment.origin_hid);
		if (!comment.origin_hid || !$box.length){
			return;
		}
		
		var $canvas=$box.closest(".__comment_canvas");
		if (!$canvas.length){
			return;
		}
		
		var obj=$canvas.data("object");
		var opts=$canvas.data("options");
		
		if (!obj){
			return;
		}
		
		
		obj.stats.comments=parseInt(obj.stats.comments)+1;
		Comment.ui.insert($canvas, obj, comment);
		
		$("#comment-"+comment.id).addClass("animated");
		setTimeout(function(){
			$("#comment-"+comment.id).removeClass("animated");
		},3000);
		
		$(opts.counter).html(obj.stats.comments);
		$(".comment-counter-"+obj.id).html(obj.stats.comments);
		$(".comment-counter-"+obj.gid).html(obj.stats.comments);
	};
};
$(document).ready(function(){
	if (Client.https) {
	    Live.me = Live.join(Client.socket_url);
	} else {
	    Live.me = Live.join(Client.socket_url);
	}

	Live.on("notification", function(data){
		var notis={title: data.title, body: data.body, icon: data.image, url:data.link, id: data.id, __state: data.__state};
		
		DN.show(notis);
		DN.bip(3, data.id);
		
		if (data.user && parseInt(data.user.num_notis)){
			Base.title.notis(data.user.num_notis);
			N.ui.update(data.user);
		}
		
		if (data.data){
			AP.sys.fire(data.type, [data.data, data]);
			AP.sys.fire(data.type+":"+data.action, [data.extra]);
			
			if (data.action=="comment" && data.extra && data.extra.type=="comment"){
				Live.response.comment(data.extra);
			}
		}
	});
	
	
	Live.on("counter", function(data){
		Base.title.notis(data.num_notis);
		N.ui.update(data);
	});

	
	Live.on("p2p", function(data){
		if (data.action){
			if (data.action=='chat.focus' || data.action=='chat.unfocus'){
				Chat.live.handleAction(data.action, data);
			}
		}
	});


	AP.sys.on("socket.ready", function(){
		Live.send("system.getonline", {}, function(data){
			Online.setPeople(data);
			AP.fire("ONLINE.LOADED");
		});
		
		Live.on("user.online",function(data){
			Online.add(data.username);
		});
		
		Live.on("user.offline",function(data){
			Online.remove(data.username);
		});
		
		N.live.init();
		Reminder.init();
	});


});var Online=new function __Online(){
	this.people=[];
	this.__online={};
	this.__loaded=false;
	
	this.setPeople=function(people){
		this.people=filter(people);
		for (var i=0; i<this.people.length; i++){
			this.__online[this.people[i].username]=this.people[i];
		}
		
		this.__loaded=true;
		
		setTimeout(function(){
			Online.__loaded=true; 
		},30000);
	};
	
	this.add=function(username){
		if (this.online(username)){
			return;
		}
		
		this.people.push({'username': username, atime: AP.time.now()});
		
	};
	
	
	this.remove=function(username){
		var r=[];
		for (var i=0; i<this.people.length; i++){
			if (this.people[i].username==username){
				
			}else{
				r.push(this.people[i]);
			}
		}
		
		this.people=r;
	};
	
	
	
	this.online=function(username){
		if (!username || !username.length){
			return null;
		}
		
		for (var i=0; i<this.people.length; i++){
			if (this.people[i].username==username){
				return this.people[i];
			}
		}
		
		return null;
	};
	
	
	this.isOnline=function(username){
		var u=username;
		if (AP.data.isObject(username) && username.username){
			u=username.username;
		}
		
		if (this.__online[username]){
			return true;
		}
		
		return false;
	};
	
	
	
	this.loaded=function(callback){
		if (this.__loaded){
			callback();
		}
		
		AP.on("ONLINE.LOADED", function(){
			callback();
		});
	};
	
	
	this.updateStatus=function(selector){
		AP.on("ONLINE.LOADED", function(){
			$(selector).each(function(){
				var $this=$(this);
				var username=$this.data("username");
				
				if (!username){
					return;
				}
				if (username.charAt(0)=="@"){
					username=username.substr(1);
				}
				var $target=$this;
				if ($this.hasClass("avatar")){
				}else{
					$target=$this.find(".avatar");
				}
				
				if (Online.online(username)){
					$target.addClass("-online");
				}else{
					$target.removeClass("-online");
				}
			});
		});
	};
	
	
	
	this.reorder=function(users){
		if (!users || !users.length){
			return users;
		}
		
		for (var i=0; i<users.length; i++){
			var obj=this.online(users[i].username);
			
			if (obj){
				users[i].online=1;
				users[i].atime=obj.atime;
			}else{
				users[i].online=0;
				users[i].atime=0;
			}
		}
		
		users.sort(function(e1, e2){
			if (e2.online==1 && e1.online==1){
				return e2.atime-e1.atime;
			}
			return e2.online-e1.online;
		});
	};
	
	
	
	function filter(people){
		var r=[];
		for (var i=0; i<people.length; i++){
			var found=false;
			var person=people[i];
			for (var j=0; j<r.length; j++){
				if (r[j].username==person.username){
					found=true;
					
					if (parseInt(r[j].atime < parseInt(person.atime))){
						r[j].atime=person.atime;
					}
				}
			}
			
			if (!found){
				r.push(person);
			}
			
		}
		return r;
	};
	
};